# 速率控制默认配置更新说明

## 📋 更新内容

根据业务需求，已将速率控制功能调整为**默认开启**，并设置合理的默认值。

**更新时间**：2025-10-22

---

## ✅ 新的默认配置

### 前端默认值

创建新通道时的默认配置：

```javascript
{
  rate_limit_enabled: true,        // 默认开启速率控制
  rate_limit_per_second: 100,      // 每秒最多100次请求
  rate_limit_per_minute: 0,        // 不限制每分钟（0表示不限制）
  rate_limit_per_hour: 0,          // 不限制每小时（0表示不限制）
  rate_limit_concurrent: 1         // 最大并发数为1（串行发送）
}
```

### 数据库默认值

数据库字段的默认值设置：

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `rate_limit_enabled` | TINYINT(1) | `1` | 默认开启速率控制 |
| `rate_limit_per_second` | INT | `100` | 每秒最多100次请求 |
| `rate_limit_per_minute` | INT | `NULL` | 不限制每分钟 |
| `rate_limit_per_hour` | INT | `NULL` | 不限制每小时 |
| `rate_limit_concurrent` | INT | `1` | 最大并发数为1 |

---

## 🎯 设计理念

### 1. 默认开启速率控制

**原因**：
- ✅ 保护通道稳定性，防止突发流量冲击
- ✅ 避免因过度请求导致通道被封禁
- ✅ 提供更安全的默认配置
- ✅ 符合生产环境最佳实践

**影响**：
- 所有新创建的通道都会自动启用速率控制
- 现有通道不受影响（除非手动修改）

### 2. 按秒控制（每秒100次）

**原因**：
- ✅ 秒级控制更精确，能有效防止瞬时流量过大
- ✅ 100次/秒是一个合理的默认值，既不太严格也不太宽松
- ✅ 适合大多数验证码、通知类短信场景

**计算**：
```
每秒100次 × 60秒 = 每分钟6000次
每秒100次 × 3600秒 = 每小时360000次
```

这个速率对于大多数业务场景已经足够。

### 3. 最大并发数为1（串行发送）

**原因**：
- ✅ 最安全的配置，避免并发请求导致的问题
- ✅ 确保请求顺序，便于追踪和调试
- ✅ 降低对下游服务的压力
- ✅ 新通道测试阶段更稳定

**适用场景**：
- 新创建的测试通道
- 不确定并发性能的通道
- 需要严格顺序保证的场景

**性能影响**：
- 并发数为1时，每秒最多100次请求
- 如果需要更高吞吐量，可以手动增加并发数

---

## 🔄 修改的文件

### 1. 前端配置文件

**文件**：`/home/vue-element-admin/src/views/sms/admin/channels.vue`

**修改位置**：
- `data()` 中的 `temp` 对象（第425-429行）
- `resetTemp()` 方法（第504-508行）

**修改内容**：
```javascript
// 修改前
rate_limit_enabled: false,
rate_limit_per_second: 0,
rate_limit_concurrent: 1,

// 修改后
rate_limit_enabled: true,
rate_limit_per_second: 100,
rate_limit_concurrent: 1,
```

### 2. 数据模型文件

**文件**：`/home/vue-element-admin/backend/models/SmsChannel.js`

**修改位置**：第130-149行

**修改内容**：
```javascript
// 修改前
rate_limit_enabled: {
  type: DataTypes.BOOLEAN,
  defaultValue: false,
  comment: '是否启用速率控制'
},
rate_limit_per_second: {
  type: DataTypes.INTEGER,
  comment: '每秒最大请求数'
},
rate_limit_concurrent: {
  type: DataTypes.INTEGER,
  comment: '最大并发请求数'
},

// 修改后
rate_limit_enabled: {
  type: DataTypes.BOOLEAN,
  defaultValue: true,
  comment: '是否启用速率控制'
},
rate_limit_per_second: {
  type: DataTypes.INTEGER,
  defaultValue: 100,
  comment: '每秒最大请求数'
},
rate_limit_concurrent: {
  type: DataTypes.INTEGER,
  defaultValue: 1,
  comment: '最大并发请求数'
},
```

### 3. 数据库迁移脚本

**文件**：
- `/home/vue-element-admin/scripts/add-rate-limit-fields.sql`
- `/home/vue-element-admin/scripts/速率控制迁移SQL.sql`
- `/home/vue-element-admin/scripts/执行速率控制字段迁移.sh`

**修改内容**：
```sql
-- 修改前
ADD COLUMN rate_limit_enabled TINYINT(1) DEFAULT 0 ...
ADD COLUMN rate_limit_per_second INT DEFAULT NULL ...
ADD COLUMN rate_limit_concurrent INT DEFAULT NULL ...

-- 修改后
ADD COLUMN rate_limit_enabled TINYINT(1) DEFAULT 1 ...
ADD COLUMN rate_limit_per_second INT DEFAULT 100 ...
ADD COLUMN rate_limit_concurrent INT DEFAULT 1 ...
```

---

## 📊 使用效果

### 创建新通道

当您创建新通道时，速率控制区域会**自动展开**并显示默认配置：

```
┌─────────────────────────────────────────────┐
│ 速率控制                                     │
├─────────────────────────────────────────────┤
│ 启用速率控制  [关闭 ━━━● 开启] ✓           │
│               防止超频请求，保护通道稳定性   │
│                                             │
│ 每秒限制     [  100  ] [+ -]               │
│              每秒最大发送请求数              │
│                                             │
│ 每分钟限制   [   0   ] [+ -]               │
│              0表示不限制                     │
│                                             │
│ 每小时限制   [   0   ] [+ -]               │
│              0表示不限制                     │
│                                             │
│ 最大并发数   [   1   ] [+ -]               │
│              串行发送，最安全                │
└─────────────────────────────────────────────┘
```

### 对现有通道的影响

⚠️ **重要**：此次修改**不影响现有通道**

- 已创建的通道配置保持不变
- 只有新创建的通道才使用新的默认值
- 如需修改现有通道，请手动编辑

---

## 🎯 不同场景的建议配置

虽然默认配置适合大多数场景，但您仍可根据实际需求调整：

### 场景1：高频验证码通道

```
✓ 启用速率控制
每秒限制：   200    # 更高的QPS
每分钟限制： 0
每小时限制： 0
最大并发数： 20     # 支持并发
```

### 场景2：通知类短信

```
✓ 启用速率控制
每秒限制：   100    # 使用默认值
每分钟限制： 5000   # 添加分钟限制
每小时限制： 0
最大并发数： 10     # 中等并发
```

### 场景3：营销短信

```
✓ 启用速率控制
每秒限制：   50     # 降低QPS
每分钟限制： 2000
每小时限制： 50000  # 添加总量控制
最大并发数： 5      # 较低并发
```

### 场景4：测试通道

```
✓ 启用速率控制
每秒限制：   10     # 严格限制
每分钟限制： 100
每小时限制： 1000
最大并发数： 1      # 使用默认值（串行）
```

---

## ⚙️ 如何调整配置

### 方法1：创建通道时调整

1. 点击【新增】按钮
2. 填写基本信息
3. 滚动到"速率控制"区域
4. 根据需求修改默认值：
   - 调整每秒限制
   - 添加分钟/小时限制
   - 增加并发数
5. 保存

### 方法2：编辑现有通道

1. 在通道列表中找到目标通道
2. 点击【编辑】按钮
3. 滚动到"速率控制"区域
4. 修改配置
5. 保存

### 方法3：关闭速率控制

如果某些通道不需要速率控制：

1. 编辑通道
2. 关闭"启用速率控制"开关
3. 保存

---

## 📝 数据库迁移注意事项

### 执行迁移SQL

使用以下命令执行数据库迁移：

```bash
# 方法1：使用交互式脚本
cd /home/vue-element-admin/scripts
./执行速率控制字段迁移.sh

# 方法2：使用SQL文件
mysql -u root -p sms_system < 速率控制迁移SQL.sql

# 方法3：手动执行
mysql -u root -p
USE sms_system;
# 复制粘贴SQL语句
```

### SQL语句（更新版）

```sql
ALTER TABLE sms_channels 
  ADD COLUMN rate_limit_enabled TINYINT(1) DEFAULT 1 
    COMMENT '是否启用速率控制' AFTER daily_limit,
  ADD COLUMN rate_limit_per_second INT DEFAULT 100 
    COMMENT '每秒最大请求数' AFTER rate_limit_enabled,
  ADD COLUMN rate_limit_per_minute INT DEFAULT NULL 
    COMMENT '每分钟最大请求数' AFTER rate_limit_per_second,
  ADD COLUMN rate_limit_per_hour INT DEFAULT NULL 
    COMMENT '每小时最大请求数' AFTER rate_limit_per_minute,
  ADD COLUMN rate_limit_concurrent INT DEFAULT 1 
    COMMENT '最大并发请求数' AFTER rate_limit_per_hour;
```

### 对现有数据的影响

执行迁移后：

- **新创建的通道**：自动使用默认值
  - `rate_limit_enabled = 1`（开启）
  - `rate_limit_per_second = 100`
  - `rate_limit_concurrent = 1`

- **已存在的通道**：字段值为NULL
  - 需要手动编辑来启用速率控制
  - 或者保持NULL（前端会使用代码中的默认值）

---

## 🔍 验证配置

### 1. 前端验证

创建新通道后，检查默认值：

```javascript
// 打开浏览器控制台，查看表单数据
console.log(this.temp)

// 应该看到：
{
  rate_limit_enabled: true,
  rate_limit_per_second: 100,
  rate_limit_per_minute: 0,
  rate_limit_per_hour: 0,
  rate_limit_concurrent: 1
}
```

### 2. 数据库验证

查询新创建的通道：

```sql
SELECT 
  id,
  channel_name,
  rate_limit_enabled,
  rate_limit_per_second,
  rate_limit_concurrent
FROM sms_channels
ORDER BY created_at DESC
LIMIT 1;
```

应该看到：
```
+----+--------------+--------------------+-----------------------+------------------------+
| id | channel_name | rate_limit_enabled | rate_limit_per_second | rate_limit_concurrent |
+----+--------------+--------------------+-----------------------+------------------------+
|  6 | 新通道       |                  1 |                   100 |                      1 |
+----+--------------+--------------------+-----------------------+------------------------+
```

---

## ❓ 常见问题

### Q1: 为什么默认开启速率控制？

**A**: 为了保护通道稳定性和安全性：
- 防止因过度请求导致通道被封禁
- 避免突发流量冲击下游服务
- 提供更安全的生产环境默认配置

### Q2: 每秒100次是否太严格？

**A**: 这是一个平衡的默认值：
- 100次/秒 = 6000次/分 = 360000次/小时
- 对于大多数验证码、通知场景足够
- 如需更高QPS，可以手动调整

### Q3: 并发数为1会不会太慢？

**A**: 串行发送是最安全的默认配置：
- 新通道测试阶段更稳定
- 降低出错风险
- 如需更高吞吐量，可增加到10-50

### Q4: 现有通道会受影响吗？

**A**: 不会。
- 只影响新创建的通道
- 现有通道配置保持不变
- 数据库迁移时现有记录字段为NULL

### Q5: 如何关闭速率控制？

**A**: 两种方式：
1. 编辑通道，关闭"启用速率控制"开关
2. 设置所有限制值为0（不推荐）

### Q6: 能否设置更复杂的限流规则？

**A**: 当前支持4个维度：
- 每秒限制
- 每分钟限制
- 每小时限制
- 最大并发数

可以组合使用实现复杂的限流策略。

---

## 📚 相关文档

- **功能说明**：`/home/vue-element-admin/通道速率控制功能说明.md`
- **迁移指南**：`/home/vue-element-admin/速率控制功能-数据库迁移指南.md`
- **界面说明**：`/home/vue-element-admin/速率控制功能-界面说明.md`
- **完成总结**：`/home/vue-element-admin/速率控制功能-完成总结.md`

---

## 📋 变更历史

| 日期 | 版本 | 说明 |
|------|------|------|
| 2025-10-22 | v1.1 | 调整默认配置：开启速率控制，每秒100次，并发数1 |
| 2025-10-22 | v1.0 | 初始版本：速率控制功能完成 |

---

**更新者**：AI Assistant  
**更新时间**：2025-10-22  
**版本**：v1.1
