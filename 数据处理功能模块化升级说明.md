# 数据处理功能模块化升级说明

## 升级概述

将数据处理功能全面重构为模块化设计，支持所有系统用户使用，并实现批量数据处理功能。

---

## 主要升级内容

### 1. 用户权限扩展

**之前**：
- 仅客户（customer）可以使用数据处理功能

**现在**：
- ✅ **管理员（admin）**：可以使用所有功能，可以查看和处理所有用户的文件
- ✅ **代理（agent）**：可以使用所有功能，只能查看和处理自己上传的文件
- ✅ **客户（customer）**：可以使用所有功能，只能查看和处理自己上传的文件

### 2. 功能模块化设计

采用卡片式功能模块布局，更直观易用：

#### 功能模块列表

1. **去除国码模块** 🔧
   - 批量去除数据中的国家代码
   - 支持指定国码或去除所有国码
   - 支持同时处理多个文件

2. **数据去重模块** 📋
   - 智能去除重复数据
   - 支持同时处理多个文件
   - 自动统计去重结果

3. **数据对比模块** 📊
   - 对比两个数据文件的差异
   - 支持三种对比模式：
     - 差异（文件1独有）
     - 共有数据
     - 各自独有

4. **按运营商提取模块** 🌐
   - 根据运营商号段筛选数据
   - 支持70个国家的运营商
   - 支持同时处理多个文件

5. **按条数提取模块** 📄
   - 按指定条数提取数据
   - 可设置起始位置
   - 支持同时处理多个文件

### 3. 批量处理能力

**核心功能**：
- ✅ 支持同时上传多个数据文件
- ✅ 支持批量选择文件进行处理
- ✅ 支持批量下载处理结果
- ✅ 批量操作进度反馈

**批量处理流程**：
1. 用户在功能模块中选择多个文件
2. 配置处理参数
3. 系统逐个处理文件
4. 自动下载所有处理结果

### 4. 界面优化

#### 功能模块卡片
```
┌─────────────────────────────────────────────┐
│  🔧      📋      📊      🌐      📄         │
│去除国码  去重   对比  运营商   条数提取      │
│                                             │
│  卡片悬停效果，点击进入相应功能              │
└─────────────────────────────────────────────┘
```

#### 文件管理区
- 支持多选文件
- 显示已选文件数量
- 批量操作提示
- 优化表格显示

---

## 技术实现

### 前端修改

#### 1. 页面结构 (`processing.vue`)

**新增功能模块卡片区**：
```vue
<el-row :gutter="20" class="function-modules">
  <el-col v-for="module in modules">
    <el-card class="module-card" @click="openModule">
      <div class="module-icon">...</div>
      <div class="module-title">...</div>
      <div class="module-desc">...</div>
    </el-card>
  </el-col>
</el-row>
```

**文件管理表格**：
```vue
<el-table 
  @selection-change="handleSelectionChange"
>
  <el-table-column type="selection" />
  <!-- 其他列 -->
</el-table>
```

#### 2. 数据结构优化

**之前**：
```javascript
data() {
  return {
    currentFile: {},  // 单个文件
    // ...
  }
}
```

**现在**：
```javascript
data() {
  return {
    selectedFiles: [],  // 多个文件选择
    deduplicateForm: {
      fileIds: []  // 批量处理
    },
    removeCodeForm: {
      fileIds: [],  // 批量处理
      countryCode: ''
    },
    // ...
  }
}
```

#### 3. 批量处理方法

```javascript
async confirmDeduplicate() {
  const results = []
  for (const fileId of this.deduplicateForm.fileIds) {
    const response = await request({
      url: '/api/data-processing/deduplicate',
      method: 'post',
      data: { fileId }
    })
    results.push(response.data)
  }
  
  // 批量下载
  results.forEach(result => {
    this.downloadFile(result.downloadPath)
  })
}
```

### 后端修改

#### 1. 权限控制优化

**文件上传** (`dataProcessing.js`):
```javascript
// 之前：仅客户可上传
if (userType !== 'customer') {
  return res.status(403)
}

// 现在：所有用户都可以上传
const { userId, userType, loginAccount } = req.user;
// 直接处理
```

**文件列表** (`dataProcessing.js`):
```javascript
// 之前：客户 + 管理员
if (userType === 'admin') {
  // 管理员逻辑
} else if (userType === 'customer') {
  // 客户逻辑
} else {
  return res.status(403)
}

// 现在：所有用户
if (userType === 'admin') {
  // 管理员查看所有文件
} else {
  // 其他用户查看自己的文件
}
```

**数据处理** (`dataProcessing.js`):
```javascript
// 权限检查：管理员可以操作所有文件，其他用户只能操作自己的文件
if (userType !== 'admin' && file.customer_id !== userId) {
  return res.status(403).json({ 
    success: false, 
    message: '无权限操作此文件' 
  });
}
```

#### 2. 路由配置

**前端路由** (`router/index.js`):
```javascript
{
  path: 'processing',
  meta: {
    roles: ['admin', 'agent', 'customer']  // 所有用户
  }
}
```

---

## 样式优化

### 功能模块卡片样式

```scss
.module-card {
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
  padding: 30px 20px;
  
  &:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }
  
  .module-icon {
    font-size: 48px;
    color: #409eff;
  }
  
  .module-title {
    font-size: 18px;
    font-weight: 600;
  }
  
  .module-desc {
    font-size: 14px;
    color: #909399;
  }
}
```

---

## 使用流程

### 1. 上传数据文件

1. 点击"上传文件"按钮
2. 支持拖拽或点击选择多个 TXT 文件
3. 单个文件不超过 100MB
4. 文件自动保存 1 个月

### 2. 批量数据处理

#### 方式一：通过功能模块卡片

1. 在文件列表中勾选要处理的文件
2. 点击对应的功能模块卡片
3. 配置处理参数（自动填充已选文件）
4. 点击"开始处理"
5. 等待处理完成，自动下载结果

#### 方式二：直接选择文件

1. 点击功能模块卡片
2. 在对话框中选择要处理的文件
3. 配置处理参数
4. 点击"开始处理"
5. 等待处理完成，自动下载结果

### 3. 功能使用示例

#### 去除国码（批量）

```
1. 选择 3 个文件：data1.txt, data2.txt, data3.txt
2. 点击"去除国码"模块
3. 输入国码"+86"（或留空去除所有）
4. 点击"开始处理"
5. 自动下载 3 个处理后的文件
```

#### 数据去重（批量）

```
1. 选择 5 个文件
2. 点击"数据去重"模块
3. 直接点击"开始去重"
4. 系统自动处理 5 个文件
5. 显示处理结果并下载
```

#### 数据对比（单次）

```
1. 点击"数据对比"模块
2. 选择主文件：file1.txt
3. 选择对比文件：file2.txt
4. 选择对比模式：差异（文件1独有）
5. 点击"开始对比"
6. 下载对比结果
```

---

## 权限矩阵

| 功能 | 管理员 | 代理 | 客户 |
|------|--------|------|------|
| 上传文件 | ✅ | ✅ | ✅ |
| 查看自己的文件 | ✅ | ✅ | ✅ |
| 查看所有文件 | ✅ | ❌ | ❌ |
| 处理自己的文件 | ✅ | ✅ | ✅ |
| 处理他人的文件 | ✅ | ❌ | ❌ |
| 删除自己的文件 | ✅ | ✅ | ✅ |
| 删除他人的文件 | ✅ | ❌ | ❌ |
| 去除国码 | ✅ | ✅ | ✅ |
| 数据去重 | ✅ | ✅ | ✅ |
| 数据对比 | ✅ | ✅ | ✅ |
| 按运营商提取 | ✅ | ✅ | ✅ |
| 按条数提取 | ✅ | ✅ | ✅ |
| 批量处理 | ✅ | ✅ | ✅ |

---

## 文件清单

### 修改的文件

1. **前端**:
   - `/home/vue-element-admin/src/views/data/processing.vue`
     - 重构页面布局为模块化设计
     - 添加批量处理功能
     - 优化用户交互体验
   
   - `/home/vue-element-admin/src/router/index.js`
     - 更新权限配置：`roles: ['admin', 'agent', 'customer']`

2. **后端**:
   - `/home/vue-element-admin/backend/routes/dataProcessing.js`
     - 移除"仅客户"限制
     - 优化权限检查逻辑
     - 支持所有用户访问

### 未修改的文件

- `/home/vue-element-admin/backend/models/CustomerDataFile.js`
- `/home/vue-element-admin/backend/utils/dataProcessor.js`
- `/home/vue-element-admin/src/data/operators.js`
- `/home/vue-element-admin/src/data/countries.js`

---

## 测试建议

### 1. 功能测试

#### 管理员账号测试
```
1. 登录 admin 账号
2. 上传测试文件
3. 查看文件列表（应显示所有用户的文件）
4. 测试各个功能模块
5. 批量处理多个文件
```

#### 代理账号测试
```
1. 创建代理账号
2. 上传测试文件
3. 查看文件列表（只显示自己的文件）
4. 测试各个功能模块
5. 批量处理
```

#### 客户账号测试
```
1. 登录客户账号
2. 上传测试文件
3. 查看文件列表（只显示自己的文件）
4. 测试所有功能模块
5. 批量处理
```

### 2. 批量处理测试

```
测试场景1：批量去重
- 上传 5 个包含重复数据的文件
- 选择全部 5 个文件
- 执行批量去重
- 验证所有文件都被处理
- 验证结果文件正确

测试场景2：批量去除国码
- 上传 3 个包含国码的文件
- 批量去除 +86 国码
- 验证处理结果

测试场景3：混合操作
- 同时进行多种操作
- 验证互不干扰
```

### 3. 权限测试

```
1. 代理尝试处理客户的文件 → 应失败
2. 客户尝试查看其他客户的文件 → 应看不到
3. 管理员处理任意文件 → 应成功
```

---

## 性能优化

### 批量处理优化

由于批量处理是串行执行（逐个处理文件），可能会有性能问题。未来可以考虑：

1. **并发处理**：使用 Promise.all 并发处理多个文件
2. **后台任务**：将批量处理放到后台队列
3. **进度提示**：显示处理进度条
4. **分批下载**：打包所有结果为 ZIP 文件

---

## 注意事项

1. **文件大小限制**：单个文件最大 100MB
2. **文件格式**：仅支持 TXT 格式
3. **保存时间**：文件保存 1 个月后自动删除
4. **批量限制**：建议单次批量处理不超过 10 个文件
5. **浏览器兼容**：建议使用 Chrome、Firefox 最新版本

---

## 升级优势

### 1. 用户体验
- ✅ 模块化设计更直观
- ✅ 卡片式布局更美观
- ✅ 操作流程更简洁
- ✅ 批量处理更高效

### 2. 功能扩展
- ✅ 所有用户都可使用
- ✅ 支持批量操作
- ✅ 权限控制更精细
- ✅ 易于添加新功能

### 3. 代码质量
- ✅ 组件结构更清晰
- ✅ 代码复用性更高
- ✅ 维护成本更低
- ✅ 扩展性更好

---

## 升级时间

- **升级日期**：2025-10-15
- **升级人员**：AI Assistant
- **测试状态**：待测试

---

## 后续优化计划

1. **性能优化**：
   - 实现并发批量处理
   - 添加处理进度显示
   - 优化大文件处理

2. **功能增强**：
   - 添加数据合并功能
   - 支持更多文件格式
   - 添加数据验证功能

3. **用户体验**：
   - 添加操作历史记录
   - 支持收藏常用配置
   - 添加快捷操作

---

## 联系方式

如有问题或建议，请联系开发团队。
