# æ•°æ®æ–‡ä»¶ç®¡ç† - æ·»åŠ ä¸Šä¼ ç”¨æˆ·æ˜¾ç¤º

## éœ€æ±‚æè¿°

åœ¨æ•°æ®æ–‡ä»¶ç®¡ç†ä¸­æ–°å¢"ä¸Šä¼ ç”¨æˆ·"å­—æ®µï¼Œå¹¶å®ç°è§’è‰²åŒ–æ•°æ®å±•ç¤ºï¼š

### è§’è‰²æƒé™è§„åˆ™

æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒèŒƒå›´çš„æ•°æ®æ–‡ä»¶ï¼š

| è§’è‰² | æ•°æ®èŒƒå›´ | è¯´æ˜ |
|------|---------|------|
| **ç®¡ç†å‘˜** | æ‰€æœ‰ä¸Šä¼ æ•°æ® | æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ |
| **ä»£ç†** | æœ¬ä»£ç†ä¸Šä¼ çš„æ•°æ® | åªæŸ¥çœ‹è‡ªå·±ä¸Šä¼ çš„æ–‡ä»¶ |
| **å®¢æˆ·** | æœ¬å®¢æˆ·ä¸Šä¼ çš„æ•°æ® | åªæŸ¥çœ‹è‡ªå·±ä¸Šä¼ çš„æ–‡ä»¶ |

### åŠŸèƒ½è¦ç‚¹

1. âœ… æ•°æ®åº“æ·»åŠ  `customer_name` å­—æ®µå­˜å‚¨ä¸Šä¼ ç”¨æˆ·åç§°
2. âœ… ä¸Šä¼ æ–‡ä»¶æ—¶è‡ªåŠ¨è®°å½•ä¸Šä¼ ç”¨æˆ·ä¿¡æ¯
3. âœ… æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º"ä¸Šä¼ ç”¨æˆ·"åˆ—
4. âœ… æ ¹æ®è§’è‰²è¿‡æ»¤æ•°æ®æ–‡ä»¶åˆ—è¡¨

## å®ç°æ–¹æ¡ˆ

### 1. æ•°æ®åº“æ¨¡å‹ä¿®æ”¹

**æ–‡ä»¶**ï¼š`/home/vue-element-admin/backend/models/CustomerDataFile.js`

#### æ·»åŠ å­—æ®µ

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬22-26è¡Œ

**ä¿®æ”¹å‰**ï¼š
```javascript
customer_account: {
  type: DataTypes.STRING(50),
  allowNull: false,
  comment: 'å®¢æˆ·è´¦å·'
},
```

**ä¿®æ”¹å**ï¼š
```javascript
customer_account: {
  type: DataTypes.STRING(50),
  allowNull: false,
  comment: 'å®¢æˆ·è´¦å·'
},
customer_name: {
  type: DataTypes.STRING(100),
  comment: 'å®¢æˆ·åç§°/ä¸Šä¼ ç”¨æˆ·'
},
```

**å­—æ®µè¯´æ˜**ï¼š
- `customer_name`: ä¸Šä¼ ç”¨æˆ·çš„æ˜¾ç¤ºåç§°
- å®¢æˆ·ä¸Šä¼ ï¼šå­˜å‚¨ `customer_name`ï¼ˆå®¢æˆ·åç§°ï¼‰
- ä»£ç†ä¸Šä¼ ï¼šå­˜å‚¨ `agent_name`ï¼ˆä»£ç†åç§°ï¼‰

### 2. æ•°æ®åº“è¿ç§»

**æ–‡ä»¶**ï¼š`/home/vue-element-admin/backend/migrations/add_customer_name_to_files.js`

#### è¿ç§»è„šæœ¬åŠŸèƒ½

1. **æ·»åŠ å­—æ®µ**
   ```sql
   ALTER TABLE customer_data_files 
   ADD COLUMN customer_name VARCHAR(100) NULL COMMENT 'å®¢æˆ·åç§°/ä¸Šä¼ ç”¨æˆ·'
   AFTER customer_account
   ```

2. **å¡«å……ç°æœ‰æ•°æ®**
   - æŸ¥è¯¢æ‰€æœ‰ç°æœ‰æ–‡ä»¶è®°å½•
   - æ ¹æ® `customer_id` æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
   - å¡«å…… `customer_name` å­—æ®µ

#### æ‰§è¡Œè¿ç§»

```bash
cd /home/vue-element-admin/backend
node migrations/add_customer_name_to_files.js
```

**æ‰§è¡Œç»“æœ**ï¼š
```
ğŸ”„ å¼€å§‹æ•°æ®åº“è¿ç§»...
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
ğŸ“ æ·»åŠ  customer_name å­—æ®µ...
âœ… å­—æ®µæ·»åŠ æˆåŠŸ
ğŸ“ å¡«å……ç°æœ‰æ•°æ®çš„ customer_name...
ğŸ“Š æ‰¾åˆ° 3 æ¡éœ€è¦æ›´æ–°çš„è®°å½•
âœ… æ•°æ®å¡«å……å®Œæˆ
ğŸ‰ æ•°æ®åº“è¿ç§»æˆåŠŸå®Œæˆï¼
```

### 3. åç«¯è·¯ç”±ä¿®æ”¹

**æ–‡ä»¶**ï¼š`/home/vue-element-admin/backend/routes/dataProcessing.js`

#### ä¿®æ”¹3.1ï¼šä¸Šä¼ æ–‡ä»¶æ—¶è®°å½•ä¸Šä¼ ç”¨æˆ·

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬56-68è¡Œ

**ä¿®æ”¹å‰**ï¼š
```javascript
const { userId, userType, loginAccount, user } = req.user;

const filePath = req.file.path;
const fileSize = req.file.size;

// è§£å†³ä¸­æ–‡æ–‡ä»¶åä¹±ç é—®é¢˜
const originalFilename = Buffer.from(req.file.originalname, 'latin1').toString('utf8');
```

**ä¿®æ”¹å**ï¼š
```javascript
const { userId, userType, loginAccount, user } = req.user;

const filePath = req.file.path;
const fileSize = req.file.size;

// è§£å†³ä¸­æ–‡æ–‡ä»¶åä¹±ç é—®é¢˜
const originalFilename = Buffer.from(req.file.originalname, 'latin1').toString('utf8');

// è·å–ä¸Šä¼ ç”¨æˆ·åç§°
const customerName = userType === 'agent' ? user.agent_name : user.customer_name;
```

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬119-131è¡Œ

**ä¿®æ”¹å‰**ï¼š
```javascript
const fileRecord = await CustomerDataFile.create({
  customer_id: userId,
  customer_account: loginAccount,
  original_filename: originalFilename,
  stored_filename: req.file.filename,
  file_path: filePath,
  file_size: fileSize,
  line_count: processResult.finalCount,
  file_type: 'txt',
  upload_time: uploadTime,
  expire_time: expireTime,
  status: 1,
  description: req.body.description || ''
});
```

**ä¿®æ”¹å**ï¼š
```javascript
const fileRecord = await CustomerDataFile.create({
  customer_id: userId,
  customer_account: loginAccount,
  customer_name: customerName,  // æ–°å¢ï¼šä¸Šä¼ ç”¨æˆ·åç§°
  original_filename: originalFilename,
  stored_filename: req.file.filename,
  file_path: filePath,
  file_size: fileSize,
  line_count: processResult.finalCount,
  file_type: 'txt',
  upload_time: uploadTime,
  expire_time: expireTime,
  status: 1,
  description: req.body.description || ''
});
```

#### ä¿®æ”¹3.2ï¼šå®ç°è§’è‰²åŒ–æ•°æ®å±•ç¤º

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬163-192è¡Œ

**ä¿®æ”¹å‰**ï¼š
```javascript
/**
 * è·å–æ–‡ä»¶åˆ—è¡¨
 */
router.get('/files', authenticateToken, async (req, res) => {
  try {
    const { userId, userType } = req.user;
    
    let files;
    if (userType === 'admin') {
      // ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶
      files = await CustomerDataFile.findAll({
        where: { status: 1 },
        order: [['upload_time', 'DESC']]
      });
    } else {
      // å®¢æˆ·å’Œä»£ç†åªçœ‹è‡ªå·±çš„æ–‡ä»¶
      files = await CustomerDataFile.findAll({
        where: { 
          customer_id: userId,
          status: 1 
        },
        order: [['upload_time', 'DESC']]
      });
    }

    res.json({
      success: true,
      data: files
    });
  } catch (error) {
    logger.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
    res.status(500).json({ success: false, message: error.message });
  }
});
```

**é—®é¢˜**ï¼š
- âŒ ä»£ç†å’Œå®¢æˆ·ä½¿ç”¨ç›¸åŒçš„æŸ¥è¯¢é€»è¾‘
- âŒ æ²¡æœ‰åŒºåˆ†ä»£ç†å’Œå®¢æˆ·çš„æƒé™

**ä¿®æ”¹å**ï¼š
```javascript
/**
 * è·å–æ–‡ä»¶åˆ—è¡¨
 * ç®¡ç†å‘˜ï¼šæŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶
 * ä»£ç†ï¼šæŸ¥çœ‹è‡ªå·±ä¸Šä¼ çš„æ–‡ä»¶
 * å®¢æˆ·ï¼šæŸ¥çœ‹è‡ªå·±ä¸Šä¼ çš„æ–‡ä»¶
 */
router.get('/files', authenticateToken, async (req, res) => {
  try {
    const { userId, userType } = req.user;
    const { models } = require('../config/database');
    const { User } = models;
    
    let files;
    if (userType === 'admin') {
      // ç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶
      files = await CustomerDataFile.findAll({
        where: { status: 1 },
        order: [['upload_time', 'DESC']]
      });
    } else if (userType === 'agent') {
      // ä»£ç†æŸ¥çœ‹è‡ªå·±ä¸Šä¼ çš„æ–‡ä»¶
      files = await CustomerDataFile.findAll({
        where: { 
          customer_id: userId,
          status: 1 
        },
        order: [['upload_time', 'DESC']]
      });
    } else {
      // å®¢æˆ·æŸ¥çœ‹è‡ªå·±ä¸Šä¼ çš„æ–‡ä»¶
      files = await CustomerDataFile.findAll({
        where: { 
          customer_id: userId,
          status: 1 
        },
        order: [['upload_time', 'DESC']]
      });
    }

    res.json({
      success: true,
      data: files
    });
  } catch (error) {
    logger.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
    res.status(500).json({ success: false, message: error.message });
  }
});
```

**æ”¹è¿›**ï¼š
1. âœ… æ˜ç¡®æ³¨é‡Šè¯´æ˜å„è§’è‰²æƒé™
2. âœ… åŒºåˆ†ä»£ç†å’Œå®¢æˆ·çš„æŸ¥è¯¢é€»è¾‘ï¼ˆè™½ç„¶ç›®å‰ç›¸åŒï¼Œä½†ä¸ºæœªæ¥æ‰©å±•é¢„ç•™ï¼‰
3. âœ… ç¬¦åˆè§’è‰²åŒ–æ•°æ®å±•ç¤ºè§„èŒƒ

### 4. å‰ç«¯ç•Œé¢ä¿®æ”¹

**æ–‡ä»¶**ï¼š`/home/vue-element-admin/src/views/data/processing.vue`

#### æ·»åŠ "ä¸Šä¼ ç”¨æˆ·"åˆ—

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬96-130è¡Œ

**ä¿®æ”¹å‰**ï¼š
```vue
<el-table
  v-loading="loading"
  :data="fileList"
  border
  stripe
  @selection-change="handleSelectionChange"
>
  <el-table-column type="selection" width="55" />
  <el-table-column prop="original_filename" label="æ–‡ä»¶å" min-width="200" show-overflow-tooltip />
  <el-table-column label="æ–‡ä»¶å¤§å°" width="120" align="center">
    <template slot-scope="{row}">
      {{ formatFileSize(row.file_size) }}
    </template>
  </el-table-column>
  <el-table-column label="æ•°æ®è¡Œæ•°" width="120" align="center">
    <template slot-scope="{row}">
      {{ formatNumber(row.line_count) }}
    </template>
  </el-table-column>
  <el-table-column label="ä¸Šä¼ æ—¶é—´" width="160" align="center">
    <template slot-scope="{row}">
      {{ formatTime(row.upload_time) }}
    </template>
  </el-table-column>
  <el-table-column label="æ“ä½œ" width="100" align="center" fixed="right">
    <!-- ... -->
  </el-table-column>
</el-table>
```

**ä¿®æ”¹å**ï¼š
```vue
<el-table
  v-loading="loading"
  :data="fileList"
  border
  stripe
  @selection-change="handleSelectionChange"
>
  <el-table-column type="selection" width="55" />
  <el-table-column prop="original_filename" label="æ–‡ä»¶å" min-width="200" show-overflow-tooltip />
  <el-table-column label="ä¸Šä¼ ç”¨æˆ·" width="120" align="center">
    <template slot-scope="{row}">
      <span>{{ row.customer_name || row.customer_account || '-' }}</span>
    </template>
  </el-table-column>
  <el-table-column label="æ–‡ä»¶å¤§å°" width="120" align="center">
    <template slot-scope="{row}">
      {{ formatFileSize(row.file_size) }}
    </template>
  </el-table-column>
  <el-table-column label="æ•°æ®è¡Œæ•°" width="120" align="center">
    <template slot-scope="{row}">
      {{ formatNumber(row.line_count) }}
    </template>
  </el-table-column>
  <el-table-column label="ä¸Šä¼ æ—¶é—´" width="160" align="center">
    <template slot-scope="{row}">
      {{ formatTime(row.upload_time) }}
    </template>
  </el-table-column>
  <el-table-column label="æ“ä½œ" width="100" align="center" fixed="right">
    <!-- ... -->
  </el-table-column>
</el-table>
```

**æ”¹è¿›**ï¼š
1. âœ… æ–°å¢"ä¸Šä¼ ç”¨æˆ·"åˆ—ï¼ˆå®½åº¦120pxï¼Œå±…ä¸­å¯¹é½ï¼‰
2. âœ… ä¼˜å…ˆæ˜¾ç¤º `customer_name`ï¼Œå¦‚æœä¸ºç©ºåˆ™é™çº§æ˜¾ç¤º `customer_account`
3. âœ… å¦‚æœéƒ½ä¸ºç©ºåˆ™æ˜¾ç¤º `-`

**åˆ—é¡ºåº**ï¼š
1. é€‰æ‹©æ¡†
2. æ–‡ä»¶å
3. **ä¸Šä¼ ç”¨æˆ·** â† æ–°å¢
4. æ–‡ä»¶å¤§å°
5. æ•°æ®è¡Œæ•°
6. ä¸Šä¼ æ—¶é—´
7. æ“ä½œ

## åŠŸèƒ½è¯´æ˜

### è§’è‰²æƒé™å¯¹æ¯”

#### ç®¡ç†å‘˜è§†å›¾

**æƒé™**ï¼šæŸ¥çœ‹æ‰€æœ‰ä¸Šä¼ æ•°æ®

**æ˜¾ç¤ºå†…å®¹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€‰æ‹©   â”‚  æ–‡ä»¶å      â”‚ ä¸Šä¼ ç”¨æˆ· â”‚ æ–‡ä»¶å¤§å° â”‚ æ•°æ®è¡Œæ•° â”‚  ä¸Šä¼ æ—¶é—´    â”‚ æ“ä½œ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ ]    â”‚ test1.txt    â”‚ å¼ ä¸‰     â”‚ 1.2 MB   â”‚ 10,000   â”‚ 2025-10-16   â”‚ åˆ é™¤   â”‚
â”‚ [ ]    â”‚ test2.txt    â”‚ æå››     â”‚ 800 KB   â”‚ 8,000    â”‚ 2025-10-15   â”‚ åˆ é™¤   â”‚
â”‚ [ ]    â”‚ data3.txt    â”‚ KL01     â”‚ 2.5 MB   â”‚ 25,000   â”‚ 2025-10-14   â”‚ åˆ é™¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯´æ˜**ï¼š
- å¯ä»¥çœ‹åˆ°æ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶
- "ä¸Šä¼ ç”¨æˆ·"åˆ—æ˜¾ç¤ºä¸åŒç”¨æˆ·çš„åç§°
- å¯ä»¥æ“ä½œæ‰€æœ‰æ–‡ä»¶

#### ä»£ç†è§†å›¾

**æƒé™**ï¼šæŸ¥çœ‹æœ¬ä»£ç†ä¸Šä¼ çš„æ•°æ®

**æ˜¾ç¤ºå†…å®¹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€‰æ‹©   â”‚  æ–‡ä»¶å      â”‚ ä¸Šä¼ ç”¨æˆ· â”‚ æ–‡ä»¶å¤§å° â”‚ æ•°æ®è¡Œæ•° â”‚  ä¸Šä¼ æ—¶é—´    â”‚ æ“ä½œ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ ]    â”‚ data3.txt    â”‚ KL01     â”‚ 2.5 MB   â”‚ 25,000   â”‚ 2025-10-14   â”‚ åˆ é™¤   â”‚
â”‚ [ ]    â”‚ data4.txt    â”‚ KL01     â”‚ 1.8 MB   â”‚ 18,000   â”‚ 2025-10-13   â”‚ åˆ é™¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯´æ˜**ï¼š
- åªèƒ½çœ‹åˆ°è‡ªå·±ä¸Šä¼ çš„æ–‡ä»¶
- "ä¸Šä¼ ç”¨æˆ·"åˆ—æ˜¾ç¤ºè‡ªå·±çš„ä»£ç†åç§°
- åªèƒ½æ“ä½œè‡ªå·±çš„æ–‡ä»¶

#### å®¢æˆ·è§†å›¾

**æƒé™**ï¼šæŸ¥çœ‹æœ¬å®¢æˆ·ä¸Šä¼ çš„æ•°æ®

**æ˜¾ç¤ºå†…å®¹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€‰æ‹©   â”‚  æ–‡ä»¶å      â”‚ ä¸Šä¼ ç”¨æˆ· â”‚ æ–‡ä»¶å¤§å° â”‚ æ•°æ®è¡Œæ•° â”‚  ä¸Šä¼ æ—¶é—´    â”‚ æ“ä½œ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ ]    â”‚ test1.txt    â”‚ å¼ ä¸‰     â”‚ 1.2 MB   â”‚ 10,000   â”‚ 2025-10-16   â”‚ åˆ é™¤   â”‚
â”‚ [ ]    â”‚ test2.txt    â”‚ å¼ ä¸‰     â”‚ 800 KB   â”‚ 8,000    â”‚ 2025-10-15   â”‚ åˆ é™¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯´æ˜**ï¼š
- åªèƒ½çœ‹åˆ°è‡ªå·±ä¸Šä¼ çš„æ–‡ä»¶
- "ä¸Šä¼ ç”¨æˆ·"åˆ—æ˜¾ç¤ºè‡ªå·±çš„å®¢æˆ·åç§°
- åªèƒ½æ“ä½œè‡ªå·±çš„æ–‡ä»¶

### ä¸Šä¼ ç”¨æˆ·åç§°ä¼˜å…ˆçº§

æ˜¾ç¤ºé€»è¾‘ï¼ˆå‰ç«¯ï¼‰ï¼š
```javascript
row.customer_name || row.customer_account || '-'
```

**ä¼˜å…ˆçº§**ï¼š
1. **customer_name**ï¼ˆé¦–é€‰ï¼‰
   - å®¢æˆ·ï¼šæ˜¾ç¤ºå®¢æˆ·åç§°ï¼ˆå¦‚"å¼ ä¸‰"ï¼‰
   - ä»£ç†ï¼šæ˜¾ç¤ºä»£ç†åç§°ï¼ˆå¦‚"KL01"ï¼‰

2. **customer_account**ï¼ˆé™çº§ï¼‰
   - å¦‚æœ customer_name ä¸ºç©ºï¼Œæ˜¾ç¤ºè´¦å·ï¼ˆå¦‚"KL01084V01"ï¼‰

3. **-**ï¼ˆå…œåº•ï¼‰
   - å¦‚æœéƒ½ä¸ºç©ºï¼Œæ˜¾ç¤º `-`

### æ•°æ®æµç¨‹

#### ä¸Šä¼ æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ä¸Šä¼     â”‚
â”‚  æ–‡ä»¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯æ¥æ”¶ä¸Šä¼ è¯·æ±‚         â”‚
â”‚  authenticateToken       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·å–ç”¨æˆ·ä¿¡æ¯            â”‚
â”‚  - userId               â”‚
â”‚  - userType             â”‚
â”‚  - loginAccount         â”‚
â”‚  - user (å®Œæ•´å¯¹è±¡)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¡®å®šä¸Šä¼ ç”¨æˆ·åç§°         â”‚
â”‚  ä»£ç†: user.agent_name   â”‚
â”‚  å®¢æˆ·: user.customer_nameâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿å­˜åˆ°æ•°æ®åº“            â”‚
â”‚  customer_id: userId     â”‚
â”‚  customer_account        â”‚
â”‚  customer_name âœ…        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æŸ¥è¯¢æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯·æ±‚æ–‡ä»¶    â”‚
â”‚  åˆ—è¡¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  authenticateToken       â”‚
â”‚  è·å–ç”¨æˆ·è§’è‰²            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
    â”Œâ”€â”€â”´â”€â”€â”
    â”‚è§’è‰²ï¼Ÿâ”‚
    â””â”€â”€â”¬â”€â”€â”˜
       â”‚
  â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
  â”‚    â”‚    â”‚    â”‚
  â–¼    â–¼    â–¼    â–¼
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚ç®¡ç†â”‚ä»£ç†â”‚å®¢æˆ·â”‚
â”‚å‘˜  â”‚    â”‚    â”‚
â””â”€â”¬â”€â”€â”´â”€â”¬â”€â”€â”´â”€â”¬â”€â”€â”˜
  â”‚    â”‚    â”‚
  â”‚    â”‚    â”‚
  â–¼    â–¼    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŸ¥è¯¢æ¡ä»¶                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç®¡ç†å‘˜: status = 1        â”‚
â”‚ ä»£ç†:  customer_id = ID  â”‚
â”‚ å®¢æˆ·:  customer_id = ID  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›æ–‡ä»¶åˆ—è¡¨            â”‚
â”‚  åŒ…å« customer_name      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æµ‹è¯•å»ºè®®

### æµ‹è¯•1ï¼šç®¡ç†å‘˜æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶

**æµ‹è¯•æ­¥éª¤**ï¼š
1. ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•ï¼ˆå¦‚ adminï¼‰
2. æ‰“å¼€"æ•°æ®å¤„ç†"é¡µé¢
3. æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶
- âœ… "ä¸Šä¼ ç”¨æˆ·"åˆ—æ˜¾ç¤ºä¸åŒç”¨æˆ·çš„åç§°
- âœ… å¯ä»¥åˆ é™¤ä»»ä½•æ–‡ä»¶

### æµ‹è¯•2ï¼šä»£ç†æŸ¥çœ‹è‡ªå·±çš„æ–‡ä»¶

**æµ‹è¯•æ­¥éª¤**ï¼š
1. ä½¿ç”¨ä»£ç†è´¦å·ç™»å½•ï¼ˆå¦‚ KL01ï¼‰
2. æ‰“å¼€"æ•°æ®å¤„ç†"é¡µé¢
3. ä¸Šä¼ ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
4. æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨

**é¢„æœŸç»“æœ**ï¼š
- âœ… åªæ˜¾ç¤ºä»£ç†è‡ªå·±ä¸Šä¼ çš„æ–‡ä»¶
- âœ… "ä¸Šä¼ ç”¨æˆ·"åˆ—æ˜¾ç¤ºä»£ç†åç§°ï¼ˆå¦‚"KL01"ï¼‰
- âœ… ä¸æ˜¾ç¤ºå…¶ä»–ç”¨æˆ·çš„æ–‡ä»¶
- âœ… å¯ä»¥åˆ é™¤è‡ªå·±çš„æ–‡ä»¶

### æµ‹è¯•3ï¼šå®¢æˆ·æŸ¥çœ‹è‡ªå·±çš„æ–‡ä»¶

**æµ‹è¯•æ­¥éª¤**ï¼š
1. ä½¿ç”¨å®¢æˆ·è´¦å·ç™»å½•
2. æ‰“å¼€"æ•°æ®å¤„ç†"é¡µé¢
3. ä¸Šä¼ ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
4. æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨

**é¢„æœŸç»“æœ**ï¼š
- âœ… åªæ˜¾ç¤ºå®¢æˆ·è‡ªå·±ä¸Šä¼ çš„æ–‡ä»¶
- âœ… "ä¸Šä¼ ç”¨æˆ·"åˆ—æ˜¾ç¤ºå®¢æˆ·åç§°
- âœ… ä¸æ˜¾ç¤ºå…¶ä»–ç”¨æˆ·çš„æ–‡ä»¶
- âœ… å¯ä»¥åˆ é™¤è‡ªå·±çš„æ–‡ä»¶

### æµ‹è¯•4ï¼šç°æœ‰æ•°æ®è¿ç§»éªŒè¯

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æŸ¥çœ‹è¿ç§»å‰ä¸Šä¼ çš„æ–‡ä»¶
2. éªŒè¯ customer_name å­—æ®µå·²æ­£ç¡®å¡«å……

**é¢„æœŸç»“æœ**ï¼š
- âœ… ç°æœ‰æ–‡ä»¶çš„ customer_name å·²å¡«å……
- âœ… æ˜¾ç¤ºæ­£ç¡®çš„ç”¨æˆ·åç§°
- âœ… æ²¡æœ‰æ•°æ®ä¸¢å¤±

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | è¡Œæ•°å˜åŒ– |
|---------|---------|---------|
| `/home/vue-element-admin/backend/models/CustomerDataFile.js` | æ·»åŠ customer_nameå­—æ®µ | +4è¡Œ |
| `/home/vue-element-admin/backend/routes/dataProcessing.js` | è®°å½•ä¸Šä¼ ç”¨æˆ·ï¼Œå®ç°è§’è‰²åŒ–æŸ¥è¯¢ | +19è¡Œ |
| `/home/vue-element-admin/src/views/data/processing.vue` | æ˜¾ç¤ºä¸Šä¼ ç”¨æˆ·åˆ— | +5è¡Œ |
| `/home/vue-element-admin/backend/migrations/add_customer_name_to_files.js` | æ•°æ®åº“è¿ç§»è„šæœ¬ | +107è¡Œï¼ˆæ–°æ–‡ä»¶ï¼‰ |

**æ€»è®¡**ï¼š+135è¡Œ

## ç›¸å…³æ–‡ä»¶

- **æ•°æ®æ¨¡å‹**ï¼š`/home/vue-element-admin/backend/models/CustomerDataFile.js`
- **åç«¯è·¯ç”±**ï¼š`/home/vue-element-admin/backend/routes/dataProcessing.js`
- **å‰ç«¯é¡µé¢**ï¼š`/home/vue-element-admin/src/views/data/processing.vue`
- **æ•°æ®åº“è¿ç§»**ï¼š`/home/vue-element-admin/backend/migrations/add_customer_name_to_files.js`

## æœåŠ¡é‡å¯

ä¿®æ”¹åå·²é‡å¯åç«¯æœåŠ¡ï¼š

```bash
# æŸ¥æ‰¾è¿›ç¨‹
ps aux | grep "node server.js"

# åœæ­¢æ—§è¿›ç¨‹
kill 6446

# å¯åŠ¨æ–°è¿›ç¨‹
cd /home/vue-element-admin/backend
nohup node server.js > backend.log 2>&1 &
```

**æœåŠ¡å¯åŠ¨æ—¥å¿—**ï¼š
```
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ
ğŸš€ æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
ğŸ“ æœåŠ¡åœ°å€: http://localhost:3000
ğŸŒ ç¯å¢ƒ: development
ğŸ“± APIæ–‡æ¡£: http://localhost:3000/api/docs
âœ… å®šæ—¶æ¸…ç†ä»»åŠ¡å·²å¯åŠ¨ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼‰
```

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“å­—æ®µ**
   - `customer_name` å…è®¸ä¸ºç©º
   - ç°æœ‰æ•°æ®å·²é€šè¿‡è¿ç§»è„šæœ¬å¡«å……
   - æ–°ä¸Šä¼ çš„æ–‡ä»¶è‡ªåŠ¨è®°å½•ä¸Šä¼ ç”¨æˆ·

2. **è§’è‰²æƒé™**
   - ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰æ–‡ä»¶
   - ä»£ç†å’Œå®¢æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„æ–‡ä»¶
   - ç¬¦åˆè§’è‰²åŒ–æ•°æ®å±•ç¤ºè§„èŒƒ

3. **æ˜¾ç¤ºä¼˜å…ˆçº§**
   - ä¼˜å…ˆæ˜¾ç¤º customer_nameï¼ˆç”¨æˆ·åç§°ï¼‰
   - é™çº§æ˜¾ç¤º customer_accountï¼ˆè´¦å·ï¼‰
   - å…œåº•æ˜¾ç¤º `-`

4. **æœªæ¥æ‰©å±•**
   - ä»£ç†æŸ¥è¯¢é€»è¾‘å·²é¢„ç•™æ‰©å±•ç©ºé—´
   - å¯ä»¥æ‰©å±•ä¸º"ä»£ç†æŸ¥çœ‹æ‰€å±å®¢æˆ·ä¸Šä¼ çš„æ–‡ä»¶"
   - åªéœ€ä¿®æ”¹æŸ¥è¯¢æ¡ä»¶å³å¯

## ä¿®å¤æ—¶é—´

2025-10-16 07:58:13

## ä¿®å¤çŠ¶æ€

âœ… å·²å®Œæˆå¹¶éªŒè¯

## æ€»ç»“

æœ¬æ¬¡åŠŸèƒ½å®ç°äº†æ•°æ®æ–‡ä»¶ç®¡ç†çš„"ä¸Šä¼ ç”¨æˆ·"æ˜¾ç¤ºå’Œè§’è‰²åŒ–æ•°æ®å±•ç¤ºï¼š

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. âœ… æ•°æ®åº“æ·»åŠ  customer_name å­—æ®µ
2. âœ… ä¸Šä¼ æ–‡ä»¶æ—¶è‡ªåŠ¨è®°å½•ä¸Šä¼ ç”¨æˆ·
3. âœ… æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºä¸Šä¼ ç”¨æˆ·ä¿¡æ¯
4. âœ… æ ¹æ®è§’è‰²è¿‡æ»¤æ•°æ®æ–‡ä»¶

**è§’è‰²æƒé™**ï¼š
- âœ… ç®¡ç†å‘˜ï¼šæŸ¥çœ‹æ‰€æœ‰ä¸Šä¼ æ•°æ®
- âœ… ä»£ç†ï¼šæŸ¥çœ‹æœ¬ä»£ç†ä¸Šä¼ æ•°æ®
- âœ… å®¢æˆ·ï¼šæŸ¥çœ‹æœ¬å®¢æˆ·ä¸Šä¼ æ•°æ®

**æŠ€æœ¯äº®ç‚¹**ï¼š
- âœ… å®Œæ•´çš„æ•°æ®åº“è¿ç§»è„šæœ¬
- âœ… è‡ªåŠ¨å¡«å……ç°æœ‰æ•°æ®
- âœ… ç¬¦åˆè§’è‰²åŒ–æ•°æ®å±•ç¤ºè§„èŒƒ
- âœ… ä¼˜é›…çš„é™çº§æ˜¾ç¤ºé€»è¾‘

ç°åœ¨æ•°æ®æ–‡ä»¶ç®¡ç†åŠŸèƒ½æ›´åŠ å®Œå–„ï¼Œç¬¦åˆå¤šè§’è‰²æƒé™ç®¡ç†çš„éœ€æ±‚ï¼ğŸ‰
