<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代理创建刷新测试工具</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        
        .tool-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        
        .status-card {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 4px solid #28a745;
        }
        
        .card.warning { border-top-color: #ffc107; }
        .card.error { border-top-color: #dc3545; }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; }
        .btn.danger { background: #dc3545; }
        
        .log-area {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .agent-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .agent-table th,
        .agent-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        
        .agent-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .agent-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .navigation-links {
            text-align: center;
            margin-top: 30px;
        }
        
        .navigation-links a {
            background: #6f42c1;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 25px;
            margin: 0 10px;
            display: inline-block;
            transition: all 0.3s;
        }
        
        .navigation-links a:hover {
            background: #5a32a3;
            transform: translateY(-2px);
        }
        
        .test-form {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin: 20px 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 代理创建刷新测试工具</h1>
        
        <!-- 当前状态 -->
        <div class="tool-section">
            <h3>📊 当前代理数据状态</h3>
            <div class="status-card">
                <div class="card" id="agentCountCard">
                    <h4>📋 代理总数</h4>
                    <p id="agentCount">检测中...</p>
                    <p id="lastCreateTime">最后创建: 检查中...</p>
                </div>
                
                <div class="card" id="refreshFlagCard">
                    <h4>🔄 刷新状态</h4>
                    <p id="refreshFlag">刷新标记: 检查中...</p>
                    <p id="refreshInfo">刷新信息: 检查中...</p>
                </div>
                
                <div class="card" id="dataConsistencyCard">
                    <h4>🔍 数据一致性</h4>
                    <p id="dataConsistency">一致性检查: 进行中...</p>
                    <p id="duplicateCheck">重复检查: 进行中...</p>
                </div>
            </div>
        </div>
        
        <!-- 测试操作面板 -->
        <div class="tool-section">
            <h3>🛠️ 测试操作</h3>
            <div style="text-align: center;">
                <button class="btn" onclick="checkCurrentStatus()">🔍 检查当前状态</button>
                <button class="btn success" onclick="simulateAgentCreate()">➕ 模拟创建代理</button>
                <button class="btn warning" onclick="testRefreshLogic()">🔄 测试刷新逻辑</button>
                <button class="btn" onclick="clearRefreshFlag()">🧹 清除刷新标记</button>
                <button class="btn danger" onclick="clearAgentData()">🗑️ 清空代理数据</button>
            </div>
        </div>
        
        <!-- 代理创建测试表单 -->
        <div class="tool-section">
            <h3>📝 快速创建代理测试</h3>
            <div class="test-form">
                <div class="form-group">
                    <label for="testAgentName">代理名称:</label>
                    <input type="text" id="testAgentName" value="测试代理KL01" placeholder="输入代理名称">
                </div>
                <div class="form-group">
                    <label for="testLoginAccount">登录账号:</label>
                    <input type="text" id="testLoginAccount" value="KL01" placeholder="输入登录账号">
                </div>
                <div class="form-group">
                    <label for="testLevel">代理等级:</label>
                    <select id="testLevel">
                        <option value="1">一级代理</option>
                        <option value="2">二级代理</option>
                        <option value="3">三级代理</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="testCommission">佣金比例 (%):</label>
                    <input type="number" id="testCommission" value="10" step="0.1" min="0" max="100">
                </div>
                <button class="btn success" onclick="createTestAgent()" style="width: 100%;">创建测试代理</button>
            </div>
        </div>
        
        <!-- 问题诊断 -->
        <div class="tool-section">
            <h3>🔧 问题诊断</h3>
            <div id="diagnosisResult">
                <p>点击"检查当前状态"开始诊断...</p>
            </div>
        </div>
        
        <!-- 日志区域 -->
        <div class="tool-section">
            <h3>📋 操作日志</h3>
            <div class="log-area" id="logArea">
                [系统] 代理创建刷新测试工具已启动
            </div>
        </div>
        
        <!-- 代理列表 -->
        <div class="tool-section">
            <h3>📄 当前代理列表</h3>
            <div id="agentListContainer">
                <p>点击"检查当前状态"查看代理列表</p>
            </div>
        </div>
        
        <!-- 导航链接 -->
        <div class="navigation-links">
            <a href="http://localhost:9528/#/user/agent-list" target="_blank">代理列表页面</a>
            <a href="http://localhost:9528/#/user/agent/create" target="_blank">创建代理页面</a>
            <a href="http://localhost:9528/#/dashboard" target="_blank">系统首页</a>
        </div>
    </div>

    <script>
        let logCount = 0;
        
        function addLog(message, type = 'info') {
            logCount++;
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'ℹ️',
                'success': '✅',
                'warning': '⚠️',
                'error': '❌'
            }[type] || 'ℹ️';
            
            logArea.innerHTML += `\n[${timestamp}] ${typeIcon} ${message}`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function updateCard(cardId, status) {
            const card = document.getElementById(cardId);
            card.className = `card ${status}`;
        }
        
        function checkCurrentStatus() {
            addLog('开始检查代理数据状态...', 'info');
            
            try {
                // 检查代理数据
                const agentListStr = localStorage.getItem('agentList');
                const agentList = agentListStr ? JSON.parse(agentListStr) : [];
                
                // 更新代理总数卡片
                document.getElementById('agentCount').textContent = `代理总数: ${agentList.length}`;
                
                if (agentList.length > 0) {
                    const latestAgent = agentList[agentList.length - 1];
                    const createTime = new Date(latestAgent.createTime).toLocaleString();
                    document.getElementById('lastCreateTime').textContent = `最后创建: ${createTime}`;
                    updateCard('agentCountCard', 'success');
                } else {
                    document.getElementById('lastCreateTime').textContent = '最后创建: 无数据';
                    updateCard('agentCountCard', 'warning');
                }
                
                // 检查刷新标记
                const shouldRefresh = localStorage.getItem('shouldRefreshAgentList');
                document.getElementById('refreshFlag').textContent = `刷新标记: ${shouldRefresh || '无'}`;
                document.getElementById('refreshInfo').textContent = shouldRefresh === 'true' ? '需要刷新' : '无需刷新';
                updateCard('refreshFlagCard', shouldRefresh === 'true' ? 'warning' : 'success');
                
                // 数据一致性检查
                const duplicates = findDuplicateAgents(agentList);
                document.getElementById('dataConsistency').textContent = `数据完整性: ${agentList.every(a => a.id && a.agentName) ? '正常' : '异常'}`;
                document.getElementById('duplicateCheck').textContent = `重复数据: ${duplicates.length}条`;
                updateCard('dataConsistencyCard', duplicates.length === 0 ? 'success' : 'warning');
                
                // 显示代理列表
                showAgentList(agentList);
                
                // 诊断结果
                provideDiagnosis(agentList, shouldRefresh, duplicates);
                
                addLog(`状态检查完成 - 共${agentList.length}个代理`, 'success');
                
            } catch (error) {
                addLog(`状态检查失败: ${error.message}`, 'error');
                updateCard('agentCountCard', 'error');
                updateCard('refreshFlagCard', 'error');
                updateCard('dataConsistencyCard', 'error');
            }
        }
        
        function findDuplicateAgents(agentList) {
            const seen = new Set();
            const duplicates = [];
            
            agentList.forEach(agent => {
                const key = `${agent.agentName}_${agent.loginAccount}`;
                if (seen.has(key)) {
                    duplicates.push(agent);
                } else {
                    seen.add(key);
                }
            });
            
            return duplicates;
        }
        
        function showAgentList(agentList) {
            const container = document.getElementById('agentListContainer');
            
            if (agentList.length === 0) {
                container.innerHTML = '<p style="color: #ffc107;">⚠️ 暂无代理数据</p>';
                return;
            }
            
            let tableHTML = '<table class="agent-table"><thead><tr>';
            tableHTML += '<th>ID</th><th>代理名称</th><th>登录账号</th><th>等级</th><th>佣金(%)</th><th>创建时间</th><th>状态</th>';
            tableHTML += '</tr></thead><tbody>';
            
            agentList.forEach(agent => {
                const createTime = new Date(agent.createTime).toLocaleString();
                const levelText = { 1: '一级', 2: '二级', 3: '三级' }[agent.level] || '未知';
                const statusText = agent.status === 1 ? '激活' : '停用';
                
                tableHTML += `<tr>
                    <td>${agent.id}</td>
                    <td>${agent.agentName}</td>
                    <td>${agent.loginAccount}</td>
                    <td>${levelText}代理</td>
                    <td>${agent.commission}%</td>
                    <td>${createTime}</td>
                    <td>${statusText}</td>
                </tr>`;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = `<p>📊 当前共有${agentList.length}个代理：</p>` + tableHTML;
        }
        
        function provideDiagnosis(agentList, shouldRefresh, duplicates) {
            const diagnosisDiv = document.getElementById('diagnosisResult');
            let diagnosis = [];
            
            if (agentList.length === 0) {
                diagnosis.push({
                    type: 'warning',
                    title: '⚠️ 代理数据为空',
                    desc: '检测到localStorage中没有代理数据',
                    solutions: ['尝试创建一个测试代理', '检查数据是否被意外清除', '访问代理创建页面手动创建']
                });
            }
            
            if (shouldRefresh === 'true') {
                diagnosis.push({
                    type: 'info',
                    title: '🔄 检测到刷新标记',
                    desc: '系统标记需要刷新代理列表',
                    solutions: ['访问代理列表页面会自动刷新', '点击"清除刷新标记"手动清除', '这是正常的刷新机制']
                });
            }
            
            if (duplicates.length > 0) {
                diagnosis.push({
                    type: 'error',
                    title: '❌ 发现重复数据',
                    desc: `发现${duplicates.length}条重复的代理数据`,
                    solutions: ['清空代理数据重新开始', '手动删除重复数据', '检查创建逻辑是否有问题']
                });
            }
            
            if (diagnosis.length === 0) {
                diagnosis.push({
                    type: 'success',
                    title: '✅ 系统状态正常',
                    desc: '代理数据和刷新机制工作正常',
                    solutions: ['可以正常创建和管理代理', '刷新机制运行正常', '数据完整性良好']
                });
            }
            
            let diagnosisHTML = '';
            diagnosis.forEach(item => {
                diagnosisHTML += `
                    <div class="highlight">
                        <h4>${item.title}</h4>
                        <p><strong>描述：</strong>${item.desc}</p>
                        <p><strong>建议：</strong></p>
                        <ul>
                            ${item.solutions.map(sol => `<li>${sol}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });
            
            diagnosisDiv.innerHTML = diagnosisHTML;
        }
        
        function simulateAgentCreate() {
            addLog('开始模拟代理创建过程...', 'info');
            
            try {
                const agentListStr = localStorage.getItem('agentList');
                let agentList = agentListStr ? JSON.parse(agentListStr) : [];
                
                // 获取新ID
                const maxId = agentList.reduce((max, agent) => Math.max(max, agent.id || 0), 0);
                const newId = maxId + 1;
                
                // 创建测试代理
                const newAgent = {
                    id: newId,
                    agentName: `模拟代理${newId}`,
                    loginAccount: `test${newId}`,
                    loginPassword: 'password123',
                    level: Math.floor(Math.random() * 3) + 1,
                    commission: 10.0 + Math.random() * 5,
                    dataCountry: ['ALL'],
                    dataValidity: ['30days'],
                    email: `test${newId}@example.com`,
                    remark: '这是模拟创建的代理',
                    status: 1,
                    bindUsers: 0,
                    totalCommission: 0,
                    createTime: Date.now()
                };
                
                // 添加到列表
                agentList.push(newAgent);
                localStorage.setItem('agentList', JSON.stringify(agentList));
                
                // 设置刷新标记（模拟创建页面的行为）
                localStorage.setItem('shouldRefreshAgentList', 'true');
                
                addLog(`代理创建成功: ${newAgent.agentName} (ID: ${newAgent.id})`, 'success');
                addLog('已设置刷新标记，等待列表页面刷新', 'info');
                
                // 重新检查状态
                checkCurrentStatus();
                
            } catch (error) {
                addLog(`模拟创建失败: ${error.message}`, 'error');
            }
        }
        
        function createTestAgent() {
            addLog('开始创建自定义测试代理...', 'info');
            
            try {
                const agentName = document.getElementById('testAgentName').value;
                const loginAccount = document.getElementById('testLoginAccount').value;
                const level = parseInt(document.getElementById('testLevel').value);
                const commission = parseFloat(document.getElementById('testCommission').value);
                
                if (!agentName || !loginAccount) {
                    addLog('请填写代理名称和登录账号', 'warning');
                    return;
                }
                
                const agentListStr = localStorage.getItem('agentList');
                let agentList = agentListStr ? JSON.parse(agentListStr) : [];
                
                // 检查是否重复
                const existing = agentList.find(a => a.loginAccount === loginAccount);
                if (existing) {
                    addLog(`登录账号 ${loginAccount} 已存在，请使用其他账号`, 'warning');
                    return;
                }
                
                // 获取新ID
                const maxId = agentList.reduce((max, agent) => Math.max(max, agent.id || 0), 0);
                const newId = maxId + 1;
                
                // 创建代理
                const newAgent = {
                    id: newId,
                    agentName: agentName,
                    loginAccount: loginAccount,
                    loginPassword: 'password123',
                    level: level,
                    commission: commission,
                    dataCountry: ['ALL'],
                    dataValidity: ['30days'],
                    email: `${loginAccount}@example.com`,
                    remark: '测试工具创建的代理',
                    status: 1,
                    bindUsers: 0,
                    totalCommission: 0,
                    createTime: Date.now()
                };
                
                // 添加到列表
                agentList.push(newAgent);
                localStorage.setItem('agentList', JSON.stringify(agentList));
                
                // 设置刷新标记
                localStorage.setItem('shouldRefreshAgentList', 'true');
                
                addLog(`代理 ${agentName} 创建成功 (ID: ${newId})`, 'success');
                addLog('现在可以访问代理列表页面查看新创建的代理', 'info');
                
                // 清空表单
                document.getElementById('testAgentName').value = '';
                document.getElementById('testLoginAccount').value = '';
                document.getElementById('testCommission').value = '10';
                
                // 重新检查状态
                checkCurrentStatus();
                
            } catch (error) {
                addLog(`创建代理失败: ${error.message}`, 'error');
            }
        }
        
        function testRefreshLogic() {
            addLog('测试刷新逻辑...', 'info');
            
            // 模拟刷新检查逻辑
            const shouldRefresh = localStorage.getItem('shouldRefreshAgentList');
            
            if (shouldRefresh === 'true') {
                addLog('✅ 检测到刷新标记，模拟列表刷新', 'success');
                localStorage.removeItem('shouldRefreshAgentList');
                addLog('🔄 模拟刷新完成，标记已清除', 'success');
            } else {
                addLog('ℹ️ 未检测到刷新标记，无需刷新', 'info');
            }
            
            checkCurrentStatus();
        }
        
        function clearRefreshFlag() {
            localStorage.removeItem('shouldRefreshAgentList');
            addLog('刷新标记已清除', 'info');
            checkCurrentStatus();
        }
        
        function clearAgentData() {
            if (!confirm('⚠️ 确定要清空所有代理数据吗？此操作不可恢复！')) {
                return;
            }
            
            localStorage.removeItem('agentList');
            localStorage.removeItem('shouldRefreshAgentList');
            addLog('所有代理数据已清空', 'warning');
            checkCurrentStatus();
        }
        
        // 页面加载时自动检查
        window.addEventListener('load', function() {
            addLog('页面加载完成，开始自动检查...', 'info');
            setTimeout(checkCurrentStatus, 1000);
        });
    </script>
</body>
</html>