<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>购买数据匹配测试工具</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .status-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 4px solid #28a745;
        }
        
        .status-card.warning { border-top-color: #ffc107; }
        .status-card.error { border-top-color: #dc3545; }
        .status-card.info { border-top-color: #007bff; }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: #212529; }
        .btn.danger { background: #dc3545; }
        
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .comparison-table {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .comparison-column {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .comparison-column.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .comparison-column.purchased {
            background: #fff3e0;
            border-color: #ff9800;
        }
        
        .log-area {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .user-selector {
            background: #e8f4fd;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .user-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .navigation-links {
            text-align: center;
            margin-top: 30px;
        }
        
        .navigation-links a {
            background: #6f42c1;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 25px;
            margin: 0 10px;
            display: inline-block;
            transition: all 0.3s;
        }
        
        .navigation-links a:hover {
            background: #5a32a3;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 购买数据匹配测试工具</h1>
        
        <!-- 问题说明 -->
        <div class="test-section">
            <h3>❗ 问题描述</h3>
            <div class="highlight">
                <p><strong>问题：</strong>用户KL01880V01在资源中心可用数据购买的数据不是选中购买的数据</p>
                <p><strong>原因：</strong>购买页面使用硬编码数据而不是根据ID从localStorage获取真实数据</p>
                <p><strong>影响：</strong>用户选择的数据与实际购买的数据不一致，可能导致业务损失</p>
                <p><strong>修复：</strong>已修改fetchDataInfo方法从localStorage根据ID获取真实数据</p>
            </div>
        </div>
        
        <!-- 用户选择器 -->
        <div class="test-section">
            <h3>👤 测试用户选择</h3>
            <div class="user-selector">
                <label for="testUser">选择测试用户：</label>
                <select id="testUser" onchange="switchUser()">
                    <option value="">请选择用户进行测试</option>
                    <option value="KL01880V01">KL01880V01 (问题用户)</option>
                    <option value="test_customer">测试客户</option>
                </select>
            </div>
        </div>
        
        <!-- 当前状态 -->
        <div class="test-section">
            <h3>📊 数据匹配状态检测</h3>
            <div class="status-grid">
                <div class="status-card" id="dataCountCard">
                    <h4>📋 可购买数据</h4>
                    <p id="dataCount">检测中...</p>
                    <p id="dataSource">数据来源: 检查中...</p>
                </div>
                
                <div class="status-card" id="matchingCard">
                    <h4>🎯 数据匹配状态</h4>
                    <p id="matchingStatus">匹配状态: 检测中...</p>
                    <p id="matchingInfo">匹配信息: 检测中...</p>
                </div>
                
                <div class="status-card" id="userBalanceCard">
                    <h4>💰 用户余额状态</h4>
                    <p id="userBalance">余额: 检测中...</p>
                    <p id="balanceStatus">状态: 检测中...</p>
                </div>
                
                <div class="status-card" id="priceCalculationCard">
                    <h4>💲 价格计算状态</h4>
                    <p id="priceCalculation">价格计算: 检测中...</p>
                    <p id="discountRate">折扣比例: 检测中...</p>
                </div>
            </div>
        </div>
        
        <!-- 测试操作 -->
        <div class="test-section">
            <h3>🛠️ 测试操作</h3>
            <div style="text-align: center;">
                <button class="btn" onclick="checkDataMatching()">🔍 检查数据匹配</button>
                <button class="btn success" onclick="simulatePurchaseFlow()">🛒 模拟购买流程</button>
                <button class="btn warning" onclick="createTestData()">📊 创建测试数据</button>
                <button class="btn" onclick="validatePurchaseData()">✅验证购买数据</button>
                <button class="btn danger" onclick="clearTestData()">🗑️ 清空测试数据</button>
            </div>
        </div>
        
        <!-- 数据比较 -->
        <div class="test-section">
            <h3>⚖️ 数据匹配比较</h3>
            <div class="comparison-table">
                <div class="comparison-column selected" id="selectedDataColumn">
                    <h4>🎯 用户选中的数据</h4>
                    <div id="selectedDataContent">
                        <p>点击"检查数据匹配"获取选中数据信息</p>
                    </div>
                </div>
                <div class="comparison-column purchased" id="purchaseDataColumn">
                    <h4>🛒 实际购买的数据</h4>
                    <div id="purchaseDataContent">
                        <p>点击"模拟购买流程"获取购买数据信息</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 修复验证 -->
        <div class="test-section">
            <h3>🔧 修复验证</h3>
            <div id="fixValidation">
                <p>等待测试结果...</p>
            </div>
        </div>
        
        <!-- 操作日志 -->
        <div class="test-section">
            <h3>📋 测试日志</h3>
            <div class="log-area" id="logArea">
                [系统] 购买数据匹配测试工具已启动
            </div>
        </div>
        
        <!-- 数据列表 -->
        <div class="test-section">
            <h3>📄 当前可购买数据</h3>
            <div id="dataListContainer">
                <p>点击"检查数据匹配"查看数据列表</p>
            </div>
        </div>
        
        <!-- 导航链接 -->
        <div class="navigation-links">
            <a href="http://localhost:9528/#/resource/center" target="_blank">资源中心</a>
            <a href="http://localhost:9528/#/order/list" target="_blank">订单列表</a>
            <a href="http://localhost:9528/#/user/customer-list" target="_blank">客户管理</a>
        </div>
    </div>

    <script>
        let currentTestUser = null;
        let testDataList = [];
        let logCount = 0;
        
        function addLog(message, type = 'info') {
            logCount++;
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': 'ℹ️',
                'success': '✅',
                'warning': '⚠️',
                'error': '❌'
            }[type] || 'ℹ️';
            
            logArea.innerHTML += `\n[${timestamp}] ${typeIcon} ${message}`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function updateCard(cardId, status) {
            const card = document.getElementById(cardId);
            card.className = `status-card ${status}`;
        }
        
        function switchUser() {
            const userSelect = document.getElementById('testUser');
            currentTestUser = userSelect.value;
            
            if (currentTestUser) {
                addLog(`切换测试用户: ${currentTestUser}`, 'info');
                simulateUserLogin(currentTestUser);
            } else {
                addLog('未选择测试用户', 'warning');
            }
        }
        
        function simulateUserLogin(userId) {
            try {
                let userData;
                if (userId === 'KL01880V01') {
                    userData = {
                        id: 101,
                        customerName: 'KL01880V01',
                        loginAccount: 'KL01880V01',
                        email: 'kl01880v01@example.com',
                        type: 'customer',
                        accountBalance: 1000.00,
                        salePriceRate: 0.9
                    };
                } else {
                    userData = {
                        id: 102,
                        customerName: '测试客户',
                        loginAccount: 'test_customer',
                        email: 'test@example.com',
                        type: 'customer',
                        accountBalance: 2000.00,
                        salePriceRate: 1.0
                    };
                }
                
                localStorage.setItem('currentUser', JSON.stringify(userData));
                
                const savedUsers = localStorage.getItem('userList');
                let users = savedUsers ? JSON.parse(savedUsers) : [];
                
                const existingIndex = users.findIndex(u => u.id === userData.id);
                if (existingIndex !== -1) {
                    users[existingIndex] = userData;
                } else {
                    users.push(userData);
                }
                
                localStorage.setItem('userList', JSON.stringify(users));
                
                addLog(`用户 ${userId} 登录成功，余额: ${userData.accountBalance}U，价格比例: ${userData.salePriceRate}`, 'success');
                
            } catch (error) {
                addLog(`用户登录失败: ${error.message}`, 'error');
            }
        }
        
        function createTestData() {
            addLog('开始创建测试数据...', 'info');
            
            try {
                testDataList = [
                    {
                        id: 1001,
                        country: '孟加拉国',
                        countryCode: 'BD',
                        dataType: '手机号码',
                        validity: '3',
                        source: 'KL01880V01测试数据源',
                        availableQuantity: 50000,
                        sellPrice: 0.05,
                        costPrice: 0.03,
                        operators: [
                            { name: 'Grameenphone', count: 25000 },
                            { name: 'Banglalink', count: 25000 }
                        ],
                        remark: 'KL01880V01用户专用测试数据',
                        uploadTime: Date.now() - 1000000,
                        status: 'available'
                    },
                    {
                        id: 1002,
                        country: '印度',
                        countryCode: 'IN',
                        dataType: '手机号码',
                        validity: '30',
                        source: '测试数据源B',
                        availableQuantity: 100000,
                        sellPrice: 0.04,
                        costPrice: 0.025,
                        operators: [
                            { name: 'Airtel', count: 60000 },
                            { name: 'Vodafone', count: 40000 }
                        ],
                        remark: '印度数据测试',
                        uploadTime: Date.now() - 2000000,
                        status: 'available'
                    }
                ];
                
                localStorage.setItem('dataList', JSON.stringify(testDataList));
                
                addLog(`创建${testDataList.length}条测试数据成功`, 'success');
                checkDataMatching();
                
            } catch (error) {
                addLog(`创建测试数据失败: ${error.message}`, 'error');
            }
        }
        
        function checkDataMatching() {
            addLog('开始检查数据匹配状态...', 'info');
            
            try {
                const dataListStr = localStorage.getItem('dataList');
                const dataList = dataListStr ? JSON.parse(dataListStr) : [];
                
                document.getElementById('dataCount').textContent = `可购买数据: ${dataList.length}条`;
                document.getElementById('dataSource').textContent = `数据来源: ${dataList.length > 0 ? 'localStorage' : '无数据'}`;
                updateCard('dataCountCard', dataList.length > 0 ? 'success' : 'warning');
                
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    const userData = JSON.parse(currentUser);
                    document.getElementById('userBalance').textContent = `余额: ${userData.accountBalance || 0}U`;
                    document.getElementById('balanceStatus').textContent = `状态: ${userData.accountBalance > 0 ? '充足' : '不足'}`;
                    updateCard('userBalanceCard', userData.accountBalance > 0 ? 'success' : 'error');
                    
                    const samplePrice = dataList.length > 0 ? dataList[0].sellPrice : 0.05;
                    const finalPrice = samplePrice * (userData.salePriceRate || 1);
                    document.getElementById('priceCalculation').textContent = `最终价格: ${finalPrice.toFixed(4)}U/条`;
                    document.getElementById('discountRate').textContent = `折扣比例: ${userData.salePriceRate || 1}`;
                    updateCard('priceCalculationCard', 'success');
                } else {
                    document.getElementById('userBalance').textContent = '余额: 未登录';
                    document.getElementById('balanceStatus').textContent = '状态: 需要登录';
                    updateCard('userBalanceCard', 'error');
                }
                
                if (dataList.length > 0) {
                    document.getElementById('matchingStatus').textContent = '匹配状态: 数据可用';
                    document.getElementById('matchingInfo').textContent = `匹配信息: ${dataList.length}条数据可供购买`;
                    updateCard('matchingCard', 'success');
                    
                    showDataList(dataList);
                    
                    if (dataList[0]) {
                        showSelectedData(dataList[0]);
                    }
                } else {
                    document.getElementById('matchingStatus').textContent = '匹配状态: 无可用数据';
                    document.getElementById('matchingInfo').textContent = '匹配信息: 请先创建测试数据';
                    updateCard('matchingCard', 'warning');
                }
                
                addLog(`数据匹配检查完成 - 共${dataList.length}条可购买数据`, 'success');
                
            } catch (error) {
                addLog(`数据匹配检查失败: ${error.message}`, 'error');
            }
        }
        
        function showDataList(dataList) {
            const container = document.getElementById('dataListContainer');
            
            if (dataList.length === 0) {
                container.innerHTML = '<p style="color: #ffc107;">⚠️ 暂无可购买数据</p>';
                return;
            }
            
            let tableHTML = '<table class="data-table"><thead><tr>';
            tableHTML += '<th>ID</th><th>国家</th><th>数据类型</th><th>数量</th><th>价格</th><th>操作</th>';
            tableHTML += '</tr></thead><tbody>';
            
            dataList.forEach(item => {
                tableHTML += `<tr>
                    <td>${item.id}</td>
                    <td>${item.country}</td>
                    <td>${item.dataType}</td>
                    <td>${item.availableQuantity.toLocaleString()}</td>
                    <td>${item.sellPrice}U/条</td>
                    <td><button class="btn" onclick="selectDataForPurchase(${item.id})">选择购买</button></td>
                </tr>`;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = `<p>📊 可购买数据列表（共${dataList.length}条）：</p>` + tableHTML;
        }
        
        function selectDataForPurchase(dataId) {
            addLog(`用户选择购买数据ID: ${dataId}`, 'info');
            
            const dataListStr = localStorage.getItem('dataList');
            const dataList = dataListStr ? JSON.parse(dataListStr) : [];
            const selectedData = dataList.find(item => item.id === dataId);
            
            if (selectedData) {
                showSelectedData(selectedData);
                addLog(`选择数据成功: ${selectedData.country} - ${selectedData.dataType}`, 'success');
                
                setTimeout(() => {
                    simulatePurchasePageLoad(dataId);
                }, 1000);
            } else {
                addLog(`未找到ID为${dataId}的数据`, 'error');
            }
        }
        
        function showSelectedData(data) {
            const container = document.getElementById('selectedDataContent');
            
            let html = `
                <div style="font-size: 13px;">
                    <p><strong>数据ID:</strong> ${data.id}</p>
                    <p><strong>国家:</strong> ${data.country}</p>
                    <p><strong>数据类型:</strong> ${data.dataType}</p>
                    <p><strong>可购买数量:</strong> ${data.availableQuantity.toLocaleString()}</p>
                    <p><strong>单价:</strong> ${data.sellPrice}U/条</p>
                    <p><strong>数据来源:</strong> ${data.source}</p>
                    <p><strong>时效性:</strong> ${getValidityText(data.validity)}</p>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function simulatePurchasePageLoad(dataId) {
            addLog(`模拟购买页面加载，获取数据ID: ${dataId}`, 'info');
            
            try {
                // 模拟修复后的fetchDataInfo方法
                const savedDataList = localStorage.getItem('dataList');
                if (!savedDataList) {
                    throw new Error('没有找到dataList数据');
                }
                
                const dataList = JSON.parse(savedDataList);
                const targetData = dataList.find(item => String(item.id) === String(dataId));
                
                if (!targetData) {
                    throw new Error(`没有找到ID为${dataId}的数据`);
                }
                
                addLog(`✅ 购买页面成功获取数据: ${targetData.country} - ${targetData.dataType}`, 'success');
                
                showPurchaseData(targetData);
                validateDataMatching(dataId, targetData);
                
            } catch (error) {
                addLog(`❌ 购买页面数据获取失败: ${error.message}`, 'error');
                
                // 显示硬编码数据（修复前的情况）
                const hardcodedData = {
                    id: dataId,
                    country: '孟加拉国',
                    dataType: '手机号码',
                    validity: '3',
                    source: 'Grameenphone官方',
                    availableQuantity: 500000,
                    sellPrice: 0.05
                };
                
                showPurchaseData(hardcodedData);
                addLog('⚠️ 使用硬编码数据（修复前的行为）', 'warning');
            }
        }
        
        function showPurchaseData(data) {
            const container = document.getElementById('purchaseDataContent');
            
            let html = `
                <div style="font-size: 13px;">
                    <p><strong>数据ID:</strong> ${data.id}</p>
                    <p><strong>国家:</strong> ${data.country}</p>
                    <p><strong>数据类型:</strong> ${data.dataType}</p>
                    <p><strong>可购买数量:</strong> ${data.availableQuantity.toLocaleString()}</p>
                    <p><strong>单价:</strong> ${data.sellPrice}U/条</p>
                    <p><strong>数据来源:</strong> ${data.source}</p>
                    <p><strong>时效性:</strong> ${getValidityText(data.validity)}</p>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function validateDataMatching(selectedId, purchaseData) {
            const validationDiv = document.getElementById('fixValidation');
            
            // 检查数据是否匹配
            const dataListStr = localStorage.getItem('dataList');
            const dataList = dataListStr ? JSON.parse(dataListStr) : [];
            const originalData = dataList.find(item => item.id === selectedId);
            
            if (originalData && 
                originalData.country === purchaseData.country &&
                originalData.dataType === purchaseData.dataType &&
                originalData.source === purchaseData.source) {
                
                validationDiv.innerHTML = `
                    <div class="highlight" style="background: #d4edda; border-color: #c3e6cb;">
                        <h4>✅ 数据匹配验证通过</h4>
                        <p><strong>验证结果:</strong> 用户选中的数据与购买页面显示的数据一致</p>
                        <p><strong>选中数据:</strong> ${originalData.country} - ${originalData.dataType} (ID: ${originalData.id})</p>
                        <p><strong>购买数据:</strong> ${purchaseData.country} - ${purchaseData.dataType} (ID: ${purchaseData.id})</p>
                        <p><strong>修复状态:</strong> ✅ 问题已修复，fetchDataInfo方法正确从localStorage获取数据</p>
                    </div>
                `;
                
                addLog('✅ 数据匹配验证通过：选中数据与购买数据完全一致', 'success');
                
            } else {
                validationDiv.innerHTML = `
                    <div class="highlight" style="background: #f8d7da; border-color: #f5c6cb;">
                        <h4>❌ 数据匹配验证失败</h4>
                        <p><strong>验证结果:</strong> 用户选中的数据与购买页面显示的数据不一致</p>
                        <p><strong>问题原因:</strong> 购买页面未正确根据ID获取数据，使用了硬编码数据</p>
                        <p><strong>修复状态:</strong> ❌ 需要修复fetchDataInfo方法</p>
                    </div>
                `;
                
                addLog('❌ 数据匹配验证失败：选中数据与购买数据不一致', 'error');
            }
        }
        
        function simulatePurchaseFlow() {
            if (!currentTestUser) {
                addLog('请先选择测试用户', 'warning');
                return;
            }
            
            addLog('开始模拟完整购买流程...', 'info');
            
            const dataListStr = localStorage.getItem('dataList');
            if (!dataListStr) {
                addLog('没有可购买数据，请先创建测试数据', 'warning');
                return;
            }
            
            const dataList = JSON.parse(dataListStr);
            if (dataList.length === 0) {
                addLog('没有可购买数据，请先创建测试数据', 'warning');
                return;
            }
            
            // 选择第一条数据进行测试
            selectDataForPurchase(dataList[0].id);
        }
        
        function validatePurchaseData() {
            addLog('开始验证购买数据一致性...', 'info');
            
            try {
                const dataListStr = localStorage.getItem('dataList');
                if (!dataListStr) {
                    addLog('没有找到可购买数据', 'warning');
                    return;
                }
                
                const dataList = JSON.parse(dataListStr);
                const testDataId = dataList.length > 0 ? dataList[0].id : null;
                
                if (!testDataId) {
                    addLog('没有可用的测试数据ID', 'warning');
                    return;
                }
                
                // 模拟获取数据
                simulatePurchasePageLoad(testDataId);
                
            } catch (error) {
                addLog(`验证失败: ${error.message}`, 'error');
            }
        }
        
        function clearTestData() {
            if (!confirm('确定要清空所有测试数据吗？')) {
                return;
            }
            
            localStorage.removeItem('dataList');
            localStorage.removeItem('currentUser');
            addLog('所有测试数据已清空', 'warning');
            
            // 重置界面
            document.getElementById('selectedDataContent').innerHTML = '<p>点击"检查数据匹配"获取选中数据信息</p>';
            document.getElementById('purchaseDataContent').innerHTML = '<p>点击"模拟购买流程"获取购买数据信息</p>';
            document.getElementById('fixValidation').innerHTML = '<p>等待测试结果...</p>';
            document.getElementById('dataListContainer').innerHTML = '<p>点击"检查数据匹配"查看数据列表</p>';
            
            checkDataMatching();
        }
        
        function getValidityText(validity) {
            const validityMap = {
                '3': '3天内',
                '30': '30天内',
                '30+': '30天以上'
            };
            return validityMap[validity] || validity;
        }
        
        // 页面加载时自动检查
        window.addEventListener('load', function() {
            addLog('页面加载完成，开始自动检查...', 'info');
            setTimeout(checkDataMatching, 1000);
        });
    </script>
</body>
</html>