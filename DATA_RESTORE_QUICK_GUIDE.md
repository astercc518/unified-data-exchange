# 数据恢复功能快速使用指南

## 一、功能入口

**访问路径**: 系统管理 → 系统备份  
**URL**: `http://服务器IP/system/backup`

## 二、恢复步骤

### 步骤 1: 选择备份文件

在备份列表中找到需要恢复的备份文件，查看：
- 文件名（包含备份时间）
- 文件大小
- 创建时间

### 步骤 2: 点击恢复按钮

点击该备份行的 **恢复** 按钮（橙色，图标：↺）

### 步骤 3: 确认风险

系统会弹出警告对话框，显示以下信息：

```
⚠️ 警告：
1. 此操作将覆盖当前数据库的所有数据
2. 恢复前会自动创建安全快照
3. 恢复后建议重启后端服务
4. 恢复过程需要 30-60 秒

请确认您已理解上述风险！
```

**重要**: 仔细阅读每一条警告信息！

### 步骤 4: 确认恢复

如果确认要继续，点击 **确认恢复** 按钮

### 步骤 5: 等待完成

- 系统显示"正在恢复数据库，请稍候..."
- 恢复按钮显示 Loading 状态
- **请勿关闭或刷新页面**
- 等待约 30-60 秒

### 步骤 6: 查看结果

**成功提示**:
```
数据库恢复成功！

建议操作：
1. 立即重启后端服务：pm2 restart backend
2. 验证数据是否正确
3. 检查系统功能是否正常
```

**失败提示**:
```
数据库恢复失败！

错误信息：...

建议操作：
1. 检查后端日志：pm2 logs backend
2. 检查数据库连接
3. 尝试使用安全快照恢复
```

### 步骤 7: 重启后端服务（重要！）

恢复成功后，**必须**重启后端服务：

```bash
pm2 restart backend
```

或通过服务器状态页面重启。

### 步骤 8: 验证数据

1. 登录系统
2. 检查关键数据是否正确
3. 测试核心功能
4. 如有问题，立即回滚

## 三、安全快照

### 什么是安全快照？

恢复前，系统会自动创建当前数据库的备份，称为"安全快照"。

**文件名格式**: `pre_restore_YYYYMMDD_HHMMSS.sql.gz`  
**存储位置**: `/home/vue-element-admin/backups/database/`

### 如何使用安全快照回滚？

如果恢复后发现数据有问题，可使用安全快照回滚：

1. **找到最新的安全快照**
   ```bash
   ls -lht /home/vue-element-admin/backups/database/pre_restore_*.sql.gz | head -1
   ```

2. **执行回滚**
   ```bash
   bash /home/vue-element-admin/scripts/restore-database.sh pre_restore_20251024_062345.sql.gz
   ```

3. **重启服务**
   ```bash
   pm2 restart backend
   ```

## 四、常见问题

### Q1: 恢复时提示"备份文件不存在"

**原因**: 备份文件已被删除或移动  
**解决**: 检查备份目录，选择其他备份文件

### Q2: 恢复失败怎么办？

**步骤**:
1. 查看错误信息
2. 检查后端日志：`pm2 logs backend`
3. 使用安全快照回滚
4. 联系技术支持

### Q3: 恢复后数据不完整

**步骤**:
1. 立即使用安全快照回滚
2. 选择更早的备份恢复
3. 检查备份文件是否损坏

### Q4: 恢复后服务无法启动

**步骤**:
1. 检查后端日志：`pm2 logs backend --lines 100`
2. 检查数据库连接：`mysql -u vue_admin_user -p vue_admin`
3. 使用安全快照回滚

## 五、最佳实践

### 恢复前检查清单

- [ ] 确认备份文件是正确的
- [ ] 确认当前数据已备份
- [ ] 确认了解恢复风险
- [ ] 选择低峰期操作
- [ ] 通知相关用户

### 恢复后验证清单

- [ ] 后端服务已重启
- [ ] 数据库连接正常
- [ ] 关键数据正确
- [ ] 核心功能可用
- [ ] 系统日志无异常

## 六、紧急联系

如遇到无法解决的问题：

1. **查看日志**
   - 后端日志: `pm2 logs backend`
   - Nginx 日志: `tail -f /var/log/nginx/ude-error.log`

2. **保留现场**
   - 不要继续操作
   - 截图错误信息
   - 记录操作步骤

3. **备份当前状态**
   ```bash
   bash /home/vue-element-admin/scripts/backup-database.sh
   ```

## 七、示例场景

### 场景 1: 误删数据，需要恢复

1. 立即创建当前数据库备份（保存误删前的状态）
2. 选择误删前的备份文件
3. 执行恢复
4. 重启服务
5. 验证数据

### 场景 2: 测试功能，需要恢复到初始状态

1. 选择初始状态的备份
2. 执行恢复
3. 重启服务
4. 开始测试

### 场景 3: 数据库损坏，需要紧急恢复

1. 停止后端服务: `pm2 stop backend`
2. 选择最新的可用备份
3. 执行恢复
4. 启动后端服务: `pm2 start backend`
5. 验证系统

---

**重要提醒**:
- 数据恢复是高风险操作，请务必谨慎
- 恢复前系统会自动创建安全快照
- 恢复后必须重启后端服务
- 如有疑问，请先咨询技术人员

**文档版本**: v1.0  
**更新时间**: 2025-10-24
