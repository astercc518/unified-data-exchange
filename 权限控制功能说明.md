# 权限控制功能实现文档

## 功能概述

实现了完整的角色权限控制系统，明确区分管理员(admin)、代理(agent)和客户(customer)的权限范围。

---

## 权限矩阵

### 代理(agent)权限

| 模块 | 子功能 | 权限 | 说明 |
|------|--------|------|------|
| **用户管理** | 客户列表 | ✅ 查看 | 只显示本代理所属的客户 |
| | 客户基本信息 | ✅ 查看 | 可查看所属客户的详细信息 |
| | 登录账号 | ✅ 操作 | 可登录本代理的客户账号 |
| | 修改密码 | ✅ 操作 | 可修改本代理客户的密码 |
| | 客户编辑 | ❌ 禁止 | 不能编辑客户信息 |
| | 充值/扣款 | ❌ 禁止 | 不能进行资金操作 |
| | 代理列表 | ❌ 隐藏 | 不显示代理列表菜单 |
| | 代理结算 | ❌ 隐藏 | 不显示代理结算菜单 |
| | 客户结算 | ✅ 查看 | 只显示本代理客户的结算信息 |
| | 充值记录 | ❌ 隐藏 | 不显示充值记录菜单 |
| **数据管理** | 整个模块 | ❌ 隐藏 | 数据管理菜单不显示 |
| **资源中心** | 数据查看 | ✅ 查看 | 可以查看可购买数据 |
| | 数据购买 | ❌ 禁止 | 无法购买数据 |
| | 数据收藏 | ❌ 禁止 | 无收藏功能 |
| **订单管理** | 订单列表 | ✅ 查看 | 查看所有客户的订单 |
| | 待处理订单 | ❌ 隐藏 | 不显示待处理订单页面 |
| | 待审核订单 | ✅ 审核 | 可审核本代理客户的订单 |
| | 已完成订单 | ✅ 查看 | 可查看本代理客户的已完成订单 |
| | 订单发货 | ✅ 操作 | 可为本代理客户订单发货 |
| **数据反馈** | 反馈列表 | ✅ 查看 | 只看本代理客户的反馈 |
| | 创建反馈 | ❌ 禁止 | 不能创建反馈 |
| | 编辑反馈 | ✅ 编辑 | 可编辑本代理客户的反馈 |
| **系统管理** | 整个模块 | ❌ 隐藏 | 系统管理菜单不显示 |

### 客户(customer)权限

| 模块 | 子功能 | 权限 | 说明 |
|------|--------|------|------|
| **用户管理** | 整个模块 | ❌ 隐藏 | 用户管理菜单不显示 |
| **数据管理** | 整个模块 | ❌ 隐藏 | 数据管理菜单不显示 |
| **资源中心** | 数据查看 | ✅ 查看 | 可以查看可购买数据 |
| | 数据购买 | ✅ 购买 | 可以购买数据 |
| | 数据收藏 | ✅ 收藏 | 可以收藏数据 |
| **订单管理** | 订单列表 | ✅ 查看 | 只能查看本账号订单 |
| | 待处理订单 | ✅ 查看 | 只显示本账号待处理订单 |
| | 待审核订单 | ❌ 隐藏 | 不显示待审核页面 |
| | 已完成订单 | ✅ 查看 | 只显示本账号已完成订单 |
| | 订单发货 | ✅ 发货 | 可为自己订单选择发货方式 |
| **数据反馈** | 反馈列表 | ✅ 查看 | 只看本账号的反馈 |
| | 创建反馈 | ✅ 创建 | 只能反馈已购买且发货的数据 |
| | 编辑反馈 | ✅ 编辑 | 可编辑自己的反馈 |
| **系统管理** | 整个模块 | ❌ 隐藏 | 系统管理菜单不显示 |

### 管理员(admin)权限

管理员拥有所有权限，可以：
- 管理所有用户（客户、代理）
- 上传和管理数据
- 查看和审核所有订单
- 配置系统（发货、安全等）
- 查看所有反馈

---

## 实现细节

### 1. 路由权限控制

**文件：** `/src/router/index.js`

#### 用户管理模块

```javascript
{
  path: '/user',
  meta: {
    roles: ['admin', 'agent']  // 代理可访问
  },
  children: [
    {
      path: 'customer-list',
      meta: {
        roles: ['admin', 'agent']  // 代理可查看客户列表
      }
    },
    {
      path: 'agent-list',
      meta: {
        roles: ['admin']  // 仅管理员
      }
    },
    {
      path: 'customer-settlement',
      meta: {
        roles: ['admin', 'agent']  // 代理可查看客户结算
      }
    },
    {
      path: 'agent-settlement',
      meta: {
        roles: ['admin']  // 仅管理员
      }
    }
  ]
}
```

#### 资源中心模块

```javascript
{
  path: '/resource',
  meta: {
    roles: ['customer', 'agent']  // 客户和代理可访问
  },
  children: [
    {
      path: 'center',
      meta: {
        roles: ['customer', 'agent']  // 都可查看
      }
    },
    {
      path: 'purchase/:id',
      meta: {
        roles: ['customer']  // 仅客户可购买
      }
    }
  ]
}
```

#### 订单管理模块

```javascript
{
  path: '/order',
  meta: {
    roles: ['admin', 'customer', 'agent']  // 都可访问
  },
  children: [
    {
      path: 'pending',
      meta: {
        roles: ['customer']  // 仅客户
      }
    },
    {
      path: 'review',
      meta: {
        roles: ['agent', 'admin']  // 代理和管理员可审核
      }
    }
  ]
}
```

#### 数据反馈模块

```javascript
{
  path: '/feedback',
  meta: {
    roles: ['admin', 'customer', 'agent']  // 都可访问
  },
  children: [
    {
      path: 'list',
      meta: {
        roles: ['admin', 'customer', 'agent']  // 都可查看
      }
    },
    {
      path: 'create',
      meta: {
        roles: ['customer']  // 仅客户可创建
      }
    }
  ]
}
```

---

### 2. 前端页面权限控制

#### 资源中心 - 购买按钮控制

**文件：** `/src/views/resource/center.vue`

```vue
<template>
  <el-table-column label="操作">
    <template slot-scope="{row}">
      <!-- 购买按钮 - 仅客户可见 -->
      <el-button
        v-if="isCustomer"
        type="primary"
        @click="handlePurchase(row)"
      >
        购买
      </el-button>
      
      <!-- 查看按钮 - 代理只能查看 -->
      <el-button
        v-if="isAgent"
        type="info"
        disabled
      >
        仅可查看
      </el-button>
      
      <!-- 收藏按钮 - 仅客户可见 -->
      <el-button
        v-if="isCustomer"
        @click="handleFavorite(row)"
      >
        收藏
      </el-button>
    </template>
  </el-table-column>
</template>

<script>
export default {
  computed: {
    isCustomer() {
      return this.$store.getters.roles.includes('customer')
    },
    isAgent() {
      return this.$store.getters.roles.includes('agent')
    }
  }
}
</script>
```

#### 用户列表 - 操作按钮控制

**文件：** `/src/views/user/list.vue`

```vue
<template>
  <el-dropdown v-if="isAdmin || isAgent">
    <el-dropdown-menu slot="dropdown">
      <!-- 登录账号 - 管理员和代理都可以 -->
      <el-dropdown-item command="login">
        登录账号
      </el-dropdown-item>
      
      <!-- 重置密码 - 管理员和代理都可以 -->
      <el-dropdown-item command="resetPassword">
        重置密码
      </el-dropdown-item>
      
      <!-- 以下仅管理员可见 -->
      <el-dropdown-item v-if="isAdmin" command="recharge">
        充值
      </el-dropdown-item>
      <el-dropdown-item v-if="isAdmin" command="deduct">
        扣款
      </el-dropdown-item>
    </el-dropdown-menu>
  </el-dropdown>
</template>
```

---

### 3. 后端权限验证

**文件：** `/backend/middleware/auth.js`

#### 权限验证中间件

```javascript
// 仅管理员可访问
const requireAdmin = (req, res, next) => {
  if (req.user.userType !== 'admin') {
    return res.status(403).json({
      success: false,
      message: '权限不足: 仅管理员可访问'
    })
  }
  next()
}

// 代理或管理员可访问
const requireAgentOrAdmin = (req, res, next) => {
  if (req.user.userType !== 'agent' && req.user.userType !== 'admin') {
    return res.status(403).json({
      success: false,
      message: '权限不足: 仅代理或管理员可访问'
    })
  }
  next()
}

// 验证客户访问权限
const verifyCustomerAccess = async (req, res, next) => {
  // 管理员可以访问所有客户
  if (req.user.userType === 'admin') {
    return next()
  }
  
  // 代理只能访问自己的客户
  if (req.user.userType === 'agent') {
    const customer = await User.findByPk(customerId)
    if (customer.agent_id !== req.user.userId) {
      return res.status(403).json({
        success: false,
        message: '权限不足: 您只能访问自己的客户'
      })
    }
  }
  
  // 客户只能访问自己
  if (req.user.userType === 'customer') {
    if (customerId !== req.user.userId) {
      return res.status(403).json({
        success: false,
        message: '权限不足: 您只能访问自己的信息'
      })
    }
  }
  
  next()
}
```

#### API路由权限应用

```javascript
// 用户管理路由
router.get('/api/users', authenticateToken, requireAgentOrAdmin, async (req, res) => {
  // 代理只能看到自己的客户
  if (req.user.userType === 'agent') {
    where.agent_id = req.user.userId
  }
  // 管理员可以看到所有用户
})

// 订单管理路由
router.get('/api/orders', authenticateToken, async (req, res) => {
  // 根据用户类型过滤数据
  if (req.user.userType === 'agent') {
    // 代理: 查询该代理下所有客户的订单
    const customers = await User.findAll({
      where: { agent_id: req.user.userId }
    })
    where.customer_id = { [Op.in]: customerIds }
  } else if (req.user.userType === 'customer') {
    // 客户: 只能查看自己的订单
    where.customer_id = req.user.userId
  }
  // admin: 不添加过滤条件,查看所有订单
})
```

---

## 数据过滤规则

### 代理数据过滤

**客户列表：**
```javascript
// 只返回本代理的客户
where.agent_id = req.user.userId
```

**订单列表：**
```javascript
// 查询本代理所有客户的订单
const customers = await User.findAll({
  where: { agent_id: req.user.userId }
})
const customerIds = customers.map(c => c.id)
where.customer_id = { [Op.in]: customerIds }
```

**反馈列表：**
```javascript
// 查询本代理所有客户的反馈
const customers = await User.findAll({
  where: { agent_id: req.user.userId }
})
const customerIds = customers.map(c => c.id)
where.customer_id = { [Op.in]: customerIds }
```

**结算信息：**
```javascript
// 只返回本代理客户的结算信息
where.agent_id = req.user.userId
```

### 客户数据过滤

**订单列表：**
```javascript
// 只返回本账号的订单
where.customer_id = req.user.userId
```

**反馈列表：**
```javascript
// 只返回本账号的反馈
where.customer_id = req.user.userId
```

**反馈创建限制：**
```javascript
// 验证订单是否属于当前客户且已发货
const order = await Order.findOne({
  where: {
    id: orderId,
    customer_id: req.user.userId,
    delivery_status: 'delivered'
  }
})
if (!order) {
  throw new Error('只能反馈已购买且发货的数据')
}
```

---

## 菜单显示控制

### 代理菜单

**显示的菜单：**
- ✅ 用户管理
  - ✅ 客户列表
  - ✅ 客户结算
- ✅ 资源中心
- ✅ 订单管理
  - ✅ 订单列表
  - ✅ 待审核订单
  - ✅ 已完成订单
- ✅ 数据反馈

**隐藏的菜单：**
- ❌ 数据管理（整个模块）
- ❌ 用户管理
  - ❌ 代理列表
  - ❌ 代理结算
  - ❌ 充值记录
- ❌ 订单管理
  - ❌ 待处理订单（客户专用）
- ❌ 系统管理（整个模块）

### 客户菜单

**显示的菜单：**
- ✅ 资源中心
- ✅ 订单管理
  - ✅ 订单列表
  - ✅ 待处理订单
  - ✅ 已完成订单
- ✅ 数据反馈

**隐藏的菜单：**
- ❌ 用户管理（整个模块）
- ❌ 数据管理（整个模块）
- ❌ 订单管理
  - ❌ 待审核订单（代理/管理员专用）
- ❌ 系统管理（整个模块）

---

## 操作权限说明

### 代理操作权限

**客户管理操作：**
- ✅ 查看客户详情
- ✅ 登录客户账号
- ✅ 重置客户密码
- ❌ 编辑客户信息（仅管理员）
- ❌ 充值/扣款（仅管理员）
- ❌ 删除客户（仅管理员）

**订单管理操作：**
- ✅ 查看订单详情
- ✅ 审核客户订单
- ✅ 订单发货
- ❌ 删除订单（仅管理员）

**反馈管理操作：**
- ✅ 查看反馈详情
- ✅ 编辑客户反馈
- ❌ 创建反馈（仅客户）
- ❌ 删除反馈（仅管理员）

### 客户操作权限

**资源中心操作：**
- ✅ 查看数据列表
- ✅ 购买数据
- ✅ 收藏数据
- ✅ 取消收藏

**订单管理操作：**
- ✅ 查看本账号订单
- ✅ 提交订单
- ✅ 选择发货方式
- ❌ 审核订单（代理/管理员）
- ❌ 删除订单（仅管理员）

**反馈管理操作：**
- ✅ 查看本账号反馈
- ✅ 创建反馈（已购买且发货的数据）
- ✅ 编辑本账号反馈
- ❌ 删除反馈（仅管理员）

---

## 测试检查清单

### 代理权限测试

**用户管理：**
- [ ] 客户列表只显示本代理的客户
- [ ] 可以查看客户详情
- [ ] 可以登录客户账号
- [ ] 可以重置客户密码
- [ ] 不能编辑客户信息
- [ ] 不能充值/扣款
- [ ] 不显示代理列表菜单
- [ ] 不显示代理结算菜单
- [ ] 客户结算只显示本代理客户

**数据管理：**
- [ ] 数据管理菜单不显示

**资源中心：**
- [ ] 可以查看数据列表
- [ ] 不能购买数据（购买按钮禁用）
- [ ] 不显示收藏按钮

**订单管理：**
- [ ] 订单列表显示所有客户订单
- [ ] 不显示待处理订单菜单
- [ ] 可以审核客户订单
- [ ] 可以查看已完成订单

**数据反馈：**
- [ ] 反馈列表只显示本代理客户反馈
- [ ] 不显示创建反馈按钮
- [ ] 可以编辑客户反馈

### 客户权限测试

**用户管理：**
- [ ] 用户管理菜单不显示

**数据管理：**
- [ ] 数据管理菜单不显示

**资源中心：**
- [ ] 可以查看数据列表
- [ ] 可以购买数据
- [ ] 可以收藏数据

**订单管理：**
- [ ] 只显示本账号订单
- [ ] 显示待处理订单菜单
- [ ] 不显示待审核订单菜单
- [ ] 可以选择发货方式

**数据反馈：**
- [ ] 只显示本账号反馈
- [ ] 可以创建反馈
- [ ] 只能反馈已购买且发货的数据
- [ ] 可以编辑本账号反馈

---

## 文件清单

### 已修改文件

```
✅ 前端文件 (3个)
/src/router/index.js                    # 路由权限配置
/src/views/resource/center.vue         # 资源中心权限控制
/src/views/user/list.vue               # 用户列表权限控制

✅ 后端文件 (已有)
/backend/middleware/auth.js             # 权限验证中间件
/backend/routes/orders.js               # 订单路由权限控制
/backend/routes/users.js                # 用户路由权限控制
/backend/routes/feedbacks.js            # 反馈路由权限控制

✅ 文档文件 (1个)
/权限控制功能说明.md                    # 本文档
```

---

## 安全建议

### 前端安全

1. **路由守卫**
   - 使用Vue Router的`beforeEach`守卫验证权限
   - 未授权路由自动跳转到401页面

2. **组件权限**
   - 使用`v-if`根据角色显示/隐藏元素
   - 敏感操作按钮根据权限动态显示

3. **API调用**
   - 所有API请求带上JWT Token
   - 前端验证用户角色后再调用API

### 后端安全

1. **中间件验证**
   - 所有API都必须通过`authenticateToken`中间件
   - 敏感操作添加`requireAdmin`或`requireAgentOrAdmin`

2. **数据过滤**
   - 根据用户类型自动过滤查询结果
   - 永远不返回用户无权查看的数据

3. **操作日志**
   - 记录所有敏感操作
   - 包含用户ID、操作类型、时间戳

---

## 后续优化

1. **细粒度权限**
   - 实现基于资源的权限控制(RBAC)
   - 支持自定义角色和权限组合

2. **审计日志**
   - 记录所有权限验证失败的尝试
   - 生成安全审计报告

3. **动态权限**
   - 支持运行时修改用户权限
   - 无需重新登录即可生效

4. **权限缓存**
   - 缓存用户权限信息
   - 减少数据库查询

---

**实现完成时间：** 2025-10-15  
**状态：** ✅ 全部完成  
**测试状态：** ⏳ 待测试
