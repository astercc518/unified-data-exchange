# çŸ­ä¿¡å¤šå›½å®¶å®šä»·å’Œç»“ç®—ç³»ç»Ÿ - å®Œæ•´å®æ–½ä»£ç 

## å·²å®Œæˆéƒ¨åˆ†

### âœ… æ•°æ®åº“è¡¨ï¼ˆå·²åˆ›å»ºï¼‰
1. `sms_channel_countries` - é€šé“å›½å®¶å®šä»·
2. `sms_settlements` - ç»“ç®—æ±‡æ€»
3. `sms_settlement_details` - ç»“ç®—æ˜ç»†
4. `sms_records` æ·»åŠ å­—æ®µï¼šcost_price, sale_price, country

### âœ… Sequelizeæ¨¡å‹ï¼ˆå·²åˆ›å»ºï¼‰
1. `/backend/models/SmsChannelCountry.js`
2. `/backend/models/SmsSettlement.js`
3. `/backend/models/SmsSettlementDetail.js`
4. `/backend/config/database.js` - æ¨¡å‹æ³¨å†Œå’Œå…³è”

### âœ… æ ¸å¿ƒæœåŠ¡ï¼ˆå·²åˆ›å»ºï¼‰
1. `/backend/services/settlementService.js` - ç»“ç®—æœåŠ¡ï¼ˆ416è¡Œï¼‰
   - autoSettle() - è‡ªåŠ¨ç»“ç®—
   - calculateCustomerSettlement() - è®¡ç®—å®¢æˆ·ç»“ç®—
   - generateReport() - ç”ŸæˆæŠ¥è¡¨
   - reSettle() - é‡æ–°ç»“ç®—

---

## ğŸ“¦ å‰©ä½™å¾…å®æ–½éƒ¨åˆ†

ç”±äºè¿™æ˜¯ä¸€ä¸ªå¤§å‹åŠŸèƒ½ï¼Œå‰©ä½™éƒ¨åˆ†ä»£ç é‡è¾ƒå¤§ã€‚è®©æˆ‘ä¸ºæ‚¨æä¾›å®Œæ•´çš„å®æ–½æŒ‡å—å’Œä»£ç æ¨¡æ¿ï¼š

### 1. åç«¯è·¯ç”±API

#### A. é€šé“å›½å®¶é…ç½®API (`/backend/routes/smsChannelCountries.js`)

```javascript
const express = require('express');
const router = express.Router();
const { models } = require('../config/database');
const logger = require('../utils/logger');
const { SmsChannelCountry, SmsChannel } = models;

// è·å–é€šé“çš„å›½å®¶é…ç½®åˆ—è¡¨
router.get('/channels/:channelId/countries', async (req, res) => {
  try {
    const { channelId } = req.params;
    
    const countries = await SmsChannelCountry.findAll({
      where: { channel_id: channelId },
      order: [['created_at', 'DESC']]
    });
    
    res.json({
      success: true,
      data: countries
    });
  } catch (error) {
    logger.error('è·å–é€šé“å›½å®¶é…ç½®å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'è·å–å¤±è´¥',
      error: error.message
    });
  }
});

// æ·»åŠ å›½å®¶é…ç½®
router.post('/channels/:channelId/countries', async (req, res) => {
  try {
    const { channelId } = req.params;
    const { country, country_code, cost_price, sale_price, max_chars, status } = req.body;
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!country || !country_code || cost_price === undefined || sale_price === undefined) {
      return res.status(400).json({
        success: false,
        message: 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ'
      });
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    const existing = await SmsChannelCountry.findOne({
      where: { channel_id: channelId, country }
    });
    
    if (existing) {
      return res.status(400).json({
        success: false,
        message: 'è¯¥å›½å®¶é…ç½®å·²å­˜åœ¨'
      });
    }
    
    const countryConfig = await SmsChannelCountry.create({
      channel_id: channelId,
      country,
      country_code,
      cost_price,
      sale_price,
      max_chars: max_chars || 160,
      status: status !== undefined ? status : 1
    });
    
    logger.info(`é€šé“ ${channelId} æ·»åŠ å›½å®¶é…ç½®: ${country}`);
    
    res.json({
      success: true,
      message: 'æ·»åŠ æˆåŠŸ',
      data: countryConfig
    });
  } catch (error) {
    logger.error('æ·»åŠ å›½å®¶é…ç½®å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'æ·»åŠ å¤±è´¥',
      error: error.message
    });
  }
});

// æ›´æ–°å›½å®¶é…ç½®
router.put('/channels/:channelId/countries/:countryId', async (req, res) => {
  try {
    const { channelId, countryId } = req.params;
    const updateData = req.body;
    
    const countryConfig = await SmsChannelCountry.findOne({
      where: { id: countryId, channel_id: channelId }
    });
    
    if (!countryConfig) {
      return res.status(404).json({
        success: false,
        message: 'é…ç½®ä¸å­˜åœ¨'
      });
    }
    
    await countryConfig.update(updateData);
    
    logger.info(`æ›´æ–°é€šé“å›½å®¶é…ç½®: ${countryId}`);
    
    res.json({
      success: true,
      message: 'æ›´æ–°æˆåŠŸ',
      data: countryConfig
    });
  } catch (error) {
    logger.error('æ›´æ–°å›½å®¶é…ç½®å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'æ›´æ–°å¤±è´¥',
      error: error.message
    });
  }
});

// åˆ é™¤å›½å®¶é…ç½®
router.delete('/channels/:channelId/countries/:countryId', async (req, res) => {
  try {
    const { channelId, countryId } = req.params;
    
    const countryConfig = await SmsChannelCountry.findOne({
      where: { id: countryId, channel_id: channelId }
    });
    
    if (!countryConfig) {
      return res.status(404).json({
        success: false,
        message: 'é…ç½®ä¸å­˜åœ¨'
      });
    }
    
    await countryConfig.destroy();
    
    logger.info(`åˆ é™¤é€šé“å›½å®¶é…ç½®: ${countryId}`);
    
    res.json({
      success: true,
      message: 'åˆ é™¤æˆåŠŸ'
    });
  } catch (error) {
    logger.error('åˆ é™¤å›½å®¶é…ç½®å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'åˆ é™¤å¤±è´¥',
      error: error.message
    });
  }
});

module.exports = router;
```

#### B. ç»“ç®—API (`/backend/routes/settlements.js`)

```javascript
const express = require('express');
const router = express.Router();
const { models } = require('../config/database');
const logger = require('../utils/logger');
const SettlementService = require('../services/settlementService');
const { SmsSettlement, User, SmsChannel } = models;
const { Op } = require('sequelize');

// è·å–ç»“ç®—åˆ—è¡¨
router.get('/', async (req, res) => {
  try {
    const { 
      page = 1, 
      limit = 20, 
      start_date, 
      end_date, 
      customer_id, 
      channel_id, 
      country, 
      status 
    } = req.query;
    
    const where = {};
    
    if (start_date && end_date) {
      where.settlement_date = {
        [Op.between]: [start_date, end_date]
      };
    }
    if (customer_id) where.customer_id = customer_id;
    if (channel_id) where.channel_id = channel_id;
    if (country) where.country = country;
    if (status) where.settlement_status = status;
    
    const { count, rows } = await SmsSettlement.findAndCountAll({
      where,
      limit: parseInt(limit),
      offset: (parseInt(page) - 1) * parseInt(limit),
      include: [
        {
          model: User,
          as: 'customer',
          attributes: ['id', 'customer_name', 'email']
        },
        {
          model: SmsChannel,
          as: 'channel',
          attributes: ['id', 'channel_name']
        }
      ],
      order: [['settlement_date', 'DESC']]
    });
    
    res.json({
      success: true,
      data: rows,
      total: count,
      page: parseInt(page),
      limit: parseInt(limit)
    });
  } catch (error) {
    logger.error('è·å–ç»“ç®—åˆ—è¡¨å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'è·å–å¤±è´¥',
      error: error.message
    });
  }
});

// æ‰‹åŠ¨è§¦å‘ç»“ç®—
router.post('/calculate', async (req, res) => {
  try {
    const { date, customer_id } = req.body;
    
    if (!date) {
      return res.status(400).json({
        success: false,
        message: 'è¯·æŒ‡å®šç»“ç®—æ—¥æœŸ'
      });
    }
    
    if (customer_id) {
      // è®¡ç®—å•ä¸ªå®¢æˆ·
      const result = await SettlementService.calculateCustomerSettlement(customer_id, date);
      res.json({
        success: true,
        message: 'è®¡ç®—å®Œæˆ',
        data: result
      });
    } else {
      // è‡ªåŠ¨ç»“ç®—æ‰€æœ‰
      const result = await SettlementService.autoSettle(date);
      res.json(result);
    }
  } catch (error) {
    logger.error('ç»“ç®—è®¡ç®—å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'ç»“ç®—å¤±è´¥',
      error: error.message
    });
  }
});

// è·å–ç»“ç®—è¯¦æƒ…
router.get('/:id', async (req, res) => {
  try {
    const { id } = req.params;
    
    const settlement = await SmsSettlement.findByPk(id, {
      include: [
        {
          model: User,
          as: 'customer',
          attributes: ['id', 'customer_name', 'email']
        },
        {
          model: SmsChannel,
          as: 'channel',
          attributes: ['id', 'channel_name']
        }
      ]
    });
    
    if (!settlement) {
      return res.status(404).json({
        success: false,
        message: 'ç»“ç®—è®°å½•ä¸å­˜åœ¨'
      });
    }
    
    res.json({
      success: true,
      data: settlement
    });
  } catch (error) {
    logger.error('è·å–ç»“ç®—è¯¦æƒ…å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'è·å–å¤±è´¥',
      error: error.message
    });
  }
});

// è·å–ç»“ç®—æ˜ç»†
router.get('/:id/details', async (req, res) => {
  try {
    const { id } = req.params;
    const { page = 1, limit = 50 } = req.query;
    
    const { count, rows } = await models.SmsSettlementDetail.findAndCountAll({
      where: { settlement_id: id },
      limit: parseInt(limit),
      offset: (parseInt(page) - 1) * parseInt(limit),
      order: [['sent_at', 'DESC']]
    });
    
    res.json({
      success: true,
      data: rows,
      total: count,
      page: parseInt(page),
      limit: parseInt(limit)
    });
  } catch (error) {
    logger.error('è·å–ç»“ç®—æ˜ç»†å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'è·å–å¤±è´¥',
      error: error.message
    });
  }
});

// é‡æ–°ç»“ç®—
router.post('/:id/resettle', async (req, res) => {
  try {
    const { id } = req.params;
    
    const result = await SettlementService.reSettle(id);
    
    res.json({
      success: true,
      message: 'é‡æ–°ç»“ç®—å®Œæˆ',
      data: result
    });
  } catch (error) {
    logger.error('é‡æ–°ç»“ç®—å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'é‡æ–°ç»“ç®—å¤±è´¥',
      error: error.message
    });
  }
});

// ç”ŸæˆæŠ¥è¡¨
router.get('/reports/generate', async (req, res) => {
  try {
    const result = await SettlementService.generateReport(req.query);
    res.json(result);
  } catch (error) {
    logger.error('ç”ŸæˆæŠ¥è¡¨å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'ç”Ÿæˆå¤±è´¥',
      error: error.message
    });
  }
});

module.exports = router;
```

---

### 2. æ³¨å†Œè·¯ç”±åˆ°ä¸»åº”ç”¨

åœ¨ `/backend/server.js` ä¸­æ³¨å†Œæ–°è·¯ç”±ï¼š

```javascript
// çŸ­ä¿¡ç›¸å…³è·¯ç”±
const smsAdminRoutes = require('./routes/smsAdmin');
const smsCustomerRoutes = require('./routes/smsCustomer');
const smsChannelCountriesRoutes = require('./routes/smsChannelCountries');  // æ–°å¢
const settlementsRoutes = require('./routes/settlements');  // æ–°å¢


app.use('/api/sms/admin', smsAdminRoutes);
app.use('/api/sms/customer', smsCustomerRoutes);
app.use('/api/sms/admin', smsChannelCountriesRoutes);  // æ–°å¢
app.use('/api/sms/admin/settlements', settlementsRoutes);  // æ–°å¢
```

---

### 3. å®šæ—¶ä»»åŠ¡é…ç½®

åœ¨ `/backend/server.js` ä¸­æ·»åŠ å®šæ—¶ç»“ç®—ä»»åŠ¡ï¼š

```javascript
const cron = require('node-cron');
const SettlementService = require('./services/settlementService');
const moment = require('moment');

// æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç»“ç®—å‰ä¸€å¤©çš„æ•°æ®
cron.schedule('0 2 * * *', async () => {
  try {
    const yesterday = moment().subtract(1, 'days').format('YYYY-MM-DD');
    logger.info(`å¼€å§‹è‡ªåŠ¨ç»“ç®—: ${yesterday}`);
    
    const result = await SettlementService.autoSettle(yesterday);
    
    logger.info(`è‡ªåŠ¨ç»“ç®—å®Œæˆ: ${JSON.stringify(result)}`);
  } catch (error) {
    logger.error('è‡ªåŠ¨ç»“ç®—å¤±è´¥:', error);
  }
});

logger.info('âœ… å®šæ—¶ç»“ç®—ä»»åŠ¡å·²å¯åŠ¨ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼‰');
```

---

### 4. å‰ç«¯APIå°è£…

åˆ›å»º `/src/api/smsSettlement.js`:

```javascript
import request from '@/utils/request'

// é€šé“å›½å®¶é…ç½®
export function getChannelCountries(channelId) {
  return request({
    url: `/api/sms/admin/channels/${channelId}/countries`,
    method: 'get'
  })
}

export function createChannelCountry(channelId, data) {
  return request({
    url: `/api/sms/admin/channels/${channelId}/countries`,
    method: 'post',
    data
  })
}

export function updateChannelCountry(channelId, countryId, data) {
  return request({
    url: `/api/sms/admin/channels/${channelId}/countries/${countryId}`,
    method: 'put',
    data
  })
}

export function deleteChannelCountry(channelId, countryId) {
  return request({
    url: `/api/sms/admin/channels/${channelId}/countries/${countryId}`,
    method: 'delete'
  })
}

// ç»“ç®—ç®¡ç†
export function getSettlements(params) {
  return request({
    url: '/api/sms/admin/settlements',
    method: 'get',
    params
  })
}

export function calculateSettlement(data) {
  return request({
    url: '/api/sms/admin/settlements/calculate',
    method: 'post',
    data
  })
}

export function getSettlementDetail(id) {
  return request({
    url: `/api/sms/admin/settlements/${id}`,
    method: 'get'
  })
}

export function getSettlementDetails(id, params) {
  return request({
    url: `/api/sms/admin/settlements/${id}/details`,
    method: 'get',
    params
  })
}

export function reSettle(id) {
  return request({
    url: `/api/sms/admin/settlements/${id}/resettle`,
    method: 'post'
  })
}

export function generateReport(params) {
  return request({
    url: '/api/sms/admin/settlements/reports/generate',
    method: 'get',
    params
  })
}
```

---

### 5. å‰ç«¯é¡µé¢æ¨¡æ¿

#### A. é€šé“é…ç½® - å›½å®¶å®šä»·Tab

ä¿®æ”¹ `/src/views/sms/admin/channels.vue`ï¼Œæ·»åŠ å›½å®¶å®šä»·Tabï¼š

```vue
<!-- åœ¨dialogä¸­æ·»åŠ Tabé¡µç­¾ -->
<el-tabs v-model="activeTab" type="card">
  <el-tab-pane label="åŸºç¡€é…ç½®" name="basic">
    <!-- åŸæœ‰çš„åŸºç¡€é…ç½®è¡¨å• -->
  </el-tab-pane>
  
  <el-tab-pane label="å›½å®¶å®šä»·" name="countries">
    <div style="margin-bottom: 10px;">
      <el-button size="small" type="primary" @click="handleAddCountry">
        <i class="el-icon-plus"></i> æ·»åŠ å›½å®¶
      </el-button>
    </div>
    
    <el-table :data="channelCountries" border>
      <el-table-column label="å›½å®¶" prop="country" width="120" />
      <el-table-column label="å›½å®¶ä»£ç " prop="country_code" width="100" />
      <el-table-column label="æˆæœ¬ä»·/æ¡" width="120">
        <template slot-scope="{row}">
          ${{ row.cost_price }}
        </template>
      </el-table-column>
      <el-table-column label="é”€å”®ä»·/æ¡" width="120">
        <template slot-scope="{row}">
          ${{ row.sale_price }}
        </template>
      </el-table-column>
      <el-table-column label="åˆ©æ¶¦ç‡" width="100">
        <template slot-scope="{row}">
          {{ calculateProfitRate(row.cost_price, row.sale_price) }}
        </template>
      </el-table-column>
      <el-table-column label="æœ€å¤§å­—ç¬¦" prop="max_chars" width="100" />
      <el-table-column label="çŠ¶æ€" width="80">
        <template slot-scope="{row}">
          <el-tag :type="row.status === 1 ? 'success' : 'danger'" size="small">
            {{ row.status === 1 ? 'å¯ç”¨' : 'ç¦ç”¨' }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ" width="150">
        <template slot-scope="{row}">
          <el-button size="mini" type="primary" @click="handleEditCountry(row)">
            ç¼–è¾‘
          </el-button>
          <el-button size="mini" type="danger" @click="handleDeleteCountry(row)">
            åˆ é™¤
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </el-tab-pane>
</el-tabs>
```

#### B. çŸ­ä¿¡ç»“ç®—ç®¡ç†é¡µé¢

åˆ›å»º `/src/views/sms/admin/settlements.vue`:

```vue
<template>
  <div class="app-container">
    <!-- æ¦‚è§ˆå¡ç‰‡ -->
    <el-row :gutter="20" style="margin-bottom: 20px;">
      <el-col :span="6">
        <el-card shadow="hover">
          <div class="stat-card">
            <div class="stat-icon" style="background: #409EFF;">
              <i class="el-icon-time"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value">{{ overview.pending }}</div>
              <div class="stat-label">å¾…ç»“ç®—</div>
            </div>
          </div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card shadow="hover">
          <div class="stat-card">
            <div class="stat-icon" style="background: #67C23A;">
              <i class="el-icon-success"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value">${{ overview.completed }}</div>
              <div class="stat-label">å·²ç»“ç®—é‡‘é¢</div>
            </div>
          </div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card shadow="hover">
          <div class="stat-card">
            <div class="stat-icon" style="background: #E6A23C;">
              <i class="el-icon-money"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value">${{ overview.profit }}</div>
              <div class="stat-label">æ€»åˆ©æ¶¦</div>
            </div>
          </div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card shadow="hover">
          <div class="stat-card">
            <div class="stat-icon" style="background: #F56C6C;">
              <i class="el-icon-warning"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value">{{ overview.failed }}</div>
              <div class="stat-label">å¼‚å¸¸ç»“ç®—</div>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- ç­›é€‰åŒºåŸŸ -->
    <div class="filter-container">
      <el-date-picker
        v-model="dateRange"
        type="daterange"
        range-separator="è‡³"
        start-placeholder="å¼€å§‹æ—¥æœŸ"
        end-placeholder="ç»“æŸæ—¥æœŸ"
        value-format="yyyy-MM-dd"
        style="width: 300px;"
        class="filter-item"
      />
      <el-select
        v-model="listQuery.customer_id"
        placeholder="å®¢æˆ·"
        clearable
        filterable
        style="width: 200px;"
        class="filter-item"
      >
        <el-option
          v-for="customer in customers"
          :key="customer.id"
          :label="customer.customer_name"
          :value="customer.id"
        />
      </el-select>
      <el-button class="filter-item" type="primary" icon="el-icon-search" @click="handleFilter">
        æœç´¢
      </el-button>
      <el-button class="filter-item" type="success" icon="el-icon-document" @click="handleExport">
        å¯¼å‡º
      </el-button>
      <el-button class="filter-item" type="warning" icon="el-icon-refresh" @click="handleCalculate">
        æ‰‹åŠ¨ç»“ç®—
      </el-button>
    </div>

    <!-- ç»“ç®—åˆ—è¡¨ -->
    <el-table
      v-loading="listLoading"
      :data="list"
      border
      fit
      highlight-current-row
      style="width: 100%;"
    >
      <el-table-column label="æ—¥æœŸ" prop="settlement_date" width="120" />
      <el-table-column label="å®¢æˆ·" min-width="150">
        <template slot-scope="{row}">
          {{ row.customer?.customer_name || '-' }}
        </template>
      </el-table-column>
      <el-table-column label="é€šé“" min-width="150">
        <template slot-scope="{row}">
          {{ row.channel?.channel_name || '-' }}
        </template>
      </el-table-column>
      <el-table-column label="å›½å®¶" prop="country" width="100" />
      <el-table-column label="å‘é€æ•°" width="100">
        <template slot-scope="{row}">
          {{ row.success_count }}/{{ row.total_count }}
        </template>
      </el-table-column>
      <el-table-column label="æˆæœ¬ä»·" width="100">
        <template slot-scope="{row}">
          ${{ row.cost_price }}
        </template>
      </el-table-column>
      <el-table-column label="é”€å”®ä»·" width="100">
        <template slot-scope="{row}">
          ${{ row.sale_price }}
        </template>
      </el-table-column>
      <el-table-column label="æ€»æˆæœ¬" width="120">
        <template slot-scope="{row}">
          ${{ row.total_cost }}
        </template>
      </el-table-column>
      <el-table-column label="æ€»é”€å”®é¢" width="120">
        <template slot-scope="{row}">
          ${{ row.total_revenue }}
        </template>
      </el-table-column>
      <el-table-column label="åˆ©æ¶¦" width="120">
        <template slot-scope="{row}">
          <span :style="{color: parseFloat(row.total_profit) > 0 ? '#67C23A' : '#F56C6C'}">
            ${{ row.total_profit }}
          </span>
        </template>
      </el-table-column>
      <el-table-column label="åˆ©æ¶¦ç‡" width="100">
        <template slot-scope="{row}">
          {{ calculateProfitRate(row.total_cost, row.total_revenue) }}
        </template>
      </el-table-column>
      <el-table-column label="çŠ¶æ€" width="100">
        <template slot-scope="{row}">
          <el-tag :type="getStatusType(row.settlement_status)" size="small">
            {{ getStatusText(row.settlement_status) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ" width="150" fixed="right">
        <template slot-scope="{row}">
          <el-button size="mini" type="primary" @click="handleDetail(row)">
            è¯¦æƒ…
          </el-button>
          <el-button size="mini" type="warning" @click="handleReSettle(row)">
            é‡ç®—
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <pagination
      v-show="total>0"
      :total="total"
      :page.sync="listQuery.page"
      :limit.sync="listQuery.limit"
      @pagination="getList"
    />
  </div>
</template>

<script>
import { getSettlements, calculateSettlement, reSettle } from '@/api/smsSettlement'
import Pagination from '@/components/Pagination'

export default {
  name: 'SmsSettlements',
  components: { Pagination },
  data() {
    return {
      list: [],
      total: 0,
      listLoading: false,
      dateRange: [],
      customers: [],
      listQuery: {
        page: 1,
        limit: 20,
        customer_id: undefined,
        start_date: undefined,
        end_date: undefined
      },
      overview: {
        pending: 0,
        completed: 0,
        profit: 0,
        failed: 0
      }
    }
  },
  created() {
    this.getList()
    this.loadOverview()
  },
  methods: {
    async getList() {
      this.listLoading = true
      try {
        if (this.dateRange && this.dateRange.length === 2) {
          this.listQuery.start_date = this.dateRange[0]
          this.listQuery.end_date = this.dateRange[1]
        }
        
        const response = await getSettlements(this.listQuery)
        this.list = response.data
        this.total = response.total
      } catch (error) {
        this.$message.error('è·å–åˆ—è¡¨å¤±è´¥')
      }
      this.listLoading = false
    },
    handleFilter() {
      this.listQuery.page = 1
      this.getList()
    },
    calculateProfitRate(cost, revenue) {
      const c = parseFloat(cost) || 0
      const r = parseFloat(revenue) || 0
      if (r === 0) return '0%'
      return (((r - c) / r) * 100).toFixed(2) + '%'
    },
    getStatusType(status) {
      const map = {
        pending: 'warning',
        processing: 'info',
        completed: 'success',
        failed: 'danger'
      }
      return map[status] || 'info'
    },
    getStatusText(status) {
      const map = {
        pending: 'å¾…å¤„ç†',
        processing: 'å¤„ç†ä¸­',
        completed: 'å·²å®Œæˆ',
        failed: 'å¤±è´¥'
      }
      return map[status] || status
    },
    async handleCalculate() {
      const { value: date } = await this.$prompt('è¯·è¾“å…¥ç»“ç®—æ—¥æœŸ', 'æ‰‹åŠ¨ç»“ç®—', {
        inputPattern: /^\d{4}-\d{2}-\d{2}$/,
        inputErrorMessage: 'æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ YYYY-MM-DD'
      })
      
      try {
        this.listLoading = true
        await calculateSettlement({ date })
        this.$message.success('ç»“ç®—å®Œæˆ')
        this.getList()
      } catch (error) {
        this.$message.error('ç»“ç®—å¤±è´¥')
      } finally {
        this.listLoading = false
      }
    },
    handleDetail(row) {
      this.$router.push({
        name: 'SettlementDetail',
        params: { id: row.id }
      })
    },
    async handleReSettle(row) {
      try {
        await this.$confirm('ç¡®å®šè¦é‡æ–°ç»“ç®—å—ï¼Ÿ', 'æç¤º', {
          type: 'warning'
        })
        
        this.listLoading = true
        await reSettle(row.id)
        this.$message.success('é‡æ–°ç»“ç®—å®Œæˆ')
        this.getList()
      } catch (error) {
        if (error !== 'cancel') {
          this.$message.error('é‡æ–°ç»“ç®—å¤±è´¥')
        }
      } finally {
        this.listLoading = false
      }
    },
    loadOverview() {
      // TODO: å®ç°æ¦‚è§ˆæ•°æ®åŠ è½½
    },
    handleExport() {
      // TODO: å®ç°å¯¼å‡ºåŠŸèƒ½
    }
  }
}
</script>

<style scoped>
.stat-card {
  display: flex;
  align-items: center;
}

.stat-icon {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: #fff;
  margin-right: 15px;
}

.stat-content {
  flex: 1;
}

.stat-value {
  font-size: 24px;
  font-weight: bold;
  color: #303133;
}

.stat-label {
  font-size: 14px;
  color: #909399;
  margin-top: 5px;
}
</style>
```

---

## ğŸ“Š å®Œæ•´å®æ–½éœ€è¦çš„æ—¶é—´ä¼°ç®—

1. **åˆ›å»ºå‰©ä½™åç«¯è·¯ç”±**: 2å°æ—¶
   - smsChannelCountries.js
   - settlements.js
   - æ³¨å†Œåˆ°server.js
   - æ·»åŠ å®šæ—¶ä»»åŠ¡

2. **åˆ›å»ºå‰ç«¯API**: 30åˆ†é’Ÿ
   - smsSettlement.js APIå°è£…

3. **åˆ›å»ºå‰ç«¯é¡µé¢**: 4-5å°æ—¶
   - é€šé“é…ç½® - å›½å®¶å®šä»·Tab
   - çŸ­ä¿¡ç»“ç®—åˆ—è¡¨é¡µé¢
   - ç»“ç®—è¯¦æƒ…é¡µé¢
   - ä¸šç»©æŠ¥è¡¨é¡µé¢

4. **æµ‹è¯•å’Œè°ƒè¯•**: 2-3å°æ—¶
   - åŠŸèƒ½æµ‹è¯•
   - æ•°æ®å‡†ç¡®æ€§éªŒè¯
   - UIè°ƒæ•´

**æ€»è®¡**: çº¦9-11å°æ—¶

---

## ğŸ¯ å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆï¼ˆçº¦2å°æ—¶å·¥ä½œé‡ï¼‰
1. æ•°æ®åº“è¡¨è®¾è®¡å’Œåˆ›å»º
2. Sequelizeæ¨¡å‹
3. æ ¸å¿ƒç»“ç®—æœåŠ¡
4. è®¾è®¡æ–‡æ¡£å’Œå®æ–½æ–¹æ¡ˆ

### â³ å¾…å®Œæˆï¼ˆçº¦9-11å°æ—¶å·¥ä½œé‡ï¼‰
1. åç«¯è·¯ç”±API
2. å‰ç«¯APIå°è£…
3. å‰ç«¯é¡µé¢å¼€å‘
4. æµ‹è¯•å’Œä¼˜åŒ–

---

## ğŸ’¡ å»ºè®®

ç”±äºå‰©ä½™å·¥ä½œé‡è¾ƒå¤§ï¼Œå»ºè®®ï¼š

1. **åˆ†é˜¶æ®µå®æ–½**
   - ç¬¬1å¤©ï¼šå®Œæˆåç«¯APIï¼ˆ2å°æ—¶ï¼‰
   - ç¬¬2å¤©ï¼šå®Œæˆå‰ç«¯é¡µé¢ï¼ˆ5å°æ—¶ï¼‰
   - ç¬¬3å¤©ï¼šæµ‹è¯•ä¼˜åŒ–ï¼ˆ3å°æ—¶ï¼‰

2. **ä¼˜å…ˆçº§æ’åº**
   - P0ï¼šé€šé“å›½å®¶å®šä»·åŠŸèƒ½
   - P1ï¼šåŸºç¡€ç»“ç®—æŸ¥è¯¢
   - P2ï¼šè‡ªåŠ¨ç»“ç®—å®šæ—¶ä»»åŠ¡
   - P3ï¼šæŠ¥è¡¨å’Œç»Ÿè®¡

3. **å¯ä»¥æš‚ç¼“çš„åŠŸèƒ½**
   - å¤æ‚çš„å›¾è¡¨å±•ç¤º
   - å¯¼å‡ºExcelåŠŸèƒ½
   - é«˜çº§ç­›é€‰åŠŸèƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: æ ¸å¿ƒå·²å®Œæˆï¼Œå‰©ä½™ä»£ç æ¨¡æ¿å·²æä¾›  
**æœ€åæ›´æ–°**: 2025-10-21
