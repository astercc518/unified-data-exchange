# 客户列表单价字段移除说明

## 问题描述

客户列表中显示"单价"列，但所有客户的单价都显示为 `￥0`，没有实际意义。

## 问题分析

### 1. 数据库模型
查看 [`User.js`](backend/models/User.js) 发现：
- ❌ 数据库表中**没有** `unit_price` 字段
- ✅ 有 `sale_price_rate` 字段（销售价比例）

### 2. 业务逻辑
通过代码分析发现：
- **unitPrice（单价）** 是在**订单**中使用的字段，表示数据的购买单价
- **客户**的定价是**动态计算**的，基于：
  - `salePriceRate`（销售价比例）
  - 数据的当前价格（根据时效动态变化）
  - 计算公式：`客户价格 = 数据当前价 × salePriceRate`

### 3. 问题根源
- 后端在返回客户列表时，硬编码 `unitPrice: 0`（作为兼容字段）
- 前端显示 `￥0`，没有实际业务意义
- 客户没有固定单价，只有销售价比例

## 解决方案

### 方案：移除"单价"列

**原因**：
1. 客户没有固定单价，只有动态定价
2. 显示 `￥0` 容易造成误解
3. 已有"销售价比例"列显示正确的定价信息

## 修复内容

### 1. 前端修改
**文件**: [`src/views/user/list.vue`](src/views/user/list.vue)

**移除内容**:
```vue
<!-- 移除的列 -->
<el-table-column
  :label="$t('user.unitPrice')"
  min-width="100px"
  align="center"
>
  <template slot-scope="{row}">
    <span>￥{{ row.unitPrice }}</span>
  </template>
</el-table-column>
```

**替换为**:
```vue
<!-- unitPrice列已移除 - 客户价格根据salePriceRate动态计算 -->
```

### 2. 后端修改
**文件**: [`backend/routes/users.js`](backend/routes/users.js)

**修改前**:
```javascript
return {
  // ... 其他字段
  salePriceRate: parseFloat(userData.sale_price_rate),
  unitPrice: userData.unit_price || 0, // 兼容旧字段 ❌
  accountBalance: parseFloat(userData.account_balance),
  // ...
};
```

**修改后**:
```javascript
return {
  // ... 其他字段
  salePriceRate: parseFloat(userData.sale_price_rate),
  // unitPrice 已移除 - 客户价格基于 salePriceRate 动态计算 ✅
  accountBalance: parseFloat(userData.account_balance),
  // ...
};
```

## 客户列表显示字段

修改后，客户列表显示以下字段：

| 字段 | 说明 | 示例 |
|------|------|------|
| ID | 客户ID | 1 |
| 登录账号 | loginAccount | testuser001 |
| 客户名称 | customerName | 测试客户 |
| 所属代理 | agentName | KL01 |
| 邮箱 | email | test@example.com |
| ~~单价~~ | ~~已移除~~ | ~~￥0~~ |
| **销售价比例** | salePriceRate | **1.2x** |
| 账户余额 | accountBalance | ￥1000.00000 |
| 状态 | status | 激活 |
| 创建时间 | createTime | 2025-10-15 12:00 |
| 操作 | - | 详情/编辑/更多 |

## 定价逻辑说明

### 客户如何获得价格？

客户购买数据时，价格计算方式：

```javascript
// 1. 获取数据当前价格（根据时效动态变化）
const dataCurrentPrice = calculateDynamicPrice(data);

// 2. 应用客户的销售价比例
const customerPrice = dataCurrentPrice × customer.salePriceRate;

// 示例：
// 数据当前价：$0.08
// 客户比例：1.2x
// 客户价格：$0.08 × 1.2 = $0.096
```

### 销售价比例含义

| 比例值 | 含义 | 示例 |
|-------|------|------|
| 1.0 | 原价 | 数据$0.08 → 客户支付$0.08 |
| 1.2 | 加价20% | 数据$0.08 → 客户支付$0.096 |
| 0.8 | 折扣20% | 数据$0.08 → 客户支付$0.064 |

## 测试验证

### 1. 查看API返回数据
```bash
curl http://localhost:3000/api/users
```

**预期结果**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "loginAccount": "testuser001",
      "customerName": "测试客户",
      "email": "test@example.com",
      "agentId": 3,
      "agentName": "KL01",
      "salePriceRate": 1.2,
      // ✅ 没有 unitPrice 字段
      "accountBalance": 1000,
      "overdraftAmount": 0,
      "status": 1,
      "createTime": 1760503705446,
      "updateTime": null,
      "remark": ""
    }
  ]
}
```

### 2. 前端页面验证
1. 登录系统：http://localhost:9527
2. 访问：用户管理 → 客户管理
3. 查看客户列表
4. 确认：
   - ✅ "单价"列已移除
   - ✅ "销售价比例"列正常显示（如：1.2x）
   - ✅ 其他列正常显示

## 修复前后对比

### 修复前
```
| ID | 登录账号 | 客户名称 | 代理 | 邮箱 | 单价 | 销售价比例 | 余额 |
|----|---------|---------|------|------|------|-----------|------|
| 1  | test001 | 测试    | KL01 | ... | ￥0  | 1.2x      | ￥100 |
```
❌ 单价显示 `￥0`，没有意义

### 修复后
```
| ID | 登录账号 | 客户名称 | 代理 | 邮箱 | 销售价比例 | 余额 |
|----|---------|---------|------|------|-----------|------|
| 1  | test001 | 测试    | KL01 | ... | 1.2x      | ￥100 |
```
✅ 移除无意义的"单价"列，保留有用的"销售价比例"

## 相关文件

- **前端列表页**: [`src/views/user/list.vue`](src/views/user/list.vue)
- **后端路由**: [`backend/routes/users.js`](backend/routes/users.js)
- **数据模型**: [`backend/models/User.js`](backend/models/User.js)

## 影响评估

### 不受影响的功能
✅ 客户创建/编辑  
✅ 客户列表查询  
✅ 客户详情查看  
✅ 充值/扣款功能  
✅ 订单创建（使用数据的实时价格）  
✅ 资源中心购买（根据 salePriceRate 计算客户价格）  

### 受影响的功能
⚠️ 客户列表显示 - "单价"列已移除  
✅ 使用"销售价比例"替代，更符合业务逻辑

## 业务说明

### 为什么客户没有固定单价？

1. **数据价格是动态的**
   - 根据时效（发布天数）动态降价
   - 3天内：原价
   - 4-7天：每天降5%
   - 8-15天：每天降2%
   - 16-30天：每天降1%
   - 30天+：最大降50%

2. **客户价格 = 数据价 × 比例**
   - 每个客户有自己的 `salePriceRate`
   - 购买时根据数据当前价格计算
   - 示例：
     ```
     数据A（3天内）：$0.10 × 1.2 = $0.12
     数据B（10天）：$0.07 × 1.2 = $0.084
     ```

3. **灵活的定价策略**
   - 代理可以为不同客户设置不同比例
   - VIP客户：0.9x（9折）
   - 普通客户：1.0x（原价）
   - 特殊客户：1.2x（加价20%）

## 修复状态

✅ **已完成**

- ✅ 前端移除"单价"列
- ✅ 后端移除 `unitPrice` 字段
- ✅ 后端服务已重启
- ✅ API返回数据正确
- ✅ 业务逻辑清晰

---

**修复时间**: 2025-10-15  
**修复人员**: AI Assistant  
**测试状态**: 已验证通过
