<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®šä»·ç®¡ç†åŒæ­¥æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .description {
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    
    .section h2 {
      color: #409eff;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .step {
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-left: 3px solid #409eff;
    }
    
    .step-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    
    button {
      background: #409eff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    button:hover {
      background: #66b1ff;
    }
    
    button.success {
      background: #67c23a;
    }
    
    button.warning {
      background: #e6a23c;
    }
    
    button.danger {
      background: #f56c6c;
    }
    
    .result {
      margin-top: 15px;
      padding: 15px;
      background: #ecf5ff;
      border-radius: 4px;
      border-left: 3px solid #409eff;
    }
    
    .result.success {
      background: #f0f9ff;
      border-left-color: #67c23a;
    }
    
    .result.error {
      background: #fef0f0;
      border-left-color: #f56c6c;
    }
    
    .data-item {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    
    .data-item strong {
      color: #409eff;
    }
    
    .price {
      color: #67c23a;
      font-weight: bold;
    }
    
    .count {
      color: #e6a23c;
      font-weight: bold;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    th, td {
      border: 1px solid #eee;
      padding: 10px;
      text-align: left;
    }
    
    th {
      background: #f5f7fa;
      color: #333;
      font-weight: bold;
    }
    
    .highlight {
      background: #fff9e6;
      padding: 2px 6px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”„ å®šä»·ç®¡ç†åŒæ­¥æµ‹è¯•</h1>
    <p class="description">
      æœ¬æµ‹è¯•ç”¨äºéªŒè¯å®šä»·ç®¡ç†åŠŸèƒ½æ˜¯å¦èƒ½å¤Ÿæ­£ç¡®åŒæ­¥æ›´æ–°èµ„æºä¸­å¿ƒçš„æ•°æ®ä»·æ ¼ã€‚
      åŒ…æ‹¬ï¼šåˆå§‹åŒ–æµ‹è¯•æ•°æ®ã€æŸ¥çœ‹å½“å‰æ•°æ®ã€ä¿®æ”¹å®šä»·ã€éªŒè¯åŒæ­¥ç»“æœç­‰æ­¥éª¤ã€‚
    </p>

    <!-- ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–æµ‹è¯•æ•°æ® -->
    <div class="section">
      <h2>æ­¥éª¤1ï¼šåˆå§‹åŒ–æµ‹è¯•æ•°æ®</h2>
      <div class="step">
        <div class="step-title">åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®åˆ°èµ„æºä¸­å¿ƒ</div>
        <button onclick="initTestData()">åˆå§‹åŒ–æµ‹è¯•æ•°æ®</button>
        <button class="warning" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        <div id="init-result"></div>
      </div>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šæŸ¥çœ‹å½“å‰æ•°æ® -->
    <div class="section">
      <h2>æ­¥éª¤2ï¼šæŸ¥çœ‹å½“å‰èµ„æºä¸­å¿ƒæ•°æ®</h2>
      <div class="step">
        <div class="step-title">æ˜¾ç¤ºå½“å‰æ‰€æœ‰æ•°æ®åŠå…¶ä»·æ ¼</div>
        <button onclick="viewCurrentData()">æŸ¥çœ‹å½“å‰æ•°æ®</button>
        <div id="view-result"></div>
      </div>
    </div>

    <!-- ç¬¬ä¸‰æ­¥ï¼šæ¨¡æ‹Ÿå®šä»·æ›´æ–° -->
    <div class="section">
      <h2>æ­¥éª¤3ï¼šæ¨¡æ‹Ÿå®šä»·ç®¡ç†ä¿®æ”¹ä»·æ ¼</h2>
      <div class="step">
        <div class="step-title">æ‰¹é‡æ›´æ–°æŒ‡å®šå›½å®¶å’Œæ—¶æ•ˆçš„æ•°æ®ä»·æ ¼</div>
        <div style="margin-bottom: 10px;">
          <label>
            å›½å®¶ï¼š
            <select id="country-select">
              <option value="å­ŸåŠ æ‹‰å›½">å­ŸåŠ æ‹‰å›½ (BD)</option>
              <option value="å°åº¦">å°åº¦ (IN)</option>
              <option value="æ³°å›½">æ³°å›½ (TH)</option>
            </select>
          </label>
          <label style="margin-left: 15px;">
            æ—¶æ•ˆï¼š
            <select id="validity-select">
              <option value="3">3å¤©å†…</option>
              <option value="30">30å¤©å†…</option>
              <option value="30+">30å¤©ä»¥ä¸Š</option>
            </select>
          </label>
        </div>
        <div style="margin-bottom: 10px;">
          <label>
            æ–°æˆæœ¬ä»·ï¼š
            <input type="number" id="new-cost-price" value="0.035" step="0.001" style="width: 100px;">
            U/æ¡
          </label>
          <label style="margin-left: 15px;">
            æ–°é”€å”®ä»·ï¼š
            <input type="number" id="new-sell-price" value="0.045" step="0.001" style="width: 100px;">
            U/æ¡
          </label>
        </div>
        <button class="success" onclick="updatePricing()">æ‰§è¡Œå®šä»·æ›´æ–°</button>
        <div id="update-result"></div>
      </div>
    </div>

    <!-- ç¬¬å››æ­¥ï¼šéªŒè¯åŒæ­¥ç»“æœ -->
    <div class="section">
      <h2>æ­¥éª¤4ï¼šéªŒè¯æ•°æ®åŒæ­¥ç»“æœ</h2>
      <div class="step">
        <div class="step-title">æ£€æŸ¥èµ„æºä¸­å¿ƒæ•°æ®ä»·æ ¼æ˜¯å¦å·²æ›´æ–°</div>
        <button onclick="verifySync()">éªŒè¯åŒæ­¥ç»“æœ</button>
        <div id="verify-result"></div>
      </div>
    </div>

    <!-- ç¬¬äº”æ­¥ï¼šæŸ¥çœ‹å®šä»·å†å² -->
    <div class="section">
      <h2>æ­¥éª¤5ï¼šæŸ¥çœ‹å®šä»·å†å²è®°å½•</h2>
      <div class="step">
        <div class="step-title">æ˜¾ç¤ºæ‰€æœ‰å®šä»·å˜æ›´è®°å½•</div>
        <button onclick="viewPricingHistory()">æŸ¥çœ‹å®šä»·å†å²</button>
        <div id="history-result"></div>
      </div>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ–æµ‹è¯•æ•°æ®
    function initTestData() {
      const testData = [
        {
          id: 1,
          country: 'å­ŸåŠ æ‹‰å›½',
          countryCode: 'BD',
          validity: '3',
          source: 'Grameenphoneå®˜æ–¹',
          dataType: 'æ‰‹æœºå·ç ',
          availableQuantity: 500000,
          operators: [
            { name: 'Grameenphone', count: 150000 },
            { name: 'Robi', count: 150000 },
            { name: 'Banglalink', count: 100000 },
            { name: 'Teletalk', count: 100000 }
          ],
          sellPrice: 0.05,
          costPrice: 0.04,
          uploadTime: Date.now(),
          status: 'available'
        },
        {
          id: 2,
          country: 'å­ŸåŠ æ‹‰å›½',
          countryCode: 'BD',
          validity: '30',
          source: 'ç¬¬ä¸‰æ–¹é‡‡é›†',
          dataType: 'ç”¨æˆ·èµ„æ–™',
          availableQuantity: 800000,
          operators: [
            { name: 'Grameenphone', count: 200000 },
            { name: 'Robi', count: 200000 },
            { name: 'Banglalink', count: 200000 },
            { name: 'Teletalk', count: 200000 }
          ],
          sellPrice: 0.04,
          costPrice: 0.03,
          uploadTime: Date.now(),
          status: 'available'
        },
        {
          id: 3,
          country: 'å­ŸåŠ æ‹‰å›½',
          countryCode: 'BD',
          validity: '30+',
          source: 'åˆä½œä¼™ä¼´',
          dataType: 'ç”µè¯å·ç ',
          availableQuantity: 1200000,
          operators: [
            { name: 'Grameenphone', count: 300000 },
            { name: 'Robi', count: 300000 },
            { name: 'Banglalink', count: 300000 },
            { name: 'Teletalk', count: 300000 }
          ],
          sellPrice: 0.03,
          costPrice: 0.02,
          uploadTime: Date.now(),
          status: 'available'
        },
        {
          id: 4,
          country: 'å°åº¦',
          countryCode: 'IN',
          validity: '3',
          source: 'Airtelå®˜æ–¹',
          dataType: 'æ‰‹æœºå·ç ',
          availableQuantity: 600000,
          operators: [
            { name: 'Airtel', count: 200000 },
            { name: 'Jio', count: 200000 },
            { name: 'Vi', count: 150000 },
            { name: 'BSNL', count: 50000 }
          ],
          sellPrice: 0.05,
          costPrice: 0.04,
          uploadTime: Date.now(),
          status: 'available'
        },
        {
          id: 5,
          country: 'å°åº¦',
          countryCode: 'IN',
          validity: '30',
          source: 'ç¬¬ä¸‰æ–¹é‡‡é›†',
          dataType: 'ç”¨æˆ·èµ„æ–™',
          availableQuantity: 900000,
          operators: [
            { name: 'Airtel', count: 300000 },
            { name: 'Jio', count: 300000 },
            { name: 'Vi', count: 200000 },
            { name: 'BSNL', count: 100000 }
          ],
          sellPrice: 0.04,
          costPrice: 0.03,
          uploadTime: Date.now(),
          status: 'available'
        }
      ];

      localStorage.setItem('dataList', JSON.stringify(testData));

      const resultDiv = document.getElementById('init-result');
      resultDiv.className = 'result success';
      resultDiv.innerHTML = `
        <strong>âœ… åˆå§‹åŒ–æˆåŠŸï¼</strong><br>
        å·²åˆ›å»º ${testData.length} æ¡æµ‹è¯•æ•°æ®åˆ°èµ„æºä¸­å¿ƒã€‚<br>
        åŒ…æ‹¬ï¼šå­ŸåŠ æ‹‰å›½ï¼ˆ3æ¡ï¼‰ã€å°åº¦ï¼ˆ2æ¡ï¼‰çš„ä¸åŒæ—¶æ•ˆæ•°æ®ã€‚
      `;
    }

    // æ¸…ç©ºæ‰€æœ‰æ•°æ®
    function clearAllData() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤èµ„æºä¸­å¿ƒå’Œå®šä»·å†å²çš„æ‰€æœ‰æ•°æ®ã€‚')) {
        localStorage.removeItem('dataList');
        localStorage.removeItem('pricingHistory');
        
        const resultDiv = document.getElementById('init-result');
        resultDiv.className = 'result';
        resultDiv.innerHTML = '<strong>ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®</strong>';
      }
    }

    // æŸ¥çœ‹å½“å‰æ•°æ®
    function viewCurrentData() {
      const dataList = JSON.parse(localStorage.getItem('dataList') || '[]');
      
      const resultDiv = document.getElementById('view-result');
      
      if (dataList.length === 0) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = '<strong>âš ï¸ æš‚æ— æ•°æ®ï¼Œè¯·å…ˆåˆå§‹åŒ–æµ‹è¯•æ•°æ®</strong>';
        return;
      }

      let html = '<strong>ğŸ“Š å½“å‰èµ„æºä¸­å¿ƒæ•°æ®ï¼š</strong><br>';
      html += '<table>';
      html += '<tr><th>ID</th><th>å›½å®¶</th><th>æ—¶æ•ˆ</th><th>æ•°æ®ç±»å‹</th><th>æ•°æ®é‡</th><th>æˆæœ¬ä»·</th><th>é”€å”®ä»·</th><th>æ¥æº</th></tr>';
      
      dataList.forEach(item => {
        html += `<tr>
          <td>${item.id}</td>
          <td>${item.country} (${item.countryCode})</td>
          <td>${getValidityText(item.validity)}</td>
          <td>${item.dataType}</td>
          <td class="count">${item.availableQuantity.toLocaleString()}</td>
          <td class="price">${item.costPrice} U/æ¡</td>
          <td class="price">${item.sellPrice} U/æ¡</td>
          <td>${item.source}</td>
        </tr>`;
      });
      
      html += '</table>';
      
      resultDiv.className = 'result success';
      resultDiv.innerHTML = html;
    }

    // æ¨¡æ‹Ÿå®šä»·æ›´æ–°
    function updatePricing() {
      const country = document.getElementById('country-select').value;
      const validity = document.getElementById('validity-select').value;
      const newCostPrice = parseFloat(document.getElementById('new-cost-price').value);
      const newSellPrice = parseFloat(document.getElementById('new-sell-price').value);

      // æ¨¡æ‹Ÿå®šä»·ç®¡ç†é¡µé¢çš„æ›´æ–°é€»è¾‘
      const result = updateResourceCenterPricing({
        country: country,
        validity: validity,
        costPrice: newCostPrice,
        sellPrice: newSellPrice
      });

      const resultDiv = document.getElementById('update-result');
      
      if (result.success) {
        resultDiv.className = 'result success';
        resultDiv.innerHTML = `
          <strong>âœ… å®šä»·æ›´æ–°æˆåŠŸï¼</strong><br>
          æ›´æ–°æ¡ä»¶ï¼š<span class="highlight">${country}</span> - <span class="highlight">${getValidityText(validity)}</span><br>
          æ–°æˆæœ¬ä»·ï¼š<span class="price">${newCostPrice} U/æ¡</span><br>
          æ–°é”€å”®ä»·ï¼š<span class="price">${newSellPrice} U/æ¡</span><br>
          åˆ©æ¶¦ç‡ï¼š<span class="price">${((newSellPrice - newCostPrice) / newCostPrice * 100).toFixed(1)}%</span><br>
          <strong>å·²æ›´æ–° <span class="count">${result.count}</span> æ¡æ•°æ®</strong>
        `;

        // ä¿å­˜å®šä»·å†å²
        savePricingHistory({
          changeTime: new Date(),
          country: country,
          validity: validity,
          oldCostPrice: result.oldPrices[0]?.costPrice || 0,
          newCostPrice: newCostPrice,
          oldSellPrice: result.oldPrices[0]?.sellPrice || 0,
          newSellPrice: newSellPrice,
          operator: 'æµ‹è¯•ç”¨æˆ·',
          remark: `æ‰¹é‡æ›´æ–°å®šä»·ï¼Œå½±å“ ${result.count} æ¡æ•°æ®`
        });
      } else {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = '<strong>âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æ•°æ®</strong>';
      }
    }

    // æ›´æ–°èµ„æºä¸­å¿ƒå®šä»·ï¼ˆæ¨¡æ‹Ÿå®šä»·ç®¡ç†é¡µé¢çš„é€»è¾‘ï¼‰
    function updateResourceCenterPricing(pricingRow) {
      try {
        const savedDataList = localStorage.getItem('dataList');
        if (!savedDataList) {
          return { success: true, count: 0 };
        }

        let dataList = JSON.parse(savedDataList);
        let updateCount = 0;
        const oldPrices = [];

        const countryCode = getCountryCodeByName(pricingRow.country);

        dataList = dataList.map(item => {
          const countryMatch = item.countryCode === countryCode || item.country === pricingRow.country;
          const validityMatch = item.validity === pricingRow.validity;

          if (countryMatch && validityMatch) {
            oldPrices.push({
              costPrice: item.costPrice,
              sellPrice: item.sellPrice
            });
            item.costPrice = pricingRow.costPrice;
            item.sellPrice = pricingRow.sellPrice;
            item.updateTime = Date.now();
            updateCount++;
          }

          return item;
        });

        localStorage.setItem('dataList', JSON.stringify(dataList));

        return { success: true, count: updateCount, oldPrices: oldPrices };
      } catch (error) {
        console.error('æ›´æ–°å¤±è´¥:', error);
        return { success: false, count: 0 };
      }
    }

    // éªŒè¯åŒæ­¥ç»“æœ
    function verifySync() {
      const country = document.getElementById('country-select').value;
      const validity = document.getElementById('validity-select').value;
      const expectedCostPrice = parseFloat(document.getElementById('new-cost-price').value);
      const expectedSellPrice = parseFloat(document.getElementById('new-sell-price').value);

      const dataList = JSON.parse(localStorage.getItem('dataList') || '[]');
      const countryCode = getCountryCodeByName(country);
      
      const matchedData = dataList.filter(item => {
        const countryMatch = item.countryCode === countryCode || item.country === country;
        const validityMatch = item.validity === validity;
        return countryMatch && validityMatch;
      });

      const resultDiv = document.getElementById('verify-result');
      
      if (matchedData.length === 0) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = '<strong>âŒ æœªæ‰¾åˆ°åŒ¹é…çš„æ•°æ®</strong>';
        return;
      }

      const allCorrect = matchedData.every(item => 
        item.costPrice === expectedCostPrice && 
        item.sellPrice === expectedSellPrice
      );

      if (allCorrect) {
        let html = '<strong>âœ… åŒæ­¥éªŒè¯é€šè¿‡ï¼</strong><br>';
        html += `æ‰¾åˆ° ${matchedData.length} æ¡åŒ¹é…æ•°æ®ï¼Œä»·æ ¼å·²å…¨éƒ¨æ›´æ–°ï¼š<br><br>`;
        
        matchedData.forEach(item => {
          html += `<div class="data-item">
            <strong>ID ${item.id}</strong> - ${item.country} - ${getValidityText(item.validity)} - ${item.dataType}<br>
            æˆæœ¬ä»·ï¼š<span class="price">${item.costPrice} U/æ¡</span> | 
            é”€å”®ä»·ï¼š<span class="price">${item.sellPrice} U/æ¡</span> | 
            æ•°æ®é‡ï¼š<span class="count">${item.availableQuantity.toLocaleString()}</span>
          </div>`;
        });
        
        resultDiv.className = 'result success';
        resultDiv.innerHTML = html;
      } else {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = '<strong>âŒ ä»·æ ¼æœªæ­£ç¡®æ›´æ–°ï¼Œè¯·æ£€æŸ¥</strong>';
      }
    }

    // æŸ¥çœ‹å®šä»·å†å²
    function viewPricingHistory() {
      const history = JSON.parse(localStorage.getItem('pricingHistory') || '[]');
      
      const resultDiv = document.getElementById('history-result');
      
      if (history.length === 0) {
        resultDiv.className = 'result';
        resultDiv.innerHTML = '<strong>ğŸ“ æš‚æ— å®šä»·å†å²è®°å½•</strong>';
        return;
      }

      let html = '<strong>ğŸ“ å®šä»·å†å²è®°å½•ï¼š</strong><br>';
      html += '<table>';
      html += '<tr><th>æ—¶é—´</th><th>å›½å®¶</th><th>æ—¶æ•ˆ</th><th>æˆæœ¬ä»·å˜æ›´</th><th>é”€å”®ä»·å˜æ›´</th><th>æ“ä½œäºº</th><th>å¤‡æ³¨</th></tr>';
      
      history.forEach(item => {
        const changeTime = new Date(item.changeTime).toLocaleString();
        html += `<tr>
          <td>${changeTime}</td>
          <td>${item.country}</td>
          <td>${getValidityText(item.validity)}</td>
          <td>${item.oldCostPrice} â†’ ${item.newCostPrice}</td>
          <td>${item.oldSellPrice} â†’ ${item.newSellPrice}</td>
          <td>${item.operator}</td>
          <td>${item.remark}</td>
        </tr>`;
      });
      
      html += '</table>';
      
      resultDiv.className = 'result success';
      resultDiv.innerHTML = html;
    }

    // ä¿å­˜å®šä»·å†å²
    function savePricingHistory(historyItem) {
      const history = JSON.parse(localStorage.getItem('pricingHistory') || '[]');
      history.unshift(historyItem);
      localStorage.setItem('pricingHistory', JSON.stringify(history));
    }

    // è¾…åŠ©å‡½æ•°
    function getCountryCodeByName(countryName) {
      const countryMap = {
        'å­ŸåŠ æ‹‰å›½': 'BD',
        'å°åº¦': 'IN',
        'æ³°å›½': 'TH',
        'è¶Šå—': 'VN',
        'å°åº¦å°¼è¥¿äºš': 'ID',
        'è²å¾‹å®¾': 'PH',
        'å·´åŸºæ–¯å¦': 'PK',
        'ç¼…ç”¸': 'MM',
        'é©¬æ¥è¥¿äºš': 'MY',
        'æ–°åŠ å¡': 'SG'
      };
      return countryMap[countryName] || countryName;
    }

    function getValidityText(validity) {
      const validityMap = {
        '3': '3å¤©å†…',
        '30': '30å¤©å†…',
        '30+': '30å¤©ä»¥ä¸Š'
      };
      return validityMap[validity] || validity;
    }
  </script>
</body>
</html>
