<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>åŠ¨æ€å®šä»·é”™è¯¯è¯Šæ–­</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #409eff;
      padding-bottom: 10px;
    }
    button {
      background: #409eff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #66b1ff;
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .success {
      background: #f0f9ff;
      border-left: 4px solid #67c23a;
      color: #67c23a;
    }
    .error {
      background: #fef0f0;
      border-left: 4px solid #f56c6c;
      color: #f56c6c;
    }
    .warning {
      background: #fdf6ec;
      border-left: 4px solid #e6a23c;
      color: #e6a23c;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ” åŠ¨æ€å®šä»·é”™è¯¯è¯Šæ–­å·¥å…·</h1>

  <div class="test-section">
    <h2>æµ‹è¯•1: æ£€æŸ¥APIæ•°æ®</h2>
    <button onclick="testAPIData()">å¼€å§‹æµ‹è¯•</button>
    <div id="api-result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•2: æµ‹è¯•åŠ¨æ€å®šä»·è®¡ç®—</h2>
    <button onclick="testPricingCalculation()">å¼€å§‹æµ‹è¯•</button>
    <div id="pricing-result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•3: æ£€æŸ¥æ•°æ®å­—æ®µ</h2>
    <button onclick="testDataFields()">å¼€å§‹æµ‹è¯•</button>
    <div id="fields-result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•4: æ¨¡æ‹Ÿå®Œæ•´æµç¨‹</h2>
    <button onclick="testFullProcess()">å¼€å§‹æµ‹è¯•</button>
    <div id="full-result"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';

    // åŠ¨æ€å®šä»·è®¡ç®—å‡½æ•°ï¼ˆä»dynamicPricing.jså¤åˆ¶ï¼‰
    function calculateCurrentPrice(dataItem, currentTime = Date.now()) {
      if (!dataItem || typeof dataItem !== 'object') {
        console.warn('âš ï¸ calculateCurrentPrice: æ— æ•ˆçš„ dataItem', dataItem)
        return {
          currentPrice: 0,
          validityDisplay: 'æœªçŸ¥',
          discountInfo: 'æ— ',
          daysSincePublish: 0,
          originalPrice: 0,
          discountPercent: '0'
        }
      }
      
      const { sellPrice, costPrice, publishTime } = dataItem

      if (!publishTime || !sellPrice) {
        return {
          currentPrice: sellPrice || 0,
          validityDisplay: 'æœªçŸ¥',
          discountInfo: 'æ— ',
          daysSincePublish: 0,
          originalPrice: sellPrice || 0,
          discountPercent: '0'
        }
      }
      
      try {
        const daysSincePublish = Math.floor((currentTime - publishTime) / (1000 * 60 * 60 * 24))

        let currentPrice = sellPrice
        let validityDisplay = 'æœªçŸ¥'
        let discountInfo = 'æ— æŠ˜æ‰£'
        let totalDiscountRate = 0

        if (daysSincePublish <= 3) {
          currentPrice = sellPrice
          validityDisplay = '3å¤©å†…'
          discountInfo = 'åŸä»·'
          totalDiscountRate = 0
        } else if (daysSincePublish <= 7) {
          const discountDays = daysSincePublish - 3
          totalDiscountRate = discountDays * 0.05
          currentPrice = sellPrice * (1 - totalDiscountRate)
          validityDisplay = '7å¤©å†…'
          discountInfo = `ç¬¬${daysSincePublish}å¤©ï¼Œæ¯å¤©é™5%ï¼Œå·²é™${(totalDiscountRate * 100).toFixed(0)}%`
        } else if (daysSincePublish <= 15) {
          const firstPeriodDiscount = 4 * 0.05
          const discountDays = daysSincePublish - 7
          const secondPeriodDiscount = discountDays * 0.02
          totalDiscountRate = firstPeriodDiscount + secondPeriodDiscount
          currentPrice = sellPrice * (1 - totalDiscountRate)
          validityDisplay = '15å¤©å†…'
          discountInfo = `ç¬¬${daysSincePublish}å¤©ï¼Œå·²é™${(totalDiscountRate * 100).toFixed(0)}%`
        } else if (daysSincePublish <= 30) {
          const firstPeriodDiscount = 4 * 0.05
          const secondPeriodDiscount = 8 * 0.02
          const discountDays = daysSincePublish - 15
          const thirdPeriodDiscount = discountDays * 0.01
          totalDiscountRate = firstPeriodDiscount + secondPeriodDiscount + thirdPeriodDiscount
          currentPrice = sellPrice * (1 - totalDiscountRate)
          validityDisplay = '30å¤©å†…'
          discountInfo = `ç¬¬${daysSincePublish}å¤©ï¼Œå·²é™${(totalDiscountRate * 100).toFixed(0)}%`
        } else {
          totalDiscountRate = 0.50
          currentPrice = sellPrice * 0.5
          validityDisplay = 'è¿‘æœŸ'
          discountInfo = `ç¬¬${daysSincePublish}å¤©ï¼Œå·²è¾¾æœ€å¤§é™ä»·50%`
        }

        const maxDiscountPrice = sellPrice * 0.5
        if (currentPrice < maxDiscountPrice) {
          currentPrice = maxDiscountPrice
          totalDiscountRate = 0.50
        }

        if (costPrice && currentPrice < costPrice) {
          currentPrice = costPrice
          totalDiscountRate = (sellPrice - costPrice) / sellPrice
        }

        return {
          currentPrice: Number(currentPrice.toFixed(4)),
          validityDisplay,
          discountInfo,
          daysSincePublish,
          originalPrice: sellPrice,
          discountPercent: (totalDiscountRate * 100).toFixed(1)
        }
      } catch (error) {
        console.error('âŒ calculateCurrentPrice è®¡ç®—å‡ºé”™:', error, dataItem)
        return {
          currentPrice: sellPrice || 0,
          validityDisplay: 'é”™è¯¯',
          discountInfo: 'è®¡ç®—å¤±è´¥',
          daysSincePublish: 0,
          originalPrice: sellPrice || 0,
          discountPercent: '0'
        }
      }
    }

    // æµ‹è¯•1: æ£€æŸ¥APIæ•°æ®
    async function testAPIData() {
      const resultDiv = document.getElementById('api-result');
      resultDiv.innerHTML = '<div class="result warning">â³ æ­£åœ¨è·å–APIæ•°æ®...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/data-library/published`);
        const data = await response.json();

        let html = '<div class="result success">';
        html += `âœ… APIå“åº”æˆåŠŸ\n\n`;
        html += `æ•°æ®æ¡æ•°: ${data.data?.length || 0}\n`;
        
        if (data.data && data.data.length > 0) {
          const item = data.data[0];
          html += `\nç¬¬ä¸€æ¡æ•°æ®:\n`;
          html += `<pre>${JSON.stringify(item, null, 2)}</pre>`;
        }
        
        html += '</div>';
        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">âŒ æµ‹è¯•å¤±è´¥\n${error.message}\n${error.stack}</div>`;
      }
    }

    // æµ‹è¯•2: æµ‹è¯•åŠ¨æ€å®šä»·è®¡ç®—
    async function testPricingCalculation() {
      const resultDiv = document.getElementById('pricing-result');
      resultDiv.innerHTML = '<div class="result warning">â³ æ­£åœ¨æµ‹è¯•å®šä»·è®¡ç®—...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/data-library/published`);
        const data = await response.json();

        if (!data.data || data.data.length === 0) {
          throw new Error('APIæœªè¿”å›æ•°æ®');
        }

        const item = data.data[0];
        
        // è½¬æ¢æ•°æ®æ ¼å¼
        const convertedItem = {
          sellPrice: parseFloat(item.sell_price),
          costPrice: parseFloat(item.cost_price),
          publishTime: item.publish_time
        };

        console.log('è½¬æ¢åçš„æ•°æ®:', convertedItem);

        // è®¡ç®—å®šä»·
        const pricingInfo = calculateCurrentPrice(convertedItem);

        let html = '<div class="result success">';
        html += `âœ… å®šä»·è®¡ç®—æˆåŠŸ\n\n`;
        html += `è¾“å…¥æ•°æ®:\n`;
        html += `<pre>${JSON.stringify(convertedItem, null, 2)}</pre>\n`;
        html += `\nè®¡ç®—ç»“æœ:\n`;
        html += `<pre>${JSON.stringify(pricingInfo, null, 2)}</pre>`;
        html += '</div>';
        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">âŒ æµ‹è¯•å¤±è´¥\n${error.message}\n${error.stack}</div>`;
      }
    }

    // æµ‹è¯•3: æ£€æŸ¥æ•°æ®å­—æ®µ
    async function testDataFields() {
      const resultDiv = document.getElementById('fields-result');
      resultDiv.innerHTML = '<div class="result warning">â³ æ­£åœ¨æ£€æŸ¥æ•°æ®å­—æ®µ...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/data-library/published`);
        const data = await response.json();

        if (!data.data || data.data.length === 0) {
          throw new Error('APIæœªè¿”å›æ•°æ®');
        }

        const item = data.data[0];

        let html = '<div class="result ';
        
        // æ£€æŸ¥å¿…éœ€å­—æ®µ
        const hasPrice = item.sell_price !== undefined && item.sell_price !== null;
        const hasTime = item.publish_time !== undefined && item.publish_time !== null;
        
        if (hasPrice && hasTime) {
          html += 'success">';
          html += `âœ… æ•°æ®å­—æ®µå®Œæ•´\n\n`;
        } else {
          html += 'error">';
          html += `âŒ æ•°æ®å­—æ®µç¼ºå¤±\n\n`;
        }

        html += `å­—æ®µæ£€æŸ¥:\n`;
        html += `- sell_price: ${item.sell_price} ${hasPrice ? 'âœ…' : 'âŒ'}\n`;
        html += `- cost_price: ${item.cost_price}\n`;
        html += `- publish_time: ${item.publish_time} ${hasTime ? 'âœ…' : 'âŒ'}\n`;
        html += `- å‘å¸ƒæ—¶é—´: ${new Date(item.publish_time).toLocaleString()}\n`;
        html += `- å‘å¸ƒå¤©æ•°: ${Math.floor((Date.now() - item.publish_time) / (1000 * 60 * 60 * 24))}å¤©\n`;

        html += `\nå®Œæ•´æ•°æ®:\n<pre>${JSON.stringify(item, null, 2)}</pre>`;
        html += '</div>';
        
        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">âŒ æµ‹è¯•å¤±è´¥\n${error.message}\n${error.stack}</div>`;
      }
    }

    // æµ‹è¯•4: æ¨¡æ‹Ÿå®Œæ•´æµç¨‹
    async function testFullProcess() {
      const resultDiv = document.getElementById('full-result');
      resultDiv.innerHTML = '<div class="result warning">â³ æ­£åœ¨æ¨¡æ‹Ÿå®Œæ•´æµç¨‹...</div>';

      try {
        // 1. è·å–APIæ•°æ®
        const response = await fetch(`${API_BASE}/api/data-library/published`);
        const apiData = await response.json();

        if (!apiData.data || apiData.data.length === 0) {
          throw new Error('APIæœªè¿”å›æ•°æ®');
        }

        // 2. è½¬æ¢æ•°æ®æ ¼å¼ï¼ˆæ¨¡æ‹Ÿcenter.vueçš„è½¬æ¢é€»è¾‘ï¼‰
        const dataList = apiData.data.map(item => ({
          id: item.id,
          country: item.country_name || item.country,
          countryCode: item.country,
          sellPrice: parseFloat(item.sell_price) || 0,
          costPrice: parseFloat(item.cost_price) || 0,
          publishTime: item.publish_time,
          availableQuantity: item.available_quantity
        }));

        console.log('è½¬æ¢åçš„æ•°æ®åˆ—è¡¨:', dataList);

        // 3. åº”ç”¨åŠ¨æ€å®šä»·
        const pricedDataList = dataList.map(item => {
          const pricingInfo = calculateCurrentPrice(item);
          return {
            ...item,
            currentSellPrice: pricingInfo.currentPrice,
            validityDisplay: pricingInfo.validityDisplay,
            discountInfo: pricingInfo.discountInfo,
            originalSellPrice: item.sellPrice
          };
        });

        console.log('å®šä»·åçš„æ•°æ®åˆ—è¡¨:', pricedDataList);

        // 4. æ˜¾ç¤ºç¬¬ä¸€æ¡æ•°æ®çš„å®šä»·ç¤ºä¾‹
        const sample = pricedDataList[0];
        const displayData = {
          'åŸå§‹ä»·æ ¼': sample.originalSellPrice || sample.sellPrice,
          'å½“å‰ä»·æ ¼': sample.currentSellPrice,
          'æ—¶æ•ˆæ˜¾ç¤º': sample.validityDisplay,
          'æŠ˜æ‰£ä¿¡æ¯': sample.discountInfo
        };

        console.log('ğŸ’° åŠ¨æ€å®šä»·ç¤ºä¾‹:', displayData);

        let html = '<div class="result success">';
        html += `âœ… å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸ\n\n`;
        html += `å¤„ç†æµç¨‹:\n`;
        html += `1. APIè¿”å› ${apiData.data.length} æ¡æ•°æ® âœ…\n`;
        html += `2. æ•°æ®è½¬æ¢å®Œæˆ ${dataList.length} æ¡ âœ…\n`;
        html += `3. åŠ¨æ€å®šä»·å®Œæˆ ${pricedDataList.length} æ¡ âœ…\n\n`;
        html += `ğŸ’° åŠ¨æ€å®šä»·ç¤ºä¾‹:\n`;
        html += `<pre>${JSON.stringify(displayData, null, 2)}</pre>\n\n`;
        html += `å®Œæ•´æ•°æ®:\n`;
        html += `<pre>${JSON.stringify(sample, null, 2)}</pre>`;
        html += '</div>';
        
        resultDiv.innerHTML = html;

      } catch (error) {
        let html = '<div class="result error">';
        html += `âŒ æµ‹è¯•å¤±è´¥\n\n`;
        html += `é”™è¯¯ä¿¡æ¯: ${error.message}\n\n`;
        html += `é”™è¯¯å †æ ˆ:\n<pre>${error.stack}</pre>`;
        html += '</div>';
        resultDiv.innerHTML = html;
      }
    }
  </script>
</body>
</html>
