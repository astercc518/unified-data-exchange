# 共用国码处理功能说明

## 📋 功能概述

当选择国际电话区号为 **+1** 时，系统会自动识别这是一个共用国码（美国、加拿大、多米尼加共用），并显示二级选择器让用户选择具体国家。

**默认行为：** 选择 +1 后，默认自动选中"美国"，用户可以手动切换为"加拿大"或"多米尼加"。

## 🎯 适用场景

此功能适用于以下两个模块：
1. **一键清洗** - 清洗数据时选择国家
2. **增加国码** - 为数据添加国码时选择国家

## 🔧 实现细节

### 1. 辅助函数（countries.js）

在 `src/data/countries.js` 中添加了三个辅助函数：

```javascript
/**
 * 根据国际电话区号获取所有国家
 * @param {string} dialCode - 国际电话区号（如 +1, +7）
 * @returns {Array} 国家列表
 */
export function getCountriesByDialCode(dialCode) {
  return countryList.filter(country => country.dialCode === dialCode)
}

/**
 * 检查是否为共用国码（多个国家共用同一国码）
 * @param {string} dialCode - 国际电话区号（如 +1, +7）
 * @returns {boolean} 是否为共用国码
 */
export function isSharedDialCode(dialCode) {
  const countries = getCountriesByDialCode(dialCode)
  return countries.length > 1
}

/**
 * 获取共用国码的默认国家
 * +1 -> 美国 (US)
 * +7 -> 俄罗斯 (RU)
 * @param {string} dialCode - 国际电话区号
 * @returns {Object|null} 默认国家对象
 */
export function getDefaultCountryForDialCode(dialCode) {
  const defaultMapping = {
    '+1': 'US', // 美国、加拿大、多米尼加 -> 默认美国
    '+7': 'RU' // 俄罗斯、哈萨克斯坦 -> 默认俄罗斯
  }

  const defaultCode = defaultMapping[dialCode]
  if (defaultCode) {
    return countryList.find(country => country.code === defaultCode)
  }

  // 如果没有默认映射，返回第一个国家
  const countries = getCountriesByDialCode(dialCode)
  return countries.length > 0 ? countries[0] : null
}
```

### 2. 数据字段（processing.vue）

#### 一键清洗表单
```javascript
cleanDataForm: {
  fileIds: [],
  countryCode: '',
  specificCountry: '', // 共用国码时选择的具体国家代码
  options: ['autoAddCode', 'autoDeduplicate', 'removeInvalid']
},
showCleanDataCountrySelector: false, // 是否显示共用国码的二级选择器
cleanDataCountryOptions: [], // 共用国码的国家选项列表
```

#### 增加国码表单
```javascript
addCodeForm: {
  fileIds: [],
  countryCode: '',
  countryCodePrefix: '',
  specificCountry: '' // 共用国码时选择的具体国家代码
},
showAddCodeCountrySelector: false, // 是否显示共用国码的二级选择器
addCodeCountryOptions: [], // 共用国码的国家选项列表
```

### 3. 处理方法（processing.vue）

#### 一键清洗 - 国家选择变化处理
```javascript
handleCleanDataCountryChange(dialCode) {
  const { isSharedDialCode, getCountriesByDialCode, getDefaultCountryForDialCode } = require('@/data/countries')

  if (dialCode && isSharedDialCode(dialCode)) {
    // 共用国码，显示二级选择器
    this.showCleanDataCountrySelector = true
    this.cleanDataCountryOptions = getCountriesByDialCode(dialCode)
    // 设置默认值为美国（+1的情况）或其他默认值
    const defaultCountry = getDefaultCountryForDialCode(dialCode)
    this.cleanDataForm.specificCountry = defaultCountry ? defaultCountry.code : ''
  } else {
    // 非共用国码，隐藏二级选择器
    this.showCleanDataCountrySelector = false
    this.cleanDataCountryOptions = []
    this.cleanDataForm.specificCountry = ''
  }
}
```

#### 增加国码 - 国家选择变化处理
```javascript
handleAddCodeCountryChange(dialCode) {
  const { isSharedDialCode, getCountriesByDialCode, getDefaultCountryForDialCode } = require('@/data/countries')

  if (dialCode && isSharedDialCode(dialCode)) {
    // 共用国码，显示二级选择器
    this.showAddCodeCountrySelector = true
    this.addCodeCountryOptions = getCountriesByDialCode(dialCode)
    // 设置默认值为美国（+1的情况）或其他默认值
    const defaultCountry = getDefaultCountryForDialCode(dialCode)
    this.addCodeForm.specificCountry = defaultCountry ? defaultCountry.code : ''
  } else {
    // 非共用国码，隐藏二级选择器
    this.showAddCodeCountrySelector = false
    this.addCodeCountryOptions = []
    this.addCodeForm.specificCountry = ''
  }
}
```

### 4. 界面组件（processing.vue）

#### 一键清洗对话框
```vue
<el-form-item label="选择国家">
  <el-select
    v-model="cleanDataForm.countryCode"
    placeholder="请选择国家"
    filterable
    clearable
    style="width: 100%"
    @change="handleCleanDataCountryChange"
  >
    <!-- 国家选项 -->
  </el-select>
</el-form-item>

<!-- 共用国码选择器（如 +1） -->
<el-form-item v-if="showCleanDataCountrySelector" label="具体国家">
  <el-select v-model="cleanDataForm.specificCountry" placeholder="请选择具体国家" style="width: 100%">
    <el-option
      v-for="country in cleanDataCountryOptions"
      :key="country.code"
      :label="country.name"
      :value="country.code"
    >
      <span>{{ country.name }} ({{ country.nameEn }})</span>
    </el-option>
  </el-select>
  <div style="margin-top: 5px; color: #909399; font-size: 12px">
    {{ cleanDataForm.countryCode }} 有多个国家共用，请选择具体国家
  </div>
</el-form-item>
```

#### 增加国码对话框
```vue
<el-form-item label="选择国家">
  <el-select
    v-model="addCodeForm.countryCode"
    placeholder="请选择国家"
    filterable
    style="width: 100%"
    @change="handleAddCodeCountryChange"
  >
    <!-- 国家选项 -->
  </el-select>
</el-form-item>

<!-- 共用国码选择器（如 +1） -->
<el-form-item v-if="showAddCodeCountrySelector" label="具体国家">
  <el-select v-model="addCodeForm.specificCountry" placeholder="请选择具体国家" style="width: 100%">
    <el-option
      v-for="country in addCodeCountryOptions"
      :key="country.code"
      :label="country.name"
      :value="country.code"
    >
      <span>{{ country.name }} ({{ country.nameEn }})</span>
    </el-option>
  </el-select>
  <div style="margin-top: 5px; color: #909399; font-size: 12px">
    {{ addCodeForm.countryCode }} 有多个国家共用，请选择具体国家
  </div>
</el-form-item>
```

## 📊 共用国码列表

目前系统中存在以下共用国码：

| 国码 | 共用国家 | 默认国家 |
|------|---------|---------|
| +1   | 美国、加拿大、多米尼加 | 美国 (US) |
| +7   | 俄罗斯、哈萨克斯坦 | 俄罗斯 (RU) |

## 🔄 用户操作流程

### 一键清洗功能
1. 用户点击"一键清洗"
2. 在"选择国家"下拉框中选择 **+1**
3. 系统自动显示"具体国家"二级选择器
4. 默认选中"美国"，用户可以切换为"加拿大"或"多米尼加"
5. 提示文字显示："+1 有多个国家共用，请选择具体国家"
6. 继续后续清洗操作

### 增加国码功能
1. 用户点击"增加国码"
2. 在"选择国家"下拉框中选择 **+1**
3. 系统自动显示"具体国家"二级选择器
4. 默认选中"美国"，用户可以切换为"加拿大"或"多米尼加"
5. 提示文字显示："+1 有多个国家共用，请选择具体国家"
6. 继续后续处理操作

## ✨ 特性说明

### 1. 自动检测
- 当选择的国码是共用国码时，自动显示二级选择器
- 当选择的国码是独占国码时，自动隐藏二级选择器

### 2. 默认值设置
- +1 默认选中"美国"（US）
- +7 默认选中"俄罗斯"（RU）
- 其他共用国码默认选中列表中的第一个国家

### 3. 用户友好
- 显示国家中英文名称，方便识别
- 提示文字说明当前国码为共用国码
- 可以随时切换具体国家

### 4. 扩展性
- 新增共用国码只需在 `getDefaultCountryForDialCode` 中添加映射
- 自动适配所有使用国码选择的功能模块

## 🎨 界面效果

### 选择独占国码（如 +52 墨西哥）
```
┌─────────────────────────────────┐
│ 选择国家                         │
│ ┌─────────────────────────────┐ │
│ │ 墨西哥 (+52)          ▼    │ │
│ └─────────────────────────────┘ │
│ 智能校验：检查数据前2位...      │
└─────────────────────────────────┘
```

### 选择共用国码（如 +1）
```
┌─────────────────────────────────┐
│ 选择国家                         │
│ ┌─────────────────────────────┐ │
│ │ +1                    ▼    │ │
│ └─────────────────────────────┘ │
│ 智能校验：检查数据前2位...      │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│ 具体国家                         │
│ ┌─────────────────────────────┐ │
│ │ 美国 (United States)  ▼    │ │
│ └─────────────────────────────┘ │
│ ├─ 美国 (United States)        │
│ ├─ 加拿大 (Canada)             │
│ └─ 多米尼加 (Dominican Republic)│
│ +1 有多个国家共用，请选择具体国家│
└─────────────────────────────────┘
```

## 🔍 技术要点

1. **动态显示/隐藏**
   - 使用 `v-if` 指令根据 `showCleanDataCountrySelector` 控制二级选择器显示

2. **数据联动**
   - 国家选择器绑定 `@change` 事件
   - 变化时调用对应的处理方法
   - 自动更新二级选择器的选项列表和默认值

3. **默认值设置**
   - 使用映射表定义每个共用国码的默认国家
   - 在检测到共用国码时自动设置 `specificCountry` 字段

4. **用户体验**
   - 自动设置默认值，减少用户操作
   - 提供清晰的提示文字
   - 显示中英文国家名称，方便识别

## 📝 注意事项

1. **后续开发**
   - 如果后续需要在后端使用 `specificCountry` 字段，需要相应修改 API 接口
   - 当前主要用于前端展示，实际处理仍使用 `countryCode`（国际电话区号）

2. **扩展共用国码**
   - 在 `getDefaultCountryForDialCode` 中添加新的映射关系即可
   - 例如：`'+44': 'GB'` （英国及其海外领地）

3. **兼容性**
   - 当国码不是共用国码时，二级选择器自动隐藏
   - 不影响现有功能的正常使用

## ✅ 测试清单

- [ ] 选择 +1 时，二级选择器自动显示
- [ ] 默认选中"美国"
- [ ] 可以手动切换为"加拿大"
- [ ] 可以手动切换为"多米尼加"
- [ ] 选择其他国码时，二级选择器自动隐藏
- [ ] 一键清洗功能正常工作
- [ ] 增加国码功能正常工作
- [ ] 清除国家选择时，二级选择器自动隐藏

## 🎯 后续优化建议

1. **后端支持**
   - 如果需要区分具体国家（如美国、加拿大），需要修改后端 API
   - 传递 `specificCountry` 字段到后端
   - 根据具体国家进行不同的数据处理

2. **更多共用国码**
   - 完善其他共用国码的处理（如 +44 英国系列）
   - 添加更详细的国家区分逻辑

3. **智能推荐**
   - 根据上传的数据特征自动推荐可能的国家
   - 例如分析号码前缀，自动选择最可能的国家

---

**创建时间：** 2025年10月15日
**版本：** 1.0.0
**作者：** Qoder AI Assistant
