# çŸ­ä¿¡ç»“ç®—åŠŸèƒ½é‡æ„æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚åˆ†æ

### åŸæœ‰ç»“ç®—ç³»ç»Ÿ
- æŒ‰å®¢æˆ·ã€é€šé“ã€å›½å®¶ç»´åº¦ç»“ç®—
- æŒ‰æ—¥ç»“ç®—

### æ–°ç»“ç®—ç³»ç»Ÿ
éœ€è¦åˆ†ä¸ºä¸¤å¤§ç»“ç®—æ¨¡å—ï¼š

#### 1ï¸âƒ£ ä»£ç†ç»“ç®—
- **ç»“ç®—å¯¹è±¡**ï¼šä»£ç†ï¼ˆAgentï¼‰
- **ç»“ç®—å†…å®¹**ï¼šä»£ç†ä¸‹æ‰€æœ‰å®¢æˆ·çš„çŸ­ä¿¡å‘é€ä¸šç»©ã€æˆæœ¬ã€åˆ©æ¶¦
- **è®¡è´¹æ–¹å¼**ï¼šæŒ‰æäº¤è®¡è´¹ï¼ˆå³æŒ‰å‘é€è¯·æ±‚æ•°è®¡è´¹ï¼Œä¸è®ºæˆåŠŸå¤±è´¥ï¼‰
- **ç»“ç®—å‘¨æœŸ**ï¼šæŒ‰æœˆç»“ç®—

#### 2ï¸âƒ£ é€šé“ç»“ç®—
- **ç»“ç®—å¯¹è±¡**ï¼šé€šé“ï¼ˆChannelï¼‰
- **ç»“ç®—å†…å®¹**ï¼šæ¯ä¸ªé€šé“å‘é€çŸ­ä¿¡äº§ç”Ÿçš„æˆæœ¬
- **è®¡è´¹æ–¹å¼**ï¼šæŒ‰æˆåŠŸè®¡è´¹ï¼ˆåªè®¡ç®—æˆåŠŸå‘é€çš„ï¼‰
- **ç»“ç®—å‘¨æœŸ**ï¼šæŒ‰æœˆç»“ç®—ï¼ˆä¸ä»£ç†ç»“ç®—åŒæ­¥ï¼‰

---

## ğŸ—ï¸ æ•°æ®åº“è®¾è®¡

### 1. ä»£ç†ç»“ç®—è¡¨ (sms_agent_settlements)

```sql
CREATE TABLE `sms_agent_settlements` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `settlement_month` VARCHAR(7) NOT NULL COMMENT 'ç»“ç®—æœˆä»½ YYYY-MM',
  `agent_id` INT(11) NOT NULL COMMENT 'ä»£ç†ID',
  
  -- æäº¤ç»Ÿè®¡ï¼ˆæŒ‰æäº¤è®¡è´¹ï¼‰
  `total_submitted` INT(11) NOT NULL DEFAULT 0 COMMENT 'æ€»æäº¤æ•°ï¼ˆå«æˆåŠŸå’Œå¤±è´¥ï¼‰',
  `total_success` INT(11) NOT NULL DEFAULT 0 COMMENT 'æˆåŠŸæ•°',
  `total_failed` INT(11) NOT NULL DEFAULT 0 COMMENT 'å¤±è´¥æ•°',
  `success_rate` DECIMAL(5,2) DEFAULT 0 COMMENT 'æˆåŠŸç‡ %',
  
  -- è´¢åŠ¡ç»Ÿè®¡
  `total_revenue` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT 'æ€»é”€å”®é¢ï¼ˆå®¢æˆ·æ”¯ä»˜ï¼‰',
  `total_cost` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT 'æ€»æˆæœ¬ï¼ˆé€šé“è´¹ç”¨ï¼‰',
  `total_profit` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT 'æ€»åˆ©æ¶¦',
  `profit_rate` DECIMAL(5,2) DEFAULT 0 COMMENT 'åˆ©æ¶¦ç‡ %',
  
  -- ä»£ç†ä½£é‡‘
  `agent_commission_rate` DECIMAL(5,2) DEFAULT 0 COMMENT 'ä»£ç†ä½£é‡‘æ¯”ä¾‹ %',
  `agent_commission` DECIMAL(15,4) DEFAULT 0 COMMENT 'ä»£ç†ä½£é‡‘é‡‘é¢',
  
  -- å®¢æˆ·ç»Ÿè®¡
  `customer_count` INT(11) DEFAULT 0 COMMENT 'æ´»è·ƒå®¢æˆ·æ•°',
  
  -- ç»“ç®—çŠ¶æ€
  `settlement_status` ENUM('pending','processing','completed','paid','cancelled') DEFAULT 'pending' COMMENT 'ç»“ç®—çŠ¶æ€',
  `settlement_date` DATE COMMENT 'ç»“ç®—æ—¥æœŸ',
  `payment_date` DATE COMMENT 'æ”¯ä»˜æ—¥æœŸ',
  
  -- æ—¶é—´æˆ³
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_agent_month` (`agent_id`, `settlement_month`),
  KEY `idx_settlement_month` (`settlement_month`),
  KEY `idx_agent_id` (`agent_id`),
  KEY `idx_status` (`settlement_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä»£ç†æœˆåº¦ç»“ç®—è¡¨';
```

### 2. ä»£ç†ç»“ç®—æ˜ç»†è¡¨ (sms_agent_settlement_details)

```sql
CREATE TABLE `sms_agent_settlement_details` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `settlement_id` INT(11) NOT NULL COMMENT 'ä»£ç†ç»“ç®—ID',
  `customer_id` INT(11) NOT NULL COMMENT 'å®¢æˆ·ID',
  `customer_name` VARCHAR(100) COMMENT 'å®¢æˆ·åç§°',
  
  -- æäº¤ç»Ÿè®¡
  `submitted_count` INT(11) NOT NULL DEFAULT 0 COMMENT 'æäº¤æ•°',
  `success_count` INT(11) NOT NULL DEFAULT 0 COMMENT 'æˆåŠŸæ•°',
  `failed_count` INT(11) NOT NULL DEFAULT 0 COMMENT 'å¤±è´¥æ•°',
  
  -- è´¢åŠ¡æ•°æ®
  `revenue` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT 'é”€å”®é¢',
  `cost` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT 'æˆæœ¬',
  `profit` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT 'åˆ©æ¶¦',
  
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_settlement_id` (`settlement_id`),
  KEY `idx_customer_id` (`customer_id`),
  CONSTRAINT `fk_agent_settlement_details` 
    FOREIGN KEY (`settlement_id`) REFERENCES `sms_agent_settlements`(`id`) 
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä»£ç†ç»“ç®—æ˜ç»†è¡¨';
```

### 3. é€šé“ç»“ç®—è¡¨ (sms_channel_settlements)

```sql
CREATE TABLE `sms_channel_settlements` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `settlement_month` VARCHAR(7) NOT NULL COMMENT 'ç»“ç®—æœˆä»½ YYYY-MM',
  `channel_id` INT(11) NOT NULL COMMENT 'é€šé“ID',
  `country` VARCHAR(50) COMMENT 'å›½å®¶ï¼ˆå¯é€‰ï¼ŒæŒ‰å›½å®¶ç»†åˆ†ï¼‰',
  
  -- å‘é€ç»Ÿè®¡ï¼ˆåªç»Ÿè®¡æˆåŠŸçš„ï¼‰
  `total_success` INT(11) NOT NULL DEFAULT 0 COMMENT 'æˆåŠŸå‘é€æ•°',
  `total_submitted` INT(11) NOT NULL DEFAULT 0 COMMENT 'æ€»æäº¤æ•°',
  `success_rate` DECIMAL(5,2) DEFAULT 0 COMMENT 'æˆåŠŸç‡ %',
  
  -- æˆæœ¬ç»Ÿè®¡
  `total_cost` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT 'æ€»æˆæœ¬',
  `avg_cost_price` DECIMAL(10,4) DEFAULT 0 COMMENT 'å¹³å‡æˆæœ¬å•ä»·',
  
  -- ç»“ç®—çŠ¶æ€
  `settlement_status` ENUM('pending','processing','completed','paid','cancelled') DEFAULT 'pending' COMMENT 'ç»“ç®—çŠ¶æ€',
  `settlement_date` DATE COMMENT 'ç»“ç®—æ—¥æœŸ',
  `payment_date` DATE COMMENT 'æ”¯ä»˜æ—¥æœŸ',
  
  -- æ—¶é—´æˆ³
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_channel_month_country` (`channel_id`, `settlement_month`, `country`),
  KEY `idx_settlement_month` (`settlement_month`),
  KEY `idx_channel_id` (`channel_id`),
  KEY `idx_country` (`country`),
  KEY `idx_status` (`settlement_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€šé“æœˆåº¦ç»“ç®—è¡¨';
```

### 4. é€šé“ç»“ç®—æ˜ç»†è¡¨ (sms_channel_settlement_details)

```sql
CREATE TABLE `sms_channel_settlement_details` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `settlement_id` INT(11) NOT NULL COMMENT 'é€šé“ç»“ç®—ID',
  `record_id` INT(11) NOT NULL COMMENT 'å‘é€è®°å½•ID',
  `phone_number` VARCHAR(20) COMMENT 'æ‰‹æœºå·',
  `cost_price` DECIMAL(10,4) DEFAULT 0 COMMENT 'æˆæœ¬ä»·',
  `sent_at` DATETIME COMMENT 'å‘é€æ—¶é—´',
  
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_settlement_id` (`settlement_id`),
  KEY `idx_record_id` (`record_id`),
  CONSTRAINT `fk_channel_settlement_details` 
    FOREIGN KEY (`settlement_id`) REFERENCES `sms_channel_settlements`(`id`) 
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€šé“ç»“ç®—æ˜ç»†è¡¨';
```

---

## ğŸ“Š æ ¸å¿ƒä¸šåŠ¡é€»è¾‘

### ä»£ç†ç»“ç®—é€»è¾‘

```javascript
/**
 * ä»£ç†æœˆåº¦ç»“ç®—æµç¨‹
 * 1. è·å–æŒ‡å®šæœˆä»½è¯¥ä»£ç†ä¸‹æ‰€æœ‰å®¢æˆ·çš„çŸ­ä¿¡è®°å½•
 * 2. æŒ‰æäº¤è®¡è´¹ï¼šç»Ÿè®¡æ‰€æœ‰statusçš„è®°å½•ï¼ˆpending, sending, success, failedï¼‰
 * 3. è®¡ç®—æ€»é”€å”®é¢ã€æ€»æˆæœ¬ã€æ€»åˆ©æ¶¦
 * 4. æ ¹æ®ä»£ç†ä½£é‡‘æ¯”ä¾‹è®¡ç®—ä½£é‡‘
 * 5. ç»Ÿè®¡æ´»è·ƒå®¢æˆ·æ•°
 * 6. ç”Ÿæˆç»“ç®—è®°å½•å’Œæ˜ç»†
 */
async function settleAgentMonthly(agentId, settlementMonth) {
  // settlementMonth æ ¼å¼: '2025-10'
  
  // 1. è·å–ä»£ç†ä¿¡æ¯
  const agent = await Agent.findByPk(agentId);
  
  // 2. è·å–ä»£ç†ä¸‹æ‰€æœ‰å®¢æˆ·
  const customers = await User.findAll({
    where: { agent_id: agentId, status: 1 }
  });
  
  const customerIds = customers.map(c => c.id);
  
  // 3. è·å–æœˆåº¦æ‰€æœ‰å‘é€è®°å½•ï¼ˆæŒ‰æäº¤è®¡è´¹ï¼ŒåŒ…å«æ‰€æœ‰çŠ¶æ€ï¼‰
  const records = await SmsRecord.findAll({
    where: {
      customer_id: { [Op.in]: customerIds },
      created_at: {
        [Op.between]: [
          `${settlementMonth}-01 00:00:00`,
          moment(settlementMonth).endOf('month').format('YYYY-MM-DD 23:59:59')
        ]
      }
    }
  });
  
  // 4. ç»Ÿè®¡æ±‡æ€»
  const totalSubmitted = records.length; // æ€»æäº¤æ•°
  const totalSuccess = records.filter(r => r.status === 'success').length;
  const totalFailed = records.filter(r => r.status === 'failed').length;
  
  // è´¢åŠ¡è®¡ç®—ï¼ˆæŒ‰æäº¤è®¡è´¹ï¼Œæ‰€æœ‰è®°å½•éƒ½è®¡è´¹ï¼‰
  const totalRevenue = records.reduce((sum, r) => sum + parseFloat(r.sale_price || 0), 0);
  const totalCost = records.reduce((sum, r) => sum + parseFloat(r.cost_price || 0), 0);
  const totalProfit = totalRevenue - totalCost;
  
  // ä»£ç†ä½£é‡‘
  const agentCommission = totalProfit * (agent.commission / 100);
  
  // 5. æŒ‰å®¢æˆ·åˆ†ç»„ç»Ÿè®¡ï¼ˆæ˜ç»†ï¼‰
  const detailsByCustomer = // ... åˆ†ç»„ç»Ÿè®¡é€»è¾‘
  
  // 6. åˆ›å»ºç»“ç®—è®°å½•
  const settlement = await SmsAgentSettlement.create({
    settlement_month: settlementMonth,
    agent_id: agentId,
    total_submitted: totalSubmitted,
    total_success: totalSuccess,
    total_failed: totalFailed,
    success_rate: (totalSuccess / totalSubmitted * 100).toFixed(2),
    total_revenue: totalRevenue,
    total_cost: totalCost,
    total_profit: totalProfit,
    profit_rate: (totalProfit / totalRevenue * 100).toFixed(2),
    agent_commission_rate: agent.commission,
    agent_commission: agentCommission,
    customer_count: customerIds.length,
    settlement_status: 'completed',
    settlement_date: new Date()
  });
  
  // 7. åˆ›å»ºæ˜ç»†è®°å½•
  await SmsAgentSettlementDetail.bulkCreate(detailsByCustomer);
  
  return settlement;
}
```

### é€šé“ç»“ç®—é€»è¾‘

```javascript
/**
 * é€šé“æœˆåº¦ç»“ç®—æµç¨‹
 * 1. è·å–æŒ‡å®šæœˆä»½è¯¥é€šé“çš„æ‰€æœ‰æˆåŠŸå‘é€è®°å½•
 * 2. æŒ‰å›½å®¶åˆ†ç»„ç»Ÿè®¡æˆæœ¬
 * 3. ç”Ÿæˆç»“ç®—è®°å½•
 */
async function settleChannelMonthly(channelId, settlementMonth, country = null) {
  // 1. è·å–é€šé“ä¿¡æ¯
  const channel = await SmsChannel.findByPk(channelId);
  
  // 2. æ„å»ºæŸ¥è¯¢æ¡ä»¶ï¼ˆåªç»Ÿè®¡æˆåŠŸçš„ï¼‰
  const where = {
    channel_id: channelId,
    status: 'success', // åªç»Ÿè®¡æˆåŠŸå‘é€çš„
    sent_at: {
      [Op.between]: [
        `${settlementMonth}-01 00:00:00`,
        moment(settlementMonth).endOf('month').format('YYYY-MM-DD 23:59:59')
      ]
    }
  };
  
  if (country) {
    where.country = country;
  }
  
  // 3. è·å–æˆåŠŸè®°å½•
  const successRecords = await SmsRecord.findAll({ where });
  
  // 4. ç»Ÿè®¡
  const totalSuccess = successRecords.length;
  const totalCost = successRecords.reduce((sum, r) => sum + parseFloat(r.cost_price || 0), 0);
  const avgCostPrice = totalSuccess > 0 ? totalCost / totalSuccess : 0;
  
  // è·å–æ€»æäº¤æ•°ï¼ˆç”¨äºè®¡ç®—æˆåŠŸç‡ï¼‰
  const totalSubmitted = await SmsRecord.count({
    where: {
      channel_id: channelId,
      sent_at: {
        [Op.between]: [
          `${settlementMonth}-01 00:00:00`,
          moment(settlementMonth).endOf('month').format('YYYY-MM-DD 23:59:59')
        ]
      }
    }
  });
  
  // 5. åˆ›å»ºç»“ç®—è®°å½•
  const settlement = await SmsChannelSettlement.create({
    settlement_month: settlementMonth,
    channel_id: channelId,
    country: country,
    total_success: totalSuccess,
    total_submitted: totalSubmitted,
    success_rate: (totalSuccess / totalSubmitted * 100).toFixed(2),
    total_cost: totalCost,
    avg_cost_price: avgCostPrice.toFixed(4),
    settlement_status: 'completed',
    settlement_date: new Date()
  });
  
  // 6. åˆ›å»ºæ˜ç»†è®°å½•
  const details = successRecords.map(r => ({
    settlement_id: settlement.id,
    record_id: r.id,
    phone_number: r.phone_number,
    cost_price: r.cost_price,
    sent_at: r.sent_at
  }));
  
  await SmsChannelSettlementDetail.bulkCreate(details);
  
  return settlement;
}
```

---

## ğŸ”„ ç»“ç®—å‘¨æœŸå¯¹æ¯”

| ç»´åº¦ | åŸç»“ç®—ç³»ç»Ÿ | ä»£ç†ç»“ç®— | é€šé“ç»“ç®— |
|------|-----------|---------|---------|
| ç»“ç®—å¯¹è±¡ | å®¢æˆ· | ä»£ç† | é€šé“ |
| ç»“ç®—å‘¨æœŸ | æŒ‰æ—¥ | æŒ‰æœˆ | æŒ‰æœˆ |
| è®¡è´¹æ–¹å¼ | æŒ‰æˆåŠŸ | æŒ‰æäº¤ | æŒ‰æˆåŠŸ |
| ç»Ÿè®¡ç»´åº¦ | å®¢æˆ·+é€šé“+å›½å®¶ | ä»£ç†ï¼ˆå«ä¸‹å±å®¢æˆ·ï¼‰ | é€šé“+å›½å®¶ |
| ä¸»è¦ç”¨é€” | å®¢æˆ·è´¦å• | ä»£ç†ä¸šç»©/ä½£é‡‘ | é€šé“æˆæœ¬æ ¸ç®— |

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### æ–°å¢æ¨¡å‹æ–‡ä»¶
```
/backend/models/
  â”œâ”€â”€ SmsAgentSettlement.js          # ä»£ç†ç»“ç®—æ¨¡å‹
  â”œâ”€â”€ SmsAgentSettlementDetail.js    # ä»£ç†ç»“ç®—æ˜ç»†æ¨¡å‹
  â”œâ”€â”€ SmsChannelSettlement.js        # é€šé“ç»“ç®—æ¨¡å‹
  â””â”€â”€ SmsChannelSettlementDetail.js  # é€šé“ç»“ç®—æ˜ç»†æ¨¡å‹
```

### æ–°å¢æœåŠ¡æ–‡ä»¶
```
/backend/services/
  â”œâ”€â”€ agentSettlementService.js      # ä»£ç†ç»“ç®—æœåŠ¡
  â””â”€â”€ channelSettlementService.js    # é€šé“ç»“ç®—æœåŠ¡
```

### æ–°å¢è·¯ç”±æ–‡ä»¶
```
/backend/routes/
  â”œâ”€â”€ agentSettlements.js            # ä»£ç†ç»“ç®—API
  â””â”€â”€ channelSettlements.js          # é€šé“ç»“ç®—API
```

### å‰ç«¯é¡µé¢
```
/src/views/sms/
  â”œâ”€â”€ agentSettlement/
  â”‚   â””â”€â”€ index.vue                  # ä»£ç†ç»“ç®—é¡µé¢
  â””â”€â”€ channelSettlement/
      â””â”€â”€ index.vue                  # é€šé“ç»“ç®—é¡µé¢
```

### APIæ¥å£
```
/src/api/
  â”œâ”€â”€ agentSettlement.js             # ä»£ç†ç»“ç®—API
  â””â”€â”€ channelSettlement.js           # é€šé“ç»“ç®—API
```

---

## ğŸ¯ APIæ¥å£è®¾è®¡

### ä»£ç†ç»“ç®—API

```
GET  /api/sms/agent-settlements                    # è·å–ä»£ç†ç»“ç®—åˆ—è¡¨
GET  /api/sms/agent-settlements/:id                # è·å–ä»£ç†ç»“ç®—è¯¦æƒ…
GET  /api/sms/agent-settlements/:id/details        # è·å–ä»£ç†ç»“ç®—æ˜ç»†
POST /api/sms/agent-settlements/calculate          # æ‰‹åŠ¨è§¦å‘ä»£ç†ç»“ç®—
GET  /api/sms/agent-settlements/statistics         # ä»£ç†ç»“ç®—ç»Ÿè®¡æ¦‚è§ˆ
POST /api/sms/agent-settlements/:id/pay            # æ ‡è®°ä¸ºå·²æ”¯ä»˜
GET  /api/sms/agent-settlements/export             # å¯¼å‡ºä»£ç†ç»“ç®—æ•°æ®
```

### é€šé“ç»“ç®—API

```
GET  /api/sms/channel-settlements                  # è·å–é€šé“ç»“ç®—åˆ—è¡¨
GET  /api/sms/channel-settlements/:id              # è·å–é€šé“ç»“ç®—è¯¦æƒ…
GET  /api/sms/channel-settlements/:id/details      # è·å–é€šé“ç»“ç®—æ˜ç»†
POST /api/sms/channel-settlements/calculate        # æ‰‹åŠ¨è§¦å‘é€šé“ç»“ç®—
GET  /api/sms/channel-settlements/statistics       # é€šé“ç»“ç®—ç»Ÿè®¡æ¦‚è§ˆ
GET  /api/sms/channel-settlements/export           # å¯¼å‡ºé€šé“ç»“ç®—æ•°æ®
```

---

## ğŸ”§ å®šæ—¶ä»»åŠ¡é…ç½®

```javascript
// æ¯æœˆ1å·å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç»“ç®—ä¸Šæœˆæ•°æ®
cron.schedule('0 2 1 * *', async () => {
  const lastMonth = moment().subtract(1, 'month').format('YYYY-MM');
  
  try {
    // 1. ä»£ç†ç»“ç®—
    logger.info(`å¼€å§‹ä»£ç†æœˆåº¦ç»“ç®—: ${lastMonth}`);
    const agentResult = await AgentSettlementService.autoSettleAllAgents(lastMonth);
    logger.info(`ä»£ç†ç»“ç®—å®Œæˆ: ${JSON.stringify(agentResult)}`);
    
    // 2. é€šé“ç»“ç®—
    logger.info(`å¼€å§‹é€šé“æœˆåº¦ç»“ç®—: ${lastMonth}`);
    const channelResult = await ChannelSettlementService.autoSettleAllChannels(lastMonth);
    logger.info(`é€šé“ç»“ç®—å®Œæˆ: ${JSON.stringify(channelResult)}`);
  } catch (error) {
    logger.error('æœˆåº¦è‡ªåŠ¨ç»“ç®—å¤±è´¥:', error);
  }
});
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### Phase 1: æ•°æ®åº“å‡†å¤‡
1. âœ… åˆ›å»ºæ–°çš„ç»“ç®—è¡¨ï¼ˆ4ä¸ªè¡¨ï¼‰
2. âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬

### Phase 2: åç«¯å¼€å‘
1. âœ… åˆ›å»ºæ•°æ®æ¨¡å‹ï¼ˆ4ä¸ªæ¨¡å‹ï¼‰
2. âœ… å¼€å‘ä»£ç†ç»“ç®—æœåŠ¡
3. âœ… å¼€å‘é€šé“ç»“ç®—æœåŠ¡
4. âœ… åˆ›å»ºAPIè·¯ç”±
5. âœ… é…ç½®å®šæ—¶ä»»åŠ¡

### Phase 3: å‰ç«¯å¼€å‘
1. âœ… ä»£ç†ç»“ç®—é¡µé¢
2. âœ… é€šé“ç»“ç®—é¡µé¢
3. âœ… APIæ¥å£å°è£…
4. âœ… èœå•é…ç½®

### Phase 4: æµ‹è¯•éªŒè¯
1. âœ… å•å…ƒæµ‹è¯•
2. âœ… é›†æˆæµ‹è¯•
3. âœ… æ•°æ®éªŒè¯

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. åŸæœ‰ç»“ç®—ç³»ç»Ÿå¤„ç†
- ä¿ç•™åŸæœ‰çš„`sms_settlements`è¡¨ä½œä¸ºå®¢æˆ·æ—¥ç»“ç®—ï¼ˆå¯é€‰ï¼‰
- æˆ–è€…åºŸå¼ƒåŸæœ‰ç»“ç®—ï¼Œç»Ÿä¸€ä½¿ç”¨æ–°çš„æœˆåº¦ç»“ç®—

### 2. è®¡è´¹æ–¹å¼å·®å¼‚
- **ä»£ç†ç»“ç®—**ï¼šæŒ‰æäº¤è®¡è´¹ï¼Œæ‰€æœ‰è®°å½•ï¼ˆæˆåŠŸ+å¤±è´¥ï¼‰éƒ½è®¡å…¥
- **é€šé“ç»“ç®—**ï¼šæŒ‰æˆåŠŸè®¡è´¹ï¼Œåªè®¡ç®—status='success'çš„è®°å½•

### 3. æ•°æ®ä¸€è‡´æ€§
- ç¡®ä¿sms_recordsè¡¨çš„cost_priceå’Œsale_priceå­—æ®µæ­£ç¡®å¡«å……
- ä»£ç†ä½£é‡‘æ¯”ä¾‹ä»agentsè¡¨çš„commissionå­—æ®µè·å–

### 4. æ€§èƒ½ä¼˜åŒ–
- æœˆåº¦ç»“ç®—æ•°æ®é‡å¤§ï¼Œä½¿ç”¨åˆ†æ‰¹å¤„ç†
- åˆ›å»ºå¿…è¦çš„æ•°æ®åº“ç´¢å¼•
- è€ƒè™‘ä½¿ç”¨é˜Ÿåˆ—å¼‚æ­¥å¤„ç†

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¼€å§‹å®æ–½ï¼š

```bash
# 1. åˆ›å»ºæ•°æ®åº“è¡¨
mysql -u vue_admin_user -p'vue_admin_2024' vue_admin < /home/vue-element-admin/database/migrations/2025-10-22_new_settlement_system.sql

# 2. é‡å¯åç«¯æœåŠ¡
pm2 restart vue-admin-server

# 3. æµ‹è¯•API
curl http://localhost:3000/api/sms/agent-settlements
curl http://localhost:3000/api/sms/channel-settlements
```

---

**è®¾è®¡æ—¶é—´**ï¼š2025-10-22  
**è®¾è®¡äººå‘˜**ï¼šç³»ç»Ÿæ¶æ„å¸ˆ  
**ç‰ˆæœ¬**ï¼šv2.0
