# 短信结算功能重构方案

## 📋 需求分析

### 原有结算系统
- 按客户、通道、国家维度结算
- 按日结算

### 新结算系统
需要分为两大结算模块：

#### 1️⃣ 代理结算
- **结算对象**：代理（Agent）
- **结算内容**：代理下所有客户的短信发送业绩、成本、利润
- **计费方式**：按提交计费（即按发送请求数计费，不论成功失败）
- **结算周期**：按月结算

#### 2️⃣ 通道结算
- **结算对象**：通道（Channel）
- **结算内容**：每个通道发送短信产生的成本
- **计费方式**：按成功计费（只计算成功发送的）
- **结算周期**：按月结算（与代理结算同步）

---

## 🏗️ 数据库设计

### 1. 代理结算表 (sms_agent_settlements)

```sql
CREATE TABLE `sms_agent_settlements` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `settlement_month` VARCHAR(7) NOT NULL COMMENT '结算月份 YYYY-MM',
  `agent_id` INT(11) NOT NULL COMMENT '代理ID',
  
  -- 提交统计（按提交计费）
  `total_submitted` INT(11) NOT NULL DEFAULT 0 COMMENT '总提交数（含成功和失败）',
  `total_success` INT(11) NOT NULL DEFAULT 0 COMMENT '成功数',
  `total_failed` INT(11) NOT NULL DEFAULT 0 COMMENT '失败数',
  `success_rate` DECIMAL(5,2) DEFAULT 0 COMMENT '成功率 %',
  
  -- 财务统计
  `total_revenue` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT '总销售额（客户支付）',
  `total_cost` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT '总成本（通道费用）',
  `total_profit` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT '总利润',
  `profit_rate` DECIMAL(5,2) DEFAULT 0 COMMENT '利润率 %',
  
  -- 代理佣金
  `agent_commission_rate` DECIMAL(5,2) DEFAULT 0 COMMENT '代理佣金比例 %',
  `agent_commission` DECIMAL(15,4) DEFAULT 0 COMMENT '代理佣金金额',
  
  -- 客户统计
  `customer_count` INT(11) DEFAULT 0 COMMENT '活跃客户数',
  
  -- 结算状态
  `settlement_status` ENUM('pending','processing','completed','paid','cancelled') DEFAULT 'pending' COMMENT '结算状态',
  `settlement_date` DATE COMMENT '结算日期',
  `payment_date` DATE COMMENT '支付日期',
  
  -- 时间戳
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_agent_month` (`agent_id`, `settlement_month`),
  KEY `idx_settlement_month` (`settlement_month`),
  KEY `idx_agent_id` (`agent_id`),
  KEY `idx_status` (`settlement_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='代理月度结算表';
```

### 2. 代理结算明细表 (sms_agent_settlement_details)

```sql
CREATE TABLE `sms_agent_settlement_details` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `settlement_id` INT(11) NOT NULL COMMENT '代理结算ID',
  `customer_id` INT(11) NOT NULL COMMENT '客户ID',
  `customer_name` VARCHAR(100) COMMENT '客户名称',
  
  -- 提交统计
  `submitted_count` INT(11) NOT NULL DEFAULT 0 COMMENT '提交数',
  `success_count` INT(11) NOT NULL DEFAULT 0 COMMENT '成功数',
  `failed_count` INT(11) NOT NULL DEFAULT 0 COMMENT '失败数',
  
  -- 财务数据
  `revenue` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT '销售额',
  `cost` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT '成本',
  `profit` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT '利润',
  
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_settlement_id` (`settlement_id`),
  KEY `idx_customer_id` (`customer_id`),
  CONSTRAINT `fk_agent_settlement_details` 
    FOREIGN KEY (`settlement_id`) REFERENCES `sms_agent_settlements`(`id`) 
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='代理结算明细表';
```

### 3. 通道结算表 (sms_channel_settlements)

```sql
CREATE TABLE `sms_channel_settlements` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `settlement_month` VARCHAR(7) NOT NULL COMMENT '结算月份 YYYY-MM',
  `channel_id` INT(11) NOT NULL COMMENT '通道ID',
  `country` VARCHAR(50) COMMENT '国家（可选，按国家细分）',
  
  -- 发送统计（只统计成功的）
  `total_success` INT(11) NOT NULL DEFAULT 0 COMMENT '成功发送数',
  `total_submitted` INT(11) NOT NULL DEFAULT 0 COMMENT '总提交数',
  `success_rate` DECIMAL(5,2) DEFAULT 0 COMMENT '成功率 %',
  
  -- 成本统计
  `total_cost` DECIMAL(15,4) NOT NULL DEFAULT 0 COMMENT '总成本',
  `avg_cost_price` DECIMAL(10,4) DEFAULT 0 COMMENT '平均成本单价',
  
  -- 结算状态
  `settlement_status` ENUM('pending','processing','completed','paid','cancelled') DEFAULT 'pending' COMMENT '结算状态',
  `settlement_date` DATE COMMENT '结算日期',
  `payment_date` DATE COMMENT '支付日期',
  
  -- 时间戳
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_channel_month_country` (`channel_id`, `settlement_month`, `country`),
  KEY `idx_settlement_month` (`settlement_month`),
  KEY `idx_channel_id` (`channel_id`),
  KEY `idx_country` (`country`),
  KEY `idx_status` (`settlement_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通道月度结算表';
```

### 4. 通道结算明细表 (sms_channel_settlement_details)

```sql
CREATE TABLE `sms_channel_settlement_details` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `settlement_id` INT(11) NOT NULL COMMENT '通道结算ID',
  `record_id` INT(11) NOT NULL COMMENT '发送记录ID',
  `phone_number` VARCHAR(20) COMMENT '手机号',
  `cost_price` DECIMAL(10,4) DEFAULT 0 COMMENT '成本价',
  `sent_at` DATETIME COMMENT '发送时间',
  
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `idx_settlement_id` (`settlement_id`),
  KEY `idx_record_id` (`record_id`),
  CONSTRAINT `fk_channel_settlement_details` 
    FOREIGN KEY (`settlement_id`) REFERENCES `sms_channel_settlements`(`id`) 
    ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通道结算明细表';
```

---

## 📊 核心业务逻辑

### 代理结算逻辑

```javascript
/**
 * 代理月度结算流程
 * 1. 获取指定月份该代理下所有客户的短信记录
 * 2. 按提交计费：统计所有status的记录（pending, sending, success, failed）
 * 3. 计算总销售额、总成本、总利润
 * 4. 根据代理佣金比例计算佣金
 * 5. 统计活跃客户数
 * 6. 生成结算记录和明细
 */
async function settleAgentMonthly(agentId, settlementMonth) {
  // settlementMonth 格式: '2025-10'
  
  // 1. 获取代理信息
  const agent = await Agent.findByPk(agentId);
  
  // 2. 获取代理下所有客户
  const customers = await User.findAll({
    where: { agent_id: agentId, status: 1 }
  });
  
  const customerIds = customers.map(c => c.id);
  
  // 3. 获取月度所有发送记录（按提交计费，包含所有状态）
  const records = await SmsRecord.findAll({
    where: {
      customer_id: { [Op.in]: customerIds },
      created_at: {
        [Op.between]: [
          `${settlementMonth}-01 00:00:00`,
          moment(settlementMonth).endOf('month').format('YYYY-MM-DD 23:59:59')
        ]
      }
    }
  });
  
  // 4. 统计汇总
  const totalSubmitted = records.length; // 总提交数
  const totalSuccess = records.filter(r => r.status === 'success').length;
  const totalFailed = records.filter(r => r.status === 'failed').length;
  
  // 财务计算（按提交计费，所有记录都计费）
  const totalRevenue = records.reduce((sum, r) => sum + parseFloat(r.sale_price || 0), 0);
  const totalCost = records.reduce((sum, r) => sum + parseFloat(r.cost_price || 0), 0);
  const totalProfit = totalRevenue - totalCost;
  
  // 代理佣金
  const agentCommission = totalProfit * (agent.commission / 100);
  
  // 5. 按客户分组统计（明细）
  const detailsByCustomer = // ... 分组统计逻辑
  
  // 6. 创建结算记录
  const settlement = await SmsAgentSettlement.create({
    settlement_month: settlementMonth,
    agent_id: agentId,
    total_submitted: totalSubmitted,
    total_success: totalSuccess,
    total_failed: totalFailed,
    success_rate: (totalSuccess / totalSubmitted * 100).toFixed(2),
    total_revenue: totalRevenue,
    total_cost: totalCost,
    total_profit: totalProfit,
    profit_rate: (totalProfit / totalRevenue * 100).toFixed(2),
    agent_commission_rate: agent.commission,
    agent_commission: agentCommission,
    customer_count: customerIds.length,
    settlement_status: 'completed',
    settlement_date: new Date()
  });
  
  // 7. 创建明细记录
  await SmsAgentSettlementDetail.bulkCreate(detailsByCustomer);
  
  return settlement;
}
```

### 通道结算逻辑

```javascript
/**
 * 通道月度结算流程
 * 1. 获取指定月份该通道的所有成功发送记录
 * 2. 按国家分组统计成本
 * 3. 生成结算记录
 */
async function settleChannelMonthly(channelId, settlementMonth, country = null) {
  // 1. 获取通道信息
  const channel = await SmsChannel.findByPk(channelId);
  
  // 2. 构建查询条件（只统计成功的）
  const where = {
    channel_id: channelId,
    status: 'success', // 只统计成功发送的
    sent_at: {
      [Op.between]: [
        `${settlementMonth}-01 00:00:00`,
        moment(settlementMonth).endOf('month').format('YYYY-MM-DD 23:59:59')
      ]
    }
  };
  
  if (country) {
    where.country = country;
  }
  
  // 3. 获取成功记录
  const successRecords = await SmsRecord.findAll({ where });
  
  // 4. 统计
  const totalSuccess = successRecords.length;
  const totalCost = successRecords.reduce((sum, r) => sum + parseFloat(r.cost_price || 0), 0);
  const avgCostPrice = totalSuccess > 0 ? totalCost / totalSuccess : 0;
  
  // 获取总提交数（用于计算成功率）
  const totalSubmitted = await SmsRecord.count({
    where: {
      channel_id: channelId,
      sent_at: {
        [Op.between]: [
          `${settlementMonth}-01 00:00:00`,
          moment(settlementMonth).endOf('month').format('YYYY-MM-DD 23:59:59')
        ]
      }
    }
  });
  
  // 5. 创建结算记录
  const settlement = await SmsChannelSettlement.create({
    settlement_month: settlementMonth,
    channel_id: channelId,
    country: country,
    total_success: totalSuccess,
    total_submitted: totalSubmitted,
    success_rate: (totalSuccess / totalSubmitted * 100).toFixed(2),
    total_cost: totalCost,
    avg_cost_price: avgCostPrice.toFixed(4),
    settlement_status: 'completed',
    settlement_date: new Date()
  });
  
  // 6. 创建明细记录
  const details = successRecords.map(r => ({
    settlement_id: settlement.id,
    record_id: r.id,
    phone_number: r.phone_number,
    cost_price: r.cost_price,
    sent_at: r.sent_at
  }));
  
  await SmsChannelSettlementDetail.bulkCreate(details);
  
  return settlement;
}
```

---

## 🔄 结算周期对比

| 维度 | 原结算系统 | 代理结算 | 通道结算 |
|------|-----------|---------|---------|
| 结算对象 | 客户 | 代理 | 通道 |
| 结算周期 | 按日 | 按月 | 按月 |
| 计费方式 | 按成功 | 按提交 | 按成功 |
| 统计维度 | 客户+通道+国家 | 代理（含下属客户） | 通道+国家 |
| 主要用途 | 客户账单 | 代理业绩/佣金 | 通道成本核算 |

---

## 📁 文件结构

### 新增模型文件
```
/backend/models/
  ├── SmsAgentSettlement.js          # 代理结算模型
  ├── SmsAgentSettlementDetail.js    # 代理结算明细模型
  ├── SmsChannelSettlement.js        # 通道结算模型
  └── SmsChannelSettlementDetail.js  # 通道结算明细模型
```

### 新增服务文件
```
/backend/services/
  ├── agentSettlementService.js      # 代理结算服务
  └── channelSettlementService.js    # 通道结算服务
```

### 新增路由文件
```
/backend/routes/
  ├── agentSettlements.js            # 代理结算API
  └── channelSettlements.js          # 通道结算API
```

### 前端页面
```
/src/views/sms/
  ├── agentSettlement/
  │   └── index.vue                  # 代理结算页面
  └── channelSettlement/
      └── index.vue                  # 通道结算页面
```

### API接口
```
/src/api/
  ├── agentSettlement.js             # 代理结算API
  └── channelSettlement.js           # 通道结算API
```

---

## 🎯 API接口设计

### 代理结算API

```
GET  /api/sms/agent-settlements                    # 获取代理结算列表
GET  /api/sms/agent-settlements/:id                # 获取代理结算详情
GET  /api/sms/agent-settlements/:id/details        # 获取代理结算明细
POST /api/sms/agent-settlements/calculate          # 手动触发代理结算
GET  /api/sms/agent-settlements/statistics         # 代理结算统计概览
POST /api/sms/agent-settlements/:id/pay            # 标记为已支付
GET  /api/sms/agent-settlements/export             # 导出代理结算数据
```

### 通道结算API

```
GET  /api/sms/channel-settlements                  # 获取通道结算列表
GET  /api/sms/channel-settlements/:id              # 获取通道结算详情
GET  /api/sms/channel-settlements/:id/details      # 获取通道结算明细
POST /api/sms/channel-settlements/calculate        # 手动触发通道结算
GET  /api/sms/channel-settlements/statistics       # 通道结算统计概览
GET  /api/sms/channel-settlements/export           # 导出通道结算数据
```

---

## 🔧 定时任务配置

```javascript
// 每月1号凌晨2点自动结算上月数据
cron.schedule('0 2 1 * *', async () => {
  const lastMonth = moment().subtract(1, 'month').format('YYYY-MM');
  
  try {
    // 1. 代理结算
    logger.info(`开始代理月度结算: ${lastMonth}`);
    const agentResult = await AgentSettlementService.autoSettleAllAgents(lastMonth);
    logger.info(`代理结算完成: ${JSON.stringify(agentResult)}`);
    
    // 2. 通道结算
    logger.info(`开始通道月度结算: ${lastMonth}`);
    const channelResult = await ChannelSettlementService.autoSettleAllChannels(lastMonth);
    logger.info(`通道结算完成: ${JSON.stringify(channelResult)}`);
  } catch (error) {
    logger.error('月度自动结算失败:', error);
  }
});
```

---

## 📝 实施步骤

### Phase 1: 数据库准备
1. ✅ 创建新的结算表（4个表）
2. ✅ 执行数据库迁移脚本

### Phase 2: 后端开发
1. ✅ 创建数据模型（4个模型）
2. ✅ 开发代理结算服务
3. ✅ 开发通道结算服务
4. ✅ 创建API路由
5. ✅ 配置定时任务

### Phase 3: 前端开发
1. ✅ 代理结算页面
2. ✅ 通道结算页面
3. ✅ API接口封装
4. ✅ 菜单配置

### Phase 4: 测试验证
1. ✅ 单元测试
2. ✅ 集成测试
3. ✅ 数据验证

---

## ⚠️ 注意事项

### 1. 原有结算系统处理
- 保留原有的`sms_settlements`表作为客户日结算（可选）
- 或者废弃原有结算，统一使用新的月度结算

### 2. 计费方式差异
- **代理结算**：按提交计费，所有记录（成功+失败）都计入
- **通道结算**：按成功计费，只计算status='success'的记录

### 3. 数据一致性
- 确保sms_records表的cost_price和sale_price字段正确填充
- 代理佣金比例从agents表的commission字段获取

### 4. 性能优化
- 月度结算数据量大，使用分批处理
- 创建必要的数据库索引
- 考虑使用队列异步处理

---

## 🚀 快速启动

执行以下命令开始实施：

```bash
# 1. 创建数据库表
mysql -u vue_admin_user -p'vue_admin_2024' vue_admin < /home/vue-element-admin/database/migrations/2025-10-22_new_settlement_system.sql

# 2. 重启后端服务
pm2 restart vue-admin-server

# 3. 测试API
curl http://localhost:3000/api/sms/agent-settlements
curl http://localhost:3000/api/sms/channel-settlements
```

---

**设计时间**：2025-10-22  
**设计人员**：系统架构师  
**版本**：v2.0
