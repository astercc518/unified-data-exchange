# 客户数据处理功能说明文档

## 功能概述

本系统新增了客户自主数据处理功能，允许客户上传数据文件并进行多种数据处理操作。所有上传的文件会在服务器上临时存储1个月，超期自动删除。

---

## 功能列表

### 1. 文件上传
- **支持格式**: 仅支持 TXT 格式
- **文件大小**: 最大 100MB
- **存储期限**: 1个月后自动删除
- **上传位置**: 服务器 `backend/uploads/customer_data/`

### 2. 数据去重
- **功能说明**: 去除文件中的重复数据
- **输出**: 去重后的文件
- **统计信息**: 
  - 原始行数
  - 去重后行数
  - 重复行数

### 3. 增加国码
- **功能说明**: 为所有号码添加国家区号
- **参数**: 国码（如 +86, +1 等）
- **处理逻辑**: 
  - 先去除已有国码
  - 再添加新国码

### 4. 去除国码
- **功能说明**: 去除号码的国家区号
- **参数**: 
  - 指定国码: 只去除指定的国码
  - 留空: 去除所有国码（1-4位数字）

### 5. 数据对比
- **功能说明**: 对比两个文件，找出差异或共同点
- **对比模式**:
  - **差异模式**: 文件1中有但文件2中没有的数据
  - **共有模式**: 两个文件都有的数据
  - **各自独有**: 两个文件各自独有的数据

### 6. 按运营商提取
- **功能说明**: 根据运营商号段提取特定运营商的数据
- **参数**:
  - 国家代码
  - 运营商名称
- **支持国家**: 70个国家，240+运营商
- **提取依据**: 号段前缀匹配

### 7. 按条数提取
- **功能说明**: 从文件中提取指定数量的数据
- **参数**:
  - 起始位置: 从第几行开始
  - 提取条数: 提取多少行

---

## 使用指南

### 访问路径
1. 登录系统（客户账号）
2. 点击菜单 **数据管理** > **数据处理**

### 上传文件

```
步骤1: 点击上传区域或拖拽文件到上传框
步骤2: 选择TXT格式文件（< 100MB）
步骤3: 系统自动验证并上传
步骤4: 上传成功后显示在文件列表中
```

**验证规则**:
- ✅ 文件大小 < 100MB
- ✅ 文件格式为 .txt
- ✅ 文件内容为有效的手机号数据（7-15位数字）

### 数据处理操作

#### 1. 数据去重

```
操作步骤:
1. 在文件列表中选择目标文件
2. 点击"数据处理" > "数据去重"
3. 确认操作
4. 等待处理完成
5. 自动下载处理后的文件
```

**示例**:
```
原始文件: 100,000行
去重后: 95,000行
重复: 5,000行
```

#### 2. 增加国码

```
操作步骤:
1. 选择文件 > 数据处理 > 增加国码
2. 输入国码（如: +86）
3. 确认处理
4. 下载结果文件
```

**示例**:
```
原始数据:
13800138000
13900139000

处理后:
+8613800138000
+8613900139000
```

#### 3. 去除国码

```
操作步骤:
1. 选择文件 > 数据处理 > 去除国码
2. 选填指定国码（留空则去除所有）
3. 确认处理
4. 下载结果
```

**示例**:
```
原始数据:
+8613800138000
+8613900139000

处理后:
13800138000
13900139000
```

#### 4. 数据对比

```
操作步骤:
1. 选择文件1 > 数据处理 > 数据对比
2. 选择要对比的文件2
3. 选择对比模式（差异/共有/各自独有）
4. 确认处理
5. 下载对比结果
```

**对比模式说明**:
- **差异**: A中有但B中没有
- **共有**: A和B都有
- **各自独有**: A独有+B独有

#### 5. 按运营商提取

```
操作步骤:
1. 选择文件 > 数据处理 > 按运营商提取
2. 选择国家（如: 中国 CN）
3. 选择运营商（如: 中国移动）
4. 确认处理
5. 下载提取结果
```

**支持的运营商示例**:
- 中国: 中国移动、中国联通、中国电信
- 美国: Verizon、AT&T、T-Mobile
- 印度: Jio、Airtel、Vi
- 更多...（共70个国家240+运营商）

#### 6. 按条数提取

```
操作步骤:
1. 选择文件 > 数据处理 > 按条数提取
2. 设置起始位置（默认0）
3. 设置提取条数（默认1000）
4. 确认处理
5. 下载提取结果
```

**示例**:
```
文件总行数: 100,000
起始位置: 0
提取条数: 5,000
结果: 提取第1-5000行数据
```

---

## 文件管理

### 文件列表信息
- 文件名
- 文件大小
- 行数
- 上传时间
- 过期时间（上传后30天）

### 文件删除
- **手动删除**: 点击删除按钮
- **自动删除**: 超过30天自动清理
- **删除范围**: 
  - 数据库记录标记为已删除
  - 物理文件从服务器删除

---

## 技术架构

### 后端

#### API接口

| 接口 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/api/data-processing/upload` | POST | 上传文件 | customer |
| `/api/data-processing/files` | GET | 获取文件列表 | customer/admin |
| `/api/data-processing/deduplicate` | POST | 数据去重 | customer/admin |
| `/api/data-processing/add-country-code` | POST | 增加国码 | customer/admin |
| `/api/data-processing/remove-country-code` | POST | 去除国码 | customer/admin |
| `/api/data-processing/compare` | POST | 数据对比 | customer/admin |
| `/api/data-processing/extract-by-operator` | POST | 按运营商提取 | customer/admin |
| `/api/data-processing/extract-by-count` | POST | 按条数提取 | customer/admin |
| `/api/data-processing/download/:filename` | GET | 下载处理后的文件 | customer/admin |
| `/api/data-processing/file/:id` | DELETE | 删除文件 | customer/admin |

#### 数据库表

```sql
customer_data_files
- id: 文件ID
- customer_id: 客户ID  
- customer_account: 客户账号
- original_filename: 原始文件名
- stored_filename: 存储文件名（UUID）
- file_path: 文件存储路径
- file_size: 文件大小（字节）
- line_count: 数据行数
- file_type: 文件类型
- upload_time: 上传时间戳
- expire_time: 过期时间戳
- status: 状态（1-有效 0-已删除）
- description: 文件描述
```

#### 定时任务

```javascript
// 每天凌晨2点执行
cron.schedule('0 2 * * *', cleanExpiredFiles)

清理逻辑:
1. 查找 expire_time < 当前时间 的文件
2. 删除物理文件
3. 更新数据库 status = 0
4. 记录清理日志
```

### 前端

#### 页面路径
`/data/processing`

#### 组件
- 文件上传组件（el-upload）
- 文件列表（el-table）
- 操作对话框（el-dialog）
- 下拉菜单（el-dropdown）

---

## 文件存储

### 目录结构

```
backend/
├── uploads/
│   ├── customer_data/          # 客户上传的原始文件
│   │   ├── uuid1.txt
│   │   ├── uuid2.txt
│   │   └── ...
│   └── processed_data/         # 处理后的文件
│       ├── dedup_uuid1.txt
│       ├── add_code_uuid2.txt
│       └── ...
```

### 文件命名规则

| 操作类型 | 文件名格式 | 示例 |
|---------|-----------|------|
| 原始文件 | `{uuid}.txt` | `a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6.txt` |
| 去重 | `dedup_{uuid}.txt` | `dedup_a1b2c3d4-xxx.txt` |
| 增加国码 | `add_code_{uuid}.txt` | `add_code_a1b2c3d4-xxx.txt` |
| 去除国码 | `remove_code_{uuid}.txt` | `remove_code_a1b2c3d4-xxx.txt` |
| 对比 | `compare_{mode}_{timestamp}.txt` | `compare_diff_1634567890.txt` |
| 运营商提取 | `operator_{name}_{timestamp}.txt` | `operator_移动_1634567890.txt` |
| 条数提取 | `extract_{count}_{timestamp}.txt` | `extract_5000_1634567890.txt` |

---

## 权限控制

### 客户（Customer）
- ✅ 上传文件
- ✅ 查看自己的文件
- ✅ 处理自己的文件
- ✅ 下载处理结果
- ✅ 删除自己的文件
- ❌ 查看其他客户的文件

### 管理员（Admin）
- ✅ 查看所有客户的文件
- ✅ 处理任意文件
- ✅ 下载任意文件
- ✅ 删除任意文件
- ✅ 查看文件统计

### 代理（Agent）
- ❌ 暂不支持数据处理功能

---

## 性能优化

### 文件读取优化
- 使用流式读取，避免一次性加载全部内容
- 逐行处理，减少内存占用
- 适用于大文件（>10MB）

### 处理速度
| 文件大小 | 处理时间 | 说明 |
|---------|---------|------|
| 1MB | < 1秒 | 小文件快速处理 |
| 10MB | < 5秒 | 中等文件 |
| 50MB | < 30秒 | 大文件 |
| 100MB | < 60秒 | 最大文件 |

---

## 错误处理

### 常见错误及解决方案

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| "只支持TXT格式文件" | 文件格式不正确 | 确保文件扩展名为.txt |
| "文件大小不能超过100MB" | 文件太大 | 分割文件或压缩数据 |
| "文件为空" | 文件无内容 | 检查文件是否有数据 |
| "数据格式不正确" | 非手机号数据 | 确保每行为7-15位数字 |
| "文件不存在" | 文件已删除或过期 | 重新上传文件 |
| "无权限操作此文件" | 非本人文件 | 只能操作自己上传的文件 |

---

## 测试案例

### 测试1: 文件上传
```
1. 准备一个包含10000行手机号的txt文件（大小约200KB）
2. 登录客户账号
3. 进入数据处理页面
4. 上传文件
5. 验证文件列表显示正确
```

**预期结果**:
- ✅ 上传成功
- ✅ 显示文件名、大小、行数
- ✅ 显示过期时间（30天后）

### 测试2: 数据去重
```
1. 准备包含重复数据的文件
原始数据（5行，3个唯一值）:
13800138000
13900139000
13800138000  # 重复
14000140000
13900139000  # 重复

2. 执行去重操作
3. 下载结果文件
```

**预期结果**:
```
处理后（3行）:
13800138000
13900139000
14000140000

统计:
- 原始行数: 5
- 去重后: 3
- 重复: 2
```

### 测试3: 运营商提取
```
1. 准备中国手机号文件（包含移动、联通、电信）
13800138000  # 移动
18500185000  # 联通  
18900189000  # 电信
13900139000  # 移动

2. 选择国家: 中国(CN)
3. 选择运营商: 中国移动
4. 执行提取
```

**预期结果**:
```
提取结果（2行）:
13800138000
13900139000

统计:
- 总数: 4
- 匹配: 2
```

---

## 监控与日志

### 操作日志
所有数据处理操作都会记录日志：

```
[2025-10-15 10:00:00] 客户 KL01880V01 上传数据文件: test.txt, 10000行
[2025-10-15 10:01:00] 数据去重完成: test.txt, 原始10000行, 去重后9500行
[2025-10-15 10:02:00] 增加国码完成: test.txt, 处理9500行, 国码+86
```

### 定时任务日志
```
[2025-10-15 02:00:00] [定时任务] 开始执行清理过期文件任务
[2025-10-15 02:00:10] [定时任务] 开始清理 15 个过期文件
[2025-10-15 02:00:15] [定时任务] 已删除过期文件: old_file1.txt
...
[2025-10-15 02:00:30] [定时任务] 清理完成: 成功15个, 失败0个
```

---

## 安全性

### 文件安全
- ✅ 文件名使用UUID，防止猜测
- ✅ 权限验证，只能访问自己的文件
- ✅ 文件类型验证，防止上传恶意文件
- ✅ 文件大小限制，防止占用过多空间

### 数据安全
- ✅ 客户数据隔离，互不可见
- ✅ 自动过期删除，防止数据泄露
- ✅ 所有操作需要认证
- ✅ 记录操作日志，可追溯

---

## 常见问题（FAQ）

**Q1: 文件最多能保存多久？**
A: 文件上传后保存30天，超期自动删除。

**Q2: 可以上传多大的文件？**
A: 最大支持100MB的TXT文件。

**Q3: 处理后的文件在哪里下载？**
A: 处理完成后会自动弹出下载窗口，或者在浏览器下载记录中查找。

**Q4: 能否恢复已删除的文件？**
A: 不能。文件删除后物理文件也会被删除，无法恢复。

**Q5: 上传的文件管理员能看到吗？**
A: 管理员可以查看所有文件，但普通客户只能看到自己的文件。

**Q6: 数据去重会保留哪一条？**
A: 保留第一次出现的数据，后续重复的会被去除。

**Q7: 支持哪些国家的运营商提取？**
A: 目前支持70个国家，240+运营商，包括中国、美国、印度、欧洲主要国家等。

---

## 更新日志

### v1.0.0 (2025-10-15)
- ✅ 初始版本发布
- ✅ 支持文件上传（TXT格式，<100MB）
- ✅ 支持数据去重
- ✅ 支持增加/去除国码
- ✅ 支持数据对比（3种模式）
- ✅ 支持按运营商提取（70国240+运营商）
- ✅ 支持按条数提取
- ✅ 定时任务自动清理过期文件（30天）
- ✅ 完整的权限控制和日志记录

---

## 技术支持

如有问题或建议，请联系系统管理员。

**文档版本**: v1.0.0  
**最后更新**: 2025-10-15
