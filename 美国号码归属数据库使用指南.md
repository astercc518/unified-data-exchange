# 美国号码归属数据库使用指南

## 📋 目录

1. [系统概述](#系统概述)
2. [数据库架构](#数据库架构)
3. [API接口](#api接口)
4. [数据导入](#数据导入)
5. [使用示例](#使用示例)
6. [维护更新](#维护更新)

---

## 系统概述

### 功能特性

✅ **精确查询**：通过NPA-NXX-XXXX号码分解，精确匹配运营商归属  
✅ **批量分析**：支持批量号码查询和运营商分布分析  
✅ **数据导入**：提供CSV导入和API导入两种方式  
✅ **更新日志**：完整记录每次数据更新的历史  
✅ **统计视图**：实时统计运营商覆盖范围和号码数量

### 适用场景

- 🔍 单号码查询：验证单个号码的运营商归属
- 📊 文件分析：分析TXT文件中所有号码的运营商分布
- 📈 批量提取：按运营商分类提取号码数据
- 🔄 数据同步：从FCC等数据源定期更新归属信息

---

## 数据库架构

### 核心表结构

#### 1. us_phone_carrier（号码归属表）

存储号码段到运营商的映射关系。

```sql
CREATE TABLE `us_phone_carrier` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `npa` CHAR(3) NOT NULL COMMENT '区号(Area Code)',
  `nxx` CHAR(3) NOT NULL COMMENT '前缀(Exchange)',
  `start_range` CHAR(4) NOT NULL COMMENT '起始号段',
  `end_range` CHAR(4) NOT NULL COMMENT '结束号段',
  `carrier_name` VARCHAR(100) NOT NULL COMMENT '运营商名称',
  `carrier_type` VARCHAR(50) COMMENT '运营商类型',
  `state` VARCHAR(50) COMMENT '州名',
  `city` VARCHAR(100) COMMENT '城市',
  `last_update` BIGINT NOT NULL COMMENT '最后更新时间戳',
  `data_source` VARCHAR(100) DEFAULT 'FCC' COMMENT '数据来源',
  
  UNIQUE KEY `uk_number_range` (`npa`, `nxx`, `start_range`, `end_range`),
  INDEX `idx_npa_nxx` (`npa`, `nxx`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**字段说明**：
- `npa`：北美编号计划区号（Area Code），如 `212`, `310`
- `nxx`：交换机前缀（Exchange），如 `200`, `555`
- `start_range` / `end_range`：后4位号码范围，如 `0000-9999`
- `carrier_name`：运营商名称，如 `Verizon Wireless`, `AT&T Mobility`
- `carrier_type`：类型（Wireless/Landline/VoIP）

**示例数据**：
```
| npa | nxx | start_range | end_range | carrier_name     | state      | city        |
|-----|-----|-------------|-----------|------------------|------------|-------------|
| 212 | 200 | 0000        | 9999      | Verizon Wireless | New York   | New York    |
| 212 | 201 | 0000        | 9999      | AT&T Mobility    | New York   | New York    |
| 310 | 200 | 0000        | 9999      | Verizon Wireless | California | Los Angeles |
```

#### 2. us_carriers（运营商主表）

存储运营商基本信息和市场统计。

```sql
CREATE TABLE `us_carriers` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `carrier_name` VARCHAR(100) NOT NULL UNIQUE,
  `carrier_code` VARCHAR(50) COMMENT '运营商代码',
  `market_share` DECIMAL(5,2) DEFAULT 0.00 COMMENT '市场份额(%)',
  `status` TINYINT DEFAULT 1 COMMENT '状态：0-停用，1-启用',
  -- 其他字段...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 3. us_carrier_update_log（更新日志表）

记录每次数据导入/更新的详细信息。

```sql
CREATE TABLE `us_carrier_update_log` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `update_type` VARCHAR(50) NOT NULL COMMENT '更新类型：full/incremental',
  `records_added` INT DEFAULT 0,
  `records_updated` INT DEFAULT 0,
  `status` VARCHAR(20) DEFAULT 'success',
  `start_time` BIGINT NOT NULL,
  `duration` INT COMMENT '耗时(秒)',
  -- 其他字段...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 数据库视图

#### v_us_carrier_stats（运营商统计视图）

实时统计每个运营商的覆盖情况。

```sql
CREATE VIEW `v_us_carrier_stats` AS
SELECT 
  c.carrier_name,
  c.carrier_type,
  c.market_share,
  COUNT(DISTINCT p.npa) AS area_codes_count,
  COUNT(*) AS number_ranges_count
FROM us_carriers c
LEFT JOIN us_phone_carrier p ON c.carrier_name = p.carrier_name
WHERE c.status = 1
GROUP BY c.id
ORDER BY c.market_share DESC;
```

### 存储过程

#### sp_get_phone_carrier（单号码查询）

输入完整号码，返回运营商信息。

```sql
CALL sp_get_phone_carrier('12122001234');
-- 返回: Verizon Wireless, New York, NY
```

---

## API接口

### 基础URL

```
http://localhost:3000/api/us-phone-carrier
```

### 认证

所有API接口需要JWT Token认证：

```bash
Authorization: Bearer <token>
```

### 接口列表

#### 1. 查询单个号码运营商

**请求**：
```http
POST /api/us-phone-carrier/query-single
Content-Type: application/json

{
  "phoneNumber": "12122001234"
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "phoneNumber": "12122001234",
    "carrierName": "Verizon Wireless",
    "carrierType": "Wireless",
    "state": "New York",
    "city": "New York",
    "ocn": null,
    "rateCenter": null
  }
}
```

#### 2. 批量查询号码运营商

**请求**：
```http
POST /api/us-phone-carrier/query-batch
Content-Type: application/json

{
  "phoneNumbers": [
    "12122001234",
    "13102005678",
    "13122009999"
  ]
}
```

**响应**：
```json
{
  "success": true,
  "data": [
    {
      "phoneNumber": "12122001234",
      "carrierName": "Verizon Wireless",
      "carrierType": "Wireless",
      "state": "New York",
      "city": "New York"
    },
    {
      "phoneNumber": "13102005678",
      "carrierName": "Verizon Wireless",
      "carrierType": "Wireless",
      "state": "California",
      "city": "Los Angeles"
    }
  ]
}
```

#### 3. 分析运营商分布

**请求**：
```http
POST /api/us-phone-carrier/analyze-distribution
Content-Type: application/json

{
  "phoneNumbers": [
    "12122001234",
    "12122011111",
    "13102002222",
    "13102013333"
  ]
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "totalCount": 4,
    "distribution": [
      {
        "name": "Verizon Wireless",
        "count": 4,
        "percentage": "100.00"
      }
    ],
    "unmatchedCount": 0,
    "unmatchedPercentage": "0.00"
  }
}
```

#### 4. 获取运营商列表

**请求**：
```http
GET /api/us-phone-carrier/carriers
```

**响应**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "carrier_name": "Verizon Wireless",
      "carrier_code": "VZW",
      "market_share": "35.00",
      "status": 1
    },
    {
      "id": 2,
      "carrier_name": "AT&T Mobility",
      "carrier_code": "ATT",
      "market_share": "32.00",
      "status": 1
    }
  ]
}
```

#### 5. 获取运营商统计

**请求**：
```http
GET /api/us-phone-carrier/carrier-stats
```

**响应**：
```json
{
  "success": true,
  "data": [
    {
      "carrier_name": "Verizon Wireless",
      "carrier_type": "Wireless",
      "market_share": "35.00",
      "area_codes_count": 9,
      "number_ranges_count": 12
    }
  ]
}
```

#### 6. 导入号码归属数据

**请求**：
```http
POST /api/us-phone-carrier/import-data
Content-Type: application/json

{
  "data": [
    {
      "npa": "415",
      "nxx": "555",
      "start_range": "0000",
      "end_range": "9999",
      "carrier_name": "AT&T Mobility",
      "carrier_type": "Wireless",
      "state": "California",
      "city": "San Francisco"
    }
  ],
  "dataSource": "FCC Update",
  "sourceFile": "fcc_data_2025.csv"
}
```

**响应**：
```json
{
  "success": true,
  "message": "数据导入成功",
  "data": {
    "addedCount": 1,
    "updatedCount": 0,
    "totalCount": 1,
    "duration": 2
  }
}
```

#### 7. 获取更新日志

**请求**：
```http
GET /api/us-phone-carrier/update-logs?page=1&pageSize=20
```

**响应**：
```json
{
  "success": true,
  "data": {
    "total": 5,
    "list": [
      {
        "id": 5,
        "update_type": "manual",
        "records_added": 100,
        "records_updated": 50,
        "status": "success",
        "start_time": 1760640000000,
        "duration": 30,
        "operator": "admin"
      }
    ],
    "page": 1,
    "pageSize": 20
  }
}
```

---

## 数据导入

### 方法一：CSV文件导入

#### 准备CSV文件

CSV格式要求（第一行为标题）：

```csv
NPA,NXX,StartRange,EndRange,CarrierName,CarrierType,State,City,OCN,LATA,RateCenter
212,200,0000,9999,Verizon Wireless,Wireless,New York,New York,,,
212,201,0000,9999,AT&T Mobility,Wireless,New York,New York,,,
310,200,0000,9999,Verizon Wireless,Wireless,California,Los Angeles,,,
```

**必填字段**：
- NPA（区号）
- NXX（前缀）
- CarrierName（运营商名称）

**可选字段**：
- StartRange / EndRange（默认 0000-9999）
- CarrierType, State, City, OCN, LATA, RateCenter

#### 执行导入

```bash
cd /home/vue-element-admin/backend
node scripts/importUSCarrierData.js import /path/to/data.csv
```

**输出示例**：
```
开始导入数据...
源文件: /path/to/data.csv
已处理 1000 条记录...
已处理 2000 条记录...

导入完成！
新增记录: 1850
更新记录: 150
错误记录: 0
耗时: 45秒
```

### 方法二：生成示例数据

用于测试或初始化：

```bash
cd /home/vue-element-admin/backend
node scripts/importUSCarrierData.js sample
```

这将生成覆盖美国10大城市的示例数据（200条记录）。

### 方法三：API导入

通过HTTP API导入数据（适合自动化更新）：

```bash
curl -X POST http://localhost:3000/api/us-phone-carrier/import-data \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "data": [
      {
        "npa": "415",
        "nxx": "555",
        "carrier_name": "T-Mobile USA",
        "carrier_type": "Wireless",
        "state": "California",
        "city": "San Francisco"
      }
    ],
    "dataSource": "API Import",
    "sourceFile": "api_update.json"
  }'
```

### 清空所有数据

⚠️ **危险操作**，仅在需要重新导入时使用：

```bash
cd /home/vue-element-admin/backend
node scripts/importUSCarrierData.js clear
```

---

## 使用示例

### 示例1：在数据处理中使用（前端）

当用户选择美国（国码1）进行运营商提取时，系统自动使用数据库查询：

```vue
<template>
  <el-select v-model="selectedCountry" @change="handleCountryChange">
    <el-option label="United States (+1)" value="1" />
    <el-option label="Bangladesh (+880)" value="880" />
  </el-select>
</template>

<script>
export default {
  methods: {
    async handleCountryChange(countryCode) {
      if (countryCode === '1') {
        // 美国号码：使用数据库查询
        const response = await this.$axios.post('/api/data-processing/analyze-operator-distribution', {
          fileId: this.currentFileId,
          countryCode: '1',
          operators: [] // 美国不需要预定义运营商
        });
        
        // 显示实际运营商分布
        this.operatorDistribution = response.data.distribution;
      } else {
        // 其他国家：使用号段匹配
        // ...
      }
    }
  }
}
</script>
```

### 示例2：后端集成

在 `dataProcessing.js` 路由中的实现：

```javascript
router.post('/analyze-operator-distribution', async (req, res) => {
  const { fileId, countryCode } = req.body;
  
  if (countryCode === '1') {
    // 美国：使用数据库查询
    const phoneNumbers = await readFileLines(file.file_path);
    
    const response = await axios.post(
      'http://localhost:3000/api/us-phone-carrier/analyze-distribution',
      { phoneNumbers }
    );
    
    return res.json({
      success: true,
      data: response.data.data
    });
  } else {
    // 其他国家：使用号段匹配
    const result = await DataProcessor.analyzeOperatorDistribution(
      file.file_path,
      { countryCode, operators }
    );
    
    return res.json({ success: true, data: result });
  }
});
```

### 示例3：直接查询

使用MySQL存储过程直接查询：

```sql
-- 查询单个号码
CALL sp_get_phone_carrier('12122001234');

-- 结果：
-- carrier_name: Verizon Wireless
-- carrier_type: Wireless
-- state: New York
-- city: New York
```

---

## 维护更新

### 定期更新数据

#### 从FCC获取最新数据

1. 访问 [FCC NANPA](https://www.nationalnanpa.com/) 下载最新号码分配数据
2. 转换为CSV格式（参考上述格式）
3. 执行导入命令

```bash
node scripts/importUSCarrierData.js import fcc_latest.csv
```

#### 增量更新

对于小批量更新，使用API导入：

```bash
curl -X POST http://localhost:3000/api/us-phone-carrier/import-data \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d @incremental_update.json
```

### 查看更新历史

通过API查看所有更新日志：

```bash
curl -X GET "http://localhost:3000/api/us-phone-carrier/update-logs?page=1&pageSize=50" \
  -H "Authorization: Bearer <token>"
```

或直接查询数据库：

```sql
SELECT 
  update_type,
  records_added,
  records_updated,
  status,
  FROM_UNIXTIME(start_time/1000) as update_time,
  duration,
  operator
FROM us_carrier_update_log
ORDER BY start_time DESC
LIMIT 20;
```

### 数据库维护

#### 索引优化

定期分析和优化索引：

```sql
ANALYZE TABLE us_phone_carrier;
OPTIMIZE TABLE us_phone_carrier;
```

#### 数据清理

删除过期或无效数据：

```sql
-- 删除超过1年未更新的数据
DELETE FROM us_phone_carrier
WHERE last_update < UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 YEAR)) * 1000;
```

#### 备份数据

定期备份数据库：

```bash
# 备份号码归属数据
mysqldump -u root vue_admin us_phone_carrier us_carriers us_carrier_update_log > us_carrier_backup_$(date +%Y%m%d).sql

# 恢复备份
mysql -u root vue_admin < us_carrier_backup_20251016.sql
```

---

## 当前数据状态

### 数据库统计

```sql
SELECT 
  COUNT(*) as total_records,
  COUNT(DISTINCT npa) as area_codes,
  COUNT(DISTINCT carrier_name) as carriers,
  COUNT(DISTINCT state) as states
FROM us_phone_carrier;
```

**当前数据**（2025-10-16）：
- 总记录数：36条
- 覆盖区号：9个（212, 310, 312, 415, 617, 202, 305, 404, 206）
- 运营商：5个（Verizon, AT&T, T-Mobile, Sprint, US Cellular）
- 覆盖州：7个

### 覆盖城市

| 区号 | 城市 | 州 | 运营商数 |
|------|------|-----|---------|
| 212 | New York | New York | 5 |
| 310 | Los Angeles | California | 5 |
| 312 | Chicago | Illinois | 5 |
| 415 | San Francisco | California | 3 |
| 617 | Boston | Massachusetts | 3 |
| 202 | Washington | D.C. | 3 |
| 305 | Miami | Florida | 3 |
| 404 | Atlanta | Georgia | 3 |
| 206 | Seattle | Washington | 3 |

---

## 故障排查

### 常见问题

#### 1. 查询返回空结果

**原因**：数据库中没有该号码段的归属信息

**解决**：
1. 检查号码格式是否正确（10位数字）
2. 查询该NPA-NXX是否存在于数据库
3. 从FCC数据源补充缺失的号段

```sql
-- 检查某个NPA-NXX是否存在
SELECT * FROM us_phone_carrier
WHERE npa = '415' AND nxx = '555';
```

#### 2. 导入数据失败

**错误**：`Duplicate entry 'xxx' for key 'uk_number_range'`

**原因**：尝试导入已存在的号段

**解决**：
- 使用 `ON DUPLICATE KEY UPDATE` 语句更新
- 或先删除旧数据再导入

#### 3. API超时

**原因**：批量查询号码过多

**解决**：
- 分批查询，每批不超过1000条
- 优化数据库索引
- 增加服务器超时时间

---

## 性能优化建议

### 数据库层面

1. **索引优化**：确保 `npa`, `nxx` 字段有复合索引
2. **分区表**：对于超大数据集（>1000万条），可考虑按NPA分区
3. **缓存**：使用Redis缓存热门号段查询结果

### 应用层面

1. **批量查询**：避免单条查询，使用批量API
2. **异步处理**：大文件分析使用后台任务队列
3. **结果缓存**：相同文件的分析结果缓存1小时

---

## 扩展计划

### 短期（1-3个月）

- [ ] 导入完整的FCC NANPA数据库（预计500万+记录）
- [ ] 添加号码归属API的Redis缓存层
- [ ] 实现定时自动更新任务（每月同步FCC数据）

### 中期（3-6个月）

- [ ] 支持加拿大号码归属查询（+1区号）
- [ ] 添加历史归属变更记录（号码转网tracking）
- [ ] 提供号码归属数据导出功能

### 长期（6-12个月）

- [ ] 集成全球主要国家号码归属数据库
- [ ] 机器学习预测号码运营商归属
- [ ] 提供SaaS API服务

---

## 技术支持

### 联系方式

- 📧 Email: support@example.com
- 📞 技术支持: +1-xxx-xxx-xxxx
- 💬 在线文档: http://docs.example.com

### 相关资源

- [FCC NANPA官网](https://www.nationalnanpa.com/)
- [北美编号计划](https://en.wikipedia.org/wiki/North_American_Numbering_Plan)
- [Sequelize文档](https://sequelize.org/)
- [Express.js文档](https://expressjs.com/)

---

*最后更新：2025-10-16*  
*版本：v1.0.0*
