# 数据发送功能 - 快速开始指南

## ✅ 已完成的工作

### 后端开发 (100%)

1. **✅ 数据模型创建**
   - [DeliveryConfig.js](file:///home/vue-element-admin/backend/models/DeliveryConfig.js) - 发货配置模型
   - [OrderData.js](file:///home/vue-element-admin/backend/models/OrderData.js) - 订单数据模型
   - [Order.js](file:///home/vue-element-admin/backend/models/Order.js) - 更新订单模型（添加发货字段）

2. **✅ 核心服务创建**
   - [deliveryService.js](file:///home/vue-element-admin/backend/services/deliveryService.js) - 发货服务
     - 邮箱发送功能
     - TGBot发送功能
     - TXT文件生成
     - 订单数据提取

3. **✅ API路由创建**
   - [delivery.js](file:///home/vue-element-admin/backend/routes/delivery.js) - 发货配置管理路由
   - [orders.js](file:///home/vue-element-admin/backend/routes/orders.js) - 订单发货路由（已更新）

4. **✅ 数据库配置更新**
   - [database.js](file:///home/vue-element-admin/backend/config/database.js) - 添加新模型
   - [server.js](file:///home/vue-element-admin/backend/server.js) - 注册新路由

5. **✅ NPM依赖安装**
   - nodemailer - 邮件发送
   - node-telegram-bot-api - TGBot集成

### 前端开发 (100%)

1. **✅ 配置管理页面**
   - [delivery-config.vue](file:///home/vue-element-admin/src/views/system/delivery-config.vue) - 发货配置管理

2. **✅ 发货功能更新**
   - [delivery.vue](file:///home/vue-element-admin/src/views/order/delivery.vue) - 客户发货页面（已更新为API调用）

3. **✅ 路由配置更新**
   - [index.js](file:///home/vue-element-admin/src/router/index.js) - 添加发货配置路由

---

## 🚀 快速启动

### 1. 后端服务器状态

**✅ 已启动并运行**
```
🚀 服务器启动成功
📍 服务地址: http://localhost:3000
📊 数据库模型同步完成
```

**新增API端点：**
- `/api/delivery/config/:type` - 发货配置管理
- `/api/orders/:id/customer-deliver` - 客户发货
- `/api/orders/verify-tgbot-order` - TGBot订单验证

### 2. 前端访问

**发货配置页面：**
```
http://localhost:9527/#/system/delivery-config
```

**菜单位置：**
```
系统管理 > 发货配置
```

---

## 📝 配置步骤

### 步骤1：配置邮箱发送（可选）

1. 登录管理后台
2. 进入"系统管理 > 发货配置"
3. 选择"邮箱发货配置"标签
4. 填写SMTP配置：
   ```
   SMTP服务器: smtp.qq.com (或其他邮箱服务器)
   端口: 587
   发件邮箱: your-email@qq.com
   密码: 授权码（非登录密码）
   发件人名称: 数据平台
   ```
5. 点击"测试发送"验证配置
6. 启用邮箱发货功能

**常用SMTP配置：**
- **QQ邮箱**: smtp.qq.com:587
- **163邮箱**: smtp.163.com:465
- **Gmail**: smtp.gmail.com:587

### 步骤2：配置TGBot发送（可选）

1. **创建TGBot**
   - 在Telegram中找到 @BotFather
   - 发送 `/newbot` 创建新Bot
   - 获取Bot Token

2. **配置系统**
   - 进入"系统管理 > 发货配置"
   - 选择"TGBot发货配置"标签
   - 填写Bot Token和Bot用户名
   - 点击"测试发送"验证（需要Chat ID）
   - 启用TGBot发货功能

---

## 💡 使用流程

### 管理员操作

1. **审核订单**
   - 客户提交订单后，订单状态为"待审核"
   - 代理/管理员审核订单
   - 审核通过后，订单状态变为"已完成-待发货"

2. **配置发货方式**
   - 至少配置一种发货方式（邮箱或TGBot）
   - 启用相应的发货功能

### 客户操作

#### 方式A：邮箱发货

1. 进入"订单管理 > 已完成订单"
2. 找到待发货订单，点击"发货"按钮
3. 选择"邮箱发货"
4. 输入接收邮箱地址
5. 点击"确认发货"
6. 等待系统发送（通常几秒内完成）
7. 查收邮件和附件

#### 方式B：TGBot发货（界面）

1. 进入"订单管理 > 已完成订单"
2. 找到待发货订单，点击"发货"按钮
3. 选择"TGBot发货"
4. 输入Chat ID（向Bot发送消息获取）
5. 点击"确认发货"
6. 在TGBot中接收文件

#### 方式C：TGBot自动验证（推荐）

1. 添加系统配置的TGBot
2. 向Bot发送订单号
3. Bot自动验证订单状态
4. 验证通过后自动发送数据文件

---

## 📊 系统功能清单

### 发货配置管理

- [x] 邮箱SMTP配置
- [x] TGBot Token配置
- [x] 配置测试功能
- [x] 启用/禁用开关
- [x] 配置保存和加载

### 订单发货功能

- [x] 客户自助发货
- [x] 邮箱发货
- [x] TGBot发货
- [x] 订单状态验证
- [x] 防重复发货
- [x] 数据文件生成
- [x] TGBot订单验证

### 安全控制

- [x] 权限验证（客户只能发货自己的订单）
- [x] 订单状态检查（必须是已完成-待发货）
- [x] 发货状态跟踪
- [x] 错误处理和提示

---

## 🗂️ 文件清单

### 后端文件 (8个)

```
backend/
├── models/
│   ├── DeliveryConfig.js       ✅ 新建
│   ├── OrderData.js            ✅ 新建
│   └── Order.js                ✅ 已更新
├── services/
│   └── deliveryService.js      ✅ 新建
├── routes/
│   ├── delivery.js             ✅ 新建
│   └── orders.js               ✅ 已更新
└── config/
    ├── database.js             ✅ 已更新
    └── server.js               ✅ 已更新
```

### 前端文件 (3个)

```
frontend/src/
├── views/
│   ├── system/
│   │   └── delivery-config.vue ✅ 新建
│   └── order/
│       └── delivery.vue        ✅ 已更新
└── router/
    └── index.js                ✅ 已更新
```

### 文档文件 (2个)

```
/home/vue-element-admin/
├── 数据发送功能说明.md          ✅ 详细文档
└── 数据发送功能-快速开始.md     ✅ 本文档
```

---

## 🔧 API接口

### 1. 获取发货配置
```http
GET /api/delivery/config/:type
Authorization: Bearer {token}

:type = email | tgbot
```

### 2. 更新发货配置
```http
PUT /api/delivery/config/:type
Authorization: Bearer {token}
Content-Type: application/json

{
  "config_data": {...},
  "status": 1,
  "remark": ""
}
```

### 3. 客户发货
```http
POST /api/orders/:id/customer-deliver
Authorization: Bearer {token}
Content-Type: application/json

{
  "delivery_method": "email",
  "delivery_address": "customer@example.com"
}
```

### 4. TGBot订单验证
```http
POST /api/orders/verify-tgbot-order
Content-Type: application/json

{
  "order_number": "ORD1234567890",
  "chat_id": "123456789"
}
```

---

## 📋 测试检查清单

### 配置测试

- [ ] 访问发货配置页面
- [ ] 保存邮箱配置
- [ ] 测试邮箱发送
- [ ] 保存TGBot配置
- [ ] 测试TGBot发送
- [ ] 切换启用/禁用状态

### 发货测试

- [ ] 创建测试订单
- [ ] 审核通过订单
- [ ] 查看已完成订单列表
- [ ] 点击发货按钮
- [ ] 选择邮箱发货
- [ ] 输入邮箱地址
- [ ] 确认发货
- [ ] 检查邮箱是否收到
- [ ] 选择TGBot发货
- [ ] 输入Chat ID
- [ ] 确认发货
- [ ] 检查TG是否收到

### TGBot验证测试

- [ ] 添加配置的TGBot
- [ ] 发送订单号
- [ ] 检查Bot响应
- [ ] 验证文件发送
- [ ] 尝试重复发货（应被拒绝）

---

## ⚠️ 注意事项

### 邮箱配置

1. **使用授权码而非登录密码**
   - QQ邮箱：在设置中生成授权码
   - Gmail：启用"低安全性应用访问"或使用App密码
   - 163邮箱：在设置中开启SMTP服务并获取授权码

2. **端口选择**
   - 25端口：可能被运营商屏蔽
   - 587端口：TLS加密（推荐）
   - 465端口：SSL加密

3. **发送限制**
   - 注意邮箱服务商的每日发送限制
   - 建议使用企业邮箱

### TGBot配置

1. **Bot Token安全**
   - 妥善保管Bot Token
   - 不要泄露给他人
   - 定期更换Token

2. **Chat ID获取**
   - 客户向Bot发送任意消息
   - 后端日志会记录Chat ID
   - 或使用Bot命令 `/start`

3. **文件大小限制**
   - Telegram文件限制：50MB
   - 如果数据量大，考虑压缩或分割

---

## 🐛 故障排查

### 问题1：邮件发送失败

**可能原因：**
- SMTP配置错误
- 授权码错误
- 网络连接问题
- 邮箱服务器屏蔽

**解决方案：**
1. 检查SMTP配置是否正确
2. 确认使用授权码而非登录密码
3. 尝试测试发送功能
4. 查看后端日志错误信息

### 问题2：TGBot发送失败

**可能原因：**
- Bot Token错误
- Chat ID无效
- 网络连接问题

**解决方案：**
1. 确认Bot Token正确
2. 向Bot发送消息确认Chat ID
3. 测试Bot配置

### 问题3：订单无法发货

**可能原因：**
- 订单状态不符合
- 订单已发货
- 配置未启用

**解决方案：**
1. 检查订单状态（必须是"已完成-待发货"）
2. 确认配置已启用
3. 查看浏览器控制台错误

---

## 📞 技术支持

### 日志位置

**后端日志：**
```
/home/vue-element-admin/backend/logs/
```

**查看实时日志：**
```bash
tail -f /home/vue-element-admin/backend/logs/combined.log
```

### 调试命令

**重启后端：**
```bash
pkill -f "node.*server.js"
cd /home/vue-element-admin/backend
node server.js
```

**查看进程：**
```bash
ps aux | grep node
```

---

## 🎉 下一步

完成配置后，您可以：

1. ✅ 测试邮箱发货功能
2. ✅ 测试TGBot发货功能
3. ✅ 配置真实订单发货流程
4. ✅ 培训客户使用发货功能
5. ✅ 监控发货日志和状态

---

## 📚 相关文档

- [数据发送功能说明.md](file:///home/vue-element-admin/数据发送功能说明.md) - 详细技术文档
- [系统管理功能修复说明.md](file:///home/vue-element-admin/系统管理功能修复说明.md) - 系统管理模块
- [QUICKSTART_系统管理功能.md](file:///home/vue-element-admin/QUICKSTART_系统管理功能.md) - 快速启动指南

---

**实现完成时间：** 2025-10-15  
**状态：** ✅ 全部完成  
**后端服务器：** ✅ 运行中  
**前端页面：** ✅ 可访问
