# 数据发送功能实现文档

## 功能概述

实现了完整的订单数据发送功能，客户在资源中心购买数据后，经过代理/管理员审核通过，订单状态变为"已完成-待发货"，客户可以选择邮箱或TGBot方式接收数据。

---

## 功能流程

### 1. 订单流程

```
购买数据 → 提交审核 → 审核通过 → 订单完成(待发货) → 客户发货 → 已发货
```

### 2. 发货方式

#### 方式一：邮箱发货
- 客户选择邮箱发货方式
- 输入接收邮箱地址
- 系统自动验证订单状态（已完成且待发货）
- 系统从数据库提取订单对应的数据
- 生成TXT格式文件
- 通过配置的SMTP服务器发送邮件附件

#### 方式二：TGBot发货
- 客户添加系统配置的TGBot账号
- 客户向Bot发送订单号
- 系统验证订单号和订单状态
- 验证通过后自动从数据库提取数据
- 生成TXT格式文件
- 通过TGBot发送文件给客户

---

## 技术实现

### 后端实现

#### 1. 数据模型

**DeliveryConfig (发货配置模型)**
```javascript
{
  id: INTEGER,
  config_type: STRING,      // 'email' 或 'tgbot'
  config_data: TEXT,        // JSON格式配置
  status: TINYINT,          // 1-启用 0-禁用
  remark: TEXT,
  create_time: BIGINT,
  update_time: BIGINT
}
```

**OrderData (订单数据模型)**
```javascript
{
  id: INTEGER,
  order_id: INTEGER,
  order_number: STRING,
  data_content: TEXT,       // 数据内容（每行一条）
  data_count: INTEGER,
  operator: STRING,         // 运营商
  create_time: BIGINT
}
```

**Order (订单模型 - 新增字段)**
```javascript
{
  // ... 原有字段
  delivery_status: STRING,   // 'pending' 或 'delivered'
  delivery_method: STRING,   // 'email' 或 'tgbot'
  delivery_address: STRING,  // 邮箱地址或Chat ID
  delivery_time: BIGINT
}
```

#### 2. 核心服务

**DeliveryService (`/backend/services/deliveryService.js`)**

```javascript
// 邮箱发送
static async sendByEmail(orderData, emailConfig, recipientEmail)

// TGBot发送
static async sendByTGBot(orderData, tgbotConfig, chatId)

// 生成TXT文件
static generateTxtContent(orderData)

// 验证订单状态
static validateOrderStatus(order)

// 提取订单数据
static async extractOrderData(orderId, OrderData)
```

#### 3. API接口

**发货配置管理 (`/api/delivery/config`)**
- `GET /api/delivery/config/:type` - 获取配置（email/tgbot）
- `PUT /api/delivery/config/:type` - 更新配置
- `POST /api/delivery/config/email/test` - 测试邮箱配置
- `POST /api/delivery/config/tgbot/test` - 测试TGBot配置

**订单发货 (`/api/orders`)**
- `POST /api/orders/:id/customer-deliver` - 客户发货（需登录）
- `POST /api/orders/verify-tgbot-order` - TGBot订单验证（公开接口）

---

### 前端实现

#### 1. 发货配置页面

**`/src/views/system/delivery-config.vue`**

功能：
- 邮箱SMTP配置
- TGBot Token配置
- 测试发送功能
- 启用/禁用开关

配置项：
```javascript
// 邮箱配置
{
  smtp_host: '',      // SMTP服务器
  smtp_port: 587,     // 端口
  smtp_secure: false, // SSL/TLS
  smtp_user: '',      // 发件邮箱
  smtp_pass: '',      // 授权密码
  sender_name: ''     // 发件人名称
}

// TGBot配置
{
  bot_token: '',      // Bot Token
  bot_username: '',   // Bot用户名
  webhook_url: ''     // Webhook地址（可选）
}
```

#### 2. 客户发货页面

**`/src/views/order/delivery.vue`** (已更新)

功能：
- 显示订单详情
- 选择发货方式
- 邮箱地址输入和验证
- Chat ID输入
- 提交发货请求

---

## 配置步骤

### 1. 安装依赖

```bash
cd /home/vue-element-admin/backend
npm install nodemailer node-telegram-bot-api
```

### 2. 配置邮箱发送

进入系统管理 > 发货配置 > 邮箱发货配置

**常用SMTP配置示例：**

**Gmail:**
```
SMTP服务器: smtp.gmail.com
端口: 587
SSL/TLS: 启用
发件邮箱: your-email@gmail.com
密码: App专用密码（不是登录密码）
```

**QQ邮箱:**
```
SMTP服务器: smtp.qq.com
端口: 587 或 465
SSL/TLS: 启用
发件邮箱: your-email@qq.com
密码: 授权码（在QQ邮箱设置中生成）
```

**163邮箱:**
```
SMTP服务器: smtp.163.com
端口: 465
SSL/TLS: 启用
发件邮箱: your-email@163.com
密码: 授权码
```

### 3. 配置TGBot

#### 步骤1：创建Bot
1. 在Telegram中找到 @BotFather
2. 发送 `/newbot` 命令
3. 按提示设置Bot名称和用户名
4. 获取Bot Token（格式：`123456:ABC-DEF...`）

#### 步骤2：配置系统
1. 进入系统管理 > 发货配置 > TGBot发货配置
2. 填入Bot Token
3. 填入Bot用户名（如：@YourDataBot）
4. 保存配置并测试

#### 步骤3：获取Chat ID
客户向Bot发送任意消息，系统日志中会显示Chat ID

---

## 使用流程

### 管理员操作

1. **配置发货方式**
   - 登录管理后台
   - 进入"系统管理 > 发货配置"
   - 配置邮箱或TGBot（或两者都配置）
   - 测试配置是否正常
   - 启用发货功能

2. **审核订单**
   - 进入"订单管理 > 待审核订单"
   - 查看订单详情
   - 审核通过后，订单状态变为"已完成-待发货"

### 客户操作

#### 邮箱发货流程

1. 进入"订单管理 > 已完成订单"
2. 找到待发货订单，点击"发货"按钮
3. 选择"邮箱发货"
4. 输入接收邮箱地址
5. 点击"确认发货"
6. 系统自动发送数据到邮箱
7. 查收邮件附件

#### TGBot发货流程

**方式一：主动发货**
1. 进入"订单管理 > 已完成订单"
2. 找到待发货订单，点击"发货"按钮
3. 选择"TGBot发货"
4. 输入Chat ID
5. 点击"确认发货"
6. TGBot自动发送文件

**方式二：Bot验证发货**
1. 添加系统配置的TGBot
2. 向Bot发送订单号
3. Bot自动验证订单状态
4. 验证通过后自动发送数据文件

---

## 数据格式

### TXT文件格式

```
========================================
订单号: ORD1234567890
数据国家: 美国
数据时效: 3天内
数据数量: 10000 条
生成时间: 2025-10-15 15:30:00
========================================

data_line_1
data_line_2
data_line_3
...
data_line_10000

========================================
数据发送完成
========================================
```

---

## 文件结构

```
backend/
├── models/
│   ├── DeliveryConfig.js       # 发货配置模型
│   ├── OrderData.js            # 订单数据模型
│   └── Order.js                # 订单模型（已更新）
├── services/
│   └── deliveryService.js      # 发货服务
├── routes/
│   ├── delivery.js             # 发货配置路由
│   └── orders.js               # 订单路由（已更新）
└── temp/                       # 临时文件目录

frontend/
├── src/
│   ├── views/
│   │   ├── system/
│   │   │   └── delivery-config.vue  # 发货配置页面
│   │   └── order/
│   │       └── delivery.vue         # 发货页面（已更新）
│   └── router/
│       └── index.js                 # 路由配置（已更新）
```

---

## API文档

### 1. 客户发货接口

**请求:**
```http
POST /api/orders/:id/customer-deliver
Authorization: Bearer {token}
Content-Type: application/json

{
  "delivery_method": "email",
  "delivery_address": "customer@example.com"
}
```

**响应:**
```json
{
  "success": true,
  "message": "发货成功",
  "data": {
    "orderId": 123,
    "orderNumber": "ORD1234567890",
    "deliveryMethod": "email",
    "deliveryAddress": "customer@example.com",
    "deliveryTime": 1697356800000
  }
}
```

### 2. TGBot验证发货接口

**请求:**
```http
POST /api/orders/verify-tgbot-order
Content-Type: application/json

{
  "order_number": "ORD1234567890",
  "chat_id": "123456789"
}
```

**响应:**
```json
{
  "success": true,
  "message": "发货成功，请查收数据",
  "data": {
    "orderNumber": "ORD1234567890",
    "quantity": 10000
  }
}
```

---

## 安全说明

### 权限控制

1. **发货配置管理** - 仅管理员可访问
2. **客户发货** - 需登录，且只能发货自己的订单
3. **TGBot验证** - 公开接口，但需验证订单状态

### 订单状态验证

发货前必须满足：
- 订单状态为 `completed`（已完成）
- 发货状态为 `pending`（待发货）
- 配置已启用（status = 1）

### 防重复发货

- 订单发货后状态变为 `delivered`
- 已发货订单无法再次发货
- TGBot验证时会检查发货状态

---

## 错误处理

### 常见错误

1. **"订单未完成，无法发货"**
   - 原因：订单状态不是 completed
   - 解决：等待管理员审核通过

2. **"订单已发货，请勿重复发货"**
   - 原因：订单已经发过货
   - 解决：联系管理员

3. **"邮箱发货功能未启用"**
   - 原因：管理员未配置或未启用邮箱发货
   - 解决：联系管理员配置

4. **"邮件发送失败"**
   - 原因：SMTP配置错误或网络问题
   - 解决：检查SMTP配置，测试连接

5. **"TGBot发送失败"**
   - 原因：Bot Token错误或Chat ID无效
   - 解决：检查Bot配置，确认Chat ID

---

## 数据库同步

启动服务器时会自动创建新表：

```bash
cd /home/vue-element-admin/backend
node server.js
```

执行后会创建：
- `delivery_configs` - 发货配置表
- `order_data` - 订单数据表
- 更新 `orders` - 添加发货相关字段

---

## 测试检查清单

### 管理员测试

- [ ] 邮箱配置保存成功
- [ ] 邮箱测试发送成功
- [ ] TGBot配置保存成功
- [ ] TGBot测试发送成功
- [ ] 配置启用/禁用正常

### 客户测试

- [ ] 查看已完成订单列表
- [ ] 待发货订单显示"发货"按钮
- [ ] 已发货订单不显示"发货"按钮
- [ ] 邮箱发货流程完整
- [ ] 邮箱接收到数据文件
- [ ] TGBot发货流程完整
- [ ] TGBot接收到数据文件

### TGBot验证测试

- [ ] Bot响应订单号消息
- [ ] 订单验证通过
- [ ] 文件发送成功
- [ ] 重复发货被拒绝

---

## 后续优化建议

1. **数据加密**
   - 对敏感数据进行加密存储
   - 文件传输使用加密

2. **发货记录**
   - 记录每次发货的详细日志
   - 支持查看发货历史

3. **批量发货**
   - 支持管理员批量发货
   - 定时自动发货

4. **更多发货方式**
   - 添加微信发送
   - 添加FTP下载
   - 添加云盘分享

5. **发货通知**
   - 发货成功后短信通知
   - 邮件发货确认

---

## 技术支持

如有问题，请检查：
1. 后端日志：`/home/vue-element-admin/backend/logs/`
2. 浏览器控制台错误
3. 网络连接状态
4. SMTP/TGBot配置

---

**实现完成时间：** 2025-10-15  
**版本：** v1.0.0
