# 数据列表定价功能测试验证指南

## 测试环境

**系统信息：**
- 前端地址：http://localhost:9528
- 后端地址：http://localhost:3000
- 数据库：MariaDB 5.5.68
- 浏览器：Chrome/Firefox（推荐开启开发者工具）

**修复文件：**
- `/home/vue-element-admin/src/views/data/library.vue`

**修复内容：**
- 修复定价功能"数据不存在"错误
- 添加数据库同步机制
- 实现三级数据同步（数据库 + 双缓存）

---

## 测试准备

### 1. 确认服务运行状态

```bash
# 检查服务进程
ps aux | grep -E "(node|npm)" | grep -v grep

# 应该看到：
# - node server.js (后端服务)
# - npm run dev (前端服务)
# - vue-cli-service serve (前端编译)

# 检查端口监听
netstat -tlnp | grep -E "(3000|9528)"
# 3000  - 后端 API 服务
# 9528  - 前端开发服务器
```

### 2. 检查数据库数据

```bash
# 查看数据列表
mysql -u vue_admin_user -pvue_admin_2024 vue_admin -e "
  SELECT 
    id, 
    country, 
    data_type, 
    validity, 
    available_quantity,
    cost_price, 
    sell_price,
    publish_status,
    status
  FROM data_library 
  ORDER BY id DESC 
  LIMIT 10;
"
```

**检查点：**
- ✅ 至少有几条测试数据
- ✅ 有未发布的数据（publish_status = 'pending'）
- ✅ 有已发布的数据（publish_status = 'published'）

### 3. 打开浏览器开发者工具

**操作步骤：**
1. 访问 http://localhost:9528
2. 按 F12 打开开发者工具
3. 切换到 Console 标签页（查看日志）
4. 切换到 Network 标签页（查看网络请求）

---

## 测试用例

### 测试用例1：未发布数据定价（核心修复场景）

**测试目的：** 验证未发布数据可以正常定价

#### 步骤1：准备测试数据

```bash
# 如果没有未发布数据，可以插入一条测试数据
mysql -u vue_admin_user -pvue_admin_2024 vue_admin << EOF
INSERT INTO data_library (
  country, country_name, data_type, validity, validity_name,
  source, available_quantity, total_quantity, 
  cost_price, sell_price, operators,
  publish_status, status, upload_time
) VALUES (
  'BR', '巴西', 'mobile', '30', '30天内',
  '测试数据', 50000, 50000,
  0.02, 0.03, '[{"name":"Vivo","quantity":20000},{"name":"Claro","quantity":15000},{"name":"TIM","quantity":15000}]',
  'pending', 'available', UNIX_TIMESTAMP() * 1000
);

SELECT LAST_INSERT_ID() as test_data_id;
EOF
```

**记录测试数据ID：** _____________

#### 步骤2：执行定价操作

1. **登录系统**
   - 访问 http://localhost:9528
   - 使用管理员账号登录

2. **进入数据列表**
   - 点击左侧菜单：数据管理 → 数据列表
   - 等待数据加载完成

3. **找到测试数据**
   - 查看列表中的"发布状态"列
   - 找到状态为"待发布"的数据
   - 确认是否为刚才插入的测试数据

4. **打开定价对话框**
   - 点击该数据行的"定价"按钮
   - 观察对话框是否正常打开

5. **查看数据信息**
   ```
   对话框应显示：
   - 国家：巴西
   - 数据类型：mobile
   - 数量：50,000
   - 时效性：30天内
   - 当前成本价：0.02 U/条
   - 当前销售价：0.03 U/条
   ```

6. **修改价格**
   - 将成本价改为：0.04
   - 将销售价改为：0.05
   - 观察利润分析自动更新：
     - 单条利润：0.0100 U
     - 利润率：25.00%
     - 总利润：500.00 U

7. **保存定价**
   - 点击"保存定价"按钮
   - 观察控制台日志

#### 步骤3：验证结果

**浏览器验证：**

1. **成功消息**
   ```
   预期提示：定价更新成功（已同步数据库）
   消息类型：success（绿色）
   持续时间：3秒
   ```

2. **对话框关闭**
   ```
   定价对话框自动关闭
   ```

3. **列表刷新**
   ```
   数据列表自动刷新
   该数据的成本价显示：0.04 U
   该数据的销售价显示：0.05 U
   利润率显示：25.00%
   ```

4. **控制台日志**
   ```javascript
   // 应该看到以下日志：
   💰 开始保存定价: {id: xxx, country: '巴西', ...}
   📡 调用数据库API更新定价，ID: xxx
   ✅ 数据库定价更新成功
   ✅ 已更新 dataListData 定价
   ℹ️  在 dataList 中未找到数据（可能未发布到资源中心）
   ✅ 定价保存完成: {...}
   🔄 数据列表开始加载...
   ```

**数据库验证：**

```bash
# 查询数据库中的价格
mysql -u vue_admin_user -pvue_admin_2024 vue_admin -e "
  SELECT 
    id,
    country,
    data_type,
    cost_price,
    sell_price,
    (sell_price - cost_price) / cost_price * 100 as profit_rate
  FROM data_library 
  WHERE id = <测试数据ID>;
"
```

**预期结果：**
```
+-----+---------+-----------+------------+------------+--------------+
| id  | country | data_type | cost_price | sell_price | profit_rate  |
+-----+---------+-----------+------------+------------+--------------+
| xxx | BR      | mobile    |     0.0400 |     0.0500 |      25.0000 |
+-----+---------+-----------+------------+------------+--------------+
```

**localStorage 验证：**

```javascript
// 在浏览器控制台执行
const testDataId = <测试数据ID>

// 检查 dataListData
const dataListData = JSON.parse(localStorage.getItem('dataListData'))
const dataInListData = dataListData.find(item => item.id === testDataId)
console.log('dataListData 中的数据:', dataInListData)
// 预期：costPrice = 0.04, sellPrice = 0.05

// 检查 dataList（未发布数据不应该在这里）
const dataList = JSON.parse(localStorage.getItem('dataList'))
const dataInList = dataList ? dataList.find(item => item.id === testDataId) : null
console.log('dataList 中的数据:', dataInList)
// 预期：null 或 undefined（因为是未发布数据）

// 检查操作日志
const logs = JSON.parse(localStorage.getItem('operationLogs'))
const lastLog = logs[0]
console.log('最新操作日志:', lastLog)
// 预期：action = 'UPDATE_PRICING', syncStatus.database = true
```

**测试结论：**
- [ ] ✅ 成功提示显示正常
- [ ] ✅ 数据库价格已更新
- [ ] ✅ dataListData 价格已更新
- [ ] ✅ 列表显示新价格
- [ ] ✅ 控制台日志正确

---

### 测试用例2：已发布数据定价

**测试目的：** 验证已发布数据定价同时更新资源中心

#### 步骤1：准备测试数据

```bash
# 插入已发布数据
mysql -u vue_admin_user -pvue_admin_2024 vue_admin << EOF
INSERT INTO data_library (
  country, country_name, data_type, validity, validity_name,
  source, available_quantity, total_quantity, 
  cost_price, sell_price, operators,
  publish_status, publish_time, status, upload_time
) VALUES (
  'MX', '墨西哥', 'mobile', '3', '3天内',
  '测试数据', 80000, 80000,
  0.03, 0.04, '[{"name":"Telcel","quantity":40000},{"name":"Movistar","quantity":25000},{"name":"AT&T","quantity":15000}]',
  'published', UNIX_TIMESTAMP() * 1000, 'available', UNIX_TIMESTAMP() * 1000
);

SELECT LAST_INSERT_ID() as test_published_data_id;
EOF
```

**记录测试数据ID：** _____________

#### 步骤2：发布到资源中心

1. **刷新数据列表**
   - 点击"刷新数据"按钮
   - 确认看到新插入的已发布数据

2. **检查发布状态**
   ```
   发布状态列应显示：已发布（绿色标签）
   ```

3. **同步到 localStorage**
   ```javascript
   // 在浏览器控制台执行
   const testDataId = <测试数据ID>
   
   // 刷新页面或重新加载数据后
   const dataList = JSON.parse(localStorage.getItem('dataList'))
   const publishedData = dataList ? dataList.find(item => item.id === testDataId) : null
   console.log('资源中心数据:', publishedData)
   // 如果为 null，说明需要手动同步
   ```

#### 步骤3：执行定价操作

1. **打开定价对话框**
   - 找到刚才插入的已发布数据
   - 点击"定价"按钮

2. **修改价格**
   - 将成本价改为：0.05
   - 将销售价改为：0.06
   - 观察利润分析：
     - 单条利润：0.0100 U
     - 利润率：20.00%
     - 总利润：800.00 U

3. **保存定价**
   - 点击"保存定价"按钮

#### 步骤4：验证结果

**浏览器验证：**

1. **控制台日志**
   ```javascript
   💰 开始保存定价: {id: xxx, country: '墨西哥', ...}
   📡 调用数据库API更新定价，ID: xxx
   ✅ 数据库定价更新成功
   ✅ 已更新 dataListData 定价
   ✅ 已更新 dataList 定价  // ← 注意：已发布数据会更新 dataList
   ✅ 定价保存完成
   ```

2. **资源中心验证**
   - 访问：资源中心 → 数据列表
   - 找到该数据
   - 确认价格已更新：成本价 0.05，销售价 0.06

**localStorage 验证：**

```javascript
// 在浏览器控制台执行
const testDataId = <测试数据ID>

// 检查 dataListData
const dataListData = JSON.parse(localStorage.getItem('dataListData'))
const dataInListData = dataListData.find(item => item.id === testDataId)
console.log('dataListData:', dataInListData.costPrice, dataInListData.sellPrice)
// 预期：0.05, 0.06

// 检查 dataList（已发布数据应该在这里）
const dataList = JSON.parse(localStorage.getItem('dataList'))
const dataInList = dataList.find(item => item.id === testDataId)
console.log('dataList:', dataInList.costPrice, dataInList.sellPrice)
// 预期：0.05, 0.06

// 检查同步状态
const logs = JSON.parse(localStorage.getItem('operationLogs'))
const lastLog = logs[0]
console.log('同步状态:', lastLog.syncStatus)
// 预期：{database: true, dataListData: true, dataList: true}
```

**测试结论：**
- [ ] ✅ 数据库价格已更新
- [ ] ✅ dataListData 价格已更新
- [ ] ✅ dataList 价格已更新
- [ ] ✅ 资源中心显示新价格
- [ ] ✅ 三级同步都成功

---

### 测试用例3：推荐定价功能

**测试目的：** 验证推荐定价按钮功能正常

#### 测试步骤

1. **打开定价对话框**
   - 选择任意一条数据
   - 点击"定价"按钮

2. **查看当前时效性**
   ```
   数据信息中显示时效性：
   - 3天内
   - 30天内
   - 30天以上
   ```

3. **点击"应用推荐定价"**
   - 点击按钮

4. **验证推荐价格**

   **3天内数据：**
   ```
   成本价：0.04 U/条
   销售价：0.05 U/条
   利润率：25.00%
   ```

   **30天内数据：**
   ```
   成本价：0.03 U/条
   销售价：0.04 U/条
   利润率：33.33%
   ```

   **30天以上数据：**
   ```
   成本价：0.02 U/条
   销售价：0.03 U/条
   利润率：50.00%
   ```

5. **保存并验证**
   - 点击"保存定价"
   - 验证价格保存成功

**测试结论：**
- [ ] ✅ 推荐定价计算正确
- [ ] ✅ 不同时效性价格不同
- [ ] ✅ 保存后价格正确

---

### 测试用例4：容错机制测试

**测试目的：** 验证错误处理和降级机制

#### 场景1：数据库连接失败

**模拟步骤：**

1. **临时停止数据库**
   ```bash
   # 停止 MariaDB
   systemctl stop mariadb
   ```

2. **执行定价操作**
   - 打开定价对话框
   - 修改价格
   - 点击保存

3. **观察控制台**
   ```javascript
   📡 调用数据库API更新定价，ID: xxx
   ❌ 数据库定价更新失败: connect ECONNREFUSED
   ✅ 已更新 dataListData 定价
   ✅ 定价保存完成
   ```

4. **验证结果**
   ```
   提示：定价更新成功（仅本地缓存）
   列表价格已更新（仅缓存）
   ```

5. **恢复数据库**
   ```bash
   # 启动 MariaDB
   systemctl start mariadb
   ```

**测试结论：**
- [ ] ✅ 数据库失败时降级到缓存
- [ ] ✅ 提示信息准确
- [ ] ✅ 不影响用户操作

#### 场景2：localStorage 清空

**模拟步骤：**

1. **清空缓存**
   ```javascript
   // 在浏览器控制台执行
   localStorage.removeItem('dataListData')
   localStorage.removeItem('dataList')
   ```

2. **刷新页面**
   - 按 F5 刷新
   - 数据应从数据库重新加载

3. **执行定价**
   - 打开定价对话框
   - 修改价格并保存

4. **验证**
   ```javascript
   // 检查缓存已恢复
   localStorage.getItem('dataListData') // 不为 null
   ```

**测试结论：**
- [ ] ✅ 缓存清空后自动重建
- [ ] ✅ 定价功能正常

---

### 测试用例5：并发操作测试

**测试目的：** 验证多次快速定价操作

#### 测试步骤

1. **快速连续定价**
   - 打开数据A的定价对话框
   - 修改价格并保存
   - 立即打开数据B的定价对话框
   - 修改价格并保存
   - 重复3-5次

2. **验证结果**
   - 每次保存都成功
   - 没有数据覆盖
   - 操作日志完整

**测试结论：**
- [ ] ✅ 并发操作正常
- [ ] ✅ 数据不冲突

---

## 性能测试

### 测试场景：大量数据定价

**测试步骤：**

1. **准备大量数据**
   ```bash
   # 插入100条测试数据
   mysql -u vue_admin_user -pvue_admin_2024 vue_admin << 'EOF'
   DELIMITER $$
   CREATE PROCEDURE insert_test_data()
   BEGIN
     DECLARE i INT DEFAULT 1;
     WHILE i <= 100 DO
       INSERT INTO data_library (
         country, country_name, data_type, validity, validity_name,
         source, available_quantity, total_quantity, 
         cost_price, sell_price, operators,
         publish_status, status, upload_time
       ) VALUES (
         'BR', '巴西', 'mobile', '30', '30天内',
         CONCAT('性能测试-', i), 50000 + i * 1000, 50000 + i * 1000,
         0.02, 0.03, '[{"name":"Vivo","quantity":20000}]',
         'pending', 'available', UNIX_TIMESTAMP() * 1000
       );
       SET i = i + 1;
     END WHILE;
   END$$
   DELIMITER ;
   
   CALL insert_test_data();
   DROP PROCEDURE insert_test_data;
   EOF
   ```

2. **刷新列表**
   - 点击"刷新数据"
   - 记录加载时间：_______ 秒

3. **执行定价**
   - 打开定价对话框
   - 修改价格
   - 记录保存时间：_______ 秒

**性能基准：**
- 列表加载：< 3秒
- 定价保存：< 1秒

**测试结论：**
- [ ] ✅ 加载时间符合预期
- [ ] ✅ 保存时间符合预期

---

## 回归测试

### 其他功能验证

确保定价修复不影响其他功能：

#### 1. 数据新增
- [ ] ✅ 新增数据功能正常
- [ ] ✅ 文件上传正常

#### 2. 数据编辑
- [ ] ✅ 编辑数据功能正常
- [ ] ✅ 保存成功

#### 3. 数据删除
- [ ] ✅ 删除确认对话框显示
- [ ] ✅ 删除成功

#### 4. 数据发布
- [ ] ✅ 单条发布正常
- [ ] ✅ 批量发布正常

#### 5. 数据下线
- [ ] ✅ 下线功能正常

#### 6. 数据详情
- [ ] ✅ 详情对话框显示正常

---

## 问题排查

### 常见问题

#### Q1：提示"数据不存在"
**可能原因：**
- localStorage 缓存损坏
- 数据库中数据被删除
- 页面未刷新

**解决方法：**
```bash
# 1. 检查数据库
mysql -u vue_admin_user -pvue_admin_2024 vue_admin -e "
  SELECT id, country FROM data_library WHERE id = <数据ID>;
"

# 2. 刷新页面并清除缓存
# 浏览器按 Ctrl+Shift+R 强制刷新
```

#### Q2：保存后价格未更新
**可能原因：**
- 列表未自动刷新
- 缓存更新失败

**解决方法：**
```javascript
// 查看控制台日志
console.log('查看定价保存日志')

// 手动刷新列表
location.reload()
```

#### Q3：推荐定价不准确
**可能原因：**
- 时效性字段错误

**解决方法：**
```bash
# 检查时效性字段
mysql -u vue_admin_user -pvue_admin_2024 vue_admin -e "
  SELECT id, validity FROM data_library WHERE id = <数据ID>;
"
# 应该是：'3', '30', '30+' 之一
```

---

## 测试报告模板

### 测试执行记录

**测试人员：** ______________  
**测试时间：** ______________  
**测试环境：** 生产环境 / 开发环境

### 测试结果汇总

| 测试用例 | 测试结果 | 备注 |
|---------|---------|------|
| 未发布数据定价 | ✅ / ❌ | |
| 已发布数据定价 | ✅ / ❌ | |
| 推荐定价功能 | ✅ / ❌ | |
| 容错机制 | ✅ / ❌ | |
| 并发操作 | ✅ / ❌ | |
| 性能测试 | ✅ / ❌ | |

### 发现的问题

| 问题编号 | 问题描述 | 严重程度 | 状态 |
|---------|---------|---------|------|
| 1 | | 高/中/低 | 待修复/已修复 |
| 2 | | 高/中/低 | 待修复/已修复 |

### 总体评价

- **功能完整性：** 完整 / 基本完整 / 不完整
- **稳定性：** 稳定 / 基本稳定 / 不稳定
- **性能：** 优秀 / 良好 / 需优化
- **建议上线：** 是 / 否

### 备注

_______________________________________________________
_______________________________________________________
_______________________________________________________

---

**文档版本：** 1.0  
**创建时间：** 2025-10-18  
**最后更新：** 2025-10-18
