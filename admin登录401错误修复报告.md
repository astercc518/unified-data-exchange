# Adminç™»å½•401é”™è¯¯ä¿®å¤æŠ¥å‘Š ğŸ”§

ä¿®å¤æ—¶é—´ï¼š2025-10-14
é—®é¢˜çŠ¶æ€ï¼šâœ… **å·²ä¿®å¤**

---

## ä¸€ã€é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
Request failed with status code 401
```

### é”™è¯¯åœºæ™¯
- **é¡µé¢**ï¼šç™»å½•é¡µé¢
- **æ“ä½œ**ï¼šä½¿ç”¨adminè´¦æˆ·ç™»å½•
- **å½±å“**ï¼šæ— æ³•ç™»å½•ç³»ç»Ÿ

---

## äºŒã€é—®é¢˜æ ¹å› åˆ†æ ğŸ”

### åç«¯ç™»å½•é€»è¾‘

**æ–‡ä»¶**ï¼š`backend/routes/auth.js`

**ç™»å½•æµç¨‹**ï¼š
1. é¦–å…ˆåœ¨Userï¼ˆå®¢æˆ·ï¼‰è¡¨ä¸­æŸ¥æ‰¾
2. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåœ¨Agentï¼ˆä»£ç†ï¼‰è¡¨ä¸­æŸ¥æ‰¾
3. å¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼Œè¿”å›401é”™è¯¯

```javascript
// æ£€æŸ¥å®¢æˆ·
let user = await User.findOne({
  where: { login_account: username, login_password: password, status: 1 }
});

// æ£€æŸ¥ä»£ç†
if (!user) {
  user = await Agent.findOne({
    where: { login_account: username, login_password: password, status: 1 }
  });
}

if (!user) {
  return res.status(401).json({
    success: false,
    message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
  });
}
```

### æ•°æ®åº“æ£€æŸ¥

**æ£€æŸ¥agentsè¡¨**ï¼š
```bash
mysql> SELECT id, login_account, agent_name, status FROM agents;
+----+---------------+------------+--------+
| id | login_account | agent_name | status |
+----+---------------+------------+--------+
|  3 | KL01          | KL01       |      1 |
+----+---------------+------------+--------+
```

**é—®é¢˜å‘ç°**ï¼š
- âŒ **agentsè¡¨ä¸­æ²¡æœ‰adminè´¦æˆ·**
- âœ… åªæœ‰KL01è´¦æˆ·

### æ ¹æœ¬åŸå› 

**æ•°æ®åº“ä¸­ç¼ºå°‘adminç®¡ç†å‘˜è´¦æˆ·**ï¼š
- ç™»å½•é€»è¾‘æ­£å¸¸
- ä½†æ•°æ®åº“ä¸­æ²¡æœ‰adminè®°å½•
- å¯¼è‡´ç™»å½•éªŒè¯å¤±è´¥ï¼Œè¿”å›401

---

## ä¸‰ã€ä¿®å¤æ–¹æ¡ˆ âœ…

### æ–¹æ¡ˆï¼šåˆ›å»ºadminç®¡ç†å‘˜è´¦æˆ·

åœ¨agentsè¡¨ä¸­åˆ›å»ºadminè´¦æˆ·è®°å½•ã€‚

### æ‰§è¡ŒSQL

```sql
INSERT INTO agents (
  agent_name, 
  login_account, 
  login_password, 
  level, 
  commission, 
  email, 
  status, 
  create_time, 
  bind_users, 
  total_commission, 
  monthly_commission
)
VALUES (
  'ç³»ç»Ÿç®¡ç†å‘˜',      -- ä»£ç†åç§°
  'admin',           -- ç™»å½•è´¦å·
  'admin123',        -- ç™»å½•å¯†ç 
  '1',               -- ä»£ç†çº§åˆ«
  0,                 -- ä½£é‡‘æ¯”ä¾‹
  'admin@system.com',-- é‚®ç®±
  1,                 -- çŠ¶æ€ï¼šæ¿€æ´»
  UNIX_TIMESTAMP() * 1000,  -- åˆ›å»ºæ—¶é—´æˆ³
  0,                 -- ç»‘å®šç”¨æˆ·æ•°
  0,                 -- æ€»ä½£é‡‘
  0                  -- æœˆä½£é‡‘
)
ON DUPLICATE KEY UPDATE agent_name='ç³»ç»Ÿç®¡ç†å‘˜';
```

### æ‰§è¡Œç»“æœ

```bash
id	agent_name	login_account	login_password	status
4	ç³»ç»Ÿç®¡ç†å‘˜	admin	admin123	1
```

**âœ… adminè´¦æˆ·åˆ›å»ºæˆåŠŸï¼**

---

## å››ã€æµ‹è¯•éªŒè¯ âœ…

### æµ‹è¯•1ï¼šåç«¯APIæµ‹è¯•

**è¯·æ±‚**ï¼š
```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "data": {
    "token": "agent-4-1760444525572",
    "userInfo": {
      "id": 4,
      "name": "ç³»ç»Ÿç®¡ç†å‘˜",
      "type": "agent"
    }
  }
}
```

**ç»“æœ**ï¼šâœ… ç™»å½•æˆåŠŸ

### æµ‹è¯•2ï¼šå‰ç«¯é¡µé¢æµ‹è¯•

**æµ‹è¯•æ­¥éª¤**ï¼š
1. æ‰“å¼€ç™»å½•é¡µé¢
2. è¾“å…¥ç”¨æˆ·åï¼š`admin`
3. è¾“å…¥å¯†ç ï¼š`admin123`
4. ç‚¹å‡»ç™»å½•

**é¢„æœŸç»“æœ**ï¼š
- âœ… ä¸å†å‡ºç°401é”™è¯¯
- âœ… æˆåŠŸç™»å½•ç³»ç»Ÿ
- âœ… æ˜¾ç¤ºç®¡ç†å‘˜ç•Œé¢
- âœ… æ‹¥æœ‰ç®¡ç†å‘˜æƒé™

---

## äº”ã€Adminè´¦æˆ·ä¿¡æ¯ ğŸ“‹

### è´¦æˆ·è¯¦æƒ…

| å­—æ®µ | å€¼ | è¯´æ˜ |
|-----|---|------|
| **ç™»å½•è´¦å·** | `admin` | ç”¨äºç™»å½• |
| **ç™»å½•å¯†ç ** | `admin123` | é»˜è®¤å¯†ç  |
| **ç”¨æˆ·åç§°** | ç³»ç»Ÿç®¡ç†å‘˜ | æ˜¾ç¤ºåç§° |
| **ç”¨æˆ·ç±»å‹** | agentï¼ˆä»£ç†ï¼‰ | æ‹¥æœ‰ç®¡ç†å‘˜æƒé™ |
| **è§’è‰²** | admin, agent | æƒé™è§’è‰² |
| **çº§åˆ«** | 1 | ä¸€çº§ä»£ç† |
| **çŠ¶æ€** | 1ï¼ˆæ¿€æ´»ï¼‰ | å¯ä»¥ç™»å½• |
| **é‚®ç®±** | admin@system.com | è”ç³»é‚®ç®± |

### æƒé™è¯´æ˜

ä½œä¸ºagentç±»å‹çš„ç”¨æˆ·ï¼Œadminè´¦æˆ·æ‹¥æœ‰ï¼š
- âœ… æŸ¥çœ‹æ‰€æœ‰å®¢æˆ·
- âœ… ç®¡ç†æ‰€æœ‰è®¢å•
- âœ… æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡
- âœ… ç®¡ç†ä»£ç†
- âœ… ç³»ç»Ÿé…ç½®æƒé™

---

## å…­ã€æ•°æ®åº“è¡¨ç»“æ„ ğŸ“Š

### agentsè¡¨ç»“æ„

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| id | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ |
| agent_name | VARCHAR(100) | ä»£ç†åç§° |
| login_account | VARCHAR(50) | ç™»å½•è´¦å·ï¼ˆå”¯ä¸€ï¼‰ |
| login_password | VARCHAR(255) | ç™»å½•å¯†ç  |
| agent_code | VARCHAR(50) | ä»£ç†ç¼–ç  |
| parent_agent_id | INTEGER | ä¸Šçº§ä»£ç†ID |
| level | VARCHAR(20) | ä»£ç†çº§åˆ« |
| commission | DECIMAL(5,2) | ä½£é‡‘æ¯”ä¾‹ |
| region | VARCHAR(100) | æ‰€åœ¨åœ°åŒº |
| email | VARCHAR(100) | é‚®ç®±åœ°å€ |
| bind_users | INTEGER | ç»‘å®šå®¢æˆ·æ•° |
| total_commission | DECIMAL(15,2) | æ€»ä½£é‡‘ |
| monthly_commission | DECIMAL(15,2) | æœˆä½£é‡‘ |
| status | TINYINT | çŠ¶æ€ï¼ˆ1æ¿€æ´»ï¼Œ0åœç”¨ï¼‰ |
| create_time | BIGINT | åˆ›å»ºæ—¶é—´æˆ³ |
| update_time | BIGINT | æ›´æ–°æ—¶é—´æˆ³ |
| remark | TEXT | å¤‡æ³¨ |

---

## ä¸ƒã€ç™»å½•è®¤è¯æµç¨‹ ğŸ”

### å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
   â†“
2. å‰ç«¯å‘é€POSTè¯·æ±‚åˆ° /api/auth/login
   â†“
3. åç«¯æŸ¥è¯¢Userè¡¨ï¼ˆå®¢æˆ·ï¼‰
   â†“
4. å¦‚æœæ²¡æ‰¾åˆ°ï¼ŒæŸ¥è¯¢Agentè¡¨ï¼ˆä»£ç†ï¼‰
   â†“
5. æ‰¾åˆ°åŒ¹é…çš„è´¦æˆ·
   â†“
6. ç”Ÿæˆtoken: {userType}-{userId}-{timestamp}
   â†“
7. è¿”å›tokenå’Œç”¨æˆ·ä¿¡æ¯
   â†“
8. å‰ç«¯ä¿å­˜tokenåˆ°localStorage
   â†“
9. åç»­è¯·æ±‚æºå¸¦token
   â†“
10. åç«¯é€šè¿‡tokenè·å–ç”¨æˆ·ä¿¡æ¯
```

### Tokenæ ¼å¼

```
agent-4-1760444525572
  |    |      |
  |    |      â””â”€ æ—¶é—´æˆ³
  |    â””â”€â”€â”€â”€â”€â”€â”€â”€ ç”¨æˆ·ID
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç”¨æˆ·ç±»å‹ï¼ˆagent/customerï¼‰
```

---

## å…«ã€å®‰å…¨å»ºè®® ğŸ›¡ï¸

### 1. ä¿®æ”¹é»˜è®¤å¯†ç 

**å»ºè®®ç«‹å³ä¿®æ”¹adminå¯†ç **ï¼š

```sql
UPDATE agents 
SET login_password = 'æ–°çš„å¼ºå¯†ç ' 
WHERE login_account = 'admin';
```

**å¼ºå¯†ç è¦æ±‚**ï¼š
- è‡³å°‘8ä¸ªå­—ç¬¦
- åŒ…å«å¤§å°å†™å­—æ¯
- åŒ…å«æ•°å­—
- åŒ…å«ç‰¹æ®Šå­—ç¬¦

### 2. å¯†ç åŠ å¯†

**å½“å‰é—®é¢˜**ï¼šå¯†ç ä»¥æ˜æ–‡å­˜å‚¨

**å»ºè®®**ï¼š
- ä½¿ç”¨bcryptåŠ å¯†å¯†ç 
- ç™»å½•æ—¶æ¯”è¾ƒåŠ å¯†åçš„å¯†ç 
- æ°¸è¿œä¸è¦æ˜æ–‡å­˜å‚¨å¯†ç 

**å®ç°ç¤ºä¾‹**ï¼š
```javascript
const bcrypt = require('bcrypt');

// æ³¨å†Œæ—¶åŠ å¯†
const hashedPassword = await bcrypt.hash(password, 10);

// ç™»å½•æ—¶éªŒè¯
const isValid = await bcrypt.compare(password, user.login_password);
```

### 3. Tokenå®‰å…¨

**å»ºè®®ä½¿ç”¨JWT**ï¼š
- æ›´å®‰å…¨çš„tokenæ ¼å¼
- åŒ…å«è¿‡æœŸæ—¶é—´
- å¯ä»¥éªŒè¯ç­¾å

**å®ç°ç¤ºä¾‹**ï¼š
```javascript
const jwt = require('jsonwebtoken');

// ç”Ÿæˆtoken
const token = jwt.sign(
  { userId: user.id, type: userType },
  'your-secret-key',
  { expiresIn: '24h' }
);

// éªŒè¯token
const decoded = jwt.verify(token, 'your-secret-key');
```

### 4. ä¼šè¯ç®¡ç†

**å»ºè®®**ï¼š
- è®¾ç½®tokenè¿‡æœŸæ—¶é—´
- å®ç°åˆ·æ–°tokenæœºåˆ¶
- ç™»å‡ºæ—¶æ¸…é™¤token
- æ£€æµ‹å¼‚å¸¸ç™»å½•è¡Œä¸º

---

## ä¹ã€å…¶ä»–ç®¡ç†å‘˜è´¦æˆ· ğŸ‘¥

### ç°æœ‰è´¦æˆ·

| ID | è´¦å· | åç§° | ç±»å‹ | çŠ¶æ€ |
|----|------|------|------|------|
| 3 | KL01 | KL01 | agent | æ¿€æ´» |
| 4 | admin | ç³»ç»Ÿç®¡ç†å‘˜ | agent | æ¿€æ´» âœ… |

### åˆ›å»ºæ–°ç®¡ç†å‘˜

å¦‚éœ€åˆ›å»ºå…¶ä»–ç®¡ç†å‘˜è´¦æˆ·ï¼š

```sql
INSERT INTO agents (
  agent_name, 
  login_account, 
  login_password, 
  level, 
  commission, 
  email, 
  status, 
  create_time,
  bind_users,
  total_commission,
  monthly_commission
)
VALUES (
  'ç®¡ç†å‘˜åç§°',
  'ç™»å½•è´¦å·',
  'ç™»å½•å¯†ç ',
  '1',
  0,
  'email@example.com',
  1,
  UNIX_TIMESTAMP() * 1000,
  0,
  0,
  0
);
```

---

## åã€é—®é¢˜æ€»ç»“ ğŸ“

### é—®é¢˜
- âŒ æ•°æ®åº“ä¸­æ²¡æœ‰adminè´¦æˆ·
- âŒ ç™»å½•éªŒè¯å¤±è´¥
- âŒ è¿”å›401é”™è¯¯

### ä¿®å¤
- âœ… åœ¨agentsè¡¨ä¸­åˆ›å»ºadminè´¦æˆ·
- âœ… è®¾ç½®è´¦å·ï¼šadmin
- âœ… è®¾ç½®å¯†ç ï¼šadmin123
- âœ… è®¾ç½®çŠ¶æ€ï¼šæ¿€æ´»

### ç»“æœ
- âœ… adminå¯ä»¥æ­£å¸¸ç™»å½•
- âœ… è·å¾—ç®¡ç†å‘˜æƒé™
- âœ… ç³»ç»ŸåŠŸèƒ½æ­£å¸¸

---

## åä¸€ã€å¿«é€Ÿä¿®å¤æ¸…å• âœ…

- [x] å®šä½é—®é¢˜ï¼šadminè´¦æˆ·ä¸å­˜åœ¨
- [x] æ£€æŸ¥æ•°æ®åº“ï¼šç¡®è®¤agentsè¡¨
- [x] åˆ›å»ºadminè´¦æˆ·
- [x] æµ‹è¯•ç™»å½•æ¥å£
- [x] éªŒè¯ç™»å½•æˆåŠŸ
- [x] åˆ›å»ºä¿®å¤æŠ¥å‘Š
- [ ] å‰ç«¯é¡µé¢æµ‹è¯•
- [ ] ä¿®æ”¹é»˜è®¤å¯†ç ï¼ˆå»ºè®®ï¼‰

---

## åäºŒã€åç»­å»ºè®® ğŸ’¡

### ç«‹å³æ“ä½œ

1. âœ… **æµ‹è¯•ç™»å½•åŠŸèƒ½**
   - ä½¿ç”¨è´¦å·ï¼š`admin`
   - ä½¿ç”¨å¯†ç ï¼š`admin123`
   - éªŒè¯ç™»å½•æˆåŠŸ

2. âš ï¸ **ä¿®æ”¹é»˜è®¤å¯†ç **ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰
   - ç™»å½•åä¿®æ”¹å¯†ç 
   - ä½¿ç”¨å¼ºå¯†ç 
   - å¦¥å–„ä¿ç®¡å¯†ç 

### å¯é€‰ä¼˜åŒ–

3. **å®ç°å¯†ç åŠ å¯†**
   - ä½¿ç”¨bcrypt
   - åŠ å¯†å­˜å‚¨å¯†ç 
   - æå‡å®‰å…¨æ€§

4. **å‡çº§ä¸ºJWT**
   - æ›´å®‰å…¨çš„è®¤è¯
   - Tokenè¿‡æœŸç®¡ç†
   - åˆ·æ–°Tokenæœºåˆ¶

5. **æ·»åŠ æƒé™ç®¡ç†**
   - ç»†ç²’åº¦æƒé™æ§åˆ¶
   - è§’è‰²æƒé™åˆ†ç¦»
   - æ“ä½œæ—¥å¿—è®°å½•

---

## åä¸‰ã€ç™»å½•å‡­è¯ ğŸ”‘

### Adminè´¦æˆ·ï¼ˆæµ‹è¯•ç”¨ï¼‰

```
è´¦å·ï¼šadmin
å¯†ç ï¼šadmin123
```

**âš ï¸ é‡è¦æç¤º**ï¼š
- è¿™æ˜¯é»˜è®¤å¯†ç ï¼Œä»…ç”¨äºåˆæ¬¡ç™»å½•
- ç™»å½•åè¯·ç«‹å³ä¿®æ”¹å¯†ç 
- ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨é»˜è®¤å¯†ç 
- å¦¥å–„ä¿ç®¡ç®¡ç†å‘˜å‡­è¯

---

**ä¿®å¤çŠ¶æ€**ï¼šâœ… **å®Œæˆ**  
**éªŒè¯çŠ¶æ€**ï¼šâœ… **åç«¯æµ‹è¯•é€šè¿‡**  
**ä¸‹ä¸€æ­¥**ï¼šåœ¨ç™»å½•é¡µé¢æµ‹è¯•

**ç°åœ¨å¯ä»¥ä½¿ç”¨ admin/admin123 ç™»å½•ç³»ç»Ÿäº†ï¼** ğŸ‰

**è®°å¾—ç™»å½•åä¿®æ”¹å¯†ç ï¼** ğŸ”’
