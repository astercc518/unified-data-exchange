# 定价管理同步更新 - 完整测试指南

## 🎯 功能概述

本功能实现了**定价管理**和**资源中心**的数据价格同步更新：
- 在定价管理页面修改价格
- 自动批量更新资源中心的匹配数据
- 保存完整的定价历史记录
- 实时统计数据量

## 📋 测试准备

### 1. 启动开发服务器

```bash
cd /home/vue-element-admin
npm run dev
```

服务将运行在：`http://103.246.246.11:9528`

### 2. 测试账号

使用管理员账号登录（如果需要）

## 🧪 完整测试流程

### 测试方案 A：使用独立测试页面（推荐）

#### 步骤1：打开测试页面

在浏览器中访问：
```
http://103.246.246.11:9528/pricing-sync-test.html
```

或者直接打开本地文件：
```bash
# 在项目根目录
open pricing-sync-test.html
# 或
firefox pricing-sync-test.html
```

#### 步骤2：初始化测试数据

1. 点击 **"初始化测试数据"** 按钮
2. 系统将创建5条测试数据：
   - 孟加拉国 - 3天内 - 手机号码（50万条，成本0.04，销售0.05）
   - 孟加拉国 - 30天内 - 用户资料（80万条，成本0.03，销售0.04）
   - 孟加拉国 - 30天以上 - 电话号码（120万条，成本0.02，销售0.03）
   - 印度 - 3天内 - 手机号码（60万条，成本0.04，销售0.05）
   - 印度 - 30天内 - 用户资料（90万条，成本0.03，销售0.04）

3. 看到成功提示：✅ 初始化成功！已创建 5 条测试数据

#### 步骤3：查看当前数据

1. 点击 **"查看当前数据"** 按钮
2. 查看数据表格，确认：
   - 所有数据已正确创建
   - 价格信息正确显示
   - 数据量正确

#### 步骤4：模拟定价更新

1. 在下拉框中选择：
   - **国家**：孟加拉国 (BD)
   - **时效**：3天内
   
2. 输入新价格：
   - **新成本价**：0.035
   - **新销售价**：0.045

3. 点击 **"执行定价更新"** 按钮

4. 确认看到成功提示：
   ```
   ✅ 定价更新成功！
   更新条件：孟加拉国 - 3天内
   新成本价：0.035 U/条
   新销售价：0.045 U/条
   利润率：28.6%
   已更新 1 条数据
   ```

#### 步骤5：验证同步结果

1. 点击 **"验证同步结果"** 按钮

2. 确认看到：
   ```
   ✅ 同步验证通过！
   找到 1 条匹配数据，价格已全部更新
   ```

3. 查看数据详情，确认价格已更新

#### 步骤6：查看定价历史

1. 点击 **"查看定价历史"** 按钮

2. 确认历史记录包含刚才的变更：
   - 变更时间
   - 国家和时效
   - 价格变更前后对比
   - 操作人和备注

#### 步骤7：测试多条数据更新

1. 清空数据，重新初始化

2. 尝试更新 **孟加拉国** 的所有数据（不指定数据类型）
   - 应该更新该国家该时效的所有数据

3. 验证所有匹配数据都已更新

### 测试方案 B：在 Vue 应用中测试

#### 步骤1：上传测试数据

1. 访问数据上传页面：
   ```
   http://103.246.246.11:9528/#/data/upload
   ```

2. 创建测试文件 `test-data.txt`：
   ```bash
   # 创建一个包含1000行的测试文件
   for i in {1..1000}; do echo "8801700000$i"; done > test-data.txt
   ```

3. 填写上传表单：
   - **国家**：孟加拉国
   - **数据类型**：手机号码
   - **数据来源**：测试数据
   - **时效性**：3天内
   - **成本价**：0.04
   - **销售价**：0.05
   - **备注**：定价同步测试数据

4. 上传文件并提交

5. 确认看到成功提示

#### 步骤2：查看资源中心

1. 访问资源中心：
   ```
   http://103.246.246.11:9528/#/resource/center
   ```

2. 确认刚上传的数据已显示：
   - 国家：孟加拉国
   - 时效：3天内
   - 数据量：1000
   - 成本价：0.04 U/条
   - 销售价：0.05 U/条

#### 步骤3：修改定价

1. 访问定价管理页面：
   ```
   http://103.246.246.11:9528/#/data/pricing
   ```

2. 找到 **孟加拉国 - 3天内** 的定价项

3. 修改价格：
   - **成本价**：改为 `0.035`
   - **销售价**：改为 `0.047`

4. 点击该行的 **"保存"** 按钮

5. 确认看到成功消息：
   ```
   定价保存成功，已更新 1 条数据
   ```

#### 步骤4：验证资源中心价格更新

1. 切换回资源中心页面：
   ```
   http://103.246.246.11:9528/#/resource/center
   ```

2. 如果价格没有立即更新，点击 **"刷新数据"** 按钮

3. 确认数据价格已更新：
   - 销售价：0.047 U/条（已更新）

4. 打开浏览器控制台（F12），查看日志：
   ```
   🔄 开始更新资源中心定价: {...}
   🌍 国家代码: BD 国家名称: 孟加拉国
   ✅ 匹配到数据: 1 孟加拉国 3
   ✅ 定价更新完成，共更新 1 条数据
   ```

#### 步骤5：查看定价历史

1. 在定价管理页面向下滚动

2. 查看 **"定价历史记录"** 表格

3. 确认最新的一条记录显示：
   - 时间：刚才的操作时间
   - 国家：孟加拉国
   - 时效：3天内
   - 成本价变更：0.04 → 0.035
   - 销售价变更：0.05 → 0.047
   - 备注：批量更新定价，影响 1 条数据

## 📊 验证检查清单

### ✅ 功能验证

- [ ] 定价管理页面显示正常
- [ ] 可以修改成本价和销售价
- [ ] 点击保存按钮后显示成功消息
- [ ] 成功消息中显示更新的数据条数
- [ ] 利润率自动计算正确
- [ ] 定价历史记录已保存
- [ ] 资源中心价格已同步更新
- [ ] 刷新按钮可以重新加载数据
- [ ] 数据量统计正确

### ✅ 数据验证

打开浏览器控制台（F12），执行以下命令验证数据：

```javascript
// 1. 查看资源中心数据
const dataList = JSON.parse(localStorage.getItem('dataList') || '[]');
console.table(dataList.map(d => ({
  id: d.id,
  country: d.country,
  validity: d.validity,
  costPrice: d.costPrice,
  sellPrice: d.sellPrice,
  quantity: d.availableQuantity
})));

// 2. 查看定价历史
const history = JSON.parse(localStorage.getItem('pricingHistory') || '[]');
console.table(history);

// 3. 验证特定数据的价格
const bdData = dataList.filter(d => d.countryCode === 'BD' && d.validity === '3');
console.log('孟加拉国3天内数据:', bdData);
```

### ✅ 边界情况测试

- [ ] 测试更新不存在的国家/时效组合（应提示未找到数据）
- [ ] 测试同时有多条相同国家和时效的数据（应全部更新）
- [ ] 测试输入极小/极大的价格值
- [ ] 测试成本价大于销售价（利润率为负）
- [ ] 测试清空 localStorage 后的行为

## 🐛 常见问题排查

### 问题1：点击保存后没有反应

**排查步骤**：
1. 打开浏览器控制台（F12）
2. 查看是否有错误信息
3. 检查网络请求
4. 确认数据格式是否正确

### 问题2：资源中心价格没有更新

**解决方法**：
1. 点击资源中心的"刷新数据"按钮
2. 检查浏览器控制台日志
3. 验证 localStorage 中的数据：
   ```javascript
   localStorage.getItem('dataList')
   ```
4. 确认国家和时效是否完全匹配

### 问题3：定价历史记录消失

**原因**：
- 浏览器清除了缓存
- localStorage 被清空

**预防措施**：
- 定期导出重要数据
- 考虑使用后端API持久化

### 问题4：更新的数据条数不对

**检查点**：
1. 确认资源中心确实有匹配的数据
2. 查看控制台匹配日志
3. 检查国家代码映射是否正确
4. 验证时效代码格式

## 📝 测试记录模板

```
测试日期：____________________
测试人员：____________________
测试环境：____________________

测试结果：
□ 通过  □ 失败  □ 部分通过

详细说明：
1. 初始化数据：□ 成功  □ 失败
   - 创建数据条数：_______
   
2. 价格更新：□ 成功  □ 失败
   - 更新国家：_______
   - 更新时效：_______
   - 更新条数：_______
   
3. 同步验证：□ 成功  □ 失败
   - 资源中心价格已更新：□ 是  □ 否
   
4. 历史记录：□ 成功  □ 失败
   - 历史记录已保存：□ 是  □ 否

发现问题：
1. ________________________________________
2. ________________________________________
3. ________________________________________

建议改进：
1. ________________________________________
2. ________________________________________
3. ________________________________________
```

## 🎓 测试技巧

### 1. 使用浏览器开发工具

```javascript
// 监控 localStorage 变化
const originalSetItem = localStorage.setItem;
localStorage.setItem = function(key, value) {
  console.log(`📝 localStorage.setItem: ${key}`, value.substring(0, 100));
  originalSetItem.apply(this, arguments);
};
```

### 2. 批量测试脚本

```javascript
// 创建多条测试数据
function createTestData(count) {
  const dataList = [];
  const countries = [
    { name: '孟加拉国', code: 'BD' },
    { name: '印度', code: 'IN' },
    { name: '泰国', code: 'TH' }
  ];
  const validities = ['3', '30', '30+'];
  
  for (let i = 0; i < count; i++) {
    const country = countries[i % countries.length];
    const validity = validities[Math.floor(i / countries.length) % validities.length];
    dataList.push({
      id: i + 1,
      country: country.name,
      countryCode: country.code,
      validity: validity,
      dataType: '测试数据',
      source: '自动生成',
      availableQuantity: Math.floor(Math.random() * 100000) + 10000,
      operators: [],
      sellPrice: validity === '3' ? 0.05 : (validity === '30' ? 0.04 : 0.03),
      costPrice: validity === '3' ? 0.04 : (validity === '30' ? 0.03 : 0.02),
      uploadTime: Date.now(),
      status: 'available'
    });
  }
  
  localStorage.setItem('dataList', JSON.stringify(dataList));
  console.log(`✅ 创建了 ${count} 条测试数据`);
}

// 使用：createTestData(20);
```

### 3. 快速清理数据

```javascript
// 清空所有测试数据
function clearAllTestData() {
  localStorage.removeItem('dataList');
  localStorage.removeItem('pricingHistory');
  console.log('🗑️ 已清空所有测试数据');
}
```

## 📈 性能测试

### 测试大量数据的更新性能

```javascript
// 创建1000条数据
createTestData(1000);

// 测试更新性能
console.time('批量更新');
// 执行定价更新操作
console.timeEnd('批量更新');
```

预期结果：
- 1000条数据更新应在 100ms 内完成
- localStorage 写入应在 50ms 内完成

## ✨ 总结

完成以上测试后，你应该能够：
1. ✅ 确认定价管理可以正常修改价格
2. ✅ 验证资源中心数据会同步更新
3. ✅ 查看完整的定价历史记录
4. ✅ 理解数据匹配和更新逻辑
5. ✅ 掌握调试和排查方法

---

**测试完成**：请在相关位置签字确认  
**日期**：_______________  
**签名**：_______________
# 定价管理同步更新 - 完整测试指南

## 🎯 功能概述

本功能实现了**定价管理**和**资源中心**的数据价格同步更新：
- 在定价管理页面修改价格
- 自动批量更新资源中心的匹配数据
- 保存完整的定价历史记录
- 实时统计数据量

## 📋 测试准备

### 1. 启动开发服务器

```bash
cd /home/vue-element-admin
npm run dev
```

服务将运行在：`http://103.246.246.11:9528`

### 2. 测试账号

使用管理员账号登录（如果需要）

## 🧪 完整测试流程

### 测试方案 A：使用独立测试页面（推荐）

#### 步骤1：打开测试页面

在浏览器中访问：
```
http://103.246.246.11:9528/pricing-sync-test.html
```

或者直接打开本地文件：
```bash
# 在项目根目录
open pricing-sync-test.html
# 或
firefox pricing-sync-test.html
```

#### 步骤2：初始化测试数据

1. 点击 **"初始化测试数据"** 按钮
2. 系统将创建5条测试数据：
   - 孟加拉国 - 3天内 - 手机号码（50万条，成本0.04，销售0.05）
   - 孟加拉国 - 30天内 - 用户资料（80万条，成本0.03，销售0.04）
   - 孟加拉国 - 30天以上 - 电话号码（120万条，成本0.02，销售0.03）
   - 印度 - 3天内 - 手机号码（60万条，成本0.04，销售0.05）
   - 印度 - 30天内 - 用户资料（90万条，成本0.03，销售0.04）

3. 看到成功提示：✅ 初始化成功！已创建 5 条测试数据

#### 步骤3：查看当前数据

1. 点击 **"查看当前数据"** 按钮
2. 查看数据表格，确认：
   - 所有数据已正确创建
   - 价格信息正确显示
   - 数据量正确

#### 步骤4：模拟定价更新

1. 在下拉框中选择：
   - **国家**：孟加拉国 (BD)
   - **时效**：3天内
   
2. 输入新价格：
   - **新成本价**：0.035
   - **新销售价**：0.045

3. 点击 **"执行定价更新"** 按钮

4. 确认看到成功提示：
   ```
   ✅ 定价更新成功！
   更新条件：孟加拉国 - 3天内
   新成本价：0.035 U/条
   新销售价：0.045 U/条
   利润率：28.6%
   已更新 1 条数据
   ```

#### 步骤5：验证同步结果

1. 点击 **"验证同步结果"** 按钮

2. 确认看到：
   ```
   ✅ 同步验证通过！
   找到 1 条匹配数据，价格已全部更新
   ```

3. 查看数据详情，确认价格已更新

#### 步骤6：查看定价历史

1. 点击 **"查看定价历史"** 按钮

2. 确认历史记录包含刚才的变更：
   - 变更时间
   - 国家和时效
   - 价格变更前后对比
   - 操作人和备注

#### 步骤7：测试多条数据更新

1. 清空数据，重新初始化

2. 尝试更新 **孟加拉国** 的所有数据（不指定数据类型）
   - 应该更新该国家该时效的所有数据

3. 验证所有匹配数据都已更新

### 测试方案 B：在 Vue 应用中测试

#### 步骤1：上传测试数据

1. 访问数据上传页面：
   ```
   http://103.246.246.11:9528/#/data/upload
   ```

2. 创建测试文件 `test-data.txt`：
   ```bash
   # 创建一个包含1000行的测试文件
   for i in {1..1000}; do echo "8801700000$i"; done > test-data.txt
   ```

3. 填写上传表单：
   - **国家**：孟加拉国
   - **数据类型**：手机号码
   - **数据来源**：测试数据
   - **时效性**：3天内
   - **成本价**：0.04
   - **销售价**：0.05
   - **备注**：定价同步测试数据

4. 上传文件并提交

5. 确认看到成功提示

#### 步骤2：查看资源中心

1. 访问资源中心：
   ```
   http://103.246.246.11:9528/#/resource/center
   ```

2. 确认刚上传的数据已显示：
   - 国家：孟加拉国
   - 时效：3天内
   - 数据量：1000
   - 成本价：0.04 U/条
   - 销售价：0.05 U/条

#### 步骤3：修改定价

1. 访问定价管理页面：
   ```
   http://103.246.246.11:9528/#/data/pricing
   ```

2. 找到 **孟加拉国 - 3天内** 的定价项

3. 修改价格：
   - **成本价**：改为 `0.035`
   - **销售价**：改为 `0.047`

4. 点击该行的 **"保存"** 按钮

5. 确认看到成功消息：
   ```
   定价保存成功，已更新 1 条数据
   ```

#### 步骤4：验证资源中心价格更新

1. 切换回资源中心页面：
   ```
   http://103.246.246.11:9528/#/resource/center
   ```

2. 如果价格没有立即更新，点击 **"刷新数据"** 按钮

3. 确认数据价格已更新：
   - 销售价：0.047 U/条（已更新）

4. 打开浏览器控制台（F12），查看日志：
   ```
   🔄 开始更新资源中心定价: {...}
   🌍 国家代码: BD 国家名称: 孟加拉国
   ✅ 匹配到数据: 1 孟加拉国 3
   ✅ 定价更新完成，共更新 1 条数据
   ```

#### 步骤5：查看定价历史

1. 在定价管理页面向下滚动

2. 查看 **"定价历史记录"** 表格

3. 确认最新的一条记录显示：
   - 时间：刚才的操作时间
   - 国家：孟加拉国
   - 时效：3天内
   - 成本价变更：0.04 → 0.035
   - 销售价变更：0.05 → 0.047
   - 备注：批量更新定价，影响 1 条数据

## 📊 验证检查清单

### ✅ 功能验证

- [ ] 定价管理页面显示正常
- [ ] 可以修改成本价和销售价
- [ ] 点击保存按钮后显示成功消息
- [ ] 成功消息中显示更新的数据条数
- [ ] 利润率自动计算正确
- [ ] 定价历史记录已保存
- [ ] 资源中心价格已同步更新
- [ ] 刷新按钮可以重新加载数据
- [ ] 数据量统计正确

### ✅ 数据验证

打开浏览器控制台（F12），执行以下命令验证数据：

```javascript
// 1. 查看资源中心数据
const dataList = JSON.parse(localStorage.getItem('dataList') || '[]');
console.table(dataList.map(d => ({
  id: d.id,
  country: d.country,
  validity: d.validity,
  costPrice: d.costPrice,
  sellPrice: d.sellPrice,
  quantity: d.availableQuantity
})));

// 2. 查看定价历史
const history = JSON.parse(localStorage.getItem('pricingHistory') || '[]');
console.table(history);

// 3. 验证特定数据的价格
const bdData = dataList.filter(d => d.countryCode === 'BD' && d.validity === '3');
console.log('孟加拉国3天内数据:', bdData);
```

### ✅ 边界情况测试

- [ ] 测试更新不存在的国家/时效组合（应提示未找到数据）
- [ ] 测试同时有多条相同国家和时效的数据（应全部更新）
- [ ] 测试输入极小/极大的价格值
- [ ] 测试成本价大于销售价（利润率为负）
- [ ] 测试清空 localStorage 后的行为

## 🐛 常见问题排查

### 问题1：点击保存后没有反应

**排查步骤**：
1. 打开浏览器控制台（F12）
2. 查看是否有错误信息
3. 检查网络请求
4. 确认数据格式是否正确

### 问题2：资源中心价格没有更新

**解决方法**：
1. 点击资源中心的"刷新数据"按钮
2. 检查浏览器控制台日志
3. 验证 localStorage 中的数据：
   ```javascript
   localStorage.getItem('dataList')
   ```
4. 确认国家和时效是否完全匹配

### 问题3：定价历史记录消失

**原因**：
- 浏览器清除了缓存
- localStorage 被清空

**预防措施**：
- 定期导出重要数据
- 考虑使用后端API持久化

### 问题4：更新的数据条数不对

**检查点**：
1. 确认资源中心确实有匹配的数据
2. 查看控制台匹配日志
3. 检查国家代码映射是否正确
4. 验证时效代码格式

## 📝 测试记录模板

```
测试日期：____________________
测试人员：____________________
测试环境：____________________

测试结果：
□ 通过  □ 失败  □ 部分通过

详细说明：
1. 初始化数据：□ 成功  □ 失败
   - 创建数据条数：_______
   
2. 价格更新：□ 成功  □ 失败
   - 更新国家：_______
   - 更新时效：_______
   - 更新条数：_______
   
3. 同步验证：□ 成功  □ 失败
   - 资源中心价格已更新：□ 是  □ 否
   
4. 历史记录：□ 成功  □ 失败
   - 历史记录已保存：□ 是  □ 否

发现问题：
1. ________________________________________
2. ________________________________________
3. ________________________________________

建议改进：
1. ________________________________________
2. ________________________________________
3. ________________________________________
```

## 🎓 测试技巧

### 1. 使用浏览器开发工具

```javascript
// 监控 localStorage 变化
const originalSetItem = localStorage.setItem;
localStorage.setItem = function(key, value) {
  console.log(`📝 localStorage.setItem: ${key}`, value.substring(0, 100));
  originalSetItem.apply(this, arguments);
};
```

### 2. 批量测试脚本

```javascript
// 创建多条测试数据
function createTestData(count) {
  const dataList = [];
  const countries = [
    { name: '孟加拉国', code: 'BD' },
    { name: '印度', code: 'IN' },
    { name: '泰国', code: 'TH' }
  ];
  const validities = ['3', '30', '30+'];
  
  for (let i = 0; i < count; i++) {
    const country = countries[i % countries.length];
    const validity = validities[Math.floor(i / countries.length) % validities.length];
    dataList.push({
      id: i + 1,
      country: country.name,
      countryCode: country.code,
      validity: validity,
      dataType: '测试数据',
      source: '自动生成',
      availableQuantity: Math.floor(Math.random() * 100000) + 10000,
      operators: [],
      sellPrice: validity === '3' ? 0.05 : (validity === '30' ? 0.04 : 0.03),
      costPrice: validity === '3' ? 0.04 : (validity === '30' ? 0.03 : 0.02),
      uploadTime: Date.now(),
      status: 'available'
    });
  }
  
  localStorage.setItem('dataList', JSON.stringify(dataList));
  console.log(`✅ 创建了 ${count} 条测试数据`);
}

// 使用：createTestData(20);
```

### 3. 快速清理数据

```javascript
// 清空所有测试数据
function clearAllTestData() {
  localStorage.removeItem('dataList');
  localStorage.removeItem('pricingHistory');
  console.log('🗑️ 已清空所有测试数据');
}
```

## 📈 性能测试

### 测试大量数据的更新性能

```javascript
// 创建1000条数据
createTestData(1000);

// 测试更新性能
console.time('批量更新');
// 执行定价更新操作
console.timeEnd('批量更新');
```

预期结果：
- 1000条数据更新应在 100ms 内完成
- localStorage 写入应在 50ms 内完成

## ✨ 总结

完成以上测试后，你应该能够：
1. ✅ 确认定价管理可以正常修改价格
2. ✅ 验证资源中心数据会同步更新
3. ✅ 查看完整的定价历史记录
4. ✅ 理解数据匹配和更新逻辑
5. ✅ 掌握调试和排查方法

---

**测试完成**：请在相关位置签字确认  
**日期**：_______________  
**签名**：_______________
