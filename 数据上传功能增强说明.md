# 数据上传功能增强说明

## 📋 概述

本次更新对数据管理的上传功能进行了全面增强，增加了以下三大核心功能：

1. **上传时自动去重** - 自动检测并去除重复数据
2. **国码自动校验** - 验证上传数据与用户基本信息中的国码是否一致
3. **数据预览功能** - 上传成功后显示前20条数据预览

---

## 🎯 功能详情

### 1. 上传时自动去重

**功能说明**：
- 上传文件时，系统自动检测并去除重复的手机号
- 去重后的数据自动保存，无需手动处理
- 显示去重统计信息（原始条数、最终条数、去除条数）

**技术实现**：
- 使用 `Set` 数据结构进行高效去重
- 在 `DataProcessor.processUpload()` 方法中实现
- 去重操作在文件验证后立即执行

**用户体验**：
```
✅ 文件上传成功！已自动去除 125 条重复数据
原始数据：10,000 条
最终数据：9,875 条
```

---

### 2. 国码自动校验

**功能说明**：
- 检测上传文件中的国码（如 +86、+1 等）
- 与用户基本信息中设置的国码进行比对
- 如果不一致，自动拦截上传并提示错误

**校验逻辑**：
1. 读取用户个人信息中的 `country_code` 字段
2. 分析上传文件的前100行数据，检测国码
3. 计算国码出现频率，判断主要国码
4. 如果检测到的国码与用户设置不一致，返回错误

**错误提示示例**：
```
❌ 国码校验失败！
上传数据的国码为 +1，但您的基本信息中设置的国码为 +86，请检查后重新上传
```

**技术细节**：
- 使用正则表达式 `/^\+(\d{1,4})/` 匹配国码
- 置信度阈值：50%（超过一半的数据有国码才认为有效）
- 支持 1-4 位数字的国码（如 +1、+86、+852、+1234）

---

### 3. 数据预览功能

**功能说明**：
- 上传成功后自动弹出预览对话框
- 显示文件的基本信息和统计数据
- 展示前20条数据供用户确认

**预览内容**：

#### 基本信息
- 文件名称
- 原始数据条数
- 最终数据条数（去重后）
- 去除的重复条数

#### 国码检测
- 检测到的国码
- 检测置信度（百分比）

#### 数据预览表格
- 序号（#）
- 数据内容（前20条）
- 代码高亮显示

**界面示例**：
```
┌─────────────────────────────────────┐
│         数据预览                     │
├─────────────────────────────────────┤
│ ✅ 已自动去除 125 条重复数据          │
│ ℹ️  检测到国码：+86 (置信度：95.5%)   │
│                                     │
│ 文件名：客户数据.txt                  │
│ 原始：10,000 条  最终：9,875 条       │
│ 去重：125 条                         │
│                                     │
│ ────── 前20条数据预览 ──────         │
│ #   数据                             │
│ 1   +8613800138000                  │
│ 2   +8613900139000                  │
│ ...                                 │
└─────────────────────────────────────┘
```

---

## 🔧 技术实现

### 后端修改

#### 1. 数据库模型更新

**文件**：`/backend/models/User.js` 和 `/backend/models/Agent.js`

添加了国码相关字段：
```javascript
country_code: {
  type: DataTypes.STRING(10),
  allowNull: true,
  comment: '国家代码(如：+86)'
},
country_name: {
  type: DataTypes.STRING(50),
  allowNull: true,
  comment: '国家名称'
}
```

#### 2. 数据处理工具类增强

**文件**：`/backend/utils/dataProcessor.js`

新增方法：

**`detectCountryCode(filePath, sampleSize)`**
- 检测文件中的国码
- 返回检测结果、置信度和样本数据

**`processUpload(inputPath, outputPath, options)`**
- 综合处理上传文件
- 支持自动去重和国码检测
- 返回处理结果和预览数据

```javascript
static async processUpload(inputPath, outputPath, options = {}) {
  const { autoDeduplicate = true, detectCode = true } = options;
  
  let lines = await this.readLines(inputPath);
  const originalCount = lines.length;
  
  // 自动去重
  let duplicateCount = 0;
  if (autoDeduplicate) {
    const uniqueLines = [...new Set(lines)];
    duplicateCount = originalCount - uniqueLines.length;
    lines = uniqueLines;
    
    if (outputPath && duplicateCount > 0) {
      await this.writeLines(outputPath, lines);
    }
  }
  
  // 检测国码
  let codeDetection = null;
  if (detectCode) {
    // ... 国码检测逻辑 ...
  }
  
  return {
    originalCount,
    finalCount: lines.length,
    duplicateCount,
    codeDetection,
    preview: lines.slice(0, 20)
  };
}
```

#### 3. 上传路由增强

**文件**：`/backend/routes/dataProcessing.js`

**主要改动**：

1. **调用新的处理方法**：
```javascript
const processResult = await DataProcessor.processUpload(
  filePath, 
  filePath,
  { autoDeduplicate: true, detectCode: true }
);
```

2. **国码校验**：
```javascript
const userCountryCode = user.country_code;

if (userCountryCode && processResult.codeDetection.hasCode) {
  const detectedCode = processResult.codeDetection.countryCode;
  
  if (detectedCode && detectedCode !== userCountryCode) {
    await fs.unlink(filePath);
    return res.status(400).json({
      success: false,
      message: `国码不一致！上传数据的国码为 ${detectedCode}，但您的基本信息中设置的国码为 ${userCountryCode}，请检查后重新上传`,
      code: 'COUNTRY_CODE_MISMATCH',
      data: {
        userCountryCode,
        detectedCode,
        confidence: processResult.codeDetection.confidence
      }
    });
  }
}
```

3. **返回增强的数据**：
```javascript
res.json({
  success: true,
  message: processResult.duplicateCount > 0 
    ? `文件上传成功！已自动去除 ${processResult.duplicateCount} 条重复数据`
    : '文件上传成功',
  data: {
    id: fileRecord.id,
    filename: originalFilename,
    size: fileSize,
    lineCount: processResult.finalCount,
    originalCount: processResult.originalCount,
    duplicateCount: processResult.duplicateCount,
    uploadTime: uploadTime,
    expireTime: expireTime,
    preview: processResult.preview,
    codeDetection: processResult.codeDetection
  }
});
```

---

### 前端修改

#### 1. 上传对话框更新

**文件**：`/src/views/data/processing.vue`

**增加功能提示**：
```html
<div slot="tip" class="el-upload__tip">
  支持同时上传多个 TXT 文件，单个文件不超过100MB<br>
  <span style="color: #E6A23C">✔ 上传时自动去除重复数据</span><br>
  <span style="color: #E6A23C">✔ 自动检验数据国码是否与基本信息一致</span>
</div>
```

#### 2. 新增预览对话框

**模板部分**：
```html
<el-dialog title="数据预览" :visible.sync="previewDialogVisible" width="800px">
  <!-- 去重提示 -->
  <el-alert
    v-if="previewData.duplicateCount > 0"
    :title="`已自动去除 ${formatNumber(previewData.duplicateCount)} 条重复数据`"
    type="success"
    :closable="false"
    show-icon
  />
  
  <!-- 国码检测提示 -->
  <el-alert
    v-if="previewData.codeDetection && previewData.codeDetection.hasCode"
    :title="`检测到国码：${previewData.codeDetection.countryCode}`"
    type="info"
    :closable="false"
    show-icon
  />

  <!-- 统计信息 -->
  <div class="preview-info">
    <el-row :gutter="20">
      <el-col :span="8">
        <span class="info-label">文件名：</span>
        <span>{{ previewData.filename }}</span>
      </el-col>
      <el-col :span="8">
        <el-tag type="success">原始：{{ formatNumber(previewData.originalCount) }} 条</el-tag>
        <el-tag type="primary">最终：{{ formatNumber(previewData.finalCount) }} 条</el-tag>
      </el-col>
      <el-col :span="8">
        <el-tag v-if="previewData.duplicateCount > 0" type="warning">
          去重：{{ formatNumber(previewData.duplicateCount) }} 条
        </el-tag>
      </el-col>
    </el-row>
  </div>

  <!-- 数据预览表格 -->
  <el-table :data="previewData.preview" border stripe max-height="400">
    <el-table-column type="index" label="#" width="60" />
    <el-table-column label="数据">
      <template slot-scope="{row}">
        <code>{{ row }}</code>
      </template>
    </el-table-column>
  </el-table>
</el-dialog>
```

**数据定义**：
```javascript
data() {
  return {
    previewDialogVisible: false,
    previewData: {
      filename: '',
      originalCount: 0,
      finalCount: 0,
      duplicateCount: 0,
      preview: [],
      codeDetection: null
    }
  }
}
```

#### 3. 上传成功处理增强

```javascript
handleUploadSuccess(response) {
  if (response.success) {
    this.$message.success(response.message)
    
    // 设置预览数据
    this.previewData = {
      filename: response.data.filename,
      originalCount: response.data.originalCount,
      finalCount: response.data.lineCount,
      duplicateCount: response.data.duplicateCount || 0,
      preview: response.data.preview || [],
      codeDetection: response.data.codeDetection
    }
    
    // 打开预览对话框
    this.previewDialogVisible = true
    
    // 刷新文件列表
    this.fetchFileList()
  } else {
    // 处理国码不一致错误
    if (response.code === 'COUNTRY_CODE_MISMATCH') {
      this.$alert(
        response.message,
        '国码校验失败',
        {
          type: 'error',
          confirmButtonText: '我知道了'
        }
      )
    } else {
      this.$message.error('上传失败: ' + response.message)
    }
  }
}
```

#### 4. 样式增强

```scss
.preview-info {
  margin-bottom: 20px;
  padding: 15px;
  background-color: #f5f7fa;
  border-radius: 4px;

  .info-label {
    font-weight: 600;
    color: #606266;
    margin-right: 10px;
  }
}

.preview-content {
  code {
    font-family: 'Courier New', Courier, monospace;
    font-size: 13px;
    color: #e96900;
    background-color: #f8f8f8;
    padding: 2px 6px;
    border-radius: 3px;
  }
}
```

---

## 📊 数据流程图

```
用户上传文件
    ↓
验证文件格式（.txt）
    ↓
读取文件内容
    ↓
自动去重处理
    ↓
检测国码
    ↓
校验国码 ─→ 不一致 ─→ 拦截上传，返回错误
    ↓ 一致或无国码
保存文件记录
    ↓
返回处理结果
    ↓
前端显示预览对话框
```

---

## 🎨 用户界面

### 上传对话框

```
┌─────────────────────────────────────┐
│      上传数据文件                     │
├─────────────────────────────────────┤
│                                     │
│        [📁 拖拽或点击上传]            │
│                                     │
│   支持同时上传多个 TXT 文件            │
│   单个文件不超过100MB                 │
│   ✔ 上传时自动去除重复数据             │
│   ✔ 自动检验数据国码是否与基本信息一致  │
│                                     │
│              [关闭]                  │
└─────────────────────────────────────┘
```

### 预览对话框

```
┌──────────────────────────────────────┐
│          数据预览                     │
├──────────────────────────────────────┤
│ ✅ 已自动去除 125 条重复数据           │
│ ℹ️  检测到国码：+86 (置信度：95.5%)    │
│                                      │
│ 文件名：测试数据.txt                   │
│ [原始：10,000 条] [最终：9,875 条]     │
│ [去重：125 条]                        │
│                                      │
│ ────── 前20条数据预览 ──────          │
│ ┌────┬────────────────────┐          │
│ │ #  │ 数据                │          │
│ ├────┼────────────────────┤          │
│ │ 1  │ +8613800138000     │          │
│ │ 2  │ +8613900139000     │          │
│ │ 3  │ +8614000140000     │          │
│ │... │ ...                │          │
│ └────┴────────────────────┘          │
│                                      │
│              [关闭]                   │
└──────────────────────────────────────┘
```

### 国码校验失败提示

```
┌──────────────────────────────────────┐
│      ⚠️ 国码校验失败                  │
├──────────────────────────────────────┤
│                                      │
│  国码不一致！                          │
│  上传数据的国码为 +1                   │
│  但您的基本信息中设置的国码为 +86       │
│  请检查后重新上传                      │
│                                      │
│           [我知道了]                  │
└──────────────────────────────────────┘
```

---

## ⚙️ 配置说明

### 国码检测参数

```javascript
// 样本大小：检测前100行
const SAMPLE_SIZE = 100;

// 置信度阈值：50%
const CONFIDENCE_THRESHOLD = 0.5;

// 国码正则：支持1-4位数字
const CODE_PATTERN = /^\+(\d{1,4})/;
```

### 去重策略

```javascript
// 使用 Set 自动去重
const uniqueLines = [...new Set(lines)];

// 计算去重数量
const duplicateCount = originalCount - uniqueLines.length;
```

### 预览设置

```javascript
// 预览数据条数：前20条
const PREVIEW_SIZE = 20;

// 预览表格最大高度：400px
max-height="400"
```

---

## 🧪 测试场景

### 场景1：正常上传（有重复数据）

**测试数据**：
```
+8613800138000
+8613900139000
+8613800138000  （重复）
+8614000140000
+8613900139000  （重复）
```

**预期结果**：
- ✅ 上传成功
- ✅ 显示去重提示：已自动去除 2 条重复数据
- ✅ 原始 5 条，最终 3 条
- ✅ 显示预览对话框

---

### 场景2：国码不一致

**用户设置**：country_code = "+86"

**测试数据**：
```
+18001234567
+18009876543
+18005551234
```

**预期结果**：
- ❌ 上传失败
- ❌ 显示错误提示：国码不一致！上传数据的国码为 +1，但您的基本信息中设置的国码为 +86
- ❌ 文件被删除，不保存到数据库

---

### 场景3：无国码数据

**测试数据**：
```
13800138000
13900139000
14000140000
```

**预期结果**：
- ✅ 上传成功
- ✅ 不进行国码校验（因为数据中无国码）
- ✅ 显示预览对话框
- ℹ️ 不显示国码检测信息

---

### 场景4：混合国码数据

**测试数据**：
```
+8613800138000
+8613900139000
13800138000     （无国码）
+8614000140000
```

**预期结果**：
- ✅ 上传成功
- ℹ️ 检测到国码：+86（置信度：75%）
- ✅ 如果用户设置为 +86，校验通过
- ✅ 显示预览对话框

---

## 📝 注意事项

### 1. 数据库字段

需要确保数据库中已添加 `country_code` 和 `country_name` 字段。如果是已有系统，需要手动执行 ALTER TABLE 语句：

```sql
-- 用户表
ALTER TABLE users 
ADD COLUMN country_code VARCHAR(10) NULL COMMENT '国家代码(如：+86)',
ADD COLUMN country_name VARCHAR(50) NULL COMMENT '国家名称';

-- 代理表
ALTER TABLE agents 
ADD COLUMN country_code VARCHAR(10) NULL COMMENT '国家代码(如：+86)',
ADD COLUMN country_name VARCHAR(50) NULL COMMENT '国家名称';
```

### 2. 用户基本信息设置

用户需要在个人信息中设置国码，否则不会进行国码校验。建议在用户管理和个人资料页面添加国码选择功能。

### 3. 国码格式

- 支持格式：`+86`、`+1`、`+852` 等
- 必须以 `+` 开头
- 支持 1-4 位数字
- 不支持的格式：`86`、`0086`、`+086` 等

### 4. 去重逻辑

- 基于完全匹配去重（包括国码）
- `+8613800138000` 和 `13800138000` 被视为不同数据
- 大小写敏感

### 5. 性能考虑

- 去重使用内存操作，大文件可能占用较多内存
- 国码检测只分析前100行，减少性能开销
- 预览只显示前20条数据

---

## 🔍 故障排查

### 问题1：上传后没有显示预览对话框

**可能原因**：
- 前端版本未更新
- 浏览器缓存

**解决方案**：
```bash
# 清除浏览器缓存
Ctrl + Shift + Delete

# 或强制刷新
Ctrl + F5
```

---

### 问题2：国码校验总是失败

**可能原因**：
- 用户基本信息中没有设置国码
- 国码格式不正确

**解决方案**：
1. 检查用户表中的 `country_code` 字段
2. 确保格式为 `+86` 而不是 `86`
3. 如果用户没有设置，不会进行校验

---

### 问题3：去重后数据丢失

**可能原因**：
- 这是正常现象，重复数据被去除了

**解决方案**：
- 检查原始文件是否有重复
- 查看预览对话框中的统计信息
- 如需保留重复数据，暂时不支持（功能设计如此）

---

## 🚀 后续优化建议

1. **可配置去重**：允许用户选择是否自动去重
2. **国码修正**：自动为无国码数据添加用户设置的国码
3. **更多统计**：显示数据分布、国码分布等详细信息
4. **导出报告**：生成上传数据的详细分析报告
5. **批量上传**：支持拖拽多个文件同时上传
6. **进度显示**：大文件上传时显示进度条

---

## 📚 相关文件清单

### 后端文件
- `/backend/models/User.js` - 用户模型（添加国码字段）
- `/backend/models/Agent.js` - 代理模型（添加国码字段）
- `/backend/utils/dataProcessor.js` - 数据处理工具类（核心逻辑）
- `/backend/routes/dataProcessing.js` - 数据处理路由（上传接口）

### 前端文件
- `/src/views/data/processing.vue` - 数据处理页面（主界面）

### 配置文件
- 无需额外配置文件

---

## ✅ 验收标准

1. ✅ 上传文件自动去重
2. ✅ 显示去重统计信息
3. ✅ 检测数据中的国码
4. ✅ 校验国码与用户设置是否一致
5. ✅ 国码不一致时拦截上传
6. ✅ 上传成功后显示预览对话框
7. ✅ 预览显示前20条数据
8. ✅ 预览显示统计信息
9. ✅ 预览显示国码检测结果
10. ✅ 所有功能无报错

---

## 📞 技术支持

如有问题，请检查：
1. 后端服务是否正常运行
2. 数据库字段是否已添加
3. 前端代码是否已更新
4. 浏览器缓存是否已清除

---

**更新时间**：2025-10-15  
**版本**：v1.0.0  
**状态**：✅ 已完成并测试通过
