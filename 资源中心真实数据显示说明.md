# èµ„æºä¸­å¿ƒçœŸå®æ•°æ®æ˜¾ç¤ºè¯´æ˜

## âœ… ä¿®æ”¹å®Œæˆ

å·²æˆåŠŸç§»é™¤æ‰€æœ‰é¡µé¢ä¸­çš„ç¡¬ç¼–ç å‡æ•°æ®ï¼Œç¡®ä¿**èµ„æºä¸­å¿ƒæ˜¾ç¤ºçš„éƒ½æ˜¯ä»æ•°æ®åº“è·å–çš„çœŸå®ä¿¡æ¯**ã€‚

---

## ğŸ“‹ ä¿®æ”¹å†…å®¹

### 1. èµ„æºä¸­å¿ƒé¡µé¢ (`center.vue`)

**ä¿®æ”¹ä½ç½®**: `/home/vue-element-admin/src/views/resource/center.vue` ç¬¬338-340è¡Œ

**ä¿®æ”¹å‰**:
```javascript
data() {
  return {
    userBalance: 1580.50,     // âŒ ç¡¬ç¼–ç çš„å‡æ•°æ®
    totalPurchased: 850000,   // âŒ ç¡¬ç¼–ç çš„å‡æ•°æ®
    totalSpent: 2420.30,      // âŒ ç¡¬ç¼–ç çš„å‡æ•°æ®
    // ...
  }
}
```

**ä¿®æ”¹å**:
```javascript
data() {
  return {
    userBalance: 0,           // âœ… åˆå§‹ä¸º0ï¼Œç­‰å¾…APIåŠ è½½çœŸå®æ•°æ®
    totalPurchased: 0,        // âœ… åˆå§‹ä¸º0ï¼Œç­‰å¾…APIåŠ è½½çœŸå®æ•°æ®
    totalSpent: 0,            // âœ… åˆå§‹ä¸º0ï¼Œç­‰å¾…APIåŠ è½½çœŸå®æ•°æ®
    // ...
  }
}
```

---

### 2. è´­ä¹°é¡µé¢ (`purchase.vue`)

**ä¿®æ”¹ä½ç½®**: `/home/vue-element-admin/src/views/resource/purchase.vue` ç¬¬218è¡Œ

**ä¿®æ”¹å‰**:
```javascript
data() {
  return {
    dataInfo: null,
    userBalance: 1580.50,     // âŒ ç¡¬ç¼–ç çš„å‡æ•°æ®
    // ...
  }
}
```

**ä¿®æ”¹å**:
```javascript
data() {
  return {
    dataInfo: null,
    userBalance: 0,           // âœ… åˆå§‹ä¸º0ï¼Œç­‰å¾…åŠ è½½çœŸå®æ•°æ®
    // ...
  }
}
```

---

### 3. è®¢é˜…ä¸­å¿ƒé¡µé¢ (`subscription.vue`)

**çŠ¶æ€**: âœ… ä¹‹å‰å·²ä¿®æ”¹ï¼Œæ— éœ€å†æ¬¡å¤„ç†

**å½“å‰å€¼**:
```javascript
data() {
  return {
    userBalance: 0,           // âœ… å·²ç»æ˜¯0
    totalPurchased: 0,        // âœ… å·²ç»æ˜¯0
    totalSpent: 0,            // âœ… å·²ç»æ˜¯0
    // ...
  }
}
```

---

## ğŸ¯ æ•°æ®åŠ è½½æœºåˆ¶

### èµ„æºä¸­å¿ƒçš„æ•°æ®æ¥æº

ç°åœ¨èµ„æºä¸­å¿ƒçš„ç»Ÿè®¡æ•°æ®**å®Œå…¨ä¾èµ–çœŸå®çš„æ•°æ®åº“æŸ¥è¯¢**ï¼š

```javascript
// åœ¨ created() ç”Ÿå‘½å‘¨æœŸä¸­è‡ªåŠ¨åŠ è½½
created() {
  this.getList()
  this.loadCustomerInfo()
  this.loadAccountStats()  // ğŸ”¥ ä»åç«¯APIè·å–çœŸå®ç»Ÿè®¡æ•°æ®
  this.initCountryData()
}
```

### APIè°ƒç”¨æµç¨‹

```javascript
async loadAccountStats() {
  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  const userInfo = this.$store.getters.userInfo
  const userType = userInfo.type || 'customer'
  const userId = userInfo.id

  // è°ƒç”¨åç«¯APIè·å–çœŸå®ç»Ÿè®¡æ•°æ®
  const response = await request({
    method: 'GET',
    url: `/api/stats/resource-center/${userType}/${userId}`
  })

  // æ›´æ–°é¡µé¢æ˜¾ç¤ºçš„æ•°æ®
  if (response.success && response.data) {
    this.userBalance = parseFloat(response.data.totalBalance || 0)
    this.totalPurchased = parseInt(response.data.totalPurchased || 0)
    this.totalSpent = parseFloat(response.data.totalSpent || 0)
  }
}
```

---

## ğŸ” ä¸åŒè§’è‰²çœ‹åˆ°çš„çœŸå®æ•°æ®

### 1ï¸âƒ£ ç®¡ç†å‘˜ (Admin)

æ˜¾ç¤º**æ‰€æœ‰å®¢æˆ·çš„æ€»é¢**ï¼š

- **è´¦æˆ·ä½™é¢æ€»é¢**: æ‰€æœ‰å®¢æˆ·çš„ `account_balance` æ±‚å’Œ
- **å·²è´­ä¹°æ•°æ®æ€»é‡**: æ‰€æœ‰è®¢å•çš„ `quantity` æ±‚å’Œ
- **ç´¯è®¡æ¶ˆè´¹æ€»é¢**: æ‰€æœ‰è®¢å•çš„ `total_amount` æ±‚å’Œ

**åç«¯æŸ¥è¯¢**:
```javascript
const allCustomers = await User.findAll({
  attributes: ['account_balance']
});

totalBalance = allCustomers.reduce((sum, customer) => 
  sum + parseFloat(customer.account_balance || 0), 0
);
```

---

### 2ï¸âƒ£ ä»£ç† (Agent)

æ˜¾ç¤º**æœ¬ä»£ç†ä¸‹æ‰€æœ‰å®¢æˆ·çš„æ€»é¢**ï¼š

- **è´¦æˆ·ä½™é¢æ€»é¢**: æœ¬ä»£ç†ä¸‹æ‰€æœ‰å®¢æˆ·çš„ `account_balance` æ±‚å’Œ
- **å·²è´­ä¹°æ•°æ®æ€»é‡**: æœ¬ä»£ç†ä¸‹æ‰€æœ‰å®¢æˆ·çš„è®¢å• `quantity` æ±‚å’Œ
- **ç´¯è®¡æ¶ˆè´¹æ€»é¢**: æœ¬ä»£ç†ä¸‹æ‰€æœ‰å®¢æˆ·çš„è®¢å• `total_amount` æ±‚å’Œ

**åç«¯æŸ¥è¯¢**:
```javascript
const agentCustomers = await User.findAll({
  where: { agent_id: userId },
  attributes: ['id', 'account_balance']
});

totalBalance = agentCustomers.reduce((sum, customer) => 
  sum + parseFloat(customer.account_balance || 0), 0
);
```

---

### 3ï¸âƒ£ å®¢æˆ· (Customer)

æ˜¾ç¤º**æœ¬å®¢æˆ·çš„ä¸ªäººæ•°æ®**ï¼š

- **è´¦æˆ·ä½™é¢**: æœ¬å®¢æˆ·çš„ `account_balance`
- **å·²è´­ä¹°æ•°æ®**: æœ¬å®¢æˆ·æ‰€æœ‰è®¢å•çš„ `quantity` æ±‚å’Œ
- **ç´¯è®¡æ¶ˆè´¹**: æœ¬å®¢æˆ·æ‰€æœ‰è®¢å•çš„ `total_amount` æ±‚å’Œ

**åç«¯æŸ¥è¯¢**:
```javascript
const customer = await User.findByPk(userId, {
  attributes: ['account_balance']
});

if (customer) {
  totalBalance = parseFloat(customer.account_balance || 0);
}
```

---

## ğŸ“Š é¡µé¢æ˜¾ç¤ºæ•ˆæœ

### ç»Ÿè®¡å¡ç‰‡æ ‡ç­¾åŠ¨æ€æ˜¾ç¤º

```vue
<!-- æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒçš„æ ‡ç­¾æ–‡å­— -->
<div class="balance-label">
  <template v-if="isAdmin">æ‰€æœ‰å®¢æˆ·è´¦æˆ·ä½™é¢æ€»é¢ (U)</template>
  <template v-else-if="isAgent">æœ¬ä»£ç†ä¸‹å®¢æˆ·è´¦æˆ·ä½™é¢æ€»é¢ (U)</template>
  <template v-else>è´¦æˆ·ä½™é¢ (U)</template>
</div>
```

### æ•°æ®åˆå§‹åŒ–å’ŒåŠ è½½è¿‡ç¨‹

1. **é¡µé¢åˆå§‹åŒ–**: ç»Ÿè®¡æ•°æ®æ˜¾ç¤ºä¸º `0`ï¼ˆé¿å…æ˜¾ç¤ºå‡æ•°æ®ï¼‰
2. **APIè°ƒç”¨**: ä»åç«¯è·å–çœŸå®çš„ç»Ÿè®¡æ•°æ®
3. **æ•°æ®æ›´æ–°**: å°†çœŸå®æ•°æ®æ›´æ–°åˆ°é¡µé¢æ˜¾ç¤º
4. **é™çº§æ–¹æ¡ˆ**: å¦‚æœAPIå¤±è´¥ï¼Œä» localStorage è·å–å¤‡ç”¨æ•°æ®

---

## ğŸ›¡ï¸ åŒé‡ä¿éšœæœºåˆ¶

ä¸ºç¡®ä¿æ•°æ®å¯é æ€§ï¼Œç³»ç»Ÿé‡‡ç”¨**APIä¼˜å…ˆ + localStorageé™çº§**çš„åŒé‡ä¿éšœï¼š

```javascript
async loadAccountStats() {
  try {
    // ğŸ”¥ ä¼˜å…ˆæ–¹æ¡ˆï¼šä»æ•°æ®åº“APIè·å–çœŸå®æ•°æ®
    const response = await request({
      method: 'GET',
      url: `/api/stats/resource-center/${userType}/${userId}`
    })

    if (response.success && response.data) {
      // æ›´æ–°ä¸ºçœŸå®æ•°æ®
      this.userBalance = parseFloat(response.data.totalBalance || 0)
      this.totalPurchased = parseInt(response.data.totalPurchased || 0)
      this.totalSpent = parseFloat(response.data.totalSpent || 0)
    } else {
      // ğŸ”„ é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨localStorageå¤‡ç”¨æ•°æ®
      this.loadAccountStatsFromLocalStorage()
    }
  } catch (error) {
    // ğŸ”„ é™çº§æ–¹æ¡ˆï¼šAPIå¤±è´¥æ—¶ä½¿ç”¨localStorage
    this.loadAccountStatsFromLocalStorage()
  }
}
```

---

## âœ… ä¿®æ”¹éªŒè¯

### æ‰€æœ‰é¡µé¢çš„åˆå§‹æ•°æ®ç°åœ¨éƒ½æ˜¯ 0:

```bash
# èµ„æºä¸­å¿ƒ
/home/vue-element-admin/src/views/resource/center.vue:L338:       userBalance: 0,
/home/vue-element-admin/src/views/resource/center.vue:L339:       totalPurchased: 0,
/home/vue-element-admin/src/views/resource/center.vue:L340:       totalSpent: 0,

# è´­ä¹°é¡µé¢
/home/vue-element-admin/src/views/resource/purchase.vue:L218:       userBalance: 0,

# è®¢é˜…ä¸­å¿ƒ
/home/vue-element-admin/src/views/resource/subscription.vue:L229:       userBalance: 0,
/home/vue-element-admin/src/views/resource/subscription.vue:L230:       totalPurchased: 0,
/home/vue-element-admin/src/views/resource/subscription.vue:L231:       totalSpent: 0,
```

---

## ğŸ“ æ€»ç»“

### âœ… å·²å®Œæˆçš„å·¥ä½œ

1. **ç§»é™¤å‡æ•°æ®**: å°†æ‰€æœ‰é¡µé¢çš„ç¡¬ç¼–ç åˆå§‹å€¼æ”¹ä¸º 0
2. **çœŸå®æ•°æ®æº**: ç»Ÿè®¡æ•°æ®å®Œå…¨æ¥è‡ªæ•°æ®åº“APIæŸ¥è¯¢
3. **è§’è‰²åŒºåˆ†**: ä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒèŒƒå›´çš„çœŸå®ç»Ÿè®¡æ•°æ®
4. **å¯é æ€§ä¿éšœ**: APIä¼˜å…ˆ + localStorageé™çº§çš„åŒé‡æœºåˆ¶

### ğŸ¯ æ ¸å¿ƒåŸåˆ™

- **ç®¡ç†å‘˜**: çœ‹åˆ°æ‰€æœ‰å®¢æˆ·çš„æ€»é¢
- **ä»£ç†**: çœ‹åˆ°æœ¬ä»£ç†ä¸‹å®¢æˆ·çš„æ€»é¢
- **å®¢æˆ·**: çœ‹åˆ°æœ¬äººçš„æ•°æ®

### ğŸ”¥ å…³é”®ä¼˜åŠ¿

- âœ… **æ•°æ®çœŸå®**: æ‰€æœ‰æ•°æ®æ¥è‡ªæ•°æ®åº“ï¼Œä¸æ˜¯å‡æ•°æ®
- âœ… **å®æ—¶å‡†ç¡®**: æ¯æ¬¡åŠ è½½éƒ½ä»APIè·å–æœ€æ–°æ•°æ®
- âœ… **æƒé™éš”ç¦»**: ä¸åŒè§’è‰²çœ‹åˆ°ç¬¦åˆæƒé™çš„æ•°æ®èŒƒå›´
- âœ… **ç”¨æˆ·ä½“éªŒ**: åˆå§‹ä¸º0ï¼Œé¿å…ç”¨æˆ·çœ‹åˆ°é—ªç°çš„å‡æ•°æ®

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

ç°åœ¨èµ„æºä¸­å¿ƒå·²ç»èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºçœŸå®çš„æ•°æ®åº“ä¿¡æ¯ã€‚ä¸ºäº†ç¡®ä¿ç³»ç»Ÿæ­£å¸¸è¿è¡Œï¼Œå»ºè®®ï¼š

1. **æµ‹è¯•ä¸åŒè§’è‰²**: åˆ†åˆ«ä½¿ç”¨ç®¡ç†å‘˜ã€ä»£ç†ã€å®¢æˆ·è´¦å·ç™»å½•æµ‹è¯•
2. **éªŒè¯æ•°æ®å‡†ç¡®æ€§**: ç¡®è®¤ç»Ÿè®¡æ•°æ®ä¸æ•°æ®åº“ä¸€è‡´
3. **æ£€æŸ¥é™çº§æ–¹æ¡ˆ**: æµ‹è¯•APIå¤±è´¥æ—¶çš„é™çº§é€»è¾‘
4. **æ€§èƒ½ä¼˜åŒ–**: å¦‚æœæ•°æ®é‡å¤§ï¼Œè€ƒè™‘æ·»åŠ ç¼“å­˜æœºåˆ¶

---

**ä¿®æ”¹æ—¶é—´**: 2025-10-15  
**ä¿®æ”¹æ–‡ä»¶**: 
- `/home/vue-element-admin/src/views/resource/center.vue`
- `/home/vue-element-admin/src/views/resource/purchase.vue`

**ä¿®æ”¹äºº**: Qoder AI Assistant
