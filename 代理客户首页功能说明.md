# 代理与客户首页功能说明

## 📋 功能概述

代理首页与客户首页采用相同的布局设计，但显示内容根据角色不同而有所区别。

---

## 🎯 页面布局对比

### 共同布局结构

两个首页都采用以下布局：

```
┌─────────────────────────────────────┐
│        欢迎信息 + 角色描述          │
├─────────────────────────────────────┤
│    统计卡片区（4个统计卡片）        │
├──────────────┬──────────────────────┤
│  快捷操作区  │    收藏/热门数据区    │
└──────────────┴──────────────────────┘
```

### 页面对比

| 区域 | 客户首页 | 代理首页 |
|------|---------|---------|
| 欢迎信息 | 欢迎尊敬的XX客户 | 欢迎，XX代理！ |
| 统计卡片 | 账户余额/总订单/总数据/反馈数 | 绑定客户/总佣金/月度订单/佣金比例 |
| 快捷操作 | 购买数据/查看订单/提交反馈 | 查看客户/查看订单/查看反馈 |
| 右侧卡片 | 我的收藏（客户自己的收藏） | 客户热门收藏（所有客户的Top5） |

---

## 📊 客户首页 - 我的收藏

**文件位置**: `/src/views/dashboard/customer.vue`

### 功能说明

显示当前客户自己的收藏数据，最多显示5条。

### 数据来源

**API接口**: `GET /api/favorites/customer/{customerId}`

**请求参数**:
```javascript
{
  page: 1,
  limit: 5
}
```

**返回数据示例**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "customerId": 5,
      "customerName": "KL01880V01",
      "dataId": 3,
      "country": "US",
      "countryName": "美国",
      "dataType": "Email数据",
      "validity": "valid_90",
      "availableQuantity": 50000,
      "sellPrice": 0.015,
      "createTime": 1760505000000,
      "currentData": {
        "id": 3,
        "availableQuantity": 50000,
        "sellPrice": 0.015,
        "status": "available"
      }
    }
  ],
  "total": 3,
  "page": 1,
  "limit": 5
}
```

### 显示内容

每条收藏显示：
- ✅ 国家名称
- ✅ 数据类型
- ✅ 可用数量
- ✅ 售价（U/条）

### 交互功能

- 点击收藏项：跳转到数据详情/购买页面
- 点击"更多"按钮：跳转到资源中心
- 空状态：显示"去收藏"按钮

---

## 🏆 代理首页 - 客户热门收藏

**文件位置**: `/src/views/dashboard/agent.vue`

### 功能说明

显示该代理下**所有客户**在**近一周内**收藏的数据，按**利润率**从高到低排序，显示前5条。

### 数据来源

**API接口**: `GET /api/favorites/agent/{agentId}/top-profit`

**请求参数**:
```javascript
{
  limit: 5  // 限制返回前5条
}
```

**返回数据示例**:
```json
{
  "success": true,
  "data": [
    {
      "favoriteId": 12,
      "customerId": 5,
      "customerName": "KL01880V01",
      "dataId": 3,
      "country": "美国",
      "dataType": "Email数据",
      "validity": "90天有效",
      "availableQuantity": 50000,
      "sellPrice": 0.015,
      "costPrice": 0.01,
      "profitMargin": "50.00",      // 利润率50%
      "createTime": 1760505000000
    },
    {
      "favoriteId": 15,
      "customerId": 6,
      "customerName": "客户王五",
      "dataId": 7,
      "country": "英国",
      "dataType": "手机号数据",
      "validity": "60天有效",
      "availableQuantity": 30000,
      "sellPrice": 0.02,
      "costPrice": 0.015,
      "profitMargin": "33.33",      // 利润率33.33%
      "createTime": 1760500000000
    }
  ],
  "total": 2
}
```

### 利润率计算公式

```javascript
利润率 = ((售价 - 成本) / 成本) × 100%

例如：
售价 = 0.015 U/条
成本 = 0.01 U/条
利润率 = ((0.015 - 0.01) / 0.01) × 100% = 50%
```

### 显示内容

每条热门收藏显示：
- ✅ 排名徽章（金/银/铜）
- ✅ 国家名称
- ✅ 数据类型
- ✅ 客户名称
- ✅ **利润率**（高亮显示）
- ✅ 售价（U/条）
- ✅ 成本（U/条）

### 排名徽章设计

| 排名 | 徽章颜色 | 渐变效果 |
|------|---------|---------|
| 第1名 | 金色 | #ffd700 → #ffed4e |
| 第2名 | 银色 | #c0c0c0 → #e8e8e8 |
| 第3名 | 铜色 | #cd7f32 → #d4a574 |
| 第4-5名 | 灰色 | #909399 |

---

## 🔧 后端API实现

### API接口

**文件位置**: `/backend/routes/favorites.js` (第217-316行)

**接口路径**: `GET /api/favorites/agent/:agentId/top-profit`

### 实现逻辑

```javascript
// 1. 获取该代理下的所有客户
const customers = await User.findAll({
  where: { agent_id: agentId },
  attributes: ['id']
});

// 2. 获取一周前的时间戳
const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);

// 3. 获取这些客户的收藏数据（近一周内）
const favorites = await Favorite.findAll({
  where: {
    customer_id: { [Op.in]: customerIds },
    create_time: { [Op.gte]: oneWeekAgo }
  },
  include: [{
    model: DataLibrary,
    as: 'dataItem',
    required: true
  }]
});

// 4. 计算利润率
const profitMargin = costPrice > 0 
  ? ((sellPrice - costPrice) / costPrice * 100) 
  : 0;

// 5. 按利润率降序排序
profitData.sort((a, b) => 
  parseFloat(b.profitMargin) - parseFloat(a.profitMargin)
);

// 6. 取前5条
const topData = profitData.slice(0, 5);
```

### 筛选条件

1. ✅ **代理过滤**: 只查询该代理下的客户
2. ✅ **时间过滤**: 只统计近7天内的收藏
3. ✅ **利润率排序**: 按利润率从高到低排序
4. ✅ **数量限制**: 只返回Top5

---

## 🎨 前端样式设计

### 客户首页 - 收藏列表

```scss
.favorite-list {
  .favorite-item {
    display: flex;
    justify-content: space-between;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 4px;
    cursor: pointer;
    
    &:hover {
      background: #e9ecef;
      transform: translateX(2px);  // 悬停时右移
    }
  }
}
```

### 代理首页 - 热门收藏列表

```scss
.top-favorites-list {
  .top-favorite-item {
    display: flex;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid #409eff;  // 左侧强调边框
    
    .rank-badge {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: bold;
      
      // 金牌渐变
      &.rank-1 {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #8b6914;
      }
      
      // 银牌渐变
      &.rank-2 {
        background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
        color: #696969;
      }
      
      // 铜牌渐变
      &.rank-3 {
        background: linear-gradient(135deg, #cd7f32 0%, #d4a574 100%);
        color: #5c3a1e;
      }
    }
    
    .profit-margin {
      color: #67c23a;  // 利润率高亮显示为绿色
      
      strong {
        font-size: 14px;
        margin-left: 4px;
      }
    }
  }
}
```

---

## 📊 数据流程图

### 客户首页数据流

```
客户登录
  ↓
获取客户ID
  ↓
调用 /api/favorites/customer/{customerId}
  ↓
返回该客户的收藏列表（最多5条）
  ↓
显示在"我的收藏"卡片中
```

### 代理首页数据流

```
代理登录
  ↓
获取代理ID
  ↓
调用 /api/favorites/agent/{agentId}/top-profit
  ↓
后端处理：
  1. 查询该代理下所有客户
  2. 查询这些客户近一周的收藏
  3. 计算每条收藏的利润率
  4. 按利润率降序排序
  5. 返回Top5
  ↓
显示在"客户热门收藏"卡片中
```

---

## 🧪 测试验证

### 测试场景1：客户查看自己的收藏

**步骤**:
1. 使用客户账号登录（如：customer01/123456）
2. 进入客户首页
3. 查看"我的收藏"卡片

**预期结果**:
- ✅ 显示该客户自己的收藏数据
- ✅ 最多显示5条
- ✅ 点击收藏项可跳转到购买页面
- ✅ 如果没有收藏，显示"去收藏"按钮

### 测试场景2：代理查看客户热门收藏

**步骤**:
1. 使用代理账号登录（如：agent01/123456）
2. 进入代理首页
3. 查看"客户热门收藏（一周内利润率Top5）"卡片

**预期结果**:
- ✅ 显示该代理下所有客户的收藏数据
- ✅ 只显示近一周内的收藏
- ✅ 按利润率从高到低排序
- ✅ 最多显示5条
- ✅ 显示客户名称
- ✅ 显示利润率（绿色高亮）
- ✅ 第1-3名显示金/银/铜徽章

### 测试场景3：不同客户收藏不同数据

**测试数据准备**:
```javascript
// 客户1收藏高利润率数据
customer01 收藏 美国Email数据（利润率50%）

// 客户2收藏中等利润率数据
customer02 收藏 英国手机数据（利润率30%）

// 客户3收藏低利润率数据
customer03 收藏 法国邮编数据（利润率20%）
```

**验证**:
- agent01登录后，应该看到：
  1. 第1名：美国Email数据（客户1，利润率50%）
  2. 第2名：英国手机数据（客户2，利润率30%）
  3. 第3名：法国邮编数据（客户3，利润率20%）

---

## 🔍 数据库查询示例

### 查询代理下的客户收藏

```sql
-- 1. 查询代理ID为5的所有客户
SELECT id FROM users WHERE agent_id = 5;

-- 2. 查询这些客户近一周的收藏
SELECT f.*, d.sell_price, d.cost_price
FROM favorites f
JOIN data_library d ON f.data_id = d.id
WHERE f.customer_id IN (SELECT id FROM users WHERE agent_id = 5)
  AND f.create_time >= (UNIX_TIMESTAMP() * 1000 - 7 * 24 * 60 * 60 * 1000);

-- 3. 计算利润率（在应用层完成）
-- profitMargin = ((sell_price - cost_price) / cost_price) * 100
```

---

## ⚠️ 注意事项

### 1. 权限控制

- **客户**: 只能查看自己的收藏
- **代理**: 只能查看自己客户的收藏
- **管理员**: 可以查看所有收藏

### 2. 时间范围

- 客户首页：显示所有时间的收藏
- 代理首页：只显示近**7天内**的收藏

### 3. 数据同步

收藏表中存储的价格是收藏时的快照，实际购买时需要获取最新价格：

```javascript
currentData: {
  id: dataItem.id,
  availableQuantity: dataItem.available_quantity,  // 最新库存
  sellPrice: parseFloat(dataItem.sell_price),      // 最新价格
  status: dataItem.status                          // 最新状态
}
```

### 4. 空状态处理

**客户首页**:
```javascript
if (favorites.length === 0) {
  // 显示空状态
  // 提供"去收藏"按钮
}
```

**代理首页**:
```javascript
if (topFavorites.length === 0) {
  // 显示"暂无客户收藏数据"
  // 不提供操作按钮（因为代理不能直接收藏）
}
```

---

## 📋 功能清单

### 已实现功能 ✅

1. ✅ 客户首页显示"我的收藏"
2. ✅ 代理首页显示"客户热门收藏"
3. ✅ 近一周时间过滤
4. ✅ 利润率计算和排序
5. ✅ Top5限制
6. ✅ 排名徽章显示（金/银/铜）
7. ✅ 利润率高亮显示
8. ✅ 客户名称显示
9. ✅ 售价和成本显示
10. ✅ 空状态处理
11. ✅ 后端API完整实现
12. ✅ 前端UI完整实现

### 相关文件清单

**前端文件**:
- `/src/views/dashboard/customer.vue` - 客户首页
- `/src/views/dashboard/agent.vue` - 代理首页

**后端文件**:
- `/backend/routes/favorites.js` - 收藏管理API
- `/backend/models/Favorite.js` - 收藏数据模型

**路由注册**:
- `/backend/server.js` - API路由注册

---

## 🎯 总结

代理首页和客户首页采用**相同的布局设计**，但根据角色特性显示**不同的内容**：

| 特性 | 客户首页 | 代理首页 |
|------|---------|---------|
| 布局 | ✅ 相同 | ✅ 相同 |
| 统计卡片 | 账户余额/订单/数据 | 客户数/佣金/订单 |
| 快捷操作 | 购买/查看订单/反馈 | 查看客户/订单/反馈 |
| 收藏卡片标题 | "我的收藏" | "客户热门收藏（一周内利润率Top5）" |
| 收藏数据来源 | 自己的收藏 | 所有客户的收藏 |
| 时间范围 | 全部 | 近一周 |
| 排序依据 | 收藏时间 | 利润率（高→低） |
| 显示数量 | 最多5条 | 最多5条 |
| 特殊显示 | - | 排名徽章、客户名称、利润率 |

**核心功能已完全实现** ✅

---

**文档创建时间**: 2025-10-15  
**功能状态**: ✅ 已完成  
**测试状态**: ✅ 可测试
