# 通道速率控制功能 - 界面使用说明

## 功能概述

在通道配置的创建/编辑对话框中，新增了"速率控制"配置区域，支持多维度的流量控制。

## 界面位置

**路径**：通道管理 → 新增/编辑通道 → 速率控制区域

**位置**：位于"每日限额"配置项下方，"状态"配置项上方

## 界面元素

### 1. 速率控制开关

```
┌─────────────────────────────────────────────────────┐
│ 启用速率控制  [关闭 ○━━━ ● 开启]                    │
│               防止超频请求，保护通道稳定性           │
└─────────────────────────────────────────────────────┘
```

- **类型**：el-switch 开关组件
- **默认状态**：关闭
- **说明文字**："防止超频请求，保护通道稳定性"

### 2. 速率控制参数（开启时显示）

当开关开启后，显示以下配置项：

```
┌─────────────────────────────────────────────────────┐
│ 速率控制                                             │
├─────────────────────────────────────────────────────┤
│ 启用速率控制  [关闭 ━━━● 开启]                      │
│               防止超频请求，保护通道稳定性           │
│                                                     │
│ 每秒限制     [     100      ] [+ -]                │
│              每秒最大发送请求数，0表示不限制         │
│                                                     │
│ 每分钟限制   [    5000      ] [+ -]                │
│              每分钟最大发送请求数，0表示不限制       │
│                                                     │
│ 每小时限制   [   200000     ] [+ -]                │
│              每小时最大发送请求数，0表示不限制       │
│                                                     │
│ 最大并发数   [      10      ] [+ -]                │
│              同时发送的最大请求数                   │
│                                                     │
│ ┌─────────────────────────────────────────────┐    │
│ │ ℹ️ 速率控制说明：                            │    │
│ │ • 每秒限制：适用于高频短信发送，防止瞬间流   │    │
│ │   量过大                                    │    │
│ │ • 每分钟/小时：控制总体发送量，防止超出供应  │    │
│ │   商限制                                    │    │
│ │ • 最大并发数：限制同时进行的请求数，保证服   │    │
│ │   务稳定                                    │    │
│ └─────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────┘
```

## 字段详解

### 每秒限制 (rate_limit_per_second)

- **控件类型**：el-input-number（数字输入框）
- **取值范围**：0 - 1000
- **默认值**：0
- **说明**：控制每秒最大请求数（QPS），适用于高频发送场景
- **示例值**：
  - `0`：不限制
  - `50`：每秒最多50条
  - `100`：每秒最多100条
  - `500`：每秒最多500条

### 每分钟限制 (rate_limit_per_minute)

- **控件类型**：el-input-number
- **取值范围**：0 - 60000
- **默认值**：0
- **说明**：控制每分钟最大请求数，防止短时间内流量过大
- **示例值**：
  - `0`：不限制
  - `2000`：每分钟最多2000条
  - `5000`：每分钟最多5000条
  - `10000`：每分钟最多10000条

### 每小时限制 (rate_limit_per_hour)

- **控件类型**：el-input-number
- **取值范围**：0 - 3600000
- **默认值**：0
- **说明**：控制每小时最大请求数，用于总体流量控制
- **示例值**：
  - `0`：不限制
  - `50000`：每小时最多5万条
  - `100000`：每小时最多10万条
  - `500000`：每小时最多50万条

### 最大并发数 (rate_limit_concurrent)

- **控件类型**：el-input-number
- **取值范围**：1 - 100
- **默认值**：1
- **说明**：限制同时进行的请求数，保证服务稳定性
- **示例值**：
  - `1`：串行发送（最安全）
  - `5`：最多5个并发
  - `10`：最多10个并发
  - `20`：最多20个并发

## 使用步骤

### 创建新通道时配置速率控制

1. 点击通道管理页面的【新增】按钮
2. 填写基本信息（通道名称、账号、密码等）
3. 滚动到"速率控制"区域
4. 开启"启用速率控制"开关
5. 根据需求配置各项参数：
   - 每秒限制：100
   - 每分钟限制：5000
   - 每小时限制：200000
   - 最大并发数：10
6. 点击【确定】保存

### 编辑现有通道添加速率控制

1. 在通道列表中找到目标通道
2. 点击【编辑】按钮
3. 滚动到"速率控制"区域
4. 开启"启用速率控制"开关
5. 配置速率控制参数
6. 点击【确定】保存

### 关闭速率控制

1. 编辑通道
2. 找到"速率控制"区域
3. 关闭"启用速率控制"开关
4. 点击【确定】保存

## 配置建议

### 验证码通道

验证码短信具有高频、即时性强的特点：

```
✓ 启用速率控制
每秒限制：   100    (支持每秒100次验证码请求)
每分钟限制： 5000   (每分钟最多5000条)
每小时限制： 0      (不限制，根据实际需求调整)
最大并发数： 20     (支持20个并发请求)
```

### 通知类短信通道

通知短信频率较高，但不如验证码密集：

```
✓ 启用速率控制
每秒限制：   50     (每秒50条足够)
每分钟限制： 2000   (每分钟2000条)
每小时限制： 50000  (每小时5万条上限)
最大并发数： 10     (10个并发)
```

### 营销短信通道

营销短信批量发送，但不需要太高的瞬时速率：

```
✓ 启用速率控制
每秒限制：   30     (控制发送速度)
每分钟限制： 1500   (每分钟1500条)
每小时限制： 50000  (每小时5万条总量控制)
最大并发数： 5      (较低的并发数)
```

### 测试通道

测试环境需要严格限制：

```
✓ 启用速率控制
每秒限制：   5      (每秒最多5条)
每分钟限制： 100    (每分钟100条)
每小时限制： 1000   (每小时1000条)
最大并发数： 2      (最多2个并发)
```

### VIP专属通道

为重要客户提供的高性能通道：

```
✓ 启用速率控制
每秒限制：   500    (高性能支持)
每分钟限制： 20000  (每分钟2万条)
每小时限制： 500000 (每小时50万条)
最大并发数： 50     (高并发支持)
```

## 字段联动说明

### 值为0的含义

所有速率控制参数，当值为 `0` 时，表示该维度**不限制**：

- `每秒限制 = 0`：不限制每秒请求数
- `每分钟限制 = 0`：不限制每分钟请求数
- `每小时限制 = 0`：不限制每小时请求数

### 多维度限制同时生效

如果同时配置了多个限制，所有限制都会生效：

**示例**：
```
每秒限制：   100
每分钟限制： 5000
每小时限制： 200000
```

这意味着：
- 任意1秒内不能超过100条
- 任意1分钟内不能超过5000条
- 任意1小时内不能超过200000条

**注意**：确保配置的值之间逻辑合理，例如：
- ✅ 正确：每秒100、每分钟5000、每小时200000
  - 100条/秒 × 60秒 = 6000条/分 > 5000（符合逻辑）
- ❌ 不合理：每秒100、每分钟500、每小时200000
  - 100条/秒 × 60秒 = 6000条/分 > 500（矛盾）

## 界面交互

### 开关状态变化

```
关闭状态：
┌─────────────────────────────────────┐
│ 启用速率控制  [关闭 ○━━━ ● 开启]    │
│               防止超频请求...       │
│                                    │
│ [状态]                             │
│   ● 启用  ○ 禁用                   │
└─────────────────────────────────────┘

开启状态：
┌─────────────────────────────────────┐
│ 启用速率控制  [关闭 ━━━● 开启]      │
│               防止超频请求...       │
│                                    │
│ 每秒限制     [100] [+ -]           │
│ 每分钟限制   [5000] [+ -]          │
│ 每小时限制   [200000] [+ -]        │
│ 最大并发数   [10] [+ -]            │
│                                    │
│ [ℹ️ 速率控制说明...]               │
│                                    │
│ [状态]                             │
│   ● 启用  ○ 禁用                   │
└─────────────────────────────────────┘
```

### 数字输入框操作

每个数字输入框支持：
- 直接输入数字
- 点击 `+` 按钮增加
- 点击 `-` 按钮减少
- 键盘上下键调整

### 输入验证

- **最小值检查**：不能小于配置的最小值
- **最大值检查**：不能大于配置的最大值
- **整数验证**：只能输入整数，不支持小数

## 数据保存

### 创建通道时

```javascript
// 发送到后端的数据
{
  channel_name: "考拉短信SMPP",
  // ... 其他字段
  rate_limit_enabled: true,
  rate_limit_per_second: 100,
  rate_limit_per_minute: 5000,
  rate_limit_per_hour: 200000,
  rate_limit_concurrent: 10,
  status: 1
}
```

### 编辑通道时

```javascript
// 更新的数据
{
  id: 5,
  rate_limit_enabled: true,
  rate_limit_per_second: 50,
  rate_limit_per_minute: 2000,
  rate_limit_per_hour: 100000,
  rate_limit_concurrent: 5
}
```

### 关闭速率控制时

```javascript
// 关闭开关后
{
  id: 5,
  rate_limit_enabled: false,
  rate_limit_per_second: 100,    // 保留配置值
  rate_limit_per_minute: 5000,   // 保留配置值
  rate_limit_per_hour: 200000,   // 保留配置值
  rate_limit_concurrent: 10      // 保留配置值
}
```

**注意**：关闭开关后，速率控制配置值会保留，再次开启时无需重新配置。

## 常见问题

### Q1: 如何完全不限制速率？

**答**：有两种方式：
1. 关闭"启用速率控制"开关（推荐）
2. 开启开关，但所有参数设为0（不推荐）

### Q2: 最大并发数为什么最小是1？

**答**：至少需要1个并发才能发送短信，0个并发意味着无法发送。

### Q3: 可以只设置部分限制吗？

**答**：可以。例如只设置"每秒限制"为100，其他设为0，表示只限制QPS。

### Q4: 速率控制何时生效？

**答**：
- **前端**：立即生效，保存后立即应用
- **后端**：需要后端实现速率限制逻辑（待开发）

### Q5: 编辑通道时看不到速率控制配置？

**答**：请确认：
1. 数据库是否已添加相关字段
2. 浏览器是否清除了缓存
3. 前端代码是否最新版本

## 相关文件

- **前端界面**：`/home/vue-element-admin/src/views/sms/admin/channels.vue`
- **数据模型**：`/home/vue-element-admin/backend/models/SmsChannel.js`
- **SQL脚本**：`/home/vue-element-admin/scripts/add-rate-limit-fields.sql`
- **迁移指南**：`/home/vue-element-admin/速率控制功能-数据库迁移指南.md`
- **功能文档**：`/home/vue-element-admin/通道速率控制功能说明.md`

## 界面预览代码

```vue
<!-- 速率控制配置区域 -->
<el-divider content-position="left">速率控制</el-divider>

<el-form-item label="启用速率控制">
  <el-switch
    v-model="temp.rate_limit_enabled"
    active-text="开启"
    inactive-text="关闭"
  />
  <span style="font-size: 12px; color: #909399; margin-left: 10px">
    防止超频请求，保护通道稳定性
  </span>
</el-form-item>

<div v-if="temp.rate_limit_enabled">
  <el-form-item label="每秒限制">
    <el-input-number 
      v-model="temp.rate_limit_per_second" 
      :min="0" 
      :max="1000"
      placeholder="每秒最大请求数" 
      style="width: 100%"
    />
    <span style="font-size: 12px; color: #909399">
      每秒最大发送请求数，0表示不限制
    </span>
  </el-form-item>
  
  <!-- 其他字段类似 -->
</div>
```

---

**更新时间**：2025-10-22  
**版本**：v1.0
