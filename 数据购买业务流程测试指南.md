# 数据购买业务流程测试指南

## 🧪 快速测试步骤

### 前提条件
1. 启动项目: `npm run dev`
2. 访问地址: `http://localhost:9528`
3. 准备两个测试账号:
   - 客户账号 (type: 'customer')
   - 代理账号 (type: 'agent')

---

## 📝 完整测试流程

### 第一步: 客户购买数据并生成订单

**操作路径**: 资源中心 → 购买数据

1. 使用**客户账号**登录系统
2. 访问: `资源中心` → `资源中心`
3. 选择一个数据记录
4. 点击"购买"按钮
5. 填写购买信息:
   - 选择数据数量
   - 选择运营商分布
   - 填写发货邮箱(会自动填充客户邮箱)
6. 点击"确认购买"
7. 系统提示"购买成功"

**预期结果**:
- ✅ 订单自动生成
- ✅ 订单号: `ORD` + 时间戳 + 随机码
- ✅ 订单状态: `pending` (待处理)
- ✅ 发货状态: `pending` (待发货)
- ✅ 订单存入 localStorage 的 `orderList`

**验证方式**:
```javascript
// 在浏览器控制台执行
const orders = JSON.parse(localStorage.getItem('orderList'))
console.log('最新订单:', orders[orders.length - 1])
// 检查 status 是否为 'pending'
```

---

### 第二步: 客户提交订单审核

**操作路径**: 订单管理 → 待处理订单

1. 访问: `订单管理` → `待处理订单`
2. 查看订单列表
3. 找到刚才创建的订单
4. 点击"提交审核"按钮
5. 确认对话框点击"确定"
6. 系统提示"订单已提交给代理审核"

**预期结果**:
- ✅ 订单状态变更: `pending` → `reviewing`
- ✅ 记录提交审核时间: `reviewTime`
- ✅ 订单从待处理列表消失
- ✅ 统计卡片数据更新

**验证方式**:
```javascript
// 在浏览器控制台执行
const orders = JSON.parse(localStorage.getItem('orderList'))
const reviewingOrders = orders.filter(o => o.status === 'reviewing')
console.log('待审核订单:', reviewingOrders)
```

**界面验证**:
- 待处理订单列表减少 1 条
- 审核中订单数 +1
- 刷新页面数据不丢失

---

### 第三步: 代理审核订单

**操作路径**: 订单管理 → 审核订单

1. **切换到代理账号**登录
2. 访问: `订单管理` → `审核订单`
3. 查看待审核订单列表
4. 找到刚才客户提交的订单
5. 点击"详情"按钮查看订单详情
6. 点击"通过"按钮(或"拒绝"按钮测试拒绝流程)

**审核通过流程**:
1. 点击"通过"按钮
2. 弹出审核对话框,显示订单详情
3. 点击"确认通过"
4. 系统提示"审核通过！订单已流转到已完成订单，等待发货"

**预期结果**:
- ✅ 订单状态变更: `reviewing` → `completed`
- ✅ 发货状态: `pending` (待发货)
- ✅ 记录审核通过时间: `approveTime`
- ✅ 订单从审核列表消失
- ✅ 统计卡片更新(今日已审核 +1)

**审核拒绝流程** (可选测试):
1. 点击"拒绝"按钮
2. 输入拒绝原因(必填)
3. 点击"确认拒绝"
4. 系统提示"订单已拒绝"

**预期结果**:
- ✅ 订单状态变更: `reviewing` → `cancelled`
- ✅ 记录拒绝原因: `rejectReason`
- ✅ 记录拒绝时间: `rejectTime`

**验证方式**:
```javascript
// 审核通过验证
const orders = JSON.parse(localStorage.getItem('orderList'))
const completedOrders = orders.filter(o => 
  o.status === 'completed' && o.deliveryStatus === 'pending'
)
console.log('待发货订单:', completedOrders)

// 审核拒绝验证
const cancelledOrders = orders.filter(o => o.status === 'cancelled')
console.log('已拒绝订单:', cancelledOrders)
```

---

### 第四步: 查看已完成订单

**操作路径**: 订单管理 → 已完成订单

1. 保持代理账号登录(或切换到客户账号也可以)
2. 访问: `订单管理` → `已完成订单`
3. 查看订单列表

**预期显示**:
- ✅ 显示审核通过的订单
- ✅ 发货状态列显示"待发货"(黄色标签)
- ✅ 操作列显示"发货"按钮
- ✅ 统计卡片显示正确数据

**界面验证**:
- 已完成订单数统计正确
- 总数据量统计正确
- 总交易额统计正确

---

### 第五步: 订单发货

**操作路径**: 已完成订单 → 点击发货 → 发货页面

1. 在已完成订单列表中
2. 找到待发货订单(发货状态为"待发货")
3. 点击"发货"按钮
4. 跳转到发货页面

**发货页面验证**:
- ✅ 显示订单号
- ✅ 显示数据基本信息(国家、时效、来源、数量、运营商)
- ✅ 显示客户基本信息(客户名称、下单时间、金额、审核时间)
- ✅ 发货方式选择区域

**邮箱发货测试**:
1. 选择"邮箱发货"
2. 输入接收邮箱地址(或使用默认填充的邮箱)
3. 可选填写备注信息
4. 点击"确认发货"
5. 确认对话框点击"确认发货"
6. 显示发货进度(2秒模拟发货)
7. 提示"发货成功！数据已发送到指定地址"
8. 自动返回已完成订单页面

**预期结果**:
- ✅ 订单发货状态变更: `pending` → `delivered`
- ✅ 记录发货时间: `deliveryTime`
- ✅ 记录发货方式: `deliveryMethod` = 'email'
- ✅ 记录发货邮箱: `deliveryEmail`
- ✅ 记录发货备注: `deliveryRemark`

**TGbot发货测试** (可选):
1. 选择"TGbot发货"
2. 输入 TG Bot ID(必填)
3. 输入 TG 用户名(选填)
4. 填写备注信息(选填)
5. 点击"确认发货"

**预期结果**:
- ✅ 发货方式: `deliveryMethod` = 'tgbot'
- ✅ 记录 TG Bot ID: `tgBotId`
- ✅ 记录 TG 用户名: `tgUsername`

**验证方式**:
```javascript
// 在浏览器控制台执行
const orders = JSON.parse(localStorage.getItem('orderList'))
const deliveredOrders = orders.filter(o => o.deliveryStatus === 'delivered')
console.log('已发货订单:', deliveredOrders)
console.log('最新发货订单:', deliveredOrders[deliveredOrders.length - 1])
```

---

### 第六步: 验证已发货订单

**操作路径**: 订单管理 → 已完成订单

1. 返回已完成订单页面
2. 刷新页面或手动点击"刷新数据"
3. 查看刚才发货的订单

**预期显示**:
- ✅ 发货状态显示"已发货"(绿色标签)
- ✅ 操作列显示"下载"按钮(不再显示"发货"按钮)
- ✅ 完成时间列显示发货时间

**统计验证**:
- 待发货订单数 -1
- 已发货订单数 +1
- 统计卡片数据正确

---

## 🔍 详细验证检查点

### 数据完整性检查

```javascript
// 打开浏览器控制台,执行以下代码

// 1. 检查订单列表
const orders = JSON.parse(localStorage.getItem('orderList'))
console.log('总订单数:', orders.length)

// 2. 按状态分组统计
const statusCount = orders.reduce((acc, order) => {
  acc[order.status] = (acc[order.status] || 0) + 1
  return acc
}, {})
console.log('订单状态统计:', statusCount)

// 3. 检查完整的订单流转
const testOrder = orders.find(o => o.status === 'completed')
console.log('测试订单完整信息:', {
  订单号: testOrder.orderNo,
  状态: testOrder.status,
  发货状态: testOrder.deliveryStatus,
  创建时间: new Date(testOrder.createTime).toLocaleString(),
  审核时间: testOrder.reviewTime ? new Date(testOrder.reviewTime).toLocaleString() : '未提交',
  通过时间: testOrder.approveTime ? new Date(testOrder.approveTime).toLocaleString() : '未审核',
  发货时间: testOrder.deliveryTime ? new Date(testOrder.deliveryTime).toLocaleString() : '未发货',
  发货方式: testOrder.deliveryMethod || '未发货'
})

// 4. 检查时间字段完整性
const completeOrders = orders.filter(o => o.status === 'completed')
completeOrders.forEach(order => {
  console.log(`订单 ${order.orderNo}:`, {
    '是否有创建时间': !!order.createTime,
    '是否有审核时间': !!order.reviewTime,
    '是否有通过时间': !!order.approveTime,
    '是否有发货时间': !!order.deliveryTime
  })
})
```

### 界面展示检查

#### 待处理订单页面 (`/order/pending`)
- [ ] 统计卡片显示正确
- [ ] 待处理订单数准确
- [ ] 审核中订单数准确
- [ ] 待处理总金额准确
- [ ] 订单列表正确过滤(只显示 pending 状态)
- [ ] "提交审核"按钮显示正常
- [ ] 点击提交后订单消失
- [ ] 刷新数据功能正常

#### 审核订单页面 (`/order/review`)
- [ ] 统计卡片显示正确
- [ ] 待审核订单数准确
- [ ] 今日已审核数准确
- [ ] 待审核总金额准确
- [ ] 订单列表正确过滤(只显示 reviewing 状态)
- [ ] "通过"和"拒绝"按钮显示正常
- [ ] 审核对话框显示完整订单信息
- [ ] 拒绝时必须填写原因
- [ ] 审核后订单从列表消失

#### 已完成订单页面 (`/order/completed`)
- [ ] 统计卡片显示正确
- [ ] 已完成订单数准确
- [ ] 总数据量准确
- [ ] 总交易额准确
- [ ] 订单列表正确过滤(只显示 completed 状态)
- [ ] 发货状态列显示正确(待发货/已发货)
- [ ] 待发货订单显示"发货"按钮
- [ ] 已发货订单显示"下载"按钮
- [ ] 点击发货跳转正确

#### 发货页面 (`/order/delivery/:id`)
- [ ] 页面标题显示订单号
- [ ] 数据基本信息完整显示
- [ ] 客户基本信息完整显示
- [ ] 发货方式单选正常
- [ ] 邮箱默认值正确填充
- [ ] 邮箱格式验证正常
- [ ] TG Bot ID 必填验证正常
- [ ] 提交发货成功
- [ ] 成功后自动返回

### 权限测试

#### 客户账号权限
- [ ] 可以访问"待处理订单"
- [ ] **不能**访问"审核订单"(菜单隐藏)
- [ ] 可以访问"已完成订单"
- [ ] **不能**直接访问发货页面(URL访问会被拦截)

#### 代理账号权限
- [ ] **不能**访问"待处理订单"(菜单隐藏,是客户专属)
- [ ] 可以访问"审核订单"
- [ ] 可以访问"已完成订单"
- [ ] 可以访问发货页面

#### 管理员账号权限
- [ ] 可以访问所有订单管理页面
- [ ] 可以执行所有操作

### 状态流转完整性测试

创建一个测试订单,完整走完流程:

```
pending → reviewing → completed(待发货) → completed(已发货)
   ↓          ↓             ↓                    ↓
客户购买   客户提交      代理审核          代理发货
          审核          通过
```

每个状态检查:
- [ ] 订单状态字段正确
- [ ] 时间字段正确记录
- [ ] 订单在正确的页面显示
- [ ] 订单不在不应该出现的页面
- [ ] 统计数据实时更新

---

## 🐛 常见问题排查

### 问题1: 订单提交审核后还在待处理列表
**原因**: 页面缓存未刷新
**解决**: 
1. 检查 `activated()` 钩子是否正确执行
2. 手动点击"刷新数据"按钮
3. 刷新浏览器页面

### 问题2: 审核订单页面看不到订单
**原因**: 
- 账号权限不对(使用的是客户账号)
- 订单状态不是 `reviewing`

**解决**:
1. 确认使用的是代理或管理员账号
2. 检查 localStorage 中订单状态
3. 确认订单已经提交审核

### 问题3: 发货按钮不显示
**原因**: 订单发货状态不是 `pending`

**解决**:
1. 检查订单的 `deliveryStatus` 字段
2. 确认订单状态是 `completed`
3. 检查已完成订单列表的过滤逻辑

### 问题4: 发货页面显示异常
**原因**: 订单数据不完整

**解决**:
1. 检查订单是否有完整的数据字段
2. 查看浏览器控制台是否有错误
3. 确认路由参数 ID 正确传递

### 问题5: 统计数据不准确
**原因**: 统计逻辑错误或数据未刷新

**解决**:
1. 检查 `getStatistics()` 方法
2. 确认过滤条件正确
3. 手动刷新页面

---

## 📊 测试数据准备

### 创建测试订单的便捷方法

在浏览器控制台执行以下代码,快速创建测试订单:

```javascript
// 创建一个完整流程的测试订单
function createTestOrder(status = 'pending') {
  const orders = JSON.parse(localStorage.getItem('orderList') || '[]')
  
  const newOrder = {
    id: orders.length + 1,
    orderNo: 'ORD' + Date.now() + Math.random().toString(36).substr(2, 4).toUpperCase(),
    customerName: '测试客户',
    country: '孟加拉国',
    validity: '3',
    source: '公开数据',
    quantity: 10000,
    operators: [
      { name: 'Grameenphone', count: 4000 },
      { name: 'Robi', count: 3000 },
      { name: 'Banglalink', count: 2000 },
      { name: 'Teletalk', count: 1000 }
    ],
    totalAmount: '50.00',
    deliveryEmail: 'test@example.com',
    status: status,
    deliveryStatus: status === 'completed' ? 'pending' : 'pending',
    createTime: Date.now(),
    reviewTime: status === 'reviewing' || status === 'completed' ? Date.now() : null,
    approveTime: status === 'completed' ? Date.now() : null,
    deliveryTime: null,
    remark: '测试订单'
  }
  
  orders.push(newOrder)
  localStorage.setItem('orderList', JSON.stringify(orders))
  
  console.log('✅ 测试订单创建成功:', newOrder.orderNo)
  return newOrder
}

// 使用示例:
createTestOrder('pending')     // 创建待处理订单
createTestOrder('reviewing')   // 创建待审核订单
createTestOrder('completed')   // 创建已完成(待发货)订单
```

### 清空测试数据

```javascript
// 清空所有订单(谨慎使用!)
localStorage.removeItem('orderList')
console.log('✅ 所有订单已清空')

// 或者只删除测试订单
const orders = JSON.parse(localStorage.getItem('orderList') || '[]')
const filteredOrders = orders.filter(o => !o.orderNo.startsWith('ORD'))
localStorage.setItem('orderList', JSON.stringify(filteredOrders))
console.log('✅ 测试订单已清空')
```

---

## ✅ 测试完成清单

完成以下所有测试项,确保功能正常:

### 基础功能测试
- [ ] 客户购买数据生成订单
- [ ] 客户提交订单审核
- [ ] 代理查看待审核订单
- [ ] 代理审核通过订单
- [ ] 代理审核拒绝订单
- [ ] 查看已完成订单
- [ ] 邮箱方式发货
- [ ] TGbot方式发货
- [ ] 查看已发货订单

### 数据准确性测试
- [ ] 订单状态流转正确
- [ ] 时间字段记录完整
- [ ] 统计数据准确
- [ ] 数据持久化正常

### 界面交互测试
- [ ] 按钮显示逻辑正确
- [ ] 表单验证正常
- [ ] 提示消息显示正确
- [ ] 页面跳转正常
- [ ] 自动刷新机制正常

### 权限控制测试
- [ ] 客户权限正确
- [ ] 代理权限正确
- [ ] 管理员权限正确
- [ ] 菜单显示根据角色过滤

### 异常场景测试
- [ ] 订单不存在的处理
- [ ] 数据格式错误的处理
- [ ] 网络异常的处理
- [ ] 表单验证失败的提示

---

## 🎉 测试通过标准

所有测试项都勾选完成,且:
- ✅ 没有控制台错误
- ✅ 数据流转完整
- ✅ 界面显示正确
- ✅ 权限控制有效
- ✅ 用户体验良好

---

**测试指南版本**: v1.0  
**更新日期**: 2025-10-12  
**测试人员**: _____________  
**测试时间**: _____________
