# 🧪 代理权限系统 - 完整功能测试指南

## 📋 测试概述

**测试目标**: 验证代理权限系统的完整功能  
**测试范围**: 前端 + 后端完整流程  
**测试时间**: 约30分钟  

---

## 🚀 测试准备

### 1. 启动后端服务

```bash
cd /home/vue-element-admin/backend
node server.js
```

**预期输出**:
```
✅ 数据库连接成功
📊 数据库模型同步完成
🚀 服务器启动成功
📍 服务地址: http://localhost:3000
```

### 2. 启动前端服务

```bash
cd /home/vue-element-admin
npm run dev
```

**预期输出**:
```
App running at:
- Local:   http://localhost:9527/
```

---

## 📝 测试用例

### 第一部分: 登录和Token测试

#### 测试1.1: Admin登录
**步骤**:
1. 打开浏览器访问 `http://localhost:9527`
2. 输入账号: `admin`
3. 输入密码: `111111`
4. 点击登录

**预期结果**:
- ✅ 登录成功
- ✅ 跳转到首页
- ✅ localStorage存储了Token
- ✅ Token格式为JWT (以ey开头)

**验证方法**:
```javascript
// 在浏览器Console执行
localStorage.getItem('vue_admin_token')
// 应该返回类似: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

#### 测试1.2: 查看请求头
**步骤**:
1. 保持登录状态
2. 打开浏览器开发者工具 (F12)
3. 切换到 Network 标签
4. 访问任意页面 (如客户列表)
5. 查看API请求

**预期结果**:
- ✅ 请求头包含: `Authorization: Bearer eyJhbGci...`
- ✅ 请求头包含: `X-Token: eyJhbGci...`

---

### 第二部分: Admin权限测试

#### 测试2.1: 查看所有客户
**步骤**:
1. 使用admin账号登录
2. 访问: 用户管理 → 客户列表

**预期结果**:
- ✅ 显示所有客户(不限制代理)
- ✅ 有"创建客户"按钮
- ✅ 每行有"编辑"和"更多"按钮

#### 测试2.2: 创建客户
**步骤**:
1. 点击"创建客户"按钮
2. 填写客户信息
3. 点击保存

**预期结果**:
- ✅ 创建成功
- ✅ 返回客户列表
- ✅ 新客户显示在列表中

#### 测试2.3: 编辑客户
**步骤**:
1. 点击某个客户的"编辑"按钮
2. 修改信息
3. 保存

**预期结果**:
- ✅ 编辑成功
- ✅ 修改生效

#### 测试2.4: 充值/扣款
**步骤**:
1. 点击客户的"更多"按钮
2. 选择"充值"或"扣款"
3. 输入金额
4. 确认

**预期结果**:
- ✅ 操作成功
- ✅ 余额更新

---

### 第三部分: Agent权限测试

#### 测试3.1: Agent登录
**步骤**:
1. 退出admin账号
2. 使用agent账号登录 (如果有的话)

**预期结果**:
- ✅ 登录成功
- ✅ 显示代理首页

#### 测试3.2: 查看客户列表 (只读)
**步骤**:
1. 访问: 用户管理 → 客户列表

**预期结果**:
- ✅ 只显示本代理的客户
- ✅ **没有**"创建客户"按钮
- ✅ **没有**"编辑"按钮
- ✅ **没有**"更多"菜单
- ✅ 只有"详情"按钮

**验证数据过滤**:
```javascript
// 在Console查看API响应
// Network → XHR → /api/users
// 响应数据中所有客户的agent_id应该相同
```

#### 测试3.3: 尝试创建客户 (应失败)
**步骤**:
1. 手动访问URL: `http://localhost:9527/user/customer/create`
2. 或使用API测试工具

**预期结果**:
- ✅ 前端应该被路由守卫拦截
- ✅ 或后端返回403错误
- ✅ 显示"权限不足"提示

#### 测试3.4: 查看订单列表
**步骤**:
1. 访问: 订单管理 → 订单列表

**预期结果**:
- ✅ 只显示本代理客户的订单
- ✅ 不显示其他代理的订单

#### 测试3.5: 审核订单
**步骤**:
1. 访问: 订单管理 → 审核订单
2. 找到待审核订单
3. 点击"通过"或"拒绝"

**预期结果**:
- ✅ 审核成功
- ✅ 订单状态更新
- ✅ 记录审核时间

#### 测试3.6: 发货订单
**步骤**:
1. 访问: 订单管理 → 已完成订单
2. 找到待发货订单
3. 点击"发货"
4. 填写发货信息

**预期结果**:
- ✅ 发货成功
- ✅ 订单状态更新为已发货

#### 测试3.7: 编辑反馈
**步骤**:
1. 访问: 数据反馈 → 反馈列表
2. 点击"编辑"
3. 修改反馈内容

**预期结果**:
- ✅ 编辑成功
- ✅ 只能编辑本代理客户的反馈

---

### 第四部分: 错误处理测试

#### 测试4.1: 401错误 - Token过期
**步骤**:
1. 登录系统
2. 在Console清除Token:
   ```javascript
   localStorage.removeItem('vue_admin_token')
   ```
3. 刷新页面或访问任意API

**预期结果**:
- ✅ 显示提示: "身份验证失败,请重新登录"
- ✅ 自动跳转到登录页
- ✅ Token被清除

#### 测试4.2: 403错误 - 权限不足
**步骤**:
1. 使用agent账号登录
2. 使用API工具尝试创建客户:
   ```bash
   curl -X POST http://localhost:3000/api/users \
     -H "Authorization: Bearer AGENT_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"loginAccount":"test"}'
   ```

**预期结果**:
- ✅ 返回403状态码
- ✅ 错误消息: "权限不足: 仅管理员可访问"
- ✅ 前端显示权限错误提示

#### 测试4.3: 越权访问测试
**步骤**:
1. 使用agent1账号登录
2. 尝试访问agent2的客户详情
3. 或尝试审核agent2客户的订单

**预期结果**:
- ✅ 返回403错误
- ✅ 显示"权限不足"提示
- ✅ 后端日志记录越权尝试

---

### 第五部分: 数据隔离测试

#### 测试5.1: 客户数据隔离
**步骤**:
1. 创建2个代理账号: agent1, agent2
2. 创建客户分配给不同代理
3. 使用agent1登录查看客户列表

**预期结果**:
- ✅ agent1只能看到自己的客户
- ✅ 看不到agent2的客户

**验证方法**:
```javascript
// 在Console查看API响应
fetch('/api/users', {
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('vue_admin_token')
  }
}).then(r => r.json()).then(data => {
  console.log('客户列表:', data)
  // 所有客户的agent_id应该相同
})
```

#### 测试5.2: 订单数据隔离
**步骤**:
1. 使用agent1登录
2. 查看订单列表

**预期结果**:
- ✅ 只显示agent1客户的订单
- ✅ 不显示agent2客户的订单

#### 测试5.3: 反馈数据隔离
**步骤**:
1. 使用agent1登录
2. 查看反馈列表

**预期结果**:
- ✅ 只显示agent1客户的反馈
- ✅ 不显示agent2客户的反馈

---

### 第六部分: 性能测试

#### 测试6.1: API响应时间
**步骤**:
1. 打开Network标签
2. 访问客户列表页面
3. 查看API响应时间

**预期结果**:
- ✅ API响应时间 < 500ms
- ✅ Token验证时间 < 100ms
- ✅ 数据过滤不影响性能

#### 测试6.2: 并发请求
**步骤**:
1. 同时打开多个页面
2. 同时发起多个请求

**预期结果**:
- ✅ 所有请求正常处理
- ✅ Token验证正确
- ✅ 无并发问题

---

## 📊 测试报告模板

### 测试结果记录

| 测试编号 | 测试项 | 预期结果 | 实际结果 | 状态 | 备注 |
|---------|--------|---------|---------|------|------|
| 1.1 | Admin登录 | 登录成功 |  | ⏳ |  |
| 1.2 | Token生成 | JWT格式 |  | ⏳ |  |
| 2.1 | 查看所有客户 | 显示全部 |  | ⏳ |  |
| 2.2 | 创建客户 | 创建成功 |  | ⏳ |  |
| 3.1 | Agent登录 | 登录成功 |  | ⏳ |  |
| 3.2 | 客户列表(只读) | 只有详情按钮 |  | ⏳ |  |
| 3.3 | 尝试创建客户 | 403错误 |  | ⏳ |  |
| 3.4 | 数据过滤 | 只看到本代理数据 |  | ⏳ |  |
| 4.1 | 401错误 | 跳转登录 |  | ⏳ |  |
| 4.2 | 403错误 | 权限提示 |  | ⏳ |  |
| 5.1 | 客户隔离 | 数据隔离正确 |  | ⏳ |  |
| 5.2 | 订单隔离 | 数据隔离正确 |  | ⏳ |  |

---

## 🐛 常见问题

### 问题1: 登录后Token未生成
**症状**: 登录成功但没有Token  
**原因**: 后端未返回Token  
**解决**: 检查后端auth.js路由

### 问题2: 401错误但没有跳转登录
**症状**: 显示401错误,但不跳转  
**原因**: 前端拦截器未正确配置  
**解决**: 检查request.js响应拦截器

### 问题3: 代理能看到所有客户
**症状**: 数据过滤失效  
**原因**: 后端未添加数据过滤  
**解决**: 检查users.js路由的where条件

### 问题4: Token验证失败
**症状**: 提示Token无效  
**原因**: JWT密钥不匹配  
**解决**: 确保前后端使用相同JWT_SECRET

---

## ✅ 验收标准

### 功能完整性
- [ ] Admin可以访问所有功能
- [ ] Agent只能访问允许的功能
- [ ] Customer只能访问自己的数据
- [ ] 数据隔离正确
- [ ] 权限验证有效

### 安全性
- [ ] Token使用JWT标准格式
- [ ] Token有过期时间
- [ ] 越权访问被拦截
- [ ] 敏感操作有日志

### 用户体验
- [ ] 错误提示友好
- [ ] Token过期自动处理
- [ ] 权限不足有明确提示
- [ ] 页面加载流畅

### 性能
- [ ] API响应时间正常
- [ ] Token验证不影响性能
- [ ] 数据过滤性能良好

---

## 🎯 快速测试命令

### 后端API测试

```bash
# 1. 测试登录
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"loginAccount":"admin","loginPassword":"111111"}'

# 2. 保存返回的Token
TOKEN="从上面响应中复制的token"

# 3. 测试获取客户列表
curl -X GET "http://localhost:3000/api/users" \
  -H "Authorization: Bearer $TOKEN"

# 4. 测试无Token访问(应该401)
curl -X GET "http://localhost:3000/api/users"

# 5. 测试无效Token(应该403)
curl -X GET "http://localhost:3000/api/users" \
  -H "Authorization: Bearer INVALID_TOKEN"
```

---

## 📚 相关文档

- [`前端Token集成实施报告.md`](./前端Token集成实施报告.md)
- [`后端权限控制实施报告.md`](./后端权限控制实施报告.md)
- [`代理角色权限定义.md`](./代理角色权限定义.md)
- [`代理权限完整实施总结.md`](./代理权限完整实施总结.md)

---

**文档版本**: v1.0  
**创建日期**: 2025-10-15  
**测试时长**: 约30分钟  
**难度等级**: 中等
