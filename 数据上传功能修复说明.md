# 数据上传功能修复说明

## 问题描述
新增数据时无法上传文件到服务器并存储到数据库中。

## 修复内容

### 1. 前端修复 (`src/views/data/library.vue`)

#### 文件上传到服务器
```javascript
async uploadFileToServer(file) {
  // 使用完整URL调用后端API
  const response = await this.$http({
    url: 'http://localhost:3000/api/upload/upload',
    method: 'post',
    data: formData,
    headers: {
      'Content-Type': 'multipart/form-data'
    },
    timeout: 60000
  })
  
  // 降级处理：如果API调用失败，使用本地计算行数
  if (error) {
    this.calculateFileLines(file)
    this.fileInfo.serverPath = null // 标记未上传到服务器
  }
}
```

#### 创建数据记录
```javascript
async createDataWithFile() {
  const requestData = {
    // 基本数据信息
    country: this.editForm.countryCode,
    country_name: countryInfo.name,
    dataType: this.editForm.dataType,
    validity: this.editForm.validity,
    source: this.editForm.source,
    operators: operators,
    sellPrice: this.editForm.sellPrice,
    costPrice: this.editForm.costPrice,
    
    // 文件信息
    fileName: this.fileInfo.name,
    filePath: this.fileInfo.serverPath,
    fileSize: this.fileInfo.size,
    fileHash: this.fileInfo.hash,
    fileLines: this.fileInfo.lines
  }
  
  // 调用后端API保存
  await this.$http({
    url: 'http://localhost:3000/api/upload/create-with-file',
    method: 'post',
    data: requestData
  })
}
```

### 2. 后端修复 (`backend/routes/data.js`)

#### 支持文件信息字段
```javascript
router.post('/', async (req, res) => {
  const data = await DataLibrary.create({
    country: countryCode || country,
    country_name: country_name || country,
    data_type: dataType || data_type,
    validity: validityCode,
    validity_name: validityName,
    source: source || '数据上传',
    total_quantity: quantity,
    available_quantity: quantity,
    operators: operators || [],
    sell_price: sellPrice || sell_price || 0,
    cost_price: costPrice || cost_price || 0,
    remark: remark || '',
    
    // 新增：文件信息字段
    file_name: fileName || null,
    file_path: filePath || null,
    file_size: fileSize || null,
    file_hash: fileHash || null,
    
    upload_time: Date.now(),
    upload_by: uploadBy || upload_by || 'system',
    publish_time: null,
    publish_status: 'pending',
    status: 'uploaded',
    create_time: Date.now()
  });
});
```

## 数据流程

### 新增数据流程
```
1. 用户选择文件
   ↓
2. 文件上传到服务器 (POST /api/upload/upload)
   - 保存文件到 backend/uploads/日期/文件名
   - 计算文件MD5哈希
   - 统计文件行数
   - 返回文件信息（路径、大小、行数、哈希）
   ↓
3. 填写数据基本信息（国家、类型、价格等）
   ↓
4. 创建数据记录 (POST /api/upload/create-with-file)
   - 保存数据信息到 data_library 表
   - 状态为 pending（待发布）
   - 包含文件路径、大小、哈希等信息
   ↓
5. 数据保存成功
   - 可在数据列表中查看
   - 可进行发布操作
```

### 数据库字段对应

| 前端字段 | 后端字段 | 数据库字段 | 说明 |
|---------|---------|-----------|------|
| fileName | fileName | file_name | 原始文件名 |
| serverPath | filePath | file_path | 服务器存储路径 |
| size | fileSize | file_size | 文件大小（字节） |
| hash | fileHash | file_hash | MD5哈希值 |
| lines | fileLines | total_quantity | 文件行数 |

## 降级策略

### 本地存储降级
如果后端服务不可用，系统会自动降级到localStorage：

```javascript
try {
  // 尝试调用数据库API
  await this.$http({ url: 'http://localhost:3000/api/upload/...' })
} catch (error) {
  // 降级到localStorage
  localStorage.setItem('dataListData', JSON.stringify(dataListData))
}
```

### 文件上传降级
如果文件上传失败，使用本地计算行数：

```javascript
try {
  // 上传文件到服务器
  await uploadFileToServer(file)
} catch (error) {
  // 本地读取文件计算行数
  this.calculateFileLines(file)
  this.fileInfo.serverPath = null // 标记未上传
}
```

## 测试步骤

### 1. 启动后端服务
```bash
cd backend
npm install
npm start
```

### 2. 启动前端服务
```bash
npm run dev
```

### 3. 测试数据上传
1. 访问：http://localhost:9528/#/data/library
2. 点击"新增数据"按钮
3. 填写基本信息：
   - 选择国家
   - 输入数据类型
   - 选择时效性
   - 输入价格
4. 上传文件（.txt格式）
5. 点击"确定"保存

### 4. 验证结果
- 检查后端日志：文件上传成功
- 检查数据库：data_library表中有新记录
- 检查文件存储：backend/uploads/日期/目录下有文件
- 前端显示：数据列表中显示新数据，状态为"待发布"

## API端点

### 文件上传
```
POST http://localhost:3000/api/upload/upload
Content-Type: multipart/form-data

Request:
- file: 文件对象

Response:
{
  "success": true,
  "data": {
    "originalName": "test.txt",
    "filename": "1234567890_abc.txt",
    "path": "/home/vue-element-admin/backend/uploads/2023-12-01/1234567890_abc.txt",
    "size": 1024,
    "hash": "abc123def456",
    "lines": 1000,
    "uploadTime": 1701417600000
  }
}
```

### 创建数据记录
```
POST http://localhost:3000/api/upload/create-with-file
Content-Type: application/json

Request:
{
  "country": "BD",
  "country_name": "孟加拉国",
  "dataType": "手机号码",
  "validity": "3",
  "validity_name": "3天内",
  "source": "数据上传",
  "operators": [...],
  "sellPrice": 0.05,
  "costPrice": 0.02,
  "remark": "备注",
  "fileName": "test.txt",
  "filePath": "/home/vue-element-admin/backend/uploads/2023-12-01/1234567890_abc.txt",
  "fileSize": 1024,
  "fileHash": "abc123def456",
  "fileLines": 1000
}

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "country": "BD",
    "country_name": "孟加拉国",
    ...
  },
  "message": "数据创建成功"
}
```

## 注意事项

1. **文件格式**：只支持 .txt 格式文件
2. **文件大小**：不超过 100MB
3. **存储位置**：backend/uploads/日期/文件名
4. **数据状态**：新上传数据默认为"待发布"状态
5. **发布操作**：需要手动发布后才会显示在资源中心

## 数据库表结构

### data_library 表
```sql
CREATE TABLE data_library (
  id INT PRIMARY KEY AUTO_INCREMENT,
  country VARCHAR(10) NOT NULL,
  country_name VARCHAR(50) NOT NULL,
  data_type VARCHAR(100),
  validity VARCHAR(20) NOT NULL,
  validity_name VARCHAR(50) NOT NULL,
  total_quantity INT DEFAULT 0,
  available_quantity INT DEFAULT 0,
  source VARCHAR(200),
  sell_price DECIMAL(10, 5) DEFAULT 0,
  cost_price DECIMAL(10, 5) DEFAULT 0,
  remark TEXT,
  file_name VARCHAR(255),        -- 文件名
  file_path VARCHAR(500),        -- 文件路径
  file_size BIGINT,              -- 文件大小
  file_hash VARCHAR(64),         -- MD5哈希
  operators JSON,
  upload_time BIGINT NOT NULL,
  upload_by VARCHAR(50),
  publish_time BIGINT,
  publish_status VARCHAR(20) DEFAULT 'pending',
  status VARCHAR(20) DEFAULT 'uploaded',
  create_time BIGINT NOT NULL,
  update_time BIGINT
);
```

## 修复完成标记

✅ 前端文件上传逻辑修复
✅ 后端数据保存逻辑修复
✅ 文件信息字段支持
✅ 降级策略实现
✅ API端点配置
✅ 数据流程完善

## 下一步优化建议

1. 添加文件预览功能
2. 支持批量上传文件
3. 添加文件去重检测（基于MD5）
4. 实现文件压缩存储
5. 添加文件下载功能
6. 实现文件定期清理
