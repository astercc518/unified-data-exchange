# 数据列表新增数据功能升级说明

## 📋 功能概述

数据列表页面的新增数据对话框已升级，新增了**文件上传功能**，与数据上传页面功能完全一致。

## ✨ 新增功能

### 1. 双模式数据录入

用户现在可以选择两种方式录入数据：

#### 方式一：手动输入数量
- 传统的手动输入方式
- 适合少量数据或已知数量的场景
- 直接在"数据数量"字段输入数值

#### 方式二：文件上传
- 上传TXT文件自动计算数量
- 支持拖拽上传或点击选择
- 自动读取文件内容并统计行数
- 自动填充到"数据数量"字段

### 2. 文件上传特性

#### 支持的文件格式
- ✅ TXT 文本文件
- ✅ 最大文件大小：100MB

#### 智能行数计算
- **小文件（≤10MB）**：完整读取，精确计算非空行数
- **大文件（>10MB）**：采样前1MB，智能估算总行数
- 自动过滤空行，确保数据准确性

#### 文件信息展示
上传文件后，系统会显示：
- 📁 文件名
- 📊 文件大小
- 📈 数据行数（自动计算）
- ⏰ 上传时间

### 3. 表单布局（遵循记忆规范）

新增数据对话框采用标准的四行布局：

```
第一行：国家 | 数据类型 | 数据来源
第二行：时效性 | 成本价 | 销售价
第三行：备注（整行）
第四行：利润率 | [数据数量/文件上传]
```

**数据录入方式选择**：
- 在第四行利润率下方新增了录入方式切换
- 单选框切换：手动输入数量 / 文件上传

## 🎯 使用流程

### 使用文件上传模式新增数据

1. **打开新增对话框**
   - 点击数据列表页面的"新增数据"按钮

2. **填写基本信息**
   - 选择国家
   - 输入数据类型（自由文本）
   - 输入数据来源
   - 选择时效性（3天内/30天内/30天以上）
   - 输入成本价和销售价

3. **选择录入方式**
   - 选择"文件上传"单选按钮
   - 手动输入数量字段会隐藏，显示文件上传区域

4. **上传文件**
   - 拖拽TXT文件到上传区域，或点击选择文件
   - 系统自动读取文件并计算行数
   - 数据数量会自动填充

5. **查看文件信息**
   - 文件上传成功后，下方会显示文件详细信息
   - 确认数据行数是否正确

6. **保存数据**
   - 点击"确定"按钮保存
   - 数据会保存为"待发布"状态
   - 需要在数据列表页面显式发布到资源中心

### 使用手动输入模式

1. 保持默认选择"手动输入数量"
2. 填写所有必填字段
3. 在"数据数量"字段直接输入数值
4. 点击"确定"保存

## 🔄 模式切换

### 从手动输入切换到文件上传
- 点击"文件上传"单选框
- 系统会清空当前的数量值
- 显示文件上传区域

### 从文件上传切换到手动输入
- 点击"手动输入数量"单选框
- 系统会清空文件信息和文件列表
- 显示数量输入框
- 数量值重置为0

## 💡 技术实现

### 关键功能代码

#### 文件行数计算
```javascript
calculateFileLines(file) {
  const reader = new FileReader()
  reader.onload = (e) => {
    const text = e.target.result
    const lines = text.split('\n').filter(line => line.trim().length > 0)
    this.fileInfo.lines = lines.length
    this.editForm.availableQuantity = lines.length
  }
  
  // 大文件优化：只读取前1MB进行采样估算
  if (file.size > 10 * 1024 * 1024) {
    const blob = file.slice(0, 1024 * 1024)
    reader.readAsText(blob, 'utf-8')
  } else {
    reader.readAsText(file, 'utf-8')
  }
}
```

#### 模式切换处理
```javascript
handleUploadModeChange(mode) {
  this.uploadMode = mode
  
  if (!mode) {
    // 切换到手动输入，清空文件信息
    this.fileList = []
    this.fileInfo = { name: '', size: 0, lines: 0, uploadTime: '' }
    this.editForm.availableQuantity = 0
    this.$refs.upload.clearFiles()
  }
}
```

### 数据保存逻辑

遵循记忆规范：**数据发布流程控制**

```javascript
// 新增数据保存到 dataListData（待发布状态）
const newData = {
  ...this.editForm,
  id: maxId + 1,
  country: countryInfo.name,
  operators: this.generateOperators(this.editForm.availableQuantity, this.editForm.countryCode),
  uploadTime: Date.now(),
  publishTime: null,        // 不设置发布时间
  publishStatus: 'pending', // 待发布状态
  status: 'uploaded'
}

dataListData.push(newData)
localStorage.setItem('dataListData', JSON.stringify(dataListData))
```

## 📊 数据流程

```
新增数据对话框
    ↓
选择录入方式
    ├─ 手动输入 → 输入数量 → 保存
    └─ 文件上传 → 选择文件 → 自动计算 → 保存
         ↓
    保存到 dataListData
    (待发布状态)
         ↓
    在数据列表中显示
    (发布状态: 待发布)
         ↓
    点击"发布"按钮
         ↓
    迁移到 dataList
    (资源中心可见)
```

## 🎨 界面优化

### 文件上传区域样式
- 拖拽上传区域，支持点击选择
- 文件类型提示
- 文件大小限制提示
- 文件信息表格展示

### 响应式设计
- 支持不同屏幕尺寸
- 移动端友好的布局调整

## ⚠️ 注意事项

1. **文件格式限制**
   - 只支持 .txt 格式文件
   - 文件大小不能超过 100MB

2. **数据准确性**
   - 系统会自动过滤空行
   - 大文件（>10MB）使用估算方式，可能存在小幅误差

3. **模式切换**
   - 切换模式会清空相应的数据
   - 建议确定好录入方式后再填写其他字段

4. **发布流程**
   - 新增的数据不会立即出现在资源中心
   - 必须在数据列表页面点击"发布"按钮
   - 发布后数据才能在资源中心被客户看到

## 🔧 与数据上传页面的一致性

| 特性 | 数据上传页面 | 数据列表新增 |
|------|------------|-------------|
| 文件上传 | ✅ | ✅ |
| 行数计算 | ✅ | ✅ |
| 大文件优化 | ✅ | ✅ |
| 文件信息展示 | ✅ | ✅ |
| 拖拽上传 | ✅ | ✅ |
| 表单布局 | 四行布局 | 四行布局 |
| 国家选择 | 支持搜索分组 | 支持搜索分组 |
| 利润率计算 | ✅ | ✅ |
| 发布流程 | 待发布状态 | 待发布状态 |

## 🚀 使用建议

1. **批量数据录入**
   - 推荐使用文件上传方式
   - 准备好TXT格式的数据文件
   - 一行一条数据记录

2. **单条数据录入**
   - 使用手动输入方式更快捷
   - 直接输入数据数量

3. **数据验证**
   - 上传文件后检查行数是否符合预期
   - 确认所有必填字段已填写
   - 查看利润率是否合理

4. **发布管理**
   - 新增多条数据后统一发布
   - 发布前可以在数据列表中预览
   - 支持批量发布操作

## 📝 版本历史

- **v1.0** - 初始版本，仅支持手动输入
- **v2.0** - 新增文件上传功能，与数据上传页面功能一致

---

**最后更新**: 2025-10-13
**维护人员**: AI Assistant
