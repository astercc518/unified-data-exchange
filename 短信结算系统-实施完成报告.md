# çŸ­ä¿¡å¤šå›½å®¶å®šä»·å’Œç»“ç®—ç³»ç»Ÿ - å®æ–½å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®ä¸ºçŸ­ä¿¡ç³»ç»Ÿæ–°å¢äº†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š
1. **é€šé“å¤šå›½å®¶å®šä»·æ”¯æŒ** - ä¸€ä¸ªé€šé“å¯ä»¥æ”¯æŒå¤šä¸ªå›½å®¶ï¼Œæ¯ä¸ªå›½å®¶è®¾ç½®ä¸åŒçš„æˆæœ¬ä»·å’Œé”€å”®ä»·
2. **çŸ­ä¿¡ç»“ç®—ç®¡ç†** - è‡ªåŠ¨ç»“ç®—å®¢æˆ·é€šè¿‡é€šé“å‘é€çŸ­ä¿¡çš„æˆæœ¬ã€é”€å”®é¢å’Œåˆ©æ¶¦
3. **ä¸šç»©æŠ¥è¡¨ç”Ÿæˆ** - æŒ‰å¤šç»´åº¦ï¼ˆæ—¥æœŸ/å®¢æˆ·/é€šé“/å›½å®¶ï¼‰ç”Ÿæˆä¸šç»©æŠ¥è¡¨

---

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. æ•°æ®åº“è®¾è®¡ä¸åˆ›å»º âœ“

#### 1.1 æ–°å»ºè¡¨

**sms_channel_countries** - é€šé“å›½å®¶å®šä»·è¡¨
```sql
CREATE TABLE `sms_channel_countries` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `channel_id` INT(11) NOT NULL COMMENT 'é€šé“ID',
  `country` VARCHAR(50) NOT NULL COMMENT 'å›½å®¶åç§°',
  `country_code` VARCHAR(10) NOT NULL COMMENT 'å›½å®¶ä»£ç ',
  `cost_price` DECIMAL(10,4) NOT NULL DEFAULT 0 COMMENT 'æˆæœ¬ä»·/æ¡',
  `sale_price` DECIMAL(10,4) NOT NULL DEFAULT 0 COMMENT 'é”€å”®ä»·/æ¡',
  `max_chars` INT(11) NOT NULL DEFAULT 160 COMMENT 'æœ€å¤§å­—ç¬¦æ•°',
  `status` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ 1å¯ç”¨ 0ç¦ç”¨',
  `created_at` DATETIME DEFAULT NULL,
  `updated_at` DATETIME DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_channel_country` (`channel_id`, `country`),
  KEY `idx_channel_id` (`channel_id`),
  KEY `idx_country` (`country`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é€šé“å›½å®¶å®šä»·é…ç½®è¡¨';
```

**sms_settlements** - çŸ­ä¿¡ç»“ç®—æ±‡æ€»è¡¨
```sql
CREATE TABLE `sms_settlements` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `settlement_date` DATE NOT NULL COMMENT 'ç»“ç®—æ—¥æœŸ',
  `customer_id` INT(11) NOT NULL COMMENT 'å®¢æˆ·ID',
  `channel_id` INT(11) NOT NULL COMMENT 'é€šé“ID',
  `country` VARCHAR(50) NOT NULL COMMENT 'å›½å®¶',
  `total_count` INT(11) NOT NULL DEFAULT 0 COMMENT 'æ€»å‘é€æ•°',
  `success_count` INT(11) NOT NULL DEFAULT 0 COMMENT 'æˆåŠŸæ•°é‡',
  `total_cost` DECIMAL(12,4) NOT NULL DEFAULT 0 COMMENT 'æ€»æˆæœ¬',
  `total_revenue` DECIMAL(12,4) NOT NULL DEFAULT 0 COMMENT 'æ€»é”€å”®é¢',
  `total_profit` DECIMAL(12,4) NOT NULL DEFAULT 0 COMMENT 'æ€»åˆ©æ¶¦',
  `cost_price` DECIMAL(10,4) NOT NULL DEFAULT 0 COMMENT 'æˆæœ¬ä»·/æ¡',
  `sale_price` DECIMAL(10,4) NOT NULL DEFAULT 0 COMMENT 'é”€å”®ä»·/æ¡',
  `settlement_status` ENUM('pending','processing','completed','failed') DEFAULT 'pending' COMMENT 'ç»“ç®—çŠ¶æ€',
  `created_at` DATETIME DEFAULT NULL,
  `updated_at` DATETIME DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_settlement` (`settlement_date`, `customer_id`, `channel_id`, `country`),
  KEY `idx_settlement_date` (`settlement_date`),
  KEY `idx_customer_id` (`customer_id`),
  KEY `idx_channel_id` (`channel_id`),
  KEY `idx_status` (`settlement_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='çŸ­ä¿¡ç»“ç®—æ±‡æ€»è¡¨';
```

**sms_settlement_details** - ç»“ç®—æ˜ç»†è¡¨
```sql
CREATE TABLE `sms_settlement_details` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `settlement_id` INT(11) NOT NULL COMMENT 'ç»“ç®—ID',
  `record_id` INT(11) NOT NULL COMMENT 'å‘é€è®°å½•ID',
  `phone_number` VARCHAR(20) NOT NULL COMMENT 'æ‰‹æœºå·ç ',
  `sms_content` TEXT COMMENT 'çŸ­ä¿¡å†…å®¹',
  `cost_price` DECIMAL(10,4) NOT NULL DEFAULT 0 COMMENT 'æˆæœ¬ä»·',
  `sale_price` DECIMAL(10,4) NOT NULL DEFAULT 0 COMMENT 'é”€å”®ä»·',
  `profit` DECIMAL(10,4) NOT NULL DEFAULT 0 COMMENT 'åˆ©æ¶¦',
  `sent_at` DATETIME DEFAULT NULL COMMENT 'å‘é€æ—¶é—´',
  `created_at` DATETIME DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_settlement_id` (`settlement_id`),
  KEY `idx_record_id` (`record_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç»“ç®—æ˜ç»†è¡¨';
```

#### 1.2 ä¿®æ”¹è¡¨

**sms_records** - æ·»åŠ å®šä»·å­—æ®µ
```sql
ALTER TABLE `sms_records` 
ADD COLUMN `cost_price` DECIMAL(10,4) DEFAULT 0 COMMENT 'æˆæœ¬ä»·/æ¡',
ADD COLUMN `sale_price` DECIMAL(10,4) DEFAULT 0 COMMENT 'é”€å”®ä»·/æ¡',
ADD COLUMN `country` VARCHAR(50) COMMENT 'å›½å®¶';
```

---

### 2. åç«¯å¼€å‘ âœ“

#### 2.1 Sequelize æ¨¡å‹ (3ä¸ª)

âœ… **`/backend/models/SmsChannelCountry.js`** (82è¡Œ)
- é€šé“å›½å®¶å®šä»·æ¨¡å‹
- å…³è”å…³ç³»ï¼šbelongsTo SmsChannel

âœ… **`/backend/models/SmsSettlement.js`** (125è¡Œ)
- ç»“ç®—æ±‡æ€»æ¨¡å‹
- å…³è”å…³ç³»ï¼šbelongsTo User, belongsTo SmsChannel

âœ… **`/backend/models/SmsSettlementDetail.js`** (75è¡Œ)
- ç»“ç®—æ˜ç»†æ¨¡å‹
- å…³è”å…³ç³»ï¼šbelongsTo SmsSettlement, belongsTo SmsRecord

âœ… **`/backend/config/database.js`** (å·²ä¿®æ”¹)
- æ³¨å†Œæ–°æ¨¡å‹
- æ·»åŠ æ¨¡å‹å…³è”å…³ç³»

#### 2.2 æ ¸å¿ƒæœåŠ¡ (1ä¸ª)

âœ… **`/backend/services/settlementService.js`** (416è¡Œ)

æ ¸å¿ƒæ–¹æ³•ï¼š
- `autoSettle(date)` - è‡ªåŠ¨ç»“ç®—æŒ‡å®šæ—¥æœŸæ•°æ®
- `calculateSettlement(date, customerId, channelId)` - è®¡ç®—ç»“ç®—
- `reSettlement(settlementId)` - é‡æ–°ç»“ç®—
- `generateReport(params)` - ç”Ÿæˆä¸šç»©æŠ¥è¡¨
- `getSettlementDetail(settlementId)` - è·å–ç»“ç®—è¯¦æƒ…
- å¤šç§åˆ†ç»„ç»Ÿè®¡æ–¹æ³•

#### 2.3 API è·¯ç”± (2ä¸ª)

âœ… **`/backend/routes/smsChannelCountries.js`** (320è¡Œ)

APIæ¥å£ï¼š
- `GET /api/sms/channels/:channelId/countries` - è·å–é€šé“å›½å®¶åˆ—è¡¨
- `GET /api/sms/channels/:channelId/countries/:id` - è·å–è¯¦æƒ…
- `POST /api/sms/channels/:channelId/countries` - æ·»åŠ å›½å®¶é…ç½®
- `PUT /api/sms/channels/:channelId/countries/:id` - æ›´æ–°é…ç½®
- `DELETE /api/sms/channels/:channelId/countries/:id` - åˆ é™¤é…ç½®
- `PUT /api/sms/channels/:channelId/countries/batch/status` - æ‰¹é‡æ›´æ–°çŠ¶æ€
- `GET /api/sms/channels/:channelId/countries/price/:countryCode` - è·å–ä»·æ ¼

âœ… **`/backend/routes/settlements.js`** (506è¡Œ)

APIæ¥å£ï¼š
- `GET /api/sms/settlements` - è·å–ç»“ç®—åˆ—è¡¨
- `GET /api/sms/settlements/:id` - è·å–ç»“ç®—è¯¦æƒ…
- `GET /api/sms/settlements/:id/details` - è·å–ç»“ç®—æ˜ç»†
- `POST /api/sms/settlements/calculate` - æ‰‹åŠ¨è§¦å‘ç»“ç®—
- `POST /api/sms/settlements/:id/resettle` - é‡æ–°ç»“ç®—
- `POST /api/sms/settlements/batch/resettle` - æ‰¹é‡é‡æ–°ç»“ç®—
- `GET /api/sms/settlements/reports/generate` - ç”ŸæˆæŠ¥è¡¨
- `GET /api/sms/settlements/statistics/overview` - ç»Ÿè®¡æ¦‚è§ˆ
- `GET /api/sms/settlements/export/csv` - å¯¼å‡ºCSV

âœ… **`/backend/server.js`** (å·²ä¿®æ”¹)
- æ³¨å†Œæ–°è·¯ç”±
- å¯åŠ¨å®šæ—¶ä»»åŠ¡

#### 2.4 å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ (1ä¸ª)

âœ… **`/backend/tasks/settlementScheduler.js`** (155è¡Œ)

å®šæ—¶ä»»åŠ¡ï¼š
- **è‡ªåŠ¨ç»“ç®—ä»»åŠ¡** - æ¯å¤©å‡Œæ™¨2ç‚¹ç»“ç®—å‰ä¸€å¤©æ•°æ®
- **å‘¨æŠ¥è¡¨ä»»åŠ¡** - æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹ç”Ÿæˆä¸Šå‘¨æŠ¥è¡¨
- **æœˆæŠ¥è¡¨ä»»åŠ¡** - æ¯æœˆ1å·å‡Œæ™¨4ç‚¹ç”Ÿæˆä¸ŠæœˆæŠ¥è¡¨

---

### 3. å‰ç«¯å¼€å‘ âœ“

#### 3.1 API å°è£… (1ä¸ª)

âœ… **`/src/api/smsSettlement.js`** (272è¡Œ)

å°è£…APIæ–¹æ³•ï¼š
- é€šé“å›½å®¶é…ç½®ç›¸å…³ï¼ˆ8ä¸ªæ–¹æ³•ï¼‰
- çŸ­ä¿¡ç»“ç®—ç›¸å…³ï¼ˆ9ä¸ªæ–¹æ³•ï¼‰
- è¾…åŠ©å·¥å…·å‡½æ•°ï¼ˆ4ä¸ªï¼‰

#### 3.2 é¡µé¢ç»„ä»¶ (3ä¸ª)

âœ… **`/src/views/sms/settlement/index.vue`** (675è¡Œ)
- ç»“ç®—åˆ—è¡¨é¡µé¢
- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡
- ç­›é€‰æŸ¥è¯¢åŠŸèƒ½
- æ‰‹åŠ¨ç»“ç®—å¯¹è¯æ¡†
- æŠ¥è¡¨ç”Ÿæˆå¯¹è¯æ¡†
- CSVå¯¼å‡ºåŠŸèƒ½

âœ… **`/src/views/sms/settlement/details.vue`** (202è¡Œ)
- ç»“ç®—æ˜ç»†é¡µé¢
- ç»“ç®—æ¦‚è§ˆä¿¡æ¯å±•ç¤º
- æ˜ç»†åˆ—è¡¨åˆ†é¡µ

âœ… **`/src/components/SmsChannelCountryPricing/index.vue`** (424è¡Œ)
- é€šé“å›½å®¶å®šä»·é…ç½®ç»„ä»¶
- å›½å®¶åˆ—è¡¨ç®¡ç†
- æ·»åŠ /ç¼–è¾‘å›½å®¶å®šä»·
- æ‰¹é‡æ“ä½œåŠŸèƒ½

#### 3.3 è·¯ç”±é…ç½® (1ä¸ª)

âœ… **`/src/router/index.js`** (å·²ä¿®æ”¹)
- æ·»åŠ ç»“ç®—ç®¡ç†è·¯ç”±
- æ·»åŠ ç»“ç®—æ˜ç»†è·¯ç”±ï¼ˆéšè—ï¼‰

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| ç±»åˆ« | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•° |
|------|--------|----------|
| æ•°æ®åº“è¡¨ | 3ä¸ªæ–°è¡¨ + 1ä¸ªä¿®æ”¹ | - |
| åç«¯æ¨¡å‹ | 3ä¸ª | 282è¡Œ |
| åç«¯æœåŠ¡ | 1ä¸ª | 416è¡Œ |
| åç«¯è·¯ç”± | 2ä¸ª | 826è¡Œ |
| å®šæ—¶ä»»åŠ¡ | 1ä¸ª | 155è¡Œ |
| å‰ç«¯API | 1ä¸ª | 272è¡Œ |
| å‰ç«¯é¡µé¢ | 3ä¸ª | 1,301è¡Œ |
| é…ç½®æ–‡ä»¶ | 3ä¸ª | - |
| **æ€»è®¡** | **14ä¸ª** | **3,252è¡Œ** |

---

## âš™ï¸ éƒ¨ç½²æ­¥éª¤

### 1. å®‰è£…ä¾èµ–

åç«¯ä¾èµ–ï¼ˆå·²å®‰è£…ï¼‰ï¼š
- âœ… node-cron (4.2.1)
- âœ… moment (2.29.4)
- âŒ lodash (éœ€è¦å®‰è£…)

```bash
cd backend
npm install lodash --save
```

### 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
# ç™»å½• MariaDB
mysql -u root -p

# é€‰æ‹©æ•°æ®åº“
USE vue_element_admin;

# æ‰§è¡Œå»ºè¡¨SQL
# 1. åˆ›å»º sms_channel_countries è¡¨
# 2. åˆ›å»º sms_settlements è¡¨
# 3. åˆ›å»º sms_settlement_details è¡¨
# 4. ä¿®æ”¹ sms_records è¡¨ï¼ˆæ·»åŠ å­—æ®µï¼‰
```

SQLè„šæœ¬å·²åœ¨ä¸Šæ–¹"1. æ•°æ®åº“è®¾è®¡ä¸åˆ›å»º"éƒ¨åˆ†æä¾›ã€‚

### 3. é‡å¯åç«¯æœåŠ¡

```bash
cd backend
npm run dev
# æˆ–
pm2 restart vue-element-admin-backend
```

æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å®šæ—¶ä»»åŠ¡å¯åŠ¨ï¼š
```
â° å¯åŠ¨çŸ­ä¿¡ç»“ç®—å®šæ—¶ä»»åŠ¡...
  âœ“ è‡ªåŠ¨ç»“ç®—ä»»åŠ¡å·²å¯åŠ¨ (æ¯å¤©å‡Œæ™¨2ç‚¹)
  âœ“ å‘¨æŠ¥è¡¨ä»»åŠ¡å·²å¯åŠ¨ (æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹)
  âœ“ æœˆæŠ¥è¡¨ä»»åŠ¡å·²å¯åŠ¨ (æ¯æœˆ1å·å‡Œæ™¨4ç‚¹)
âœ… æ‰€æœ‰çŸ­ä¿¡ç»“ç®—å®šæ—¶ä»»åŠ¡å¯åŠ¨å®Œæˆ
```

### 4. å‰ç«¯æ— éœ€é¢å¤–æ“ä½œ

æ‰€æœ‰å‰ç«¯ä»£ç å·²åˆ›å»ºå®Œæˆï¼Œåˆ·æ–°é¡µé¢å³å¯çœ‹åˆ°æ–°èœå•ã€‚

---

## ğŸ”§ å¾…å®Œæˆå·¥ä½œ

### 1. ä¿®æ”¹çŸ­ä¿¡å‘é€é€»è¾‘ âš ï¸

**ä½ç½®**: `/backend/routes/smsCustomer.js` æˆ– `/backend/routes/smsAdmin.js`

**éœ€è¦ä¿®æ”¹**: åœ¨çŸ­ä¿¡å‘é€æ—¶ï¼Œæ ¹æ®é€šé“å’Œå›½å®¶è·å–ä»·æ ¼å¹¶è®°å½•

**ç¤ºä¾‹ä»£ç **:
```javascript
const { SmsChannelCountry } = require('../config/database').models;

// åœ¨å‘é€çŸ­ä¿¡å‰ï¼Œè·å–ä»·æ ¼
async function getChannelPrice(channelId, country) {
  const pricing = await SmsChannelCountry.findOne({
    where: {
      channel_id: channelId,
      country: country,
      status: 1
    }
  });
  
  return pricing ? {
    cost_price: pricing.cost_price,
    sale_price: pricing.sale_price
  } : {
    cost_price: 0,
    sale_price: 0
  };
}

// åœ¨åˆ›å»º SmsRecord æ—¶
const { cost_price, sale_price } = await getChannelPrice(channelId, country);

await SmsRecord.create({
  // ... å…¶ä»–å­—æ®µ
  cost_price,
  sale_price,
  country
});
```

### 2. é€šé“ç®¡ç†é¡µé¢é›†æˆå›½å®¶å®šä»·é…ç½® âš ï¸

**ä½ç½®**: `/src/views/sms/admin/channels.vue`

**éœ€è¦ä¿®æ”¹**: åœ¨é€šé“åˆ—è¡¨çš„"æ“ä½œ"æ æ·»åŠ "å›½å®¶å®šä»·"æŒ‰é’®

**ç¤ºä¾‹ä»£ç **:
```vue
<template>
  <div>
    <!-- åœ¨æ“ä½œåˆ—æ·»åŠ æŒ‰é’® -->
    <el-button type="warning" size="mini" @click="handleCountryPricing(row)">
      å›½å®¶å®šä»·
    </el-button>
    
    <!-- æ·»åŠ ç»„ä»¶ -->
    <channel-country-pricing
      :visible.sync="pricingDialogVisible"
      :channel-id="currentChannelId"
      :channel-name="currentChannelName"
    />
  </div>
</template>

<script>
import ChannelCountryPricing from '@/components/SmsChannelCountryPricing'

export default {
  components: { ChannelCountryPricing },
  data() {
    return {
      pricingDialogVisible: false,
      currentChannelId: null,
      currentChannelName: ''
    }
  },
  methods: {
    handleCountryPricing(row) {
      this.currentChannelId = row.id
      this.currentChannelName = row.channel_name
      this.pricingDialogVisible = true
    }
  }
}
</script>
```

### 3. æµ‹è¯•ä¸ä¼˜åŒ– âš ï¸

#### 3.1 åŠŸèƒ½æµ‹è¯•
- [ ] é€šé“å›½å®¶å®šä»·CRUD
- [ ] æ‰‹åŠ¨è§¦å‘ç»“ç®—
- [ ] è‡ªåŠ¨ç»“ç®—å®šæ—¶ä»»åŠ¡
- [ ] é‡æ–°ç»“ç®—åŠŸèƒ½
- [ ] æŠ¥è¡¨ç”Ÿæˆ
- [ ] CSVå¯¼å‡º

#### 3.2 æ•°æ®å‡†ç¡®æ€§éªŒè¯
- [ ] æˆæœ¬ä»·ã€é”€å”®ä»·è®¡ç®—æ­£ç¡®
- [ ] åˆ©æ¶¦è®¡ç®—æ­£ç¡®
- [ ] ç»“ç®—æ±‡æ€»æ•°æ®å‡†ç¡®
- [ ] åˆ†ç»„ç»Ÿè®¡æ­£ç¡®

#### 3.3 æ€§èƒ½ä¼˜åŒ–
- [ ] å¤§é‡æ•°æ®ç»“ç®—æ€§èƒ½
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- [ ] åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### 1. é…ç½®é€šé“å›½å®¶å®šä»·

1. è¿›å…¥ **çŸ­ä¿¡ç®¡ç† > é€šé“é…ç½®**
2. åœ¨é€šé“åˆ—è¡¨ä¸­ç‚¹å‡»æŸä¸ªé€šé“çš„ **"å›½å®¶å®šä»·"** æŒ‰é’®
3. ç‚¹å‡» **"æ·»åŠ å›½å®¶"**
4. å¡«å†™ï¼š
   - é€‰æ‹©å›½å®¶
   - æˆæœ¬ä»·ï¼ˆé‡‡è´­ä»·ï¼‰
   - é”€å”®ä»·ï¼ˆå®¢æˆ·ä»·ï¼‰
   - æœ€å¤§å­—ç¬¦æ•°
   - çŠ¶æ€
5. ç‚¹å‡»ç¡®å®šä¿å­˜

### 2. æŸ¥çœ‹ç»“ç®—è®°å½•

1. è¿›å…¥ **çŸ­ä¿¡ç®¡ç† > çŸ­ä¿¡ç»“ç®—**
2. ä½¿ç”¨ç­›é€‰æ¡ä»¶æŸ¥è¯¢ï¼š
   - æ—¥æœŸèŒƒå›´
   - å®¢æˆ·
   - é€šé“
   - å›½å®¶
   - ç»“ç®—çŠ¶æ€
3. ç‚¹å‡» **"æŸ¥çœ‹æ˜ç»†"** æŸ¥çœ‹è¯¦ç»†è®°å½•

### 3. æ‰‹åŠ¨è§¦å‘ç»“ç®—

1. åœ¨ç»“ç®—åˆ—è¡¨é¡µé¢ç‚¹å‡» **"æ‰‹åŠ¨ç»“ç®—"**
2. é€‰æ‹©ç»“ç®—æ—¥æœŸ
3. ç‚¹å‡» **"ç¡®è®¤ç»“ç®—"**
4. ç³»ç»Ÿå°†ç»“ç®—è¯¥æ—¥æœŸæ‰€æœ‰æˆåŠŸçš„å‘é€è®°å½•

### 4. ç”Ÿæˆä¸šç»©æŠ¥è¡¨

1. åœ¨ç»“ç®—åˆ—è¡¨é¡µé¢ç‚¹å‡» **"ç”ŸæˆæŠ¥è¡¨"**
2. é€‰æ‹©æ—¥æœŸèŒƒå›´
3. é€‰æ‹©åˆ†ç»„ç»´åº¦ï¼š
   - æŒ‰æ—¥æœŸ
   - æŒ‰å®¢æˆ·
   - æŒ‰é€šé“
   - æŒ‰å›½å®¶
4. ç‚¹å‡» **"ç”ŸæˆæŠ¥è¡¨"**

### 5. å¯¼å‡ºæ•°æ®

1. è®¾ç½®ç­›é€‰æ¡ä»¶
2. ç‚¹å‡» **"å¯¼å‡ºCSV"**
3. ä¸‹è½½CSVæ–‡ä»¶

---

## ğŸš€ é«˜çº§åŠŸèƒ½

### å®šæ—¶ä»»åŠ¡ç®¡ç†

å®šæ—¶ä»»åŠ¡å·²è‡ªåŠ¨å¯åŠ¨ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚å¦‚éœ€æ‰‹åŠ¨æ‰§è¡Œï¼š

```javascript
const { manualSettle } = require('./tasks/settlementScheduler');

// æ‰‹åŠ¨ç»“ç®—æŒ‡å®šæ—¥æœŸ
await manualSettle('2025-10-20');
```

### APIä½¿ç”¨ç¤ºä¾‹

#### è·å–ä»·æ ¼ä¿¡æ¯
```bash
GET /api/sms/channels/1/countries/price/86
```

#### æ‰‹åŠ¨ç»“ç®—
```bash
POST /api/sms/settlements/calculate
Content-Type: application/json

{
  "date": "2025-10-20"
}
```

#### ç”ŸæˆæŠ¥è¡¨
```bash
GET /api/sms/settlements/reports/generate?start_date=2025-10-01&end_date=2025-10-20&group_by=customer
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### 1. å®šæ—¶ä»»åŠ¡æœªæ‰§è¡Œ

**æ£€æŸ¥**ï¼šæŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œç¡®è®¤å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨

**è§£å†³**ï¼šé‡å¯åç«¯æœåŠ¡

### 2. ç»“ç®—æ•°æ®ä¸å‡†ç¡®

**åŸå› **ï¼šå‘é€çŸ­ä¿¡æ—¶æœªè®°å½•æˆæœ¬ä»·å’Œé”€å”®ä»·

**è§£å†³**ï¼šå®Œæˆ"å¾…å®Œæˆå·¥ä½œ > 1. ä¿®æ”¹çŸ­ä¿¡å‘é€é€»è¾‘"

### 3. æ— æ³•æŸ¥çœ‹å›½å®¶å®šä»·

**åŸå› **ï¼šé€šé“ç®¡ç†é¡µé¢æœªé›†æˆç»„ä»¶

**è§£å†³**ï¼šå®Œæˆ"å¾…å®Œæˆå·¥ä½œ > 2. é€šé“ç®¡ç†é¡µé¢é›†æˆå›½å®¶å®šä»·é…ç½®"

---

## ğŸ“ˆ æ•°æ®æµç¨‹å›¾

```
å‘é€çŸ­ä¿¡
  â†“
è·å–é€šé“å›½å®¶å®šä»· (sms_channel_countries)
  â†“
è®°å½•å‘é€ä¿¡æ¯ + æˆæœ¬ä»· + é”€å”®ä»· (sms_records)
  â†“
å®šæ—¶ä»»åŠ¡è§¦å‘ (æ¯å¤©å‡Œæ™¨2ç‚¹)
  â†“
æŒ‰æ—¥æœŸ/å®¢æˆ·/é€šé“/å›½å®¶åˆ†ç»„
  â†“
åˆ›å»ºç»“ç®—æ±‡æ€» (sms_settlements)
  â†“
åˆ›å»ºç»“ç®—æ˜ç»† (sms_settlement_details)
  â†“
ç”ŸæˆæŠ¥è¡¨/å¯¼å‡ºCSV
```

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### âœ… å·²å®ç°

1. **å¤šå›½å®¶å®šä»·æ”¯æŒ**
   - ä¸€ä¸ªé€šé“æ”¯æŒå¤šä¸ªå›½å®¶
   - æ¯ä¸ªå›½å®¶ç‹¬ç«‹è®¾ç½®æˆæœ¬ä»·å’Œé”€å”®ä»·
   - å®æ—¶è®¡ç®—åˆ©æ¶¦ç‡

2. **è‡ªåŠ¨ç»“ç®—**
   - æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç»“ç®—å‰ä¸€å¤©æ•°æ®
   - æŒ‰å®¢æˆ·ã€é€šé“ã€å›½å®¶ç»´åº¦æ±‡æ€»
   - è®¡ç®—æ€»æˆæœ¬ã€æ€»æ”¶å…¥ã€æ€»åˆ©æ¶¦

3. **ä¸šç»©æŠ¥è¡¨**
   - å¤šç»´åº¦åˆ†ç»„ç»Ÿè®¡ï¼ˆæ—¥æœŸ/å®¢æˆ·/é€šé“/å›½å®¶ï¼‰
   - å¯è§†åŒ–ç»Ÿè®¡æ¦‚è§ˆ
   - CSVå¯¼å‡ºåŠŸèƒ½

4. **æ•°æ®å®‰å…¨**
   - æ•°æ®åº“äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
   - é‡æ–°ç»“ç®—åŠŸèƒ½
   - è¯¦ç»†çš„æ˜ç»†è®°å½•

5. **ç”¨æˆ·ä½“éªŒ**
   - ç›´è§‚çš„UIç•Œé¢
   - çµæ´»çš„ç­›é€‰æŸ¥è¯¢
   - å®æ—¶è®¡ç®—å±•ç¤º

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- ğŸ“„ `/çŸ­ä¿¡å¤šå›½å®¶å®šä»·å’Œç»“ç®—ç³»ç»Ÿ-å®æ–½æ–¹æ¡ˆ.md` (517è¡Œ) - è¯¦ç»†è®¾è®¡æ–‡æ¡£
- ğŸ“„ `/çŸ­ä¿¡ç»“ç®—ç³»ç»Ÿ-å®Œæ•´å®æ–½ä»£ç .md` (1031è¡Œ) - å®Œæ•´ä»£ç æ¨¡æ¿
- ğŸ“„ æœ¬æ–‡æ¡£ - å®æ–½å®ŒæˆæŠ¥å‘Š

---

## ğŸ‘¥ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒä»¥ä¸Šæ–‡æ¡£æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-10-21  
**ç³»ç»Ÿç‰ˆæœ¬**: v1.0.0  
**å¼€å‘çŠ¶æ€**: æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œå¾…é›†æˆçŸ­ä¿¡å‘é€é€»è¾‘

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å®æ–½å…±å®Œæˆï¼š
- âœ… 3ä¸ªæ•°æ®åº“è¡¨åˆ›å»º + 1ä¸ªè¡¨ä¿®æ”¹
- âœ… 3ä¸ªSequelizeæ¨¡å‹
- âœ… 1ä¸ªæ ¸å¿ƒæœåŠ¡ï¼ˆ416è¡Œï¼‰
- âœ… 2ä¸ªAPIè·¯ç”±ï¼ˆ826è¡Œï¼‰
- âœ… 1ä¸ªå®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨
- âœ… 1ä¸ªå‰ç«¯APIå°è£…
- âœ… 3ä¸ªå‰ç«¯é¡µé¢ç»„ä»¶
- âœ… è·¯ç”±é…ç½®
- âœ… å®Œæ•´çš„è®¾è®¡å’Œå®æ–½æ–‡æ¡£

**æ€»ä»£ç é‡**: 3,252è¡Œ

**ä¸‹ä¸€æ­¥**: 
1. å®‰è£…lodashä¾èµ–
2. æ‰§è¡Œæ•°æ®åº“è¿ç§»
3. ä¿®æ”¹çŸ­ä¿¡å‘é€é€»è¾‘ä»¥è®°å½•ä»·æ ¼
4. åœ¨é€šé“ç®¡ç†é¡µé¢é›†æˆå›½å®¶å®šä»·é…ç½®
5. å…¨é¢æµ‹è¯•å’Œä¼˜åŒ–

æ ¸å¿ƒåŠŸèƒ½å·²ç»å®Œæ•´å®ç°ï¼Œç³»ç»Ÿå¯ä»¥ç‹¬ç«‹è¿è¡Œã€‚åªéœ€å®ŒæˆçŸ­ä¿¡å‘é€é€»è¾‘çš„é›†æˆï¼Œå³å¯æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼
