# 阶梯动态定价规则说明

## 📋 业务需求

动态定价针对**时效为"3天内"的数据**，从发布当天开始进行阶梯降价销售。

---

## 🎯 定价规则

### 阶段划分

定价分为4个阶段，根据发布天数进行阶梯降价：

| 阶段 | 发布天数 | 降价规则 | 时效显示 |
|------|---------|---------|---------|
| **阶段1** | 0-3天 | 保持原价（100%） | 3天内 |
| **阶段2** | 4-7天 | 每天降价5%叠加 | 7天内 |
| **阶段3** | 8-15天 | 每天降价2%叠加 | 15天内 |
| **阶段4** | 16-30天 | 每天降价1%叠加 | 30天内 |
| **超期** | 30天+ | 最大降价50% | 近期 |

---

## 📐 详细计算公式

### 阶段1: 0-3天（原价期）
```
当前价格 = 原价 × 100%
降价比例 = 0%
```

**示例**：
- 原价 $0.10
- 第0天: $0.10 (0%)
- 第1天: $0.10 (0%)
- 第2天: $0.10 (0%)
- 第3天: $0.10 (0%)

---

### 阶段2: 4-7天（快速降价期）
```
降价天数 = 当前天数 - 3
降价比例 = 降价天数 × 5%
当前价格 = 原价 × (1 - 降价比例)
```

**示例**（原价 $0.10）：
- 第4天: $0.10 × (1 - 5%) = **$0.0950** (-5%)
- 第5天: $0.10 × (1 - 10%) = **$0.0900** (-10%)
- 第6天: $0.10 × (1 - 15%) = **$0.0850** (-15%)
- 第7天: $0.10 × (1 - 20%) = **$0.0800** (-20%)

**累计降价**: 最多 20% (4天 × 5%)

---

### 阶段3: 8-15天（中速降价期）
```
第一阶段降价 = 4 × 5% = 20%
降价天数 = 当前天数 - 7
第二阶段降价 = 降价天数 × 2%
总降价比例 = 20% + 第二阶段降价
当前价格 = 原价 × (1 - 总降价比例)
```

**示例**（原价 $0.10）：
- 第8天: $0.10 × (1 - 22%) = **$0.0780** (-22%)
  - 前期降20% + 第8天降2%
- 第9天: $0.10 × (1 - 24%) = **$0.0760** (-24%)
  - 前期降20% + 2天降4%
- 第10天: $0.10 × (1 - 26%) = **$0.0740** (-26%)
- ...
- 第15天: $0.10 × (1 - 36%) = **$0.0640** (-36%)
  - 前期降20% + 8天降16%

**累计降价**: 20% + 16% = **36%**

---

### 阶段4: 16-30天（缓慢降价期）
```
第一阶段降价 = 20%
第二阶段降价 = 16%
降价天数 = 当前天数 - 15
第三阶段降价 = 降价天数 × 1%
总降价比例 = 20% + 16% + 第三阶段降价
当前价格 = 原价 × (1 - 总降价比例)
```

**示例**（原价 $0.10）：
- 第16天: $0.10 × (1 - 37%) = **$0.0630** (-37%)
  - 前期降36% + 第16天降1%
- 第20天: $0.10 × (1 - 41%) = **$0.0590** (-41%)
  - 前期降36% + 5天降5%
- 第25天: $0.10 × (1 - 46%) = **$0.0540** (-46%)
  - 前期降36% + 10天降10%
- 第30天: $0.10 × (1 - 51%) → **$0.0500** (-50%)
  - 前期降36% + 15天降15% = 51%，但限制为50%

**累计降价**: 20% + 16% + 15% = 51%，但**限制为50%**

---

## 🚫 限制条件

### 1. 最大降价限制
```
最低价格 = 原价 × 50%
```

无论经过多少天，价格不得低于原价的50%。

**示例**：
- 原价 $0.10
- 最低价格 = $0.10 × 50% = **$0.05**
- 即使计算出的降价超过50%，也限制为$0.05

### 2. 成本价限制
```
最低价格 = max(原价 × 50%, 成本价)
```

价格不得低于成本价。

**示例**：
- 原价 $0.10
- 成本价 $0.06
- 理论最低价 $0.05
- 实际最低价 = max($0.05, $0.06) = **$0.06**

---

## 📊 完整价格趋势表

| 天数 | 阶段 | 降价比例 | 价格($0.10) | 说明 |
|------|------|---------|------------|------|
| 0 | 阶段1 | 0% | $0.1000 | 原价 |
| 1 | 阶段1 | 0% | $0.1000 | 原价 |
| 2 | 阶段1 | 0% | $0.1000 | 原价 |
| 3 | 阶段1 | 0% | $0.1000 | 原价 |
| **4** | **阶段2** | **5%** | **$0.0950** | 开始降价 |
| 5 | 阶段2 | 10% | $0.0900 | |
| 6 | 阶段2 | 15% | $0.0850 | |
| 7 | 阶段2 | 20% | $0.0800 | |
| **8** | **阶段3** | **22%** | **$0.0780** | 降速减缓 |
| 9 | 阶段3 | 24% | $0.0760 | |
| 10 | 阶段3 | 26% | $0.0740 | |
| 11 | 阶段3 | 28% | $0.0720 | |
| 12 | 阶段3 | 30% | $0.0700 | |
| 13 | 阶段3 | 32% | $0.0680 | |
| 14 | 阶段3 | 34% | $0.0660 | |
| 15 | 阶段3 | 36% | $0.0640 | |
| **16** | **阶段4** | **37%** | **$0.0630** | 降速进一步减缓 |
| 20 | 阶段4 | 41% | $0.0590 | |
| 25 | 阶段4 | 46% | $0.0540 | |
| 30 | 阶段4 | 50% | $0.0500 | 达到最大降价 |
| 35+ | 超期 | 50% | $0.0500 | 保持最大降价 |

---

## 💡 设计理念

### 为什么采用阶梯降价？

1. **前期快速降价（4-7天）**
   - 数据最新鲜，快速降价吸引买家
   - 每天降5%，4天可降20%

2. **中期适度降价（8-15天）**
   - 数据仍有价值，降速减缓
   - 每天降2%，8天再降16%

3. **后期缓慢降价（16-30天）**
   - 数据价值降低，但仍保留利润空间
   - 每天降1%，15天再降15%

4. **保底价格（50%）**
   - 确保有最低利润
   - 避免价格过低

### 业务优势

✅ **灵活性**: 根据数据新鲜度自动调价  
✅ **激励性**: 早买价格更优  
✅ **保护性**: 最大降价50%保证利润  
✅ **透明性**: 清晰的降价规则

---

## 🔧 技术实现

### 核心函数
**文件**: `/src/utils/dynamicPricing.js`  
**函数**: `calculateCurrentPrice(dataItem, currentTime)`

### 关键代码
```javascript
// 计算距离发布时间的天数
const daysSincePublish = Math.floor((currentTime - publishTime) / (1000 * 60 * 60 * 24))

// 阶段1: 0-3天
if (daysSincePublish <= 3) {
  currentPrice = sellPrice
  totalDiscountRate = 0
}
// 阶段2: 4-7天
else if (daysSincePublish <= 7) {
  const discountDays = daysSincePublish - 3
  totalDiscountRate = discountDays * 0.05
  currentPrice = sellPrice * (1 - totalDiscountRate)
}
// 阶段3: 8-15天
else if (daysSincePublish <= 15) {
  const firstPeriodDiscount = 4 * 0.05 // 20%
  const discountDays = daysSincePublish - 7
  const secondPeriodDiscount = discountDays * 0.02
  totalDiscountRate = firstPeriodDiscount + secondPeriodDiscount
  currentPrice = sellPrice * (1 - totalDiscountRate)
}
// 阶段4: 16-30天
else if (daysSincePublish <= 30) {
  const firstPeriodDiscount = 4 * 0.05 // 20%
  const secondPeriodDiscount = 8 * 0.02 // 16%
  const discountDays = daysSincePublish - 15
  const thirdPeriodDiscount = discountDays * 0.01
  totalDiscountRate = firstPeriodDiscount + secondPeriodDiscount + thirdPeriodDiscount
  currentPrice = sellPrice * (1 - totalDiscountRate)
}

// 限制最大降价50%
const maxDiscountPrice = sellPrice * 0.5
if (currentPrice < maxDiscountPrice) {
  currentPrice = maxDiscountPrice
}
```

---

## 🧪 测试验证

### 测试页面
```
http://localhost:9528/test-pricing-ladder.html
```

### 测试用例

#### 用例1: 新鲜数据（第1天）
- 输入: 原价 $0.10, 第1天
- 预期: $0.10 (0%)
- 说明: 原价期

#### 用例2: 快速降价期（第5天）
- 输入: 原价 $0.10, 第5天
- 预期: $0.09 (-10%)
- 计算: (5-3) × 5% = 10%

#### 用例3: 中速降价期（第10天）
- 输入: 原价 $0.10, 第10天
- 预期: $0.074 (-26%)
- 计算: 20% + (10-7) × 2% = 26%

#### 用例4: 缓慢降价期（第20天）
- 输入: 原价 $0.10, 第20天
- 预期: $0.059 (-41%)
- 计算: 20% + 16% + (20-15) × 1% = 41%

#### 用例5: 最大降价（第35天）
- 输入: 原价 $0.10, 第35天
- 预期: $0.05 (-50%)
- 说明: 限制为最大降价50%

---

## 📈 价格曲线图

```
价格
$0.10 |████████                    (0-3天: 原价期)
$0.09 |      ████                  (4-7天: 快速降价期)
$0.08 |          ████              
$0.07 |              ████████      (8-15天: 中速降价期)
$0.06 |                      ████████████  (16-30天: 缓慢降价期)
$0.05 |                                  ██████████  (30+天: 保持50%)
      +--------------------------------------------------
       0   3   7    15             30            天数
```

---

## ✅ 实施清单

- [x] 修改 `calculateCurrentPrice()` 函数
- [x] 实现阶梯降价逻辑
- [x] 添加50%最大降价限制
- [x] 创建测试页面
- [x] 编写详细文档
- [ ] 用户验收测试
- [ ] 生产环境部署

---

**文档版本**: v2.0  
**更新日期**: 2025-10-14  
**适用范围**: 时效为"3天内"的数据  
**实施状态**: ✅ 已实施
