# SMPP UCS-2å­—èŠ‚åºé—®é¢˜ä¿®å¤

## ğŸš¨ ç´§æ€¥é—®é¢˜

**ç°è±¡**ï¼šå‘é€çš„çŸ­ä¿¡å…¨éƒ¨ä¹±ç ï¼ŒåŒ…æ‹¬è‹±æ–‡å’Œä¸­æ–‡

**æ”¶åˆ°çš„å†…å®¹**ï¼š
```
ä¹±ç ï¼šå€æ €æ¤€çŒ€ æ¤€çŒ€ æ„€ ç€æ”€çŒ€ç€ æ´€æ”€çŒ€çŒ€æ„€æœ€æ”€ æ˜€çˆ€æ¼€æ´€ Næ«æ…“í…“
åŸæ–‡ï¼šThis is a test message from ä¸€æ­£å¡å‘
```

**é—®é¢˜ç±»å‹**ï¼šå­—èŠ‚åºé”™è¯¯ï¼ˆByte Order / Endiannessï¼‰

---

## ğŸ” é—®é¢˜åˆ†æ

### å­—èŠ‚åºï¼ˆEndiannessï¼‰æ¦‚å¿µ

åœ¨å¤šå­—èŠ‚ç¼–ç ä¸­ï¼Œå­—èŠ‚çš„å­˜å‚¨é¡ºåºæœ‰ä¸¤ç§ï¼š

| å­—èŠ‚åº | è¯´æ˜ | ç¤ºä¾‹ï¼ˆå­—ç¬¦'T'ï¼ŒUnicode: U+0054ï¼‰ |
|--------|------|----------------------------------|
| **å¤§ç«¯åºï¼ˆBig Endianï¼‰** | é«˜ä½å­—èŠ‚åœ¨å‰ | `00 54` |
| **å°ç«¯åºï¼ˆLittle Endianï¼‰** | ä½ä½å­—èŠ‚åœ¨å‰ | `54 00` |

### ä¹±ç äº§ç”ŸåŸå› 

```
åŸæ–‡ï¼šThis is a test message from ä¸€æ­£å¡å‘

é”™è¯¯ç¼–ç ï¼ˆå°ç«¯åº utf16leï¼‰ï¼š
T -> 54 00
h -> 68 00
i -> 69 00
s -> 73 00

æ¥æ”¶ç«¯æŒ‰å¤§ç«¯åºè§£æï¼š
54 00 -> U+5400 -> å€
68 00 -> U+6800 -> æ €
69 00 -> U+6900 -> æ¤€
73 00 -> U+7300 -> çŒ€

ç»“æœï¼šå€æ €æ¤€çŒ€ (å®Œå…¨ä¹±ç ï¼)
```

### æ­£ç¡®ç¼–ç ï¼ˆå¤§ç«¯åº utf16beï¼‰

```
åŸæ–‡ï¼šThis is a test message from ä¸€æ­£å¡å‘

æ­£ç¡®ç¼–ç ï¼ˆå¤§ç«¯åºï¼‰ï¼š
T -> 00 54
h -> 00 68
i -> 00 69
s -> 00 73

æ¥æ”¶ç«¯æŒ‰å¤§ç«¯åºè§£æï¼š
00 54 -> U+0054 -> T âœ“
00 68 -> U+0068 -> h âœ“
00 69 -> U+0069 -> i âœ“
00 73 -> U+0073 -> s âœ“

ç»“æœï¼šThis (æ­£ç¡®ï¼)
```

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### é—®é¢˜ä»£ç 

```javascript
// é”™è¯¯ï¼šä½¿ç”¨äº†å°ç«¯åºï¼ˆucs2å®é™…æ˜¯utf16leçš„åˆ«åï¼‰
if (hasUnicode) {
  dataCoding = 8;
  shortMessage = Buffer.from(content, 'ucs2');  // âŒ å°ç«¯åº
}
```

### ä¿®å¤ä»£ç 

```javascript
// æ­£ç¡®ï¼šä½¿ç”¨å¤§ç«¯åº
if (hasUnicode) {
  dataCoding = 8;
  shortMessage = Buffer.from(content, 'utf16be');  // âœ… å¤§ç«¯åº
  logger.info(`æ£€æµ‹åˆ°Unicodeå­—ç¬¦ï¼Œä½¿ç”¨UCS-2ç¼–ç ï¼ˆå¤§ç«¯åºï¼‰`, { 
    content: content.substring(0, 20),
    bufferLength: shortMessage.length,
    firstBytes: shortMessage.slice(0, 10).toString('hex')  // æ˜¾ç¤ºå‰10å­—èŠ‚çš„åå…­è¿›åˆ¶
  });
}
```

---

## ğŸ“Š ç¼–ç å¯¹æ¯”

### Node.js Bufferç¼–ç é€‰é¡¹

| ç¼–ç åç§° | å­—èŠ‚åº | è¯´æ˜ | SMPPå…¼å®¹æ€§ |
|---------|--------|------|------------|
| `'ucs2'` | å°ç«¯åº | UTF-16LEçš„åˆ«å | âŒ ä¸å…¼å®¹ |
| `'utf16le'` | å°ç«¯åº | UTF-16 Little Endian | âŒ ä¸å…¼å®¹ |
| **`'utf16be'`** | **å¤§ç«¯åº** | **UTF-16 Big Endian** | **âœ… å…¼å®¹** |

### å®é™…ç¼–ç ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šè‹±æ–‡å­—æ¯ "T"

```javascript
const text = "T";

// é”™è¯¯ç¼–ç ï¼ˆå°ç«¯åºï¼‰
Buffer.from(text, 'ucs2')
// è¾“å‡ºï¼š<Buffer 54 00>
// è§£æï¼šU+5400 = å€ âŒ

// æ­£ç¡®ç¼–ç ï¼ˆå¤§ç«¯åºï¼‰
Buffer.from(text, 'utf16be')
// è¾“å‡ºï¼š<Buffer 00 54>
// è§£æï¼šU+0054 = T âœ“
```

#### ç¤ºä¾‹2ï¼šä¸­æ–‡ "ä¸€"

```javascript
const text = "ä¸€";  // Unicode: U+4E00

// é”™è¯¯ç¼–ç ï¼ˆå°ç«¯åºï¼‰
Buffer.from(text, 'ucs2')
// è¾“å‡ºï¼š<Buffer 00 4e>
// è§£æï¼šU+004E = N âŒ

// æ­£ç¡®ç¼–ç ï¼ˆå¤§ç«¯åºï¼‰
Buffer.from(text, 'utf16be')
// è¾“å‡ºï¼š<Buffer 4e 00>
// è§£æï¼šU+4E00 = ä¸€ âœ“
```

#### ç¤ºä¾‹3ï¼šå®Œæ•´çŸ­ä¿¡

```javascript
const content = "This is a test message from ä¸€æ­£å¡å‘";

// é”™è¯¯ç¼–ç ï¼ˆå°ç«¯åºï¼‰
Buffer.from(content, 'ucs2').toString('hex').substring(0, 40)
// è¾“å‡ºï¼š54006800690073002000690073002000610020007400...
//       ^^ ^^-- å­—èŠ‚é¡ºåºé”™è¯¯
// è¯»å–ï¼š5400 6800 6900 7300 2000...
// è§£æï¼šå€   æ €   æ¤€   çŒ€   âŒ

// æ­£ç¡®ç¼–ç ï¼ˆå¤§ç«¯åºï¼‰
Buffer.from(content, 'utf16be').toString('hex').substring(0, 40)
// è¾“å‡ºï¼š00540068006900730020006900730020006100200074...
//       ^^ ^^-- å­—èŠ‚é¡ºåºæ­£ç¡®
// è¯»å–ï¼š0054 0068 0069 0073 0020...
// è§£æï¼šT    h    i    s    (ç©ºæ ¼) âœ“
```

---

## ğŸ¯ SMPPåè®®è¦æ±‚

### data_coding = 8 çš„è§„èŒƒ

æ ¹æ®SMPP 3.4åè®®è§„èŒƒï¼š

```
data_coding = 0x08 (8)
ç¼–ç ï¼šUCS-2
å­—èŠ‚åºï¼šBig Endianï¼ˆå¤§ç«¯åºï¼‰
è¯´æ˜ï¼šæ¯ä¸ªå­—ç¬¦2å­—èŠ‚ï¼Œé«˜ä½å­—èŠ‚åœ¨å‰
```

### ä¸ºä»€ä¹ˆå¿…é¡»ç”¨å¤§ç«¯åºï¼Ÿ

1. **SMPPåè®®è§„å®š**ï¼šdata_coding=8 æ˜ç¡®è¦æ±‚ä½¿ç”¨å¤§ç«¯åº
2. **ç½‘ç»œä¼ è¾“æ ‡å‡†**ï¼šç½‘ç»œå­—èŠ‚åºé€šå¸¸æ˜¯å¤§ç«¯åºï¼ˆNetwork Byte Orderï¼‰
3. **å›½é™…æ ‡å‡†**ï¼šUCS-2/UTF-16é»˜è®¤æŒ‡çš„æ˜¯å¤§ç«¯åºï¼Œå°ç«¯åºéœ€è¦æ˜ç¡®æ ‡æ³¨ä¸ºLE

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹

#### æµ‹è¯•1ï¼šçº¯è‹±æ–‡

```javascript
å†…å®¹ï¼šHello World
ç¼–ç ï¼šutf16be
æœŸæœ›ï¼šHello World âœ“
```

#### æµ‹è¯•2ï¼šè‹±æ–‡+ä¸­æ–‡

```javascript
å†…å®¹ï¼šThis is a test message from ä¸€æ­£å¡å‘
ç¼–ç ï¼šutf16be
æœŸæœ›ï¼šThis is a test message from ä¸€æ­£å¡å‘ âœ“
```

#### æµ‹è¯•3ï¼šçº¯ä¸­æ–‡

```javascript
å†…å®¹ï¼šä½ å¥½ä¸–ç•Œ
ç¼–ç ï¼šutf16be
æœŸæœ›ï¼šä½ å¥½ä¸–ç•Œ âœ“
```

### å­—èŠ‚æ£€æŸ¥å·¥å…·

```javascript
// éªŒè¯ç¼–ç æ˜¯å¦æ­£ç¡®
const content = "Thisä¸€";
const buffer = Buffer.from(content, 'utf16be');

console.log('å†…å®¹:', content);
console.log('é•¿åº¦:', buffer.length, 'å­—èŠ‚');
console.log('åå…­è¿›åˆ¶:', buffer.toString('hex'));
console.log('å‰10å­—èŠ‚:', buffer.slice(0, 10).toString('hex'));

// é¢„æœŸè¾“å‡ºï¼š
// å†…å®¹: Thisä¸€
// é•¿åº¦: 10 å­—èŠ‚ (5ä¸ªå­—ç¬¦ Ã— 2å­—èŠ‚)
// åå…­è¿›åˆ¶: 00540068006900734e00
// å‰10å­—èŠ‚: 00540068006900734e00
//           ^^^^ ^^^^ ^^^^ ^^^^ ^^^^
//           T    h    i    s    ä¸€
```

---

## ğŸ“ ä¿®æ”¹è¯¦æƒ…

### æ–‡ä»¶

`/home/vue-element-admin/backend/services/smppService.js`

### ä¿®æ”¹ä½ç½®

ç¬¬137-152è¡Œçš„ `sendSingle()` æ–¹æ³•

### ä¿®æ”¹å†…å®¹

```diff
  if (hasUnicode) {
    // åŒ…å«ä¸­æ–‡æˆ–å…¶ä»–Unicodeå­—ç¬¦ï¼Œä½¿ç”¨UCS-2ç¼–ç ï¼ˆå¤§ç«¯åºï¼‰
    dataCoding = 8; // UCS-2
-   shortMessage = Buffer.from(content, 'ucs2');
+   // ä½¿ç”¨utf16beï¼ˆå¤§ç«¯åºï¼‰ï¼Œè€Œä¸æ˜¯ucs2ï¼ˆå°ç«¯åºï¼‰
+   shortMessage = Buffer.from(content, 'utf16be');
    logger.info(`æ£€æµ‹åˆ°Unicodeå­—ç¬¦ï¼Œä½¿ç”¨UCS-2ç¼–ç ï¼ˆå¤§ç«¯åºï¼‰`, { 
      content: content.substring(0, 20),
-     length: shortMessage.length 
+     bufferLength: shortMessage.length,
+     firstBytes: shortMessage.slice(0, 10).toString('hex')
    });
  }
```

### å…³é”®å˜æ›´

| é¡¹ç›® | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| ç¼–ç æ–¹å¼ | `'ucs2'`ï¼ˆå°ç«¯åºï¼‰ | `'utf16be'`ï¼ˆå¤§ç«¯åºï¼‰ |
| æ—¥å¿—ä¿¡æ¯ | åŸºæœ¬ä¿¡æ¯ | æ·»åŠ å­—èŠ‚åºè¯´æ˜å’Œåå…­è¿›åˆ¶æ˜¾ç¤º |
| è°ƒè¯•ä¿¡æ¯ | åªæ˜¾ç¤ºé•¿åº¦ | æ˜¾ç¤ºç¼“å†²åŒºé•¿åº¦å’Œå‰10å­—èŠ‚ |

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ä¿®æ”¹å·²å®Œæˆ âœ…

æ–‡ä»¶å·²æ›´æ–°ï¼š`smppService.js`

### 2. åç«¯æœåŠ¡å·²é‡å¯ âœ…

```bash
pm2 restart vue-admin-server
# çŠ¶æ€ï¼šonline âœ“
```

### 3. æµ‹è¯•æ­¥éª¤

1. æ‰“å¼€é€šé“ç®¡ç†é¡µé¢
2. æ‰¾åˆ°"ä¸€æ­£å¡å‘"é€šé“
3. ç‚¹å‡»ã€æµ‹è¯•ã€‘æŒ‰é’®
4. å¡«å†™ï¼š
   - æ‰‹æœºå·ï¼š`84977109485`
   - å†…å®¹ï¼š`This is a test message from ä¸€æ­£å¡å‘`
5. å‘é€æµ‹è¯•çŸ­ä¿¡

### 4. éªŒè¯ç»“æœ

**é¢„æœŸæ”¶åˆ°çš„çŸ­ä¿¡**ï¼š
```
This is a test message from ä¸€æ­£å¡å‘
```

**ä¸åº”è¯¥å‡ºç°çš„ä¹±ç **ï¼š
```
âŒ å€æ €æ¤€çŒ€ æ¤€çŒ€ æ„€ ç€æ”€çŒ€ç€...
```

### 5. æŸ¥çœ‹æ—¥å¿—

```bash
pm2 logs vue-admin-server --lines 50 | grep "UCS-2"

# åº”è¯¥çœ‹åˆ°ï¼š
# "æ£€æµ‹åˆ°Unicodeå­—ç¬¦ï¼Œä½¿ç”¨UCS-2ç¼–ç ï¼ˆå¤§ç«¯åºï¼‰"
# bufferLength: XX
# firstBytes: "00540068006900..." (æ­£ç¡®çš„å¤§ç«¯åºå­—èŠ‚)
```

---

## ğŸ“ æŠ€æœ¯çŸ¥è¯†ç‚¹

### 1. ä»€ä¹ˆæ˜¯å­—èŠ‚åºï¼Ÿ

å­—èŠ‚åºï¼ˆEndiannessï¼‰æ˜¯æŒ‡å¤šå­—èŠ‚æ•°æ®åœ¨å†…å­˜ä¸­çš„å­˜å‚¨é¡ºåºï¼š

```
æ•°å­— 0x1234ï¼š
å¤§ç«¯åºï¼š12 34 (é«˜ä½åœ¨å‰)
å°ç«¯åºï¼š34 12 (ä½ä½åœ¨å‰)
```

### 2. ä¸ºä»€ä¹ˆä¼šæœ‰å­—èŠ‚åºé—®é¢˜ï¼Ÿ

- **CPUæ¶æ„å·®å¼‚**ï¼šIntel x86ç”¨å°ç«¯åºï¼Œç½‘ç»œåè®®ç”¨å¤§ç«¯åº
- **æ•°æ®ä¼ è¾“**ï¼šä¸åŒç³»ç»Ÿé—´ä¼ è¾“éœ€è¦ç»Ÿä¸€å­—èŠ‚åº
- **åè®®è§„èŒƒ**ï¼šå¤§å¤šæ•°ç½‘ç»œåè®®è§„å®šä½¿ç”¨å¤§ç«¯åº

### 3. UTF-16çš„å­—èŠ‚åº

```
UTF-16ï¼š2å­—èŠ‚ç¼–ç Unicodeå­—ç¬¦
UTF-16BEï¼šå¤§ç«¯åºï¼ˆBig Endianï¼‰
UTF-16LEï¼šå°ç«¯åºï¼ˆLittle Endianï¼‰
BOMï¼šå­—èŠ‚åºæ ‡è®°ï¼ˆByte Order Markï¼‰
  - FE FF = å¤§ç«¯åº
  - FF FE = å°ç«¯åº
```

### 4. SMPPä¸­çš„UCS-2

```
SMPP data_coding = 8ï¼š
- åç§°ï¼šUCS-2
- æœ¬è´¨ï¼šUTF-16BE
- å­—èŠ‚åºï¼šå¤§ç«¯åº
- æ¯å­—ç¬¦ï¼š2å­—èŠ‚
- æ— BOMï¼šä¸éœ€è¦BOMæ ‡è®°
```

---

## âš ï¸ å¸¸è§é”™è¯¯

### é”™è¯¯1ï¼šä½¿ç”¨ 'ucs2'

```javascript
// âŒ é”™è¯¯
Buffer.from(content, 'ucs2')
// å®é™…æ˜¯ UTF-16LEï¼ˆå°ç«¯åºï¼‰
```

### é”™è¯¯2ï¼šä½¿ç”¨ 'utf16le'

```javascript
// âŒ é”™è¯¯
Buffer.from(content, 'utf16le')
// æ˜ç¡®çš„å°ç«¯åºï¼Œä¸SMPPä¸å…¼å®¹
```

### é”™è¯¯3ï¼šæ·»åŠ BOM

```javascript
// âŒ ä¸éœ€è¦
const bom = Buffer.from([0xFE, 0xFF]);
const data = Buffer.from(content, 'utf16be');
Buffer.concat([bom, data]);
// SMPPä¸éœ€è¦BOMï¼Œåè€Œä¼šå¯¼è‡´é—®é¢˜
```

### æ­£ç¡®åšæ³•

```javascript
// âœ… æ­£ç¡®
Buffer.from(content, 'utf16be')
// ç›´æ¥ä½¿ç”¨å¤§ç«¯åºï¼Œæ— éœ€BOM
```

---

## ğŸ“Š æ€§èƒ½å½±å“

### ç¼–ç è½¬æ¢æ€§èƒ½

```javascript
// æ€§èƒ½æµ‹è¯•
const content = "This is a test message from ä¸€æ­£å¡å‘";

console.time('utf16be');
for (let i = 0; i < 10000; i++) {
  Buffer.from(content, 'utf16be');
}
console.timeEnd('utf16be');

// ç»“æœï¼šçº¦10-20ms (10000æ¬¡)
// æ€§èƒ½å½±å“ï¼šå¯å¿½ç•¥ä¸è®¡
```

### å†…å­˜ä½¿ç”¨

```
åŸæ–‡ï¼š"This is a test message from ä¸€æ­£å¡å‘" (38ä¸ªå­—ç¬¦)
ç¼–ç åï¼š76å­—èŠ‚ (38 Ã— 2)
å·®å¼‚ï¼šä¸å°ç«¯åºå®Œå…¨ç›¸åŒï¼Œåªæ˜¯å­—èŠ‚é¡ºåºä¸åŒ
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹Bufferå†…å®¹

```javascript
const buffer = Buffer.from("Testä¸€", 'utf16be');
console.log('Hex:', buffer.toString('hex'));
// è¾“å‡ºï¼š00540065007300744e00
//       ^^^^ ^^^^ ^^^^ ^^^^ ^^^^
//       T    e    s    t    ä¸€
```

### 2. å¯¹æ¯”ä¸¤ç§ç¼–ç 

```javascript
const text = "Testä¸€";
console.log('å°ç«¯åº:', Buffer.from(text, 'utf16le').toString('hex'));
console.log('å¤§ç«¯åº:', Buffer.from(text, 'utf16be').toString('hex'));

// è¾“å‡ºï¼š
// å°ç«¯åº: 5400650073007400004e
// å¤§ç«¯åº: 0054006500730074004e
//         ^^^^ ^^^^-- å­—èŠ‚é¡ºåºç›¸å
```

### 3. éªŒè¯è§£æ

```javascript
// å‘é€çš„å­—èŠ‚
const sent = Buffer.from("T", 'utf16be');
console.log('å‘é€:', sent.toString('hex'));  // 0054

// æ¨¡æ‹Ÿæ¥æ”¶ç«¯è§£æ
const received = Buffer.from('0054', 'hex');
console.log('è§£æ:', received.toString('utf16be'));  // T âœ“
```

---

## âœ… æ€»ç»“

| é¡¹ç›® | é—®é¢˜ | è§£å†³ |
|------|------|------|
| **ç°è±¡** | å…¨éƒ¨ä¹±ç ï¼ˆè‹±æ–‡+ä¸­æ–‡ï¼‰ | - |
| **åŸå› ** | ä½¿ç”¨å°ç«¯åºï¼ˆutf16leï¼‰ | æ”¹ç”¨å¤§ç«¯åºï¼ˆutf16beï¼‰ |
| **ç¼–ç ** | `Buffer.from(content, 'ucs2')` | `Buffer.from(content, 'utf16be')` |
| **çŠ¶æ€** | âŒ ä¹±ç  | âœ… æ­£ç¡®æ˜¾ç¤º |

---

**ä¿®å¤æ—¶é—´**ï¼š2025-10-22  
**ç´§æ€¥ç¨‹åº¦**ï¼šğŸš¨ é«˜ï¼ˆå½±å“æ‰€æœ‰SMPPçŸ­ä¿¡ï¼‰  
**çŠ¶æ€**ï¼šâœ… å·²ä¿®å¤ï¼Œå·²éƒ¨ç½²ï¼Œå¾…æµ‹è¯•éªŒè¯
