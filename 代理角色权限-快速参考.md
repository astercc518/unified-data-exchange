# 🚀 代理角色权限 - 快速参考手册

## 📋 角色定义

### 系统三大角色

1. **管理员(admin)** - 超级管理员
   - 系统最高权限
   - 管理所有用户、数据、订单
   - 系统配置和维护

2. **代理(agent)** - 销售角色
   - 管理所属客户
   - 审核订单、发货
   - 编辑数据反馈

3. **客户(customer)** - 普通用户
   - 购买数据
   - 提交订单审核
   - 提交数据反馈

---

## ✅ 核心权限(已实现)

### 1️⃣ 查看客户信息 (只读)
- **路径**: 用户管理 → 客户列表
- **URL**: `/user/customer-list`
- **权限**: `['admin', 'agent']`
- **功能**:
  - ✅ 查看本代理下的客户列表
  - ✅ 查看客户详情
  - ❌ 不能编辑/删除/充值

### 2️⃣ 审核订单
- **路径**: 订单管理 → 审核订单
- **URL**: `/order/review`
- **权限**: `['agent', 'admin']`
- **功能**:
  - ✅ 查看待审核订单 (status = 'reviewing')
  - ✅ 审核通过 → `completed` + 待发货
  - ✅ 审核拒绝 → `cancelled` (需填写原因)

### 3️⃣ 订单发货
- **路径**: 订单管理 → 已完成订单 → 发货
- **URL**: `/order/delivery/:id`
- **权限**: `['agent', 'admin']`
- **功能**:
  - ✅ 选择发货方式 (邮箱/TG Bot)
  - ✅ 填写发货信息
  - ✅ 确认发货 → `delivered`

### 4️⃣ 编辑数据反馈
- **路径**: 数据反馈 → 反馈列表
- **URL**: `/feedback/list`, `/feedback/create`
- **权限**: `['admin', 'customer', 'agent']`
- **功能**:
  - ✅ 查看反馈列表
  - ✅ 编辑反馈内容
  - ✅ 更新质量评价

---

## ❌ 禁止权限

### 系统管理权限
- ❌ 创建/编辑/删除客户
- ❌ 充值/扣款
- ❌ 重置客户密码
- ❌ 上传/编辑/删除数据
- ❌ 查看结算记录
- ❌ 系统设置

---

## 🔧 实现状态

### ✅ 已完成
- [x] 路由权限配置
- [x] 审核订单功能
- [x] 订单发货功能
- [x] 数据反馈编辑
- [x] 客户列表只读按钮控制

### ⚠️ 待实现
- [ ] 后端API数据过滤 (代理只能获取自己的客户)
- [ ] 后端API权限验证 (防止越权访问)

---

## 📊 权限对比速查表

| 功能 | 管理员 | 代理 | 客户 |
|-----|--------|------|------|
| 查看所有客户 | ✅ | ❌ | ❌ |
| 查看本代理客户 | ✅ | ✅ (只读) | ❌ |
| 编辑客户 | ✅ | ❌ | ❌ |
| 充值/扣款 | ✅ | ❌ | ❌ |
| 审核订单 | ✅ | ✅ | ❌ |
| 发货订单 | ✅ | ✅ | ❌ |
| 编辑反馈 | ✅ | ✅ | ✅ |
| 上传数据 | ✅ | ❌ | ❌ |
| 购买数据 | ✅ | ❌ | ✅ |

---

## 🎯 测试要点

### 代理账号测试
1. **登录代理账号**
2. **验证可访问**:
   - ✅ 用户管理 → 客户列表 (只有"详情"按钮)
   - ✅ 订单管理 → 审核订单
   - ✅ 订单管理 → 已完成订单 (有"发货"按钮)
   - ✅ 数据反馈 → 反馈列表 (有"编辑"按钮)
3. **验证不可访问**:
   - ❌ 数据管理菜单 (整个菜单不显示)
   - ❌ 代理管理菜单
   - ❌ 结算管理菜单
   - ❌ 系统管理菜单

### 权限测试用例
```bash
# 测试代理登录
POST /api/auth/login
{
  "loginAccount": "agent01",
  "password": "123456"
}

# 验证返回的roles包含'agent'
# 验证菜单只显示允许的模块
```

---

## 🛠️ 开发指南

### 添加新功能权限

#### 1. 路由配置
```javascript
// /src/router/index.js
{
  path: 'new-page',
  meta: {
    roles: ['agent', 'admin']  // 代理可访问
  }
}
```

#### 2. 按钮权限控制
```vue
<!-- 仅管理员可见 -->
<el-button v-if="isAdmin" @click="handleEdit">
  编辑
</el-button>

<!-- 代理和管理员可见 -->
<el-button v-if="isAdmin || isAgent" @click="handleReview">
  审核
</el-button>
```

#### 3. 计算属性
```javascript
computed: {
  isAdmin() {
    return this.$store.getters.roles.includes('admin')
  },
  isAgent() {
    return this.$store.getters.roles.includes('agent')
  }
}
```

---

## 📂 关键文件清单

### 路由配置
- `/src/router/index.js` - 路由权限定义

### 权限管理
- `/src/store/modules/permission.js` - 权限路由过滤
- `/src/store/modules/user.js` - 用户角色管理

### 代理可访问页面
- `/src/views/user/list.vue` - 客户列表 (只读)
- `/src/views/user/detail.vue` - 客户详情 (只读)
- `/src/views/order/review.vue` - 审核订单 ✅
- `/src/views/order/delivery.vue` - 订单发货 ✅
- `/src/views/order/list.vue` - 订单列表
- `/src/views/order/completed.vue` - 已完成订单
- `/src/views/feedback/list.vue` - 反馈列表
- `/src/views/feedback/create.vue` - 创建/编辑反馈
- `/src/views/feedback/detail.vue` - 反馈详情
- `/src/views/resource/center.vue` - 资源中心 (只读)
- `/src/views/dashboard/agent.vue` - 代理首页

---

## 🔒 安全注意事项

### 前端安全
- ✅ 路由权限控制 (已实现)
- ✅ 按钮显示控制 (已实现)
- ⚠️ URL直接访问拦截 (部分实现)

### 后端安全 (待加强)
- ⚠️ **必须实现**: API数据过滤
- ⚠️ **必须实现**: 权限验证中间件
- ⚠️ **必须实现**: 操作日志记录

### 推荐实现
```javascript
// 后端API示例
router.get('/api/users', authenticateToken, async (req, res) => {
  const { userId, userType } = req.user;
  
  // 权限过滤
  let whereCondition = {};
  if (userType === 'agent') {
    whereCondition.agent_id = userId;  // 只返回该代理的客户
  }
  
  const users = await User.findAll({ where: whereCondition });
  res.json({ success: true, data: users });
});
```

---

## 📞 常见问题

### Q1: 代理能看到其他代理的客户吗?
**A**: 不能。后端API应该过滤,只返回 `agent_id` 等于当前代理ID的客户。

### Q2: 代理能修改客户信息吗?
**A**: 不能。客户列表页面的"编辑"按钮只对管理员显示。

### Q3: 代理能删除订单吗?
**A**: 不能。代理只能审核和发货,不能删除或取消订单。

### Q4: 代理能查看所有订单吗?
**A**: 只能查看本代理下客户的订单。需要后端API过滤。

### Q5: 代理能上传数据吗?
**A**: 不能。数据管理菜单对代理不可见。

---

## 🎓 权限设计原则

1. **最小权限原则**: 代理只有完成业务必需的权限
2. **职责分离**: 销售(代理) vs 运营(管理员)
3. **数据隔离**: 代理只能访问自己客户的数据
4. **操作可追溯**: 所有操作应记录日志
5. **前后端双重验证**: 前端控制显示,后端验证权限

---

**文档版本**: v1.0  
**最后更新**: 2025-10-15  
**适用角色**: 开发人员、测试人员  
**相关文档**: [代理角色权限定义.md](./代理角色权限定义.md)
