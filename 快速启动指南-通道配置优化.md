# 快速启动指南 - 短信通道配置优化

## 🚀 立即开始

### 第一步：执行数据库迁移

```bash
# 连接到MySQL数据库
mysql -u root -p vue_element_admin

# 执行迁移脚本
source backend/migrations/update_sms_channels_optional_fields.sql;

# 验证修改
DESCRIBE sms_channels;
```

### 第二步：重启后端服务

```bash
# 进入项目目录
cd /home/vue-element-admin

# 重启后端（如果使用PM2）
pm2 restart backend

# 或者直接运行
node backend/server.js
```

### 第三步：清理前端缓存

```bash
# 重新构建前端（如果是生产环境）
npm run build:prod

# 或者清除浏览器缓存并刷新页面
# Chrome: Ctrl+Shift+Delete
```

## 📝 创建第一个多国家通道

### 1. 进入通道配置页面

导航：**短信管理 > 通道配置**

### 2. 点击"新建通道"

填写以下信息：

```
通道名称: SMS57-国际通道
协议类型: HTTP
HTTP方法: POST
网关地址: https://api.sms57.com/send
账号: your_account
密码: your_password
接入码: 10690（如果使用SMS57）
状态: 启用
```

### 3. 保存通道

点击"确定"，系统提示：
> 创建通道成功，请在"国家定价"中配置各国家的价格

### 4. 配置国家定价

点击刚创建通道的"国家定价"按钮

#### 添加中国定价
```
国家: 中国 (China) +86
成本价/条: 0.008
销售价/条: 0.01
最大字符数: 160
状态: 启用
```

#### 添加美国定价
```
国家: 美国 (United States) +1
成本价/条: 0.006
销售价/条: 0.009
最大字符数: 160
状态: 启用
```

#### 添加更多国家
根据实际需要添加...

### 5. 测试发送

回到通道列表，点击"测试"按钮

```
手机号码: 8613800138000（中国）
短信内容: 这是一条测试短信
```

点击"发送测试短信"，查看结果。

## 🔄 迁移现有通道数据（可选）

如果你有现有的通道数据，可以将它们迁移到新的多国家模式：

```sql
-- 将现有通道的定价迁移到 sms_channel_countries 表
INSERT INTO `sms_channel_countries` 
  (`channel_id`, `country`, `country_code`, `cost_price`, `sale_price`, `max_chars`, `status`, `created_at`, `updated_at`)
SELECT 
  `id` as `channel_id`,
  `country`,
  `country_code`,
  `price_per_sms` * 0.8 as `cost_price`, -- 假设成本是销售价的80%
  `price_per_sms` as `sale_price`,
  `max_chars`,
  `status`,
  NOW() as `created_at`,
  NOW() as `updated_at`
FROM `sms_channels`
WHERE `country` IS NOT NULL 
  AND NOT EXISTS (
    SELECT 1 FROM `sms_channel_countries` 
    WHERE `channel_id` = `sms_channels`.`id` 
      AND `country` = `sms_channels`.`country`
  );
```

## ✅ 验证清单

- [ ] 数据库迁移成功执行
- [ ] 后端服务正常启动
- [ ] 前端页面加载正常
- [ ] 可以创建新通道（不需要填写国家信息）
- [ ] "国家定价"按钮可以正常点击
- [ ] 可以在国家定价中添加国家
- [ ] 测试发送功能正常

## 🎯 常见问题

### Q1: 为什么创建通道时不需要选择国家了？

**A:** 新的设计允许一个通道支持多个国家，每个国家有独立的定价。创建通道后，通过"国家定价"按钮添加需要支持的国家。

### Q2: 现有的通道数据会丢失吗？

**A:** 不会。数据库迁移只是将字段改为可选，现有数据完全保留。建议执行迁移SQL将数据同步到新表。

### Q3: 测试发送时手机号格式变了？

**A:** 是的。因为通道不再绑定单一国家，手机号需要包含国家代码。例如：
- 中国：8613800138000
- 美国：12025551234

### Q4: 如何知道一个通道支持哪些国家？

**A:** 点击通道的"国家定价"按钮，可以看到该通道配置的所有国家列表。

### Q5: 可以为同一个国家配置多个通道吗？

**A:** 可以。你可以创建多个通道，每个通道都可以配置相同的国家，这样可以实现负载均衡和备用通道。

## 📞 需要帮助？

如果遇到问题：

1. 检查浏览器控制台是否有错误
2. 检查后端日志：`pm2 logs backend`
3. 验证数据库表结构是否正确
4. 确认前后端代码都已更新

## 🎉 完成！

恭喜！你已经成功升级到多国家通道管理系统。现在可以：

- ✅ 创建支持多国家的通道
- ✅ 为每个国家设置独立定价
- ✅ 灵活管理成本和利润
- ✅ 更好地支持国际化业务
