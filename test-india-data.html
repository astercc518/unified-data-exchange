<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°åº¦æ•°æ®è¯Šæ–­å·¥å…·</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      transition: all 0.3s;
    }
    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .result {
      background: #f9f9f9;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-top: 15px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 500px;
      overflow-y: auto;
    }
    .success {
      background: #f0f9ff;
      border-left-color: #67c23a;
      color: #67c23a;
    }
    .error {
      background: #fef0f0;
      border-left-color: #f56c6c;
      color: #f56c6c;
    }
    .warning {
      background: #fdf6ec;
      border-left-color: #e6a23c;
      color: #e6a23c;
    }
    .info {
      background: #f4f4f5;
      border-left-color: #909399;
      color: #606266;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #667eea;
      color: white;
      font-weight: 600;
    }
    tr:hover {
      background: #f5f5f5;
    }
    .tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .tag-success { background: #f0f9ff; color: #67c23a; border: 1px solid #67c23a; }
    .tag-error { background: #fef0f0; color: #f56c6c; border: 1px solid #f56c6c; }
    .tag-warning { background: #fdf6ec; color: #e6a23c; border: 1px solid #e6a23c; }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ‡®ğŸ‡³ å°åº¦æ•°æ®è¯Šæ–­å·¥å…·</h1>
    <p>æ£€æµ‹èµ„æºä¸­å¿ƒæ— æ³•æ˜¾ç¤ºå°åº¦æ•°æ®çš„åŸå› </p>
  </div>

  <div class="test-section">
    <h2>ğŸ“¡ æµ‹è¯•1ï¼šæ£€æŸ¥åç«¯APIè¿”å›</h2>
    <button onclick="testBackendAPI()">æµ‹è¯•åç«¯API</button>
    <div id="backend-result"></div>
  </div>

  <div class="test-section">
    <h2>ğŸ” æµ‹è¯•2ï¼šæ£€æŸ¥æ•°æ®è½¬æ¢é€»è¾‘</h2>
    <button onclick="testDataConversion()">æµ‹è¯•æ•°æ®è½¬æ¢</button>
    <div id="conversion-result"></div>
  </div>

  <div class="test-section">
    <h2>ğŸš« æµ‹è¯•3ï¼šæ£€æŸ¥ç­›é€‰æ¡ä»¶</h2>
    <button onclick="testFiltering()">æµ‹è¯•ç­›é€‰é€»è¾‘</button>
    <div id="filter-result"></div>
  </div>

  <div class="test-section">
    <h2>ğŸ’° æµ‹è¯•4ï¼šæ£€æŸ¥åŠ¨æ€å®šä»·</h2>
    <button onclick="testDynamicPricing()">æµ‹è¯•åŠ¨æ€å®šä»·</button>
    <div id="pricing-result"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';

    // æµ‹è¯•1ï¼šæ£€æŸ¥åç«¯API
    async function testBackendAPI() {
      const resultDiv = document.getElementById('backend-result');
      resultDiv.innerHTML = '<div class="result info">æ­£åœ¨æµ‹è¯•...</div>';

      try {
        // æµ‹è¯•ä¸å¸¦ç­›é€‰æ¡ä»¶
        const response1 = await fetch(`${API_BASE}/api/data-library/published`);
        const data1 = await response1.json();

        // æµ‹è¯•å¸¦å°åº¦ç­›é€‰æ¡ä»¶
        const response2 = await fetch(`${API_BASE}/api/data-library/published?country=IN`);
        const data2 = await response2.json();

        let html = '<div class="result success">';
        html += `âœ… åç«¯APIæµ‹è¯•æˆåŠŸ\n\n`;
        html += `ã€ä¸å¸¦ç­›é€‰æ¡ä»¶ã€‘\n`;
        html += `- è¿”å›æ•°æ®æ¡æ•°: ${data1.data?.length || 0}\n`;
        html += `- æ˜¯å¦åŒ…å«å°åº¦æ•°æ®: ${data1.data?.some(item => item.country === 'IN') ? 'æ˜¯' : 'å¦'}\n\n`;

        if (data1.data?.length > 0) {
          const indiaData = data1.data.find(item => item.country === 'IN');
          if (indiaData) {
            html += `ã€å°åº¦æ•°æ®è¯¦æƒ…ã€‘\n`;
            html += `- ID: ${indiaData.id}\n`;
            html += `- å›½å®¶ä»£ç : ${indiaData.country}\n`;
            html += `- å›½å®¶åç§°: ${indiaData.country_name}\n`;
            html += `- æ•°æ®ç±»å‹: ${indiaData.data_type}\n`;
            html += `- æ—¶æ•ˆæ€§: ${indiaData.validity}\n`;
            html += `- å¯ç”¨æ•°é‡: ${indiaData.available_quantity}\n`;
            html += `- é”€å”®ä»·æ ¼: ${indiaData.sell_price}\n`;
            html += `- çŠ¶æ€: ${indiaData.status}\n`;
            html += `- å‘å¸ƒçŠ¶æ€: ${indiaData.publish_status}\n`;
            html += `- å‘å¸ƒæ—¶é—´: ${indiaData.publish_time}\n\n`;
          }
        }

        html += `ã€å¸¦å°åº¦ç­›é€‰æ¡ä»¶ã€‘\n`;
        html += `- è¿”å›æ•°æ®æ¡æ•°: ${data2.data?.length || 0}\n`;

        html += '</div>';
        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æµ‹è¯•2ï¼šæ£€æŸ¥æ•°æ®è½¬æ¢
    async function testDataConversion() {
      const resultDiv = document.getElementById('conversion-result');
      resultDiv.innerHTML = '<div class="result info">æ­£åœ¨æµ‹è¯•...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/data-library/published?country=IN`);
        const apiData = await response.json();

        if (!apiData.data || apiData.data.length === 0) {
          resultDiv.innerHTML = '<div class="result warning">âš ï¸ åç«¯æœªè¿”å›å°åº¦æ•°æ®</div>';
          return;
        }

        // æ¨¡æ‹Ÿå‰ç«¯æ•°æ®è½¬æ¢é€»è¾‘
        const item = apiData.data[0];
        const convertedData = {
          id: item.id,
          country: item.country_name || item.country,
          countryCode: item.country,
          dataType: item.data_type,
          validity: item.validity,
          validityDisplay: item.validity_name,
          source: item.source || 'æœªçŸ¥',
          availableQuantity: item.available_quantity,
          totalQuantity: item.total_quantity,
          sellPrice: parseFloat(item.sell_price) || 0,
          costPrice: parseFloat(item.cost_price) || 0,
          operators: (typeof item.operators === 'string' ? JSON.parse(item.operators) : (item.operators || [])).map(op => ({
            name: op.name,
            count: op.quantity || op.count || 0,
            marketShare: op.marketShare,
            segments: op.segments
          })),
          uploadTime: item.upload_time,
          publishTime: item.publish_time,
          status: item.status,
          remark: item.remark
        };

        let html = '<div class="result success">';
        html += `âœ… æ•°æ®è½¬æ¢æˆåŠŸ\n\n`;
        html += `ã€åŸå§‹æ•°æ®ã€‘\n`;
        html += JSON.stringify(item, null, 2);
        html += `\n\nã€è½¬æ¢åæ•°æ®ã€‘\n`;
        html += JSON.stringify(convertedData, null, 2);
        html += '</div>';

        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æµ‹è¯•3ï¼šæ£€æŸ¥ç­›é€‰é€»è¾‘
    async function testFiltering() {
      const resultDiv = document.getElementById('filter-result');
      resultDiv.innerHTML = '<div class="result info">æ­£åœ¨æµ‹è¯•...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/data-library/published`);
        const apiData = await response.json();

        if (!apiData.data || apiData.data.length === 0) {
          resultDiv.innerHTML = '<div class="result warning">âš ï¸ åç«¯æœªè¿”å›æ•°æ®</div>';
          return;
        }

        // æ¨¡æ‹Ÿ applyFilters æ–¹æ³•
        function applyFilters(dataList, filters = {}) {
          let filteredList = [...dataList];

          // è¿‡æ»¤æ‰å·²å”®ç½„çš„æ•°æ®
          filteredList = filteredList.filter(item => {
            return item.available_quantity > 0 && item.status !== 'sold_out';
          });

          // å›½å®¶ç­›é€‰
          if (filters.country) {
            filteredList = filteredList.filter(item => {
              return item.country === filters.country ||
                     (item.country_name && item.country_name.includes(filters.country));
            });
          }

          // æ—¶æ•ˆç­›é€‰
          if (filters.validity) {
            filteredList = filteredList.filter(item => item.validity === filters.validity);
          }

          // æ•°æ®æ¥æºç­›é€‰
          if (filters.source) {
            filteredList = filteredList.filter(item =>
              item.source && item.source.toLowerCase().includes(filters.source.toLowerCase())
            );
          }

          return filteredList;
        }

        const originalCount = apiData.data.length;
        const filteredData = applyFilters(apiData.data, {});
        const filteredCount = filteredData.length;

        const indiaDataBefore = apiData.data.filter(item => item.country === 'IN');
        const indiaDataAfter = filteredData.filter(item => item.country === 'IN');

        let html = '<div class="result">';
        html += `ğŸ“Š ç­›é€‰æµ‹è¯•ç»“æœ\n\n`;
        html += `åŸå§‹æ•°æ®: ${originalCount} æ¡\n`;
        html += `ç­›é€‰åæ•°æ®: ${filteredCount} æ¡\n`;
        html += `è¢«è¿‡æ»¤æ•°æ®: ${originalCount - filteredCount} æ¡\n\n`;
        html += `å°åº¦æ•°æ®ï¼ˆç­›é€‰å‰ï¼‰: ${indiaDataBefore.length} æ¡\n`;
        html += `å°åº¦æ•°æ®ï¼ˆç­›é€‰åï¼‰: ${indiaDataAfter.length} æ¡\n\n`;

        if (indiaDataBefore.length > 0 && indiaDataAfter.length === 0) {
          html += `âŒ é—®é¢˜ç¡®è®¤ï¼šå°åº¦æ•°æ®è¢«ç­›é€‰æ¡ä»¶è¿‡æ»¤äº†ï¼\n\n`;
          const indiaItem = indiaDataBefore[0];
          html += `è¢«è¿‡æ»¤çš„åŸå› åˆ†æï¼š\n`;
          html += `- å¯ç”¨æ•°é‡: ${indiaItem.available_quantity} ${indiaItem.available_quantity > 0 ? 'âœ…' : 'âŒ'}\n`;
          html += `- çŠ¶æ€: ${indiaItem.status} ${indiaItem.status !== 'sold_out' ? 'âœ…' : 'âŒ'}\n`;
        } else if (indiaDataAfter.length > 0) {
          html += `âœ… å°åº¦æ•°æ®é€šè¿‡ç­›é€‰æ¡ä»¶\n`;
        }

        html += '</div>';
        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æµ‹è¯•4ï¼šæ£€æŸ¥åŠ¨æ€å®šä»·
    async function testDynamicPricing() {
      const resultDiv = document.getElementById('pricing-result');
      resultDiv.innerHTML = '<div class="result info">æ­£åœ¨æµ‹è¯•...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/data-library/published?country=IN`);
        const apiData = await response.json();

        if (!apiData.data || apiData.data.length === 0) {
          resultDiv.innerHTML = '<div class="result warning">âš ï¸ åç«¯æœªè¿”å›å°åº¦æ•°æ®</div>';
          return;
        }

        const item = apiData.data[0];
        const publishTime = new Date(item.publish_time).getTime();
        const currentTime = Date.now();
        const daysSincePublish = Math.floor((currentTime - publishTime) / (1000 * 60 * 60 * 24));
        const sellPrice = parseFloat(item.sell_price);

        let currentPrice = sellPrice;
        let totalDiscountRate = 0;

        if (daysSincePublish <= 3) {
          currentPrice = sellPrice;
          totalDiscountRate = 0;
        } else if (daysSincePublish <= 7) {
          const discountDays = daysSincePublish - 3;
          totalDiscountRate = discountDays * 0.05;
          currentPrice = sellPrice * (1 - totalDiscountRate);
        } else if (daysSincePublish <= 15) {
          const firstPeriodDiscount = 4 * 0.05;
          const discountDays = daysSincePublish - 7;
          const secondPeriodDiscount = discountDays * 0.02;
          totalDiscountRate = firstPeriodDiscount + secondPeriodDiscount;
          currentPrice = sellPrice * (1 - totalDiscountRate);
        } else if (daysSincePublish <= 30) {
          const firstPeriodDiscount = 4 * 0.05;
          const secondPeriodDiscount = 8 * 0.02;
          const discountDays = daysSincePublish - 15;
          const thirdPeriodDiscount = discountDays * 0.01;
          totalDiscountRate = firstPeriodDiscount + secondPeriodDiscount + thirdPeriodDiscount;
          currentPrice = sellPrice * (1 - totalDiscountRate);
        }

        const maxDiscountPrice = sellPrice * 0.5;
        if (currentPrice < maxDiscountPrice) {
          currentPrice = maxDiscountPrice;
        }

        let html = '<div class="result success">';
        html += `âœ… åŠ¨æ€å®šä»·æµ‹è¯•æˆåŠŸ\n\n`;
        html += `å‘å¸ƒæ—¶é—´: ${new Date(publishTime).toLocaleString()}\n`;
        html += `å¤©æ•°: ${daysSincePublish} å¤©\n`;
        html += `åŸå§‹ä»·æ ¼: ${sellPrice.toFixed(4)} U\n`;
        html += `æŠ˜æ‰£ç‡: ${(totalDiscountRate * 100).toFixed(2)}%\n`;
        html += `å½“å‰ä»·æ ¼: ${currentPrice.toFixed(4)} U\n`;
        html += '</div>';

        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
      }
    }
  </script>
</body>
</html>
