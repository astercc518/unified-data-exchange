# 资源中心统计数据按角色显示功能说明

## ✅ 功能实现完成

资源中心顶部统计卡片已成功实现按用户角色显示不同数据!

---

## 📋 功能需求

### 统计卡片显示内容

资源中心页面顶部有3个统计卡片:
1. **账户余额** (U)
2. **已购买数据** (条数)
3. **累计消费** (U)

### 不同角色显示不同范围

#### 管理员 (Admin)
- **账户余额**: 所有客户账户余额总额
- **已购买数据**: 所有客户已购买数据总量
- **累计消费**: 所有客户累计消费总额

#### 代理 (Agent)
- **账户余额**: 本代理下所有客户账户余额总额
- **已购买数据**: 本代理下所有客户已购买数据总量
- **累计消费**: 本代理下所有客户累计消费总额

#### 客户 (Customer)
- **账户余额**: 本客户账户余额
- **已购买数据**: 本客户已购买数据
- **累计消费**: 本客户累计消费

---

## 🔧 技术实现

### 1. 后端接口

**文件**: `/home/vue-element-admin/backend/routes/stats.js`

**新增接口**: `GET /api/stats/resource-center/:userType/:userId`

**参数说明**:
- `userType`: 用户类型 (admin / agent / customer)
- `userId`: 用户ID

**响应格式**:
```json
{
  "success": true,
  "data": {
    "totalBalance": "15800.50",
    "totalPurchased": 8500000,
    "totalSpent": "24203.00"
  }
}
```

**核心逻辑**:

#### 管理员查询
```javascript
if (userType === 'admin') {
  // 获取所有客户
  const allCustomers = await User.findAll({
    attributes: ['account_balance']
  });
  
  // 汇总账户余额
  totalBalance = allCustomers.reduce((sum, customer) => 
    sum + parseFloat(customer.account_balance || 0), 0
  );
  
  // 获取所有订单
  const allOrders = await Order.findAll({
    attributes: ['quantity', 'total_amount']
  });
  
  // 汇总已购买数量
  totalPurchased = allOrders.reduce((sum, order) => 
    sum + parseInt(order.quantity || 0), 0
  );
  
  // 汇总累计消费
  totalSpent = allOrders.reduce((sum, order) => 
    sum + parseFloat(order.total_amount || 0), 0
  );
}
```

#### 代理查询
```javascript
else if (userType === 'agent') {
  // 获取本代理下的所有客户
  const agentCustomers = await User.findAll({
    where: { agent_id: userId },
    attributes: ['id', 'account_balance']
  });
  
  // 汇总账户余额
  totalBalance = agentCustomers.reduce((sum, customer) => 
    sum + parseFloat(customer.account_balance || 0), 0
  );
  
  const customerIds = agentCustomers.map(c => c.id);
  
  if (customerIds.length > 0) {
    // 获取这些客户的订单
    const customerOrders = await Order.findAll({
      where: { customer_id: { [Op.in]: customerIds } },
      attributes: ['quantity', 'total_amount']
    });
    
    // 汇总数据
    totalPurchased = customerOrders.reduce(...);
    totalSpent = customerOrders.reduce(...);
  }
}
```

#### 客户查询
```javascript
else if (userType === 'customer') {
  // 获取客户信息
  const customer = await User.findByPk(userId, {
    attributes: ['account_balance']
  });
  
  if (customer) {
    totalBalance = parseFloat(customer.account_balance || 0);
  }
  
  // 获取客户订单
  const customerOrders = await Order.findAll({
    where: { customer_id: userId },
    attributes: ['quantity', 'total_amount']
  });
  
  // 汇总数据
  totalPurchased = customerOrders.reduce(...);
  totalSpent = customerOrders.reduce(...);
}
```

---

### 2. 前端实现

#### 资源中心页面

**文件**: `/home/vue-element-admin/src/views/resource/center.vue`

**修改内容**:

##### 1) 统计卡片标签动态显示

```vue
<div class="balance-label">
  <template v-if="isAdmin">所有客户账户余额总额 (U)</template>
  <template v-else-if="isAgent">本代理下客户账户余额总额 (U)</template>
  <template v-else>账户余额 (U)</template>
</div>
```

##### 2) 数据加载方法

```javascript
async loadAccountStats() {
  try {
    // 获取当前用户信息
    const userInfo = this.$store.getters.userInfo;
    const userType = userInfo.type || 'customer';
    const userId = userInfo.id;

    // 调用后端API
    const response = await request({
      method: 'GET',
      url: `/api/stats/resource-center/${userType}/${userId}`
    });

    if (response.success && response.data) {
      this.userBalance = parseFloat(response.data.totalBalance || 0);
      this.totalPurchased = parseInt(response.data.totalPurchased || 0);
      this.totalSpent = parseFloat(response.data.totalSpent || 0);
    } else {
      // 降级到localStorage备用方案
      this.loadAccountStatsFromLocalStorage();
    }
  } catch (error) {
    // 错误处理
    this.loadAccountStatsFromLocalStorage();
  }
}
```

##### 3) localStorage备用方案

```javascript
loadAccountStatsFromLocalStorage() {
  const userData = JSON.parse(currentUser);
  const userType = userData.type;

  if (userType === 'admin') {
    // 管理员: 汇总所有客户数据
    const allCustomers = users.filter(u => u.type === 'customer');
    this.userBalance = allCustomers.reduce(...);
    
  } else if (userType === 'agent') {
    // 代理: 汇总本代理下客户数据
    const agentCustomers = users.filter(u => 
      u.type === 'customer' && u.agentId === userData.id
    );
    this.userBalance = agentCustomers.reduce(...);
    
  } else if (userType === 'customer') {
    // 客户: 仅本客户数据
    const customer = users.find(u => u.id === userData.id);
    this.userBalance = parseFloat(customer.accountBalance || 0);
  }
}
```

---

#### 订阅中心页面

**文件**: `/home/vue-element-admin/src/views/resource/subscription.vue`

**修改内容**:
- 使用相同的 `loadAccountStats()` 方法
- 订阅中心仅客户可见,所以只需要加载客户数据
- 标签文字保持不变 (不需要角色判断)

---

## 📊 数据展示对比

### 管理员视图

```
┌─────────────────────────────────────────┐
│ 📊 资源中心 - 管理员视图                 │
├─────────────────────────────────────────┤
│ ┌──────────────┐  ┌──────────────┐      │
│ │ 15,800.50    │  │ 8,500,000    │      │
│ │所有客户账户  │  │所有客户已购买│      │
│ │余额总额 (U)  │  │数据总量      │      │
│ └──────────────┘  └──────────────┘      │
│ ┌──────────────┐                        │
│ │ 24,203.00    │                        │
│ │所有客户累计  │                        │
│ │消费总额 (U)  │                        │
│ └──────────────┘                        │
└─────────────────────────────────────────┘
```

### 代理视图

```
┌─────────────────────────────────────────┐
│ 📊 资源中心 - 代理视图                   │
├─────────────────────────────────────────┤
│ ┌──────────────┐  ┌──────────────┐      │
│ │ 3,200.00     │  │ 1,500,000    │      │
│ │本代理下客户  │  │本代理下客户  │      │
│ │账户余额总额  │  │已购买数据总量│      │
│ │(U)           │  │              │      │
│ └──────────────┘  └──────────────┘      │
│ ┌──────────────┐                        │
│ │ 5,600.00     │                        │
│ │本代理下客户  │                        │
│ │累计消费总额  │                        │
│ │(U)           │                        │
│ └──────────────┘                        │
└─────────────────────────────────────────┘
```

### 客户视图

```
┌─────────────────────────────────────────┐
│ 📊 资源中心 - 客户视图                   │
├─────────────────────────────────────────┤
│ ┌──────────────┐  ┌──────────────┐      │
│ │ 1,580.50     │  │ 850,000      │      │
│ │账户余额 (U)  │  │已购买数据    │      │
│ └──────────────┘  └──────────────┘      │
│ ┌──────────────┐                        │
│ │ 2,420.30     │                        │
│ │累计消费 (U)  │                        │
│ └──────────────┘                        │
└─────────────────────────────────────────┘
```

---

## 🔄 数据流程

### 完整流程

```
1. 用户登录
   ↓
2. 进入资源中心
   ↓
3. 调用 loadAccountStats()
   ↓
4. 从 Vuex 获取用户类型和ID
   ↓
5. 调用后端API
   GET /api/stats/resource-center/{userType}/{userId}
   ↓
6. 后端根据角色查询数据
   - 管理员 → 查询所有客户
   - 代理 → 查询本代理下客户
   - 客户 → 查询本客户
   ↓
7. 返回统计数据
   ↓
8. 前端更新统计卡片显示
   ↓
9. 根据角色显示不同的标签文字
```

### API调用示例

#### 管理员
```javascript
GET /api/stats/resource-center/admin/1

Response:
{
  "success": true,
  "data": {
    "totalBalance": "15800.50",
    "totalPurchased": 8500000,
    "totalSpent": "24203.00"
  }
}
```

#### 代理
```javascript
GET /api/stats/resource-center/agent/2

Response:
{
  "success": true,
  "data": {
    "totalBalance": "3200.00",
    "totalPurchased": 1500000,
    "totalSpent": "5600.00"
  }
}
```

#### 客户
```javascript
GET /api/stats/resource-center/customer/3

Response:
{
  "success": true,
  "data": {
    "totalBalance": "1580.50",
    "totalPurchased": 850000,
    "totalSpent": "2420.30"
  }
}
```

---

## 🛡️ 错误处理

### 1. API调用失败

如果API调用失败,自动降级到localStorage备用方案:

```javascript
async loadAccountStats() {
  try {
    const response = await request(...);
    if (response.success) {
      // 使用API数据
    } else {
      // 降级到localStorage
      this.loadAccountStatsFromLocalStorage();
    }
  } catch (error) {
    // 错误处理,降级到localStorage
    this.loadAccountStatsFromLocalStorage();
  }
}
```

### 2. 数据为空处理

```javascript
this.userBalance = parseFloat(response.data.totalBalance || 0);
this.totalPurchased = parseInt(response.data.totalPurchased || 0);
this.totalSpent = parseFloat(response.data.totalSpent || 0);
```

---

## 📝 代码统计

| 文件 | 类型 | 行数变化 |
|------|------|----------|
| `backend/routes/stats.js` | 修改 | +102 |
| `src/views/resource/center.vue` | 修改 | +138 |
| `src/views/resource/subscription.vue` | 修改 | +33 |
| **总计** | - | **+273行** |

---

## ✅ 验证清单

- [x] 后端统计接口创建完成
- [x] 管理员查询所有客户数据逻辑
- [x] 代理查询本代理下客户数据逻辑
- [x] 客户查询本客户数据逻辑
- [x] 前端调用API获取数据
- [x] localStorage备用方案实现
- [x] 统计卡片标签动态显示
- [x] 错误处理和降级机制
- [x] 资源中心页面更新
- [x] 订阅中心页面更新
- [x] 无语法错误
- [x] 代码格式规范

---

## 🎯 核心优势

### 1. 角色权限分离
- ✅ 管理员看全局数据
- ✅ 代理看本代理数据
- ✅ 客户看个人数据

### 2. 双重保障
- ✅ 优先使用数据库API
- ✅ 降级使用localStorage

### 3. 用户体验
- ✅ 标签文字清晰明确
- ✅ 数据范围一目了然
- ✅ 实时更新统计数据

### 4. 可扩展性
- ✅ 易于添加新的角色
- ✅ 易于扩展统计维度
- ✅ 统一的API设计

---

## 🔍 使用示例

### 管理员查看全局数据

```
1. 管理员登录系统
2. 访问资源中心
3. 看到统计卡片:
   - 所有客户账户余额总额: 15,800.50 U
   - 所有客户已购买数据总量: 8,500,000 条
   - 所有客户累计消费总额: 24,203.00 U
```

### 代理查看团队数据

```
1. 代理登录系统
2. 访问资源中心
3. 看到统计卡片:
   - 本代理下客户账户余额总额: 3,200.00 U
   - 本代理下客户已购买数据总量: 1,500,000 条
   - 本代理下客户累计消费总额: 5,600.00 U
```

### 客户查看个人数据

```
1. 客户登录系统
2. 访问资源中心或订阅中心
3. 看到统计卡片:
   - 账户余额: 1,580.50 U
   - 已购买数据: 850,000 条
   - 累计消费: 2,420.30 U
```

---

## 🎉 总结

资源中心统计数据已成功实现按角色显示功能!

### 实现效果

✅ **管理员**: 看到所有客户的汇总数据
✅ **代理**: 看到本代理下客户的汇总数据  
✅ **客户**: 看到个人数据

### 技术特点

✅ **后端API**: 统一接口,根据角色返回不同数据
✅ **前端适配**: 动态标签,清晰展示数据范围
✅ **容错机制**: API失败自动降级到localStorage
✅ **实时更新**: 页面激活时自动刷新数据

立即体验按角色显示的统计数据功能! 🚀
