# çŸ­ä¿¡ç»“ç®—ç³»ç»Ÿ - å¿«é€Ÿå¯åŠ¨æŒ‡å—

## âœ… å·²å®Œæˆå·¥ä½œæ¸…å•

- [x] æ•°æ®åº“è¡¨åˆ›å»ºï¼ˆ3ä¸ªæ–°è¡¨ï¼‰
- [x] æ•°æ®åº“å­—æ®µæ·»åŠ ï¼ˆsms_recordsè¡¨ï¼‰
- [x] åç«¯æ¨¡å‹åˆ›å»ºï¼ˆ3ä¸ªï¼‰
- [x] åç«¯æœåŠ¡å®ç°ï¼ˆSettlementServiceï¼‰
- [x] åç«¯APIè·¯ç”±ï¼ˆ2ä¸ªï¼‰
- [x] å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨
- [x] å‰ç«¯APIå°è£…
- [x] å‰ç«¯é¡µé¢ç»„ä»¶ï¼ˆ3ä¸ªï¼‰
- [x] è·¯ç”±é…ç½®
- [x] ä¾èµ–å®‰è£…ï¼ˆlodashï¼‰
- [x] æ•°æ®åº“è¿ç§»æ‰§è¡Œ

## ğŸš€ ç«‹å³å¯åŠ¨

### 1. é‡å¯åç«¯æœåŠ¡

```bash
cd /home/vue-element-admin/backend
pm2 restart vue-element-admin-backend
# æˆ–
npm run dev
```

### 2. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤

```bash
pm2 logs vue-element-admin-backend
```

æœŸå¾…çœ‹åˆ°ï¼š
```
â° å¯åŠ¨çŸ­ä¿¡ç»“ç®—å®šæ—¶ä»»åŠ¡...
  âœ“ è‡ªåŠ¨ç»“ç®—ä»»åŠ¡å·²å¯åŠ¨ (æ¯å¤©å‡Œæ™¨2ç‚¹)
  âœ“ å‘¨æŠ¥è¡¨ä»»åŠ¡å·²å¯åŠ¨ (æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹)
  âœ“ æœˆæŠ¥è¡¨ä»»åŠ¡å·²å¯åŠ¨ (æ¯æœˆ1å·å‡Œæ™¨4ç‚¹)
âœ… æ‰€æœ‰çŸ­ä¿¡ç»“ç®—å®šæ—¶ä»»åŠ¡å¯åŠ¨å®Œæˆ
```

### 3. å‰ç«¯è®¿é—®

åˆ·æ–°æµè§ˆå™¨ï¼Œåœ¨å·¦ä¾§èœå• **çŸ­ä¿¡ç®¡ç†** ä¸‹å¯ä»¥çœ‹åˆ°ï¼š
- é€šé“é…ç½®
- å‘é€è®°å½•
- çŸ­ä¿¡ç»Ÿè®¡
- **çŸ­ä¿¡ç»“ç®—** â­ï¸ï¼ˆæ–°å¢ï¼‰

## ğŸ“ å¿«é€Ÿæµ‹è¯•æµç¨‹

### æ­¥éª¤1ï¼šé…ç½®é€šé“å›½å®¶å®šä»·

1. è¿›å…¥ **çŸ­ä¿¡ç®¡ç† > é€šé“é…ç½®**
2. ç‚¹å‡»æŸä¸ªé€šé“çš„ **"å›½å®¶å®šä»·"** æŒ‰é’®ï¼ˆéœ€è¦å…ˆä¿®æ”¹channels.vueæ·»åŠ æ­¤æŒ‰é’®ï¼‰
3. æ·»åŠ å›½å®¶å®šä»·é…ç½®ï¼š
   - å›½å®¶ï¼šChina
   - å›½å®¶ä»£ç ï¼š86
   - æˆæœ¬ä»·ï¼š0.0050
   - é”€å”®ä»·ï¼š0.0080
   - æœ€å¤§å­—ç¬¦ï¼š70

### æ­¥éª¤2ï¼šæ‰‹åŠ¨è§¦å‘ç»“ç®—æµ‹è¯•

1. è¿›å…¥ **çŸ­ä¿¡ç®¡ç† > çŸ­ä¿¡ç»“ç®—**
2. ç‚¹å‡» **"æ‰‹åŠ¨ç»“ç®—"**
3. é€‰æ‹©ä¸€ä¸ªæœ‰å‘é€è®°å½•çš„æ—¥æœŸ
4. ç‚¹å‡» **"ç¡®è®¤ç»“ç®—"**
5. æŸ¥çœ‹ç»“ç®—ç»“æœ

### æ­¥éª¤3ï¼šæŸ¥çœ‹ç»“ç®—æ˜ç»†

1. åœ¨ç»“ç®—åˆ—è¡¨ä¸­ç‚¹å‡» **"æŸ¥çœ‹æ˜ç»†"**
2. æŸ¥çœ‹è¯¦ç»†çš„çŸ­ä¿¡å‘é€è®°å½•å’Œåˆ©æ¶¦è®¡ç®—

### æ­¥éª¤4ï¼šç”Ÿæˆä¸šç»©æŠ¥è¡¨

1. ç‚¹å‡» **"ç”ŸæˆæŠ¥è¡¨"**
2. é€‰æ‹©æ—¥æœŸèŒƒå›´å’Œåˆ†ç»„ç»´åº¦
3. æŸ¥çœ‹ç»Ÿè®¡æ•°æ®

## âš ï¸ å¾…å®Œæˆé›†æˆ

### å¿…éœ€ï¼šä¿®æ”¹é€šé“ç®¡ç†é¡µé¢

**æ–‡ä»¶**: `/src/views/sms/admin/channels.vue`

åœ¨è¡¨æ ¼æ“ä½œåˆ—æ·»åŠ æŒ‰é’®ï¼š

```vue
<template>
  <!-- åœ¨æ“ä½œåˆ—çš„ el-table-column ä¸­æ·»åŠ  -->
  <el-button type="warning" size="mini" @click="handleCountryPricing(row)">
    å›½å®¶å®šä»·
  </el-button>
  
  <!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ ç»„ä»¶ -->
  <channel-country-pricing
    :visible.sync="pricingDialogVisible"
    :channel-id="currentChannelId"
    :channel-name="currentChannelName"
  />
</template>

<script>
import ChannelCountryPricing from '@/components/SmsChannelCountryPricing'

export default {
  components: { ChannelCountryPricing },
  data() {
    return {
      pricingDialogVisible: false,
      currentChannelId: null,
      currentChannelName: ''
    }
  },
  methods: {
    handleCountryPricing(row) {
      this.currentChannelId = row.id
      this.currentChannelName = row.channel_name
      this.pricingDialogVisible = true
    }
  }
}
</script>
```

### å¿…éœ€ï¼šä¿®æ”¹çŸ­ä¿¡å‘é€é€»è¾‘

åœ¨å‘é€çŸ­ä¿¡æ—¶è®°å½•æˆæœ¬ä»·å’Œé”€å”®ä»·ã€‚

æ‰¾åˆ°çŸ­ä¿¡å‘é€çš„è·¯ç”±æ–‡ä»¶ï¼ˆå¯èƒ½æ˜¯ `smsCustomer.js` æˆ– `smsAdmin.js`ï¼‰ï¼Œåœ¨åˆ›å»º `SmsRecord` æ—¶æ·»åŠ ï¼š

```javascript
const { SmsChannelCountry } = require('../config/database').models;

// è·å–ä»·æ ¼
const pricing = await SmsChannelCountry.findOne({
  where: {
    channel_id: channelId,
    country: country, // æ ¹æ®æ‰‹æœºå·å›½å®¶ä»£ç è·å–
    status: 1
  }
});

const cost_price = pricing ? pricing.cost_price : 0;
const sale_price = pricing ? pricing.sale_price : 0;

// åˆ›å»ºè®°å½•æ—¶åŒ…å«ä»·æ ¼
await SmsRecord.create({
  // ... å…¶ä»–å­—æ®µ
  cost_price,
  sale_price,
  country
});
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

### 1. è‡ªåŠ¨ç»“ç®—

- **æ—¶é—´**: æ¯å¤©å‡Œæ™¨2ç‚¹
- **èŒƒå›´**: å‰ä¸€å¤©æ‰€æœ‰æˆåŠŸå‘é€çš„çŸ­ä¿¡
- **ç»´åº¦**: æŒ‰å®¢æˆ·ã€é€šé“ã€å›½å®¶åˆ†ç»„
- **è®¡ç®—**: 
  - æ€»æˆæœ¬ = Î£(æˆæœ¬ä»·)
  - æ€»æ”¶å…¥ = Î£(é”€å”®ä»·)
  - æ€»åˆ©æ¶¦ = æ€»æ”¶å…¥ - æ€»æˆæœ¬

### 2. æ‰‹åŠ¨ç»“ç®—

ç”¨äºè¡¥ç»“ç®—æˆ–é‡æ–°ç»“ç®—æŒ‡å®šæ—¥æœŸçš„æ•°æ®ã€‚

### 3. ä¸šç»©æŠ¥è¡¨

æ”¯æŒå¤šç»´åº¦åˆ†ç»„ï¼š
- æŒ‰æ—¥æœŸï¼šæŸ¥çœ‹æ¯å¤©çš„ä¸šç»©è¶‹åŠ¿
- æŒ‰å®¢æˆ·ï¼šæŸ¥çœ‹å„å®¢æˆ·çš„æ¶ˆè´¹å’Œåˆ©æ¶¦
- æŒ‰é€šé“ï¼šæŸ¥çœ‹å„é€šé“çš„ä½¿ç”¨æƒ…å†µ
- æŒ‰å›½å®¶ï¼šæŸ¥çœ‹å„å›½å®¶çš„ä¸šåŠ¡åˆ†å¸ƒ

### 4. æ•°æ®å¯¼å‡º

å¯¼å‡ºCSVæ ¼å¼çš„ç»“ç®—æ•°æ®ï¼Œä¾¿äºè¿›ä¸€æ­¥åˆ†æã€‚

## ğŸ“Š APIæµ‹è¯•

### æµ‹è¯•é€šé“å›½å®¶é…ç½®

```bash
# è·å–é€šé“1çš„æ‰€æœ‰å›½å®¶é…ç½®
curl http://localhost:3000/api/sms/channels/1/countries

# æ·»åŠ å›½å®¶é…ç½®
curl -X POST http://localhost:3000/api/sms/channels/1/countries \
  -H "Content-Type: application/json" \
  -d '{
    "country": "China",
    "country_code": "86",
    "cost_price": 0.0050,
    "sale_price": 0.0080,
    "max_chars": 70
  }'

# è·å–ä»·æ ¼ä¿¡æ¯
curl http://localhost:3000/api/sms/channels/1/countries/price/86
```

### æµ‹è¯•ç»“ç®—åŠŸèƒ½

```bash
# è·å–ç»“ç®—åˆ—è¡¨
curl "http://localhost:3000/api/sms/settlements?start_date=2025-10-01&end_date=2025-10-21"

# æ‰‹åŠ¨è§¦å‘ç»“ç®—
curl -X POST http://localhost:3000/api/sms/settlements/calculate \
  -H "Content-Type: application/json" \
  -d '{"date": "2025-10-20"}'

# è·å–ç»Ÿè®¡æ¦‚è§ˆ
curl "http://localhost:3000/api/sms/settlements/statistics/overview?start_date=2025-10-01&end_date=2025-10-21"

# ç”ŸæˆæŠ¥è¡¨
curl "http://localhost:3000/api/sms/settlements/reports/generate?start_date=2025-10-01&end_date=2025-10-21&group_by=customer"
```

## ğŸ› æ•…éšœæ’æŸ¥

### 1. å®šæ—¶ä»»åŠ¡æœªå¯åŠ¨

**ç°è±¡**: æ—¥å¿—ä¸­æ²¡æœ‰çœ‹åˆ°å®šæ—¶ä»»åŠ¡å¯åŠ¨ä¿¡æ¯

**æ£€æŸ¥**: 
```bash
cd /home/vue-element-admin/backend
grep "startSettlementTasks" server.js
```

**è§£å†³**: ç¡®ä¿ server.js ä¸­å·²å¯¼å…¥å¹¶è°ƒç”¨ `startSettlementTasks()`

### 2. è·¯ç”±404é”™è¯¯

**ç°è±¡**: è®¿é—®ç»“ç®—APIè¿”å›404

**æ£€æŸ¥**: 
```bash
grep "settlements" /home/vue-element-admin/backend/server.js
```

**è§£å†³**: ç¡®ä¿åœ¨ server.js ä¸­æ³¨å†Œäº†è·¯ç”±

### 3. å‰ç«¯é¡µé¢ç©ºç™½

**ç°è±¡**: ç‚¹å‡»"çŸ­ä¿¡ç»“ç®—"èœå•åé¡µé¢ç©ºç™½

**æ£€æŸ¥**: æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

**è§£å†³**: 
- æ£€æŸ¥è·¯ç”±é…ç½®æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç»„ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥APIæ˜¯å¦èƒ½æ­£å¸¸è¿”å›æ•°æ®

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **çŸ­ä¿¡ç»“ç®—ç³»ç»Ÿ-å®æ–½å®ŒæˆæŠ¥å‘Š.md** - å®Œæ•´çš„å®æ–½æŠ¥å‘Šå’Œä»£ç ç»Ÿè®¡
2. **çŸ­ä¿¡å¤šå›½å®¶å®šä»·å’Œç»“ç®—ç³»ç»Ÿ-å®æ–½æ–¹æ¡ˆ.md** - è¯¦ç»†çš„è®¾è®¡æ–¹æ¡ˆ
3. **çŸ­ä¿¡ç»“ç®—ç³»ç»Ÿ-å®Œæ•´å®æ–½ä»£ç .md** - æ‰€æœ‰ä»£ç æ¨¡æ¿
4. **database/migrations/2025-10-21_sms_settlement.sql** - æ•°æ®åº“è¿ç§»è„šæœ¬

## âœ¨ ä¸‹ä¸€æ­¥å»ºè®®

1. **ç«‹å³å¯ç”¨**:
   - é‡å¯åç«¯æœåŠ¡
   - è®¿é—®å‰ç«¯æŸ¥çœ‹æ–°åŠŸèƒ½
   - æµ‹è¯•æ‰‹åŠ¨ç»“ç®—åŠŸèƒ½

2. **çŸ­æœŸä¼˜åŒ–** (1-2å°æ—¶):
   - åœ¨é€šé“ç®¡ç†é¡µé¢é›†æˆå›½å®¶å®šä»·é…ç½®
   - ä¿®æ”¹çŸ­ä¿¡å‘é€é€»è¾‘è®°å½•ä»·æ ¼

3. **é•¿æœŸä¼˜åŒ–** (å¯é€‰):
   - æ·»åŠ æŠ¥è¡¨å¯è§†åŒ–å›¾è¡¨
   - æ·»åŠ é‚®ä»¶é€šçŸ¥åŠŸèƒ½
   - ä¼˜åŒ–å¤§æ•°æ®é‡ç»“ç®—æ€§èƒ½
   - æ·»åŠ ç»“ç®—æ•°æ®å®¡æ ¸æµç¨‹

## ğŸ‰ æ­å–œï¼

æ ¸å¿ƒåŠŸèƒ½å·²ç»å…¨éƒ¨å®Œæˆï¼Œç³»ç»Ÿå¯ä»¥ç‹¬ç«‹è¿è¡Œã€‚åªéœ€å®ŒæˆçŸ­ä¿¡å‘é€é€»è¾‘çš„é›†æˆï¼Œå³å¯æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼

---

**æœ€åæ›´æ–°**: 2025-10-21  
**çŠ¶æ€**: âœ… å¯ä»¥ç«‹å³å¯åŠ¨æµ‹è¯•
