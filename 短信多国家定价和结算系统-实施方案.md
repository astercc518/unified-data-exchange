# 短信多国家定价和结算系统 - 完整实施方案

## 📋 需求概述

### 核心需求
1. **通道多国家支持** - 一个通道可配置多个国家，每个国家独立定价
2. **双重定价体系** - 成本价（采购价）+ 销售价（客户价）
3. **自动结算系统** - 按日/按需自动结算客户短信费用
4. **业绩统计报表** - 成本、销售额、利润多维度统计

---

## 🗄️ 数据库设计

### 1. 通道国家定价表 (sms_channel_countries)

```sql
CREATE TABLE sms_channel_countries (
  id INT AUTO_INCREMENT PRIMARY KEY,
  channel_id INT NOT NULL,                    -- 通道ID
  country VARCHAR(50) NOT NULL,               -- 国家名称
  country_code VARCHAR(10) NOT NULL,          -- 国家代码
  cost_price DECIMAL(10,4) NOT NULL,          -- 成本价/条
  sale_price DECIMAL(10,4) NOT NULL,          -- 销售价/条
  max_chars INT NOT NULL DEFAULT 160,         -- 最大字符数
  status TINYINT(1) NOT NULL DEFAULT 1,       -- 状态
  created_at DATETIME,
  updated_at DATETIME,
  UNIQUE KEY uk_channel_country (channel_id, country)
);
```

**说明**：
- 一个通道可以有多条国家配置记录
- 每个国家独立设置成本价和销售价
- 支持按国家设置不同的字符数限制

### 2. 短信结算表 (sms_settlements)

```sql
CREATE TABLE sms_settlements (
  id INT AUTO_INCREMENT PRIMARY KEY,
  settlement_date DATE NOT NULL,              -- 结算日期
  customer_id INT NOT NULL,                   -- 客户ID
  channel_id INT NOT NULL,                    -- 通道ID
  country VARCHAR(50) NOT NULL,               -- 国家
  total_count INT NOT NULL,                   -- 总发送数
  success_count INT NOT NULL,                 -- 成功数
  failed_count INT NOT NULL,                  -- 失败数
  total_cost DECIMAL(12,4) NOT NULL,          -- 总成本
  total_revenue DECIMAL(12,4) NOT NULL,       -- 总销售额
  total_profit DECIMAL(12,4) NOT NULL,        -- 总利润
  cost_price DECIMAL(10,4) NOT NULL,          -- 成本价/条
  sale_price DECIMAL(10,4) NOT NULL,          -- 销售价/条
  settlement_status ENUM('pending','processing','completed','failed'),
  created_at DATETIME,
  updated_at DATETIME,
  UNIQUE KEY uk_settlement (settlement_date, customer_id, channel_id, country)
);
```

**说明**：
- 按日期、客户、通道、国家维度汇总
- 记录成本、销售额、利润
- 支持结算状态跟踪

### 3. 结算明细表 (sms_settlement_details)

```sql
CREATE TABLE sms_settlement_details (
  id INT AUTO_INCREMENT PRIMARY KEY,
  settlement_id INT NOT NULL,                 -- 结算ID
  record_id INT NOT NULL,                     -- 发送记录ID
  phone_number VARCHAR(20) NOT NULL,          -- 手机号
  cost DECIMAL(10,4) NOT NULL,                -- 成本
  revenue DECIMAL(10,4) NOT NULL,             -- 销售额
  profit DECIMAL(10,4) NOT NULL,              -- 利润
  status VARCHAR(20) NOT NULL,                -- 状态
  sent_at DATETIME,                           -- 发送时间
  created_at DATETIME
);
```

**说明**：
- 记录每条短信的详细结算信息
- 关联发送记录ID便于追溯
- 支持明细查询和审计

---

## 🏗️ 系统架构

### 1. 模型层（Models）

#### SmsChannelCountry（通道国家配置）
- `findByChannel(channelId)` - 获取通道的所有国家配置
- `findByCountry(channelId, country)` - 获取特定国家配置
- `getPricing(channelId, country)` - 获取定价信息

#### SmsSettlement（结算）
- `createSettlement(data)` - 创建结算记录
- `getByDateRange(startDate, endDate)` - 按日期范围查询
- `getByCustomer(customerId)` - 按客户查询
- `updateStatus(id, status)` - 更新结算状态

### 2. 服务层（Services）

#### SettlementService（结算服务）
```javascript
class SettlementService {
  // 自动结算（按日期）
  async autoSettle(date)
  
  // 计算客户当日结算
  async calculateCustomerSettlement(customerId, date)
  
  // 生成结算报表
  async generateReport(params)
  
  // 重新结算
  async reSettle(settlementId)
}
```

#### PricingService（定价服务）
```javascript
class PricingService {
  // 获取通道国家价格
  async getPrice(channelId, country)
  
  // 计算发送成本
  async calculateCost(channelId, country, count)
  
  // 批量获取价格
  async getBatchPricing(items)
}
```

### 3. 路由层（Routes）

#### /api/sms/admin/channels/:id/countries
- `GET` - 获取通道国家配置列表
- `POST` - 添加国家配置
- `PUT /:countryId` - 更新国家配置
- `DELETE /:countryId` - 删除国家配置

#### /api/sms/admin/settlements
- `GET` - 获取结算列表
- `POST /calculate` - 手动触发结算
- `GET /:id` - 获取结算详情
- `GET /:id/details` - 获取结算明细
- `POST /:id/export` - 导出结算数据

#### /api/sms/admin/reports
- `GET /profit` - 利润报表
- `GET /revenue` - 销售额报表
- `GET /cost` - 成本报表
- `GET /summary` - 综合报表

---

## 🎨 前端界面设计

### 1. 通道配置增强

#### 原有功能
- 通道基础信息配置
- 协议配置（HTTP/SMPP）

#### 新增功能
- **国家定价管理**（Tab页签）
  - 国家列表（表格）
  - 添加国家按钮
  - 每个国家显示：
    - 国家名称
    - 国家代码
    - 成本价
    - 销售价
    - 利润率
    - 最大字符数
    - 状态
    - 操作（编辑/删除）

#### 界面布局
```
┌─ 通道配置 ─────────────────────────────┐
│ [基础配置] [协议配置] [国家定价] [统计] │
├──────────────────────────────────────┤
│ 国家定价列表                    [+添加] │
│ ┌────────────────────────────────┐ │
│ │国家│成本价│销售价│利润率│操作 │ │
│ ├────────────────────────────────┤ │
│ │印度│0.0050│0.0080│60%│[编辑]  │ │
│ │美国│0.0100│0.0150│50%│[编辑]  │ │
│ │巴西│0.0080│0.0120│50%│[编辑]  │ │
│ └────────────────────────────────┘ │
└──────────────────────────────────────┘
```

### 2. 短信结算管理（新增页面）

#### 功能模块
1. **结算概览**
   - 今日待结算金额
   - 本月已结算金额
   - 待处理结算数
   - 异常结算数

2. **结算列表**
   - 筛选：日期范围、客户、通道、国家、状态
   - 显示字段：
     - 结算日期
     - 客户名称
     - 通道名称
     - 国家
     - 发送数/成功数
     - 成本价
     - 销售价
     - 总成本
     - 总销售额
     - 利润
     - 利润率
     - 结算状态
     - 操作

3. **操作功能**
   - 查看明细
   - 导出Excel
   - 重新结算
   - 手动结算

#### 界面布局
```
┌─ 短信结算 ─────────────────────────────────────────┐
│ [概览卡片区域]                                      │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐               │
│ │待结算│ │已结算│ │待处理│ │异常 │               │
│ └─────┘ └─────┘ └─────┘ └─────┘               │
│                                                    │
│ [筛选区域]                                          │
│ 日期: [开始] - [结束]  客户: [选择]  [搜索] [导出] │
│                                                    │
│ [结算列表]                                          │
│ ┌──────────────────────────────────────────────┐│
│ │日期│客户│通道│国家│数量│成本│销售额│利润│操作││
│ ├──────────────────────────────────────────────┤│
│ │10-21│张三│SMS57│印度│1000│$5│$8│$3│[详情]││
│ │10-21│李四│SMS57│美国│500│$5│$7.5│$2.5│[详情]││
│ └──────────────────────────────────────────────┘│
└────────────────────────────────────────────────────┘
```

### 3. 业绩报表（新增页面）

#### 报表类型
1. **利润报表**
   - 按日期统计
   - 按客户统计
   - 按通道统计
   - 按国家统计

2. **趋势图表**
   - 成本趋势
   - 销售额趋势
   - 利润趋势
   - 利润率趋势

3. **排行榜**
   - 客户销售额排行
   - 客户利润排行
   - 通道使用排行
   - 国家发送量排行

---

## 🔧 核心功能实现

### 1. 发送时价格计算

#### 流程
```
1. 客户创建发送任务
   ↓
2. 选择通道和国家
   ↓
3. 从 sms_channel_countries 获取定价
   ↓
4. 计算总费用（按销售价）
   ↓
5. 检查客户余额
   ↓
6. 扣除余额（按销售价）
   ↓
7. 发送短信
   ↓
8. 创建发送记录（保存成本价和销售价）
```

#### 代码示例
```javascript
// 获取价格
const pricing = await SmsChannelCountry.findOne({
  where: {
    channel_id: channelId,
    country: country,
    status: 1
  }
});

if (!pricing) {
  throw new Error('该通道不支持此国家');
}

// 计算费用
const totalCost = phoneNumbers.length * parseFloat(pricing.cost_price);
const totalRevenue = phoneNumbers.length * parseFloat(pricing.sale_price);
const totalProfit = totalRevenue - totalCost;

// 扣除余额（按销售价）
await user.decrement('account_balance', { by: totalRevenue });

// 创建记录
await SmsRecord.create({
  ...
  cost: pricing.sale_price,  // 客户支付价格
  cost_price: pricing.cost_price,  // 成本价（新增字段）
  sale_price: pricing.sale_price,  // 销售价（新增字段）
  ...
});
```

### 2. 自动结算

#### 定时任务
```javascript
// 使用 node-cron
const cron = require('node-cron');

// 每天凌晨2点自动结算前一天的数据
cron.schedule('0 2 * * *', async () => {
  const yesterday = moment().subtract(1, 'days').format('YYYY-MM-DD');
  await SettlementService.autoSettle(yesterday);
});
```

#### 结算逻辑
```javascript
async autoSettle(date) {
  // 1. 获取当天所有发送记录
  const records = await SmsRecord.findAll({
    where: {
      sent_at: {
        [Op.between]: [
          `${date} 00:00:00`,
          `${date} 23:59:59`
        ]
      },
      status: 'success'  // 只结算成功的
    }
  });

  // 2. 按客户、通道、国家分组
  const groups = _.groupBy(records, r => 
    `${r.customer_id}_${r.channel_id}_${r.country}`
  );

  // 3. 每组创建一条结算记录
  for (const [key, groupRecords] of Object.entries(groups)) {
    const [customerId, channelId, country] = key.split('_');
    
    const totalCount = groupRecords.length;
    const totalCost = _.sumBy(groupRecords, r => parseFloat(r.cost_price));
    const totalRevenue = _.sumBy(groupRecords, r => parseFloat(r.sale_price));
    const totalProfit = totalRevenue - totalCost;
    
    // 创建结算记录
    const settlement = await SmsSettlement.create({
      settlement_date: date,
      customer_id: customerId,
      channel_id: channelId,
      country: country,
      total_count: totalCount,
      success_count: totalCount,
      failed_count: 0,
      total_cost: totalCost,
      total_revenue: totalRevenue,
      total_profit: totalProfit,
      cost_price: totalCost / totalCount,
      sale_price: totalRevenue / totalCount,
      settlement_status: 'completed'
    });
    
    // 创建明细记录
    const details = groupRecords.map(r => ({
      settlement_id: settlement.id,
      record_id: r.id,
      phone_number: r.phone_number,
      cost: r.cost_price,
      revenue: r.sale_price,
      profit: parseFloat(r.sale_price) - parseFloat(r.cost_price),
      status: r.status,
      sent_at: r.sent_at
    }));
    
    await SmsSettlementDetail.bulkCreate(details);
  }
}
```

---

## 📊 数据统计维度

### 1. 按时间统计
- 按日统计
- 按周统计
- 按月统计
- 按年统计
- 自定义日期范围

### 2. 按维度统计
- 按客户统计
- 按通道统计
- 按国家统计
- 按平台类型统计
- 组合维度统计

### 3. 统计指标
- 发送总数
- 成功数/失败数
- 成功率
- 总成本
- 总销售额
- 总利润
- 平均利润率
- 平均成本价
- 平均销售价

---

## 🚀 实施步骤

### 阶段一：数据库和模型（已完成）
- ✅ 创建 sms_channel_countries 表
- ✅ 创建 sms_settlements 表
- ✅ 创建 sms_settlement_details 表
- ✅ 创建 SmsChannelCountry 模型
- ✅ 创建 SmsSettlement 模型

### 阶段二：后端API开发（进行中）
- [ ] 通道国家配置API
- [ ] 结算服务实现
- [ ] 结算API接口
- [ ] 报表统计API
- [ ] 定时任务配置

### 阶段三：前端开发
- [ ] 通道配置 - 国家定价Tab
- [ ] 短信结算管理页面
- [ ] 业绩报表页面
- [ ] 数据图表组件

### 阶段四：测试和优化
- [ ] 功能测试
- [ ] 性能测试
- [ ] 数据准确性验证
- [ ] UI/UX优化

---

## ⚠️ 注意事项

### 1. 数据迁移
现有通道已有 `price_per_sms` 字段，需要：
- 为现有通道创建默认国家配置
- 将 `price_per_sms` 作为销售价
- 成本价需要手动设置或按比例计算

### 2. 兼容性
- 保留原有单一定价方式
- 优先使用国家定价
- 国家定价不存在时降级使用通道默认价格

### 3. 性能优化
- 结算数据量大时考虑分批处理
- 使用索引优化查询
- 缓存常用定价信息
- 异步处理结算任务

### 4. 数据一致性
- 使用事务保证结算准确性
- 记录审计日志
- 支持重新结算
- 异常数据告警

---

## 📈 预期效果

### 业务价值
1. **灵活定价** - 支持不同国家差异化定价
2. **利润透明** - 清晰的成本和利润核算
3. **自动化** - 自动结算减少人工成本
4. **数据决策** - 丰富的报表支持业务决策

### 技术指标
1. **准确性** - 结算准确率 > 99.9%
2. **及时性** - 每日自动结算，2小时内完成
3. **性能** - 单日百万级数据结算 < 5分钟
4. **可靠性** - 支持重新结算和数据修正

---

**文档版本**: 1.0  
**创建时间**: 2025-10-21  
**状态**: 设计阶段
