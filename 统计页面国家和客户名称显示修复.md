# 统计页面国家和客户名称显示修复

## 问题描述

在管理员统计页面中，存在以下显示异常：

### 问题1：国家显示为 "TEST"
**位置**：
- 按国家统计表格
- 按通道统计表格

**现象**：所有测试记录的国家列都显示为 "TEST"，而不是真实的国家名称（如 Brazil、Vietnam 等）

### 问题2：客户名称显示为 "未知客户"
**位置**：按客户统计表格（Top 10）

**现象**：管理员测试发送的记录显示为"未知客户"，而不是 "admin"

## 根本原因

### 原因1：测试发送时硬编码国家为 "TEST"

**错误代码**（`/backend/routes/smsAdmin.js` 第632行）：
```javascript
await SmsRecord.create({
  task_id: null,
  customer_id: req.user?.id || 1,
  channel_id: id,
  phone_number,
  country: 'TEST',  // ❌ 硬编码为TEST
  content,
  // ... 其他字段
});
```

**问题分析**：
- 测试发送时，国家字段被硬编码为 `'TEST'`
- 导致统计时无法按真实国家分组
- 所有测试记录都归类到 "TEST" 国家

### 原因2：管理员用户没有 customer_name

**错误代码**（`/backend/routes/smsAdmin.js` 第456-462行）：
```javascript
const customerData = byCustomer.map(item => ({
  customer_id: item.customer_id,
  customer_name: item.customer ? item.customer.customer_name : '未知客户',  // ❌ 管理员没有customer_name
  total_sent: parseInt(item.get('total_sent')) || 0,
  total_success: parseInt(item.get('total_success')) || 0,
  total_cost: parseFloat(item.get('total_cost')) || 0
}));
```

**问题分析**：
- `customer_id = 1` 是管理员账号
- 管理员用户表中 `customer_name` 字段为空或NULL
- 统计时只检查了 `customer_name`，没有处理管理员的特殊情况
- 根据项目规范：**"管理员测试发送的短信记录，其客户名称必须显示为'admin'"**

## 解决方案

### 方案1：实现手机号国家自动识别

创建工具函数 `getCountryFromPhone()`，根据手机号国家码自动识别国家：

```javascript
/**
 * 根据手机号识别国家
 * @param {string} phoneNumber - 手机号码
 * @returns {string} 国家名称
 */
function getCountryFromPhone(phoneNumber) {
  // 移除所有非数字字符
  const cleanPhone = phoneNumber.replace(/\D/g, '');
  
  // 国家码映射
  const countryCodeMap = {
    '55': 'Brazil',        // 巴西
    '84': 'Vietnam',       // 越南
    '880': 'Bangladesh',   // 孟加拉
    '86': 'China',         // 中国
    '1': 'USA',            // 美国/加拿大
    '91': 'India',         // 印度
    '62': 'Indonesia',     // 印度尼西亚
    '63': 'Philippines',   // 菲律宾
    '66': 'Thailand',      // 泰国
    '60': 'Malaysia',      // 马来西亚
    '65': 'Singapore'      // 新加坡
  };
  
  // 按照从长到短的顺序匹配国家码
  const sortedCodes = Object.keys(countryCodeMap).sort((a, b) => b.length - a.length);
  
  for (const code of sortedCodes) {
    if (cleanPhone.startsWith(code)) {
      return countryCodeMap[code];
    }
  }
  
  return 'Unknown';  // 未知国家
}
```

**优势**：
- ✅ 自动识别，无需手动输入
- ✅ 支持多国家码
- ✅ 按长度优先匹配（避免 `1` 匹配到 `880` 开头的号码）
- ✅ 可扩展，易于添加新国家

### 方案2：修复客户名称显示逻辑

增强客户统计数据格式化，处理管理员特殊情况：

```javascript
// 格式化客户统计数据
const customerData = byCustomer.map(item => {
  let customerName = '未知客户';
  if (item.customer && item.customer.customer_name) {
    customerName = item.customer.customer_name;
  } else if (item.customer && item.customer.login_account === 'admin') {
    customerName = 'admin';  // 管理员测试记录显示为admin
  }
  
  return {
    customer_id: item.customer_id,
    customer_name: customerName,
    total_sent: parseInt(item.get('total_sent')) || 0,
    total_success: parseInt(item.get('total_success')) || 0,
    total_cost: parseFloat(item.get('total_cost')) || 0
  };
});
```

**判断逻辑**：
1. 如果有 `customer_name`，使用 `customer_name`
2. 如果 `login_account === 'admin'`，显示 "admin"
3. 其他情况，显示 "未知客户"

## 修改内容

### 文件：`/home/vue-element-admin/backend/routes/smsAdmin.js`

#### 修改1：添加国家识别函数（第11行后）

```javascript
/**
 * 根据手机号识别国家
 * @param {string} phoneNumber - 手机号码
 * @returns {string} 国家名称
 */
function getCountryFromPhone(phoneNumber) {
  // 移除所有非数字字符
  const cleanPhone = phoneNumber.replace(/\D/g, '');
  
  // 国家码映射（根据实际业务添加）
  const countryCodeMap = {
    // 巴西
    '55': 'Brazil',
    // 越南
    '84': 'Vietnam',
    // 孟加拉
    '880': 'Bangladesh',
    // 中国
    '86': 'China',
    // 美国/加拿大
    '1': 'USA',
    // 印度
    '91': 'India',
    // 印度尼西亚
    '62': 'Indonesia',
    // 菲律宾
    '63': 'Philippines',
    // 泰国
    '66': 'Thailand',
    // 马来西亚
    '60': 'Malaysia',
    // 新加坡
    '65': 'Singapore'
  };
  
  // 按照从长到短的顺序匹配国家码
  const sortedCodes = Object.keys(countryCodeMap).sort((a, b) => b.length - a.length);
  
  for (const code of sortedCodes) {
    if (cleanPhone.startsWith(code)) {
      return countryCodeMap[code];
    }
  }
  
  return 'Unknown';  // 未知国家
}
```

#### 修改2：增加 login_account 查询字段（第437行）

**修改前**：
```javascript
include: [
  {
    model: User,
    as: 'customer',
    attributes: ['customer_name'],  // ❌ 只查询customer_name
    required: false
  }
]
```

**修改后**：
```javascript
include: [
  {
    model: User,
    as: 'customer',
    attributes: ['customer_name', 'login_account'],  // ✅ 增加login_account
    required: false
  }
]
```

#### 修改3：修复客户名称显示逻辑（第457-465行）

**修改前**：
```javascript
const customerData = byCustomer.map(item => ({
  customer_id: item.customer_id,
  customer_name: item.customer ? item.customer.customer_name : '未知客户',
  total_sent: parseInt(item.get('total_sent')) || 0,
  total_success: parseInt(item.get('total_success')) || 0,
  total_cost: parseFloat(item.get('total_cost')) || 0
}));
```

**修改后**：
```javascript
const customerData = byCustomer.map(item => {
  let customerName = '未知客户';
  if (item.customer && item.customer.customer_name) {
    customerName = item.customer.customer_name;
  } else if (item.customer && item.customer.login_account === 'admin') {
    customerName = 'admin';  // 管理员测试记录显示为admin
  }
  
  return {
    customer_id: item.customer_id,
    customer_name: customerName,
    total_sent: parseInt(item.get('total_sent')) || 0,
    total_success: parseInt(item.get('total_success')) || 0,
    total_cost: parseFloat(item.get('total_cost')) || 0
  };
});
```

#### 修改4：使用国家识别函数（测试发送，第678-682行）

**修改前**：
```javascript
if (sendResult.success && sendResult.list && sendResult.list.length > 0) {
  // 记录测试发送（不计费）
  await SmsRecord.create({
    task_id: null,
    customer_id: req.user?.id || 1,
    channel_id: id,
    phone_number,
    country: 'TEST',  // ❌ 硬编码
    content,
    // ... 其他字段
  });
}
```

**修改后**：
```javascript
if (sendResult.success && sendResult.list && sendResult.list.length > 0) {
  // 从手机号识别国家
  const country = getCountryFromPhone(phone_number);
  
  // 记录测试发送（不计费）
  await SmsRecord.create({
    task_id: null,
    customer_id: req.user?.id || 1,
    channel_id: id,
    phone_number,
    country: country,  // ✅ 从手机号识别
    content,
    // ... 其他字段
  });
}
```

### 数据库更新：历史数据修复

**文件**：`/home/vue-element-admin/更新测试记录国家.sql`

更新已有的测试记录，将 `country = 'TEST'` 改为真实国家：

```sql
-- 巴西 (55开头)
UPDATE sms_records 
SET country = 'Brazil' 
WHERE country = 'TEST' 
  AND phone_number LIKE '55%';

-- 越南 (84开头)
UPDATE sms_records 
SET country = 'Vietnam' 
WHERE country = 'TEST' 
  AND phone_number LIKE '84%';

-- 孟加拉 (880开头)
UPDATE sms_records 
SET country = 'Bangladesh' 
WHERE country = 'TEST' 
  AND phone_number LIKE '880%';

-- ... 其他国家
```

**执行结果**：
```
country     count
Brazil      4
Vietnam     3
Bangladesh  1
```

## 技术要点

### 1. 国家码匹配算法

**为什么要按长度排序？**

```javascript
// ❌ 错误：不排序可能导致错误匹配
const codes = ['1', '880', '55'];
'8801234567'.startsWith('1')  // true (错误！应该匹配'880')

// ✅ 正确：按长度降序排序
const sortedCodes = ['880', '55', '1'];
'8801234567'.startsWith('880')  // true (正确！)
```

### 2. 客户名称优先级

```
1. customer_name（优先）
   ↓
2. login_account === 'admin'（管理员）
   ↓
3. '未知客户'（兜底）
```

### 3. SQL LIKE 模糊匹配

```sql
-- 匹配以55开头的手机号
WHERE phone_number LIKE '55%'

-- % 是通配符，匹配任意字符
-- '55%' 表示以55开头
```

## 测试验证

### 1. 刷新统计页面

**步骤**：
1. 浏览器访问：系统管理 → 短信管理 → 数据统计
2. 刷新页面（F5）

**预期结果**：

**按国家统计**：
```
国家        发送总量  成功数量  失败数量  成功率    总费用
Brazil      4         4         0         100%      $0.00
Vietnam     3         3         0         100%      $0.00
Bangladesh  1         1         0         100%      $0.00
```

**按客户统计**：
```
排名  客户名称   发送总量  成功数量  成功率  总费用
1     admin      8         8         100%    $0.00
```

**按通道统计**：
```
通道名称    国家        发送总量  成功数量  失败数量  成功率  总费用
一正卡发    Vietnam     3         3         0         100%    $0.00
巴西TS      Brazil      4         4         0         100%    $0.00
巴西TS      Bangladesh  1         1         0         100%    $0.00
```

### 2. 测试新发送

**步骤**：
1. 进入通道管理
2. 选择任意通道，点击【测试】
3. 输入不同国家的手机号：
   - 巴西：`5531983059116`
   - 越南：`84977109485`
   - 孟加拉：`8801626535940`
4. 发送测试短信
5. 返回统计页面查看

**预期结果**：
- ✅ 国家自动识别为 Brazil、Vietnam、Bangladesh
- ✅ 客户名称显示为 "admin"
- ✅ 统计数据按真实国家分组

### 3. 验证国家识别函数

**测试代码**（在浏览器控制台或Node.js环境）：

```javascript
// 测试函数
function getCountryFromPhone(phoneNumber) {
  const cleanPhone = phoneNumber.replace(/\D/g, '');
  const countryCodeMap = {
    '55': 'Brazil',
    '84': 'Vietnam',
    '880': 'Bangladesh'
  };
  const sortedCodes = Object.keys(countryCodeMap).sort((a, b) => b.length - a.length);
  for (const code of sortedCodes) {
    if (cleanPhone.startsWith(code)) {
      return countryCodeMap[code];
    }
  }
  return 'Unknown';
}

// 测试用例
console.log(getCountryFromPhone('5531983059116'));   // "Brazil"
console.log(getCountryFromPhone('84977109485'));     // "Vietnam"
console.log(getCountryFromPhone('8801626535940'));   // "Bangladesh"
console.log(getCountryFromPhone('12345678901'));     // "Unknown"
```

## 常见问题

### Q1: 为什么不用正则表达式？

**答**：
- 当前需求简单，`startsWith()` 更直观
- 性能更好（不需要编译正则）
- 易于维护和扩展

如果需要更复杂的匹配规则，可以改用正则：
```javascript
const patterns = {
  /^55\d{11,}$/: 'Brazil',
  /^84\d{9,}$/: 'Vietnam'
};
```

### Q2: 如何添加新国家？

**答**：在 `countryCodeMap` 中添加新映射：

```javascript
const countryCodeMap = {
  // ... 现有国家
  '44': 'UK',           // 英国
  '61': 'Australia',    // 澳大利亚
  '81': 'Japan'         // 日本
};
```

### Q3: 为什么客户名称不直接用 login_account？

**答**：
- `customer_name` 是面向用户的显示名称
- `login_account` 是登录账号（可能是邮箱、手机号等）
- 管理员特殊处理：没有 `customer_name`，用 `login_account` 判断

### Q4: 历史数据更新后能回滚吗？

**答**：
建议更新前备份：
```sql
-- 备份
CREATE TABLE sms_records_backup AS SELECT * FROM sms_records;

-- 回滚
UPDATE sms_records r
JOIN sms_records_backup b ON r.id = b.id
SET r.country = b.country;
```

### Q5: Unknown 国家怎么处理？

**答**：
有两种策略：
1. **保留 Unknown**：提醒用户添加国家码映射
2. **改为手动输入**：在测试发送时增加国家选择框

当前采用方案1，便于发现未支持的国家。

## 扩展优化

### 1. 国家码数据库化（推荐）

将国家码映射存储到数据库：

```sql
CREATE TABLE country_codes (
  id INT PRIMARY KEY AUTO_INCREMENT,
  country_code VARCHAR(10) NOT NULL,
  country_name VARCHAR(50) NOT NULL,
  country_name_cn VARCHAR(50),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO country_codes (country_code, country_name, country_name_cn) VALUES
('55', 'Brazil', '巴西'),
('84', 'Vietnam', '越南'),
('880', 'Bangladesh', '孟加拉');
```

**优势**：
- 支持动态添加/修改
- 支持多语言显示
- 无需修改代码

### 2. 使用第三方库（可选）

使用 `libphonenumber-js` 库进行更准确的识别：

```javascript
const { parsePhoneNumberFromString } = require('libphonenumber-js');

function getCountryFromPhone(phoneNumber) {
  const phoneNumberObj = parsePhoneNumberFromString(phoneNumber);
  if (phoneNumberObj && phoneNumberObj.country) {
    return phoneNumberObj.country;  // 返回ISO国家码 (如 'BR', 'VN')
  }
  return 'Unknown';
}
```

### 3. 缓存优化（性能优化）

对于高频查询，可以缓存国家码映射：

```javascript
let countryCodeCache = null;

async function getCountryCodeMap() {
  if (countryCodeCache) return countryCodeCache;
  
  // 从数据库加载
  const codes = await CountryCode.findAll();
  countryCodeCache = codes.reduce((map, code) => {
    map[code.country_code] = code.country_name;
    return map;
  }, {});
  
  return countryCodeCache;
}
```

## 项目规范遵守

根据项目规范记忆：

> **管理员测试记录客户名称显示**：管理员测试发送的短信记录，其客户名称必须显示为'admin'。

本次修复已严格遵守此规范，通过以下方式实现：

```javascript
// 判断逻辑
if (item.customer && item.customer.login_account === 'admin') {
  customerName = 'admin';  // ✅ 符合规范
}
```

## 修复时间
2025-10-22

## 修复人员
Qoder AI

## 相关文件

### 修改的文件
1. `/home/vue-element-admin/backend/routes/smsAdmin.js`
   - 添加 `getCountryFromPhone()` 函数
   - 修改客户统计查询，增加 `login_account` 字段
   - 修改客户名称显示逻辑，处理管理员特殊情况
   - 修改测试发送，使用国家识别函数

### 新增的文件
1. `/home/vue-element-admin/更新测试记录国家.sql` - 历史数据修复SQL脚本

## 总结

**核心问题**：
1. 测试发送时国家硬编码为 "TEST"
2. 管理员用户没有 customer_name 导致显示为"未知客户"

**解决方案**：
1. 实现手机号国家自动识别
2. 增强客户名称显示逻辑，遵守项目规范

**修复效果**：
- ✅ 统计页面国家显示真实国家名称
- ✅ 管理员测试记录客户名称显示为 "admin"
- ✅ 历史数据已更新
- ✅ 未来测试发送自动识别国家

**技术亮点**：
- 国家码按长度优先匹配算法
- 客户名称三级降级显示策略
- SQL批量更新历史数据
- 符合项目规范要求
