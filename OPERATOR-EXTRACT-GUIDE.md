# 按运营商提取功能使用指南

## 功能概述

"按运营商提取"功能支持**选择多个运营商，并为每个运营商设置独立的提取条数**，系统会为每个选中的运营商生成独立的数据文件，并自动下载。

## 使用步骤

### 1. 打开按运营商提取对话框

- 点击"数据提取"模块中的"按运营商提取"卡片
- 对话框打开

### 2. 选择处理文件

- 在"处理文件"下拉框中选择要处理的数据文件
- 显示文件名和行数，方便选择

### 3. 选择国家

- 在"国家"下拉框中选择目标国家
- 例如：巴西 (+55)、美国 (+1)等
- 系统会自动分析该文件中的运营商分布

### 4. 等待运营商分析

- 系统自动分析文件中的运营商分布
- 显示"正在分析文件中的运营商分布..."
- 分析完成后显示结果通知

### 5. 选择运营商（支持多选）

**核心功能：可以选择多个运营商进行合并提取**

示例（巴西数据）：
- ☑ Vivo (数量: 9,840, 占比: 24.6%)
- ☑ Claro (数量: 11,160, 占比: 27.9%)
- ☑ TIM Brasil (数量: 9,840, 占比: 24.6%)
- ☐ Oi (数量: 9,200, 占比: 23.0%)

**说明：** 可以选择任意数量的运营商（1个或多个）

### 6. 设置每个运营商的提取条数

选择运营商后，会显示"提取条数设置"区域，**每个运营商都有独立的设置**：

#### 示例配置：

**Vivo**
- ◉ 限制条数 / ○ 全部提取
- 提取条数：`5000`（可调整）

**Claro**
- ○ 限制条数 / ◉ 全部提取
- （提取该运营商的所有数据）

**TIM Brasil**
- ◉ 限制条数 / ○ 全部提取
- 提取条数：`8000`（可调整）

#### 设置说明：

| 选项 | 说明 | 效果 |
|------|------|------|
| **限制条数（开启）** | 只提取指定数量的数据 | 提取前N条匹配的数据 |
| **全部提取（关闭）** | 提取该运营商的全部数据 | 不限制条数 |

### 7. 开始提取

- 点击"开始提取"按钮
- 系统为每个选中的运营商生成独立文件
- 显示进度提示

### 8. 查看结果并自动下载

#### 结果示例：

```
提取完成！

总数据: 40,000 条
提取总数: 24,160 条
运营商数: 3 个

● Vivo: 5,000 条 (限制5000条, 已达上限)
● Claro: 11,160 条
● TIM Brasil: 8,000 条 (限制8000条)
```

#### 自动下载：

系统会自动下载以下文件：
- `operator_Vivo_1710796842199_abc123.txt` (5,000条)
- `operator_Claro_1710796842299_def456.txt` (11,160条)
- `operator_TIM_Brasil_1710796842399_ghi789.txt` (8,000条)

## 功能亮点

### ✅ 多运营商批量提取

- 一次操作可提取多个运营商的数据
- 无需多次重复操作
- 大幅提升效率

### ✅ 独立条数控制

- 每个运营商都有独立的条数设置
- 灵活控制每个运营商的提取数量
- 满足不同运营商的数据需求

### ✅ 自动文件管理

- 为每个运营商生成独立的文件
- 文件名包含运营商名称，便于识别
- 自动下载，无需手动操作

### ✅ 智能提取

- 基于Google libphonenumber库进行号码分析
- 准确识别运营商归属
- 支持全球120+国家

## 典型使用场景

### 场景1：精准营销数据分发

**需求：** 需要给巴西的3个运营商（Vivo、Claro、TIM）分别发送不同数量的营销数据

**操作：**
1. 选择巴西 (+55)
2. 选择3个运营商
3. 设置条数：
   - Vivo: 10,000条
   - Claro: 8,000条
   - TIM Brasil: 12,000条
4. 一键提取，自动下载3个文件

### 场景2：运营商数据测试

**需求：** 测试不同运营商的号码质量，需要每个运营商少量样本

**操作：**
1. 选择目标国家
2. 选择所有检测到的运营商
3. 每个运营商设置提取1000条
4. 快速获取所有运营商的测试样本

### 场景3：客户定制数据包

**需求：** 客户要求提供指定运营商的全部数据

**操作：**
1. 选择国家
2. 仅选择客户指定的运营商
3. 设置为"全部提取"
4. 生成完整的运营商数据包

## 重要提示

### ⚠️ 共享号段国家

某些国家的运营商共享号段池，系统会采用模拟分配方案：

**共享号段国家列表：**
- 🇺🇸 美国 (US)
- 🇧🇷 巴西 (BR) - 基于地域模拟分配
- 🇸🇬 新加坡 (SG)
- 🇯🇵 日本 (JP)
- 🇫🇷 法国 (FR)
- 🇪🇸 西班牙 (ES)
- 🇳🇱 荷兰 (NL)
- 🇦🇺 澳大利亚 (AU)

**说明：**
- 这些国家的运营商无法通过号码前缀精确区分
- 系统采用模拟分配方案（基于区号或地域）
- 提取结果用于数据分组展示，不代表真实运营商归属
- 建议使用"按条数提取"功能作为替代方案

### 💡 最佳实践

1. **合理设置条数**
   - 根据实际业务需求设置提取条数
   - 避免提取过多不需要的数据
   - 使用"全部提取"时注意数据量

2. **验证国家选择**
   - 确保选择的国家与文件数据匹配
   - 可先使用"文件预览"功能查看国家分布

3. **检查分析结果**
   - 注意查看未匹配数据的占比
   - 如果未匹配比例过高，检查号码格式

4. **文件命名识别**
   - 下载的文件名包含运营商名称和时间戳
   - 便于后续整理和使用

## 技术说明

### 后端API

**接口：** `POST /api/data-processing/extract-by-operator`

**请求参数：**
```json
{
  "fileId": 123,
  "operators": [
    {
      "name": "Vivo",
      "numberSegments": ["119", "129", ...],
      "countryCode": "55",
      "limit": 5000  // null表示全部提取
    },
    {
      "name": "Claro",
      "numberSegments": ["349", "359", ...],
      "countryCode": "55",
      "limit": null  // 提取全部
    }
  ]
}
```

**响应结果：**
```json
{
  "success": true,
  "message": "运营商数据提取完成",
  "data": {
    "totalMatched": 24160,
    "totalProcessed": 40000,
    "operatorCount": 3,
    "results": [
      {
        "operatorName": "Vivo",
        "matchedCount": 5000,
        "limit": 5000,
        "limitReached": true,
        "downloadPath": "/api/data-processing/download/operator_Vivo_xxx.txt"
      }
    ]
  }
}
```

### 数据处理流程

```
1. 接收请求 → 验证参数
2. 读取源文件 → 加载数据
3. 遍历运营商 → 逐个处理
   ├─ 去除国码（如果有）
   ├─ 匹配号段前缀
   ├─ 应用条数限制（如果设置）
   └─ 生成输出文件
4. 返回结果 → 前端自动下载
```

## 更新日志

### v1.0 (2025-10-18)

**功能：**
- ✅ 支持多运营商选择
- ✅ 每个运营商独立条数控制
- ✅ 合并提取，自动下载
- ✅ 实时显示提取进度
- ✅ 详细的结果统计

**优化：**
- 🔧 巴西运营商号段配置优化
- 🔧 共享号段国家特殊处理
- 🔧 提取结果详细展示

## 相关文档

- [巴西运营商优化说明](./BRAZIL-OPERATOR-FIX.md)
- [运营商数据配置](./src/data/operators.js)
- [数据处理工具](./backend/utils/dataProcessor.js)

## 技术支持

如有问题，请联系技术支持团队。
