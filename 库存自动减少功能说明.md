# 库存自动减少功能说明

## 需求描述

**用户反馈**：在资源中心购买数据后，应该按实际购买后的数量进行库存减少。

**举例**：KL01880V01购买了印度10000条Jio数据，那么在资源中心应该显示剩余90000条数据。

## 问题分析

### 修复前的问题

1. **购买流程不完整**
   - ✅ 扣除用户余额
   - ✅ 创建购买订单
   - ✅ 生成扣款记录
   - ❌ **未减少资源中心数据的可用数量**

2. **数据不同步**
   - 购买后资源中心仍显示原始数量
   - 用户可以重复购买超过库存的数据
   - 无法准确反映实际可用库存

## 修复方案

### 1. 添加库存减少方法

在购买页面 ([`purchase.vue`](/home/vue-element-admin/src/views/resource/purchase.vue)) 添加 `reduceDataQuantity()` 方法：

```javascript
// 减少资源中心数据的可用数量
reduceDataQuantity() {
  console.log('📉 开始减少资源中心数据可用数量...')
  
  const savedDataList = localStorage.getItem('dataList')
  if (!savedDataList) {
    console.warn('⚠️ 未找到dataList，无法减少数量')
    return
  }

  try {
    const dataList = JSON.parse(savedDataList)
    const dataIndex = dataList.findIndex(item => String(item.id) === String(this.dataInfo.id))

    if (dataIndex === -1) {
      console.error('❌ 未找到ID为', this.dataInfo.id, '的数据')
      throw new Error('数据不存在，无法更新库存')
    }

    const currentData = dataList[dataIndex]
    const purchaseQuantity = this.purchaseForm.quantity

    // 检查库存是否充足
    if (currentData.availableQuantity < purchaseQuantity) {
      throw new Error('库存不足，无法完成购买')
    }

    // 减少总可用数量
    const originalQuantity = currentData.availableQuantity
    currentData.availableQuantity -= purchaseQuantity

    console.log('✅ 总数量: ' + originalQuantity.toLocaleString() + ' → ' + currentData.availableQuantity.toLocaleString())

    // 减少各运营商的数量
    if (currentData.operators && currentData.operators.length > 0) {
      console.log('📱 开始减少运营商数据量...')
      
      this.selectedOperators.forEach(selectedOp => {
        const operator = currentData.operators.find(op => op.name === selectedOp.name)
        if (operator) {
          const originalOpCount = operator.count
          operator.count -= selectedOp.allocated
          
          // 确保不会出现负数
          if (operator.count < 0) {
            operator.count = 0
          }
          
          console.log(`  - ${selectedOp.name}: ${originalOpCount.toLocaleString()} → ${operator.count.toLocaleString()} (减少 ${selectedOp.allocated.toLocaleString()})`)
        }
      })
    }

    // 如果数量为0，标记为售罄
    if (currentData.availableQuantity <= 0) {
      currentData.status = 'sold_out'
      console.log('🔴 数据已售罄，标记为 sold_out')
    }

    // 更新localStorage
    dataList[dataIndex] = currentData
    localStorage.setItem('dataList', JSON.stringify(dataList))

    console.log('✅ 资源中心数据已更新')
    
  } catch (error) {
    console.error('❌ 减少数据数量失败:', error)
    throw error
  }
}
```

### 2. 在购买流程中调用

修改 `submitPurchase()` 方法，在购买成功后调用库存减少：

```javascript
try {
  // 1. 扣除用户账户余额
  this.deductUserBalance()

  // 2. 生成购买订单
  this.createPurchaseOrder()

  // 3. 生成扣款记录
  this.createDeductRecord()

  // 4. 减少资源中心数据的可用数量 ✅ 新增
  this.reduceDataQuantity()

  setTimeout(() => {
    this.$message.success(this.$t('resource.purchaseSuccess'))
    this.purchaseLoading = false
    this.$router.push('/order/list')
  }, 1500)
} catch (error) {
  this.$message.error('购买失败：' + error.message)
  this.purchaseLoading = false
}
```

### 3. 资源中心自动刷新

修改资源中心 ([`center.vue`](/home/vue-element-admin/src/views/resource/center.vue)) 的 `activated()` 钩子：

```javascript
activated() {
  // 当组件被激活时（从其他页面返回），重新加载账户统计信息和数据列表
  console.log('🔄 资源中心页面被激活，重新加载数据...')
  this.loadAccountStats()
  this.getList() // ✅ 重新加载数据列表，确保显示最新的可用数量
}
```

### 4. 过滤已售罄数据

修改 `applyFilters()` 方法，过滤掉已售罄的数据：

```javascript
applyFilters(dataList) {
  let filteredList = [...dataList]

  // ✅ 过滤掉已售罄的数据
  filteredList = filteredList.filter(item => {
    return item.availableQuantity > 0 && item.status !== 'sold_out'
  })

  // 国家筛选
  if (this.listQuery.country) {
    filteredList = filteredList.filter(item => {
      return item.countryCode === this.listQuery.country ||
             item.country.includes(this.listQuery.country)
    })
  }

  // ... 其他筛选条件

  return filteredList
}
```

## 功能特点

### 1. 总库存减少

- ✅ 购买后自动减少 `availableQuantity`
- ✅ 实时更新 localStorage
- ✅ 立即反映到资源中心

### 2. 运营商库存减少

- ✅ 按照用户选择的运营商分配减少
- ✅ 每个运营商的 `count` 精确减少
- ✅ 支持多运营商购买

**示例**：
```
购买前:
- Jio: 40000 条
- Airtel: 35000 条
- Vi: 25000 条

购买 10000 条，选择 Jio:
- Jio: 30000 条 (减少 10000)
- Airtel: 35000 条 (不变)
- Vi: 25000 条 (不变)
```

### 3. 售罄处理

- ✅ 库存为 0 时自动标记为 `sold_out`
- ✅ 资源中心自动过滤已售罄数据
- ✅ 防止继续购买

### 4. 安全检查

- ✅ 购买前检查库存是否充足
- ✅ 防止负数库存
- ✅ 错误处理和回滚

## 数据流向

```
用户点击购买
    ↓
填写购买表单
    ↓
确认购买
    ↓
1. 扣除账户余额 (userList)
2. 创建购买订单 (orderList)
3. 生成扣款记录 (rechargeRecords)
4. 减少资源库存 (dataList) ✅ 新增
    ↓
更新 localStorage
    ↓
跳转到订单列表
    ↓
用户返回资源中心
    ↓
activated() 触发
    ↓
重新加载数据列表
    ↓
显示更新后的库存
```

## 验证方法

### 方法一：使用测试工具（推荐）

我们创建了专门的测试工具来验证库存减少功能：

**文件位置**：`/home/vue-element-admin/inventory-reduction-test.html`

**访问地址**：
```
http://localhost:9528/inventory-reduction-test.html
```

**测试步骤**：

1. **创建测试数据**
   - 点击 "📦 创建测试数据" 按钮
   - 系统会创建印度和孟加拉国的测试数据
   - 每条数据都有明确的运营商分布

2. **模拟购买**
   - 点击 "🛒 模拟购买" 按钮
   - 选择要购买的数据
   - 输入购买数量（如 10000）
   - 选择运营商（如 Jio）
   - 点击 "确认购买"

3. **查看对比**
   - 系统自动显示购买前后的库存对比
   - 总数量变化
   - 各运营商数量变化
   - 状态变化

4. **检查库存**
   - 点击 "✔️ 检查库存" 按钮
   - 查看当前所有数据的库存状态
   - 验证库存是否正确减少

**测试工具功能**：
- ✅ 创建真实的测试数据
- ✅ 模拟完整的购买流程
- ✅ 实时显示库存变化
- ✅ 购买前后对比展示
- ✅ 自动过滤已售罄数据
- ✅ 详细的日志输出

### 方法二：实际操作测试

1. **准备测试数据**
   - 访问数据上传页面
   - 上传包含运营商信息的数据
   - 记录初始数量（如印度 Jio 100000 条）

2. **访问资源中心**
   ```
   http://localhost:9528/#/resource/center
   ```
   - 找到刚上传的数据
   - 确认显示的数量正确

3. **执行购买**
   - 点击"购买"按钮
   - 选择运营商（如 Jio）
   - 输入购买数量（如 10000）
   - 确认购买

4. **返回资源中心**
   - 使用浏览器后退或点击导航
   - 观察数据列表

5. **验证结果**
   - ✅ 总可用数量应该减少 10000
   - ✅ Jio 运营商数量应该减少 10000
   - ✅ 其他运营商数量不变
   - ✅ 如果购买完所有数据，该条目应该消失

### 方法三：浏览器开发者工具验证

1. **打开开发者工具**（F12）

2. **查看 Console 日志**
   - 购买时应该看到：
     ```
     📉 开始减少资源中心数据可用数量...
     📊 当前数据信息: {...}
     ✅ 总数量: 100,000 → 90,000
     📱 开始减少运营商数据量...
       - Jio: 40,000 → 30,000 (减少 10,000)
     ✅ 资源中心数据已更新
     ```

3. **查看 localStorage**
   - Application → Local Storage
   - 查看 `dataList`
   - 验证数量已更新

## 完整示例

### 场景：用户 KL01880V01 购买印度 Jio 数据

**初始状态**：
```json
{
  "id": 12345,
  "country": "印度",
  "countryCode": "IN",
  "dataType": "手机号码",
  "availableQuantity": 100000,
  "operators": [
    { "name": "Jio", "count": 40000 },
    { "name": "Airtel", "count": 35000 },
    { "name": "Vi", "count": 25000 }
  ],
  "status": "available"
}
```

**购买操作**：
- 购买数量：10000 条
- 选择运营商：Jio

**购买后状态**：
```json
{
  "id": 12345,
  "country": "印度",
  "countryCode": "IN",
  "dataType": "手机号码",
  "availableQuantity": 90000,  // ✅ 减少 10000
  "operators": [
    { "name": "Jio", "count": 30000 },     // ✅ 减少 10000
    { "name": "Airtel", "count": 35000 },  // 不变
    { "name": "Vi", "count": 25000 }       // 不变
  ],
  "status": "available"
}
```

**资源中心显示**：
- 印度手机号码数据：**90,000 条可用** ✅
- 运营商分布：
  - Jio: 30,000 条
  - Airtel: 35,000 条
  - Vi: 25,000 条

## 边界情况处理

### 1. 库存不足

```javascript
if (currentData.availableQuantity < purchaseQuantity) {
  throw new Error('库存不足，无法完成购买')
}
```

**结果**：购买失败，显示错误提示

### 2. 库存归零

```javascript
if (currentData.availableQuantity <= 0) {
  currentData.status = 'sold_out'
}
```

**结果**：
- 数据标记为 `sold_out`
- 资源中心自动过滤，不再显示
- 无法继续购买

### 3. 运营商数量保护

```javascript
operator.count -= selectedOp.allocated

if (operator.count < 0) {
  operator.count = 0
}
```

**结果**：确保运营商数量不会出现负数

### 4. 数据不存在

```javascript
if (dataIndex === -1) {
  throw new Error('数据不存在，无法更新库存')
}
```

**结果**：购买失败，提示数据不存在

## 注意事项

1. **购买前必须检查库存**
   - 防止超卖
   - 提供友好的错误提示

2. **运营商分配必须准确**
   - 按照用户选择的运营商减少
   - 总减少量 = 各运营商减少量之和

3. **localStorage 同步更新**
   - 购买后立即更新
   - 确保数据一致性

4. **页面自动刷新**
   - 返回资源中心时自动加载最新数据
   - 使用 `activated()` 钩子

5. **错误处理**
   - 任何失败都应该回滚
   - 显示明确的错误信息

## 相关文件

- `/home/vue-element-admin/src/views/resource/purchase.vue` - 购买页面（已添加库存减少）
- `/home/vue-element-admin/src/views/resource/center.vue` - 资源中心（已添加自动刷新）
- `/home/vue-element-admin/inventory-reduction-test.html` - 库存减少测试工具

## 后续优化建议

1. **并发控制**
   - 处理多用户同时购买同一数据的情况
   - 添加乐观锁或悲观锁机制

2. **购买历史**
   - 记录每次库存变化
   - 便于追踪和审计

3. **库存预警**
   - 库存低于阈值时提醒
   - 自动补货机制

4. **数据归档**
   - 已售罄的数据移到归档区
   - 保留历史记录

## 故障排查

如果库存没有减少，请检查：

1. **浏览器控制台日志**
   - 是否有错误信息
   - `reduceDataQuantity()` 是否被调用
   - 数量计算是否正确

2. **localStorage 数据**
   - 数据是否存在
   - ID 是否匹配
   - 数据格式是否正确

3. **购买流程**
   - 是否完整执行所有步骤
   - 是否有异常中断

4. **页面刷新**
   - 返回资源中心是否触发 `activated()`
   - 数据列表是否重新加载
