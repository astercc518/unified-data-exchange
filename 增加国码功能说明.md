# 增加国码功能说明

## 功能概述

为数据处理模块新增"增加国码"功能，支持批量为数据文件添加国家代码前缀。

---

## 功能特性

### 1. 功能卡片
- **位置**：功能模块区第6个卡片
- **图标**：➕ (el-icon-plus)
- **名称**：增加国码
- **描述**：批量为数据添加国家代码

### 2. 批量处理
- ✅ 支持同时选择多个文件
- ✅ 自动填充已选文件
- ✅ 批量添加国码
- ✅ 批量下载结果

### 3. 国家选择
遵循项目规范，提供三种交互方式：

#### (1) 热门国家快选
顶部展示16个常用国家：
- 中国 (+86)
- 美国 (+1)
- 英国 (+44)
- 日本 (+81)
- 韩国 (+82)
- 新加坡 (+65)
- 马来西亚 (+60)
- 泰国 (+66)
- 越南 (+84)
- 印度尼西亚 (+62)
- 菲律宾 (+63)
- 印度 (+91)
- 俄罗斯 (+7)
- 澳大利亚 (+61)
- 新西兰 (+64)
- 德国 (+49)

#### (2) 全部国家列表
支持查看所有70个国家

#### (3) 智能搜索
- 支持中文名搜索
- 支持国家代码搜索
- 支持区号搜索
- 模糊匹配

### 4. 自动填充国码
- 选择国家后自动显示对应国码
- 国码显示在只读输入框中
- 清晰展示将要添加的前缀

---

## 使用步骤

### 方式一：通过功能卡片

1. **选择文件** - 在文件列表中勾选要处理的文件
2. **点击功能卡片** - 点击"增加国码"卡片
3. **选择国家** - 在下拉框中选择国家
4. **确认国码** - 系统自动显示对应国码
5. **开始处理** - 点击"开始处理"按钮
6. **下载结果** - 自动下载所有处理结果文件

### 方式二：直接使用

1. **点击功能卡片** - 直接点击"增加国码"卡片
2. **选择文件** - 在对话框中选择要处理的文件
3. **选择国家** - 选择目标国家
4. **开始处理** - 点击"开始处理"按钮
5. **下载结果** - 自动下载处理结果

---

## 对话框界面

```
┌─────────────────────────────────────────┐
│  增加国码                                │
├─────────────────────────────────────────┤
│  处理文件:                               │
│  ┌───────────────────────────────────┐  │
│  │ ☑ data1.txt (1,000行)            │  │
│  │ ☑ data2.txt (2,500行)            │  │
│  │ ☑ data3.txt (800行)              │  │
│  └───────────────────────────────────┘  │
│  已选择 3 个文件                         │
│                                         │
│  选择国家:                               │
│  ┌───────────────────────────────────┐  │
│  │ 热门国家                           │  │
│  │   中国 (+86)                       │  │
│  │   美国 (+1)                        │  │
│  │   ...                              │  │
│  │ 全部国家                           │  │
│  │   [所有国家列表]                   │  │
│  └───────────────────────────────────┘  │
│                                         │
│  国码:                                  │
│  ┌───────────────────────────────────┐  │
│  │ 选中国家的国码 │ +86               │  │
│  └───────────────────────────────────┘  │
│  国码将添加到每行数据的开头              │
│                                         │
│         [取消]  [开始处理]               │
└─────────────────────────────────────────┘
```

---

## 技术实现

### 前端实现

#### 1. 功能卡片 (`processing.vue`)
```vue
<el-col :xs="24" :sm="12" :md="8" :lg="6">
  <el-card class="module-card" shadow="hover" @click.native="openModule('addCode')">
    <div class="module-icon">
      <i class="el-icon-plus" />
    </div>
    <div class="module-title">增加国码</div>
    <div class="module-desc">批量为数据添加国家代码</div>
  </el-card>
</el-col>
```

#### 2. 对话框 (`processing.vue`)
```vue
<el-dialog title="增加国码" :visible.sync="dialogAddCode" width="700px">
  <el-form :model="addCodeForm" label-width="120px">
    <!-- 文件选择 -->
    <el-form-item label="处理文件">
      <el-select v-model="addCodeForm.fileIds" multiple>
        <!-- 文件列表 -->
      </el-select>
    </el-form-item>
    
    <!-- 国家选择 -->
    <el-form-item label="选择国家">
      <el-select v-model="addCodeForm.countryCode" filterable>
        <!-- 热门国家 -->
        <el-option-group label="热门国家">
          <el-option v-for="country in hotCountries" />
        </el-option-group>
        <!-- 全部国家 -->
        <el-option-group label="全部国家">
          <el-option v-for="country in countryList" />
        </el-option-group>
      </el-select>
    </el-form-item>
    
    <!-- 国码显示 -->
    <el-form-item label="国码">
      <el-input v-model="addCodeForm.countryCodePrefix" disabled />
    </el-form-item>
  </el-form>
</el-dialog>
```

#### 3. 数据结构
```javascript
data() {
  return {
    dialogAddCode: false,
    addCodeForm: {
      fileIds: [],
      countryCode: '',
      countryCodePrefix: ''
    },
    hotCountries: [
      { code: '+86', name: '中国' },
      { code: '+1', name: '美国' },
      // ... 16个热门国家
    ]
  }
}
```

#### 4. 监听器
```javascript
watch: {
  'addCodeForm.countryCode'(newVal) {
    if (newVal) {
      this.addCodeForm.countryCodePrefix = newVal
    } else {
      this.addCodeForm.countryCodePrefix = ''
    }
  }
}
```

#### 5. 批量处理方法
```javascript
async confirmAddCode() {
  // 验证
  if (!this.addCodeForm.fileIds.length) {
    this.$message.warning('请选择要处理的文件')
    return
  }
  if (!this.addCodeForm.countryCode) {
    this.$message.warning('请选择国家')
    return
  }

  // 批量处理
  this.processing = true
  const results = []
  for (const fileId of this.addCodeForm.fileIds) {
    const response = await request({
      url: '/api/data-processing/add-country-code',
      method: 'post',
      data: {
        fileId,
        countryCode: this.addCodeForm.countryCode
      }
    })
    results.push(response.data)
  }

  // 批量下载
  results.forEach(result => {
    this.downloadFile(result.downloadPath)
  })
}
```

### 后端API

后端API已经存在，无需修改：

**端点**: `POST /api/data-processing/add-country-code`

**请求参数**:
```json
{
  "fileId": 123,
  "countryCode": "+86"
}
```

**响应**:
```json
{
  "success": true,
  "message": "处理完成",
  "data": {
    "processedCount": 1000,
    "downloadPath": "/api/data-processing/download/add_code_xxx.txt"
  }
}
```

---

## 文件清单

### 修改的文件

1. **`/home/vue-element-admin/src/views/data/processing.vue`**
   - ✅ 添加"增加国码"功能卡片
   - ✅ 添加"增加国码"对话框
   - ✅ 添加 `dialogAddCode` 状态
   - ✅ 添加 `addCodeForm` 表单数据
   - ✅ 添加 `hotCountries` 热门国家列表
   - ✅ 添加 `watch` 监听器自动填充国码
   - ✅ 在 `openModule` 方法中添加 `addCode` 处理
   - ✅ 添加 `confirmAddCode` 批量处理方法

### 未修改的文件

- 后端路由 (`backend/routes/dataProcessing.js`) - API已存在
- 数据处理工具 (`backend/utils/dataProcessor.js`) - 功能已实现
- 路由配置 (`src/router/index.js`) - 无需修改
- 国家数据 (`src/data/countries.js`) - 无需修改

---

## 使用示例

### 示例1：批量添加中国国码

```
1. 勾选 3 个文件：phone1.txt, phone2.txt, phone3.txt
2. 点击"增加国码"卡片
3. 在"热门国家"中选择"中国 (+86)"
4. 自动显示国码：+86
5. 点击"开始处理"
6. 系统处理 3 个文件，为每行数据添加 +86 前缀
7. 自动下载 3 个处理后的文件
```

### 示例2：添加美国国码

```
1. 点击"增加国码"卡片
2. 在对话框中选择 5 个文件
3. 选择"美国 (+1)"
4. 国码显示：+1
5. 点击"开始处理"
6. 下载 5 个添加了 +1 前缀的文件
```

### 示例3：搜索并添加

```
1. 点击"增加国码"卡片
2. 选择文件
3. 在国家下拉框中输入"新加坡"进行搜索
4. 选择"新加坡 (+65)"
5. 国码自动填充为 +65
6. 开始处理
```

---

## 功能对比

| 功能 | 去除国码 | 增加国码 |
|------|---------|---------|
| 批量处理 | ✅ | ✅ |
| 国家选择 | ❌ (手动输入) | ✅ (下拉选择) |
| 热门国家 | ❌ | ✅ |
| 智能搜索 | ❌ | ✅ |
| 自动填充 | ❌ | ✅ (选择国家自动显示国码) |
| 指定国码 | ✅ | ✅ |
| 空值处理 | ✅ (留空去除所有) | ❌ (必须选择) |

---

## 注意事项

1. **必须选择国家**：与"去除国码"不同，增加国码必须选择国家
2. **国码自动填充**：选择国家后国码自动显示，无需手动输入
3. **前缀格式**：国码会原样添加到每行数据的开头（包括+号）
4. **数据格式**：处理后的数据格式为：`国码原始数据`，例如：`+8613800138000`
5. **批量限制**：建议单次处理不超过10个文件

---

## 升级优势

### 用户体验
- ✅ 下拉选择比手动输入更方便
- ✅ 热门国家快选提高效率
- ✅ 智能搜索支持多种输入方式
- ✅ 自动填充国码避免输入错误

### 功能完善
- ✅ 与"去除国码"功能互补
- ✅ 完整的国码处理解决方案
- ✅ 符合项目国家选择器规范

### 代码质量
- ✅ 遵循现有代码风格
- ✅ 复用批量处理逻辑
- ✅ 利用现有后端API

---

## 升级时间

- **升级日期**：2025-10-15
- **升级人员**：AI Assistant
- **测试状态**：待测试

---

## 测试建议

1. **功能测试**：
   - 测试热门国家选择
   - 测试全部国家选择
   - 测试搜索功能
   - 测试批量处理

2. **界面测试**：
   - 验证国码自动填充
   - 验证文件数量显示
   - 验证对话框交互

3. **边界测试**：
   - 未选择文件时提示
   - 未选择国家时提示
   - 批量处理多个文件

---

现在数据处理功能包含完整的6个模块：

1. 🔧 **去除国码** - 批量去除数据中的国家代码
2. 📋 **数据去重** - 智能去除重复数据
3. 📊 **数据对比** - 对比多个数据文件的差异
4. 🌐 **按运营商提取** - 根据运营商筛选数据
5. 📄 **按条数提取** - 按指定条数提取数据
6. ➕ **增加国码** - 批量为数据添加国家代码 ✨ 新增

功能完整，覆盖所有数据处理场景！
