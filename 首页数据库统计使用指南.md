# 首页数据库统计功能使用指南

## 📌 功能说明

首页统计面板现在已经完全集成数据库，所有显示的数据都是从 MariaDB 数据库实时查询获取的。

## 🎯 统计数据说明

### 主要统计指标

#### 1. 📦 总数据量
- **显示内容**: 数据库中的记录总数
- **数据来源**: `data_libraries` 表
- **更新方式**: 实时查询
- **点击跳转**: 数据库列表页面

#### 2. 👥 代理总数
- **显示内容**: 系统中启用状态的代理数量
- **数据来源**: `agents` 表（status = 1）
- **更新方式**: 实时查询
- **点击跳转**: 代理列表页面

#### 3. 👤 客户总数（用户总数）
- **显示内容**: 系统注册用户总数
- **数据来源**: `users` 表
- **更新方式**: 实时查询
- **点击跳转**: 用户列表页面

#### 4. 🟢 服务器状态
- **显示内容**: 后端服务运行状态
- **状态类型**:
  - 🟢 在线: 服务正常运行
  - 🟡 警告: 服务响应缓慢
  - 🔴 离线: 服务不可用
- **检测方式**: 定时请求 /health 接口

### 销售额统计

#### 1. 💰 今日销售额
- **时间范围**: 今天 00:00 至当前时间
- **计算公式**: 已完成订单金额 + 成功充值金额
- **数据来源**: 
  - `orders` 表（status = 'completed'）
  - `recharge_records` 表（status = 'success'）

#### 2. 📊 本周销售额
- **时间范围**: 最近 7 天
- **计算公式**: 同上
- **用途**: 短期销售趋势分析

#### 3. 📈 本月销售额
- **时间范围**: 本月 1 号至当前时间
- **计算公式**: 同上
- **用途**: 月度业绩统计

## 🔄 数据更新机制

### 自动更新
- **触发时机**: 
  - 首次进入首页
  - 切换到首页 tab
  - 页面刷新后
- **更新频率**: 每次访问时自动加载
- **更新时间**: 显示在面板底部

### 手动刷新
1. 点击统计面板下方的"刷新数据"按钮
2. 系统会重新从数据库查询所有统计数据
3. 刷新完成后显示成功提示

## 📊 数据查询流程

```
用户访问首页
    ↓
前端发起 API 请求
    ↓
后端查询数据库
    ↓
计算统计数据
    ↓
返回 JSON 结果
    ↓
前端展示数据（带动画效果）
```

## 🧪 如何测试验证

### 方法 1: 使用测试页面
```bash
# 在浏览器中访问
http://localhost:9528/test-dashboard-stats.html
```

### 方法 2: 检查 API 响应
```bash
# 在命令行执行
curl http://localhost:3000/api/stats/system
```

### 方法 3: 查看浏览器控制台
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 访问首页
4. 查看日志输出：
   ```
   📈 从数据库API加载统计数据...
   ✅ 统计数据加载成功: {...}
   ✅ 首页统计数据更新完成
   ```

## 💡 使用技巧

### 1. 快速查看实时数据
- 每次进入首页都会自动加载最新数据
- 无需手动刷新即可查看实时统计

### 2. 查看详细信息
- 点击统计卡片可跳转到对应的详细页面
- 例如：点击"总数据量"查看数据库列表

### 3. 监控系统状态
- 观察"服务器状态"指示器
- 🟢 在线 = 一切正常
- 🟡 警告 = 可能存在性能问题
- 🔴 离线 = 需要检查后端服务

### 4. 销售数据分析
- 对比今日/本周/本月销售额
- 了解销售趋势
- 制定业务策略

## ⚠️ 注意事项

### 1. 数据准确性
- 所有数据直接从数据库查询，保证准确性
- 如果数据显示为 0，可能是数据库中确实没有数据

### 2. 性能考虑
- 统计查询会占用一定数据库资源
- 避免频繁手动刷新
- 建议间隔至少 10 秒

### 3. 权限要求
- 只有管理员角色能看到完整统计数据
- 代理和客户看到的是各自的专属 Dashboard

### 4. 降级机制
如果数据库连接失败：
- 系统会自动使用 localStorage 中的缓存数据
- 服务器状态会显示为"警告"或"离线"
- 建议检查后端服务是否正常运行

## 🔧 常见问题

### Q1: 统计数据显示为 0？
**A**: 检查以下几点：
1. 数据库中是否有数据
2. 后端服务是否正常运行
3. 查看浏览器控制台是否有错误信息

### Q2: 数据更新不及时？
**A**: 
1. 点击"刷新数据"按钮手动更新
2. 刷新浏览器页面
3. 检查后端服务是否正常

### Q3: 销售额计算不正确？
**A**: 
1. 确认订单状态是否为"已完成"
2. 确认充值状态是否为"成功"
3. 检查时间范围是否正确

### Q4: 服务器状态显示离线？
**A**: 
1. 检查后端服务是否运行
2. 执行命令: `ps aux | grep "node server.js"`
3. 如果未运行，执行: `bash start-system.sh`

## 📱 API 接口说明

### 获取系统统计
```bash
GET /api/stats/system
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "counts": {
      "users": 1,
      "agents": 1,
      "dataLibrary": 4,
      "orders": 0,
      "recharges": 0
    },
    "orderStats": [],
    "amounts": {
      "totalBalance": 0,
      "totalRecharge": 0,
      "totalOrderAmount": 0
    }
  }
}
```

## 🚀 访问地址

- **前端首页**: http://localhost:9528
- **测试页面**: http://localhost:9528/test-dashboard-stats.html
- **统计 API**: http://localhost:3000/api/stats/system
- **健康检查**: http://localhost:3000/health

## 📞 技术支持

如果遇到问题：
1. 查看后端日志: `tail -f /tmp/backend.log`
2. 查看前端日志: 浏览器控制台
3. 检查服务状态: `bash start-system.sh`

---

**版本**: v1.0  
**更新日期**: 2025-10-14  
**状态**: ✅ 已上线
