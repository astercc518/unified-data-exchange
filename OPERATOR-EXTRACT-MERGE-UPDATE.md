# 按运营商提取功能 - 合并文件模式

## 更新说明

**更新日期**: 2025-10-18  
**版本**: v2.0

### 功能变更

将"按运营商提取"功能从**多文件模式**改为**合并文件模式**。

#### 变更前 (v1.0)
```
选择运营商：Vivo、Claro、TIM

结果：生成3个独立文件
- operator_Vivo_xxx.txt (5,000条)
- operator_Claro_xxx.txt (11,160条)
- operator_TIM_Brasil_xxx.txt (8,000条)
```

#### 变更后 (v2.0) ✅
```
选择运营商：Vivo、Claro、TIM

结果：生成1个合并文件
- merged_Vivo_Claro_TIM_Brasil_xxx.txt (24,160条)
  包含所有选中运营商的数据
```

## 核心改进

### 1. 后端逻辑优化

**文件**: `/home/vue-element-admin/backend/routes/dataProcessing.js`

**改进点**:
- ✅ 读取源文件一次，遍历所有数据
- ✅ 为每个运营商匹配数据并收集
- ✅ 将所有运营商的数据合并到一个数组
- ✅ 生成单个合并文件
- ✅ 返回合并文件的下载路径

**处理流程**:
```javascript
1. 读取源文件所有数据
2. 遍历选中的运营商：
   - 匹配该运营商的号段
   - 应用条数限制（如果设置）
   - 收集匹配的数据
   - 添加到合并数组
3. 生成合并文件
4. 返回统计信息 + 下载路径
```

### 2. 前端界面调整

**文件**: `/home/vue-element-admin/src/views/data/processing.vue`

**改进点**:
- ✅ 接收后端返回的 `downloadPath`（单个路径）
- ✅ 显示各运营商提取明细
- ✅ 自动下载一个合并文件
- ✅ 提示"已生成合并文件"

## 使用示例

### 场景：巴西多运营商数据提取

#### 1. 选择文件和国家
```
文件: brazil_40000.txt (40,000条)
国家: 巴西 (+55)
```

#### 2. 选择运营商和条数
```
☑ Vivo        → 限制条数: 5,000
☑ Claro       → 全部提取 (11,160条)
☑ TIM Brasil  → 限制条数: 8,000
```

#### 3. 提取结果
```
━━━━━━━━━━━━━━━━━━━━━━━━━
      提取结果
━━━━━━━━━━━━━━━━━━━━━━━━━

总数据: 40,000 条
提取总数: 24,160 条
运营商数: 3 个

各运营商提取明细：
● Vivo: 5,000 条 (限制5000条, 已达上限)
● Claro: 11,160 条
● TIM Brasil: 8,000 条 (限制8000条)

已生成合并文件，正在下载...
━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 4. 下载文件
```
文件名: merged_Vivo_Claro_TIM_Brasil_1710796842199.txt
大小: 24,160 条数据
内容: 包含3个运营商的数据，按选择顺序排列
```

## 文件命名规则

### 合并文件命名格式
```
merged_{运营商1}_{运营商2}_{运营商3}_{时间戳}.txt
```

### 示例
```
merged_Vivo_Claro_TIM_Brasil_1710796842199.txt
merged_AT&T_Verizon_1710796842299.txt
merged_Vodafone_Orange_1710796842399.txt
```

## 数据顺序

合并文件中的数据按**选择运营商的顺序**排列：

```
例如：选择顺序为 Vivo → Claro → TIM

文件内容：
5561948148249  ← Vivo的数据
5514991567905  ← Vivo的数据
...
（5,000条Vivo数据）
...
5534927348408  ← Claro的数据
5534991567905  ← Claro的数据
...
（11,160条Claro数据）
...
5571923772116  ← TIM的数据
5571990454920  ← TIM的数据
...
（8,000条TIM数据）
```

## 技术细节

### API 响应格式

**接口**: `POST /api/data-processing/extract-by-operator`

**请求参数** (不变):
```json
{
  "fileId": 123,
  "operators": [
    {
      "name": "Vivo",
      "numberSegments": ["119", "129", ...],
      "countryCode": "55",
      "limit": 5000
    },
    {
      "name": "Claro",
      "numberSegments": ["349", "359", ...],
      "countryCode": "55",
      "limit": null
    }
  ]
}
```

**响应格式** (新):
```json
{
  "success": true,
  "message": "运营商数据提取完成",
  "data": {
    "totalMatched": 24160,      // 总提取条数
    "totalProcessed": 40000,    // 源文件总条数
    "operatorCount": 3,         // 选中运营商数量
    "operatorStats": [          // 各运营商统计（新增）
      {
        "operatorName": "Vivo",
        "matchedCount": 5000,
        "limit": 5000,
        "limitReached": true
      },
      {
        "operatorName": "Claro",
        "matchedCount": 11160,
        "limit": null,
        "limitReached": false
      }
    ],
    "downloadPath": "/api/data-processing/download/merged_Vivo_Claro_TIM_Brasil_xxx.txt"
  }
}
```

### 性能优化

**优化点**:
1. ✅ 只读取源文件一次
2. ✅ 在内存中处理所有运营商的匹配
3. ✅ 减少磁盘I/O操作
4. ✅ 减少文件生成次数

**性能对比**:

| 操作 | v1.0 (多文件) | v2.0 (合并) | 提升 |
|------|---------------|-------------|------|
| 读取源文件 | 3次 | 1次 | **66%↓** |
| 写入文件 | 3次 | 1次 | **66%↓** |
| 文件数量 | 3个 | 1个 | **66%↓** |
| 下载次数 | 3次 | 1次 | **66%↓** |

## 使用优势

### ✅ 更简单的文件管理
- 只需要管理一个文件
- 文件命名清晰包含所有运营商
- 减少文件整理工作

### ✅ 更快的下载速度
- 只触发一次下载
- 减少浏览器下载提示
- 避免多文件并发下载问题

### ✅ 更好的数据完整性
- 所有数据在一个文件中
- 避免文件遗漏
- 便于数据验证和使用

### ✅ 更高的处理效率
- 减少磁盘I/O
- 降低服务器负载
- 提升处理速度

## 适用场景

### 场景1：批量营销数据准备
```
需求：准备一份包含多个运营商的营销数据

优势：
- 一个文件包含所有目标运营商
- 方便导入营销系统
- 减少数据整合工作
```

### 场景2：数据分发
```
需求：将多个运营商的数据打包发送给客户

优势：
- 单文件发送更方便
- 减少邮件附件数量
- 客户接收更简单
```

### 场景3：数据分析
```
需求：分析多个运营商的数据质量

优势：
- 统一文件格式便于分析
- 减少数据加载次数
- 提升分析效率
```

## 注意事项

### ⚠️ 文件大小
- 合并文件可能比较大
- 建议根据实际需求设置条数限制
- 超大文件可能影响下载速度

### 💡 条数限制建议
```
推荐设置：
- 小批量测试: 每个运营商 1,000-5,000 条
- 中等规模: 每个运营商 10,000-50,000 条
- 大批量: 每个运营商 100,000+ 条

注意：
- 合理控制总数据量
- 避免生成超大文件（>100MB）
```

### 📝 数据顺序
- 数据按选择运营商的顺序排列
- 如需特定顺序，请调整运营商选择顺序

## 升级说明

### 向后兼容性
- ✅ API接口保持兼容
- ✅ 前端界面保持一致
- ✅ 用户操作流程不变
- ⚠️ 响应数据格式有变化（增加了字段）

### 升级步骤
1. 更新后端代码
2. 更新前端代码
3. 重启服务
4. 清除浏览器缓存
5. 测试功能

## 测试建议

### 功能测试
```bash
# 测试1：单运营商提取
选择: Vivo (限制5000条)
预期: 生成 merged_Vivo_xxx.txt (5000条)

# 测试2：多运营商提取
选择: Vivo + Claro + TIM (各10000条)
预期: 生成 merged_Vivo_Claro_TIM_xxx.txt (30000条)

# 测试3：部分限制部分全部
选择: Vivo(限制5000) + Claro(全部)
预期: 文件包含两部分数据，总数正确
```

### 验证点
- ✅ 文件生成成功
- ✅ 数据条数正确
- ✅ 文件命名规范
- ✅ 下载功能正常
- ✅ 统计信息准确

## 相关文件

**修改的文件**:
- `/home/vue-element-admin/backend/routes/dataProcessing.js` - 后端API
- `/home/vue-element-admin/src/views/data/processing.vue` - 前端界面

**相关文档**:
- [按运营商提取使用指南](./OPERATOR-EXTRACT-GUIDE.md)
- [巴西运营商优化说明](./BRAZIL-OPERATOR-FIX.md)

## 技术支持

如有问题，请联系技术支持团队。

---

**版本历史**:
- v2.0 (2025-10-18): 改为合并文件模式
- v1.0 (2025-10-18): 初始版本（多文件模式）
