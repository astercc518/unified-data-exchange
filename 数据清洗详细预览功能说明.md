# 数据清洗详细预览功能说明

## 更新时间
**2025-10-16**

## 功能概述

一键清洗功能现在返回更详细的预览数据，帮助用户了解数据清洗的每个步骤处理了哪些数据。

## 新增预览字段

### 1. 异常数据预览 (`invalidDataPreview`)

**说明**: 显示前20条被过滤掉的异常数据及其原因

**数据结构**:
```javascript
invalidDataPreview: [
  {
    data: "123",              // 异常数据内容
    length: 3,                // 数据长度
    reason: "长度过短"         // 过滤原因
  },
  {
    data: "88888888888888",
    length: 14,
    reason: "超过8位连续相同数字"
  }
]
```

**过滤原因分类**:
- `长度过短` - 少于7位
- `长度过长` - 超过19位
- `超过8位连续相同数字` - 如 `88888888888888`

**显示示例**:
```
【异常数据预览】(前20条被过滤的数据)
────────────────────────────────────────────────────────────
  1. 123                       | 长度:  3位 | 原因: 长度过短
  2. 123456789012345678901234567 | 长度: 27位 | 原因: 长度过长
  3. 88888888888888            | 长度: 14位 | 原因: 超过8位连续相同数字
```

---

### 2. 重复数据预览 (`duplicateDataPreview`)

**说明**: 显示前20条被去重的重复数据

**数据结构**:
```javascript
duplicateDataPreview: [
  {
    data: "902712535"         // 重复的数据
  },
  {
    data: "8613800138000"
  }
]
```

**显示示例**:
```
【重复数据预览】(前20条重复的数据)
────────────────────────────────────────────────────────────
  1. 902712535
  2. 902712535
  3. 8613800138000
```

**说明**: 
- 每个重复出现的数据都会被记录
- 最终只保留一条，其余被去除

---

### 3. 添加国码预览 (`addedCodePreview`)

**说明**: 显示前20条添加了国码的数据，包含原始数据、处理结果和原因

**数据结构**:
```javascript
addedCodePreview: [
  {
    original: "902712535",           // 原始数据
    result: "84902712535",           // 处理后数据
    reason: "无国码但长度符合标准，添加国码"  // 处理原因
  },
  {
    original: "9027125361",
    result: "849027125361",
    reason: "无国码但长度符合标准，添加国码"
  }
]
```

**处理原因分类**:
- `无国码但长度符合标准，添加国码` - 正常添加国码
- `其他情况，尝试添加国码` - 无法明确识别的数据

**显示示例**:
```
【添加国码预览】(前20条添加了国码的数据)
────────────────────────────────────────────────────────────
  1. 902712535       → 84902712535       | 无国码但长度符合标准，添加国码
  2. 902712536       → 84902712536       | 无国码但长度符合标准，添加国码
  3. 9027125361      → 849027125361      | 无国码但长度符合标准，添加国码
  4. 9027125362      → 849027125362      | 无国码但长度符合标准，添加国码
```

---

### 4. 去除国码预览 (`removedCodePreview`)

**说明**: 预留字段，用于未来实现去除国码功能时使用

**数据结构**:
```javascript
removedCodePreview: []  // 当前为空
```

---

## 完整返回数据结构

```javascript
{
  // 统计信息
  originalCount: 15,        // 原始数据总数
  finalCount: 9,            // 最终数据总数
  invalidCount: 3,          // 去除的异常数据数量
  duplicateCount: 3,        // 去除的重复数据数量
  addedCodeCount: 4,        // 添加国码的数量
  skippedCount: 5,          // 跳过（已有国码/其他国家数据）的数量
  
  // 处理步骤
  steps: [
    {
      step: "去除异常数据",
      removed: 3,
      remaining: 12,
      description: "去除7-19位范围外的数据和超过8位连续相同数字的数据"
    },
    {
      step: "数据去重",
      removed: 3,
      remaining: 9
    },
    {
      step: "智能校验国码",
      added: 4,
      skipped: 5,
      countryCode: "84",
      description: "检查前2位是否为84，且长度符合标准"
    }
  ],
  
  // 详细预览数据（新增）
  invalidDataPreview: [
    { data: "123", length: 3, reason: "长度过短" },
    { data: "123456789012345678901234567", length: 27, reason: "长度过长" },
    { data: "88888888888888", length: 14, reason: "超过8位连续相同数字" }
  ],
  
  duplicateDataPreview: [
    { data: "902712535" },
    { data: "902712535" },
    { data: "8613800138000" }
  ],
  
  addedCodePreview: [
    { original: "902712535", result: "84902712535", reason: "无国码但长度符合标准，添加国码" },
    { original: "902712536", result: "84902712536", reason: "无国码但长度符合标准，添加国码" },
    { original: "9027125361", result: "849027125361", reason: "无国码但长度符合标准，添加国码" },
    { original: "9027125362", result: "849027125362", reason: "无国码但长度符合标准，添加国码" }
  ],
  
  removedCodePreview: [],
  
  // 调试日志（前20条，已有）
  debugLogs: [...],
  
  // 最终数据预览（前20条，已有）
  preview: [...]
}
```

---

## 使用场景

### 场景1：了解哪些数据被过滤了

用户上传了1000条数据，清洗后只剩800条，想知道被过滤的200条是什么：

```javascript
// 查看异常数据预览
result.invalidDataPreview.forEach(item => {
  console.log(`${item.data} - ${item.reason}`);
});
```

### 场景2：确认去重是否正确

用户想知道哪些数据是重复的：

```javascript
// 查看重复数据预览
result.duplicateDataPreview.forEach(item => {
  console.log(`重复数据: ${item.data}`);
});
```

### 场景3：验证国码添加逻辑

用户想确认哪些数据被添加了国码，以及为什么：

```javascript
// 查看添加国码预览
result.addedCodePreview.forEach(item => {
  console.log(`${item.original} → ${item.result} (${item.reason})`);
});
```

---

## 前端展示建议

### 1. 在清洗结果对话框中添加详细预览标签页

```vue
<el-tabs v-model="activeTab">
  <el-tab-pane label="统计信息" name="stats">
    <!-- 现有的统计信息 -->
  </el-tab-pane>
  
  <el-tab-pane label="异常数据" name="invalid">
    <el-table :data="cleanResult.invalidDataPreview">
      <el-table-column prop="data" label="数据" />
      <el-table-column prop="length" label="长度" />
      <el-table-column prop="reason" label="原因" />
    </el-table>
  </el-tab-pane>
  
  <el-tab-pane label="重复数据" name="duplicate">
    <el-table :data="cleanResult.duplicateDataPreview">
      <el-table-column prop="data" label="数据" />
    </el-table>
  </el-tab-pane>
  
  <el-tab-pane label="添加国码" name="added">
    <el-table :data="cleanResult.addedCodePreview">
      <el-table-column prop="original" label="原始数据" />
      <el-table-column prop="result" label="处理后" />
      <el-table-column prop="reason" label="原因" />
    </el-table>
  </el-tab-pane>
  
  <el-tab-pane label="最终数据" name="preview">
    <!-- 现有的数据预览 -->
  </el-tab-pane>
</el-tabs>
```

### 2. 使用折叠面板展示

```vue
<el-collapse v-model="activeNames">
  <el-collapse-item title="异常数据预览" name="invalid">
    <div v-for="(item, index) in cleanResult.invalidDataPreview" :key="index">
      {{ item.data }} ({{ item.length }}位) - {{ item.reason }}
    </div>
  </el-collapse-item>
  
  <el-collapse-item title="重复数据预览" name="duplicate">
    <div v-for="(item, index) in cleanResult.duplicateDataPreview" :key="index">
      {{ item.data }}
    </div>
  </el-collapse-item>
  
  <el-collapse-item title="添加国码预览" name="added">
    <div v-for="(item, index) in cleanResult.addedCodePreview" :key="index">
      {{ item.original }} → {{ item.result }} ({{ item.reason }})
    </div>
  </el-collapse-item>
</el-collapse>
```

---

## 技术实现

### 异常数据收集

```javascript
// 在过滤异常数据时收集
const invalidData = [];
lines = lines.filter(line => {
  let isValid = true;
  let reason = '';
  
  if (line.length < 7 || line.length > 19) {
    isValid = false;
    reason = line.length < 7 ? '长度过短' : '长度过长';
  } else if (/(\d)\1{7,}/.test(line)) {
    isValid = false;
    reason = '超过8位连续相同数字';
  }
  
  // 记录前20条异常数据
  if (!isValid && invalidData.length < 20) {
    invalidData.push({ data: line, length: line.length, reason: reason });
  }
  
  return isValid;
});
```

### 重复数据收集

```javascript
// 在去重时收集重复数据
const duplicateData = [];
const seenData = new Set();

lines.forEach(line => {
  if (seenData.has(line)) {
    // 记录前20条重复数据
    if (duplicateData.length < 20) {
      duplicateData.push({ data: line });
    }
  } else {
    seenData.add(line);
  }
});
```

### 添加国码数据收集

```javascript
// 在添加国码时收集
const addedCodeData = [];
let wasModified = false;

lines = lines.map(line => {
  // ... 判断逻辑 ...
  
  if (wasModified && addedCodeData.length < 20) {
    addedCodeData.push({
      original: line,
      result: result,
      reason: reason
    });
  }
  
  return result;
});
```

---

## 注意事项

### 1. 预览数据限制

- 所有预览数据都限制为**前20条**
- 避免返回数据量过大影响性能
- 20条足够用户了解数据处理情况

### 2. 数据顺序

- 异常数据：按在原始数据中出现的顺序
- 重复数据：按第2次及以后出现的顺序
- 添加国码：按在数据中出现的顺序

### 3. 性能影响

- 收集预览数据的开销很小
- 不会显著影响清洗性能
- 只在每个步骤中增加少量逻辑判断

---

## 版本信息

- **版本**: v2.2
- **更新日期**: 2025-10-16
- **更新内容**: 
  - ✅ 新增异常数据预览
  - ✅ 新增重复数据预览
  - ✅ 新增添加国码预览
  - ✅ 预留去除国码预览字段

---

## 相关文件

- **后端实现**: [`/home/vue-element-admin/backend/utils/dataProcessor.js`](file:///home/vue-element-admin/backend/utils/dataProcessor.js#L753-L1024)
- **路由处理**: [`/home/vue-element-admin/backend/routes/dataProcessing.js`](file:///home/vue-element-admin/backend/routes/dataProcessing.js)
- **前端界面**: [`/home/vue-element-admin/src/views/data/processing.vue`](file:///home/vue-element-admin/src/views/data/processing.vue)

---

## 测试结果

✅ **测试通过**

测试数据：15条（包含异常、重复、需要添加国码、已有国码等各种情况）

处理结果：
- ✅ 正确收集3条异常数据
- ✅ 正确收集3条重复数据
- ✅ 正确收集4条添加国码的数据
- ✅ 所有预览数据格式正确

---

**功能已完成并测试通过** ✅  
**可以投入使用** 🎉
