<template>
  <div class="data-processing-container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
      <h2 class="page-title">
        <i class="el-icon-s-operation" /> æ•°æ®å¤„ç†ä¸­å¿ƒ
      </h2>
      <p class="page-description">æä¾›å…¨æ–¹ä½çš„æ•°æ®æ¸…æ´—ã€è½¬æ¢ã€æå–å’Œç”ŸæˆåŠŸèƒ½</p>
    </div>

    <!-- æ¨èåŠŸèƒ½ -->
    <div class="function-section">
      <div class="section-header">
        <i class="el-icon-star-on" /> æ¨èåŠŸèƒ½
      </div>
      <el-row :gutter="20" class="function-modules">
        <!-- ä¸€é”®æ¸…æ´— -->
        <el-col :xs="24" :sm="12" :md="8" :lg="6">
          <el-card class="module-card module-card-featured" shadow="hover" @click.native="openModule('cleanData')">
            <div class="module-icon" style="color: #67C23A">
              <i class="el-icon-magic-stick" />
            </div>
            <div class="module-title" style="color: #67C23A">ä¸€é”®æ¸…æ´—</div>
            <div class="module-desc">è‡ªåŠ¨æ ¡éªŒå›½ç ã€å»é‡ã€å»é™¤å¼‚å¸¸æ•°æ®</div>
            <div class="module-badge">æ¨è</div>
          </el-card>
        </el-col>

        <!-- å·ç ç”Ÿæˆ -->
        <el-col :xs="24" :sm="12" :md="8" :lg="6">
          <el-card class="module-card module-card-new" shadow="hover" @click.native="openModule('generateNumbers')">
            <div class="module-icon" style="color: #E6A23C">
              <i class="el-icon-connection" />
            </div>
            <div class="module-title" style="color: #E6A23C">å·ç ç”Ÿæˆ</div>
            <div class="module-desc">åŸºäºGoogle libphonenumberç”Ÿæˆå·ç </div>
            <div class="module-badge module-badge-new">æ–°åŠŸèƒ½</div>
          </el-card>
        </el-col>
      </el-row>
    </div>

    <!-- æ•°æ®æ¸…æ´—åŠŸèƒ½ -->
    <div class="function-section">
      <div class="section-header">
        <i class="el-icon-brush" /> æ•°æ®æ¸…æ´—
      </div>
      <el-row :gutter="20" class="function-modules">
        <!-- å¢åŠ å›½ç  -->
        <el-col :xs="24" :sm="12" :md="8" :lg="6">
          <el-card class="module-card" shadow="hover" @click.native="openModule('addCode')">
            <div class="module-icon" style="color: #409EFF">
              <i class="el-icon-plus" />
            </div>
            <div class="module-title">å¢åŠ å›½ç </div>
            <div class="module-desc">æ‰¹é‡ä¸ºæ•°æ®æ·»åŠ å›½å®¶ä»£ç </div>
          </el-card>
        </el-col>

        <!-- å»é™¤å›½ç  -->
        <el-col :xs="24" :sm="12" :md="8" :lg="6">
          <el-card class="module-card" shadow="hover" @click.native="openModule('removeCode')">
            <div class="module-icon" style="color: #409EFF">
              <i class="el-icon-remove-outline" />
            </div>
            <div class="module-title">å»é™¤å›½ç </div>
            <div class="module-desc">æ‰¹é‡å»é™¤æ•°æ®ä¸­çš„å›½å®¶ä»£ç </div>
          </el-card>
        </el-col>

        <!-- æ•°æ®å»é‡ -->
        <el-col :xs="24" :sm="12" :md="8" :lg="6">
          <el-card class="module-card" shadow="hover" @click.native="openModule('deduplicate')">
            <div class="module-icon" style="color: #409EFF">
              <i class="el-icon-files" />
            </div>
            <div class="module-title">æ•°æ®å»é‡</div>
            <div class="module-desc">æ™ºèƒ½å»é™¤é‡å¤æ•°æ®</div>
          </el-card>
        </el-col>

        <!-- æ•°æ®å¯¹æ¯” -->
        <el-col :xs="24" :sm="12" :md="8" :lg="6">
          <el-card class="module-card" shadow="hover" @click.native="openModule('compare')">
            <div class="module-icon" style="color: #409EFF">
              <i class="el-icon-s-data" />
            </div>
            <div class="module-title">æ•°æ®å¯¹æ¯”</div>
            <div class="module-desc">å¯¹æ¯”å¤šä¸ªæ•°æ®æ–‡ä»¶çš„å·®å¼‚</div>
          </el-card>
        </el-col>
      </el-row>
    </div>

    <!-- æ•°æ®æå–åŠŸèƒ½ -->
    <div class="function-section">
      <div class="section-header">
        <i class="el-icon-download" /> æ•°æ®æå–
      </div>
      <el-row :gutter="20" class="function-modules">
        <!-- æŒ‰è¿è¥å•†æå– -->
        <el-col :xs="24" :sm="12" :md="8" :lg="6">
          <el-card class="module-card" shadow="hover" @click.native="openModule('extractOperator')">
            <div class="module-icon" style="color: #909399">
              <i class="el-icon-share" />
            </div>
            <div class="module-title">æŒ‰è¿è¥å•†æå–</div>
            <div class="module-desc">æ ¹æ®è¿è¥å•†ç­›é€‰æ•°æ®</div>
          </el-card>
        </el-col>

        <!-- æŒ‰æ¡æ•°æå– -->
        <el-col :xs="24" :sm="12" :md="8" :lg="6">
          <el-card class="module-card" shadow="hover" @click.native="openModule('extractCount')">
            <div class="module-icon" style="color: #909399">
              <i class="el-icon-document-copy" />
            </div>
            <div class="module-title">æŒ‰æ¡æ•°æå–</div>
            <div class="module-desc">æŒ‰æŒ‡å®šæ¡æ•°æå–æ•°æ®</div>
          </el-card>
        </el-col>
      </el-row>
    </div>

    <!-- æ•°æ®æ–‡ä»¶ç®¡ç† -->
    <el-card class="file-manager-card">
      <div slot="header" class="clearfix">
        <span class="card-title"><i class="el-icon-folder-opened" /> æ•°æ®æ–‡ä»¶ç®¡ç†</span>
        <el-button style="float: right" type="primary" size="small" @click="showUploadDialog">
          <i class="el-icon-upload" /> ä¸Šä¼ æ–‡ä»¶
        </el-button>
        <el-button style="float: right; margin-right: 10px" type="text" @click="fetchFileList">
          <i class="el-icon-refresh" /> åˆ·æ–°
        </el-button>
      </div>

      <el-table
        v-loading="loading"
        :data="fileList"
        border
        stripe
        @selection-change="handleSelectionChange"
      >
        <el-table-column type="selection" width="55" />
        <el-table-column prop="original_filename" label="æ–‡ä»¶å" min-width="200" show-overflow-tooltip />
        <el-table-column label="ä¸Šä¼ ç”¨æˆ·" width="120" align="center">
          <template slot-scope="{row}">
            <span>{{ row.customer_name || row.customer_account || '-' }}</span>
          </template>
        </el-table-column>
        <el-table-column label="æ–‡ä»¶å¤§å°" width="120" align="center">
          <template slot-scope="{row}">
            {{ formatFileSize(row.file_size) }}
          </template>
        </el-table-column>
        <el-table-column label="æ•°æ®è¡Œæ•°" width="120" align="center">
          <template slot-scope="{row}">
            {{ formatNumber(row.line_count) }}
          </template>
        </el-table-column>
        <el-table-column label="ä¸Šä¼ æ—¶é—´" width="160" align="center">
          <template slot-scope="{row}">
            {{ formatTime(row.upload_time) }}
          </template>
        </el-table-column>
        <el-table-column label="æ“ä½œ" width="180" align="center" fixed="right">
          <template slot-scope="{row}">
            <el-button
              type="text"
              size="small"
              icon="el-icon-view"
              @click="handlePreview(row)"
            >
              é¢„è§ˆ
            </el-button>
            <el-button
              type="danger"
              size="mini"
              icon="el-icon-delete"
              @click="handleDelete(row)"
            >
              åˆ é™¤
            </el-button>
          </template>
        </el-table-column>
      </el-table>

      <div v-if="selectedFiles.length > 0" class="batch-actions">
        <el-alert
          :title="`å·²é€‰æ‹© ${selectedFiles.length} ä¸ªæ–‡ä»¶`"
          type="info"
          :closable="false"
        />
      </div>
    </el-card>

    <!-- æ–‡ä»¶ä¸Šä¼ å¯¹è¯æ¡† -->
    <el-dialog title="ä¸Šä¼ æ•°æ®æ–‡ä»¶" :visible.sync="uploadDialogVisible" width="600px" @close="handleUploadDialogClose">
      <el-upload
        ref="upload"
        class="upload-demo"
        drag
        :action="uploadAction"
        :headers="uploadHeaders"
        :on-success="handleUploadSuccess"
        :on-error="handleUploadError"
        :before-upload="beforeUpload"
        :file-list="uploadFileList"
        multiple
        accept=".txt"
      >
        <i class="el-icon-upload" />
        <div class="el-upload__text">
          å°†æ–‡ä»¶æ‹–åˆ°æ­¤å¤„ï¼Œæˆ–<em>ç‚¹å‡»ä¸Šä¼ </em>
        </div>
        <div slot="tip" class="el-upload__tip">
          æ”¯æŒåŒæ—¶ä¸Šä¼ å¤šä¸ª TXT æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡100MB<br>
          <span style="color: #E6A23C">âœ” ä¸Šä¼ æ—¶è‡ªåŠ¨å»é™¤é‡å¤æ•°æ®</span><br>
          <span style="color: #E6A23C">âœ” è‡ªåŠ¨æ£€éªŒæ•°æ®å›½ç æ˜¯å¦ä¸åŸºæœ¬ä¿¡æ¯ä¸€è‡´</span>
        </div>
      </el-upload>
      <span slot="footer" class="dialog-footer">
        <el-button @click="uploadDialogVisible = false">å…³é—­</el-button>
      </span>
    </el-dialog>

    <!-- æ•°æ®é¢„è§ˆå¯¹è¯æ¡† -->
    <el-dialog title="æ•°æ®é¢„è§ˆ" :visible.sync="previewDialogVisible" width="800px">
      <el-alert
        v-if="previewData.duplicateCount > 0"
        :title="`å·²è‡ªåŠ¨å»é™¤ ${formatNumber(previewData.duplicateCount)} æ¡é‡å¤æ•°æ®`"
        type="success"
        :closable="false"
        show-icon
        style="margin-bottom: 15px"
      />

      <el-alert
        v-if="previewData.codeDetection && previewData.codeDetection.hasCode"
        :title="`æ£€æµ‹åˆ°å›½ç ï¼š${previewData.codeDetection.countryCode} (ç½®ä¿¡åº¦ï¼š${(previewData.codeDetection.confidence * 100).toFixed(1)}%)`"
        type="info"
        :closable="false"
        show-icon
        style="margin-bottom: 15px"
      />

      <div class="preview-info">
        <el-row :gutter="20">
          <el-col :span="8">
            <div class="info-item">
              <span class="info-label">æ–‡ä»¶åï¼š</span>
              <span class="info-value">{{ previewData.filename }}</span>
            </div>
          </el-col>
          <el-col :span="8">
            <el-tag type="success">åŸå§‹ï¼š{{ formatNumber(previewData.originalCount) }} æ¡</el-tag>
            <el-tag type="primary" style="margin-left: 10px">æœ€ç»ˆï¼š{{ formatNumber(previewData.finalCount) }} æ¡</el-tag>
          </el-col>
          <el-col :span="8">
            <el-tag v-if="previewData.duplicateCount > 0" type="warning">
              å»é‡ï¼š{{ formatNumber(previewData.duplicateCount) }} æ¡
            </el-tag>
          </el-col>
        </el-row>
      </div>

      <el-divider content-position="left">å‰20æ¡æ•°æ®é¢„è§ˆ</el-divider>

      <div class="preview-content">
        <el-table
          :data="previewData.preview"
          border
          stripe
          max-height="400"
        >
          <el-table-column type="index" label="#" width="60" align="center" />
          <el-table-column label="æ•°æ®" min-width="200">
            <template slot-scope="{row}">
              <code>{{ row }}</code>
            </template>
          </el-table-column>
        </el-table>
      </div>

      <span slot="footer" class="dialog-footer">
        <el-button type="primary" @click="previewDialogVisible = false">å…³é—­</el-button>
      </span>
    </el-dialog>

    <!-- å»é™¤å›½ç å¯¹è¯æ¡† -->
    <el-dialog title="å»é™¤å›½ç " :visible.sync="dialogRemoveCode" width="700px">
      <el-form :model="removeCodeForm" label-width="120px">
        <el-form-item label="å¤„ç†æ–‡ä»¶">
          <el-select v-model="removeCodeForm.fileIds" multiple placeholder="è¯·é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶" style="width: 100%">
            <el-option
              v-for="file in fileList"
              :key="file.id"
              :label="`${file.original_filename} (${formatNumber(file.line_count)}è¡Œ)`"
              :value="file.id"
            />
          </el-select>
          <div style="margin-top: 10px; color: #909399; font-size: 12px">
            å·²é€‰æ‹© {{ removeCodeForm.fileIds.length }} ä¸ªæ–‡ä»¶
          </div>
        </el-form-item>
        <el-form-item label="æŒ‡å®šå›½ç ">
          <el-input v-model="removeCodeForm.countryCode" placeholder="ç•™ç©ºåˆ™å»é™¤æ‰€æœ‰å›½ç ï¼Œä¾‹å¦‚ï¼š+86" />
        </el-form-item>
        <el-form-item label="å¤„ç†æ–¹å¼">
          <el-radio-group v-model="removeCodeForm.processMode">
            <el-radio label="immediate">ç«‹å³å¤„ç†</el-radio>
            <el-radio label="background">ç§»è‡³åå°é˜Ÿåˆ—</el-radio>
          </el-radio-group>
          <div v-if="removeCodeForm.processMode === 'background'" style="margin-top: 5px; color: #E6A23C; font-size: 12px">
            <i class="el-icon-info" /> ä»»åŠ¡å°†åœ¨åå°é˜Ÿåˆ—ä¸­å¤„ç†,å¯åœ¨"å¤„ç†ä»»åŠ¡"é¡µé¢æŸ¥çœ‹è¿›åº¦
          </div>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="dialogRemoveCode = false">å–æ¶ˆ</el-button>
        <el-button type="primary" :loading="processing" @click="confirmRemoveCode">å¼€å§‹å¤„ç†</el-button>
      </span>
    </el-dialog>

    <!-- æ•°æ®å»é‡å¯¹è¯æ¡† -->
    <el-dialog title="æ•°æ®å»é‡" :visible.sync="dialogDeduplicate" width="700px">
      <el-form :model="deduplicateForm" label-width="120px">
        <el-form-item label="å¤„ç†æ–‡ä»¶">
          <el-select v-model="deduplicateForm.fileIds" multiple placeholder="è¯·é€‰æ‹©è¦å»é‡çš„æ–‡ä»¶" style="width: 100%">
            <el-option
              v-for="file in fileList"
              :key="file.id"
              :label="`${file.original_filename} (${formatNumber(file.line_count)}è¡Œ)`"
              :value="file.id"
            />
          </el-select>
          <div style="margin-top: 10px; color: #909399; font-size: 12px">
            å·²é€‰æ‹© {{ deduplicateForm.fileIds.length }} ä¸ªæ–‡ä»¶
          </div>
        </el-form-item>
        <el-form-item label="å¤„ç†æ–¹å¼">
          <el-radio-group v-model="deduplicateForm.processMode">
            <el-radio label="immediate">ç«‹å³å¤„ç†</el-radio>
            <el-radio label="background">ç§»è‡³åå°é˜Ÿåˆ—</el-radio>
          </el-radio-group>
          <div v-if="deduplicateForm.processMode === 'background'" style="margin-top: 5px; color: #E6A23C; font-size: 12px">
            <i class="el-icon-info" /> ä»»åŠ¡å°†åœ¨åå°é˜Ÿåˆ—ä¸­å¤„ç†,å¯åœ¨"å¤„ç†ä»»åŠ¡"é¡µé¢æŸ¥çœ‹è¿›åº¦
          </div>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="dialogDeduplicate = false">å–æ¶ˆ</el-button>
        <el-button type="primary" :loading="processing" @click="confirmDeduplicate">å¼€å§‹å»é‡</el-button>
      </span>
    </el-dialog>

    <!-- æ•°æ®å¯¹æ¯”å¯¹è¯æ¡† -->
    <el-dialog title="æ•°æ®å¯¹æ¯”" :visible.sync="dialogCompare" width="700px">
      <el-form :model="compareForm" label-width="120px">
        <el-form-item label="ä¸»æ–‡ä»¶">
          <el-select v-model="compareForm.file1Id" placeholder="è¯·é€‰æ‹©ä¸»æ–‡ä»¶" style="width: 100%">
            <el-option
              v-for="file in fileList"
              :key="file.id"
              :label="`${file.original_filename} (${formatNumber(file.line_count)}è¡Œ)`"
              :value="file.id"
            />
          </el-select>
        </el-form-item>
        <el-form-item label="å¯¹æ¯”æ–‡ä»¶">
          <el-select v-model="compareForm.file2Id" placeholder="è¯·é€‰æ‹©å¯¹æ¯”æ–‡ä»¶" style="width: 100%">
            <el-option
              v-for="file in fileList.filter(f => f.id !== compareForm.file1Id)"
              :key="file.id"
              :label="`${file.original_filename} (${formatNumber(file.line_count)}è¡Œ)`"
              :value="file.id"
            />
          </el-select>
        </el-form-item>
        <el-form-item label="å¯¹æ¯”æ¨¡å¼">
          <el-radio-group v-model="compareForm.mode">
            <el-radio label="diff">å·®å¼‚ï¼ˆæ–‡ä»¶1ç‹¬æœ‰ï¼‰</el-radio>
            <el-radio label="common">å…±æœ‰æ•°æ®</el-radio>
            <el-radio label="unique">å„è‡ªç‹¬æœ‰</el-radio>
          </el-radio-group>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="dialogCompare = false">å–æ¶ˆ</el-button>
        <el-button type="primary" :loading="processing" @click="confirmCompare">å¼€å§‹å¯¹æ¯”</el-button>
      </span>
    </el-dialog>

    <!-- æŒ‰è¿è¥å•†æå–å¯¹è¯æ¡† -->
    <el-dialog title="æŒ‰è¿è¥å•†æå–" :visible.sync="dialogExtractOperator" width="800px">
      <el-form :model="extractOperatorForm" label-width="120px">
        <el-form-item label="å¤„ç†æ–‡ä»¶">
          <el-select
            v-model="extractOperatorForm.fileId"
            placeholder="è¯·é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶"
            style="width: 100%"
            @change="handleFileChange"
          >
            <el-option
              v-for="file in fileList"
              :key="file.id"
              :label="`${file.original_filename} (${formatNumber(file.line_count)}è¡Œ)`"
              :value="file.id"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="å›½å®¶">
          <el-select
            v-model="extractOperatorForm.countryCode"
            placeholder="è¯·é€‰æ‹©å›½å®¶"
            filterable
            @change="handleCountryChange"
          >
            <el-option
              v-for="country in countryList"
              :key="country.code"
              :label="`${country.name} (${country.dialCode})`"
              :value="country.code"
            >
              <span style="float: left">{{ country.name }}</span>
              <span style="float: right; color: #8492a6; font-size: 13px">{{ country.dialCode }}</span>
            </el-option>
          </el-select>
        </el-form-item>

        <el-divider content-position="left">è¿è¥å•†é€‰æ‹©ä¸æå–æ¡æ•°</el-divider>

        <el-alert
          v-if="extractOperatorForm.analyzing"
          title="æ­£åœ¨åˆ†ææ–‡ä»¶ä¸­çš„è¿è¥å•†åˆ†å¸ƒ..."
          type="info"
          :closable="false"
          show-icon
        />

        <el-form-item v-if="!extractOperatorForm.analyzing && operatorList.length > 0" label="é€‰æ‹©è¿è¥å•†">
          <div style="margin-bottom: 15px">
            <el-checkbox-group v-model="extractOperatorForm.selectedOperators" @change="handleOperatorSelection">
              <el-checkbox
                v-for="operator in operatorList"
                :key="operator.name"
                :label="operator.name"
                style="display: block; margin-bottom: 10px"
              >
                {{ operator.name }} (æ•°é‡: {{ formatNumber(operator.count) }}, å æ¯”: {{ operator.percentage }}%)
              </el-checkbox>
            </el-checkbox-group>
          </div>
        </el-form-item>

        <el-alert
          v-if="!extractOperatorForm.analyzing && operatorList.length === 0 && extractOperatorForm.countryCode"
          type="warning"
          :closable="false"
        >
          <template slot="title">
            <div v-if="extractOperatorForm.countryCode === 'US'" style="line-height: 1.8;">
              <strong>ç¾å›½å·ç è¿è¥å•†è¯†åˆ«è¯´æ˜</strong><br>
              <div style="margin-top: 8px; font-weight: normal; font-size: 13px;">
                âš ï¸ åŸå› ï¼šç¾å›½æ‰€æœ‰è¿è¥å•†å…±äº«ç›¸åŒçš„åŒºå·æ± ï¼Œç³»ç»Ÿå°†æŒ‰åŒºå·è¿›è¡Œæ¨¡æ‹Ÿåˆ†ç»„<br>
                âœ“ å¦‚æœæ–‡ä»¶ä¸­æœªæ£€æµ‹åˆ°æ•°æ®ï¼Œè¯·æ£€æŸ¥å·ç æ ¼å¼ï¼š1 + åŒºå·(3ä½) + å·ç (7ä½)<br>
                <strong>å»ºè®®ï¼š</strong>ä½¿ç”¨â€œæŒ‰æ¡æ•°æå–â€åŠŸèƒ½è¿›è¡Œæ•°æ®æå–ï¼Œæ›´åŠ å‡†ç¡®
              </div>
            </div>
            <div v-else>
              æ–‡ä»¶ä¸­æœªæ£€æµ‹åˆ°è¯¥å›½å®¶çš„è¿è¥å•†æ•°æ®ï¼Œè¯·é€‰æ‹©å…¶ä»–å›½å®¶æˆ–æ–‡ä»¶
            </div>
          </template>
        </el-alert>

        <el-form-item v-if="extractOperatorForm.selectedOperators.length > 0" label="æå–æ¡æ•°è®¾ç½®">
          <div
            v-for="opName in extractOperatorForm.selectedOperators"
            :key="opName"
            style="margin-bottom: 15px; padding: 10px; background: #f5f7fa; border-radius: 4px"
          >
            <div v-if="extractOperatorForm.operatorLimits[opName]" style="display: flex; align-items: center; justify-content: space-between">
              <span style="font-weight: 600; color: #303133">{{ opName }}</span>
              <div style="display: flex; align-items: center">
                <el-switch
                  v-model="extractOperatorForm.operatorLimits[opName].enabled"
                  active-text="é™åˆ¶æ¡æ•°"
                  inactive-text="å…¨éƒ¨æå–"
                  style="margin-right: 15px"
                />
                <el-input-number
                  v-if="extractOperatorForm.operatorLimits[opName].enabled"
                  v-model="extractOperatorForm.operatorLimits[opName].limit"
                  :min="1"
                  :max="1000000"
                  :step="1000"
                  placeholder="æå–æ¡æ•°"
                  style="width: 180px"
                />
              </div>
            </div>
          </div>
          <div style="margin-top: 10px; color: #909399; font-size: 12px">
            ğŸ’¡ æç¤ºï¼šå¼€å¯"é™åˆ¶æ¡æ•°"åï¼Œå°†ä»…æå–æŒ‡å®šæ•°é‡çš„æ•°æ®ï¼›å…³é—­åˆ™æå–è¯¥è¿è¥å•†çš„å…¨éƒ¨æ•°æ®
          </div>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="dialogExtractOperator = false">å–æ¶ˆ</el-button>
        <el-button type="primary" :loading="processing" @click="confirmExtractOperator">å¼€å§‹æå–</el-button>
      </span>
    </el-dialog>

    <!-- æŒ‰æ¡æ•°æå–å¯¹è¯æ¡† -->
    <el-dialog title="æŒ‰æ¡æ•°æå–" :visible.sync="dialogExtractCount" width="700px">
      <el-form :model="extractCountForm" label-width="120px">
        <el-form-item label="å¤„ç†æ–‡ä»¶">
          <el-select v-model="extractCountForm.fileIds" multiple placeholder="è¯·é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶" style="width: 100%">
            <el-option
              v-for="file in fileList"
              :key="file.id"
              :label="`${file.original_filename} (${formatNumber(file.line_count)}è¡Œ)`"
              :value="file.id"
            />
          </el-select>
          <div style="margin-top: 10px; color: #909399; font-size: 12px">
            å·²é€‰æ‹© {{ extractCountForm.fileIds.length }} ä¸ªæ–‡ä»¶
          </div>
        </el-form-item>
        <el-form-item label="èµ·å§‹ä½ç½®">
          <el-input-number v-model="extractCountForm.startFrom" :min="0" />
        </el-form-item>
        <el-form-item label="æå–æ¡æ•°">
          <el-input-number v-model="extractCountForm.count" :min="1" />
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="dialogExtractCount = false">å–æ¶ˆ</el-button>
        <el-button type="primary" :loading="processing" @click="confirmExtractCount">å¼€å§‹æå–</el-button>
      </span>
    </el-dialog>

    <!-- å¢åŠ å›½ç å¯¹è¯æ¡† -->
    <el-dialog title="å¢åŠ å›½ç " :visible.sync="dialogAddCode" width="700px">
      <el-form :model="addCodeForm" label-width="120px">
        <el-form-item label="å¤„ç†æ–‡ä»¶">
          <el-select v-model="addCodeForm.fileIds" multiple placeholder="è¯·é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶" style="width: 100%">
            <el-option
              v-for="file in fileList"
              :key="file.id"
              :label="`${file.original_filename} (${formatNumber(file.line_count)}è¡Œ)`"
              :value="file.id"
            />
          </el-select>
          <div style="margin-top: 10px; color: #909399; font-size: 12px">
            å·²é€‰æ‹© {{ addCodeForm.fileIds.length }} ä¸ªæ–‡ä»¶
          </div>
        </el-form-item>
        <el-form-item label="é€‰æ‹©å›½å®¶">
          <el-select
            v-model="addCodeForm.countryCode"
            placeholder="è¯·é€‰æ‹©å›½å®¶"
            filterable
            style="width: 100%"
            @change="handleAddCodeCountryChange"
          >
            <el-option-group label="çƒ­é—¨å›½å®¶">
              <el-option
                v-for="country in hotCountries"
                :key="country.code"
                :label="`${country.name} (${country.dialCode})`"
                :value="country.dialCode"
              >
                <span style="float: left">{{ country.name }}</span>
                <span style="float: right; color: #8492a6; font-size: 13px">{{ country.dialCode }}</span>
              </el-option>
            </el-option-group>
            <el-option-group label="å…¨éƒ¨å›½å®¶">
              <el-option
                v-for="country in countryList"
                :key="country.code"
                :label="`${country.name} (${country.dialCode})`"
                :value="country.dialCode"
              >
                <span style="float: left">{{ country.name }}</span>
                <span style="float: right; color: #8492a6; font-size: 13px">{{ country.dialCode }}</span>
              </el-option>
            </el-option-group>
          </el-select>
        </el-form-item>

        <!-- å…±ç”¨å›½ç é€‰æ‹©å™¨ï¼ˆå¦‚ +1ï¼‰ -->
        <el-form-item v-if="showAddCodeCountrySelector" label="å…·ä½“å›½å®¶">
          <el-select v-model="addCodeForm.specificCountry" placeholder="è¯·é€‰æ‹©å…·ä½“å›½å®¶" style="width: 100%">
            <el-option
              v-for="country in addCodeCountryOptions"
              :key="country.code"
              :label="country.name"
              :value="country.code"
            >
              <span>{{ country.name }} ({{ country.nameEn }})</span>
            </el-option>
          </el-select>
          <div style="margin-top: 5px; color: #909399; font-size: 12px">
            {{ addCodeForm.countryCode }} æœ‰å¤šä¸ªå›½å®¶å…±ç”¨ï¼Œè¯·é€‰æ‹©å…·ä½“å›½å®¶
          </div>
        </el-form-item>

        <el-form-item label="å›½ç ">
          <el-input v-model="addCodeForm.countryCodePrefix" placeholder="ä¾‹å¦‚ï¼š+86" disabled>
            <template slot="prepend">é€‰ä¸­å›½å®¶çš„å›½ç </template>
          </el-input>
          <div style="margin-top: 5px; color: #909399; font-size: 12px">
            å›½ç å°†æ·»åŠ åˆ°æ¯è¡Œæ•°æ®çš„å¼€å¤´
          </div>
        </el-form-item>
        <el-form-item label="å¤„ç†æ–¹å¼">
          <el-radio-group v-model="addCodeForm.processMode">
            <el-radio label="immediate">ç«‹å³å¤„ç†</el-radio>
            <el-radio label="background">ç§»è‡³åå°é˜Ÿåˆ—</el-radio>
          </el-radio-group>
          <div v-if="addCodeForm.processMode === 'background'" style="margin-top: 5px; color: #E6A23C; font-size: 12px">
            <i class="el-icon-info" /> ä»»åŠ¡å°†åœ¨åå°é˜Ÿåˆ—ä¸­å¤„ç†,å¯åœ¨"å¤„ç†ä»»åŠ¡"é¡µé¢æŸ¥çœ‹è¿›åº¦
          </div>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button @click="dialogAddCode = false">å–æ¶ˆ</el-button>
        <el-button type="primary" :loading="processing" @click="confirmAddCode">å¼€å§‹å¤„ç†</el-button>
      </span>
    </el-dialog>

    <!-- ä¸€é”®æ¸…æ´—å¯¹è¯æ¡† -->
    <el-dialog title="ä¸€é”®æ¸…æ´—æ•°æ®" :visible.sync="dialogCleanData" width="800px">
      <el-alert
        title="ä¸€é”®æ¸…æ´—å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š"
        type="info"
        :closable="false"
        style="margin-bottom: 20px"
      >
        <div slot="default">
          <p style="margin: 5px 0">âœ” <strong>æ­¥éª¤1ï¼šå»é™¤å¼‚å¸¸æ•°æ®</strong>ï¼šå»é™¤å°äº7ä½æˆ–å¤§äº15ä½ã€åŒ…å«éæ•°å­—ã€è¶…8ä½ç›¸åŒæ•°å­—çš„æ•°æ®</p>
          <p style="margin: 5px 0">âœ” <strong>æ­¥éª¤2ï¼šå»é™¤é‡å¤æ•°æ®</strong>ï¼šå»é™¤æ•°æ®ä¸­çš„ç›¸åŒå·ç </p>
          <p style="margin: 5px 0">âœ” <strong>æ­¥éª¤3ï¼šæ™ºèƒ½æ ¡éªŒå›½ç </strong>ï¼šæ ¹æ®é€‰æ‹©çš„å›½å®¶ï¼Œæ£€æŸ¥æ•°æ®å‰1-3ä½æ˜¯å¦å·²åŒ…å«è¯¥å›½ç ï¼Œæœ‰åˆ™ä¿ç•™ï¼Œæ— åˆ™æ·»åŠ </p>
        </div>
      </el-alert>

      <el-form :model="cleanDataForm" label-width="120px">
        <el-form-item label="å¤„ç†æ–‡ä»¶">
          <el-select v-model="cleanDataForm.fileIds" multiple placeholder="è¯·é€‰æ‹©è¦æ¸…æ´—çš„æ–‡ä»¶" style="width: 100%">
            <el-option
              v-for="file in fileList"
              :key="file.id"
              :label="`${file.original_filename} (${formatNumber(file.line_count)}è¡Œ)`"
              :value="file.id"
            />
          </el-select>
          <div style="margin-top: 10px; color: #909399; font-size: 12px">
            å·²é€‰æ‹© {{ cleanDataForm.fileIds.length }} ä¸ªæ–‡ä»¶
          </div>
        </el-form-item>

        <el-form-item label="é€‰æ‹©å›½å®¶">
          <el-select
            v-model="cleanDataForm.countryCode"
            placeholder="è¯·é€‰æ‹©å›½å®¶"
            filterable
            clearable
            style="width: 100%"
            @change="handleCleanDataCountryChange"
          >
            <el-option-group label="çƒ­é—¨å›½å®¶">
              <el-option
                v-for="country in hotCountries"
                :key="country.code"
                :label="`${country.name} (${country.dialCode})`"
                :value="country.dialCode"
              >
                <span style="float: left">{{ country.name }}</span>
                <span style="float: right; color: #8492a6; font-size: 13px">{{ country.dialCode }}</span>
              </el-option>
            </el-option-group>
            <el-option-group label="å…¨éƒ¨å›½å®¶">
              <el-option
                v-for="country in countryList"
                :key="country.code"
                :label="`${country.name} (${country.dialCode})`"
                :value="country.dialCode"
              >
                <span style="float: left">{{ country.name }}</span>
                <span style="float: right; color: #8492a6; font-size: 13px">{{ country.dialCode }}</span>
              </el-option>
            </el-option-group>
          </el-select>
          <div style="margin-top: 5px; color: #909399; font-size: 12px">
            æ™ºèƒ½æ ¡éªŒï¼šæ£€æŸ¥æ•°æ®å‰1-3ä½æ˜¯å¦ä¸ºé€‰æ‹©çš„å›½ç ï¼ˆå¦‚ç¾å›½æ£€1ï¼Œå¢¨è¥¿å“¥æ£€52ï¼Œé˜¿è”é…‹æ£€æµ‹971ï¼‰ï¼Œæœ‰åˆ™ä¿ç•™ï¼Œæ— åˆ™æ·»åŠ 
          </div>
        </el-form-item>

        <!-- å…±ç”¨å›½ç é€‰æ‹©å™¨ï¼ˆå¦‚ +1ï¼‰ -->
        <el-form-item v-if="showCleanDataCountrySelector" label="å…·ä½“å›½å®¶">
          <el-select v-model="cleanDataForm.specificCountry" placeholder="è¯·é€‰æ‹©å…·ä½“å›½å®¶" style="width: 100%">
            <el-option
              v-for="country in cleanDataCountryOptions"
              :key="country.code"
              :label="country.name"
              :value="country.code"
            >
              <span>{{ country.name }} ({{ country.nameEn }})</span>
            </el-option>
          </el-select>
          <div style="margin-top: 5px; color: #909399; font-size: 12px">
            {{ cleanDataForm.countryCode }} æœ‰å¤šä¸ªå›½å®¶å…±ç”¨ï¼Œè¯·é€‰æ‹©å…·ä½“å›½å®¶
          </div>
        </el-form-item>

        <el-form-item label="æ¸…æ´—é€‰é¡¹">
          <el-checkbox-group v-model="cleanDataForm.options">
            <el-checkbox label="autoAddCode">æ™ºèƒ½æ ¡éªŒå›½ç </el-checkbox>
            <el-checkbox label="autoDeduplicate">è‡ªåŠ¨å»é‡</el-checkbox>
            <el-checkbox label="removeInvalid">å»é™¤å¼‚å¸¸æ•°æ®</el-checkbox>
          </el-checkbox-group>
        </el-form-item>
      </el-form>

      <span slot="footer" class="dialog-footer">
        <el-button @click="dialogCleanData = false">å–æ¶ˆ</el-button>
        <el-button type="success" :loading="processing" @click="confirmCleanData">
          <i class="el-icon-magic-stick" /> å¼€å§‹æ¸…æ´—
        </el-button>
      </span>
    </el-dialog>

    <!-- æ¸…æ´—ç»“æœå¯¹è¯æ¡† -->
    <el-dialog title="æ•°æ®æ¸…æ´—ç»“æœ" :visible.sync="cleanResultDialogVisible" width="900px">
      <el-alert
        title="æ•°æ®æ¸…æ´—å®Œæˆï¼"
        type="success"
        :closable="false"
        show-icon
        style="margin-bottom: 20px"
      />

      <div class="clean-result-summary">
        <el-row :gutter="20">
          <el-col :span="4">
            <div class="stat-card">
              <div class="stat-label">åŸå§‹æ•°æ®</div>
              <div class="stat-value">{{ formatNumber(cleanResult.originalCount) }}</div>
            </div>
          </el-col>
          <el-col :span="4">
            <div class="stat-card">
              <div class="stat-label">æœ€ç»ˆæ•°æ®</div>
              <div class="stat-value" style="color: #67C23A">{{ formatNumber(cleanResult.finalCount) }}</div>
            </div>
          </el-col>
          <el-col :span="4">
            <div class="stat-card">
              <div class="stat-label">å»é™¤å¼‚å¸¸</div>
              <div class="stat-value" style="color: #E6A23C">{{ formatNumber(cleanResult.invalidCount) }}</div>
            </div>
          </el-col>
          <el-col :span="4">
            <div class="stat-card">
              <div class="stat-label">å»é™¤é‡å¤</div>
              <div class="stat-value" style="color: #F56C6C">{{ formatNumber(cleanResult.duplicateCount) }}</div>
            </div>
          </el-col>
          <el-col :span="4">
            <div class="stat-card">
              <div class="stat-label">æ·»åŠ å›½ç </div>
              <div class="stat-value" style="color: #409EFF">{{ formatNumber(cleanResult.addedCodeCount) }}</div>
            </div>
          </el-col>
          <el-col :span="4">
            <div class="stat-card">
              <div class="stat-label">å·²æœ‰å›½ç </div>
              <div class="stat-value" style="color: #909399">{{ formatNumber(cleanResult.skippedCount) }}</div>
            </div>
          </el-col>
        </el-row>
      </div>

      <el-divider content-position="left">å¤„ç†æ­¥éª¤</el-divider>

      <el-timeline>
        <el-timeline-item
          v-for="(step, index) in cleanResult.steps"
          :key="index"
          :timestamp="step.step"
          placement="top"
          :type="index === cleanResult.steps.length - 1 ? 'success' : 'primary'"
        >
          <el-card>
            <p v-if="step.removed">å»é™¤ï¼š<strong>{{ formatNumber(step.removed) }}</strong> æ¡</p>
            <p v-if="step.added">æ·»åŠ å›½ç ï¼š<strong>{{ formatNumber(step.added) }}</strong> æ¡</p>
            <p v-if="step.skipped">å·²æœ‰å›½ç ï¼š<strong>{{ formatNumber(step.skipped) }}</strong> æ¡</p>
            <p v-if="step.remaining">å‰©ä½™ï¼š<strong>{{ formatNumber(step.remaining) }}</strong> æ¡</p>
            <p v-if="step.countryCode">å›½ç ï¼š<strong>{{ step.countryCode }}</strong></p>
            <p v-if="step.description" style="color: #909399; font-size: 12px; margin-top: 5px;">{{ step.description }}</p>
          </el-card>
        </el-timeline-item>
      </el-timeline>

      <el-divider content-position="left">è¯¦ç»†é¢„è§ˆ</el-divider>

      <el-tabs type="border-card">
        <!-- æœ€ç»ˆæ•°æ®é¢„è§ˆ -->
        <el-tab-pane label="æœ€ç»ˆæ•°æ®ï¼ˆå‰20æ¡ï¼‰">
          <el-table :data="cleanResult.preview" border stripe max-height="400">
            <el-table-column type="index" label="#" width="60" align="center" />
            <el-table-column label="æ•°æ®" min-width="200">
              <template slot-scope="{row}">
                <code>{{ row }}</code>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>

        <!-- å¼‚å¸¸æ•°æ®é¢„è§ˆ -->
        <el-tab-pane :label="`å¼‚å¸¸æ•°æ®ï¼ˆå‰20æ¡ï¼Œå…±${formatNumber(cleanResult.invalidCount)}æ¡ï¼‰`">
          <el-alert
            v-if="!cleanResult.invalidDataPreview || cleanResult.invalidDataPreview.length === 0"
            title="æ²¡æœ‰å¼‚å¸¸æ•°æ®"
            type="success"
            :closable="false"
            show-icon
          />
          <el-table v-else :data="cleanResult.invalidDataPreview" border stripe max-height="400">
            <el-table-column type="index" label="#" width="60" align="center" />
            <el-table-column label="å¼‚å¸¸æ•°æ®" min-width="200">
              <template slot-scope="{row}">
                <code>{{ row.data }}</code>
              </template>
            </el-table-column>
            <el-table-column label="æ•°æ®é•¿åº¦" width="100" align="center">
              <template slot-scope="{row}">
                {{ row.length }}
              </template>
            </el-table-column>
            <el-table-column label="è¿‡æ»¤åŸå› " width="200">
              <template slot-scope="{row}">
                <el-tag :type="row.reason.includes('è¿‡çŸ­') ? 'warning' : row.reason.includes('è¿‡é•¿') ? 'danger' : 'info'" size="small">
                  {{ row.reason }}
                </el-tag>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>

        <!-- é‡å¤æ•°æ®é¢„è§ˆ -->
        <el-tab-pane :label="`é‡å¤æ•°æ®ï¼ˆå‰20æ¡ï¼Œå…±${formatNumber(cleanResult.duplicateCount)}æ¡ï¼‰`">
          <el-alert
            v-if="!cleanResult.duplicateDataPreview || cleanResult.duplicateDataPreview.length === 0"
            title="æ²¡æœ‰é‡å¤æ•°æ®"
            type="success"
            :closable="false"
            show-icon
          />
          <el-table v-else :data="cleanResult.duplicateDataPreview" border stripe max-height="400">
            <el-table-column type="index" label="#" width="60" align="center" />
            <el-table-column label="é‡å¤æ•°æ®" min-width="200">
              <template slot-scope="{row}">
                <code>{{ row.data }}</code>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>

        <!-- å›½ç å¼‚å¸¸æ•°æ®é¢„è§ˆ -->
        <el-tab-pane :label="`å›½ç å¼‚å¸¸ï¼ˆå‰20æ¡ï¼Œå…±${formatNumber(cleanResult.addedCodeCount)}æ¡ï¼‰`">
          <el-alert
            v-if="!cleanResult.addedCodePreview || cleanResult.addedCodePreview.length === 0"
            title="æ²¡æœ‰å›½ç å¼‚å¸¸æ•°æ®"
            type="success"
            :closable="false"
            show-icon
          />
          <el-table v-else :data="cleanResult.addedCodePreview" border stripe max-height="400">
            <el-table-column type="index" label="#" width="60" align="center" />
            <el-table-column label="åŸå§‹æ•°æ®" width="200">
              <template slot-scope="{row}">
                <code style="color: #909399;">{{ row.original }}</code>
              </template>
            </el-table-column>
            <el-table-column label="ä¿®æ­£å" width="200">
              <template slot-scope="{row}">
                <code :style="row.status === 'å·²ä¿®æ­£' ? 'color: #67C23A; font-weight: bold;' : 'color: #E6A23C;'">{{ row.result }}</code>
              </template>
            </el-table-column>
            <el-table-column label="å¼‚å¸¸åŸå› " width="150" align="center">
              <template slot-scope="{row}">
                <el-tag :type="row.reason === 'ç¼ºå°‘å›½ç ' ? 'warning' : 'danger'" size="small">
                  {{ row.reason }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column label="å¤„ç†çŠ¶æ€" width="120" align="center">
              <template slot-scope="{row}">
                <el-tag :type="row.status === 'å·²ä¿®æ­£' ? 'success' : 'info'" size="small">
                  {{ row.status }}
                </el-tag>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>
      </el-tabs>

      <span slot="footer" class="dialog-footer">
        <el-button @click="cleanResultDialogVisible = false">å…³é—­</el-button>
        <el-button type="success" @click="downloadCleanedFiles">
          <i class="el-icon-download" /> ä¸‹è½½æ‰€æœ‰æ–‡ä»¶
        </el-button>
      </span>
    </el-dialog>

    <!-- å·ç ç”Ÿæˆå¯¹è¯æ¡† -->
    <el-dialog title="å·ç ç”Ÿæˆ" :visible.sync="dialogGenerateNumbers" width="900px">
      <el-alert
        title="åŸºäº Google libphonenumber åº“ç”Ÿæˆç¬¦åˆå›½é™…æ ‡å‡†çš„æ‰‹æœºå·ç "
        type="info"
        :closable="false"
        show-icon
        style="margin-bottom: 20px"
      >
        <div slot="default">
          <p style="margin: 5px 0">âœ” æ”¯æŒå…¨çƒæ‰€æœ‰å›½å®¶</p>
          <p style="margin: 5px 0">âœ” æŒ‰è¿è¥å•†å·æ®µç”Ÿæˆ</p>
          <p style="margin: 5px 0">âœ” è‡ªåŠ¨éªŒè¯å·ç æœ‰æ•ˆæ€§</p>
        </div>
      </el-alert>

      <el-form :model="generateNumbersForm" label-width="120px">
        <el-form-item label="é€‰æ‹©å›½å®¶">
          <el-select
            v-model="generateNumbersForm.countryCode"
            placeholder="è¯·é€‰æ‹©å›½å®¶"
            filterable
            style="width: 100%"
            @change="handleGenerateCountryChange"
          >
            <el-option-group label="çƒ­é—¨å›½å®¶">
              <el-option
                v-for="country in hotCountries"
                :key="country.code"
                :label="`${country.name} (${country.dialCode})`"
                :value="country.code"
              >
                <span style="float: left">{{ country.name }}</span>
                <span style="float: right; color: #8492a6; font-size: 13px">{{ country.dialCode }}</span>
              </el-option>
            </el-option-group>
            <el-option-group label="å…¨éƒ¨å›½å®¶">
              <el-option
                v-for="country in countryList"
                :key="country.code"
                :label="`${country.name} (${country.dialCode})`"
                :value="country.code"
              >
                <span style="float: left">{{ country.name }}</span>
                <span style="float: right; color: #8492a6; font-size: 13px">{{ country.dialCode }}</span>
              </el-option>
            </el-option-group>
          </el-select>
        </el-form-item>

        <el-form-item v-if="generateNumbersForm.countryCode" label="å›½å®¶ä¿¡æ¯">
          <div style="padding: 12px; background: #f5f7fa; border-radius: 4px; border: 1px solid #e4e7ed">
            <el-row :gutter="20">
              <el-col :span="8">
                <div style="margin-bottom: 8px">
                  <span style="color: #909399; font-size: 12px">å›½ç ï¼š</span>
                  <strong>{{ generateNumbersForm.countryInfo.countryCode || '-' }}</strong>
                </div>
              </el-col>
              <el-col :span="8">
                <div style="margin-bottom: 8px">
                  <span style="color: #909399; font-size: 12px">å·ç é•¿åº¦ï¼š</span>
                  <strong>{{ generateNumbersForm.countryInfo.phoneLength || '-' }} ä½</strong>
                </div>
              </el-col>
              <el-col :span="8">
                <div style="margin-bottom: 8px">
                  <span style="color: #909399; font-size: 12px">ç¤ºä¾‹å·ç ï¼š</span>
                  <code style="color: #E6A23C">{{ generateNumbersForm.countryInfo.exampleNumber || '-' }}</code>
                </div>
              </el-col>
            </el-row>
          </div>
        </el-form-item>

        <el-divider content-position="left">è¿è¥å•†é€‰æ‹©ä¸ç”Ÿæˆè®¾ç½®</el-divider>

        <el-alert
          v-if="generateNumbersForm.loadingOperators"
          title="æ­£åœ¨åŠ è½½è¿è¥å•†ä¿¡æ¯..."
          type="info"
          :closable="false"
          show-icon
        />

        <el-form-item v-if="!generateNumbersForm.loadingOperators && generateOperatorList.length > 0" label="é€‰æ‹©è¿è¥å•†">
          <div style="margin-bottom: 15px">
            <el-checkbox-group v-model="generateNumbersForm.selectedOperators" @change="handleGenerateOperatorSelection">
              <el-checkbox
                v-for="operator in generateOperatorList"
                :key="operator.name"
                :label="operator.name"
                style="display: block; margin-bottom: 10px"
              >
                {{ operator.name }} (å·æ®µæ•°: {{ operator.numberSegments.length }}, å¸‚åœºä»½é¢: {{ operator.marketShare }}%)
              </el-checkbox>
            </el-checkbox-group>
          </div>
        </el-form-item>

        <el-alert
          v-if="!generateNumbersForm.loadingOperators && generateOperatorList.length === 0 && generateNumbersForm.countryCode"
          type="warning"
          :closable="false"
        >
          <template slot="title">
            <div style="line-height: 1.8;">
              è¯¥å›½å®¶æš‚æ— è¿è¥å•†é…ç½®æ•°æ®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ 
            </div>
          </template>
        </el-alert>

        <el-form-item v-if="generateNumbersForm.selectedOperators.length > 0" label="ç”Ÿæˆæ•°é‡è®¾ç½®">
          <div
            v-for="opName in generateNumbersForm.selectedOperators"
            :key="opName"
            style="margin-bottom: 15px; padding: 10px; background: #f5f7fa; border-radius: 4px"
          >
            <div style="display: flex; align-items: center; justify-content: space-between">
              <span style="font-weight: 600; color: #303133">{{ opName }}</span>
              <el-input-number
                v-if="generateNumbersForm.operatorCounts[opName]"
                v-model="generateNumbersForm.operatorCounts[opName]"
                :min="1"
                :max="1000000"
                :step="1000"
                placeholder="ç”Ÿæˆæ•°é‡"
                style="width: 180px"
              />
            </div>
          </div>
          <div style="margin-top: 10px; color: #909399; font-size: 12px">
            ğŸ’¡ æç¤ºï¼šè®¾ç½®æ¯ä¸ªè¿è¥å•†éœ€è¦ç”Ÿæˆçš„å·ç æ•°é‡
          </div>
        </el-form-item>

        <el-form-item label="é«˜çº§é€‰é¡¹">
          <el-checkbox v-model="generateNumbersForm.includeCountryCode">åŒ…å«å›½ç </el-checkbox>
          <div style="margin-top: 5px; color: #909399; font-size: 12px">
            é€‰ä¸­åç”Ÿæˆçš„å·ç åŒ…å«å›½é™…åŒºå·ï¼ˆå¦‚ 52xxxxxxxxxxï¼‰ï¼Œå¦åˆ™ä»…ç”Ÿæˆæœ¬åœ°å·ç ï¼ˆå¦‚ xxxxxxxxxxï¼‰
          </div>
        </el-form-item>
      </el-form>

      <span slot="footer" class="dialog-footer">
        <el-button @click="dialogGenerateNumbers = false">å–æ¶ˆ</el-button>
        <el-button type="warning" :loading="processing" @click="confirmGenerateNumbers">
          <i class="el-icon-connection" /> å¼€å§‹ç”Ÿæˆ
        </el-button>
      </span>
    </el-dialog>

    <!-- å·ç ç”Ÿæˆç»“æœå¯¹è¯æ¡† -->
    <el-dialog title="å·ç ç”Ÿæˆç»“æœ" :visible.sync="generateResultDialogVisible" width="900px">
      <el-alert
        title="å·ç ç”Ÿæˆå®Œæˆï¼"
        type="success"
        :closable="false"
        show-icon
        style="margin-bottom: 20px"
      />

      <div class="clean-result-summary">
        <el-row :gutter="20">
          <el-col :span="6">
            <div class="stat-card">
              <div class="stat-label">å›½å®¶</div>
              <div class="stat-value" style="color: #409EFF; font-size: 20px">{{ generateResult.regionCode }}</div>
            </div>
          </el-col>
          <el-col :span="6">
            <div class="stat-card">
              <div class="stat-label">è¿è¥å•†æ•°</div>
              <div class="stat-value" style="color: #67C23A">{{ generateResult.operatorCount }}</div>
            </div>
          </el-col>
          <el-col :span="6">
            <div class="stat-card">
              <div class="stat-label">æ€»ç”Ÿæˆæ•°</div>
              <div class="stat-value" style="color: #E6A23C">{{ formatNumber(generateResult.totalCount) }}</div>
            </div>
          </el-col>
          <el-col :span="6">
            <div class="stat-card">
              <div class="stat-label">æˆåŠŸç‡</div>
              <div class="stat-value" style="color: #67C23A; font-size: 20px">100%</div>
            </div>
          </el-col>
        </el-row>
      </div>

      <el-divider content-position="left">è¿è¥å•†ç”Ÿæˆç»“æœ</el-divider>

      <el-table :data="generateResult.operators" border stripe>
        <el-table-column type="index" label="#" width="60" align="center" />
        <el-table-column prop="operatorName" label="è¿è¥å•†" width="200" />
        <el-table-column label="ç”Ÿæˆæ•°é‡" width="150" align="center">
          <template slot-scope="{row}">
            <el-tag type="success">{{ formatNumber(row.count) }} æ¡</el-tag>
          </template>
        </el-table-column>
        <el-table-column label="æ“ä½œ" align="center">
          <template slot-scope="{row}">
            <el-button
              type="primary"
              size="small"
              icon="el-icon-download"
              @click="downloadFile(row.downloadPath)"
            >
              ä¸‹è½½
            </el-button>
          </template>
        </el-table-column>
      </el-table>

      <el-divider content-position="left">æ•°æ®é¢„è§ˆï¼ˆå‰20æ¡ï¼‰</el-divider>

      <el-table :data="generateResult.preview" border stripe max-height="400">
        <el-table-column type="index" label="#" width="60" align="center" />
        <el-table-column label="ç”Ÿæˆçš„å·ç " min-width="200">
          <template slot-scope="{row}">
            <code style="color: #67C23A; font-weight: bold">{{ row }}</code>
          </template>
        </el-table-column>
      </el-table>

      <span slot="footer" class="dialog-footer">
        <el-button @click="generateResultDialogVisible = false">å…³é—­</el-button>
        <el-button type="success" icon="el-icon-download" @click="downloadFile(generateResult.mergedDownloadPath)">
          ä¸‹è½½åˆå¹¶æ–‡ä»¶
        </el-button>
      </span>
    </el-dialog>
  </div>
</template>

<script>
import { getToken } from '@/utils/auth'
import request from '@/utils/request'
import { getOperatorsByCountry } from '@/data/operators'
import { countryList } from '@/data/countries'
import { createTask } from '@/api/dataProcessing'

export default {
  name: 'DataProcessing',
  data() {
    return {
      loading: false,
      processing: false,
      fileList: [],
      selectedFiles: [],

      // ä¸Šä¼ é…ç½®
      uploadDialogVisible: false,
      uploadAction: process.env.VUE_APP_BASE_API + '/api/data-processing/upload',
      uploadHeaders: {
        Authorization: 'Bearer ' + getToken()
      },
      uploadFileList: [],

      // å¯¹è¯æ¡†
      dialogDeduplicate: false,
      dialogRemoveCode: false,
      dialogAddCode: false,
      dialogCompare: false,
      dialogExtractOperator: false,
      dialogExtractCount: false,
      previewDialogVisible: false,
      dialogCleanData: false,
      cleanResultDialogVisible: false,
      dialogGenerateNumbers: false, // å·ç ç”Ÿæˆå¯¹è¯æ¡†
      generateResultDialogVisible: false, // ç”Ÿæˆç»“æœå¯¹è¯æ¡†

      // é¢„è§ˆæ•°æ®
      previewData: {
        filename: '',
        originalCount: 0,
        finalCount: 0,
        duplicateCount: 0,
        preview: [],
        codeDetection: null
      },

      // è¡¨å•
      deduplicateForm: {
        fileIds: [],
        processMode: 'immediate' // immediate | background
      },
      removeCodeForm: {
        fileIds: [],
        countryCode: '',
        processMode: 'immediate' // immediate | background
      },
      addCodeForm: {
        fileIds: [],
        countryCode: '',
        countryCodePrefix: '',
        specificCountry: '', // å…±ç”¨å›½ç æ—¶é€‰æ‹©çš„å…·ä½“å›½å®¶ä»£ç 
        processMode: 'immediate' // immediate | background
      },
      showAddCodeCountrySelector: false, // æ˜¯å¦æ˜¾ç¤ºå…±ç”¨å›½ç çš„äºŒçº§é€‰æ‹©å™¨
      addCodeCountryOptions: [], // å…±ç”¨å›½ç çš„å›½å®¶é€‰é¡¹åˆ—è¡¨
      compareForm: {
        file1Id: null,
        file2Id: null,
        mode: 'diff'
      },
      extractOperatorForm: {
        fileId: null,
        countryCode: '',
        selectedOperators: [], // é€‰ä¸­çš„è¿è¥å•†åç§°åˆ—è¡¨
        operatorLimits: {}, // å­˜å‚¨æ¯ä¸ªè¿è¥å•†çš„é™åˆ¶è®¾ç½®: { operatorName: { enabled: false, limit: 10000 } }
        analyzing: false // æ˜¯å¦æ­£åœ¨åˆ†æ
      },
      extractCountForm: {
        fileIds: [],
        startFrom: 0,
        count: 1000
      },
      cleanDataForm: {
        fileIds: [],
        countryCode: '',
        specificCountry: '', // å…±ç”¨å›½ç æ—¶é€‰æ‹©çš„å…·ä½“å›½å®¶ä»£ç 
        options: ['autoAddCode', 'autoDeduplicate', 'removeInvalid']
      },
      showCleanDataCountrySelector: false, // æ˜¯å¦æ˜¾ç¤ºå…±ç”¨å›½ç çš„äºŒçº§é€‰æ‹©å™¨
      cleanDataCountryOptions: [], // å…±ç”¨å›½ç çš„å›½å®¶é€‰é¡¹åˆ—è¡¨
      cleanResult: {
        originalCount: 0,
        finalCount: 0,
        invalidCount: 0,
        duplicateCount: 0,
        addedCodeCount: 0,
        skippedCount: 0, // å·²æœ‰å›½ç è·³è¿‡çš„æ•°é‡
        steps: [],
        preview: [],
        // æ–°å¢ï¼šè¯¦ç»†é¢„è§ˆæ•°æ®
        invalidDataPreview: [], // X - å¼‚å¸¸æ•°æ®é¢„è§ˆï¼ˆæ­¥éª¤1è¿‡æ»¤æ‰çš„ï¼‰
        duplicateDataPreview: [], // Y - é‡å¤æ•°æ®é¢„è§ˆï¼ˆæ­¥éª¤2å»é™¤çš„ï¼‰
        addedCodePreview: [], // Z - å›½ç å¼‚å¸¸æ•°æ®é¢„è§ˆï¼ˆæ­¥éª¤3ä¿®æ­£çš„ï¼‰
        removedCodePreview: [] // å»é™¤å›½ç çš„æ•°æ®é¢„è§ˆï¼ˆé¢„ç•™ï¼‰
      },
      cleanedFiles: [],

      // å·ç ç”Ÿæˆè¡¨å•
      generateNumbersForm: {
        countryCode: '',
        selectedOperators: [],
        operatorCounts: {}, // { operatorName: count }
        includeCountryCode: true,
        countryInfo: {},
        loadingOperators: false
      },
      generateOperatorList: [], // å½“å‰å›½å®¶çš„è¿è¥å•†åˆ—è¡¨
      generateResult: {
        regionCode: '',
        totalCount: 0,
        operatorCount: 0,
        operators: [],
        mergedDownloadPath: '',
        preview: []
      },

      // æ•°æ®
      countryList: [],
      operatorList: [],
      hotCountries: [
        { dialCode: '+86', name: 'ä¸­å›½', code: 'CN' },
        { dialCode: '+1', name: 'ç¾å›½', code: 'US' },
        { dialCode: '+44', name: 'è‹±å›½', code: 'GB' },
        { dialCode: '+81', name: 'æ—¥æœ¬', code: 'JP' },
        { dialCode: '+82', name: 'éŸ©å›½', code: 'KR' },
        { dialCode: '+65', name: 'æ–°åŠ å¡', code: 'SG' },
        { dialCode: '+60', name: 'é©¬æ¥è¥¿äºš', code: 'MY' },
        { dialCode: '+66', name: 'æ³°å›½', code: 'TH' },
        { dialCode: '+84', name: 'è¶Šå—', code: 'VN' },
        { dialCode: '+62', name: 'å°åº¦å°¼è¥¿äºš', code: 'ID' },
        { dialCode: '+63', name: 'è²å¾‹å®¾', code: 'PH' },
        { dialCode: '+91', name: 'å°åº¦', code: 'IN' },
        { dialCode: '+7', name: 'ä¿„ç½—æ–¯', code: 'RU' },
        { dialCode: '+61', name: 'æ¾³å¤§åˆ©äºš', code: 'AU' },
        { dialCode: '+64', name: 'æ–°è¥¿å…°', code: 'NZ' },
        { dialCode: '+49', name: 'å¾·å›½', code: 'DE' },
        { dialCode: '+52', name: 'å¢¨è¥¿å“¥', code: 'MX' }
      ]
    }
  },
  watch: {
    // ç›‘å¬å›½å®¶é€‰æ‹©ï¼Œè‡ªåŠ¨å¡«å……å›½ç ï¼ˆå›½é™…ç”µè¯åŒºå·ï¼‰
    'addCodeForm.countryCode'(newVal) {
      if (newVal) {
        // newVal ç°åœ¨æ˜¯ dialCodeï¼ˆå¦‚ +52ï¼‰ï¼Œç›´æ¥ä½¿ç”¨
        this.addCodeForm.countryCodePrefix = newVal
      } else {
        this.addCodeForm.countryCodePrefix = ''
      }
    }
  },
  created() {
    this.fetchFileList()
    this.countryList = countryList
  },
  methods: {
    // è·å–å›½å®¶è¿è¥å•†æ•°æ®ï¼ˆåŒ…å«sharedSegmentsæ ‡è®°ï¼‰
    getCountryOperatorData(countryCode) {
      const { operatorData } = require('@/data/operators')
      return operatorData[countryCode] || null
    },

    // è·å–å›½å®¶åç§°
    getCountryName(countryCode) {
      const country = this.countryList.find(c => c.code === countryCode)
      return country ? country.name : countryCode
    },

    // æ‰“å¼€åŠŸèƒ½æ¨¡å—
    openModule(moduleName) {
      switch (moduleName) {
        case 'cleanData':
          this.cleanDataForm.fileIds = this.selectedFiles.map(f => f.id)
          this.cleanDataForm.countryCode = ''
          this.cleanDataForm.options = ['autoAddCode', 'autoDeduplicate', 'removeInvalid']
          this.dialogCleanData = true
          break
        case 'removeCode':
          this.removeCodeForm.fileIds = this.selectedFiles.map(f => f.id)
          this.removeCodeForm.countryCode = ''
          this.dialogRemoveCode = true
          break
        case 'deduplicate':
          this.deduplicateForm.fileIds = this.selectedFiles.map(f => f.id)
          this.dialogDeduplicate = true
          break
        case 'addCode':
          this.addCodeForm.fileIds = this.selectedFiles.map(f => f.id)
          this.addCodeForm.countryCode = ''
          this.addCodeForm.countryCodePrefix = ''
          this.dialogAddCode = true
          break
        case 'compare':
          this.compareForm.file1Id = null
          this.compareForm.file2Id = null
          this.compareForm.mode = 'diff'
          this.dialogCompare = true
          break
        case 'extractOperator':
          this.extractOperatorForm.fileId = this.selectedFiles.length > 0 ? this.selectedFiles[0].id : null
          this.extractOperatorForm.countryCode = ''
          this.extractOperatorForm.selectedOperators = []
          this.extractOperatorForm.operatorLimits = {}
          this.operatorList = []
          this.dialogExtractOperator = true
          break
        case 'extractCount':
          this.extractCountForm.fileIds = this.selectedFiles.map(f => f.id)
          this.extractCountForm.startFrom = 0
          this.extractCountForm.count = 1000
          this.dialogExtractCount = true
          break
        case 'generateNumbers':
          // æ‰“å¼€å·ç ç”Ÿæˆå¯¹è¯æ¡†
          this.generateNumbersForm.countryCode = ''
          this.generateNumbersForm.selectedOperators = []
          this.generateNumbersForm.operatorCounts = {}
          this.generateNumbersForm.includeCountryCode = true
          this.generateNumbersForm.countryInfo = {}
          this.generateOperatorList = []
          this.dialogGenerateNumbers = true
          break
      }
    },

    // æ–‡ä»¶é€‰æ‹©å˜åŒ–
    handleSelectionChange(selection) {
      this.selectedFiles = selection
    },

    // æ˜¾ç¤ºä¸Šä¼ å¯¹è¯æ¡†
    showUploadDialog() {
      this.uploadDialogVisible = true
      this.uploadFileList = []
    },

    async fetchFileList() {
      this.loading = true
      try {
        const response = await request({
          url: '/api/data-processing/files',
          method: 'get'
        })
        this.fileList = response.data
      } catch (error) {
        this.$message.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message)
      } finally {
        this.loading = false
      }
    },

    beforeUpload(file) {
      const isValidSize = file.size / 1024 / 1024 < 100
      if (!isValidSize) {
        this.$message.error('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 100MB!')
        return false
      }
      const isTxt = file.name.toLowerCase().endsWith('.txt')
      if (!isTxt) {
        this.$message.error('åªèƒ½ä¸Šä¼  TXT æ ¼å¼æ–‡ä»¶!')
        return false
      }
      return true
    },

    handleUploadSuccess(response) {
      if (response.success) {
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        this.$message.success(response.message)

        // å¦‚æœæœ‰è¿‡æ»¤çš„å¼‚å¸¸æ•°æ®ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
        if (response.data.invalidCount > 0) {
          this.$notify({
            title: 'ä¸Šä¼ å®Œæˆ',
            message: `åŸå§‹æ•°æ®ï¼š${this.formatNumber(response.data.originalCount)}æ¡<br>æœ‰æ•ˆæ•°æ®ï¼š${this.formatNumber(response.data.lineCount)}æ¡<br>è¿‡æ»¤å¼‚å¸¸ï¼š${this.formatNumber(response.data.invalidCount)}æ¡`,
            type: 'success',
            dangerouslyUseHTMLString: true,
            duration: 5000
          })
        }

        // å»¶è¿Ÿåˆ·æ–°æ–‡ä»¶åˆ—è¡¨ï¼Œç¡®ä¿æ•°æ®å·²ä¿å­˜
        setTimeout(() => {
          this.fetchFileList()
        }, 500)
      } else {
        this.$message.error('ä¸Šä¼ å¤±è´¥: ' + response.message)
      }
    },

    handleUploadError(error) {
      this.$message.error('ä¸Šä¼ å¤±è´¥: ' + error.message)
    },

    // ä¸Šä¼ å¯¹è¯æ¡†å…³é—­æ—¶åˆ·æ–°åˆ—è¡¨
    handleUploadDialogClose() {
      // å…³é—­å¯¹è¯æ¡†æ—¶åˆ·æ–°æ–‡ä»¶åˆ—è¡¨ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°æ•°æ®
      this.fetchFileList()
      // æ¸…ç©ºä¸Šä¼ åˆ—è¡¨
      this.uploadFileList = []
    },

    // é¢„è§ˆæ–‡ä»¶æ•°æ®
    async handlePreview(file) {
      this.loading = true
      try {
        const response = await request({
          url: `/api/data-processing/file/${file.id}/preview`,
          method: 'get'
        })

        // è®¾ç½®é¢„è§ˆæ•°æ®
        this.previewData = {
          filename: response.data.filename,
          originalCount: response.data.lineCount,
          finalCount: response.data.lineCount,
          duplicateCount: 0,
          preview: response.data.preview,
          codeDetection: response.data.codeDetection
        }

        this.previewDialogVisible = true
      } catch (error) {
        this.$message.error('è·å–é¢„è§ˆæ•°æ®å¤±è´¥: ' + (error.response?.data?.message || error.message))
      } finally {
        this.loading = false
      }
    },

    // æ•°æ®å»é‡
    async confirmDeduplicate() {
      if (!this.deduplicateForm.fileIds || this.deduplicateForm.fileIds.length === 0) {
        this.$message.warning('è¯·é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶')
        return
      }

      this.processing = true
      try {
        // åå°é˜Ÿåˆ—æ¨¡å¼
        if (this.deduplicateForm.processMode === 'background') {
          for (const fileId of this.deduplicateForm.fileIds) {
            const file = this.fileList.find(f => f.id === fileId)
            await createTask({
              taskType: 'deduplicate',
              taskName: `å»é‡: ${file ? file.original_filename : fileId}`,
              params: { fileId }
            })
          }

          this.$message.success(`å·²åˆ›å»º ${this.deduplicateForm.fileIds.length} ä¸ªåå°ä»»åŠ¡ï¼Œè¯·åœ¨"å¤„ç†ä»»åŠ¡"é¡µé¢æŸ¥çœ‹è¿›åº¦`)
          
          // æç¤ºè·³è½¬
          this.$confirm('æ˜¯å¦è·³è½¬åˆ°"å¤„ç†ä»»åŠ¡"é¡µé¢æŸ¥çœ‹è¿›åº¦?', 'æç¤º', {
            confirmButtonText: 'ç«‹å³è·³è½¬',
            cancelButtonText: 'ç¨åæŸ¥çœ‹',
            type: 'info'
          }).then(() => {
            this.$router.push('/data/processing-tasks')
          }).catch(() => {})

          this.dialogDeduplicate = false
          this.deduplicateForm.fileIds = []
          return
        }

        // ç«‹å³å¤„ç†æ¨¡å¼
        const results = []
        for (const fileId of this.deduplicateForm.fileIds) {
          const response = await request({
            url: '/api/data-processing/deduplicate',
            method: 'post',
            data: { fileId }
          })
          results.push(response.data)
        }

        this.$message.success(`å¤„ç†å®Œæˆï¼å…±å¤„ç† ${results.length} ä¸ªæ–‡ä»¶`)

        // ä¸‹è½½æ‰€æœ‰ç»“æœ
        results.forEach(result => {
          this.downloadFile(result.downloadPath)
        })

        this.dialogDeduplicate = false
        this.deduplicateForm.fileIds = []
      } catch (error) {
        this.$message.error('å¤„ç†å¤±è´¥: ' + error.message)
      } finally {
        this.processing = false
      }
    },

    // å»é™¤å›½ç 
    async confirmRemoveCode() {
      if (!this.removeCodeForm.fileIds || this.removeCodeForm.fileIds.length === 0) {
        this.$message.warning('è¯·é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶')
        return
      }

      this.processing = true
      try {
        // åå°é˜Ÿåˆ—æ¨¡å¼
        if (this.removeCodeForm.processMode === 'background') {
          for (const fileId of this.removeCodeForm.fileIds) {
            const file = this.fileList.find(f => f.id === fileId)
            await createTask({
              taskType: 'remove_code',
              taskName: `å»é™¤å›½ç : ${file ? file.original_filename : fileId}`,
              params: {
                fileId,
                countryCode: this.removeCodeForm.countryCode
              }
            })
          }

          this.$message.success(`å·²åˆ›å»º ${this.removeCodeForm.fileIds.length} ä¸ªåå°ä»»åŠ¡ï¼Œè¯·åœ¨"å¤„ç†ä»»åŠ¡"é¡µé¢æŸ¥çœ‹è¿›åº¦`)
          
          this.$confirm('æ˜¯å¦è·³è½¬åˆ°"å¤„ç†ä»»åŠ¡"é¡µé¢æŸ¥çœ‹è¿›åº¦?', 'æç¤º', {
            confirmButtonText: 'ç«‹å³è·³è½¬',
            cancelButtonText: 'ç¨åæŸ¥çœ‹',
            type: 'info'
          }).then(() => {
            this.$router.push('/data/processing-tasks')
          }).catch(() => {})

          this.dialogRemoveCode = false
          this.removeCodeForm.fileIds = []
          this.removeCodeForm.countryCode = ''
          return
        }

        // ç«‹å³å¤„ç†æ¨¡å¼
        const results = []
        for (const fileId of this.removeCodeForm.fileIds) {
          const response = await request({
            url: '/api/data-processing/remove-country-code',
            method: 'post',
            data: {
              fileId,
              countryCode: this.removeCodeForm.countryCode
            }
          })
          results.push(response.data)
        }

        this.$message.success(`å¤„ç†å®Œæˆï¼å…±å¤„ç† ${results.length} ä¸ªæ–‡ä»¶`)

        // ä¸‹è½½æ‰€æœ‰ç»“æœ
        results.forEach(result => {
          this.downloadFile(result.downloadPath)
        })

        this.dialogRemoveCode = false
        this.removeCodeForm.fileIds = []
        this.removeCodeForm.countryCode = ''
      } catch (error) {
        this.$message.error('å¤„ç†å¤±è´¥: ' + error.message)
      } finally {
        this.processing = false
      }
    },

    // å¢åŠ å›½ç 
    async confirmAddCode() {
      if (!this.addCodeForm.fileIds || this.addCodeForm.fileIds.length === 0) {
        this.$message.warning('è¯·é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶')
        return
      }
      if (!this.addCodeForm.countryCode) {
        this.$message.warning('è¯·é€‰æ‹©å›½å®¶')
        return
      }

      this.processing = true
      try {
        // å»æ‰å›½ç ä¸­çš„ + å·ï¼Œåªä¿ç•™æ•°å­—
        const countryCodeNumber = this.addCodeForm.countryCode.replace(/^\+/, '')

        // åå°é˜Ÿåˆ—æ¨¡å¼
        if (this.addCodeForm.processMode === 'background') {
          for (const fileId of this.addCodeForm.fileIds) {
            const file = this.fileList.find(f => f.id === fileId)
            await createTask({
              taskType: 'add_code',
              taskName: `å¢åŠ å›½ç : ${file ? file.original_filename : fileId}`,
              params: {
                fileId,
                countryCode: countryCodeNumber
              }
            })
          }

          this.$message.success(`å·²åˆ›å»º ${this.addCodeForm.fileIds.length} ä¸ªåå°ä»»åŠ¡ï¼Œè¯·åœ¨"å¤„ç†ä»»åŠ¡"é¡µé¢æŸ¥çœ‹è¿›åº¦`)
          
          this.$confirm('æ˜¯å¦è·³è½¬åˆ°"å¤„ç†ä»»åŠ¡"é¡µé¢æŸ¥çœ‹è¿›åº¦?', 'æç¤º', {
            confirmButtonText: 'ç«‹å³è·³è½¬',
            cancelButtonText: 'ç¨åæŸ¥çœ‹',
            type: 'info'
          }).then(() => {
            this.$router.push('/data/processing-tasks')
          }).catch(() => {})

          this.dialogAddCode = false
          this.addCodeForm.fileIds = []
          this.addCodeForm.countryCode = ''
          this.addCodeForm.countryCodePrefix = ''
          return
        }

        // ç«‹å³å¤„ç†æ¨¡å¼
        const results = []
        for (const fileId of this.addCodeForm.fileIds) {
          const response = await request({
            url: '/api/data-processing/add-country-code',
            method: 'post',
            data: {
              fileId,
              countryCode: countryCodeNumber
            }
          })
          results.push(response.data)
        }

        this.$message.success(`å¤„ç†å®Œæˆï¼å…±å¤„ç† ${results.length} ä¸ªæ–‡ä»¶`)

        // ä¸‹è½½æ‰€æœ‰ç»“æœ
        results.forEach(result => {
          this.downloadFile(result.downloadPath)
        })

        this.dialogAddCode = false
        this.addCodeForm.fileIds = []
        this.addCodeForm.countryCode = ''
        this.addCodeForm.countryCodePrefix = ''
      } catch (error) {
        this.$message.error('å¤„ç†å¤±è´¥: ' + error.message)
      } finally {
        this.processing = false
      }
    },

    // æ•°æ®å¯¹æ¯”
    async confirmCompare() {
      if (!this.compareForm.file1Id || !this.compareForm.file2Id) {
        this.$message.warning('è¯·é€‰æ‹©ä¸¤ä¸ªæ–‡ä»¶è¿›è¡Œå¯¹æ¯”')
        return
      }
      if (this.compareForm.file1Id === this.compareForm.file2Id) {
        this.$message.warning('è¯·é€‰æ‹©ä¸åŒçš„æ–‡ä»¶')
        return
      }

      this.processing = true
      try {
        const response = await request({
          url: '/api/data-processing/compare',
          method: 'post',
          data: {
            file1Id: this.compareForm.file1Id,
            file2Id: this.compareForm.file2Id,
            mode: this.compareForm.mode
          }
        })
        this.$message.success(`å¯¹æ¯”å®Œæˆï¼ç»“æœ${response.data.resultCount}è¡Œ`)
        this.downloadFile(response.data.downloadPath)
        this.dialogCompare = false
      } catch (error) {
        this.$message.error('å¯¹æ¯”å¤±è´¥: ' + error.message)
      } finally {
        this.processing = false
      }
    },

    handleCountryChange(countryCode) {
      // æ¸…ç©ºä¹‹å‰çš„é€‰æ‹©
      this.extractOperatorForm.selectedOperators = []
      this.extractOperatorForm.operatorLimits = {}
      this.operatorList = []

      if (!countryCode || !this.extractOperatorForm.fileId) {
        return
      }

      // åˆ†ææ–‡ä»¶ä¸­çš„è¿è¥å•†åˆ†å¸ƒ
      this.analyzeOperatorDistribution()
    },

    // å¤„ç†æ–‡ä»¶é€‰æ‹©å˜åŒ–
    handleFileChange(fileId) {
      // æ¸…ç©ºä¹‹å‰çš„é€‰æ‹©
      this.extractOperatorForm.selectedOperators = []
      this.extractOperatorForm.operatorLimits = {}
      this.operatorList = []

      if (!fileId || !this.extractOperatorForm.countryCode) {
        return
      }

      // åˆ†ææ–‡ä»¶ä¸­çš„è¿è¥å•†åˆ†å¸ƒ
      this.analyzeOperatorDistribution()
    },

    // åˆ†ææ–‡ä»¶çš„è¿è¥å•†åˆ†å¸ƒ
    async analyzeOperatorDistribution() {
      if (!this.extractOperatorForm.fileId || !this.extractOperatorForm.countryCode) {
        return
      }

      // æ£€æŸ¥æ˜¯å¦ä¸ºå…±äº«å·æ®µçš„å›½å®¶
      const countryData = this.getCountryOperatorData(this.extractOperatorForm.countryCode)
      if (countryData && countryData.sharedSegments) {
        this.$alert(
          `<div style="line-height: 1.8;">
            <strong>âš ï¸ è¯¥å›½å®¶è¿è¥å•†å…±äº«å·æ®µæ± </strong><br/>
            <div style="margin-top: 10px; font-size: 13px;">
              ç”±äº${this.getCountryName(this.extractOperatorForm.countryCode)}çš„æ‰€æœ‰è¿è¥å•†å…±äº«ç›¸åŒçš„å·æ®µæ± ï¼Œ<br/>
              ç³»ç»Ÿå°†æŒ‰å¸‚åœºä»½é¢è¿›è¡Œæ¨¡æ‹Ÿåˆ†ç»„ï¼Œ<strong>ä¸ä»£è¡¨å·ç çš„çœŸå®è¿è¥å•†å½’å±</strong>ã€‚<br/><br/>
              <strong style="color: #E6A23C;">å¼ºçƒˆå»ºè®®ï¼š</strong>ä½¿ç”¨"æŒ‰æ¡æ•°æå–"åŠŸèƒ½ä»£æ›¿æŒ‰è¿è¥å•†æå–
            </div>
          </div>`,
          'è¿è¥å•†è¯†åˆ«é™åˆ¶',
          {
            dangerouslyUseHTMLString: true,
            confirmButtonText: 'ç»§ç»­ä½¿ç”¨æ¨¡æ‹Ÿåˆ†ç»„',
            cancelButtonText: 'åˆ‡æ¢åˆ°æŒ‰æ¡æ•°æå–',
            showCancelButton: true,
            type: 'warning'
          }
        ).then(() => {
          // ç”¨æˆ·é€‰æ‹©ç»§ç»­ï¼Œæ‰§è¡Œåˆ†æ
          this.performOperatorAnalysis()
        }).catch(() => {
          // ç”¨æˆ·é€‰æ‹©åˆ‡æ¢åŠŸèƒ½
          this.dialogExtractOperator = false
          this.$nextTick(() => {
            this.openModule('extractCount')
          })
        })
        return
      }

      // æ­£å¸¸å›½å®¶ï¼Œç›´æ¥åˆ†æ
      this.performOperatorAnalysis()
    },

    // æ‰§è¡Œè¿è¥å•†åˆ†æï¼ˆä»analyzeOperatorDistributionåˆ†ç¦»å‡ºæ¥ï¼‰
    async performOperatorAnalysis() {
      // è·å–å›½å®¶çš„æ‰€æœ‰è¿è¥å•†
      const allOperators = getOperatorsByCountry(this.extractOperatorForm.countryCode)
      if (allOperators.length === 0) {
        this.$message.warning('è¯¥å›½å®¶æš‚æ— è¿è¥å•†æ•°æ®')
        return
      }

      // è·å–å›½ç 
      const country = this.countryList.find(c => c.code === this.extractOperatorForm.countryCode)
      const countryCode = country ? country.dialCode.replace(/^\+/, '') : null

      this.extractOperatorForm.analyzing = true
      try {
        const response = await request({
          url: '/api/data-processing/analyze-operator-distribution',
          method: 'post',
          data: {
            fileId: this.extractOperatorForm.fileId,
            countryCode: countryCode,
            operators: allOperators
          }
        })

        const { totalCount, distribution, unmatchedCount } = response.data

        // æ ¹æ®å®é™…åˆ†æç»“æœè®¾ç½®è¿è¥å•†åˆ—è¡¨
        if (distribution.length === 0) {
          // é’ˆå¯¹ç¾å›½æ•°æ®ç»™å‡ºç‰¹æ®Šæç¤º
          if (this.extractOperatorForm.countryCode === 'US') {
            this.$message({
              type: 'warning',
              duration: 8000,
              dangerouslyUseHTMLString: true,
              message: '<div style="line-height: 1.6;">' +
                '<strong>æ–‡ä»¶ä¸­æœªæ£€æµ‹åˆ°ç¾å›½è¿è¥å•†æ•°æ®</strong><br/>' +
                'å¯èƒ½çš„åŸå› ï¼š<br/>' +
                '1. å·ç æ ¼å¼ä¸æ­£ç¡®ï¼ˆç¾å›½å·ç æ ¼å¼ï¼š1+åŒºå·+7ä½å·ç ï¼Œå…±11ä½ï¼‰<br/>' +
                '2. ç¼ºå°‘åŒºå·ï¼ˆç¾å›½å·ç å¿…é¡»åŒ…å«3ä½åŒºå·ï¼‰<br/>' +
                '3. åŒºå·ä¸åœ¨é…ç½®èŒƒå›´å†…<br/><br/>' +
                '<strong>å»ºè®®ï¼š</strong><br/>' +
                'â€¢ ä½¿ç”¨"æŒ‰æ¡æ•°æå–"åŠŸèƒ½ä»£æ›¿æŒ‰è¿è¥å•†æå–<br/>' +
                'â€¢ ç¡®è®¤å·ç æ ¼å¼ä¸ºï¼š1+åŒºå·(3ä½)+å·ç (7ä½)<br/>' +
                'â€¢ æ£€æŸ¥æ–‡ä»¶æ•°æ®é¢„è§ˆç¡®è®¤æ ¼å¼æ­£ç¡®æ€§' +
                '</div>'
            })
          } else {
            this.$message.warning('æ–‡ä»¶ä¸­æœªæ£€æµ‹åˆ°ä»»ä½•è¿è¥å•†æ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶å†…å®¹å’Œå›½å®¶é€‰æ‹©æ˜¯å¦æ­£ç¡®')
          }
          this.operatorList = []
          return
        }

        // æ„å»ºè¿è¥å•†åˆ—è¡¨ï¼Œæ˜¾ç¤ºå®é™…æ•°é‡å’Œç™¾åˆ†æ¯”
        this.operatorList = distribution.map(d => {
          const percentage = ((d.count / totalCount) * 100).toFixed(1)
          return {
            name: d.name,
            numberSegments: d.numberSegments,
            count: d.count,
            percentage: percentage,
            displayText: `${d.name} (æ•°é‡: ${this.formatNumber(d.count)}, å æ¯”: ${percentage}%)`
          }
        })

        // å¦‚æœæœ‰æœªåŒ¹é…çš„æ•°æ®ï¼Œä¹Ÿæ˜¾ç¤ºå‡ºæ¥
        if (unmatchedCount > 0) {
          const percentage = ((unmatchedCount / totalCount) * 100).toFixed(1)
          const analysisMethod = response.data.analysisMethod || 'unknown'
          const methodText = analysisMethod === 'awesome-phonenumber'
            ? 'ä½¿ç”¨ Google libphonenumber åº“è¿›è¡Œæ™ºèƒ½åˆ†æ'
            : 'ä½¿ç”¨å·æ®µåŒ¹é…'

          // ç¾å›½æ•°æ®ç‰¹æ®Šæç¤º
          if (this.extractOperatorForm.countryCode === 'US') {
            this.$message({
              type: 'info',
              duration: 8000,
              dangerouslyUseHTMLString: true,
              message: `<div style="line-height: 1.6;">
                <strong>åˆ†æå®Œæˆï¼</strong><br/>
                æ£€æµ‹åˆ° ${distribution.length} ä¸ªè¿è¥å•†ï¼Œå¦æœ‰ ${this.formatNumber(unmatchedCount)} æ¡ (${percentage}%) æœªåŒ¹é…<br/>
                <span style="color: #67C23A;">âœ“ åˆ†ææ–¹æ³•ï¼š${methodText}</span><br/>
                <span style="color: #E6A23C;">âš ï¸ æ³¨æ„ï¼šç¾å›½è¿è¥å•†å…±äº«ç›¸åŒçš„åŒºå·æ± ï¼Œæ­¤åˆ†é…ä»…æŒ‰åŒºå·è¿›è¡Œæ¨¡æ‹Ÿåˆ†ç»„ï¼Œä¸ä»£è¡¨çœŸå®è¿è¥å•†å½’å±</span>
              </div>`
            })
          } else {
            this.$message({
              type: 'info',
              duration: 6000,
              dangerouslyUseHTMLString: true,
              message: `<div style="line-height: 1.6;">
                <strong>åˆ†æå®Œæˆï¼</strong><br/>
                æ£€æµ‹åˆ° ${distribution.length} ä¸ªè¿è¥å•†ï¼Œå¦æœ‰ ${this.formatNumber(unmatchedCount)} æ¡ (${percentage}%) æœªåŒ¹é…<br/>
                <span style="color: #67C23A;">âœ“ åˆ†ææ–¹æ³•ï¼š${methodText}</span>
              </div>`
            })
          }
        } else {
          const analysisMethod = response.data.analysisMethod || 'unknown'
          const methodText = analysisMethod === 'awesome-phonenumber'
            ? 'ä½¿ç”¨ Google libphonenumber åº“è¿›è¡Œæ™ºèƒ½åˆ†æ'
            : 'ä½¿ç”¨å·æ®µåŒ¹é…'

          if (this.extractOperatorForm.countryCode === 'US') {
            this.$message({
              type: 'success',
              duration: 6000,
              dangerouslyUseHTMLString: true,
              message: `<div style="line-height: 1.6;">
                åˆ†æå®Œæˆï¼æ£€æµ‹åˆ° ${distribution.length} ä¸ªè¿è¥å•†<br/>
                <span style="color: #67C23A;">âœ“ åˆ†ææ–¹æ³•ï¼š${methodText}</span><br/>
                <span style="color: #E6A23C;">âš ï¸ æ³¨æ„ï¼šç¾å›½è¿è¥å•†å…±äº«ç›¸åŒçš„åŒºå·æ± ï¼Œæ­¤åˆ†é…ä»…æŒ‰åŒºå·è¿›è¡Œæ¨¡æ‹Ÿåˆ†ç»„ï¼Œä¸ä»£è¡¨çœŸå®è¿è¥å•†å½’å±</span>
              </div>`
            })
          } else {
            this.$message({
              type: 'success',
              duration: 5000,
              dangerouslyUseHTMLString: true,
              message: `<div style="line-height: 1.6;">
                åˆ†æå®Œæˆï¼æ£€æµ‹åˆ° ${distribution.length} ä¸ªè¿è¥å•†<br/>
                <span style="color: #67C23A;">âœ“ åˆ†ææ–¹æ³•ï¼š${methodText}</span>
              </div>`
            })
          }
        }
      } catch (error) {
        this.$message.error('åˆ†æå¤±è´¥: ' + (error.response?.data?.message || error.message))
        this.operatorList = []
      } finally {
        this.extractOperatorForm.analyzing = false
      }
    },

    // å¤„ç†è¿è¥å•†é€‰æ‹©å˜åŒ–
    handleOperatorSelection(selectedOperators) {
      // ä¸ºæ–°é€‰ä¸­çš„è¿è¥å•†åˆå§‹åŒ–é™åˆ¶è®¾ç½®
      selectedOperators.forEach(opName => {
        if (!this.extractOperatorForm.operatorLimits[opName]) {
          this.$set(this.extractOperatorForm.operatorLimits, opName, {
            enabled: false, // é»˜è®¤ä¸é™åˆ¶ï¼Œæå–å…¨éƒ¨
            limit: 10000 // é»˜è®¤é™åˆ¶æ•°é‡
          })
        }
      })

      // æ¸…ç†å·²å–æ¶ˆé€‰æ‹©çš„è¿è¥å•†çš„è®¾ç½®
      Object.keys(this.extractOperatorForm.operatorLimits).forEach(opName => {
        if (!selectedOperators.includes(opName)) {
          this.$delete(this.extractOperatorForm.operatorLimits, opName)
        }
      })
    },

    // æŒ‰è¿è¥å•†æå–
    async confirmExtractOperator() {
      if (!this.extractOperatorForm.fileId) {
        this.$message.warning('è¯·é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶')
        return
      }
      if (!this.extractOperatorForm.countryCode) {
        this.$message.warning('è¯·é€‰æ‹©å›½å®¶')
        return
      }
      if (!this.extractOperatorForm.selectedOperators || this.extractOperatorForm.selectedOperators.length === 0) {
        this.$message.warning('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¿è¥å•†')
        return
      }

      // è·å–å›½ç 
      const country = this.countryList.find(c => c.code === this.extractOperatorForm.countryCode)
      const countryCode = country ? country.dialCode.replace(/^\+/, '') : null

      // æ„å»ºè¿è¥å•†æ•°æ®
      const operators = []
      for (const opName of this.extractOperatorForm.selectedOperators) {
        const operator = this.operatorList.find(op => op.name === opName)
        if (!operator) {
          this.$message.error(`è¿è¥å•† ${opName} æ•°æ®ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°åˆ†æ`)
          return
        }
        if (!operator.numberSegments || !Array.isArray(operator.numberSegments)) {
          this.$message.error(`è¿è¥å•† ${opName} å·æ®µæ•°æ®ä¸å®Œæ•´ï¼Œè¯·é‡æ–°åˆ†æ`)
          return
        }
        const limitConfig = this.extractOperatorForm.operatorLimits[opName]
        if (!limitConfig) {
          this.$message.error(`è¿è¥å•† ${opName} é…ç½®ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°é€‰æ‹©`)
          return
        }

        operators.push({
          name: opName,
          numberSegments: operator.numberSegments,
          countryCode: countryCode,
          limit: limitConfig.enabled ? limitConfig.limit : null // å¦‚æœæœªå¼€å¯é™åˆ¶ï¼Œä¼ nullè¡¨ç¤ºæå–å…¨éƒ¨
        })
      }

      console.log('æå–å‚æ•°:', {
        fileId: this.extractOperatorForm.fileId,
        operators: operators
      })

      this.processing = true
      try {
        const response = await request({
          url: '/api/data-processing/extract-by-operator',
          method: 'post',
          data: {
            fileId: this.extractOperatorForm.fileId,
            operators: operators
          }
        })

        const { totalMatched, totalProcessed, operatorCount, operatorStats, downloadPath } = response.data

        // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
        let message = `æå–å®Œæˆï¼\n`
        message += `æ€»æ•°æ®: ${this.formatNumber(totalProcessed)} æ¡\n`
        message += `æå–æ€»æ•°: ${this.formatNumber(totalMatched)} æ¡\n`
        message += `è¿è¥å•†æ•°: ${operatorCount} ä¸ª\n\n`
        message += `å„è¿è¥å•†æå–æ˜ç»†ï¼š\n`

        operatorStats.forEach(stat => {
          message += `â— ${stat.operatorName}: ${this.formatNumber(stat.matchedCount)} æ¡`
          if (stat.limit) {
            message += ` (é™åˆ¶${this.formatNumber(stat.limit)}æ¡`
            if (stat.limitReached) {
              message += ', å·²è¾¾ä¸Šé™'
            }
            message += ')'
          }
          message += '\n'
        })

        message += `\nå·²ç”Ÿæˆåˆå¹¶æ–‡ä»¶ï¼Œæ­£åœ¨ä¸‹è½½...`

        this.$alert(message, 'æå–ç»“æœ', {
          confirmButtonText: 'ç¡®å®š',
          type: 'success',
          dangerouslyUseHTMLString: false
        })

        // ä¸‹è½½åˆå¹¶æ–‡ä»¶ï¼ˆåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼‰
        this.downloadFile(downloadPath)

        this.dialogExtractOperator = false
        this.extractOperatorForm.fileId = null
        this.extractOperatorForm.selectedOperators = []
        this.extractOperatorForm.operatorLimits = {}
      } catch (error) {
        this.$message.error('æå–å¤±è´¥: ' + (error.response?.data?.message || error.message))
      } finally {
        this.processing = false
      }
    },

    // æŒ‰æ¡æ•°æå–
    async confirmExtractCount() {
      if (!this.extractCountForm.fileIds || this.extractCountForm.fileIds.length === 0) {
        this.$message.warning('è¯·é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶')
        return
      }
      if (!this.extractCountForm.count || this.extractCountForm.count <= 0) {
        this.$message.warning('è¯·è¾“å…¥æœ‰æ•ˆçš„æå–æ¡æ•°')
        return
      }

      this.processing = true
      try {
        const results = []
        let totalExtracted = 0

        for (const fileId of this.extractCountForm.fileIds) {
          const response = await request({
            url: '/api/data-processing/extract-by-count',
            method: 'post',
            data: {
              fileId,
              count: this.extractCountForm.count,
              startFrom: this.extractCountForm.startFrom
            }
          })
          results.push(response.data)
          totalExtracted += response.data.extractedCount || 0
        }

        this.$message.success(
          `å¤„ç†å®Œæˆï¼å…±å¤„ç† ${results.length} ä¸ªæ–‡ä»¶ï¼Œ` +
          `æå–å‡º ${this.formatNumber(totalExtracted)} æ¡æ•°æ®`
        )

        // ä¸‹è½½æ‰€æœ‰ç»“æœ
        results.forEach(result => {
          this.downloadFile(result.downloadPath)
        })

        this.dialogExtractCount = false
        this.extractCountForm.fileIds = []
      } catch (error) {
        this.$message.error('æå–å¤±è´¥: ' + error.message)
      } finally {
        this.processing = false
      }
    },

    // ä¸€é”®æ¸…æ´—
    async confirmCleanData() {
      if (!this.cleanDataForm.fileIds || this.cleanDataForm.fileIds.length === 0) {
        this.$message.warning('è¯·é€‰æ‹©è¦æ¸…æ´—çš„æ–‡ä»¶')
        return
      }
      if (!this.cleanDataForm.countryCode && this.cleanDataForm.options.includes('autoAddCode')) {
        this.$message.warning('è¯·é€‰æ‹©å›½å®¶æˆ–å–æ¶ˆ"æ™ºèƒ½æ ¡éªŒå›½ç "é€‰é¡¹')
        return
      }

      this.processing = true
      this.cleanedFiles = []

      try {
        const results = []
        let totalOriginal = 0
        let totalFinal = 0
        let totalInvalid = 0
        let totalDuplicate = 0
        let totalAddedCode = 0
        let totalSkippedCode = 0 // ç´¯è®¡è·³è¿‡ï¼ˆå·²æœ‰å›½ç ï¼‰æ•°é‡

        // å»æ‰å›½ç ä¸­çš„ + å·ï¼Œåªä¿ç•™æ•°å­—ï¼ˆå¦‚æœæœ‰é€‰æ‹©å›½å®¶çš„è¯ï¼‰
        const countryCodeNumber = this.cleanDataForm.countryCode ? this.cleanDataForm.countryCode.replace(/^\+/, '') : null

        for (const fileId of this.cleanDataForm.fileIds) {
          const response = await request({
            url: '/api/data-processing/clean-data',
            method: 'post',
            data: {
              fileId,
              countryCode: countryCodeNumber,
              autoAddCode: this.cleanDataForm.options.includes('autoAddCode'),
              autoDeduplicate: this.cleanDataForm.options.includes('autoDeduplicate'),
              removeInvalid: this.cleanDataForm.options.includes('removeInvalid')
            }
          })

          results.push(response.data)
          totalOriginal += response.data.originalCount || 0
          totalFinal += response.data.finalCount || 0
          totalInvalid += response.data.invalidCount || 0
          totalDuplicate += response.data.duplicateCount || 0
          totalAddedCode += response.data.addedCodeCount || 0
          totalSkippedCode += response.data.skippedCount || 0 // ç´¯è®¡è·³è¿‡æ•°é‡

          this.cleanedFiles.push({
            downloadPath: response.data.downloadPath,
            filename: `cleaned_file_${fileId}.txt`
          })
        }

        // è®¾ç½®æ¸…æ´—ç»“æœï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç»“æœä½œä¸ºç¤ºä¾‹ï¼‰
        if (results.length > 0) {
          const firstResult = results[0]
          this.cleanResult = {
            originalCount: totalOriginal,
            finalCount: totalFinal,
            invalidCount: totalInvalid,
            duplicateCount: totalDuplicate,
            addedCodeCount: totalAddedCode,
            skippedCount: totalSkippedCode, // è®¾ç½®è·³è¿‡æ•°é‡
            steps: firstResult.steps || [],
            preview: firstResult.preview || [],
            // æ–°å¢ï¼šè¯¦ç»†é¢„è§ˆæ•°æ®
            invalidDataPreview: firstResult.invalidDataPreview || [],
            duplicateDataPreview: firstResult.duplicateDataPreview || [],
            addedCodePreview: firstResult.addedCodePreview || [],
            removedCodePreview: firstResult.removedCodePreview || []
          }
        }

        // å…³é—­æ¸…æ´—å¯¹è¯æ¡†ï¼Œæ‰“å¼€ç»“æœå¯¹è¯æ¡†
        this.dialogCleanData = false
        this.cleanResultDialogVisible = true

        this.$message.success(
          `æ¸…æ´—å®Œæˆï¼å…±å¤„ç† ${results.length} ä¸ªæ–‡ä»¶ï¼Œ` +
          `åŸå§‹ ${this.formatNumber(totalOriginal)} æ¡ï¼Œ` +
          `æœ€ç»ˆ ${this.formatNumber(totalFinal)} æ¡`
        )
      } catch (error) {
        this.$message.error('æ¸…æ´—å¤±è´¥: ' + error.message)
      } finally {
        this.processing = false
      }
    },

    // ä¸‹è½½æ¸…æ´—åçš„æ–‡ä»¶
    downloadCleanedFiles() {
      this.cleanedFiles.forEach(file => {
        this.downloadFile(file.downloadPath)
      })
      this.$message.success(`å¼€å§‹ä¸‹è½½ ${this.cleanedFiles.length} ä¸ªæ–‡ä»¶`)
    },

    downloadFile(downloadPath) {
      const url = process.env.VUE_APP_BASE_API + downloadPath + '?token=' + getToken()
      window.open(url, '_blank')
    },

    async handleDelete(row) {
      try {
        await this.$confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${row.original_filename}" å—ï¼Ÿ`, 'æç¤º', {
          confirmButtonText: 'ç¡®å®š',
          cancelButtonText: 'å–æ¶ˆ',
          type: 'warning'
        })

        await request({
          url: `/api/data-processing/file/${row.id}`,
          method: 'delete'
        })

        this.$message.success('åˆ é™¤æˆåŠŸ')
        this.fetchFileList()
      } catch (error) {
        if (error !== 'cancel') {
          this.$message.error('åˆ é™¤å¤±è´¥: ' + error.message)
        }
      }
    },

    formatFileSize(bytes) {
      if (bytes === null || bytes === undefined) return '0 B'
      if (bytes < 1024) return bytes + ' B'
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB'
      return (bytes / 1024 / 1024).toFixed(2) + ' MB'
    },

    formatNumber(num) {
      if (num === null || num === undefined) return '0'
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')
    },

    formatTime(timestamp) {
      if (!timestamp) return '-'
      const date = new Date(timestamp)
      return date.toLocaleString('zh-CN')
    },

    // å¤„ç†æ¸…æ´—æ—¶çš„å›½å®¶é€‰æ‹©å˜åŒ–ï¼ˆå¤„ç†å…±ç”¨å›½ç ï¼‰
    handleCleanDataCountryChange(dialCode) {
      const { isSharedDialCode, getCountriesByDialCode, getDefaultCountryForDialCode } = require('@/data/countries')

      if (dialCode && isSharedDialCode(dialCode)) {
        // å…±ç”¨å›½ç ï¼Œæ˜¾ç¤ºäºŒçº§é€‰æ‹©å™¨
        this.showCleanDataCountrySelector = true
        this.cleanDataCountryOptions = getCountriesByDialCode(dialCode)
        // è®¾ç½®é»˜è®¤å€¼ä¸ºç¾å›½ï¼ˆ+1çš„æƒ…å†µï¼‰æˆ–å…¶ä»–é»˜è®¤å€¼
        const defaultCountry = getDefaultCountryForDialCode(dialCode)
        this.cleanDataForm.specificCountry = defaultCountry ? defaultCountry.code : ''
      } else {
        // éå…±ç”¨å›½ç ï¼Œéšè—äºŒçº§é€‰æ‹©å™¨
        this.showCleanDataCountrySelector = false
        this.cleanDataCountryOptions = []
        this.cleanDataForm.specificCountry = ''
      }
    },

    // å¤„ç†å¢åŠ å›½ç æ—¶çš„å›½å®¶é€‰æ‹©å˜åŒ–ï¼ˆå¤„ç†å…±ç”¨å›½ç ï¼‰
    handleAddCodeCountryChange(dialCode) {
      const { isSharedDialCode, getCountriesByDialCode, getDefaultCountryForDialCode } = require('@/data/countries')

      if (dialCode && isSharedDialCode(dialCode)) {
        // å…±ç”¨å›½ç ï¼Œæ˜¾ç¤ºäºŒçº§é€‰æ‹©å™¨
        this.showAddCodeCountrySelector = true
        this.addCodeCountryOptions = getCountriesByDialCode(dialCode)
        // è®¾ç½®é»˜è®¤å€¼ä¸ºç¾å›½ï¼ˆ+1çš„æƒ…å†µï¼‰æˆ–å…¶ä»–é»˜è®¤å€¼
        const defaultCountry = getDefaultCountryForDialCode(dialCode)
        this.addCodeForm.specificCountry = defaultCountry ? defaultCountry.code : ''
      } else {
        // éå…±ç”¨å›½ç ï¼Œéšè—äºŒçº§é€‰æ‹©å™¨
        this.showAddCodeCountrySelector = false
        this.addCodeCountryOptions = []
        this.addCodeForm.specificCountry = ''
      }
    },

    // ========== å·ç ç”ŸæˆåŠŸèƒ½ ==========

    // å¤„ç†ç”Ÿæˆå·ç æ—¶çš„å›½å®¶é€‰æ‹©
    async handleGenerateCountryChange(countryCode) {
      if (!countryCode) {
        this.generateOperatorList = []
        this.generateNumbersForm.countryInfo = {}
        return
      }

      // åŠ è½½è¿è¥å•†åˆ—è¡¨
      this.generateNumbersForm.loadingOperators = true

      try {
        // è·å–å›½å®¶ä¿¡æ¯
        const formatResponse = await request({
          url: `/api/data-processing/country-format/${countryCode}`,
          method: 'get'
        })

        this.generateNumbersForm.countryInfo = formatResponse.data

        // åŠ è½½è¿è¥å•†æ•°æ®
        const operatorData = this.getCountryOperatorData(countryCode)
        if (operatorData && operatorData.operators) {
          this.generateOperatorList = operatorData.operators
        } else {
          this.generateOperatorList = []
        }

        // æ¸…ç©ºé€‰æ‹©
        this.generateNumbersForm.selectedOperators = []
        this.generateNumbersForm.operatorCounts = {}
      } catch (error) {
        this.$message.error('è·å–å›½å®¶ä¿¡æ¯å¤±è´¥: ' + error.message)
      } finally {
        this.generateNumbersForm.loadingOperators = false
      }
    },

    // å¤„ç†è¿è¥å•†é€‰æ‹©
    handleGenerateOperatorSelection(selectedOperators) {
      // ä¸ºæ¯ä¸ªè¿è¥å•†åˆå§‹åŒ–ç”Ÿæˆæ•°é‡
      const newCounts = {}
      selectedOperators.forEach(opName => {
        if (this.generateNumbersForm.operatorCounts[opName]) {
          newCounts[opName] = this.generateNumbersForm.operatorCounts[opName]
        } else {
          newCounts[opName] = 10000 // é»˜è®¤10000æ¡
        }
      })
      this.generateNumbersForm.operatorCounts = newCounts
    },

    // ç¡®è®¤ç”Ÿæˆå·ç 
    async confirmGenerateNumbers() {
      // éªŒè¯
      if (!this.generateNumbersForm.countryCode) {
        this.$message.warning('è¯·é€‰æ‹©å›½å®¶')
        return
      }
      if (this.generateNumbersForm.selectedOperators.length === 0) {
        this.$message.warning('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¿è¥å•†')
        return
      }

      // éªŒè¯æ¯ä¸ªè¿è¥å•†çš„ç”Ÿæˆæ•°é‡
      for (const opName of this.generateNumbersForm.selectedOperators) {
        const count = this.generateNumbersForm.operatorCounts[opName]
        if (!count || count <= 0) {
          this.$message.warning(`è¯·è®¾ç½®è¿è¥å•† ${opName} çš„ç”Ÿæˆæ•°é‡`)
          return
        }
        if (count > 1000000) {
          this.$message.warning(`è¿è¥å•† ${opName} çš„ç”Ÿæˆæ•°é‡ä¸èƒ½è¶…è¿‡ 1,000,000`)
          return
        }
      }

      this.processing = true

      try {
        // å‡†å¤‡è¿è¥å•†æ•°æ®
        const operators = this.generateNumbersForm.selectedOperators.map(opName => {
          const operator = this.generateOperatorList.find(op => op.name === opName)
          return {
            name: opName,
            numberSegments: operator.numberSegments,
            count: this.generateNumbersForm.operatorCounts[opName]
          }
        })

        // è®¡ç®—æ€»æ•°é‡å’Œé¢„è®¡æ—¶é—´
        const totalCount = operators.reduce((sum, op) => sum + op.count, 0)
        const estimatedTime = Math.ceil(totalCount / 10000) // æ¯ç§’çº¦1Wæ¡

        // æ˜¾ç¤ºåŠ è½½æç¤º
        let loadingMessage = `æ­£åœ¨ç”Ÿæˆ ${totalCount.toLocaleString()} æ¡å·ç ...`
        if (totalCount > 100000) {
          loadingMessage += `\né¢„è®¡éœ€è¦ ${estimatedTime} ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…`
        }

        const loadingInstance = this.$loading({
          lock: true,
          text: loadingMessage,
          spinner: 'el-icon-loading',
          background: 'rgba(0, 0, 0, 0.7)'
        })

        // è°ƒç”¨åç«¯API
        const response = await request({
          url: '/api/data-processing/generate-multiple-operators',
          method: 'post',
          data: {
            regionCode: this.generateNumbersForm.countryCode,
            operators: operators,
            options: {
              includeCountryCode: this.generateNumbersForm.includeCountryCode,
              format: 'e164',
              unique: true
            }
          }
        })

        loadingInstance.close()

        // æ˜¾ç¤ºç»“æœ
        this.generateResult = response.data
        this.generateResultDialogVisible = true
        this.dialogGenerateNumbers = false

        this.$message.success(response.message)
      } catch (error) {
        this.$message.error('ç”Ÿæˆå¤±è´¥: ' + (error.response?.data?.message || error.message))
      } finally {
        this.processing = false
      }
    }
  }
}
</script>

<style lang="scss" scoped>
.data-processing-container {
  padding: 20px;
  background: #f0f2f5;
  min-height: calc(100vh - 84px);

  // é¡µé¢æ ‡é¢˜
  .page-header {
    margin-bottom: 30px;
    padding: 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);

    .page-title {
      margin: 0 0 8px 0;
      font-size: 28px;
      font-weight: 600;
      display: flex;
      align-items: center;

      i {
        margin-right: 12px;
        font-size: 32px;
      }
    }

    .page-description {
      margin: 0;
      font-size: 14px;
      opacity: 0.9;
    }
  }

  // åŠŸèƒ½åˆ†ç»„
  .function-section {
    margin-bottom: 30px;

    .section-header {
      padding: 12px 20px;
      margin-bottom: 20px;
      background: white;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      color: #303133;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      display: flex;
      align-items: center;

      i {
        margin-right: 8px;
        font-size: 18px;
        color: #409EFF;
      }
    }
  }

  .function-modules {
    .module-card {
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      padding: 30px 20px;
      border-radius: 12px;
      position: relative;
      height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      background: white;

      &:hover {
        transform: translateY(-8px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      }

      &.module-card-featured {
        border: 2px solid #67C23A;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2f1 100%);

        &:hover {
          box-shadow: 0 8px 24px rgba(103, 194, 58, 0.3);
        }
      }

      &.module-card-new {
        border: 2px solid #E6A23C;
        background: linear-gradient(135deg, #fff7e6 0%, #fef5e7 100%);

        &:hover {
          box-shadow: 0 8px 24px rgba(230, 162, 60, 0.3);
        }
      }

      .module-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #67C23A;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(103, 194, 58, 0.3);

        &.module-badge-new {
          background: #E6A23C;
          box-shadow: 0 2px 8px rgba(230, 162, 60, 0.3);
        }
      }

      .module-icon {
        font-size: 48px;
        color: #409eff;
        margin-bottom: 15px;

        i {
          font-size: 48px;
        }
      }

      .module-title {
        font-size: 18px;
        font-weight: 600;
        color: #303133;
        margin-bottom: 10px;
      }

      .module-desc {
        font-size: 13px;
        color: #909399;
        line-height: 1.6;
      }
    }
  }

  .file-manager-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);

    .card-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;

      i {
        margin-right: 8px;
        color: #409EFF;
      }
    }

    .batch-actions {
      margin-top: 20px;
    }
  }

  .upload-demo {
    margin-top: 10px;
  }

  .preview-info {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f5f7fa;
    border-radius: 4px;

    .info-item {
      margin-bottom: 10px;

      .info-label {
        font-weight: 600;
        color: #606266;
        margin-right: 10px;
      }

      .info-value {
        color: #303133;
      }
    }
  }

  .preview-content {
    code {
      font-family: 'Courier New', Courier, monospace;
      font-size: 13px;
      color: #e96900;
      background-color: #f8f8f8;
      padding: 2px 6px;
      border-radius: 3px;
    }
  }

  .clean-result-summary {
    margin-bottom: 20px;

    .stat-card {
      text-align: center;
      padding: 20px;
      background: #f5f7fa;
      border-radius: 8px;
      transition: all 0.3s;

      &:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      }

      .stat-label {
        font-size: 14px;
        color: #909399;
        margin-bottom: 10px;
      }

      .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #303133;
      }
    }
  }
}

// å“åº”å¼ä¼˜åŒ–
@media (max-width: 768px) {
  .data-processing-container {
    padding: 10px;

    .page-header {
      padding: 16px;

      .page-title {
        font-size: 22px;

        i {
          font-size: 24px;
        }
      }
    }

    .function-section {
      .section-header {
        font-size: 14px;
      }
    }

    .function-modules {
      .module-card {
        padding: 20px 15px;
        height: 160px;

        .module-icon {
          font-size: 40px;

          i {
            font-size: 40px;
          }
        }

        .module-title {
          font-size: 16px;
        }

        .module-desc {
          font-size: 12px;
        }
      }
    }
  }
}
</style>
