# 功能说明 - 按运营商提取支持多运营商自定义条数

## 📋 功能概述

按运营商提取功能现已升级，支持**同时选择多个运营商**，并为**每个运营商单独设置提取条数**，提供更灵活的数据提取方式。

---

## ✨ 新功能特性

### 1. 多运营商同时提取
- ✅ 支持同时选择多个运营商
- ✅ 一次操作，生成多个文件
- ✅ 每个运营商独立输出文件

### 2. 自定义提取条数
- ✅ 为每个运营商单独设置提取条数
- ✅ 支持开关控制：全部提取 / 限制条数
- ✅ 实时显示提取进度和结果

### 3. 智能提示
- ✅ 显示每个运营商的提取数量
- ✅ 提示是否达到限制条数
- ✅ 详细的提取结果统计

---

## 🎯 使用场景

### 场景1：按比例提取多运营商数据
**需求**: 从孟加拉国数据中，提取不同运营商的数据，每个运营商提取不同数量

**操作**:
1. 选择文件: `bangladesh_data.txt` (50,000行)
2. 选择国家: 孟加拉国
3. 选择运营商:
   - ✅ Grameenphone - 限制条数: 10,000
   - ✅ Banglalink - 限制条数: 5,000
   - ✅ Robi - 限制条数: 3,000
4. 开始提取

**结果**:
```
提取完成！
总数据: 50,000 条
提取总数: 18,000 条
运营商数: 3 个

● Grameenphone: 10,000 条 (限制10,000条, 已达上限)
● Banglalink: 5,000 条 (限制5,000条, 已达上限)
● Robi: 3,000 条 (限制3,000条, 已达上限)
```

自动下载3个文件:
- `operator_Grameenphone_1729123456789.txt` (10,000行)
- `operator_Banglalink_1729123456790.txt` (5,000行)
- `operator_Robi_1729123456791.txt` (3,000行)

---

### 场景2：全部提取某些运营商，限制其他运营商
**需求**: 提取所有主要运营商数据，但限制其他运营商数据量

**操作**:
1. 选择文件: `india_data.txt` (100,000行)
2. 选择国家: 印度
3. 选择运营商:
   - ✅ Jio - **全部提取** (关闭限制)
   - ✅ Airtel - **全部提取** (关闭限制)
   - ✅ Vi - 限制条数: 5,000
4. 开始提取

**结果**:
```
提取完成！
总数据: 100,000 条
提取总数: 55,000 条
运营商数: 3 个

● Jio: 30,000 条
● Airtel: 20,000 条
● Vi: 5,000 条 (限制5,000条, 已达上限)
```

---

## 📱 界面说明

### 对话框布局

```
┌─────────────────────────────────────────────┐
│  按运营商提取                               │
├─────────────────────────────────────────────┤
│                                             │
│  处理文件: [选择文件 ▼]                     │
│                                             │
│  国家: [选择国家 ▼]                         │
│                                             │
│  ──────── 运营商选择与提取条数 ────────     │
│                                             │
│  选择运营商:                                │
│  ☑ Grameenphone (市场份额: 46%)            │
│  ☑ Banglalink (市场份额: 30%)              │
│  ☐ Robi (市场份额: 20%)                    │
│                                             │
│  提取条数设置:                              │
│  ┌──────────────────────────────────────┐  │
│  │ Grameenphone                         │  │
│  │ [限制条数 ⚫] [10000 ▲▼]             │  │
│  └──────────────────────────────────────┘  │
│  ┌──────────────────────────────────────┐  │
│  │ Banglalink                           │  │
│  │ [全部提取 ⚪] [      ]               │  │
│  └──────────────────────────────────────┘  │
│                                             │
│  💡 提示: 开启"限制条数"后，将仅提取       │
│     指定数量的数据；关闭则提取该运营商     │
│     的全部数据                             │
│                                             │
│  [取消]              [开始提取]            │
└─────────────────────────────────────────────┘
```

### 控件说明

1. **处理文件**: 单选，选择要处理的数据文件
2. **国家**: 下拉选择，支持搜索
3. **运营商多选**: 勾选框，可选择多个运营商
4. **限制条数开关**: 
   - 开启: 显示数量输入框，限制提取条数
   - 关闭: 提取该运营商的全部数据
5. **提取数量输入**: 设置提取的数据条数（最小1，最大1,000,000）

---

## 🔧 技术实现

### 后端API变更

#### 请求格式

**旧版本**:
```json
{
  "fileId": 123,
  "numberSegments": ["017", "013"],
  "operatorName": "Grameenphone"
}
```

**新版本**:
```json
{
  "fileId": 123,
  "operators": [
    {
      "name": "Grameenphone",
      "numberSegments": ["017", "013", "019"],
      "countryCode": "880",
      "limit": 10000
    },
    {
      "name": "Banglalink",
      "numberSegments": ["014", "019"],
      "countryCode": "880",
      "limit": null
    }
  ]
}
```

#### 响应格式

**旧版本**:
```json
{
  "success": true,
  "message": "运营商数据提取完成",
  "data": {
    "matchedCount": 15000,
    "totalCount": 50000,
    "operator": "Grameenphone",
    "downloadPath": "/api/data-processing/download/operator_Grameenphone_xxx.txt"
  }
}
```

**新版本**:
```json
{
  "success": true,
  "message": "运营商数据提取完成",
  "data": {
    "totalMatched": 15000,
    "totalProcessed": 50000,
    "operatorCount": 2,
    "results": [
      {
        "operatorName": "Grameenphone",
        "matchedCount": 10000,
        "totalCount": 50000,
        "limit": 10000,
        "limitReached": true,
        "downloadPath": "/api/data-processing/download/operator_Grameenphone_xxx.txt"
      },
      {
        "operatorName": "Banglalink",
        "matchedCount": 5000,
        "totalCount": 50000,
        "limit": null,
        "limitReached": false,
        "downloadPath": "/api/data-processing/download/operator_Banglalink_xxx.txt"
      }
    ]
  }
}
```

### 核心数据处理逻辑

**文件**: `/home/vue-element-admin/backend/utils/dataProcessor.js`

```javascript
static async extractByOperator(inputPath, outputPath, numberSegments, countryCode = null, limit = null) {
  const lines = await this.readLines(inputPath);
  let matchedLines = [];
  
  for (const line of lines) {
    // 如果已达到限制条数，停止提取
    if (limit && matchedLines.length >= limit) {
      break;
    }
    
    // ... 数据匹配逻辑 ...
    
    if (isMatch) {
      matchedLines.push(cleaned);
    }
  }
  
  return {
    totalCount: lines.length,
    matchedCount: matchedLines.length,
    limitReached: limit && matchedLines.length >= limit
  };
}
```

---

## 📊 性能优化

### 1. 提前终止
- 达到限制条数后立即停止读取
- 避免处理不需要的数据
- 提升大文件处理速度

### 2. 并发处理
- 多个运营商顺序处理
- 每个运营商独立输出文件
- 避免内存占用过大

### 3. 文件命名优化
- 添加随机字符串避免冲突
- 格式: `operator_{运营商名}_{时间戳}_{随机串}.txt`
- 示例: `operator_Grameenphone_1729123456789_a1b2c3d4e.txt`

---

## ⚠️ 注意事项

### 1. 文件选择
- 旧版支持多文件批量处理
- 新版改为单文件处理（更精确控制）
- 如需处理多文件，可多次操作

### 2. 提取条数限制
- `limit = null`: 提取所有匹配数据
- `limit > 0`: 提取指定条数
- 达到限制后停止，返回 `limitReached = true`

### 3. 运营商号段
- 号段信息来自 `/src/data/operators.js`
- 支持全球70+国家，240+运营商
- 自动去除国码后匹配号段

### 4. 数据格式
- 输入文件需为纯数字格式
- 每行一个号码
- 支持带国码或不带国码

---

## 🔍 测试示例

### 测试用例1: 多运营商限制提取

**测试数据**:
```
8801712345678
8801812345679
8801412345680
8801912345681
8801712345682
... (共50,000行)
```

**测试步骤**:
1. 选择文件
2. 选择国家: 孟加拉国 (BD)
3. 选择运营商:
   - Grameenphone (号段: 017, 013, 019) - 限制10条
   - Banglalink (号段: 014, 019) - 限制5条
4. 开始提取

**预期结果**:
- 文件1: `operator_Grameenphone_xxx.txt` - 10行 (以017开头的号码)
- 文件2: `operator_Banglalink_xxx.txt` - 5行 (以014开头的号码)

---

### 测试用例2: 部分限制部分全部提取

**测试步骤**:
1. 选择文件 (50,000行)
2. 选择国家: 孟加拉国 (BD)
3. 选择运营商:
   - Grameenphone - **全部提取**
   - Banglalink - 限制100条
4. 开始提取

**预期结果**:
- 文件1: `operator_Grameenphone_xxx.txt` - 约23,000行 (所有Grameenphone号码)
- 文件2: `operator_Banglalink_xxx.txt` - 100行 (限制的Banglalink号码)

---

## 📝 更新日志

### v2.0 (2025-10-16)
- ✅ 支持多运营商同时选择
- ✅ 每个运营商可单独设置提取条数
- ✅ 优化界面，使用开关控制限制模式
- ✅ 详细的提取结果统计
- ✅ 自动下载所有生成的文件

### v1.0 (之前版本)
- 单运营商提取
- 支持多文件批量处理
- 提取全部匹配数据

---

## 💡 使用建议

1. **测试数据**: 建议先用小文件测试，确认提取结果正确
2. **条数设置**: 根据实际需求设置合理的条数限制
3. **文件管理**: 及时下载并整理生成的文件
4. **批量处理**: 如需处理多个文件，可使用循环操作

---

## 📞 技术支持

如有问题，请查看:
- 数据处理功能说明文档
- 运营商信息配置文档
- 系统日志: `/home/vue-element-admin/backend/server.log`
