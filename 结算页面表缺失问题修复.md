# ç»“ç®—é¡µé¢"è·å–ç»“ç®—åˆ—è¡¨å¤±è´¥"é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

ç”¨æˆ·æ‰“å¼€çŸ­ä¿¡ç»“ç®—é¡µé¢æ—¶æç¤º**"è·å–ç»“ç®—åˆ—è¡¨å¤±è´¥"**ã€‚

## é—®é¢˜æ’æŸ¥

### 1. æ—¥å¿—åˆ†æ

ä»åç«¯æ—¥å¿—ä¸­å‘ç°ï¼š
- APIè¯·æ±‚æ­£å¸¸ï¼š`GET /api/sms/settlements?... HTTP/1.1" 200 86`
- è¿”å›çŠ¶æ€ç 200ï¼Œä½†å“åº”ä½“ç§¯å¾ˆå°ï¼ˆ86å­—èŠ‚ï¼‰
- æ²¡æœ‰æŠ¥é”™ä¿¡æ¯ï¼Œè¯´æ˜ä¸æ˜¯ç¨‹åºé”™è¯¯

### 2. æ•°æ®åº“æ£€æŸ¥

æ‰§è¡Œæ•°æ®åº“æ£€æŸ¥å‘ç°ï¼š
```sql
mysql> SHOW TABLES LIKE 'sms_settlements';
Empty set (0.00 sec)
```

**æ ¹æœ¬åŸå› **ï¼š`sms_settlements`è¡¨ä¸å­˜åœ¨ï¼

### 3. ç¼ºå¤±çš„è¡¨

éœ€è¦åˆ›å»ºçš„è¡¨ï¼š
1. **sms_settlements** - ç»“ç®—æ±‡æ€»è¡¨
2. **sms_settlement_details** - ç»“ç®—æ˜ç»†è¡¨
3. **sms_channel_countries** - é€šé“å›½å®¶å®šä»·è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰

## è§£å†³æ–¹æ¡ˆ

### æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬

å·²å­˜åœ¨åˆ›å»ºè¡¨çš„SQLæ–‡ä»¶ï¼š
- æ–‡ä»¶è·¯å¾„ï¼š`/home/vue-element-admin/database/migrations/2025-10-21_sms_settlement.sql`

æ‰§è¡Œå‘½ä»¤ï¼š
```bash
mysql -u vue_admin_user -p'vue_admin_2024' vue_admin < /home/vue-element-admin/database/migrations/2025-10-21_sms_settlement.sql
```

### æ‰§è¡Œç»“æœ

```
âœ… æ•°æ®åº“è¿ç§»å®Œæˆï¼
ğŸ“Š å·²åˆ›å»º3ä¸ªæ–°è¡¨ï¼š
   - sms_channel_countries (9æ¡è®°å½•)
   - sms_settlements (0æ¡è®°å½•)
   - sms_settlement_details (0æ¡è®°å½•)
ğŸ”§ å·²ä¿®æ”¹sms_recordsè¡¨ï¼Œæ·»åŠ cost_price, sale_price, countryå­—æ®µ
```

### è¡¨ç»“æ„ç¡®è®¤

**sms_settlements è¡¨ç»“æ„ï¼š**
```
+-------------------+---------------------------------------------------+------+-----+---------------------+-------------------------------+
| Field             | Type                                              | Null | Key | Default             | Extra                         |
+-------------------+---------------------------------------------------+------+-----+---------------------+-------------------------------+
| id                | int(11)                                           | NO   | PRI | NULL                | auto_increment                |
| settlement_date   | date                                              | NO   | MUL | NULL                |                               |
| customer_id       | int(11)                                           | NO   | MUL | NULL                |                               |
| channel_id        | int(11)                                           | NO   | MUL | NULL                |                               |
| country           | varchar(50)                                       | NO   | MUL | NULL                |                               |
| total_count       | int(11)                                           | NO   |     | 0                   |                               |
| success_count     | int(11)                                           | NO   |     | 0                   |                               |
| failed_count      | int(11)                                           | NO   |     | 0                   |                               |
| total_cost        | decimal(12,4)                                     | NO   |     | 0.0000              |                               |
| total_revenue     | decimal(12,4)                                     | NO   |     | 0.0000              |                               |
| total_profit      | decimal(12,4)                                     | NO   |     | 0.0000              |                               |
| cost_price        | decimal(10,4)                                     | NO   |     | 0.0000              |                               |
| sale_price        | decimal(10,4)                                     | NO   |     | 0.0000              |                               |
| settlement_status | enum('pending','processing','completed','failed') | YES  | MUL | pending             |                               |
| created_at        | datetime                                          | YES  |     | current_timestamp() |                               |
| updated_at        | datetime                                          | YES  |     | current_timestamp() | on update current_timestamp() |
+-------------------+---------------------------------------------------+------+-----+---------------------+-------------------------------+
```

### APIå“åº”éªŒè¯

ä¿®å¤åAPIæ­£å¸¸è¿”å›ï¼š
```bash
$ curl "http://localhost:3000/api/sms/settlements?page=1&limit=20&..."

Response:
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "total": 0,
    "page": 1,
    "limit": 20,
    "list": []
  }
}
```

## ä¿®å¤å®Œæˆ

### âœ… å·²å®Œæˆ

1. åˆ›å»ºäº† `sms_settlements` è¡¨ï¼ˆç»“ç®—æ±‡æ€»è¡¨ï¼‰
2. åˆ›å»ºäº† `sms_settlement_details` è¡¨ï¼ˆç»“ç®—æ˜ç»†è¡¨ï¼‰
3. éªŒè¯äº† `sms_channel_countries` è¡¨ï¼ˆé€šé“å›½å®¶å®šä»·è¡¨ï¼Œå·²æœ‰9æ¡è®°å½•ï¼‰
4. APIå“åº”æ­£å¸¸ï¼Œè¿”å›ç©ºåˆ—è¡¨ï¼ˆå› ä¸ºè¿˜æ²¡æœ‰ç»“ç®—æ•°æ®ï¼‰

### ğŸ“ æ³¨æ„äº‹é¡¹

**ç»“ç®—è¡¨å½“å‰ä¸ºç©ºæ˜¯æ­£å¸¸çš„**ï¼Œå› ä¸ºï¼š
1. è¿™æ˜¯æ–°åˆ›å»ºçš„è¡¨
2. éœ€è¦é€šè¿‡ä»¥ä¸‹æ–¹å¼ç”Ÿæˆç»“ç®—æ•°æ®ï¼š
   - **è‡ªåŠ¨ç»“ç®—**ï¼šé…ç½®å®šæ—¶ä»»åŠ¡æ¯å¤©è‡ªåŠ¨ç»“ç®—å‰ä¸€å¤©æ•°æ®
   - **æ‰‹åŠ¨ç»“ç®—**ï¼šåœ¨ç»“ç®—é¡µé¢ç‚¹å‡»"æ‰‹åŠ¨ç»“ç®—"æŒ‰é’®ï¼Œé€‰æ‹©æ—¥æœŸè¿›è¡Œç»“ç®—

### ğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ

#### 1. é…ç½®é€šé“å›½å®¶å®šä»·

åœ¨ä½¿ç”¨ç»“ç®—åŠŸèƒ½ä¹‹å‰ï¼Œéœ€è¦å…ˆé…ç½®é€šé“çš„å›½å®¶å®šä»·ï¼š

**å¯¼èˆªè·¯å¾„**ï¼šçŸ­ä¿¡ç®¡ç† > é€šé“é…ç½® > ç‚¹å‡»"å›½å®¶å®šä»·"æŒ‰é’®

**é…ç½®ç¤ºä¾‹**ï¼š
```
å›½å®¶: å·´è¥¿ (Brazil)
å›½å®¶ä»£ç : 55
æˆæœ¬ä»·: 0.0050
é”€å”®ä»·: 0.0080
æœ€å¤§å­—ç¬¦æ•°: 160
çŠ¶æ€: å¯ç”¨
```

#### 2. æ‰‹åŠ¨è§¦å‘ç»“ç®—

**æ–¹å¼ä¸€ï¼šé€šè¿‡å‰ç«¯é¡µé¢**
1. è®¿é—®ï¼šçŸ­ä¿¡ç®¡ç† > çŸ­ä¿¡ç»“ç®—
2. ç‚¹å‡»"æ‰‹åŠ¨ç»“ç®—"æŒ‰é’®
3. é€‰æ‹©è¦ç»“ç®—çš„æ—¥æœŸï¼ˆå»ºè®®é€‰æ‹©æœ‰çŸ­ä¿¡å‘é€è®°å½•çš„æ—¥æœŸï¼‰
4. ç‚¹å‡»ç¡®è®¤

**æ–¹å¼äºŒï¼šé€šè¿‡API**
```bash
curl -X POST http://localhost:3000/api/sms/settlements/calculate \
  -H "Content-Type: application/json" \
  -d '{"date": "2025-10-22"}'
```

#### 3. é…ç½®è‡ªåŠ¨å®šæ—¶ç»“ç®—ï¼ˆå¯é€‰ï¼‰

åœ¨ `backend/server.js` ä¸­æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼š
```javascript
const cron = require('node-cron');
const SettlementService = require('./services/settlementService');
const moment = require('moment');

// æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç»“ç®—å‰ä¸€å¤©çš„æ•°æ®
cron.schedule('0 2 * * *', async () => {
  try {
    const yesterday = moment().subtract(1, 'days').format('YYYY-MM-DD');
    logger.info(`å¼€å§‹è‡ªåŠ¨ç»“ç®—: ${yesterday}`);
    
    const result = await SettlementService.autoSettle(yesterday);
    
    logger.info(`è‡ªåŠ¨ç»“ç®—å®Œæˆ: ${JSON.stringify(result)}`);
  } catch (error) {
    logger.error('è‡ªåŠ¨ç»“ç®—å¤±è´¥:', error);
  }
});
```

## éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥é¡µé¢æ˜¯å¦æ­£å¸¸

åˆ·æ–°ç»“ç®—é¡µé¢ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
- âœ… ç»Ÿè®¡æ¦‚è§ˆæ˜¾ç¤º0æ¡è®°å½•ã€0.0000å…ƒæ•°æ®
- âœ… ç»“ç®—åˆ—è¡¨æ˜¾ç¤ºç©ºåˆ—è¡¨
- âœ… æ²¡æœ‰é”™è¯¯æç¤º

### 2. æ£€æŸ¥å›½å®¶å®šä»·é…ç½®

```bash
mysql -u vue_admin_user -p'vue_admin_2024' vue_admin -e "SELECT * FROM sms_channel_countries"
```

åº”è¯¥çœ‹åˆ°9æ¡å›½å®¶å®šä»·è®°å½•ã€‚

### 3. æµ‹è¯•æ‰‹åŠ¨ç»“ç®—

é€‰æ‹©æœ‰çŸ­ä¿¡å‘é€è®°å½•çš„æ—¥æœŸï¼ˆå¦‚2025-10-22ï¼‰ï¼Œè§¦å‘æ‰‹åŠ¨ç»“ç®—ï¼ŒéªŒè¯æ˜¯å¦èƒ½æ­£å¸¸ç”Ÿæˆç»“ç®—è®°å½•ã€‚

## é—®é¢˜æ ¹å› åˆ†æ

### ä¸ºä»€ä¹ˆè¡¨ä¼šç¼ºå¤±ï¼Ÿ

å¯èƒ½åŸå› ï¼š
1. **åˆå§‹åŒ–æœªå®Œæˆ**ï¼šç³»ç»Ÿéƒ¨ç½²æ—¶å¯èƒ½æ²¡æœ‰æ‰§è¡Œå®Œæ•´çš„æ•°æ®åº“è¿ç§»è„šæœ¬
2. **åˆ†æ­¥å®æ–½**ï¼šç»“ç®—åŠŸèƒ½æ˜¯åæœŸæ·»åŠ çš„ï¼Œä¹‹å‰çš„éƒ¨ç½²æ²¡æœ‰åŒ…å«è¿™äº›è¡¨
3. **è¿ç§»é—æ¼**ï¼šä¹‹å‰å¯èƒ½åªåˆ›å»ºäº†ä¸šåŠ¡è¡¨ï¼ˆsms_records, sms_tasksç­‰ï¼‰ï¼Œä½†é—æ¼äº†ç»“ç®—ç›¸å…³è¡¨

### é¢„é˜²æªæ–½

1. **æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†**ï¼š
   - ç»´æŠ¤å®Œæ•´çš„è¿ç§»è„šæœ¬æ¸…å•
   - è®°å½•æ¯æ¬¡è¿ç§»çš„æ‰§è¡Œæ—¶é—´å’ŒçŠ¶æ€

2. **éƒ¨ç½²æ£€æŸ¥æ¸…å•**ï¼š
   - éªŒè¯æ‰€æœ‰å¿…éœ€çš„è¡¨éƒ½å·²åˆ›å»º
   - æ£€æŸ¥è¡¨ç»“æ„æ˜¯å¦ä¸æ¨¡å‹å®šä¹‰ä¸€è‡´

3. **ç›‘æ§å‘Šè­¦**ï¼š
   - å¯¹å…³é”®è¡¨çš„å­˜åœ¨æ€§è¿›è¡Œç›‘æ§
   - APIé”™è¯¯æ—¶è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

## ç›¸å…³æ–‡ä»¶

### æ•°æ®åº“æ–‡ä»¶
- `/home/vue-element-admin/database/migrations/2025-10-21_sms_settlement.sql` - ç»“ç®—è¡¨åˆ›å»ºè„šæœ¬

### æ¨¡å‹æ–‡ä»¶
- `/home/vue-element-admin/backend/models/SmsSettlement.js` - ç»“ç®—æ±‡æ€»æ¨¡å‹
- `/home/vue-element-admin/backend/models/SmsSettlementDetail.js` - ç»“ç®—æ˜ç»†æ¨¡å‹
- `/home/vue-element-admin/backend/models/SmsChannelCountry.js` - é€šé“å›½å®¶å®šä»·æ¨¡å‹

### APIè·¯ç”±
- `/home/vue-element-admin/backend/routes/settlements.js` - ç»“ç®—APIè·¯ç”±
- `/home/vue-element-admin/backend/routes/smsChannelCountries.js` - å›½å®¶å®šä»·APIè·¯ç”±

### å‰ç«¯æ–‡ä»¶
- `/home/vue-element-admin/src/views/sms/settlement/index.vue` - ç»“ç®—é¡µé¢
- `/home/vue-element-admin/src/api/smsSettlement.js` - ç»“ç®—APIæ¥å£

### æœåŠ¡å±‚
- `/home/vue-element-admin/backend/services/settlementService.js` - ç»“ç®—ä¸šåŠ¡é€»è¾‘

## æ€»ç»“

âœ… **é—®é¢˜å·²è§£å†³**ï¼šé€šè¿‡æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬åˆ›å»ºäº†ç¼ºå¤±çš„ç»“ç®—ç›¸å…³è¡¨

ğŸ“Š **å½“å‰çŠ¶æ€**ï¼š
- APIæ­£å¸¸å“åº”
- è¿”å›ç©ºåˆ—è¡¨ï¼ˆæ­£å¸¸ï¼Œå› ä¸ºè¿˜æ²¡æœ‰ç»“ç®—æ•°æ®ï¼‰
- æ‰€æœ‰è¡¨ç»“æ„å·²å°±ç»ª

ğŸ¯ **ä¸‹ä¸€æ­¥**ï¼š
1. é…ç½®é€šé“å›½å®¶å®šä»·
2. è§¦å‘æ‰‹åŠ¨ç»“ç®—ç”Ÿæˆæµ‹è¯•æ•°æ®
3. éªŒè¯ç»“ç®—åŠŸèƒ½å®Œæ•´æ€§

---

**ä¿®å¤æ—¶é—´**ï¼š2025-10-22  
**ä¿®å¤äººå‘˜**ï¼šç³»ç»Ÿç®¡ç†å‘˜  
**å½±å“èŒƒå›´**ï¼šç»“ç®—ç®¡ç†åŠŸèƒ½  
**é£é™©ç­‰çº§**ï¼šä½ï¼ˆä»…å½±å“æ–°åŠŸèƒ½ï¼Œä¸å½±å“ç°æœ‰ä¸šåŠ¡ï¼‰
