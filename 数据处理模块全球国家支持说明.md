# 数据处理模块全球国家支持说明

## 更新概述

数据处理模块已全面升级，现已支持全球110个国家和地区的国际手机号码处理。

**更新时间**：2025-10-16

## 支持的国家数量

- **总计**：110个国家和地区
- **覆盖范围**：
  - 亚洲：26个国家
  - 欧洲：21个国家
  - 北美洲：11个国家
  - 南美洲：12个国家
  - 非洲：30个国家
  - 大洋洲：10个国家

## 核心升级内容

### 1. 全局国家配置常量

新增 `STANDARD_PHONE_LENGTH_MAP` 全局配置，包含110个国家的标准手机号长度信息（不含国码）：

```javascript
const STANDARD_PHONE_LENGTH_MAP = {
  '86': [11],          // 中国
  '52': [10],          // 墨西哥
  '971': [9],          // 阿联酋
  // ... 共110个国家配置
};
```

### 2. 智能辅助函数

#### `getStandardPhoneLengths(countryCode)`
获取指定国家的标准手机号长度（不含国码）。

**参数**：
- `countryCode` (string): 国码，如 "52", "86", "971"

**返回**：
- Array: 标准长度数组，如 [10], [9, 10]

**示例**：
```javascript
getStandardPhoneLengths('86')   // 返回 [11]
getStandardPhoneLengths('84')   // 返回 [9, 10]
getStandardPhoneLengths('999')  // 返回 [9, 10, 11] (未知国码的默认值)
```

#### `isValidInternationalPhone(phone, countryCode)`
检查是否为有效的国际手机号码。

**参数**：
- `phone` (string): 手机号码
- `countryCode` (string, 可选): 国码

**返回**：
- boolean: 是否有效

**验证规则**：
1. 基本长度检查：7-19位数字
2. 如果提供国码，检查是否符合该国家标准长度
3. 自动识别是否已包含国码

**示例**：
```javascript
isValidInternationalPhone('8613800138000', '86')      // true
isValidInternationalPhone('13800138000', '86')        // true
isValidInternationalPhone('123', '86')                // false (太短)
isValidInternationalPhone('52123456789012345678', '52') // false (太长)
```

## 已升级的功能

### 1. 增加国码 (addCountryCode)

**智能校验逻辑**：
- ✅ 检查前缀是否已有国码
- ✅ 检查总长度是否符合国家标准
- ✅ 避免重复添加国码
- ✅ 支持110个国家的精确识别

**处理逻辑（四种情况）**：
1. **已有国码且长度标准** → 跳过（不重复添加）
2. **无国码且长度标准** → 添加国码
3. **已有国码但长度异常** → 保持原样（可能是其他国家数据）
4. **其他情况** → 尝试添加国码

**返回数据**：
```javascript
{
  processedCount: 1000,    // 处理总数
  addedCount: 600,         // 添加国码的数量
  skippedCount: 400,       // 跳过的数量
  countryCode: "52"        // 使用的国码
}
```

**示例**：
```javascript
// 越南数据 (国码84)
原始数据：84902712535   (前缀84，总长11位 = 84 + 9位手机号)
处理结果：84902712535   (跳过，已有国码且长度符合标准)

原始数据：902712535     (无前缀，9位手机号)
处理结果：84902712535   (添加国码)

原始数据：849027125     (前缀84，但总长只有9位，异常)
处理结果：849027125     (保持原样，可能是其他数据)
```

### 2. 去除国码 (removeCountryCode)

**智能识别逻辑**：
- ✅ 支持指定国码去除
- ✅ 支持智能识别110个国家的国码自动去除
- ✅ 基于前缀+长度双重校验，确保准确性
- ✅ 按国码长度从长到短检查（3位→2位→1位），避免误判

**处理模式**：

#### 模式1：指定国码去除
```javascript
await removeCountryCode(inputPath, outputPath, '52')
// 只去除墨西哥国码52，且必须符合标准长度
```

#### 模式2：智能去除所有国码
```javascript
await removeCountryCode(inputPath, outputPath, null)
// 自动识别并去除110个国家的任意国码
```

**返回数据**：
```javascript
{
  processedCount: 1000,    // 处理总数
  removedCount: 800,       // 成功去除国码的数量
  skippedCount: 200        // 保持原样的数量
}
```

**智能识别示例**：
```javascript
// 智能去除模式会按国码长度从长到短检查
8613800138000  →  检查3位(861) ✗ → 检查2位(86) ✓ → 去除 → 13800138000
9715551234     →  检查3位(971) ✓ → 去除 → 5551234
5215551234567  →  检查3位(521) ✗ → 检查2位(52) ✓ → 去除 → 5551234567
```

### 3. 上传处理 (processUpload)

**智能过滤逻辑**：
- ✅ 自动过滤不正常的手机号数据
- ✅ 支持全球110个国家的格式验证
- ✅ 可指定国家进行更精确的验证
- ✅ 详细的异常数据分类统计

**过滤规则**：
1. 必须全是数字（去除非数字字符后）
2. 长度在7-19位之间
3. 不能有超过8位连续相同的数字
4. 如果指定国家，必须符合该国家标准格式

**返回数据**：
```javascript
{
  originalCount: 1000,     // 原始数据总数
  validCount: 850,         // 有效数据数量
  invalidCount: 150,       // 无效数据数量
  invalidReasons: {        // 无效原因分类
    nonDigit: 20,          // 包含非数字字符
    tooShort: 30,          // 长度过短
    tooLong: 10,           // 长度过长
    repeating: 40,         // 连续重复数字
    invalidFormat: 50      // 不符合国家标准格式
  },
  preview: [...]           // 前20条预览数据
}
```

**使用示例**：
```javascript
// 基础过滤
await processUpload(inputPath, outputPath, { filterInvalid: true })

// 指定国家精确验证
await processUpload(inputPath, outputPath, { 
  filterInvalid: true, 
  countryCode: '52' 
})
```

### 4. 按运营商提取 (extractByOperator)

**智能处理逻辑**：
- ✅ 智能识别并去除国码
- ✅ 支持指定国码提高准确性
- ✅ 支持110个国家的自动识别
- ✅ 保留原始数据格式（含国码）

**处理流程**：
1. 清理数据（去除非数字字符）
2. 智能去除国码（指定或自动识别）
3. 使用纯手机号匹配号段
4. 保存匹配的原始数据（含国码）

**返回数据**：
```javascript
{
  totalCount: 1000,        // 总数据量
  matchedCount: 300,       // 匹配的数量
  unmatchedCount: 700,     // 未匹配的数量
  segments: ['133', '153'], // 匹配的号段
  countryCode: '86'        // 使用的国码
}
```

**使用示例**：
```javascript
// 指定国码提取（更精确）
await extractByOperator(inputPath, outputPath, ['133', '153'], '86')

// 自动识别国码提取
await extractByOperator(inputPath, outputPath, ['133', '153'], null)
```

### 5. 国码检测 (detectCountryCode)

**智能检测逻辑**：
- ✅ 智能识别110个国家的国码
- ✅ 基于前缀+长度双重验证
- ✅ 统计所有检测到的国码及其频率
- ✅ 识别主要国码（出现频率最高）

**返回数据**：
```javascript
{
  detectedCodes: [         // 所有检测到的国码
    { code: '86', count: 800, percentage: '80.00%' },
    { code: '52', count: 150, percentage: '15.00%' },
    { code: '971', count: 50, percentage: '5.00%' }
  ],
  primaryCode: '86',       // 主要国码
  confidence: '80.00%',    // 置信度
  hasCode: true,           // 是否检测到国码
  totalLines: 1000,        // 文件总行数
  validSamples: 1000,      // 有效样本数
  samples: [...]           // 前20条样本数据
}
```

**检测算法**：
1. 采样前100行数据（可配置）
2. 按国码长度从长到短检查（3位→2位→1位）
3. 匹配标准国码列表
4. 验证总长度是否符合该国家标准
5. 统计频率并排序

### 6. 文件验证 (validateDataFile)

**智能验证逻辑**：
- ✅ 支持基础格式验证
- ✅ 支持指定国家的严格验证
- ✅ 详细的错误原因反馈
- ✅ 70%有效率阈值（宽容模式）

**返回数据**：
```javascript
// 验证成功
{
  valid: true,
  lineCount: 1000,
  countryCode: '52',
  validSampleRate: '95.00%'
}

// 验证失败
{
  valid: false,
  error: '数据格式不正确。检测到 20 条样本中只有 10 条符合格式...',
  invalidReasons: [
    { line: 1, reason: '包含非数字字符' },
    { line: 5, reason: '长度不符(5位)' },
    { line: 8, reason: '不符合52国家标准' }
  ]
}
```

**使用示例**：
```javascript
// 基础验证
await validateDataFile(filePath)

// 指定国家严格验证
await validateDataFile(filePath, '52')
```

### 7. 一键清洗 (cleanData)

**处理流程**（保持不变，但使用全局配置）：
1. **去除异常数据**：清理非数字字符、过滤7-19位范围外的数据
2. **数据去重**：使用Set去重
3. **智能校验国码**：基于110个国家的标准长度配置

**返回数据**：
```javascript
{
  originalCount: 1000,
  invalidCount: 50,
  duplicateCount: 100,
  addedCodeCount: 600,
  skippedCount: 250,
  finalCount: 850,
  steps: [
    {
      step: '去除异常数据',
      removed: 50,
      remaining: 950,
      description: '去除7-19位范围外的数据和超过8位连续相同数字的数据'
    },
    {
      step: '数据去重',
      removed: 100,
      remaining: 850
    },
    {
      step: '智能校验国码',
      added: 600,
      skipped: 250,
      countryCode: '52',
      description: '检查前2位是否为52，且长度符合标准'
    }
  ],
  preview: [...]
}
```

## 技术优势

### 1. 精确的国码识别

**传统方式**（只检查前缀）：
```javascript
// 问题：越南数据84902712535被误判
if (line.startsWith('84')) {
  // 错误地认为这是没有国码的数据
  return '84' + line;  // 结果：8484902712535（错误！）
}
```

**智能方式**（前缀+长度双重校验）：
```javascript
// 正确：同时检查前缀和总长度
const prefix = line.substring(0, 2);  // '84'
const totalLength = line.length;       // 11
const standardLengths = [9, 10];       // 越南标准手机号长度
const standardLengthsWithCode = [11, 12];  // 84 + 9/10

if (prefix === '84' && standardLengthsWithCode.includes(totalLength)) {
  // 前缀是84 且 总长度11符合标准（84+9位）
  return line;  // 跳过，已有国码
}
```

### 2. 避免国码误判

**问题场景**：
- 墨西哥国码 `52`（2位）
- 危地马拉国码 `502`（3位）

**解决方案**：按长度从长到短检查
```javascript
// 数据：5025551234 (危地马拉手机号)
// 错误方式：先检查2位 → 误判为墨西哥52
// 正确方式：先检查3位502 → 正确识别为危地马拉
for (let codeLen = 3; codeLen >= 1; codeLen--) {
  const possibleCode = cleaned.substring(0, codeLen);
  if (STANDARD_PHONE_LENGTH_MAP[possibleCode]) {
    // 检查长度是否匹配...
  }
}
```

### 3. 共用国码支持

**国码共用情况**：
- `1` - 美国、加拿大、多米尼加等
- `7` - 俄罗斯、哈萨克斯坦

**处理方式**：
```javascript
// 都使用相同的标准长度
'1': [10],   // 美国/加拿大等都是10位
'7': [10],   // 俄罗斯/哈萨克斯坦等都是10位
```

### 4. 多长度国家支持

**支持不同长度的国家**：
```javascript
'84': [9, 10],       // 越南：9位或10位
'62': [9, 10, 11],   // 印度尼西亚：9/10/11位
'60': [9, 10],       // 马来西亚：9位或10位
'55': [10, 11],      // 巴西：10位或11位
```

## 兼容性说明

### 向后兼容
- ✅ 所有现有API接口保持不变
- ✅ 返回数据结构向后兼容（仅增加字段）
- ✅ 默认参数保持原有行为

### 性能优化
- ✅ 使用Map数据结构快速查找
- ✅ 优先级检查减少不必要的计算
- ✅ 单次遍历完成多项检查

## 数据标准来源

- **ITU国际电信联盟标准**
- **各国电信监管机构官方规范**
- **实际使用情况调研**

## 完整国家列表

详见：[一键清洗全球国家支持列表.md](./一键清洗全球国家支持列表.md)

包含110个国家和地区的完整信息：
- 国码
- 中英文名称
- 标准手机号长度
- 所属大洲
- 典型号段示例

## 使用建议

### 1. 明确数据来源国家
如果知道数据的来源国家，建议在所有操作中指定 `countryCode` 参数，可以获得更精确的结果。

### 2. 利用智能检测
如果数据来源不明，可先使用 `detectCountryCode()` 检测主要国码，再进行后续处理。

### 3. 组合使用功能
建议的数据处理流程：
```
上传(自动过滤) → 检测国码 → 一键清洗 → 按需提取
```

### 4. 验证处理结果
所有函数都返回详细的统计信息，建议检查返回数据以确认处理结果。

## 更新记录

- **2025-10-16**：全面升级支持110个国家
  - 新增全局国家配置常量
  - 升级7个核心功能
  - 实现智能国码识别算法
  - 修复国码重复添加bug
  - 优化国码去除逻辑
  - 增强数据验证能力

- **之前版本**：支持15个主要国家

## 技术支持

如遇到特定国家的数据处理问题，请提供：
1. 国家名称或国码
2. 示例数据（脱敏）
3. 期望的处理结果
4. 实际的处理结果

我们会及时更新标准配置或优化处理逻辑。
