<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æŒä¹…åŒ–ç®¡ç†ä¸­å¿ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 30px;
            background: #f5f7fa;
            padding: 25px;
            border-radius: 12px;
        }
        
        .section h2 {
            color: #303133;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #409EFF;
        }
        
        .stat-card h3 {
            color: #909399;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-card .value {
            color: #303133;
            font-size: 24px;
            font-weight: bold;
        }
        
        .stat-card .sub-value {
            color: #606266;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: #409EFF;
            color: white;
        }
        
        .btn-success {
            background: #67C23A;
            color: white;
        }
        
        .btn-warning {
            background: #E6A23C;
            color: white;
        }
        
        .btn-danger {
            background: #F56C6C;
            color: white;
        }
        
        .btn-info {
            background: #909399;
            color: white;
        }
        
        .log-container {
            background: #2d3a4b;
            color: #67C23A;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #409EFF;
            padding-left: 10px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .alert.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        .alert-success {
            background: #f0f9ff;
            border-left: 4px solid #67C23A;
            color: #67C23A;
        }
        
        .alert-error {
            background: #fef0f0;
            border-left: 4px solid #F56C6C;
            color: #F56C6C;
        }
        
        .alert-warning {
            background: #fdf6ec;
            border-left: 4px solid #E6A23C;
            color: #E6A23C;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .data-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: #f5f7fa;
            padding: 12px;
            text-align: left;
            color: #606266;
            font-weight: bold;
            border-bottom: 2px solid #e4e7ed;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #ebeef5;
            color: #303133;
        }
        
        .data-table tr:hover {
            background: #f5f7fa;
        }
        
        .emoji {
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’¾ æ•°æ®æŒä¹…åŒ–ç®¡ç†ä¸­å¿ƒ</h1>
            <p>ç®¡ç†å’Œç›‘æ§ç³»ç»Ÿæ•°æ®çš„æ°¸ä¹…å­˜å‚¨</p>
        </div>
        
        <div class="content">
            <div id="alertBox" class="alert"></div>
            
            <!-- æ•°æ®ç»Ÿè®¡ -->
            <div class="section">
                <h2><span class="emoji">ğŸ“Š</span> å­˜å‚¨ç»Ÿè®¡</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <h3>æ€»æ•°æ®é‡</h3>
                        <div class="value" id="totalItems">-</div>
                        <div class="sub-value">è·¨ <span id="totalKeys">-</span> ä¸ªæ•°æ®è¡¨</div>
                    </div>
                    <div class="stat-card">
                        <h3>å­˜å‚¨ç©ºé—´</h3>
                        <div class="value" id="totalSize">-</div>
                        <div class="sub-value">LocalStorage ä½¿ç”¨é‡</div>
                    </div>
                    <div class="stat-card">
                        <h3>å®¢æˆ·æ•°æ®</h3>
                        <div class="value" id="userCount">-</div>
                        <div class="sub-value">æ´»è·ƒç”¨æˆ·è®°å½•</div>
                    </div>
                    <div class="stat-card">
                        <h3>è®¢å•æ•°æ®</h3>
                        <div class="value" id="orderCount">-</div>
                        <div class="sub-value">å†å²è®¢å•è®°å½•</div>
                    </div>
                </div>
            </div>
            
            <!-- æ•°æ®ç®¡ç†æ“ä½œ -->
            <div class="section">
                <h2><span class="emoji">ğŸ› ï¸</span> æ•°æ®ç®¡ç†</h2>
                <div class="button-group">
                    <button class="btn-success" onclick="createBackup()">
                        ğŸ’¾ åˆ›å»ºå¤‡ä»½
                    </button>
                    <button class="btn-primary" onclick="checkIntegrity()">
                        ğŸ” æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
                    </button>
                    <button class="btn-info" onclick="exportData()">
                        ğŸ“¤ å¯¼å‡ºæ•°æ®
                    </button>
                    <button class="btn-warning" onclick="showImport()">
                        ğŸ“¥ å¯¼å…¥æ•°æ®
                    </button>
                    <button class="btn-danger" onclick="confirmClear()">
                        ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®
                    </button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
            
            <!-- è¯¦ç»†ç»Ÿè®¡ -->
            <div class="section">
                <h2><span class="emoji">ğŸ“ˆ</span> æ•°æ®è¯¦æƒ…</h2>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>æ•°æ®è¡¨</th>
                                <th>è®°å½•æ•°</th>
                                <th>å¤§å°</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody id="detailsTable">
                            <tr>
                                <td colspan="4" style="text-align: center; color: #909399;">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- å˜æ›´æ—¥å¿— -->
            <div class="section">
                <h2><span class="emoji">ğŸ“</span> æœ€è¿‘å˜æ›´æ—¥å¿—</h2>
                <div class="log-container" id="changeLog">
                    <div class="log-entry">æš‚æ— æ—¥å¿—</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æŒä¹…åŒ–å­˜å‚¨ç®¡ç†ç±»ï¼ˆç®€åŒ–ç‰ˆï¼‰
        class PersistentStorage {
            constructor() {
                this.storageKeys = {
                    userList: 'å®¢æˆ·åˆ—è¡¨',
                    agentList: 'ä»£ç†åˆ—è¡¨',
                    dataLibrary: 'æ•°æ®åº“',
                    orderList: 'è®¢å•åˆ—è¡¨',
                    rechargeRecords: 'å……å€¼è®°å½•',
                    feedbackList: 'åé¦ˆè®°å½•'
                }
                this.backupKey = '_storage_backup_'
                this.changeLogKey = '_change_log_'
            }

            get(key) {
                try {
                    const data = localStorage.getItem(key)
                    return data ? JSON.parse(data) : []
                } catch (error) {
                    console.error(`è¯»å–å¤±è´¥ [${key}]:`, error)
                    return []
                }
            }

            set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value))
                    this.logChange(key, {
                        action: 'set',
                        timestamp: Date.now(),
                        count: Array.isArray(value) ? value.length : 1
                    })
                    return true
                } catch (error) {
                    console.error(`ä¿å­˜å¤±è´¥ [${key}]:`, error)
                    return false
                }
            }

            createBackup() {
                try {
                    const backup = {}
                    Object.keys(this.storageKeys).forEach(key => {
                        backup[key] = this.get(key)
                    })
                    backup._timestamp = Date.now()
                    localStorage.setItem(this.backupKey, JSON.stringify(backup))
                    console.log('âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸ')
                    return true
                } catch (error) {
                    console.error('âŒ å¤‡ä»½å¤±è´¥:', error)
                    return false
                }
            }

            recoverFromBackup() {
                try {
                    const backupData = localStorage.getItem(this.backupKey)
                    if (!backupData) {
                        throw new Error('æœªæ‰¾åˆ°å¤‡ä»½')
                    }
                    const backup = JSON.parse(backupData)
                    Object.keys(this.storageKeys).forEach(key => {
                        if (backup[key]) {
                            this.set(key, backup[key])
                        }
                    })
                    console.log('âœ… æ¢å¤æˆåŠŸ')
                    return true
                } catch (error) {
                    console.error('âŒ æ¢å¤å¤±è´¥:', error)
                    return false
                }
            }

            logChange(key, info) {
                try {
                    const logs = JSON.parse(localStorage.getItem(this.changeLogKey) || '[]')
                    logs.push({ key, ...info })
                    if (logs.length > 100) logs.shift()
                    localStorage.setItem(this.changeLogKey, JSON.stringify(logs))
                } catch (error) {
                    console.error('æ—¥å¿—è®°å½•å¤±è´¥:', error)
                }
            }

            getChangeLogs(limit = 10) {
                try {
                    const logs = JSON.parse(localStorage.getItem(this.changeLogKey) || '[]')
                    return logs.slice(-limit).reverse()
                } catch (error) {
                    return []
                }
            }

            getStatistics() {
                const stats = {
                    totalKeys: 0,
                    totalItems: 0,
                    totalSize: 0,
                    details: {}
                }

                Object.keys(this.storageKeys).forEach(key => {
                    const data = this.get(key)
                    const jsonStr = JSON.stringify(data)
                    
                    stats.details[key] = {
                        count: Array.isArray(data) ? data.length : 0,
                        size: jsonStr.length,
                        sizeKB: (jsonStr.length / 1024).toFixed(2)
                    }

                    stats.totalKeys++
                    stats.totalItems += stats.details[key].count
                    stats.totalSize += stats.details[key].size
                })

                stats.totalSizeKB = (stats.totalSize / 1024).toFixed(2)
                return stats
            }

            exportAllData() {
                const exportData = {
                    version: '1.0',
                    exportTime: Date.now(),
                    data: {}
                }

                Object.keys(this.storageKeys).forEach(key => {
                    exportData.data[key] = this.get(key)
                })

                return exportData
            }

            importData(importData) {
                try {
                    if (!importData || !importData.data) {
                        throw new Error('æ— æ•ˆçš„å¯¼å…¥æ•°æ®')
                    }

                    this.createBackup()
                    
                    Object.entries(importData.data).forEach(([key, value]) => {
                        this.set(key, value)
                    })

                    return true
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error)
                    this.recoverFromBackup()
                    return false
                }
            }

            clearAll() {
                this.createBackup()
                Object.keys(this.storageKeys).forEach(key => {
                    localStorage.removeItem(key)
                })
                return true
            }

            checkDataIntegrity() {
                const report = {
                    valid: true,
                    issues: [],
                    details: {}
                }

                Object.keys(this.storageKeys).forEach(key => {
                    const data = this.get(key)
                    report.details[key] = {
                        exists: data !== null,
                        count: Array.isArray(data) ? data.length : 0,
                        isArray: Array.isArray(data)
                    }

                    if (!Array.isArray(data)) {
                        report.issues.push(`${this.storageKeys[key]}: æ•°æ®æ ¼å¼é”™è¯¯`)
                        report.valid = false
                    }
                })

                return report
            }
        }

        const storage = new PersistentStorage()

        // åˆå§‹åŒ–é¡µé¢
        function init() {
            loadStatistics()
            loadChangeLogs()
        }

        function loadStatistics() {
            const stats = storage.getStatistics()
            
            document.getElementById('totalItems').textContent = stats.totalItems
            document.getElementById('totalKeys').textContent = stats.totalKeys
            document.getElementById('totalSize').textContent = stats.totalSizeKB + ' KB'
            document.getElementById('userCount').textContent = stats.details.userList?.count || 0
            document.getElementById('orderCount').textContent = stats.details.orderList?.count || 0

            // æ›´æ–°è¯¦æƒ…è¡¨æ ¼
            const tbody = document.getElementById('detailsTable')
            tbody.innerHTML = ''
            
            Object.entries(storage.storageKeys).forEach(([key, name]) => {
                const detail = stats.details[key]
                const row = tbody.insertRow()
                row.innerHTML = `
                    <td>${name}</td>
                    <td>${detail.count} æ¡</td>
                    <td>${detail.sizeKB} KB</td>
                    <td><span style="color: #67C23A;">âœ“ æ­£å¸¸</span></td>
                `
            })
        }

        function loadChangeLogs() {
            const logs = storage.getChangeLogs()
            const logContainer = document.getElementById('changeLog')
            
            if (logs.length === 0) {
                logContainer.innerHTML = '<div class="log-entry">æš‚æ— å˜æ›´è®°å½•</div>'
                return
            }

            logContainer.innerHTML = logs.map(log => {
                const time = new Date(log.timestamp).toLocaleString('zh-CN')
                const keyName = storage.storageKeys[log.key] || log.key
                return `<div class="log-entry">
                    [${time}] ${keyName} - ${log.action} - ${log.count || 0} æ¡è®°å½•
                </div>`
            }).join('')
        }

        function createBackup() {
            const result = storage.createBackup()
            showAlert(result ? 'success' : 'error', 
                result ? 'âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸï¼' : 'âŒ å¤‡ä»½åˆ›å»ºå¤±è´¥')
            loadChangeLogs()
        }

        function checkIntegrity() {
            const report = storage.checkDataIntegrity()
            if (report.valid) {
                showAlert('success', 'âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡ï¼æ‰€æœ‰æ•°æ®æ­£å¸¸')
            } else {
                showAlert('warning', 'âš ï¸ å‘ç°é—®é¢˜ï¼š' + report.issues.join('ã€'))
            }
        }

        function exportData() {
            const data = storage.exportAllData()
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `data-export-${Date.now()}.json`
            a.click()
            URL.revokeObjectURL(url)
            showAlert('success', 'âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼')
        }

        function showImport() {
            document.getElementById('importFile').click()
        }

        function importData(event) {
            const file = event.target.files[0]
            if (!file) return

            const reader = new FileReader()
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result)
                    const result = storage.importData(data)
                    showAlert(result ? 'success' : 'error',
                        result ? 'âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼' : 'âŒ æ•°æ®å¯¼å…¥å¤±è´¥')
                    if (result) {
                        loadStatistics()
                        loadChangeLogs()
                    }
                } catch (error) {
                    showAlert('error', 'âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + error.message)
                }
            }
            reader.readAsText(file)
        }

        function confirmClear() {
            if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¼šå…ˆåˆ›å»ºå¤‡ä»½ï¼Œå¯ä»¥é€šè¿‡å¤‡ä»½æ¢å¤ã€‚')) {
                storage.clearAll()
                showAlert('warning', 'âš ï¸ æ•°æ®å·²æ¸…ç©ºï¼ˆå¤‡ä»½å·²ä¿ç•™ï¼‰')
                loadStatistics()
                loadChangeLogs()
            }
        }

        function showAlert(type, message) {
            const alertBox = document.getElementById('alertBox')
            alertBox.className = `alert alert-${type} show`
            alertBox.innerHTML = `<strong>${message}</strong>`
            
            setTimeout(() => {
                alertBox.classList.remove('show')
            }, 5000)
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = init
    </script>
</body>
</html>
