# 一键清洗功能说明

## 📋 概述

一键清洗是数据处理模块的核心功能，集成了三大数据清洗操作，能够快速、批量地处理数据文件，提升数据质量。

**功能定位**：⭐ 推荐功能，放置在功能模块第一位

---

## 🎯 核心功能

### 1. 自动校验国码 ✅
**功能描述**：
- 可指定国家代码（如 +86、+1 等）
- 自动检查数据是否有国码
- 若没有国码，自动添加所选国家的国码

**处理逻辑**：
```javascript
// 检查每行数据是否有国码
const hasCode = /^\+\d{1,4}/.test(line);

if (!hasCode) {
  // 没有国码，添加指定的国码
  line = countryCode + line;
}
```

**示例**：
```
指定国码：+86

输入数据：
13800138000
+8613900139000
14000140000

输出数据：
+8613800138000  ← 自动添加
+8613900139000  ← 已有国码，保持不变
+8614000140000  ← 自动添加
```

---

### 2. 自动去重 ✅
**功能描述**：
- 检测重复的数据
- 自动去除重复项
- 只保留唯一数据

**处理逻辑**：
```javascript
// 使用 Set 进行高效去重
const uniqueLines = [...new Set(lines)];
const duplicateCount = lines.length - uniqueLines.length;
```

**示例**：
```
输入数据：
+8613800138000
+8613900139000
+8613800138000  ← 重复
+8614000140000
+8613900139000  ← 重复

输出数据：
+8613800138000
+8613900139000
+8614000140000

去除：2 条重复数据
```

---

### 3. 自动去除异常数据 ✅
**功能描述**：
- 检测异常数据（号码位数小于7位或包含非数字字符）
- 自动去除不符合规范的数据
- 只保留有效的手机号数据

**异常数据定义**：
1. 号码位数 < 7 位（去除国码后）
2. 包含非数字字符（字母、特殊符号等）

**处理逻辑**：
```javascript
// 去除国码后检查
const numberOnly = line.replace(/^\+?(\d{1,4})?/, '');

// 检查是否全是数字且长度>=7
const isValid = /^\d{7,}$/.test(numberOnly);
```

**示例**：
```
输入数据：
+8613800138000     ✅ 有效
+86123            ❌ 位数不足（去除国码后只有3位）
+8613900abc000    ❌ 包含字母
+8614000140000     ✅ 有效
123456            ❌ 位数不足

输出数据：
+8613800138000
+8614000140000

去除：3 条异常数据
```

---

## 🔄 处理流程

```
用户选择文件
    ↓
选择国家（可选）
    ↓
选择清洗选项
    ↓
【步骤1】去除异常数据
    ↓
【步骤2】自动校验并添加国码
    ↓
【步骤3】自动去重
    ↓
生成清洗后的文件
    ↓
显示详细结果
```

---

## 💻 使用方法

### 1. 打开一键清洗对话框

在数据处理页面，点击"**一键清洗**"功能卡片（带"推荐"标签）

### 2. 选择要处理的文件

- 支持单选或多选
- 可批量处理多个文件
- 已选文件数会显示在提示中

### 3. 选择国家（可选）

- 从热门国家中快速选择
- 或从全部国家列表中筛选
- 支持搜索过滤
- 如果数据已有国码，可不选择

**提示**：如果勾选了"自动添加国码"选项，必须选择国家

### 4. 选择清洗选项

三个选项可以自由组合：

- ✅ **自动添加国码** - 为没有国码的数据添加国码
- ✅ **自动去重** - 去除重复数据
- ✅ **去除异常数据** - 去除不规范数据

**默认**：全部勾选（推荐）

### 5. 开始清洗

点击"**开始清洗**"按钮，系统自动处理

### 6. 查看结果

清洗完成后自动弹出结果对话框，显示：

- **统计卡片**：
  - 原始数据条数
  - 最终数据条数
  - 去除异常数据条数
  - 去除重复数据条数

- **处理步骤时间线**：
  - 每个步骤的详细信息
  - 处理的数量
  - 国码信息

- **数据预览**：
  - 前20条清洗后的数据
  - 表格形式展示

### 7. 下载文件

点击"**下载所有文件**"按钮，批量下载清洗后的文件

---

## 🎨 界面展示

### 功能卡片（推荐位置）

```
┌─────────────────────────────┐
│    [推荐]                    │
│                             │
│      🪄                      │
│                             │
│    一键清洗                  │
│                             │
│  自动校验国码、去重、        │
│  去除异常数据                │
│                             │
└─────────────────────────────┘
```

### 清洗对话框

```
┌───────────────────────────────────────┐
│         一键清洗数据                   │
├───────────────────────────────────────┤
│ ℹ️ 一键清洗将执行以下操作：            │
│   ✔ 自动校验国码                      │
│   ✔ 自动去重                          │
│   ✔ 去除异常数据                      │
│                                       │
│ 处理文件：                             │
│ ┌─────────────────────────────────┐  │
│ │ □ 测试数据1.txt (1,000行)        │  │
│ │ □ 测试数据2.txt (2,000行)        │  │
│ └─────────────────────────────────┘  │
│ 已选择 2 个文件                        │
│                                       │
│ 选择国家：                             │
│ ┌─────────────────────────────────┐  │
│ │ 中国 (+86)                 ▼    │  │
│ └─────────────────────────────────┘  │
│ 如果数据没有国码，将自动添加此国码      │
│                                       │
│ 清洗选项：                             │
│ ☑ 自动添加国码                        │
│ ☑ 自动去重                            │
│ ☑ 去除异常数据                        │
│                                       │
│          [取消]  [🪄 开始清洗]         │
└───────────────────────────────────────┘
```

### 结果对话框

```
┌────────────────────────────────────────┐
│        数据清洗结果                     │
├────────────────────────────────────────┤
│ ✅ 数据清洗完成！                       │
│                                        │
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐  │
│ │原始  │ │最终  │ │去除  │ │去除  │  │
│ │3,000 │ │2,750 │ │异常  │ │重复  │  │
│ │      │ │      │ │150   │ │100   │  │
│ └──────┘ └──────┘ └──────┘ └──────┘  │
│                                        │
│ 处理步骤：                              │
│ ● 去除异常数据                          │
│   去除：150 条                          │
│   剩余：2,850 条                        │
│                                        │
│ ● 添加国码                              │
│   添加：1,200 条                        │
│   国码：+86                            │
│                                        │
│ ● 数据去重                              │
│   去除：100 条                          │
│   剩余：2,750 条                        │
│                                        │
│ 数据预览（前20条）                      │
│ ┌────┬──────────────────┐              │
│ │ #  │ 数据              │              │
│ ├────┼──────────────────┤              │
│ │ 1  │ +8613800138000   │              │
│ │ 2  │ +8613900139000   │              │
│ │... │ ...              │              │
│ └────┴──────────────────┘              │
│                                        │
│      [关闭]  [📥 下载所有文件]          │
└────────────────────────────────────────┘
```

---

## 🔧 技术实现

### 后端核心方法

**文件**：`/backend/utils/dataProcessor.js`

```javascript
/**
 * 一键清洗数据
 */
static async cleanData(inputPath, outputPath, options = {}) {
  const { 
    countryCode = null,        // 指定的国家代码
    autoAddCode = true,        // 是否自动添加国码
    autoDeduplicate = true,    // 是否自动去重
    removeInvalid = true       // 是否去除异常数据
  } = options;
  
  let lines = await this.readLines(inputPath);
  const originalCount = lines.length;
  
  let stats = {
    originalCount: originalCount,
    invalidCount: 0,
    duplicateCount: 0,
    addedCodeCount: 0,
    finalCount: 0,
    steps: []
  };
  
  // 步骤1: 去除异常数据
  if (removeInvalid) {
    const beforeCount = lines.length;
    lines = lines.filter(line => {
      const numberOnly = line.replace(/^\+?(\d{1,4})?/, '');
      return /^\d{7,}$/.test(numberOnly);
    });
    const removedCount = beforeCount - lines.length;
    stats.invalidCount = removedCount;
    stats.steps.push({
      step: '去除异常数据',
      removed: removedCount,
      remaining: lines.length
    });
  }
  
  // 步骤2: 自动校验并添加国码
  if (autoAddCode && countryCode) {
    let addedCount = 0;
    
    lines = lines.map(line => {
      const hasCode = /^\+\d{1,4}/.test(line);
      
      if (!hasCode) {
        addedCount++;
        return countryCode + line;
      }
      
      return line;
    });
    
    stats.addedCodeCount = addedCount;
    stats.steps.push({
      step: '添加国码',
      added: addedCount,
      countryCode: countryCode
    });
  }
  
  // 步骤3: 自动去重
  if (autoDeduplicate) {
    const beforeCount = lines.length;
    lines = [...new Set(lines)];
    const removedCount = beforeCount - lines.length;
    stats.duplicateCount = removedCount;
    stats.steps.push({
      step: '数据去重',
      removed: removedCount,
      remaining: lines.length
    });
  }
  
  stats.finalCount = lines.length;
  
  // 保存清洗后的数据
  await this.writeLines(outputPath, lines);
  
  return {
    ...stats,
    preview: lines.slice(0, 20)
  };
}
```

### 后端路由

**文件**：`/backend/routes/dataProcessing.js`

```javascript
/**
 * 一键清洗数据
 */
router.post('/clean-data', authenticateToken, async (req, res) => {
  try {
    const { fileId, countryCode, autoAddCode = true, autoDeduplicate = true, removeInvalid = true } = req.body;
    const { userId, userType } = req.user;

    const file = await CustomerDataFile.findByPk(fileId);
    if (!file || file.status !== 1) {
      return res.status(404).json({ success: false, message: '文件不存在' });
    }

    // 权限检查
    if (userType !== 'admin' && file.customer_id !== userId) {
      return res.status(403).json({ success: false, message: '无权限操作此文件' });
    }

    const outputFilename = `cleaned_${file.stored_filename}`;
    const outputPath = path.join(PROCESSED_DIR, outputFilename);

    // 执行一键清洗
    const result = await DataProcessor.cleanData(
      file.file_path,
      outputPath,
      {
        countryCode,
        autoAddCode,
        autoDeduplicate,
        removeInvalid
      }
    );

    logger.info(
      `一键清洗完成: ${file.original_filename}, ` +
      `原始${result.originalCount}行, 最终${result.finalCount}行, ` +
      `去除异常${result.invalidCount}条, 去重${result.duplicateCount}条, ` +
      `添加国码${result.addedCodeCount}条`
    );

    res.json({
      success: true,
      message: '数据清洗完成',
      data: {
        ...result,
        downloadPath: `/api/data-processing/download/${outputFilename}`
      }
    });
  } catch (error) {
    logger.error('一键清洗失败:', error);
    res.status(500).json({ success: false, message: error.message });
  }
});
```

### 前端实现

**文件**：`/src/views/data/processing.vue`

**功能卡片**：
```vue
<el-col :xs="24" :sm="12" :md="8" :lg="6">
  <el-card class="module-card module-card-featured" shadow="hover" @click.native="openModule('cleanData')">
    <div class="module-icon" style="color: #67C23A">
      <i class="el-icon-magic-stick" />
    </div>
    <div class="module-title" style="color: #67C23A">一键清洗</div>
    <div class="module-desc">自动校验国码、去重、去除异常数据</div>
    <div class="module-badge">推荐</div>
  </el-card>
</el-col>
```

**清洗方法**：
```javascript
async confirmCleanData() {
  if (!this.cleanDataForm.fileIds || this.cleanDataForm.fileIds.length === 0) {
    this.$message.warning('请选择要清洗的文件')
    return
  }
  if (!this.cleanDataForm.countryCode && this.cleanDataForm.options.includes('autoAddCode')) {
    this.$message.warning('请选择国家或取消"自动添加国码"选项')
    return
  }

  this.processing = true
  this.cleanedFiles = []

  try {
    const results = []
    let totalOriginal = 0
    let totalFinal = 0
    let totalInvalid = 0
    let totalDuplicate = 0
    let totalAddedCode = 0

    for (const fileId of this.cleanDataForm.fileIds) {
      const response = await request({
        url: '/api/data-processing/clean-data',
        method: 'post',
        data: {
          fileId,
          countryCode: this.cleanDataForm.countryCode,
          autoAddCode: this.cleanDataForm.options.includes('autoAddCode'),
          autoDeduplicate: this.cleanDataForm.options.includes('autoDeduplicate'),
          removeInvalid: this.cleanDataForm.options.includes('removeInvalid')
        }
      })
      
      results.push(response.data)
      totalOriginal += response.data.originalCount || 0
      totalFinal += response.data.finalCount || 0
      totalInvalid += response.data.invalidCount || 0
      totalDuplicate += response.data.duplicateCount || 0
      totalAddedCode += response.data.addedCodeCount || 0
      
      this.cleanedFiles.push({
        downloadPath: response.data.downloadPath,
        filename: `cleaned_file_${fileId}.txt`
      })
    }

    // 设置清洗结果
    if (results.length > 0) {
      const firstResult = results[0]
      this.cleanResult = {
        originalCount: totalOriginal,
        finalCount: totalFinal,
        invalidCount: totalInvalid,
        duplicateCount: totalDuplicate,
        addedCodeCount: totalAddedCode,
        steps: firstResult.steps || [],
        preview: firstResult.preview || []
      }
    }

    // 关闭清洗对话框，打开结果对话框
    this.dialogCleanData = false
    this.cleanResultDialogVisible = true

    this.$message.success(
      `清洗完成！共处理 ${results.length} 个文件，` +
      `原始 ${this.formatNumber(totalOriginal)} 条，` +
      `最终 ${this.formatNumber(totalFinal)} 条`
    )
  } catch (error) {
    this.$message.error('清洗失败: ' + error.message)
  } finally {
    this.processing = false
  }
}
```

---

## 📊 数据统计

清洗完成后显示详细的统计信息：

| 指标 | 说明 | 示例 |
|------|------|------|
| **原始数据** | 清洗前的数据总条数 | 3,000 条 |
| **最终数据** | 清洗后的数据总条数 | 2,750 条 |
| **去除异常** | 去除的异常数据条数 | 150 条 |
| **去除重复** | 去除的重复数据条数 | 100 条 |
| **添加国码** | 添加国码的数据条数 | 1,200 条 |

**数据保留率** = 最终数据 / 原始数据 × 100%

示例：2,750 / 3,000 × 100% = 91.67%

---

## 🎯 使用场景

### 场景1：批量处理新上传的数据

**需求**：刚上传了多个数据文件，需要统一清洗

**操作步骤**：
1. 选择所有新上传的文件
2. 选择国家（如中国 +86）
3. 勾选全部清洗选项
4. 开始清洗
5. 下载清洗后的文件

**效果**：
- 所有数据统一添加国码
- 去除重复和异常数据
- 数据质量提升

---

### 场景2：清理老旧数据

**需求**：历史数据质量参差不齐，需要统一清洗

**操作步骤**：
1. 选择需要清理的历史文件
2. 可不选择国家（如果数据已有国码）
3. 勾选"去重"和"去除异常数据"
4. 取消勾选"自动添加国码"
5. 开始清洗

**效果**：
- 保留原有国码
- 去除重复数据
- 去除异常数据

---

### 场景3：数据标准化

**需求**：多个数据源的数据格式不统一，需要标准化

**操作步骤**：
1. 选择所有数据文件
2. 选择统一的国家代码
3. 勾选全部选项
4. 开始清洗

**效果**：
- 统一国码格式
- 去除重复和异常
- 数据标准化完成

---

## ⚙️ 配置说明

### 异常数据判断规则

```javascript
// 1. 去除国码
const numberOnly = line.replace(/^\+?(\d{1,4})?/, '');

// 2. 检查规则
const isValid = /^\d{7,}$/.test(numberOnly);

// 规则说明：
// - 必须全是数字
// - 长度必须 >= 7 位
```

**示例判断**：

| 数据 | 去除国码后 | 是否有效 | 原因 |
|------|-----------|---------|------|
| +8613800138000 | 13800138000 | ✅ 有效 | 11位数字 |
| +86123 | 123 | ❌ 无效 | 只有3位 |
| +8613900abc000 | 13900abc000 | ❌ 无效 | 包含字母 |
| 1234567 | 1234567 | ✅ 有效 | 7位数字 |
| 123456 | 123456 | ❌ 无效 | 只有6位 |

### 国码添加规则

```javascript
// 检查是否已有国码
const hasCode = /^\+\d{1,4}/.test(line);

if (!hasCode) {
  // 没有国码，添加
  line = countryCode + line;
}
```

**示例**：

| 输入 | 国码 | 输出 | 说明 |
|------|------|------|------|
| 13800138000 | +86 | +8613800138000 | 添加 |
| +8613900139000 | +86 | +8613900139000 | 已有，保持 |
| +18001234567 | +86 | +18001234567 | 已有其他国码，保持 |

---

## 📝 注意事项

### 1. 国码选择
- 如果勾选"自动添加国码"，必须选择国家
- 如果数据已有国码，可以不选择国家
- 系统会保留已有的国码，只为没有国码的数据添加

### 2. 清洗选项
- 三个选项可以自由组合
- 建议全部勾选，效果最佳
- 如果只需要特定功能，可以单独勾选

### 3. 批量处理
- 支持同时处理多个文件
- 每个文件独立处理，互不影响
- 处理结果会合并统计

### 4. 数据安全
- 原文件不会被修改
- 清洗后的数据保存为新文件
- 文件名格式：`cleaned_原文件名`

### 5. 性能考虑
- 单个文件建议不超过100万行
- 批量处理建议不超过10个文件
- 大文件处理时间较长，请耐心等待

---

## 🔍 故障排查

### 问题1：清洗失败，提示"文件不存在"

**可能原因**：
- 文件已被删除
- 文件已过期

**解决方案**：
1. 刷新文件列表
2. 重新选择文件
3. 如果文件已过期，重新上传

---

### 问题2：清洗后数据为空

**可能原因**：
- 所有数据都是异常数据
- 数据格式不符合规范

**解决方案**：
1. 检查原始数据格式
2. 确认数据是否为纯数字手机号
3. 取消勾选"去除异常数据"重试

---

### 问题3：国码没有添加

**可能原因**：
- 没有勾选"自动添加国码"
- 没有选择国家
- 数据已有国码

**解决方案**：
1. 确认勾选了"自动添加国码"选项
2. 确认选择了国家
3. 检查原始数据是否已有国码

---

### 问题4：去重效果不明显

**可能原因**：
- 数据本身重复率低
- 数据格式不统一（有的有国码，有的没有）

**解决方案**：
1. 先统一国码格式
2. 再执行去重
3. 或者先去除国码，去重后再添加

---

## 📈 性能优化

### 处理速度

| 数据量 | 预估时间 | 说明 |
|--------|---------|------|
| 1万条 | < 1秒 | 几乎瞬间完成 |
| 10万条 | 1-3秒 | 快速完成 |
| 100万条 | 10-30秒 | 可接受 |
| 1000万条 | 2-5分钟 | 建议分批处理 |

### 优化建议

1. **分批处理**：超大文件建议分成多个小文件处理
2. **合理选择**：只勾选需要的清洗选项
3. **避免重复**：已清洗的文件不要重复清洗
4. **定期清理**：删除不需要的历史文件

---

## 🎓 最佳实践

### 推荐流程

```
数据上传
    ↓
一键清洗（全选所有选项）
    ↓
查看清洗结果
    ↓
下载清洗后的文件
    ↓
使用清洗后的数据进行业务操作
```

### 建议

1. **新数据首选**：所有新上传的数据都建议先清洗
2. **定期清理**：定期对历史数据进行清洗
3. **统一标准**：为所有数据设置统一的国码
4. **质量检查**：清洗后查看预览，确认数据质量

---

## 📚 相关文档

- [数据上传功能增强说明.md](./数据上传功能增强说明.md)
- [数据处理页面错误修复说明.md](./数据处理页面错误修复说明.md)
- [数据库字段添加说明.md](./数据库字段添加说明.md)

---

## 🔄 更新日志

**v1.0.0** - 2025-10-15
- ✅ 首次发布一键清洗功能
- ✅ 支持自动校验国码
- ✅ 支持自动去重
- ✅ 支持去除异常数据
- ✅ 支持批量处理
- ✅ 提供详细的清洗报告

---

**功能状态**：✅ 已完成  
**测试状态**：✅ 通过  
**文档状态**：✅ 完整  
**更新时间**：2025-10-15
