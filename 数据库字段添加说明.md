# 数据库字段添加说明

## 问题描述

登录 admin 账号时出现错误：
```
Unknown column 'country_code' in 'field list'
```

**原因**：代码中已经添加了 `country_code` 和 `country_name` 字段到模型，但数据库表中还没有这些字段。

---

## 解决方案

### 1. 添加字段到 users 表

```sql
USE vue_admin;

ALTER TABLE users 
ADD COLUMN country_code VARCHAR(10) NULL COMMENT '国家代码(如：+86)' AFTER overdraft_amount,
ADD COLUMN country_name VARCHAR(50) NULL COMMENT '国家名称' AFTER country_code;
```

**执行命令**：
```bash
cd /home/vue-element-admin/backend
mysql -u root -e "USE vue_admin; ALTER TABLE users ADD COLUMN country_code VARCHAR(10) NULL COMMENT '国家代码(如：+86)' AFTER overdraft_amount, ADD COLUMN country_name VARCHAR(50) NULL COMMENT '国家名称' AFTER country_code;"
```

---

### 2. 添加字段到 agents 表

```sql
USE vue_admin;

ALTER TABLE agents 
ADD COLUMN country_code VARCHAR(10) NULL COMMENT '国家代码(如：+86)' AFTER monthly_commission,
ADD COLUMN country_name VARCHAR(50) NULL COMMENT '国家名称' AFTER country_code;
```

**执行命令**：
```bash
cd /home/vue-element-admin/backend
mysql -u root -e "USE vue_admin; ALTER TABLE agents ADD COLUMN country_code VARCHAR(10) NULL COMMENT '国家代码(如：+86)' AFTER monthly_commission, ADD COLUMN country_name VARCHAR(50) NULL COMMENT '国家名称' AFTER country_code;"
```

---

## 验证字段

### 查看 users 表结构
```bash
mysql -u root -e "USE vue_admin; DESCRIBE users;" | grep country
```

**预期输出**：
```
country_code    varchar(10)    YES        NULL
country_name    varchar(50)    YES        NULL
```

### 查看 agents 表结构
```bash
mysql -u root -e "USE vue_admin; DESCRIBE agents;" | grep country
```

**预期输出**：
```
country_code    varchar(10)    YES        NULL
country_name    varchar(50)    YES        NULL
```

---

## 重启服务

添加字段后需要重启后端服务：

```bash
# 查找并停止旧进程
ps aux | grep "node.*server.js" | grep -v grep | awk '{print $2}' | xargs kill -9

# 启动新服务
cd /home/vue-element-admin/backend
nohup node server.js > /tmp/backend.log 2>&1 &

# 查看启动日志
tail -20 /tmp/backend.log
```

---

## 字段说明

### country_code
- **类型**：VARCHAR(10)
- **可空**：是（NULL）
- **说明**：存储国家代码，格式如 `+86`、`+1`、`+852` 等
- **用途**：
  - 上传数据时进行国码校验
  - 用户基本信息显示
  - 数据筛选和统计

### country_name
- **类型**：VARCHAR(50)
- **可空**：是（NULL）
- **说明**：存储国家名称中文，如 `中国`、`美国`、`英国` 等
- **用途**：
  - 前端界面友好显示
  - 符合国家字段显示规范（优先显示中文名称）
  - 用户基本信息展示

---

## 完整的表结构（更新后）

### users 表
```
+------------------+---------------+------+-----+---------+----------------+
| Field            | Type          | Null | Key | Default | Extra          |
+------------------+---------------+------+-----+---------+----------------+
| id               | int(11)       | NO   | PRI | NULL    | auto_increment |
| login_account    | varchar(50)   | NO   | UNI | NULL    |                |
| login_password   | varchar(255)  | NO   |     | NULL    |                |
| customer_name    | varchar(100)  | NO   |     | NULL    |                |
| email            | varchar(100)  | NO   |     | NULL    |                |
| agent_id         | int(11)       | YES  | MUL | NULL    |                |
| agent_name       | varchar(100)  | YES  |     | NULL    |                |
| sale_price_rate  | decimal(5,2)  | YES  |     | 1.00    |                |
| account_balance  | decimal(15,5) | YES  |     | 0.00000 |                |
| overdraft_amount | decimal(15,5) | YES  |     | 0.00000 |                |
| country_code     | varchar(10)   | YES  |     | NULL    |    ← 新增      |
| country_name     | varchar(50)   | YES  |     | NULL    |    ← 新增      |
| status           | tinyint(4)    | YES  |     | 1       |                |
| create_time      | bigint(20)    | NO   |     | NULL    |                |
| update_time      | bigint(20)    | YES  |     | NULL    |                |
| remark           | text          | YES  |     | NULL    |                |
+------------------+---------------+------+-----+---------+----------------+
```

### agents 表
```
+--------------------+---------------+------+-----+---------+----------------+
| Field              | Type          | Null | Key | Default | Extra          |
+--------------------+---------------+------+-----+---------+----------------+
| id                 | int(11)       | NO   | PRI | NULL    | auto_increment |
| agent_name         | varchar(100)  | NO   |     | NULL    |                |
| login_account      | varchar(50)   | NO   | UNI | NULL    |                |
| login_password     | varchar(255)  | NO   |     | NULL    |                |
| agent_code         | varchar(50)   | YES  | UNI | NULL    |                |
| parent_agent_id    | int(11)       | YES  |     | NULL    |                |
| level              | varchar(20)   | YES  |     | NULL    |                |
| commission         | decimal(5,2)  | YES  |     | 0.00    |                |
| region             | varchar(100)  | YES  |     | NULL    |                |
| email              | varchar(100)  | YES  |     | NULL    |                |
| bind_users         | int(11)       | YES  |     | 0       |                |
| total_commission   | decimal(15,2) | YES  |     | 0.00    |                |
| monthly_commission | decimal(15,2) | YES  |     | 0.00    |                |
| country_code       | varchar(10)   | YES  |     | NULL    |    ← 新增      |
| country_name       | varchar(50)   | YES  |     | NULL    |    ← 新增      |
| status             | tinyint(4)    | YES  |     | 1       |                |
| create_time        | bigint(20)    | NO   |     | NULL    |                |
| update_time        | bigint(20)    | YES  |     | NULL    |                |
| remark             | text          | YES  |     | NULL    |                |
+--------------------+---------------+------+-----+---------+----------------+
```

---

## 相关功能

这两个字段支持以下功能：

1. **数据上传功能增强**
   - 上传时自动检测数据中的国码
   - 校验上传数据的国码与用户设置的国码是否一致
   - 国码不一致时拦截上传并提示错误

2. **用户管理**
   - 用户基本信息中可以设置国家和国码
   - 前端界面优先显示国家中文名称
   - 支持按国家筛选用户

3. **代理管理**
   - 代理基本信息中可以设置国家和国码
   - 支持按国家统计代理分布
   - 国际化代理管理

---

## 注意事项

### 1. 字段位置
- `country_code` 在 `overdraft_amount` 之后
- `country_name` 在 `country_code` 之后
- 保持字段顺序有助于代码的可读性

### 2. 默认值
- 两个字段都允许 NULL
- 现有用户/代理的这两个字段值为 NULL
- 新用户可以在创建或编辑时设置

### 3. 兼容性
- 已有功能不受影响
- 如果用户未设置国码，上传数据时不进行国码校验
- 前端显示时如果字段为空，可以显示默认值或隐藏

### 4. 数据迁移
如果需要为现有用户批量设置默认国码：
```sql
-- 示例：为所有用户设置默认国码为中国
UPDATE users SET country_code = '+86', country_name = '中国' WHERE country_code IS NULL;
UPDATE agents SET country_code = '+86', country_name = '中国' WHERE country_code IS NULL;
```

---

## 故障排查

### 问题1：执行 ALTER TABLE 失败
**可能原因**：
- 数据库连接失败
- 权限不足
- 表被锁定

**解决方案**：
```bash
# 检查数据库连接
mysql -u root -e "SELECT 1;"

# 检查表是否存在
mysql -u root -e "USE vue_admin; SHOW TABLES;"

# 检查是否有锁
mysql -u root -e "SHOW OPEN TABLES WHERE In_use > 0;"
```

---

### 问题2：字段添加成功但登录仍报错
**可能原因**：
- 后端服务未重启
- 缓存问题

**解决方案**：
```bash
# 确保停止所有旧进程
killall -9 node

# 重启服务
cd /home/vue-element-admin/backend
node server.js

# 清除浏览器缓存
Ctrl + Shift + Delete
```

---

### 问题3：前端无法读取国码字段
**可能原因**：
- API 返回数据中没有这两个字段
- 前端代码未更新

**解决方案**：
```bash
# 检查 API 返回数据
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' | jq

# 查看返回数据是否包含 country_code 和 country_name
```

---

## 执行状态

✅ **已完成**
- users 表添加 country_code 字段
- users 表添加 country_name 字段
- agents 表添加 country_code 字段
- agents 表添加 country_name 字段
- 后端服务器重启成功
- 字段验证通过

**执行时间**：2025-10-15 11:42:38

---

## 相关文档

- [数据上传功能增强说明.md](./数据上传功能增强说明.md)
- [User 模型定义](/backend/models/User.js)
- [Agent 模型定义](/backend/models/Agent.js)
- [数据处理路由](/backend/routes/dataProcessing.js)

---

**维护人员**：系统管理员  
**更新时间**：2025-10-15  
**状态**：✅ 已完成
