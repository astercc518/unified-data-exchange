# 定价管理数据同步测试指南

## 测试环境

**系统信息：**
- 前端地址：http://localhost:9528
- 后端地址：http://localhost:3000
- 数据库：MariaDB 5.5.68
- 浏览器：Chrome/Firefox（推荐开启开发者工具）

**修复文件：**
- `/home/vue-element-admin/src/views/data/library.vue`
- `/home/vue-element-admin/src/views/data/pricing.vue`

**修复内容：**
- 数据列表添加刷新通知机制
- 定价管理修复 API 响应处理
- 添加自动同步监听器
- 页面激活时强制刷新

---

## 测试准备

### 1. 确认服务运行状态

```bash
# 检查前端服务
curl -s http://localhost:9528 | head -5

# 检查后端服务
ps aux | grep "node server.js" | grep -v grep

# 检查数据库
mysql -u vue_admin_user -pvue_admin_2024 vue_admin -e "SELECT COUNT(*) as total FROM data_library WHERE publish_status='published';"
```

### 2. 打开浏览器开发者工具

**操作步骤：**
1. 访问 http://localhost:9528
2. 按 F12 打开开发者工具
3. 切换到 Console 标签页（查看日志）
4. 切换到 Application 标签页 → Local Storage（查看缓存）

### 3. 准备测试数据

```bash
# 查看已发布数据
mysql -u vue_admin_user -pvue_admin_2024 vue_admin -e "
  SELECT 
    id,
    country,
    country_name,
    data_type,
    validity,
    cost_price,
    sell_price,
    publish_status
  FROM data_library 
  WHERE publish_status = 'published'
  ORDER BY id DESC 
  LIMIT 5;
"
```

**确认：**
- ✅ 至少有几条已发布数据
- ✅ 数据有明确的价格信息

---

## 测试用例

### 测试用例1：单页面定价同步（核心场景）

**测试目的：** 验证在数据列表修改定价后，切换到定价管理页面能自动显示最新价格

#### 步骤1：打开数据列表

1. 访问 http://localhost:9528
2. 登录系统
3. 进入：数据管理 → 数据列表
4. 找到一条已发布的数据（发布状态为"已发布"）

**记录原价格：**
- 数据ID：_____________
- 国家：_____________
- 时效性：_____________
- 原成本价：_____________
- 原销售价：_____________

#### 步骤2：修改定价

1. 点击该数据的"定价"按钮
2. 定价对话框打开
3. 修改价格：
   - 新成本价：_____________ (建议改为 0.05)
   - 新销售价：_____________ (建议改为 0.06)
4. 点击"保存定价"按钮

**观察控制台：**
```javascript
// 应该看到以下日志
💰 开始保存定价: {id: xxx, country: 'xxx', ...}
📡 调用数据库API更新定价，ID: xxx
✅ 数据库定价更新成功
✅ 已更新 dataListData 定价
✅ 已更新 dataList 定价
🔔 已通知定价管理页面刷新  // ← 关键日志
✅ 定价保存完成
```

**预期结果：**
- ✅ 提示"定价更新成功（已同步数据库）"
- ✅ 对话框自动关闭
- ✅ 列表刷新，显示新价格

#### 步骤3：切换到定价管理

1. 点击左侧菜单：数据管理 → 定价管理
2. 观察控制台日志
3. 查看定价管理页面

**观察控制台：**
```javascript
// 应该看到以下日志
🔄 定价管理页面被激活，重新加载数据...
🗑️ 清除定价缓存...
💰 开始加载定价管理数据...
📡 API响应: {success: true, dataLength: X, total: X}
✅ 从数据库API获取数据: X 条
💾 更新 localStorage 缓存...
✅ localStorage 缓存已更新: X 条
📊 生成定价项: X 个
```

**预期结果：**
- ✅ 定价管理页面自动显示最新价格
- ✅ 对应国家和时效性的成本价为 0.05
- ✅ 对应国家和时效性的销售价为 0.06
- ✅ 利润率自动计算正确

#### 步骤4：验证数据库

```bash
mysql -u vue_admin_user -pvue_admin_2024 vue_admin -e "
  SELECT 
    id,
    country_name,
    validity,
    cost_price,
    sell_price,
    update_time
  FROM data_library 
  WHERE id = <测试数据ID>;
"
```

**预期结果：**
```
+-----+--------------+----------+------------+------------+---------------+
| id  | country_name | validity | cost_price | sell_price | update_time   |
+-----+--------------+----------+------------+------------+---------------+
| xxx | 巴西         | 30       |     0.0500 |     0.0600 | 1729248xxx... |
+-----+--------------+----------+------------+------------+---------------+
```

**测试结论：**
- [ ] ✅ 定价保存成功
- [ ] ✅ 数据库已更新
- [ ] ✅ 切换页面自动显示新价格
- [ ] ✅ 控制台日志正确

---

### 测试用例2：多标签页实时同步

**测试目的：** 验证在一个标签页修改定价后，另一个已打开的定价管理页面能自动同步

#### 步骤1：打开两个标签页

1. 标签页1：打开定价管理页面
   ```
   http://localhost:9528/#/data/pricing
   ```

2. 标签页2：打开数据列表页面
   ```
   http://localhost:9528/#/data/library
   ```

**初始状态：**
- 标签页1显示定价列表
- 标签页2显示数据列表

#### 步骤2：在标签页2修改定价

1. 切换到标签页2（数据列表）
2. 找到一条已发布数据
3. 点击"定价"按钮
4. 修改价格（例如成本价改为 0.07，销售价改为 0.08）
5. 点击"保存定价"

**观察标签页2控制台：**
```javascript
💰 开始保存定价: {...}
✅ 数据库定价更新成功
🔔 已通知定价管理页面刷新  // ← 关键
```

#### 步骤3：观察标签页1

**等待时间：** 最多5秒

**观察标签页1控制台：**
```javascript
// 5秒内应该自动输出
🔔 检测到定价更新通知，自动刷新...
💰 开始加载定价管理数据...
✅ 从数据库API获取数据: X 条
💾 更新 localStorage 缓存...
```

**预期结果：**
- ✅ 标签页1在5秒内自动刷新
- ✅ 定价列表显示新价格
- ✅ 无需手动刷新页面

#### 步骤4：验证 localStorage

**在任一标签页控制台执行：**
```javascript
// 检查刷新标记
localStorage.getItem('pricingNeedsRefresh')
// 预期：修改定价后为 'true'，自动刷新后为 null

// 检查数据缓存
const dataList = JSON.parse(localStorage.getItem('dataList'))
const testData = dataList.find(item => item.id === <测试数据ID>)
console.log('缓存中的价格:', {
  成本价: testData.costPrice,
  销售价: testData.sellPrice
})
// 预期：显示最新价格
```

**测试结论：**
- [ ] ✅ 多标签页实时同步
- [ ] ✅ 5秒内自动刷新
- [ ] ✅ localStorage 正确更新
- [ ] ✅ 刷新标记正确清除

---

### 测试用例3：API 响应格式兼容性

**测试目的：** 验证定价管理页面能正确处理不同的 API 响应格式

#### 步骤1：刷新定价管理页面

1. 进入：数据管理 → 定价管理
2. 点击"刷新定价"按钮
3. 观察控制台日志

**观察控制台：**
```javascript
🔄 刷新定价数据...
💰 开始加载定价管理数据...
📡 API响应: {
  success: true,
  dataLength: X,
  total: X
}
✅ 从数据库API获取数据: X 条
```

**预期结果：**
- ✅ API 响应格式被正确识别
- ✅ 数据成功加载
- ✅ 定价列表正常显示

#### 步骤2：测试 API 失败降级

**模拟方法：**
```javascript
// 在控制台临时拦截 API
const originalFetch = window.fetch
window.fetch = function(...args) {
  if (args[0].includes('/api/data-library/published')) {
    return Promise.reject(new Error('模拟API失败'))
  }
  return originalFetch.apply(this, args)
}

// 然后刷新页面
```

**观察控制台：**
```javascript
❌ 数据库API调用失败: 模拟API失败
🔄 降级到localStorage模式...
📱 从localStorage加载定价数据...
📄 从 localStorage 加载数据: X 条
```

**预期结果：**
- ✅ API 失败时不报错
- ✅ 自动降级到 localStorage
- ✅ 数据仍能正常显示

**恢复：**
```javascript
// 恢复 fetch
window.fetch = originalFetch
location.reload()
```

**测试结论：**
- [ ] ✅ API 响应格式兼容
- [ ] ✅ 失败降级正常
- [ ] ✅ 错误处理完善

---

### 测试用例4：缓存更新验证

**测试目的：** 验证 localStorage 缓存与数据库保持同步

#### 步骤1：检查初始缓存

**在浏览器控制台执行：**
```javascript
// 查看缓存数据
const dataList = JSON.parse(localStorage.getItem('dataList'))
console.table(dataList.map(item => ({
  ID: item.id,
  国家: item.country,
  时效: item.validityDisplay,
  成本价: item.costPrice,
  销售价: item.sellPrice
})))
```

**记录：** 某条数据的价格 _____________

#### 步骤2：修改定价

1. 进入数据列表
2. 修改该数据的定价
3. 保存成功

#### 步骤3：检查缓存更新

**在浏览器控制台执行：**
```javascript
// 再次查看缓存
const dataList = JSON.parse(localStorage.getItem('dataList'))
const updated = dataList.find(item => item.id === <测试数据ID>)
console.log('缓存已更新:', {
  ID: updated.id,
  国家: updated.country,
  成本价: updated.costPrice,
  销售价: updated.sellPrice
})
```

**预期结果：**
- ✅ 缓存中的价格已更新
- ✅ 与修改的价格一致

#### 步骤4：对比数据库

```bash
mysql -u vue_admin_user -pvue_admin_2024 vue_admin -e "
  SELECT id, cost_price, sell_price 
  FROM data_library 
  WHERE id = <测试数据ID>;
"
```

**预期结果：**
- ✅ 缓存价格 = 数据库价格
- ✅ 数据完全同步

**测试结论：**
- [ ] ✅ 缓存更新及时
- [ ] ✅ 数据库与缓存同步
- [ ] ✅ 数据一致性保证

---

### 测试用例5：监听器生命周期

**测试目的：** 验证定时器正确启动和清理

#### 步骤1：进入定价管理页面

1. 访问：数据管理 → 定价管理
2. 观察控制台

**观察控制台：**
```javascript
⏰ 动态定价定时器已启动
⏰ 定价同步监听器已启动
```

**预期结果：**
- ✅ 两个定时器都已启动

#### 步骤2：切换到其他页面

1. 点击：数据管理 → 数据列表
2. 观察控制台

**观察控制台：**
```javascript
// 定价管理页面被 deactivated
⏰ 动态定价定时器已清理
⏰ 定价同步监听器已清理
```

**预期结果：**
- ✅ 定时器被正确清理
- ✅ 不会继续运行

#### 步骤3：再次返回定价管理

1. 点击：数据管理 → 定价管理
2. 观察控制台

**观察控制台：**
```javascript
// 定价管理页面被 activated
🔄 定价管理页面被激活，重新加载数据...
⏰ 定价同步监听器已启动  // ← 重新启动
```

**预期结果：**
- ✅ 定时器重新启动
- ✅ 数据自动刷新

**测试结论：**
- [ ] ✅ 定时器正确启动
- [ ] ✅ 定时器正确清理
- [ ] ✅ 无内存泄漏

---

## 性能测试

### 测试场景：同步延迟测试

**测试步骤：**

1. **准备计时器**
   ```javascript
   // 在控制台准备
   let startTime
   ```

2. **修改定价**
   ```javascript
   // 在数据列表点击保存前执行
   startTime = Date.now()
   // 然后点击保存定价
   ```

3. **切换页面**
   - 立即切换到定价管理页面

4. **记录时间**
   ```javascript
   // 在定价管理页面数据加载完成后
   const syncTime = Date.now() - startTime
   console.log('同步耗时:', syncTime, 'ms')
   ```

**性能基准：**
- 页面切换同步：< 1000ms（推荐）
- 多标签页同步：< 5000ms（可接受）

**测试记录：**
- 测试1：_______ ms
- 测试2：_______ ms
- 测试3：_______ ms
- 平均：_______ ms

**测试结论：**
- [ ] ✅ 同步延迟可接受
- [ ] ✅ 用户体验良好

---

## 回归测试

### 确保修复不影响其他功能

#### 1. 数据列表其他功能

- [ ] ✅ 数据新增正常
- [ ] ✅ 数据编辑正常
- [ ] ✅ 数据删除正常
- [ ] ✅ 数据发布正常
- [ ] ✅ 数据详情正常

#### 2. 定价管理其他功能

- [ ] ✅ 定价历史记录显示正常
- [ ] ✅ 自定义定价功能正常
- [ ] ✅ 推荐定价功能正常
- [ ] ✅ 筛选功能正常
- [ ] ✅ 数据统计正常

#### 3. 资源中心功能

- [ ] ✅ 资源列表显示正常
- [ ] ✅ 价格显示与定价管理一致
- [ ] ✅ 购买功能正常

---

## 问题排查

### 常见问题

#### Q1：定价管理页面不自动刷新

**可能原因：**
- 监听器未启动
- 刷新标记未设置
- 页面缓存问题

**排查方法：**
```javascript
// 1. 检查监听器
console.log('监听器状态:', this.pricingSyncTimer)

// 2. 检查刷新标记
console.log('刷新标记:', localStorage.getItem('pricingNeedsRefresh'))

// 3. 手动触发刷新
this.getPricingList()
```

#### Q2：价格显示不一致

**可能原因：**
- 缓存未更新
- 数据库更新失败
- 页面筛选条件不同

**排查方法：**
```bash
# 1. 检查数据库
mysql -u vue_admin_user -pvue_admin_2024 vue_admin -e "
  SELECT id, country, cost_price, sell_price 
  FROM data_library 
  WHERE id = <数据ID>;
"

# 2. 检查缓存
# 在浏览器控制台
const dataList = JSON.parse(localStorage.getItem('dataList'))
const data = dataList.find(item => item.id === <数据ID>)
console.log('缓存价格:', data.costPrice, data.sellPrice)

# 3. 清除缓存重新加载
localStorage.removeItem('dataList')
location.reload()
```

#### Q3：控制台无日志输出

**可能原因：**
- 代码未生效
- 前端服务未重启
- 浏览器缓存

**解决方法：**
```bash
# 1. 检查前端服务
ps aux | grep vue-cli-service

# 2. 强制刷新浏览器
# 按 Ctrl+Shift+R（Windows/Linux）
# 按 Cmd+Shift+R（Mac）

# 3. 清除浏览器缓存
# F12 → Application → Clear storage → Clear site data
```

---

## 测试报告模板

### 测试执行记录

**测试人员：** ______________  
**测试时间：** ______________  
**测试环境：** 生产环境 / 开发环境

### 测试结果汇总

| 测试用例 | 测试结果 | 耗时 | 备注 |
|---------|---------|------|------|
| 单页面定价同步 | ✅ / ❌ | ___ ms | |
| 多标签页实时同步 | ✅ / ❌ | ___ ms | |
| API 响应格式兼容 | ✅ / ❌ | - | |
| 缓存更新验证 | ✅ / ❌ | - | |
| 监听器生命周期 | ✅ / ❌ | - | |

### 性能测试结果

| 测试项 | 平均耗时 | 性能基准 | 结果 |
|--------|---------|---------|------|
| 页面切换同步 | ___ ms | < 1000ms | ✅ / ❌ |
| 多标签页同步 | ___ ms | < 5000ms | ✅ / ❌ |

### 发现的问题

| 问题编号 | 问题描述 | 严重程度 | 状态 |
|---------|---------|---------|------|
| 1 | | 高/中/低 | 待修复/已修复 |
| 2 | | 高/中/低 | 待修复/已修复 |

### 总体评价

- **功能完整性：** 完整 / 基本完整 / 不完整
- **同步准确性：** 准确 / 基本准确 / 不准确
- **性能：** 优秀 / 良好 / 需优化
- **建议上线：** 是 / 否

### 备注

_______________________________________________________
_______________________________________________________
_______________________________________________________

---

**文档版本：** 1.0  
**创建时间：** 2025-10-18  
**最后更新：** 2025-10-18
