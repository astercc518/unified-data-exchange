# 系统管理模块增强功能说明

## 概述

本次更新为系统管理模块添加了三个核心功能，并隐藏了部分不需要的菜单项。

## 一、新增功能

### 1. 操作日志查询 (`/system/logs`)

**功能描述：**
- 查询账号登录信息和操作信息
- 支持按日志类型、操作人、时间范围筛选
- 支持清空历史日志

**前端文件：**
- `/src/views/system/logs.vue` (225行)

**后端文件：**
- `/backend/routes/system/logs.js` (161行)
- `/backend/models/OperationLog.js` (73行)

**主要功能：**
```javascript
// 获取操作日志列表（支持分页）
GET /api/system/logs?page=1&limit=20&type=login&operator=admin

// 记录操作日志
POST /api/system/logs
{
  type: 'login' | 'operation',
  operator: '操作人账号',
  action: '操作动作',
  description: '操作描述',
  ipAddress: 'IP地址',
  status: 'success' | 'failed'
}

// 清空历史日志
DELETE /api/system/logs
```

**数据模型：**
```javascript
{
  id: INTEGER,
  type: STRING(20),          // login-登录，operation-操作
  operator: STRING(100),     // 操作人账号
  operator_type: STRING(20), // admin-管理员，agent-代理，customer-客户
  action: STRING(100),       // 操作动作
  description: TEXT,         // 操作描述
  ip_address: STRING(50),    // IP地址
  user_agent: TEXT,          // 用户代理
  status: STRING(20),        // success-成功，failed-失败
  create_time: BIGINT        // 创建时间戳
}
```

**页面特性：**
- 日志类型标签显示（登录/操作）
- 状态标签显示（成功/失败）
- 日期范围选择器
- 分页显示
- 清空历史功能（需二次确认）

---

### 2. 修改密码 (`/system/password`)

**功能描述：**
- 修改管理员密码
- 验证原密码
- 实时显示密码强度
- 修改成功后自动退出登录

**前端文件：**
- `/src/views/system/password.vue` (215行)

**后端文件：**
- `/backend/routes/system/security.js` (151行，共享安全管理API)

**主要功能：**
```javascript
// 修改管理员密码
POST /api/system/security/change-password
{
  adminId: 1,
  oldPassword: '旧密码',
  newPassword: '新密码'
}
```

**密码强度计算：**
- 基础分数（长度）：6字符+1分，8字符+1分，10字符+1分
- 大小写混合：+1分
- 包含数字：+1分
- 包含特殊字符：+1分
- **评级标准：**
  - 0-2分：弱
  - 3-4分：中
  - 5-6分：强

**页面特性：**
- 原密码验证
- 新密码强度实时显示（进度条+文字）
- 密码确认验证
- 修改成功后1秒延迟退出登录

---

### 3. 安全管理 (`/system/security`)

**功能描述：**
- 调整登录密码安全等级（低/中/高）
- 设置登录IP限制（默认不限制）
- 管理IP白名单

**前端文件：**
- `/src/views/system/security.vue` (230行)

**后端文件：**
- `/backend/routes/system/security.js` (151行)
- `/backend/models/SystemConfig.js` (49行)

**主要功能：**
```javascript
// 获取安全配置
GET /api/system/security/config

// 更新安全配置
PUT /api/system/security/config
{
  passwordLevel: 'low' | 'medium' | 'high',
  ipRestriction: true | false,
  allowedIps: ['192.168.1.1', '10.0.0.1']
}
```

**密码安全等级：**
- **低 (low)**：至少6个字符
- **中 (medium)**：至少8个字符，包含字母和数字
- **高 (high)**：至少10个字符，包含大小写字母、数字和特殊字符

**IP限制功能：**
- 开关控制（默认关闭）
- IPv4地址格式验证
- IP白名单添加/删除
- 显示当前IP列表

**页面特性：**
- 密码等级选择（单选框）
- IP限制开关
- IP输入框（带格式验证）
- IP白名单列表（可删除）
- 保存按钮（一键保存所有配置）

---

## 二、隐藏的菜单项

### 1. 权限管理 (Permission)

**位置：** `/src/router/index.js` 第523行

**修改内容：** 添加 `hidden: true` 属性

```javascript
{
  path: 'permission',
  component: () => import('@/views/permission/page'),
  name: 'SystemPermission',
  redirect: '/system/permission/page',
  hidden: true,  // 隐藏菜单项
  meta: {
    title: 'navbar.permission',
    icon: 'lock'
  },
  // ... children
}
```

**说明：** 权限管理功能仍然可以通过直接URL访问，只是在侧边栏菜单中不显示。

---

### 2. Nested Routes

**位置：** `/src/router/index.js` 第681行

**修改内容：** 添加 `hidden: true` 属性

```javascript
{
  path: 'nested',
  name: 'SystemNested',
  redirect: '/system/nested/menu1',
  hidden: true,  // 隐藏菜单项
  meta: { title: 'Nested Routes', icon: 'nested' },
  // ... children
}
```

**说明：** Nested Routes示例组件已从侧边栏菜单中隐藏。

---

## 三、文件结构

### 前端文件

```
/src/views/system/
├── logs.vue          # 操作日志查询页面
├── password.vue      # 修改密码页面
└── security.vue      # 安全管理页面
```

### 后端文件

```
/backend/
├── routes/system/
│   ├── logs.js       # 操作日志API路由
│   └── security.js   # 安全管理API路由
├── models/
│   ├── OperationLog.js    # 操作日志数据模型
│   └── SystemConfig.js    # 系统配置数据模型
└── server.js         # 服务器入口（已更新路由注册）
```

---

## 四、路由配置

### 系统管理菜单结构

```javascript
/system (系统管理)
├── /system/logs       # 操作日志 ✅ 新增
├── /system/password   # 修改密码 ✅ 新增
├── /system/security   # 安全管理 ✅ 新增
├── /system/permission # 权限管理 🚫 已隐藏
├── /system/icons      # 图标
├── /system/components # 组件示例
├── /system/charts     # 图表示例
└── /system/nested     # Nested Routes 🚫 已隐藏
```

---

## 五、API接口汇总

### 操作日志接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/system/logs` | 获取操作日志列表（支持分页和筛选） |
| POST | `/api/system/logs` | 记录操作日志 |
| DELETE | `/api/system/logs` | 清空历史日志 |

### 安全管理接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | `/api/system/security/change-password` | 修改管理员密码 |
| GET | `/api/system/security/config` | 获取安全配置 |
| PUT | `/api/system/security/config` | 更新安全配置 |

---

## 六、权限控制

所有新增功能均设置为 `roles: ['admin']`，仅管理员可访问。

---

## 七、数据库表结构

### operation_logs 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| type | STRING(20) | 日志类型（login/operation） |
| operator | STRING(100) | 操作人账号 |
| operator_type | STRING(20) | 操作人类型 |
| action | STRING(100) | 操作动作 |
| description | TEXT | 操作描述 |
| ip_address | STRING(50) | IP地址 |
| user_agent | TEXT | 用户代理 |
| status | STRING(20) | 状态（success/failed） |
| create_time | BIGINT | 创建时间戳 |

### system_configs 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| config_key | STRING(100) | 配置键（唯一） |
| config_value | TEXT | 配置值（JSON格式） |
| description | STRING(255) | 配置描述 |
| create_time | BIGINT | 创建时间戳 |
| update_time | BIGINT | 更新时间戳 |

---

## 八、使用说明

### 1. 启动后端服务器

```bash
cd /home/vue-element-admin/backend
node server.js
```

### 2. 启动前端开发服务器

```bash
cd /home/vue-element-admin
npm run dev
```

### 3. 访问新功能

- 操作日志：登录后访问 `系统管理 > 操作日志`
- 修改密码：登录后访问 `系统管理 > 修改密码`
- 安全管理：登录后访问 `系统管理 > 安全管理`

---

## 九、注意事项

1. **操作日志**：
   - 清空日志操作不可恢复，请谨慎操作
   - 日志记录需要在相关操作中手动调用API

2. **修改密码**：
   - 修改密码后会自动退出登录，需重新登录
   - 密码强度仅为前端提示，后端应根据安全等级强制验证

3. **安全管理**：
   - IP限制功能需要在后端中间件中实现验证逻辑
   - 密码安全等级设置后，需要在用户注册/修改密码时验证

4. **菜单隐藏**：
   - 隐藏的菜单项仍可通过直接URL访问
   - 如需完全禁用，需要在后端或权限控制中处理

---

## 十、未来改进建议

1. **操作日志**：
   - 添加自动记录中间件，在关键操作时自动记录日志
   - 增加日志导出功能（CSV/Excel）
   - 添加日志统计分析

2. **密码安全**：
   - 后端实现密码强度验证
   - 添加密码历史记录，防止使用旧密码
   - 实现密码过期策略

3. **IP限制**：
   - 实现IP白名单验证中间件
   - 支持IP段配置（CIDR格式）
   - 添加IP黑名单功能

4. **安全增强**：
   - 添加双因素认证（2FA）
   - 实现登录失败锁定机制
   - 添加会话管理（强制踢出用户）

---

## 完成状态

✅ 操作日志查询功能 - 已完成  
✅ 修改密码功能 - 已完成  
✅ 安全管理功能 - 已完成  
✅ 隐藏权限管理菜单 - 已完成  
✅ 隐藏Nested Routes菜单 - 已完成  
✅ 后端API开发 - 已完成  
✅ 前端页面开发 - 已完成  
✅ 路由配置 - 已完成  
✅ 数据模型创建 - 已完成  

**开发完成时间：** 2025-10-15
