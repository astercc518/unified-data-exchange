# 🛡️ 代理角色权限定义文档

## 📋 角色定位

**代理(Agent)** 在系统中的业务定位为**销售角色**,负责管理所属客户并提供数据销售服务。

---

## ✅ 代理角色权限清单

### 1. 客户管理权限

#### ✅ 可查看本代理下的客户基本信息
- **功能路径**: 用户管理 → 客户列表
- **路由路径**: `/user/customer-list`
- **权限范围**: 
  - 只能查看 `agent_id` 等于当前代理ID的客户
  - 可查看字段:
    - 客户登录账号 (`login_account`)
    - 客户姓名 (`customer_name`)
    - 电子邮箱 (`email`)
    - 账户余额 (`account_balance`)
    - 售价倍率 (`sale_price_rate`)
    - 账户状态 (`status`)
    - 创建时间 (`create_time`)
  
- **操作权限**:
  - ✅ 查看客户详情
  - ❌ **不能创建**新客户(只有管理员可以创建)
  - ❌ **不能编辑**客户信息
  - ❌ **不能删除**客户
  - ❌ **不能充值**或扣款
  - ❌ **不能重置**客户密码
  - ❌ **不能切换**客户状态

**实现说明**: 需要在后端API添加过滤,确保代理只能获取自己名下的客户数据。

---

### 2. 订单审核权限

#### ✅ 可审核客户提交的购买数据订单
- **功能路径**: 订单管理 → 审核订单
- **路由路径**: `/order/review`
- **路由配置**:
  ```javascript
  meta: {
    title: 'navbar.reviewOrders',
    icon: 'document-checked',
    roles: ['agent', 'admin']  // 仅代理和管理员可访问
  }
  ```

- **权限范围**:
  - 只能审核本代理下客户提交的订单
  - 订单状态必须为 `reviewing`(审核中)
  
- **操作权限**:
  - ✅ **查看**待审核订单列表
  - ✅ **查看**订单详情
  - ✅ **审核通过**订单
    - 订单状态变更: `reviewing` → `completed`
    - 发货状态变更: 无 → `pending`(待发货)
    - 记录审核通过时间: `approve_time`
  - ✅ **审核拒绝**订单
    - 订单状态变更: `reviewing` → `cancelled`
    - **必须填写**拒绝原因: `reject_reason`
    - 记录拒绝时间: `reject_time`
  
- **统计数据**:
  - 待审核订单数
  - 今日已审核数
  - 待审核总金额

**已实现**: ✅ 功能已完整实现,页面文件: `/src/views/order/review.vue`

---

### 3. 订单发货权限

#### ✅ 可发货已审核通过的订单
- **功能路径**: 订单管理 → 已完成订单 → 发货
- **路由路径**: `/order/delivery/:id`
- **路由配置**:
  ```javascript
  meta: {
    title: 'navbar.orderDelivery',
    roles: ['agent', 'admin'],  // 仅代理和管理员可访问
    hidden: true  // 不显示在菜单,通过按钮跳转
  }
  ```

- **权限范围**:
  - 只能发货本代理下客户的订单
  - 订单状态必须为 `completed`
  - 发货状态必须为 `pending`(待发货)
  
- **操作权限**:
  - ✅ **查看**订单基本信息
    - 订单号、客户信息、数据信息
  - ✅ **选择**发货方式
    - 邮箱发货 (Email)
    - TG Bot发货 (Telegram Bot)
  - ✅ **填写**发货信息
    - 发货地址(邮箱或TG Bot ID)
    - 发货备注(可选)
  - ✅ **确认发货**
    - 发货状态变更: `pending` → `delivered`
    - 记录发货时间: `delivery_time`
    - 记录发货方式: `delivery_method`
    - 记录发货地址: `delivery_address`

**已实现**: ✅ 功能已完整实现,页面文件: `/src/views/order/delivery.vue`

---

### 4. 数据反馈编辑权限

#### ✅ 可编辑已购买数据的效果反馈
- **功能路径**: 数据反馈 → 反馈列表
- **路由路径**: `/feedback/list`, `/feedback/create`
- **路由配置**:
  ```javascript
  meta: {
    title: 'navbar.dataFeedback',
    icon: 'message',
    roles: ['admin', 'customer', 'agent']  // 三个角色都可访问
  }
  ```

- **权限范围**:
  - 可查看本代理下所有客户的反馈
  - 可编辑本代理下客户提交的反馈
  
- **操作权限**:
  - ✅ **查看**反馈列表
    - 筛选条件: 数据源、质量评价、反馈时间
  - ✅ **查看**反馈详情
    - 数据效果分析(访问量、注册数、充值数)
    - 转化率统计
    - 质量评价
    - 详细反馈内容
  - ✅ **编辑**反馈内容
    - 修改数据效果数据
    - 更新质量评价
    - 补充改进建议
  - ❌ **不能删除**反馈记录

**已实现**: ✅ 功能已完整实现
- 反馈列表: `/src/views/feedback/list.vue`
- 创建/编辑反馈: `/src/views/feedback/create.vue`
- 反馈详情: `/src/views/feedback/detail.vue`

---

### 5. 订单查看权限

#### ✅ 可查看本代理下所有订单
- **功能路径**: 订单管理 → 订单列表/已完成订单
- **路由路径**: `/order/list`, `/order/completed`
- **权限范围**:
  - 只能查看本代理下客户的订单
  - 可查看所有状态的订单

- **操作权限**:
  - ✅ **查看**订单列表
  - ✅ **查看**订单详情
  - ✅ **下载**已发货数据
  - ❌ **不能取消**订单
  - ❌ **不能修改**订单金额

---

### 6. 资源中心访问权限

#### ✅ 可查看可用数据资源
- **功能路径**: 资源中心
- **路由路径**: `/resource/center`
- **路由配置**:
  ```javascript
  meta: {
    title: 'navbar.resourceCenter',
    icon: 'shopping',
    roles: ['customer', 'agent']  // 客户和代理可访问
  }
  ```

- **操作权限**:
  - ✅ **查看**可用数据列表
  - ✅ **查看**数据详情(国家、类型、数量、价格等)
  - ❌ **不能购买**数据(仅客户可以购买)
  - ❌ **不能删除**数据

**说明**: 代理可以查看资源中心,了解可售数据情况,但不能直接购买。

---

### 7. 首页数据统计权限

#### ✅ 可查看代理业务统计数据
- **功能路径**: 首页(Dashboard)
- **路由路径**: `/dashboard`
- **显示内容**:
  - 绑定客户数
  - 本月订单数
  - 客户收藏Top5(按利润率排序)
  - ❌ **不显示**服务状态

**已实现**: ✅ 代理首页已优化,文件: `/src/views/dashboard/agent.vue`

---

## ❌ 代理角色禁止的权限

### 1. 系统管理权限
代理**完全没有**系统管理权限,以下功能均**禁止访问**:

- ❌ **用户管理**
  - 不能创建客户
  - 不能编辑客户信息
  - 不能删除客户
  - 不能充值或扣款
  - 不能重置客户密码
  - 不能切换客户状态

- ❌ **代理管理**
  - 不能查看其他代理信息
  - 不能创建、编辑、删除代理

- ❌ **数据管理**
  - 不能上传数据
  - 不能编辑数据库数据
  - 不能设置数据定价
  - 不能删除数据

- ❌ **结算管理**
  - 不能查看客户结算记录
  - 不能查看代理结算记录
  - 不能执行结算操作

- ❌ **充值记录**
  - 不能查看充值记录

- ❌ **系统设置**
  - 不能修改系统配置
  - 不能管理权限
  - 不能访问系统管理菜单

---

## 📊 权限对比表

| 功能模块 | 管理员 | 代理 | 客户 | 说明 |
|---------|--------|------|------|------|
| **客户管理** |
| 查看所有客户 | ✅ | ❌ | ❌ | 代理只能查看自己的客户 |
| 查看本代理客户 | ✅ | ✅ | ❌ | 只读,不能编辑 |
| 创建客户 | ✅ | ❌ | ❌ | |
| 编辑客户 | ✅ | ❌ | ❌ | |
| 删除客户 | ✅ | ❌ | ❌ | |
| 充值/扣款 | ✅ | ❌ | ❌ | |
| 重置密码 | ✅ | ❌ | ❌ | |
| **订单管理** |
| 查看所有订单 | ✅ | ❌ | ❌ | 代理只能查看自己客户的订单 |
| 查看本代理订单 | ✅ | ✅ | ❌ | |
| 查看自己订单 | ✅ | ✅ | ✅ | |
| 提交审核 | ❌ | ❌ | ✅ | 客户专属 |
| 审核订单 | ✅ | ✅ | ❌ | 代理核心权限 |
| 发货订单 | ✅ | ✅ | ❌ | 代理核心权限 |
| 取消订单 | ✅ | ❌ | ✅ | 客户可取消待处理订单 |
| **数据反馈** |
| 查看所有反馈 | ✅ | ❌ | ❌ | 代理只能查看自己客户的反馈 |
| 查看本代理反馈 | ✅ | ✅ | ❌ | |
| 查看自己反馈 | ✅ | ✅ | ✅ | |
| 创建反馈 | ✅ | ❌ | ✅ | 客户创建反馈 |
| 编辑反馈 | ✅ | ✅ | ✅ | 代理核心权限 |
| 删除反馈 | ✅ | ❌ | ❌ | |
| **资源中心** |
| 查看数据 | ✅ | ✅ | ✅ | |
| 购买数据 | ✅ | ❌ | ✅ | 代理不能购买 |
| 收藏数据 | ❌ | ❌ | ✅ | 客户专属 |
| 删除数据 | ✅ | ❌ | ❌ | |
| **数据管理** |
| 上传数据 | ✅ | ❌ | ❌ | 管理员专属 |
| 编辑数据 | ✅ | ❌ | ❌ | |
| 定价管理 | ✅ | ❌ | ❌ | |
| **代理管理** |
| 查看代理列表 | ✅ | ❌ | ❌ | 管理员专属 |
| 创建代理 | ✅ | ❌ | ❌ | |
| 编辑代理 | ✅ | ❌ | ❌ | |
| **结算管理** |
| 客户结算 | ✅ | ❌ | ❌ | 管理员专属 |
| 代理结算 | ✅ | ❌ | ❌ | |
| **系统管理** |
| 系统设置 | ✅ | ❌ | ❌ | 管理员专属 |
| 权限管理 | ✅ | ❌ | ❌ | |

---

## 🔧 技术实现要点

### 1. 前端路由权限控制
在 `/src/router/index.js` 中通过 `meta.roles` 配置权限:

```javascript
// ✅ 代理可访问
{
  path: 'review',
  meta: {
    roles: ['agent', 'admin']
  }
}

// ❌ 代理不可访问
{
  path: 'customer-list',
  meta: {
    roles: ['admin']  // 只有管理员
  }
}
```

### 2. 后端API数据过滤
**需要实现**: 在后端API中添加代理权限过滤逻辑

```javascript
// 示例: 获取客户列表时,如果是代理角色,只返回该代理下的客户
router.get('/api/users', authenticateToken, async (req, res) => {
  const { userId, userType } = req.user;
  
  let whereCondition = {};
  
  if (userType === 'agent') {
    // 代理只能查看自己的客户
    whereCondition.agent_id = userId;
  }
  // admin可以查看所有客户,不添加过滤条件
  
  const users = await User.findAll({ where: whereCondition });
  res.json({ success: true, data: users });
});
```

### 3. 前端界面按钮权限控制
使用 `v-if` 指令根据角色显示/隐藏按钮:

```vue
<!-- 编辑按钮 - 仅管理员可见 -->
<el-button
  v-if="userType === 'admin'"
  type="primary"
  @click="handleEdit(row)"
>
  编辑
</el-button>

<!-- 发货按钮 - 代理和管理员可见 -->
<el-button
  v-if="userType === 'agent' || userType === 'admin'"
  type="success"
  @click="handleDelivery(row)"
>
  发货
</el-button>
```

### 4. Vuex状态管理
在 `/src/store/modules/user.js` 中存储用户角色信息:

```javascript
state: {
  id: '',
  type: '',  // 'admin', 'agent', 'customer'
  roles: [],
  name: ''
}
```

---

## 📝 待实现功能清单

### 高优先级 (必须实现)

- [ ] **后端API权限过滤**
  - [ ] 客户列表API添加代理过滤 (`/api/users`)
  - [ ] 订单列表API添加代理过滤 (`/api/orders`)
  - [ ] 反馈列表API添加代理过滤 (`/api/feedbacks`)
  - [ ] 审核订单API添加代理权限验证
  - [ ] 发货API添加代理权限验证

- [ ] **前端界面权限优化**
  - [ ] 客户列表页面移除代理的编辑/删除按钮
  - [ ] 客户列表页面移除代理的创建按钮
  - [ ] 客户列表页面移除代理的充值/扣款/重置密码按钮

### 中优先级 (建议实现)

- [ ] **数据统计优化**
  - [ ] 代理首页只显示本代理客户的统计数据
  - [ ] 订单统计只计算本代理客户的订单

- [ ] **操作日志**
  - [ ] 记录代理的审核操作
  - [ ] 记录代理的发货操作
  - [ ] 记录代理的反馈编辑操作

### 低优先级 (可选实现)

- [ ] **权限审计**
  - [ ] 定期检查代理访问记录
  - [ ] 异常权限访问告警

---

## 🎯 总结

**代理角色定位**: 销售角色,负责管理所属客户的订单和数据反馈

**核心权限 (3个)**:
1. ✅ 查看本代理下客户基本信息(只读)
2. ✅ 审核客户提交的购买数据订单
3. ✅ 编辑已购买数据的效果反馈

**禁止权限**:
- ❌ 无系统管理员权限
- ❌ 不能创建/编辑/删除客户
- ❌ 不能充值/扣款
- ❌ 不能上传/编辑/删除数据
- ❌ 不能查看其他代理的数据

**实现状态**:
- ✅ 前端路由权限配置: 已完成
- ✅ 订单审核功能: 已完成
- ✅ 订单发货功能: 已完成
- ✅ 数据反馈编辑: 已完成
- ⚠️ 后端API数据过滤: **待实现**
- ⚠️ 前端界面按钮权限: **待优化**

---

**文档版本**: v1.0  
**创建日期**: 2025-10-15  
**最后更新**: 2025-10-15  
**作者**: AI Assistant (Qoder)
