# 通道速率控制功能 - 数据库迁移指南

## ✅ 功能说明

为短信通道添加了完整的速率控制功能，支持以下维度的限流：

- **每秒限制**：控制每秒最大请求数（QPS）
- **每分钟限制**：控制每分钟最大请求数
- **每小时限制**：控制每小时最大请求数  
- **最大并发数**：控制同时进行的请求数

## 📦 已完成的工作

### 1. 前端界面 ✅

已在通道配置页面添加速率控制配置区域，位于"每日限额"配置下方：

- 速率控制总开关（启用/关闭）
- 4个速率控制参数输入框
- 详细的使用说明和提示信息

文件：`/home/vue-element-admin/src/views/sms/admin/channels.vue`

### 2. 数据模型 ✅

已在 SmsChannel 模型中添加5个新字段：

```javascript
rate_limit_enabled: {
  type: DataTypes.BOOLEAN,
  defaultValue: false,
  comment: '是否启用速率控制'
},
rate_limit_per_second: {
  type: DataTypes.INTEGER,
  comment: '每秒最大请求数'
},
rate_limit_per_minute: {
  type: DataTypes.INTEGER,
  comment: '每分钟最大请求数'
},
rate_limit_per_hour: {
  type: DataTypes.INTEGER,
  comment: '每小时最大请求数'
},
rate_limit_concurrent: {
  type: DataTypes.INTEGER,
  comment: '最大并发请求数'
}
```

文件：`/home/vue-element-admin/backend/models/SmsChannel.js`

### 3. 表单数据绑定 ✅

已在 temp 对象和 resetTemp 方法中添加速率控制字段初始化：

```javascript
temp: {
  // ... 其他字段
  rate_limit_enabled: false,
  rate_limit_per_second: 0,
  rate_limit_per_minute: 0,
  rate_limit_per_hour: 0,
  rate_limit_concurrent: 1,
  // ...
}
```

## 🔧 需要执行的操作

### 第一步：执行数据库迁移（必需）

请按以下步骤执行SQL语句，添加速率控制字段到数据库：

#### 方法一：使用MySQL命令行工具

```bash
# 登录MySQL
mysql -u root -p

# 执行以下SQL
USE sms_system;

ALTER TABLE sms_channels 
  ADD COLUMN rate_limit_enabled TINYINT(1) DEFAULT 0 
    COMMENT '是否启用速率控制' AFTER daily_limit,
  ADD COLUMN rate_limit_per_second INT DEFAULT NULL 
    COMMENT '每秒最大请求数' AFTER rate_limit_enabled,
  ADD COLUMN rate_limit_per_minute INT DEFAULT NULL 
    COMMENT '每分钟最大请求数' AFTER rate_limit_per_second,
  ADD COLUMN rate_limit_per_hour INT DEFAULT NULL 
    COMMENT '每小时最大请求数' AFTER rate_limit_per_minute,
  ADD COLUMN rate_limit_concurrent INT DEFAULT NULL 
    COMMENT '最大并发请求数' AFTER rate_limit_per_hour;

# 验证字段是否添加成功
DESCRIBE sms_channels;

# 退出
EXIT;
```

#### 方法二：使用SQL文件

```bash
cd /home/vue-element-admin/scripts
mysql -u root -p sms_system < add-rate-limit-fields.sql
```

### 第二步：验证功能（推荐）

1. **刷新前端页面**
   - 打开浏览器，访问通道管理页面
   - 清除浏览器缓存或硬刷新（Ctrl+F5）

2. **创建新通道测试**
   - 点击"新增"按钮
   - 滚动到"速率控制"区域
   - 应该能看到速率控制开关和配置项

3. **编辑现有通道测试**
   - 选择任意通道，点击"编辑"
   - 开启"速率控制"开关
   - 配置各项参数，例如：
     - 每秒限制：100
     - 每分钟限制：5000
     - 每小时限制：200000
     - 最大并发数：10
   - 保存后查看数据库是否正确保存

4. **数据库验证**
   ```sql
   SELECT 
     id,
     channel_name,
     rate_limit_enabled,
     rate_limit_per_second,
     rate_limit_per_minute,
     rate_limit_per_hour,
     rate_limit_concurrent
   FROM sms_channels;
   ```

## 📊 字段说明

| 字段名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| rate_limit_enabled | TINYINT(1) | 0 | 是否启用速率控制 |
| rate_limit_per_second | INT | NULL | 每秒最大请求数，0或NULL表示不限制 |
| rate_limit_per_minute | INT | NULL | 每分钟最大请求数，0或NULL表示不限制 |
| rate_limit_per_hour | INT | NULL | 每小时最大请求数，0或NULL表示不限制 |
| rate_limit_concurrent | INT | NULL | 最大并发请求数 |

## 🎯 使用场景示例

### 场景1：高频短信通道

适用于验证码、通知类短信，需要控制瞬时流量：

```
启用速率控制：✓ 开启
每秒限制：100    # 每秒最多100条
每分钟限制：5000  # 每分钟最多5000条
每小时限制：0     # 不限制
最大并发数：20    # 最多20个并发请求
```

### 场景2：营销短信通道

适用于营销类短信，总量控制更重要：

```
启用速率控制：✓ 开启
每秒限制：50      # 每秒最多50条
每分钟限制：2000  # 每分钟最多2000条
每小时限制：50000 # 每小时最多50000条
最大并发数：10    # 最多10个并发请求
```

### 场景3：测试通道

适用于测试环境，严格控制发送量：

```
启用速率控制：✓ 开启
每秒限制：5       # 每秒最多5条
每分钟限制：100   # 每分钟最多100条
每小时限制：1000  # 每小时最多1000条
最大并发数：2     # 最多2个并发请求
```

## ⚠️ 注意事项

1. **值为0或NULL**：表示该维度不限制
2. **并发数最小值为1**：前端已设置最小值限制
3. **多维度限制同时生效**：如果同时设置了多个限制，所有条件都会被检查
4. **后端实现待完成**：目前只完成了前端界面和数据模型，后端的速率限制逻辑需要使用 Redis 或其他方案实现

## 🔄 下一步工作

### 后端速率限制实现（待开发）

建议使用 Redis + Token Bucket 算法或 Sliding Window 算法实现：

1. **每秒限制**：使用 Redis INCR + EXPIRE 实现
2. **每分钟/小时限制**：使用滑动窗口计数
3. **并发控制**：使用 Redis SETNX 实现分布式锁

详细的后端实现方案请参考：`/home/vue-element-admin/通道速率控制功能说明.md`

## 📝 变更记录

- **2025-10-22**：完成前端界面、数据模型、表单绑定
- **2025-10-22**：创建数据库迁移脚本和使用文档

---

## 快速复制SQL语句

```sql
-- 添加速率控制字段
USE sms_system;

ALTER TABLE sms_channels 
  ADD COLUMN rate_limit_enabled TINYINT(1) DEFAULT 0 COMMENT '是否启用速率控制' AFTER daily_limit,
  ADD COLUMN rate_limit_per_second INT DEFAULT NULL COMMENT '每秒最大请求数' AFTER rate_limit_enabled,
  ADD COLUMN rate_limit_per_minute INT DEFAULT NULL COMMENT '每分钟最大请求数' AFTER rate_limit_per_second,
  ADD COLUMN rate_limit_per_hour INT DEFAULT NULL COMMENT '每小时最大请求数' AFTER rate_limit_per_minute,
  ADD COLUMN rate_limit_concurrent INT DEFAULT NULL COMMENT '最大并发请求数' AFTER rate_limit_per_hour;

-- 验证
SELECT COLUMN_NAME, COLUMN_TYPE, COLUMN_DEFAULT, COLUMN_COMMENT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = 'sms_system'
  AND TABLE_NAME = 'sms_channels'
  AND COLUMN_NAME LIKE 'rate_limit%'
ORDER BY ORDINAL_POSITION;
```
