# é€šé“é€Ÿç‡æ§åˆ¶åŠŸèƒ½ - æ•°æ®åº“è¿ç§»æŒ‡å—

## âœ… åŠŸèƒ½è¯´æ˜

ä¸ºçŸ­ä¿¡é€šé“æ·»åŠ äº†å®Œæ•´çš„é€Ÿç‡æ§åˆ¶åŠŸèƒ½ï¼Œæ”¯æŒä»¥ä¸‹ç»´åº¦çš„é™æµï¼š

- **æ¯ç§’é™åˆ¶**ï¼šæ§åˆ¶æ¯ç§’æœ€å¤§è¯·æ±‚æ•°ï¼ˆQPSï¼‰
- **æ¯åˆ†é’Ÿé™åˆ¶**ï¼šæ§åˆ¶æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°
- **æ¯å°æ—¶é™åˆ¶**ï¼šæ§åˆ¶æ¯å°æ—¶æœ€å¤§è¯·æ±‚æ•°  
- **æœ€å¤§å¹¶å‘æ•°**ï¼šæ§åˆ¶åŒæ—¶è¿›è¡Œçš„è¯·æ±‚æ•°

## ğŸ“¦ å·²å®Œæˆçš„å·¥ä½œ

### 1. å‰ç«¯ç•Œé¢ âœ…

å·²åœ¨é€šé“é…ç½®é¡µé¢æ·»åŠ é€Ÿç‡æ§åˆ¶é…ç½®åŒºåŸŸï¼Œä½äº"æ¯æ—¥é™é¢"é…ç½®ä¸‹æ–¹ï¼š

- é€Ÿç‡æ§åˆ¶æ€»å¼€å…³ï¼ˆå¯ç”¨/å…³é—­ï¼‰
- 4ä¸ªé€Ÿç‡æ§åˆ¶å‚æ•°è¾“å…¥æ¡†
- è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’Œæç¤ºä¿¡æ¯

æ–‡ä»¶ï¼š`/home/vue-element-admin/src/views/sms/admin/channels.vue`

### 2. æ•°æ®æ¨¡å‹ âœ…

å·²åœ¨ SmsChannel æ¨¡å‹ä¸­æ·»åŠ 5ä¸ªæ–°å­—æ®µï¼š

```javascript
rate_limit_enabled: {
  type: DataTypes.BOOLEAN,
  defaultValue: false,
  comment: 'æ˜¯å¦å¯ç”¨é€Ÿç‡æ§åˆ¶'
},
rate_limit_per_second: {
  type: DataTypes.INTEGER,
  comment: 'æ¯ç§’æœ€å¤§è¯·æ±‚æ•°'
},
rate_limit_per_minute: {
  type: DataTypes.INTEGER,
  comment: 'æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°'
},
rate_limit_per_hour: {
  type: DataTypes.INTEGER,
  comment: 'æ¯å°æ—¶æœ€å¤§è¯·æ±‚æ•°'
},
rate_limit_concurrent: {
  type: DataTypes.INTEGER,
  comment: 'æœ€å¤§å¹¶å‘è¯·æ±‚æ•°'
}
```

æ–‡ä»¶ï¼š`/home/vue-element-admin/backend/models/SmsChannel.js`

### 3. è¡¨å•æ•°æ®ç»‘å®š âœ…

å·²åœ¨ temp å¯¹è±¡å’Œ resetTemp æ–¹æ³•ä¸­æ·»åŠ é€Ÿç‡æ§åˆ¶å­—æ®µåˆå§‹åŒ–ï¼š

```javascript
temp: {
  // ... å…¶ä»–å­—æ®µ
  rate_limit_enabled: false,
  rate_limit_per_second: 0,
  rate_limit_per_minute: 0,
  rate_limit_per_hour: 0,
  rate_limit_concurrent: 1,
  // ...
}
```

## ğŸ”§ éœ€è¦æ‰§è¡Œçš„æ“ä½œ

### ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¿…éœ€ï¼‰

è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰§è¡ŒSQLè¯­å¥ï¼Œæ·»åŠ é€Ÿç‡æ§åˆ¶å­—æ®µåˆ°æ•°æ®åº“ï¼š

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨MySQLå‘½ä»¤è¡Œå·¥å…·

```bash
# ç™»å½•MySQL
mysql -u root -p

# æ‰§è¡Œä»¥ä¸‹SQL
USE sms_system;

ALTER TABLE sms_channels 
  ADD COLUMN rate_limit_enabled TINYINT(1) DEFAULT 0 
    COMMENT 'æ˜¯å¦å¯ç”¨é€Ÿç‡æ§åˆ¶' AFTER daily_limit,
  ADD COLUMN rate_limit_per_second INT DEFAULT NULL 
    COMMENT 'æ¯ç§’æœ€å¤§è¯·æ±‚æ•°' AFTER rate_limit_enabled,
  ADD COLUMN rate_limit_per_minute INT DEFAULT NULL 
    COMMENT 'æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°' AFTER rate_limit_per_second,
  ADD COLUMN rate_limit_per_hour INT DEFAULT NULL 
    COMMENT 'æ¯å°æ—¶æœ€å¤§è¯·æ±‚æ•°' AFTER rate_limit_per_minute,
  ADD COLUMN rate_limit_concurrent INT DEFAULT NULL 
    COMMENT 'æœ€å¤§å¹¶å‘è¯·æ±‚æ•°' AFTER rate_limit_per_hour;

# éªŒè¯å­—æ®µæ˜¯å¦æ·»åŠ æˆåŠŸ
DESCRIBE sms_channels;

# é€€å‡º
EXIT;
```

#### æ–¹æ³•äºŒï¼šä½¿ç”¨SQLæ–‡ä»¶

```bash
cd /home/vue-element-admin/scripts
mysql -u root -p sms_system < add-rate-limit-fields.sql
```

### ç¬¬äºŒæ­¥ï¼šéªŒè¯åŠŸèƒ½ï¼ˆæ¨èï¼‰

1. **åˆ·æ–°å‰ç«¯é¡µé¢**
   - æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®é€šé“ç®¡ç†é¡µé¢
   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜æˆ–ç¡¬åˆ·æ–°ï¼ˆCtrl+F5ï¼‰

2. **åˆ›å»ºæ–°é€šé“æµ‹è¯•**
   - ç‚¹å‡»"æ–°å¢"æŒ‰é’®
   - æ»šåŠ¨åˆ°"é€Ÿç‡æ§åˆ¶"åŒºåŸŸ
   - åº”è¯¥èƒ½çœ‹åˆ°é€Ÿç‡æ§åˆ¶å¼€å…³å’Œé…ç½®é¡¹

3. **ç¼–è¾‘ç°æœ‰é€šé“æµ‹è¯•**
   - é€‰æ‹©ä»»æ„é€šé“ï¼Œç‚¹å‡»"ç¼–è¾‘"
   - å¼€å¯"é€Ÿç‡æ§åˆ¶"å¼€å…³
   - é…ç½®å„é¡¹å‚æ•°ï¼Œä¾‹å¦‚ï¼š
     - æ¯ç§’é™åˆ¶ï¼š100
     - æ¯åˆ†é’Ÿé™åˆ¶ï¼š5000
     - æ¯å°æ—¶é™åˆ¶ï¼š200000
     - æœ€å¤§å¹¶å‘æ•°ï¼š10
   - ä¿å­˜åæŸ¥çœ‹æ•°æ®åº“æ˜¯å¦æ­£ç¡®ä¿å­˜

4. **æ•°æ®åº“éªŒè¯**
   ```sql
   SELECT 
     id,
     channel_name,
     rate_limit_enabled,
     rate_limit_per_second,
     rate_limit_per_minute,
     rate_limit_per_hour,
     rate_limit_concurrent
   FROM sms_channels;
   ```

## ğŸ“Š å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| rate_limit_enabled | TINYINT(1) | 0 | æ˜¯å¦å¯ç”¨é€Ÿç‡æ§åˆ¶ |
| rate_limit_per_second | INT | NULL | æ¯ç§’æœ€å¤§è¯·æ±‚æ•°ï¼Œ0æˆ–NULLè¡¨ç¤ºä¸é™åˆ¶ |
| rate_limit_per_minute | INT | NULL | æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°ï¼Œ0æˆ–NULLè¡¨ç¤ºä¸é™åˆ¶ |
| rate_limit_per_hour | INT | NULL | æ¯å°æ—¶æœ€å¤§è¯·æ±‚æ•°ï¼Œ0æˆ–NULLè¡¨ç¤ºä¸é™åˆ¶ |
| rate_limit_concurrent | INT | NULL | æœ€å¤§å¹¶å‘è¯·æ±‚æ•° |

## ğŸ¯ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1ï¼šé«˜é¢‘çŸ­ä¿¡é€šé“

é€‚ç”¨äºéªŒè¯ç ã€é€šçŸ¥ç±»çŸ­ä¿¡ï¼Œéœ€è¦æ§åˆ¶ç¬æ—¶æµé‡ï¼š

```
å¯ç”¨é€Ÿç‡æ§åˆ¶ï¼šâœ“ å¼€å¯
æ¯ç§’é™åˆ¶ï¼š100    # æ¯ç§’æœ€å¤š100æ¡
æ¯åˆ†é’Ÿé™åˆ¶ï¼š5000  # æ¯åˆ†é’Ÿæœ€å¤š5000æ¡
æ¯å°æ—¶é™åˆ¶ï¼š0     # ä¸é™åˆ¶
æœ€å¤§å¹¶å‘æ•°ï¼š20    # æœ€å¤š20ä¸ªå¹¶å‘è¯·æ±‚
```

### åœºæ™¯2ï¼šè¥é”€çŸ­ä¿¡é€šé“

é€‚ç”¨äºè¥é”€ç±»çŸ­ä¿¡ï¼Œæ€»é‡æ§åˆ¶æ›´é‡è¦ï¼š

```
å¯ç”¨é€Ÿç‡æ§åˆ¶ï¼šâœ“ å¼€å¯
æ¯ç§’é™åˆ¶ï¼š50      # æ¯ç§’æœ€å¤š50æ¡
æ¯åˆ†é’Ÿé™åˆ¶ï¼š2000  # æ¯åˆ†é’Ÿæœ€å¤š2000æ¡
æ¯å°æ—¶é™åˆ¶ï¼š50000 # æ¯å°æ—¶æœ€å¤š50000æ¡
æœ€å¤§å¹¶å‘æ•°ï¼š10    # æœ€å¤š10ä¸ªå¹¶å‘è¯·æ±‚
```

### åœºæ™¯3ï¼šæµ‹è¯•é€šé“

é€‚ç”¨äºæµ‹è¯•ç¯å¢ƒï¼Œä¸¥æ ¼æ§åˆ¶å‘é€é‡ï¼š

```
å¯ç”¨é€Ÿç‡æ§åˆ¶ï¼šâœ“ å¼€å¯
æ¯ç§’é™åˆ¶ï¼š5       # æ¯ç§’æœ€å¤š5æ¡
æ¯åˆ†é’Ÿé™åˆ¶ï¼š100   # æ¯åˆ†é’Ÿæœ€å¤š100æ¡
æ¯å°æ—¶é™åˆ¶ï¼š1000  # æ¯å°æ—¶æœ€å¤š1000æ¡
æœ€å¤§å¹¶å‘æ•°ï¼š2     # æœ€å¤š2ä¸ªå¹¶å‘è¯·æ±‚
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å€¼ä¸º0æˆ–NULL**ï¼šè¡¨ç¤ºè¯¥ç»´åº¦ä¸é™åˆ¶
2. **å¹¶å‘æ•°æœ€å°å€¼ä¸º1**ï¼šå‰ç«¯å·²è®¾ç½®æœ€å°å€¼é™åˆ¶
3. **å¤šç»´åº¦é™åˆ¶åŒæ—¶ç”Ÿæ•ˆ**ï¼šå¦‚æœåŒæ—¶è®¾ç½®äº†å¤šä¸ªé™åˆ¶ï¼Œæ‰€æœ‰æ¡ä»¶éƒ½ä¼šè¢«æ£€æŸ¥
4. **åç«¯å®ç°å¾…å®Œæˆ**ï¼šç›®å‰åªå®Œæˆäº†å‰ç«¯ç•Œé¢å’Œæ•°æ®æ¨¡å‹ï¼Œåç«¯çš„é€Ÿç‡é™åˆ¶é€»è¾‘éœ€è¦ä½¿ç”¨ Redis æˆ–å…¶ä»–æ–¹æ¡ˆå®ç°

## ğŸ”„ ä¸‹ä¸€æ­¥å·¥ä½œ

### åç«¯é€Ÿç‡é™åˆ¶å®ç°ï¼ˆå¾…å¼€å‘ï¼‰

å»ºè®®ä½¿ç”¨ Redis + Token Bucket ç®—æ³•æˆ– Sliding Window ç®—æ³•å®ç°ï¼š

1. **æ¯ç§’é™åˆ¶**ï¼šä½¿ç”¨ Redis INCR + EXPIRE å®ç°
2. **æ¯åˆ†é’Ÿ/å°æ—¶é™åˆ¶**ï¼šä½¿ç”¨æ»‘åŠ¨çª—å£è®¡æ•°
3. **å¹¶å‘æ§åˆ¶**ï¼šä½¿ç”¨ Redis SETNX å®ç°åˆ†å¸ƒå¼é”

è¯¦ç»†çš„åç«¯å®ç°æ–¹æ¡ˆè¯·å‚è€ƒï¼š`/home/vue-element-admin/é€šé“é€Ÿç‡æ§åˆ¶åŠŸèƒ½è¯´æ˜.md`

## ğŸ“ å˜æ›´è®°å½•

- **2025-10-22**ï¼šå®Œæˆå‰ç«¯ç•Œé¢ã€æ•°æ®æ¨¡å‹ã€è¡¨å•ç»‘å®š
- **2025-10-22**ï¼šåˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬å’Œä½¿ç”¨æ–‡æ¡£

---

## å¿«é€Ÿå¤åˆ¶SQLè¯­å¥

```sql
-- æ·»åŠ é€Ÿç‡æ§åˆ¶å­—æ®µ
USE sms_system;

ALTER TABLE sms_channels 
  ADD COLUMN rate_limit_enabled TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦å¯ç”¨é€Ÿç‡æ§åˆ¶' AFTER daily_limit,
  ADD COLUMN rate_limit_per_second INT DEFAULT NULL COMMENT 'æ¯ç§’æœ€å¤§è¯·æ±‚æ•°' AFTER rate_limit_enabled,
  ADD COLUMN rate_limit_per_minute INT DEFAULT NULL COMMENT 'æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°' AFTER rate_limit_per_second,
  ADD COLUMN rate_limit_per_hour INT DEFAULT NULL COMMENT 'æ¯å°æ—¶æœ€å¤§è¯·æ±‚æ•°' AFTER rate_limit_per_minute,
  ADD COLUMN rate_limit_concurrent INT DEFAULT NULL COMMENT 'æœ€å¤§å¹¶å‘è¯·æ±‚æ•°' AFTER rate_limit_per_hour;

-- éªŒè¯
SELECT COLUMN_NAME, COLUMN_TYPE, COLUMN_DEFAULT, COLUMN_COMMENT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = 'sms_system'
  AND TABLE_NAME = 'sms_channels'
  AND COLUMN_NAME LIKE 'rate_limit%'
ORDER BY ORDINAL_POSITION;
```
