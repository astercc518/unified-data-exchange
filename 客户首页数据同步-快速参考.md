# 客户首页数据同步 - 快速参考

## 问题
❌ 客户登录首页显示的信息未同步数据库

## 原因
后端 `/api/auth/info` 接口缺少 `id` 和 `type` 字段，导致前端无法获取用户ID来加载数据

## 修复方案

### 修改后端API
**文件**: `/backend/routes/auth.js`

```javascript
// 修复：添加缺失字段
res.json({
  success: true,
  data: {
    id: user.id,              // ✅ 添加
    type: userType,           // ✅ 添加
    roles,
    name,
    loginAccount: user.login_account,
    customerName: userType === 'customer' ? user.customer_name : undefined,
    email: user.email,         // ✅ 添加
    avatar: '...',
    introduction: '...'
  }
});
```

### 重启服务
```bash
pkill -f "node.*server.js"
cd /backend && node server.js
```

## 验证修复

```bash
# 1. 登录获取token
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"KL01880V01","password":"111111"}'

# 2. 获取用户信息（验证包含id和type）
curl "http://localhost:3000/api/auth/info?token=customer-5-xxx"

# 预期结果：
{
  "success": true,
  "data": {
    "id": 5,                 ✅ 包含ID
    "type": "customer",      ✅ 包含类型
    ...
  }
}
```

## 客户首页数据来源

| 显示项 | 数据来源API | 说明 |
|--------|-----------|------|
| 账户余额 | GET /api/users/:id | 实时查询用户余额 |
| 总订单数 | GET /api/orders?customerId=xxx | 统计该客户订单 |
| 购买数据总量 | GET /api/orders | 累加订单quantity |
| 最近活动 | GET /api/orders + /api/recharge-records | 合并排序取前4条 |

## 数据流程

```
登录 → 获取Token → 调用 /api/auth/info
  ↓
返回 { id: 5, type: 'customer' }
  ↓
customer.vue 使用 id=5 加载数据
  ↓
并发调用：
  • /api/users/5 → 余额
  • /api/orders?customerId=5 → 订单
  • /api/recharge-records?customerId=5 → 充值
  ↓
渲染首页卡片
```

## 测试脚本

```bash
./test-customer-dashboard.sh
```

**预期输出**：
```
✅ 找到客户ID: 5
✅ 客户信息已加载
✅ API调用检查通过
✅ 客户首页数据已正确同步数据库！
```

## 检查清单

- [✅] /api/auth/info 返回 id 字段
- [✅] /api/auth/info 返回 type 字段
- [✅] customer.vue 使用 userInfo.id
- [✅] 所有数据从数据库查询
- [✅] 后端服务已重启

## 相关文件

- `/backend/routes/auth.js` - 后端认证路由
- `/src/views/dashboard/customer.vue` - 客户首页
- `/test-customer-dashboard.sh` - 测试脚本

---

**状态**: ✅ 已修复  
**测试**: ✅ 通过
