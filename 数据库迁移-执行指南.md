# 速率控制字段 - 数据库迁移执行指南

## 🚀 三种执行方式

### 方法1：使用SQL文件导入（最简单）✨

```bash
cd /home/vue-element-admin/scripts
mysql -u root -p sms_system < 迁移速率控制字段-简化版.sql
```

**操作步骤**：
1. 打开终端
2. 复制上面的命令
3. 粘贴执行
4. 输入MySQL密码
5. 等待执行完成

**预期输出**：
```
Enter password: [输入密码]
status
✅ 速率控制字段添加成功！

字段名                    类型        默认值  注释
rate_limit_enabled        tinyint(1)  1       是否启用速率控制
rate_limit_per_second     int(11)     100     每秒最大请求数
rate_limit_per_minute     int(11)     NULL    每分钟最大请求数
rate_limit_per_hour       int(11)     NULL    每小时最大请求数
rate_limit_concurrent     int(11)     1       最大并发请求数
```

---

### 方法2：使用交互式Shell脚本

```bash
cd /home/vue-element-admin/scripts
./执行速率控制字段迁移.sh
```

**操作步骤**：
1. 执行上面的命令
2. 看到提示后输入MySQL密码（不显示）
3. 等待执行完成

**界面提示**：
```
========================================
  短信通道 - 速率控制字段迁移
========================================

即将添加以下字段到 sms_channels 表：
  - rate_limit_enabled      (是否启用速率控制)
  - rate_limit_per_second   (每秒最大请求数)
  - rate_limit_per_minute   (每分钟最大请求数)
  - rate_limit_per_hour     (每小时最大请求数)
  - rate_limit_concurrent   (最大并发请求数)

========================================

请输入MySQL root密码：[在这里输入密码]
```

---

### 方法3：手动复制粘贴SQL

**步骤1**：登录MySQL
```bash
mysql -u root -p
```

**步骤2**：输入密码后，切换数据库
```sql
USE sms_system;
```

**步骤3**：复制粘贴以下SQL执行
```sql
ALTER TABLE sms_channels 
  ADD COLUMN rate_limit_enabled TINYINT(1) DEFAULT 1 
    COMMENT '是否启用速率控制' AFTER daily_limit,
  ADD COLUMN rate_limit_per_second INT DEFAULT 100 
    COMMENT '每秒最大请求数' AFTER rate_limit_enabled,
  ADD COLUMN rate_limit_per_minute INT DEFAULT NULL 
    COMMENT '每分钟最大请求数' AFTER rate_limit_per_second,
  ADD COLUMN rate_limit_per_hour INT DEFAULT NULL 
    COMMENT '每小时最大请求数' AFTER rate_limit_per_minute,
  ADD COLUMN rate_limit_concurrent INT DEFAULT 1 
    COMMENT '最大并发请求数' AFTER rate_limit_per_hour;
```

**步骤4**：验证字段
```sql
DESCRIBE sms_channels;
```

**步骤5**：查看新字段
```sql
SELECT 
  COLUMN_NAME,
  COLUMN_TYPE,
  COLUMN_DEFAULT,
  COLUMN_COMMENT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = 'sms_system'
  AND TABLE_NAME = 'sms_channels'
  AND COLUMN_NAME LIKE 'rate_limit%';
```

**步骤6**：退出
```sql
EXIT;
```

---

## ✅ 执行后验证

### 1. 查看表结构

```sql
mysql -u root -p -e "USE sms_system; DESCRIBE sms_channels;" | grep rate_limit
```

**预期输出**：
```
rate_limit_enabled        tinyint(1)   YES        1
rate_limit_per_second     int(11)      YES        100
rate_limit_per_minute     int(11)      YES        NULL
rate_limit_per_hour       int(11)      YES        NULL
rate_limit_concurrent     int(11)      YES        1
```

### 2. 创建测试通道

```sql
INSERT INTO sms_channels (channel_name, account, password, protocol_type) 
VALUES ('测试通道', 'test', 'test123', 'http');

-- 查看新创建的通道
SELECT 
  id,
  channel_name,
  rate_limit_enabled,
  rate_limit_per_second,
  rate_limit_concurrent
FROM sms_channels
ORDER BY id DESC
LIMIT 1;
```

**预期结果**：
```
+----+--------------+--------------------+-----------------------+------------------------+
| id | channel_name | rate_limit_enabled | rate_limit_per_second | rate_limit_concurrent |
+----+--------------+--------------------+-----------------------+------------------------+
|  X | 测试通道     |                  1 |                   100 |                      1 |
+----+--------------+--------------------+-----------------------+------------------------+
```

### 3. 前端验证

1. 刷新浏览器页面（Ctrl+F5）
2. 打开通道管理页面
3. 点击【新增】按钮
4. 查看"速率控制"区域
5. 应该看到：
   - 开关默认**开启**
   - 每秒限制显示 **100**
   - 最大并发数显示 **1**

---

## ⚠️ 常见问题

### Q1: 执行SQL时报错"字段已存在"

**错误信息**：
```
ERROR 1060 (42S21): Duplicate column name 'rate_limit_enabled'
```

**解决方法**：
字段已经存在，无需重复执行。可以查看现有字段：
```sql
DESCRIBE sms_channels;
```

### Q2: 忘记MySQL密码

**解决方法**：
尝试以下常用密码：
- `123456`
- `root`
- 空密码（直接按回车）

或查看配置文件：
```bash
cat /home/vue-element-admin/backend/config/database.js
```

### Q3: 数据库连接失败

**错误信息**：
```
ERROR 2002 (HY000): Can't connect to local MySQL server
```

**解决方法**：
1. 检查MySQL服务是否运行：
   ```bash
   systemctl status mysqld
   ```
2. 启动MySQL服务：
   ```bash
   systemctl start mysqld
   ```

### Q4: 权限不足

**错误信息**：
```
ERROR 1045 (28000): Access denied for user 'root'@'localhost'
```

**解决方法**：
1. 确认用户名和密码是否正确
2. 尝试使用其他有权限的用户
3. 查看后端配置中的数据库用户信息

---

## 📋 快速命令参考

```bash
# 推荐：使用SQL文件（最简单）
cd /home/vue-element-admin/scripts
mysql -u root -p sms_system < 迁移速率控制字段-简化版.sql

# 备选：使用交互式脚本
./执行速率控制字段迁移.sh

# 验证：查看字段
mysql -u root -p -e "USE sms_system; DESCRIBE sms_channels;" | grep rate_limit

# 测试：创建通道查看默认值
mysql -u root -p sms_system -e "INSERT INTO sms_channels (channel_name, account, password, protocol_type) VALUES ('测试速率控制', 'test', 'test123', 'http'); SELECT id, channel_name, rate_limit_enabled, rate_limit_per_second, rate_limit_concurrent FROM sms_channels ORDER BY id DESC LIMIT 1;"
```

---

## 📁 相关文件

- **SQL文件（简化版）**：`/home/vue-element-admin/scripts/迁移速率控制字段-简化版.sql`
- **Shell脚本**：`/home/vue-element-admin/scripts/执行速率控制字段迁移.sh`
- **原始SQL**：`/home/vue-element-admin/scripts/add-rate-limit-fields.sql`
- **详细版SQL**：`/home/vue-element-admin/scripts/速率控制迁移SQL.sql`

---

**推荐执行顺序**：

1. ✅ **执行迁移**（使用方法1最简单）
2. ✅ **验证字段**（查看表结构）
3. ✅ **刷新前端**（Ctrl+F5）
4. ✅ **测试功能**（创建新通道）

---

**更新时间**：2025-10-22  
**版本**：v1.1
