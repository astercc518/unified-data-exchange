# 运营商分布功能说明

## 功能概述

数据管理系统的**运营商分布**功能已经从"按市场份额分配"改为"基于实际上传文件数据分析"。

## 核心改进

### 之前（错误）
上传10000条美国号码数据，系统会**按市场份额自动分配**：
- Verizon: 3700条 (37%)
- AT&T: 3200条 (32%)
- T-Mobile: 2400条 (24%)
- Sprint: 700条 (7%)

### 现在（正确）
上传10000条美国号码数据，系统会**实际分析文件内容**：

假设文件中实际包含：
- AT&T: 4000条
- Verizon: 3000条
- T-Mobile: 3000条

则系统显示：
- AT&T: 4000条 (40%)
- Verizon: 3000条 (30%)
- T-Mobile: 3000条 (30%)

## 技术实现

### 1. 上传流程

```
用户上传数据文件
    ↓
文件上传到服务器（数据处理模块）
    ↓
自动去重、验证有效性
    ↓
调用运营商分析API
    ↓
使用 Google libphonenumber 库解析号码
    ↓
按运营商号段匹配统计
    ↓
计算每个运营商的实际数量和占比
    ↓
保存到数据库
```

### 2. API调用

**分析运营商分布接口：**
```javascript
POST /api/data-processing/analyze-operator-distribution

请求参数：
{
  "fileId": 123,              // 文件ID
  "countryCode": "1",         // 国家代码（如美国=1）
  "operators": [              // 运营商配置
    {
      "name": "AT&T",
      "numberSegments": ["201", "202", ...]
    },
    {
      "name": "Verizon",
      "numberSegments": ["203", "204", ...]
    }
  ]
}

返回结果：
{
  "success": true,
  "data": {
    "totalCount": 10000,
    "validCount": 9800,
    "invalidCount": 200,
    "distribution": [
      {
        "name": "AT&T",
        "count": 4000,
        "percentage": 40.0
      },
      {
        "name": "Verizon",
        "count": 3000,
        "percentage": 30.0
      },
      {
        "name": "T-Mobile",
        "count": 3000,
        "percentage": 30.0
      }
    ]
  }
}
```

### 3. 数据库存储

运营商分布数据存储在 `data_library` 表的 `operators` 字段（JSON格式）：

```json
[
  {
    "name": "AT&T",
    "count": 4000,
    "quantity": 4000,
    "percentage": "40.0"
  },
  {
    "name": "Verizon",
    "count": 3000,
    "quantity": 3000,
    "percentage": "30.0"
  },
  {
    "name": "T-Mobile",
    "count": 3000,
    "quantity": 3000,
    "percentage": "30.0"
  }
]
```

## 涉及文件

### 前端
- `/src/views/data/upload.vue` - 数据上传页面（主要修改）
- `/src/views/data/library.vue` - 数据列表页面（显示运营商分布）

### 后端
- `/backend/routes/dataProcessing.js` - 数据处理路由（运营商分析API）
- `/backend/routes/data.js` - 数据管理路由（保存数据）
- `/backend/utils/phoneNumberAnalyzer.js` - 号码分析工具（运营商识别）
- `/backend/models/DataLibrary.js` - 数据库模型（新增file_id字段）

## 支持的国家

理论上支持全球所有国家，只要在 `/src/data/operators.js` 中配置了该国家的运营商信息。

已配置国家示例：
- 🇺🇸 美国 (US)
- 🇲🇽 墨西哥 (MX)
- 🇦🇪 阿联酋 (AE)
- 🇧🇩 孟加拉国 (BD)
- 🇸🇦 沙特阿拉伯 (SA)
- ...等200+国家

## 注意事项

1. **运营商配置必须准确**：号段配置直接影响分析准确性
2. **文件格式要求**：TXT文件，每行一个号码
3. **号码格式**：
   - 可以包含国码（如 +1234567890）
   - 也可以不含国码（如 1234567890）
   - 系统会自动解析和验证

4. **无运营商配置的国家**：
   - 系统会提示并保存数据
   - `operators` 字段为空数组

## 测试建议

### 测试用例1：美国数据
上传文件包含：
```
2012345678  (AT&T)
2023456789  (AT&T)
3124567890  (Verizon)
3234567890  (Verizon)
4045678901  (T-Mobile)
```

期望结果：
- AT&T: 2条 (40%)
- Verizon: 2条 (40%)
- T-Mobile: 1条 (20%)

### 测试用例2：墨西哥数据
上传文件包含：
```
5215512345678  (Telcel)
5215512345679  (Telcel)
5215512345680  (Telcel)
5213312345678  (AT&T Mexico)
5213312345679  (AT&T Mexico)
```

期望结果：
- Telcel: 3条 (60%)
- AT&T Mexico: 2条 (40%)

## 更新记录

- **2025-10-18**: 实现基于实际数据的运营商分布统计
  - 修改前端上传逻辑，调用分析API
  - 后端支持file_id关联
  - 数据库模型新增file_id字段
