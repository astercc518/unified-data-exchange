# 通道配置 - 测试发送功能

## 📋 功能概述

为短信通道配置页面增加了测试发送短信功能，管理员可以在配置完通道后立即测试通道是否可用，无需等待实际业务使用。

**实施时间**: 2025-10-21  
**实施状态**: ✅ 已完成并部署

---

## 🎯 功能特性

### 1. 测试按钮
- 在通道列表的每一行添加了"测试"按钮
- 按钮位于"编辑"和"删除"按钮之前
- 使用绿色（success）主题突出显示

### 2. 测试对话框
包含以下元素：
- **通道信息提示**：显示通道名称、国家、最大字符数
- **手机号输入框**：
  - 自动显示国家代码前缀
  - 验证手机号格式（7-15位数字）
  - 提示不需要输入国家代码
- **短信内容输入框**：
  - 支持多行输入
  - 实时显示字符数统计
  - 显示当前/最大字符数
  - 超出限制时红色警告
  - 最大500字符
- **发送按钮**：
  - 显示发送状态（发送中...）
  - 防止重复点击

### 3. 测试记录
- 测试发送会创建短信记录
- 记录标记为测试（cost = 0，不计费）
- 记录关联的通道ID和用户ID
- 保存网关响应结果

### 4. 结果反馈
**成功时**：
- 绿色成功提示消息
- 显示消息ID（mid）
- 通知框显示5秒

**失败时**：
- 红色错误提示消息
- 显示详细错误原因
- 通知框显示10秒，便于排查问题

---

## 🔧 技术实现

### 后端接口

#### 新增路由
```javascript
POST /api/sms/admin/channels/:id/test
```

#### 请求参数
```json
{
  "phone_number": "9876543210",  // 手机号（不含国家代码）
  "content": "This is a test message"  // 短信内容
}
```

#### 响应示例

**成功响应**：
```json
{
  "success": true,
  "message": "测试发送成功",
  "data": {
    "mid": "20231021120530001",  // 消息ID
    "result": 0  // 0表示成功
  }
}
```

**失败响应**：
```json
{
  "success": false,
  "message": "发送失败: 号码格式错误",
  "data": {
    "result": 102  // 错误码
  }
}
```

### 支持的平台

目前支持：
- ✅ **SMS57** - 完全支持
- ⏳ **Twilio** - 暂不支持
- ⏳ **其他平台** - 暂不支持

### 验证逻辑

1. **必填字段检查**：
   - 手机号不能为空
   - 短信内容不能为空

2. **通道状态检查**：
   - 通道必须存在
   - 可以发送给禁用的通道（测试用途）

3. **字符数限制**：
   - 内容不能超过通道的 max_chars 限制
   - 前端和后端双重验证

4. **手机号格式**：
   - 7-15位数字
   - 不包含国家代码

### 发送流程

```
用户点击测试按钮
    ↓
打开测试对话框，显示通道信息
    ↓
输入手机号和短信内容
    ↓
前端验证（格式、字符数）
    ↓
发送到后端 API
    ↓
后端验证（必填、通道存在、字符数）
    ↓
调用 SMS57Service.send()
    ↓
创建测试记录（不计费）
    ↓
返回结果给前端
    ↓
显示成功/失败通知
```

---

## 📝 代码修改清单

### 1. 后端文件

#### `/backend/routes/smsAdmin.js`
- ✅ 新增 `POST /channels/:id/test` 路由
- ✅ 集成 SMS57Service
- ✅ 创建测试发送记录
- ✅ 返回详细的发送结果

**代码位置**: 第253-359行

**关键代码**：
```javascript
// 测试发送短信
router.post('/channels/:id/test', async (req, res) => {
  // 验证输入
  // 调用SMS57Service
  // 记录测试结果
  // 返回响应
});
```

### 2. 前端API文件

#### `/src/api/smsAdmin.js`
- ✅ 新增 `testSendSms(id, data)` 函数

**代码**：
```javascript
export function testSendSms(id, data) {
  return request({
    url: `/api/sms/admin/channels/${id}/test`,
    method: 'post',
    data
  })
}
```

### 3. 前端页面文件

#### `/src/views/sms/admin/channels.vue`

**修改内容**：

1. **导入测试API**（第2行）
2. **操作列添加测试按钮**（第64-73行）
   - 宽度从200px改为260px
   - 添加绿色"测试"按钮
   
3. **添加测试对话框**（第170-230行）
   - 通道信息提示
   - 手机号输入框（带国家代码前缀）
   - 短信内容输入框（多行）
   - 字符数统计
   - 发送按钮

4. **添加数据属性**（第251-267行）
   ```javascript
   testDialogVisible: false,
   testSending: false,
   currentChannel: {},
   testData: { phone_number: '', content: '' },
   testRules: { ... }
   ```

5. **添加方法**（第322-374行）
   - `handleTest(row)` - 打开测试对话框
   - `sendTestSms()` - 发送测试短信

---

## 🧪 测试指南

### 测试步骤

1. **登录系统**
   - URL: http://103.246.246.11:9527
   - 用户名: admin
   - 密码: 58ganji@123

2. **进入通道配置页面**
   - 导航: 短信管理 > 通道配置

3. **点击测试按钮**
   - 选择任意一个启用的通道
   - 点击该行的"测试"按钮

4. **填写测试信息**
   - **手机号**: 输入印度手机号（如 9876543210）
   - **短信内容**: 输入测试内容（如 "Test message from admin"）
   - 查看字符数统计

5. **发送测试短信**
   - 点击"发送测试短信"按钮
   - 等待响应（通常2-5秒）

6. **查看结果**
   - 成功：绿色通知，显示消息ID
   - 失败：红色通知，显示错误原因

### 测试场景

#### 场景1：正常发送
- **通道**: 印度SMS57通道
- **手机号**: 9876543210
- **内容**: "This is a test message"
- **预期**: 发送成功，显示消息ID

#### 场景2：号码格式错误
- **手机号**: 123（少于7位）
- **预期**: 前端验证失败，提示"请输入有效的手机号"

#### 场景3：内容超长
- **内容**: 输入超过通道max_chars的文本
- **预期**: 
  - 前端显示红色警告"(超出限制)"
  - 发送时提示"内容超过最大字符数限制"

#### 场景4：空内容
- **手机号**: 9876543210
- **内容**: （留空）
- **预期**: 前端验证失败，提示"请输入短信内容"

#### 场景5：通道不可用
- **通道**: 使用错误的账号/密码配置的通道
- **预期**: 发送失败，显示SMS57返回的错误信息

### 查看测试记录

测试发送的记录会保存在数据库中：

```sql
-- 查看最近的测试记录
SELECT 
  id,
  phone_number,
  content,
  status,
  cost,  -- 应该为0
  gateway_response,
  created_at
FROM sms_records
WHERE cost = 0  -- 测试记录不计费
ORDER BY created_at DESC
LIMIT 10;
```

---

## 🔍 错误排查

### 常见错误及解决方法

#### 1. 404 错误
**错误**：`POST /api/sms/admin/channels/1/test 404`

**原因**：后端路由未生效

**解决**：
```bash
pm2 restart vue-admin-server
pm2 logs vue-admin-server --lines 50
```

#### 2. 500 错误 - SMS57Service not found
**错误**：`Cannot find module '../services/sms57Service'`

**原因**：SMS57服务文件不存在

**解决**：
```bash
# 检查文件是否存在
ls -la /home/vue-element-admin/backend/services/sms57Service.js

# 如不存在，需要创建该服务文件
```

#### 3. 发送失败 - 账号密码错误
**错误**：`发送失败: 账号或密码错误`

**原因**：通道配置的账号密码不正确

**解决**：
- 编辑通道，更新正确的账号和密码
- 联系SMS57获取正确的凭证

#### 4. 发送失败 - 号码格式错误
**错误**：`发送失败: 号码格式错误`

**原因**：
- 输入了国家代码（应该只输入号码）
- 号码长度不符合要求

**解决**：
- 只输入纯数字，不含国家代码
- 印度手机号通常是10位

#### 5. 前端显示"测试发送失败"
**错误**：通用错误提示

**解决**：
```bash
# 查看后端日志
pm2 logs vue-admin-server --lines 100

# 查看网络请求
# 浏览器F12 > Network > 查看请求详情
```

---

## 📊 功能对比

| 功能 | 修改前 | 修改后 |
|------|--------|--------|
| 测试发送 | ❌ 不支持 | ✅ 支持 |
| 验证通道 | ❌ 需要实际使用 | ✅ 可立即测试 |
| 测试记录 | ❌ 无记录 | ✅ 保存记录（不计费） |
| 错误提示 | ❌ 无 | ✅ 详细错误信息 |
| 字符数检查 | ❌ 无 | ✅ 实时统计 |
| 多平台支持 | - | ⚠️ 目前仅SMS57 |

---

## 🎨 界面预览

### 通道列表 - 测试按钮
```
┌───────────────────────────────────────────────────────┐
│ ID │ 通道名称 │ 国家 │ ... │ 操作                  │
├────┼─────────┼──────┼─────┼──────────────────────┤
│ 1  │ 印度SMS57│ India│ ... │ [测试] [编辑] [删除] │
│ 2  │ 美国SMS57│ USA  │ ... │ [测试] [编辑] [删除] │
└────┴─────────┴──────┴─────┴──────────────────────┘
```

### 测试对话框布局
```
┌──────────────────────────────────────┐
│  测试发送短信                    [X] │
├──────────────────────────────────────┤
│                                      │
│  ℹ️ 通道: 印度SMS57通道               │
│    国家: India (+91)                 │
│    最大字符: 160                     │
│                                      │
│  手机号码: [+91] [_____________]     │
│            请输入不含国家代码的手机号 │
│                                      │
│  短信内容: [____________________]    │
│           [____________________]    │
│           [____________________]    │
│           [____________________]    │
│           当前字符数: 25 / 160      │
│                                      │
│                    [取消] [发送测试短信] │
└──────────────────────────────────────┘
```

---

## 🚀 部署信息

### 编译状态
```bash
✅ 前端编译: 成功
✅ 后端重启: 成功
✅ 服务状态: 运行中
```

### 访问信息
- **前端地址**: http://103.246.246.11:9527
- **后端地址**: http://103.246.246.11:3000
- **测试接口**: POST http://103.246.246.11:3000/api/sms/admin/channels/:id/test

### 服务器信息
- **PM2进程**: vue-admin-server (ID: 2)
- **重启次数**: 2972
- **内存使用**: ~75MB
- **状态**: online

---

## 📌 注意事项

### 使用建议

1. **测试前确认通道配置**
   - 确保账号、密码、网关地址正确
   - 确保通道类型为 SMS57

2. **使用真实号码测试**
   - 使用实际存在的手机号
   - 最好使用自己的号码接收测试

3. **注意字符数限制**
   - 不同通道有不同的字符数限制
   - 超出限制会发送失败

4. **测试记录不计费**
   - 测试发送的 cost 字段为 0
   - 不会扣除用户余额
   - 但实际会通过SMS57发送（产生运营商费用）

5. **频率控制**
   - 避免频繁测试同一号码
   - 可能触发运营商限制

### 安全考虑

1. **权限控制**
   - 仅管理员可以测试
   - 需要登录并有相应权限

2. **日志记录**
   - 所有测试发送都有日志
   - 可追溯测试历史

3. **防止滥用**
   - 建议添加每日测试次数限制
   - 建议添加IP限流

---

## 🔄 后续优化建议

### 功能增强

1. **添加批量测试**
   - 支持一次测试多个号码
   - 验证通道稳定性

2. **支持更多平台**
   - Twilio
   - Nexmo
   - 阿里云短信
   - 腾讯云短信

3. **测试报告**
   - 显示测试历史
   - 成功率统计
   - 响应时间统计

4. **模板测试**
   - 支持从模板选择内容
   - 变量替换测试

### UI优化

1. **添加测试历史弹窗**
   - 显示该通道的测试记录
   - 查看历史测试结果

2. **添加快速测试**
   - 一键使用默认号码和内容
   - 快速验证通道可用性

3. **添加定时测试**
   - 定期自动测试通道
   - 通道故障告警

### 性能优化

1. **异步发送**
   - 大批量测试时异步处理
   - 避免请求超时

2. **结果缓存**
   - 缓存最近的测试结果
   - 减少数据库查询

---

## ✅ 完成总结

### 已实现功能

- ✅ 测试发送按钮
- ✅ 测试对话框界面
- ✅ 手机号格式验证
- ✅ 字符数实时统计
- ✅ SMS57平台发送
- ✅ 测试记录保存
- ✅ 成功/失败通知
- ✅ 详细错误提示

### 技术栈

- **后端**: Node.js + Express + Sequelize
- **前端**: Vue 2 + Element UI
- **短信服务**: SMS57
- **数据库**: MariaDB

### 文件清单

| 文件 | 修改类型 | 说明 |
|------|---------|------|
| `/backend/routes/smsAdmin.js` | ✏️ 修改 | 添加测试发送接口 |
| `/src/api/smsAdmin.js` | ✏️ 修改 | 添加测试API方法 |
| `/src/views/sms/admin/channels.vue` | ✏️ 修改 | 添加测试UI和逻辑 |

### 数据库影响

- **新增记录**: 每次测试会在 `sms_records` 表新增一条记录
- **字段标识**: `cost = 0` 标识测试记录
- **关联字段**: `task_id = NULL`，`user_id = 管理员ID`

---

## 📞 技术支持

如有问题，请检查：

1. **后端日志**
   ```bash
   pm2 logs vue-admin-server --lines 100
   ```

2. **前端控制台**
   - 浏览器 F12 > Console
   - 查看JavaScript错误

3. **网络请求**
   - 浏览器 F12 > Network
   - 查看API请求和响应

4. **数据库记录**
   ```sql
   SELECT * FROM sms_records 
   WHERE cost = 0 
   ORDER BY created_at DESC 
   LIMIT 10;
   ```

---

**文档版本**: 1.0  
**最后更新**: 2025-10-21  
**作者**: Qoder AI Assistant
