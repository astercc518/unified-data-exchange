# 数据购买业务流程优化说明

## 📋 业务流程概述

本次优化实现了完整的数据购买业务流程，涉及客户、代理两个角色的协同工作。

### 完整业务流程图

```
客户端操作流程:
资源中心 → 选择数据 → 提交购买 → 生成订单(pending) 
    ↓
待处理订单页面 → 点击"提交审核" → 订单状态变更(reviewing)
    ↓
等待代理审核...

代理端操作流程:
审核订单页面 → 查看订单详情 → 审核通过/拒绝
    ↓ (通过)
订单流转到已完成订单(completed + 待发货)

客户端/代理端发货流程:
已完成订单页面 → 点击"发货" → 跳转发货界面
    ↓
填写发货信息(邮箱/TGbot) → 提交发货 → 订单状态(delivered)
```

## 🎯 订单状态流转

### 订单状态定义

| 状态代码 | 中文名称 | 说明 | 可见角色 |
|---------|---------|------|---------|
| `pending` | 待处理 | 客户刚下单，等待提交审核 | 客户 |
| `reviewing` | 审核中 | 客户已提交，等待代理审核 | 代理/管理员 |
| `completed` | 已完成 | 代理审核通过，等待发货 | 全部 |
| `cancelled` | 已取消 | 订单被拒绝或取消 | 全部 |

### 发货状态定义

| 状态代码 | 中文名称 | 说明 |
|---------|---------|------|
| `pending` | 待发货 | 订单已完成但未发货 |
| `delivered` | 已发货 | 数据已发送给客户 |

## 📁 新增/修改的文件

### 1. 待处理订单页面 (客户端)
**文件**: `/src/views/order/pending.vue`

**功能**:
- 显示客户自己的待处理订单(status = 'pending')
- 提供"提交审核"按钮
- 点击后订单状态变更为 'reviewing'，并记录提交时间

**关键代码**:
```javascript
handleProcess(row) {
  this.$confirm('确认将该订单提交给代理审核？', this.$t('common.warning'), {
    confirmButtonText: this.$t('common.confirm'),
    cancelButtonText: this.$t('common.cancel'),
    type: 'warning'
  }).then(() => {
    const savedOrders = localStorage.getItem('orderList')
    if (savedOrders) {
      const orders = JSON.parse(savedOrders)
      const orderIndex = orders.findIndex(o => o.id === row.id)
      if (orderIndex !== -1) {
        orders[orderIndex].status = 'reviewing' // 审核中
        orders[orderIndex].reviewTime = Date.now() // 提交审核时间
        localStorage.setItem('orderList', JSON.stringify(orders))
        this.$message.success('订单已提交给代理审核')
        this.getList()
        this.getStatistics()
      }
    }
  }).catch(() => {})
}
```

**统计卡片**:
- 待处理订单数
- 审核中订单数
- 待处理总金额

### 2. 审核订单页面 (代理端) ✨新建
**文件**: `/src/views/order/review.vue`

**功能**:
- 显示所有待审核订单(status = 'reviewing')
- 提供"通过"和"拒绝"两个操作按钮
- 审核通过: 订单状态变更为 'completed'，发货状态为 'pending'
- 审核拒绝: 订单状态变更为 'cancelled'，记录拒绝原因

**关键代码**:
```javascript
confirmReview() {
  if (this.reviewAction === 'reject' && !this.rejectReason.trim()) {
    this.$message.warning('请输入拒绝原因')
    return
  }

  this.reviewLoading = true

  setTimeout(() => {
    const savedOrders = localStorage.getItem('orderList')
    if (savedOrders) {
      const orders = JSON.parse(savedOrders)
      const orderIndex = orders.findIndex(o => o.id === this.currentOrder.id)
      if (orderIndex !== -1) {
        if (this.reviewAction === 'approve') {
          // 审核通过，流转到已完成订单，状态为待发货
          orders[orderIndex].status = 'completed'
          orders[orderIndex].deliveryStatus = 'pending'
          orders[orderIndex].approveTime = Date.now()
          this.$message.success('审核通过！订单已流转到已完成订单，等待发货')
        } else {
          // 审核拒绝
          orders[orderIndex].status = 'cancelled'
          orders[orderIndex].rejectReason = this.rejectReason
          orders[orderIndex].rejectTime = Date.now()
          this.$message.success('订单已拒绝')
        }
        localStorage.setItem('orderList', JSON.stringify(orders))
      }
    }
    this.reviewLoading = false
    this.reviewDialogVisible = false
    this.getList()
    this.getStatistics()
  }, 1500)
}
```

**统计卡片**:
- 待审核订单数
- 今日已审核数
- 待审核总金额

**权限**: 仅代理(agent)和管理员(admin)可访问

### 3. 已完成订单页面 (客户/代理端)
**文件**: `/src/views/order/completed.vue`

**修改内容**:
- 增加发货状态显示列
- 待发货订单显示"发货"按钮
- 已发货订单显示"下载"按钮
- 点击"发货"按钮跳转到发货页面

**关键代码**:
```vue
<el-table-column
  label="发货状态"
  prop="deliveryStatus"
  width="100"
  align="center"
>
  <template slot-scope="{row}">
    <el-tag v-if="row.deliveryStatus === 'pending'" type="warning">
      待发货
    </el-tag>
    <el-tag v-else-if="row.deliveryStatus === 'delivered'" type="success">
      已发货
    </el-tag>
  </template>
</el-table-column>

<!-- 操作列 -->
<el-button
  v-if="row.deliveryStatus === 'pending'"
  type="success"
  size="mini"
  @click="handleDeliver(row)"
>
  发货
</el-button>
```

```javascript
handleDeliver(row) {
  // 跳转到发货页面
  this.$router.push({
    path: `/order/delivery/${row.id}`
  })
}
```

### 4. 发货页面 ✨新建
**文件**: `/src/views/order/delivery.vue`

**功能**:
- **数据基本信息**: 订单号、数据国家、时效、来源、数量、运营商分布
- **客户基本信息**: 客户名称、下单时间、订单金额、审核通过时间
- **发货方式选择**:
  1. **邮箱发货**: 输入接收邮箱地址
  2. **TGbot发货**: 输入Telegram Bot ID和用户名
- **备注信息**: 可选填写发货备注
- **提交发货**: 更新订单状态为已发货(delivered)

**关键代码**:
```javascript
doDelivery() {
  this.submitting = true
  console.log('📦 开始发货，订单ID:', this.orderId)

  setTimeout(() => {
    const savedOrders = localStorage.getItem('orderList')
    if (savedOrders) {
      const orders = JSON.parse(savedOrders)
      const orderIndex = orders.findIndex(o => o.id === this.orderId)
      
      if (orderIndex !== -1) {
        // 更新订单状态
        orders[orderIndex].deliveryStatus = 'delivered'
        orders[orderIndex].deliveryTime = Date.now()
        orders[orderIndex].deliveryMethod = this.deliveryForm.deliveryMethod
        
        if (this.deliveryForm.deliveryMethod === 'email') {
          orders[orderIndex].deliveryEmail = this.deliveryForm.deliveryEmail
        } else {
          orders[orderIndex].tgBotId = this.deliveryForm.tgBotId
          orders[orderIndex].tgUsername = this.deliveryForm.tgUsername
        }
        
        orders[orderIndex].deliveryRemark = this.deliveryForm.remark

        localStorage.setItem('orderList', JSON.stringify(orders))
        
        this.$message({
          type: 'success',
          message: '发货成功！数据已发送到指定地址',
          duration: 3000
        })

        setTimeout(() => {
          this.goBack()
        }, 1500)
      }
    }
    this.submitting = false
  }, 2000)
}
```

**表单验证**:
- 邮箱格式验证
- TG Bot ID必填验证
- 发货方式必选验证

**界面设计**:
- 使用 `el-descriptions` 组件展示订单信息
- 使用 `el-form` 组件处理发货表单
- 清晰的分区标题和图标
- 响应式布局

### 5. 路由配置
**文件**: `/src/router/index.js`

**新增路由**:
```javascript
{
  path: 'review',
  component: () => import('@/views/order/review'),
  name: 'ReviewOrders',
  meta: {
    title: 'navbar.reviewOrders',
    icon: 'document-checked',
    roles: ['agent', 'admin']
  }
},
{
  path: 'delivery/:id(\\d+)',
  component: () => import('@/views/order/delivery'),
  name: 'OrderDelivery',
  meta: {
    title: 'navbar.orderDelivery',
    roles: ['agent', 'admin']
  },
  hidden: true
}
```

**路由权限**:
- 待处理订单(pending): 仅客户(customer)可见
- 审核订单(review): 仅代理(agent)和管理员(admin)可见
- 已完成订单(completed): 所有角色可见
- 发货页面(delivery): 仅代理(agent)和管理员(admin)可访问

### 6. 语言配置
**文件**: `/src/lang/index.js`

**新增翻译**:
```javascript
// 中文
navbar: {
  reviewOrders: '审核订单',
  orderDelivery: '订单发货',
}

// 英文
navbar: {
  reviewOrders: 'Review Orders',
  orderDelivery: 'Order Delivery',
}
```

## 🔄 数据流转时间线

### 订单生命周期完整时间线

| 时间字段 | 说明 | 触发时机 |
|---------|------|---------|
| `createTime` | 订单创建时间 | 客户在资源中心购买数据 |
| `reviewTime` | 提交审核时间 | 客户点击"提交审核" |
| `approveTime` | 审核通过时间 | 代理审核通过 |
| `rejectTime` | 拒绝时间 | 代理审核拒绝 |
| `deliveryTime` | 发货时间 | 发货成功 |

### 订单数据结构

```javascript
{
  id: 1,
  orderNo: "ORD1234567890ABCD",
  customerName: "张三",
  country: "孟加拉国",
  validity: "3",
  source: "公开数据",
  quantity: 10000,
  operators: [
    { name: "Grameenphone", count: 4000 },
    { name: "Robi", count: 3000 },
    { name: "Banglalink", count: 2000 },
    { name: "Teletalk", count: 1000 }
  ],
  totalAmount: "50.00",
  deliveryEmail: "customer@example.com",
  
  // 状态字段
  status: "completed",           // pending/reviewing/completed/cancelled
  deliveryStatus: "pending",     // pending/delivered
  
  // 时间字段
  createTime: 1697123456789,     // 创建时间
  reviewTime: 1697123556789,     // 提交审核时间
  approveTime: 1697123656789,    // 审核通过时间
  rejectTime: null,              // 拒绝时间
  deliveryTime: null,            // 发货时间
  
  // 发货信息
  deliveryMethod: "email",       // email/tgbot
  tgBotId: "",                   // TG Bot ID
  tgUsername: "",                // TG 用户名
  deliveryRemark: "",            // 发货备注
  
  // 审核信息
  rejectReason: "",              // 拒绝原因
  remark: ""                     // 订单备注
}
```

## 📊 页面访问路径

| 页面名称 | 访问路径 | 显示角色 |
|---------|---------|---------|
| 订单列表 | `/order/list` | 全部 |
| 待处理订单 | `/order/pending` | 客户 |
| 审核订单 | `/order/review` | 代理/管理员 |
| 已完成订单 | `/order/completed` | 全部 |
| 订单详情 | `/order/detail/:id` | 全部(隐藏) |
| 订单发货 | `/order/delivery/:id` | 代理/管理员(隐藏) |

## 🎨 界面优化

### 统计卡片设计
每个页面都设计了3个统计卡片，使用渐变背景色区分：

- **待处理订单页面**: 黄色(待处理) + 蓝色(审核中) + 绿色(金额)
- **审核订单页面**: 黄色(待审核) + 绿色(已审核) + 蓝色(金额)
- **已完成订单页面**: 绿色(已完成) + 蓝色(数据量) + 黄色(金额)

### 状态标签颜色
- `pending` (待处理): warning - 黄色
- `reviewing` (审核中): primary - 蓝色
- `completed` (已完成): success - 绿色
- `cancelled` (已取消): danger - 红色
- 待发货: warning - 黄色
- 已发货: success - 绿色

## 🔔 用户提示信息

### 操作成功提示
- "订单已提交给代理审核" (客户提交审核)
- "审核通过！订单已流转到已完成订单，等待发货" (代理审核通过)
- "订单已拒绝" (代理审核拒绝)
- "发货成功！数据已发送到指定地址" (发货成功)

### 操作确认对话框
- "确认将该订单提交给代理审核？"
- "确认通过/拒绝该订单？"
- "确认发货？数据将发送到指定地址"

## 📝 使用说明

### 客户操作流程

1. **在资源中心购买数据**
   - 访问: `/resource/center`
   - 选择数据并购买
   - 订单自动生成，状态为 `pending`

2. **提交审核**
   - 访问: `/order/pending`
   - 查看待处理订单
   - 点击"提交审核"按钮
   - 订单状态变更为 `reviewing`

3. **等待代理审核**
   - 代理审核通过后，订单流转到已完成订单
   - 可在 `/order/completed` 查看

4. **等待发货**
   - 订单显示"待发货"状态
   - 等待代理或管理员发货

### 代理操作流程

1. **审核订单**
   - 访问: `/order/review`
   - 查看待审核订单列表
   - 点击"详情"查看订单详情
   - 点击"通过"或"拒绝"进行审核

2. **审核通过**
   - 订单自动流转到已完成订单
   - 发货状态为"待发货"
   - 记录审核通过时间

3. **审核拒绝**
   - 必须填写拒绝原因
   - 订单状态变更为 `cancelled`
   - 记录拒绝时间和原因

4. **发货操作**
   - 访问: `/order/completed`
   - 找到待发货订单
   - 点击"发货"按钮
   - 跳转到发货页面 `/order/delivery/:id`

5. **填写发货信息**
   - 查看订单详细信息
   - 选择发货方式(邮箱/TGbot)
   - 填写发货地址
   - 可选填写备注信息
   - 点击"确认发货"

6. **发货成功**
   - 订单状态变更为"已发货"
   - 记录发货时间和方式
   - 自动返回已完成订单页面

## 🔍 技术要点

### 1. Vue 组件缓存处理
使用 `activated()` 钩子确保从其他页面返回时数据自动刷新：

```javascript
activated() {
  console.log('🔄 页面被激活，重新加载数据...')
  this.getList()
  this.getStatistics()
}
```

### 2. 权限控制
通过路由 meta 中的 roles 字段控制页面访问权限：

```javascript
meta: {
  title: 'navbar.reviewOrders',
  icon: 'document-checked',
  roles: ['agent', 'admin']  // 仅代理和管理员可访问
}
```

### 3. 状态流转日志
每个状态变更都有详细的控制台日志输出，便于调试：

```javascript
console.log('✅ 订单审核通过:', orders[orderIndex].orderNo)
console.log('❌ 订单被拒绝:', orders[orderIndex].orderNo, '原因:', this.rejectReason)
console.log('📦 开始发货，订单ID:', this.orderId)
```

### 4. 数据验证
发货表单使用 Element UI 的表单验证：

```javascript
const validateEmail = (rule, value, callback) => {
  if (!value) {
    callback(new Error('请输入接收邮箱'))
  } else if (!/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/.test(value)) {
    callback(new Error('请输入正确的邮箱格式'))
  } else {
    callback()
  }
}
```

### 5. 用户体验优化
- 加载状态显示
- 操作确认对话框
- 成功提示消息
- 自动返回上一页
- 响应式界面设计

## 🎯 后续优化建议

1. **API 对接**: 将 localStorage 替换为真实的后端 API
2. **实时通知**: 使用 WebSocket 实现订单状态变更的实时通知
3. **文件上传**: 实现真实的数据文件上传和下载功能
4. **审核历史**: 记录完整的审核历史和操作日志
5. **批量操作**: 支持批量审核和批量发货
6. **导出报表**: 支持订单数据导出为 Excel
7. **邮件通知**: 状态变更时自动发送邮件通知客户
8. **TG Bot集成**: 真实集成 Telegram Bot API

## 📌 注意事项

1. **数据持久化**: 当前使用 localStorage 存储，刷新页面数据不会丢失
2. **权限验证**: 确保登录用户角色正确，否则无法访问对应页面
3. **状态一致性**: 订单状态变更时同时更新相关时间字段
4. **表单验证**: 发货前必须验证表单数据的完整性和正确性
5. **错误处理**: 添加了完善的错误处理和用户提示

## ✅ 测试要点

### 功能测试
- [x] 客户提交订单审核
- [x] 代理查看待审核订单
- [x] 代理审核通过订单
- [x] 代理审核拒绝订单
- [x] 查看已完成订单列表
- [x] 待发货订单显示发货按钮
- [x] 跳转到发货页面
- [x] 邮箱发货流程
- [x] TGbot发货流程
- [x] 发货成功状态更新

### 权限测试
- [x] 客户只能看到待处理订单
- [x] 代理可以看到审核订单
- [x] 所有角色可以看到已完成订单
- [x] 发货页面权限控制

### 数据测试
- [x] 订单状态正确流转
- [x] 时间字段正确记录
- [x] 统计数据准确计算
- [x] 表单验证正确执行

## 📞 技术支持

如有问题或需要进一步优化，请联系开发团队。

---

**文档版本**: v1.0  
**更新日期**: 2025-10-12  
**适用系统**: Vue Element Admin 数据管理系统
