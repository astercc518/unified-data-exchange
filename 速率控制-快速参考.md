# 速率控制功能 - 快速参考指南

## 🎯 新的默认配置（v1.1）

### 创建新通道时的默认值

```javascript
{
  rate_limit_enabled: true,        // ✓ 默认开启
  rate_limit_per_second: 100,      // 每秒100次
  rate_limit_per_minute: 0,        // 不限制
  rate_limit_per_hour: 0,          // 不限制
  rate_limit_concurrent: 1         // 并发数1（串行）
}
```

### 界面效果

```
┌────────────────────────────────────────┐
│ ✓ 启用速率控制 [━━━● 开启]            │
│   防止超频请求，保护通道稳定性         │
│                                        │
│   每秒限制:   [  100  ]  ← 默认开启   │
│   每分钟限制: [   0   ]  ← 不限制     │
│   每小时限制: [   0   ]  ← 不限制     │
│   最大并发数: [   1   ]  ← 串行发送   │
└────────────────────────────────────────┘
```

---

## 📊 性能计算

### 默认配置性能

```
每秒 100 次 × 60 秒 = 每分钟 6,000 次
每秒 100 次 × 3600 秒 = 每小时 360,000 次
```

### 吞吐量对比

| 并发数 | 每秒最大 | 每分钟最大 | 每小时最大 |
|--------|----------|------------|------------|
| 1      | 100      | 6,000      | 360,000    |
| 5      | 100      | 6,000      | 360,000    |
| 10     | 100      | 6,000      | 360,000    |
| 20     | 100      | 6,000      | 360,000    |

**注意**：并发数不影响速率限制，只影响处理延迟。

---

## 🔧 数据库迁移 SQL（最新版）

### 快速复制执行

```sql
USE sms_system;

ALTER TABLE sms_channels 
  ADD COLUMN rate_limit_enabled TINYINT(1) DEFAULT 1 
    COMMENT '是否启用速率控制' AFTER daily_limit,
  ADD COLUMN rate_limit_per_second INT DEFAULT 100 
    COMMENT '每秒最大请求数' AFTER rate_limit_enabled,
  ADD COLUMN rate_limit_per_minute INT DEFAULT NULL 
    COMMENT '每分钟最大请求数' AFTER rate_limit_per_second,
  ADD COLUMN rate_limit_per_hour INT DEFAULT NULL 
    COMMENT '每小时最大请求数' AFTER rate_limit_per_minute,
  ADD COLUMN rate_limit_concurrent INT DEFAULT 1 
    COMMENT '最大并发请求数' AFTER rate_limit_per_hour;
```

### 执行方法

```bash
# 方法1：交互式脚本
cd /home/vue-element-admin/scripts
./执行速率控制字段迁移.sh

# 方法2：SQL文件
mysql -u root -p sms_system < 速率控制迁移SQL.sql

# 方法3：手动执行
mysql -u root -p
# 然后复制粘贴上面的SQL
```

---

## 🎨 常用配置模板

### 验证码通道（高频）

```
✓ 启用速率控制
每秒限制:   200
每分钟限制: 0
每小时限制: 0
最大并发数: 20
```

### 通知短信（中频）

```
✓ 启用速率控制
每秒限制:   100   ← 使用默认
每分钟限制: 5000
每小时限制: 0
最大并发数: 10
```

### 营销短信（低频）

```
✓ 启用速率控制
每秒限制:   50
每分钟限制: 2000
每小时限制: 50000
最大并发数: 5
```

### 测试通道（严格）

```
✓ 启用速率控制
每秒限制:   10
每分钟限制: 100
每小时限制: 1000
最大并发数: 1     ← 使用默认
```

---

## 📁 已修改的文件

| 文件 | 修改内容 |
|------|----------|
| `src/views/sms/admin/channels.vue` | temp对象和resetTemp方法默认值 |
| `backend/models/SmsChannel.js` | 数据库模型默认值 |
| `scripts/add-rate-limit-fields.sql` | SQL默认值 |
| `scripts/速率控制迁移SQL.sql` | SQL默认值 |
| `scripts/执行速率控制字段迁移.sh` | Shell脚本SQL |

---

## ✅ 验证清单

### 前端验证

- [ ] 创建新通道，速率控制开关应默认打开
- [ ] 每秒限制应显示 100
- [ ] 最大并发数应显示 1
- [ ] 速率控制区域应自动展开

### 数据库验证

```sql
-- 查看新创建的通道
SELECT 
  channel_name,
  rate_limit_enabled,
  rate_limit_per_second,
  rate_limit_concurrent
FROM sms_channels
ORDER BY created_at DESC
LIMIT 1;

-- 期望结果
-- enabled=1, per_second=100, concurrent=1
```

---

## 🚀 下一步

1. **执行数据库迁移**（如果尚未执行）
2. **刷新浏览器**（Ctrl+F5）
3. **创建测试通道**验证默认配置
4. **根据实际需求**调整各通道配置

---

## 📚 完整文档

- **默认配置说明**：`速率控制默认配置说明.md`
- **迁移指南**：`速率控制功能-数据库迁移指南.md`
- **界面说明**：`速率控制功能-界面说明.md`
- **功能详解**：`通道速率控制功能说明.md`

---

**版本**：v1.1  
**更新**：2025-10-22
