# 订阅中心功能说明

## 功能概述

在资源中心新增**订阅中心**标签页，为客户提供个性化的数据推荐服务。订阅中心根据客户的购买历史和收藏记录，智能推荐相关数据。

---

## 实现内容

### 1. 后端实现

#### 新增API接口

**路由地址**: `/api/data-library/subscription/:customerId`

**请求方法**: GET

**请求参数**:
- `customerId` (路径参数): 客户ID
- `page` (查询参数): 页码，默认1
- `limit` (查询参数): 每页数量，默认20

**功能逻辑**:

1. **获取已购买订单的国家和类型**
   ```javascript
   const purchasedOrders = await Order.findAll({
     where: { 
       customer_id: customerId,
       status: 'completed'
     },
     attributes: ['country', 'data_type'],
     group: ['country', 'data_type']
   });
   ```

2. **获取收藏的数据ID**
   ```javascript
   const favorites = await Favorite.findAll({
     where: { customer_id: customerId },
     attributes: ['data_id']
   });
   ```

3. **查询推荐数据**
   - 查询与已购买订单相同国家和数据类型的可用数据
   - 查询用户收藏的数据
   - 合并去重后返回

4. **标记数据来源**
   - `favorite`: 来自收藏
   - `purchased`: 来自已购买推荐
   - `both`: 既在收藏中又属于已购买类型

**响应格式**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "country": "BD",
      "country_name": "孟加拉国",
      "data_type": "手机号码",
      "validity": "3",
      "validity_name": "3天内",
      "source": "官方渠道",
      "available_quantity": 500000,
      "sell_price": 0.05,
      "operators": [...],
      "subscriptionSource": "purchased",
      "isFavorited": false,
      "isPurchasedType": true
    }
  ],
  "total": 10,
  "page": 1,
  "limit": 20
}
```

**文件路径**: `/home/vue-element-admin/backend/routes/data.js`

---

### 2. 前端实现

#### 页面结构调整

**文件路径**: `/home/vue-element-admin/src/views/resource/center.vue`

#### 主要修改点

1. **添加标签页组件**
   ```vue
   <el-tabs v-model="activeTab" @tab-click="handleTabClick">
     <el-tab-pane label="可购买数据" name="available">
       <!-- 原有的数据列表 -->
     </el-tab-pane>
     
     <el-tab-pane name="subscription">
       <span slot="label">
         <i class="el-icon-star-on" />
         订阅中心
       </span>
       <!-- 订阅数据列表 -->
     </el-tab-pane>
   </el-tabs>
   ```

2. **新增数据字段**
   ```javascript
   data() {
     return {
       activeTab: 'available',
       // 订阅中心数据
       subscriptionList: [],
       subscriptionTotal: 0,
       subscriptionLoading: false,
       subscriptionQuery: {
         page: 1,
         limit: 20
       }
     }
   }
   ```

3. **新增方法**

   **标签页切换事件**:
   ```javascript
   handleTabClick(tab) {
     if (tab.name === 'subscription') {
       this.getSubscriptionList()
     }
   }
   ```

   **获取订阅数据**:
   ```javascript
   async getSubscriptionList() {
     if (!this.customerId) {
       console.warn('未找到客户ID，无法加载订阅数据')
       return
     }

     this.subscriptionLoading = true
     
     try {
       const response = await request({
         method: 'GET',
         url: `/api/data-library/subscription/${this.customerId}`,
         params: {
           page: this.subscriptionQuery.page,
           limit: this.subscriptionQuery.limit
         }
       })

       if (response.success) {
         this.subscriptionList = response.data || []
         this.subscriptionTotal = response.total || 0
         
         // 更新收藏状态
         this.subscriptionList.forEach(item => {
           if (item.isFavorited) {
             this.favoriteIds.add(item.id)
           }
         })
       }
     } catch (error) {
       console.error('获取订阅数据失败:', error)
       this.$message.error('获取订阅数据失败：' + error.message)
     } finally {
       this.subscriptionLoading = false
     }
   }
   ```

   **解析运营商数据**:
   ```javascript
   parseOperators(operators) {
     if (!operators) return []
     if (typeof operators === 'string') {
       try {
         return JSON.parse(operators)
       } catch (e) {
         return []
       }
     }
     return operators
   }
   ```

---

## 功能特点

### 1. 智能推荐

- **基于购买历史**: 推荐与已购买数据相同国家和类型的新数据
- **基于收藏**: 显示用户收藏的所有数据
- **来源标识**: 清晰标记数据来源（收藏/已购/两者皆有）

### 2. 用户体验

- **权限控制**: 仅对客户开放，代理和管理员看到提示信息
- **数据来源标签**:
  - 🟡 黄色标签: 收藏
  - 🟢 绿色标签: 已购推荐
  - 🔵 蓝色标签: 收藏+已购

- **空状态提示**: 无订阅数据时显示友好提示

### 3. 完整功能

订阅中心的数据支持:
- ✅ 查看数据详情
- ✅ 购买操作
- ✅ 收藏/取消收藏
- ✅ 分页浏览
- ✅ 价格应用客户折扣

---

## 表格列说明

### 订阅中心表格列

| 列名 | 说明 | 宽度 |
|------|------|------|
| ID | 数据ID | 80px |
| 推荐来源 | 标签显示：收藏/已购/收藏+已购 | 100px |
| 国家 | 国家名称 | 120px |
| 数据类型 | 数据分类 | 100px |
| 时效性 | 3天内/30天内/30天以上 | 120px |
| 数据来源 | 数据提供方 | 150px+ |
| 可用数量 | 格式化数字显示 | 120px |
| 运营商分布 | 各运营商数量和占比 | 200px+ |
| 销售价格 | 应用客户折扣后的价格 | 140px |
| 操作 | 购买、收藏按钮 | 200px |

---

## 使用场景

### 场景1: 新客户

- **状态**: 无购买记录，无收藏
- **显示**: 提示"暂无订阅数据，请先购买数据或添加收藏"

### 场景2: 有购买记录的客户

- **状态**: 购买过孟加拉国的手机号码
- **推荐**: 显示所有孟加拉国的手机号码数据（包括新上架的）

### 场景3: 有收藏的客户

- **状态**: 收藏了印度的电话号码
- **推荐**: 显示该收藏数据（标记为"收藏"）

### 场景4: 既有购买又有收藏

- **状态**: 购买过孟加拉国数据，收藏了印度数据
- **推荐**: 
  - 孟加拉国所有相同类型数据（标记"已购"）
  - 印度收藏的数据（标记"收藏"）
  - 如果收藏的数据恰好是已购买类型，标记"收藏+已购"

---

## 技术实现细节

### 数据库查询优化

使用 Sequelize 的 `Op.or` 操作符合并多个查询条件:

```javascript
const whereConditions = [];

// 已购买类型
purchasedOrders.forEach(order => {
  whereConditions.push({
    country: order.country,
    data_type: order.data_type
  });
});

// 收藏数据
if (favoriteDataIds.length > 0) {
  whereConditions.push({
    id: { [Op.in]: favoriteDataIds }
  });
}

// 执行查询
await DataLibrary.findAndCountAll({
  where: {
    [Op.or]: whereConditions,
    publish_status: 'published',
    status: 'available',
    available_quantity: { [Op.gt]: 0 }
  }
});
```

### 前端状态管理

- 使用 `activeTab` 控制当前激活的标签页
- 订阅数据独立的分页状态 `subscriptionQuery`
- 共享收藏状态 `favoriteIds`，确保两个标签页收藏状态一致

### 样式优化

- 标签页图标美化
- 推荐来源标签颜色区分
- 空状态友好提示
- 响应式表格布局

---

## 测试要点

### 功能测试

1. ✅ 客户登录后能看到订阅中心标签页
2. ✅ 代理/管理员看到权限提示
3. ✅ 切换到订阅中心自动加载数据
4. ✅ 根据购买历史推荐相同国家和类型的数据
5. ✅ 显示收藏的数据
6. ✅ 正确标记数据来源
7. ✅ 购买功能正常
8. ✅ 收藏/取消收藏功能正常
9. ✅ 分页功能正常
10. ✅ 价格正确应用客户折扣

### 边界测试

1. ✅ 无购买记录且无收藏时显示提示
2. ✅ 只有购买记录时只显示推荐数据
3. ✅ 只有收藏时只显示收藏数据
4. ✅ 数据量大时分页正常
5. ✅ 网络错误时显示友好提示

---

## 后续优化建议

### 1. 推荐算法增强

- 根据购买频率调整推荐权重
- 考虑时效性优先级
- 添加热门数据推荐

### 2. 用户体验优化

- 添加排序功能（按价格、数量、时效性）
- 添加筛选功能（仅显示收藏/仅显示推荐）
- 添加搜索功能

### 3. 数据统计

- 统计订阅转化率
- 分析哪些推荐最受欢迎
- 优化推荐策略

---

## 相关文件清单

### 后端文件

- `/home/vue-element-admin/backend/routes/data.js` - 数据路由（新增订阅接口）
- `/home/vue-element-admin/backend/models/Order.js` - 订单模型
- `/home/vue-element-admin/backend/models/Favorite.js` - 收藏模型
- `/home/vue-element-admin/backend/models/DataLibrary.js` - 数据库模型

### 前端文件

- `/home/vue-element-admin/src/views/resource/center.vue` - 资源中心页面（主要修改）

### 文档文件

- `/home/vue-element-admin/订阅中心功能说明.md` - 本文档

---

## 总结

订阅中心功能为客户提供了个性化的数据浏览体验，通过智能推荐算法帮助客户发现感兴趣的数据。该功能结合了购买历史和收藏记录，提供了更精准的数据推荐，提升了用户体验和转化率。
