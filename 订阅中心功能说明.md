# è®¢é˜…ä¸­å¿ƒåŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

åœ¨èµ„æºä¸­å¿ƒæ–°å¢**è®¢é˜…ä¸­å¿ƒ**æ ‡ç­¾é¡µï¼Œä¸ºå®¢æˆ·æä¾›ä¸ªæ€§åŒ–çš„æ•°æ®æ¨èæœåŠ¡ã€‚è®¢é˜…ä¸­å¿ƒæ ¹æ®å®¢æˆ·çš„è´­ä¹°å†å²å’Œæ”¶è—è®°å½•ï¼Œæ™ºèƒ½æ¨èç›¸å…³æ•°æ®ã€‚

---

## å®ç°å†…å®¹

### 1. åç«¯å®ç°

#### æ–°å¢APIæ¥å£

**è·¯ç”±åœ°å€**: `/api/data-library/subscription/:customerId`

**è¯·æ±‚æ–¹æ³•**: GET

**è¯·æ±‚å‚æ•°**:
- `customerId` (è·¯å¾„å‚æ•°): å®¢æˆ·ID
- `page` (æŸ¥è¯¢å‚æ•°): é¡µç ï¼Œé»˜è®¤1
- `limit` (æŸ¥è¯¢å‚æ•°): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20

**åŠŸèƒ½é€»è¾‘**:

1. **è·å–å·²è´­ä¹°è®¢å•çš„å›½å®¶å’Œç±»å‹**
   ```javascript
   const purchasedOrders = await Order.findAll({
     where: { 
       customer_id: customerId,
       status: 'completed'
     },
     attributes: ['country', 'data_type'],
     group: ['country', 'data_type']
   });
   ```

2. **è·å–æ”¶è—çš„æ•°æ®ID**
   ```javascript
   const favorites = await Favorite.findAll({
     where: { customer_id: customerId },
     attributes: ['data_id']
   });
   ```

3. **æŸ¥è¯¢æ¨èæ•°æ®**
   - æŸ¥è¯¢ä¸å·²è´­ä¹°è®¢å•ç›¸åŒå›½å®¶å’Œæ•°æ®ç±»å‹çš„å¯ç”¨æ•°æ®
   - æŸ¥è¯¢ç”¨æˆ·æ”¶è—çš„æ•°æ®
   - åˆå¹¶å»é‡åè¿”å›

4. **æ ‡è®°æ•°æ®æ¥æº**
   - `favorite`: æ¥è‡ªæ”¶è—
   - `purchased`: æ¥è‡ªå·²è´­ä¹°æ¨è
   - `both`: æ—¢åœ¨æ”¶è—ä¸­åˆå±äºå·²è´­ä¹°ç±»å‹

**å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "country": "BD",
      "country_name": "å­ŸåŠ æ‹‰å›½",
      "data_type": "æ‰‹æœºå·ç ",
      "validity": "3",
      "validity_name": "3å¤©å†…",
      "source": "å®˜æ–¹æ¸ é“",
      "available_quantity": 500000,
      "sell_price": 0.05,
      "operators": [...],
      "subscriptionSource": "purchased",
      "isFavorited": false,
      "isPurchasedType": true
    }
  ],
  "total": 10,
  "page": 1,
  "limit": 20
}
```

**æ–‡ä»¶è·¯å¾„**: `/home/vue-element-admin/backend/routes/data.js`

---

### 2. å‰ç«¯å®ç°

#### é¡µé¢ç»“æ„è°ƒæ•´

**æ–‡ä»¶è·¯å¾„**: `/home/vue-element-admin/src/views/resource/center.vue`

#### ä¸»è¦ä¿®æ”¹ç‚¹

1. **æ·»åŠ æ ‡ç­¾é¡µç»„ä»¶**
   ```vue
   <el-tabs v-model="activeTab" @tab-click="handleTabClick">
     <el-tab-pane label="å¯è´­ä¹°æ•°æ®" name="available">
       <!-- åŸæœ‰çš„æ•°æ®åˆ—è¡¨ -->
     </el-tab-pane>
     
     <el-tab-pane name="subscription">
       <span slot="label">
         <i class="el-icon-star-on" />
         è®¢é˜…ä¸­å¿ƒ
       </span>
       <!-- è®¢é˜…æ•°æ®åˆ—è¡¨ -->
     </el-tab-pane>
   </el-tabs>
   ```

2. **æ–°å¢æ•°æ®å­—æ®µ**
   ```javascript
   data() {
     return {
       activeTab: 'available',
       // è®¢é˜…ä¸­å¿ƒæ•°æ®
       subscriptionList: [],
       subscriptionTotal: 0,
       subscriptionLoading: false,
       subscriptionQuery: {
         page: 1,
         limit: 20
       }
     }
   }
   ```

3. **æ–°å¢æ–¹æ³•**

   **æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶**:
   ```javascript
   handleTabClick(tab) {
     if (tab.name === 'subscription') {
       this.getSubscriptionList()
     }
   }
   ```

   **è·å–è®¢é˜…æ•°æ®**:
   ```javascript
   async getSubscriptionList() {
     if (!this.customerId) {
       console.warn('æœªæ‰¾åˆ°å®¢æˆ·IDï¼Œæ— æ³•åŠ è½½è®¢é˜…æ•°æ®')
       return
     }

     this.subscriptionLoading = true
     
     try {
       const response = await request({
         method: 'GET',
         url: `/api/data-library/subscription/${this.customerId}`,
         params: {
           page: this.subscriptionQuery.page,
           limit: this.subscriptionQuery.limit
         }
       })

       if (response.success) {
         this.subscriptionList = response.data || []
         this.subscriptionTotal = response.total || 0
         
         // æ›´æ–°æ”¶è—çŠ¶æ€
         this.subscriptionList.forEach(item => {
           if (item.isFavorited) {
             this.favoriteIds.add(item.id)
           }
         })
       }
     } catch (error) {
       console.error('è·å–è®¢é˜…æ•°æ®å¤±è´¥:', error)
       this.$message.error('è·å–è®¢é˜…æ•°æ®å¤±è´¥ï¼š' + error.message)
     } finally {
       this.subscriptionLoading = false
     }
   }
   ```

   **è§£æè¿è¥å•†æ•°æ®**:
   ```javascript
   parseOperators(operators) {
     if (!operators) return []
     if (typeof operators === 'string') {
       try {
         return JSON.parse(operators)
       } catch (e) {
         return []
       }
     }
     return operators
   }
   ```

---

## åŠŸèƒ½ç‰¹ç‚¹

### 1. æ™ºèƒ½æ¨è

- **åŸºäºè´­ä¹°å†å²**: æ¨èä¸å·²è´­ä¹°æ•°æ®ç›¸åŒå›½å®¶å’Œç±»å‹çš„æ–°æ•°æ®
- **åŸºäºæ”¶è—**: æ˜¾ç¤ºç”¨æˆ·æ”¶è—çš„æ‰€æœ‰æ•°æ®
- **æ¥æºæ ‡è¯†**: æ¸…æ™°æ ‡è®°æ•°æ®æ¥æºï¼ˆæ”¶è—/å·²è´­/ä¸¤è€…çš†æœ‰ï¼‰

### 2. ç”¨æˆ·ä½“éªŒ

- **æƒé™æ§åˆ¶**: ä»…å¯¹å®¢æˆ·å¼€æ”¾ï¼Œä»£ç†å’Œç®¡ç†å‘˜çœ‹åˆ°æç¤ºä¿¡æ¯
- **æ•°æ®æ¥æºæ ‡ç­¾**:
  - ğŸŸ¡ é»„è‰²æ ‡ç­¾: æ”¶è—
  - ğŸŸ¢ ç»¿è‰²æ ‡ç­¾: å·²è´­æ¨è
  - ğŸ”µ è“è‰²æ ‡ç­¾: æ”¶è—+å·²è´­

- **ç©ºçŠ¶æ€æç¤º**: æ— è®¢é˜…æ•°æ®æ—¶æ˜¾ç¤ºå‹å¥½æç¤º

### 3. å®Œæ•´åŠŸèƒ½

è®¢é˜…ä¸­å¿ƒçš„æ•°æ®æ”¯æŒ:
- âœ… æŸ¥çœ‹æ•°æ®è¯¦æƒ…
- âœ… è´­ä¹°æ“ä½œ
- âœ… æ”¶è—/å–æ¶ˆæ”¶è—
- âœ… åˆ†é¡µæµè§ˆ
- âœ… ä»·æ ¼åº”ç”¨å®¢æˆ·æŠ˜æ‰£

---

## è¡¨æ ¼åˆ—è¯´æ˜

### è®¢é˜…ä¸­å¿ƒè¡¨æ ¼åˆ—

| åˆ—å | è¯´æ˜ | å®½åº¦ |
|------|------|------|
| ID | æ•°æ®ID | 80px |
| æ¨èæ¥æº | æ ‡ç­¾æ˜¾ç¤ºï¼šæ”¶è—/å·²è´­/æ”¶è—+å·²è´­ | 100px |
| å›½å®¶ | å›½å®¶åç§° | 120px |
| æ•°æ®ç±»å‹ | æ•°æ®åˆ†ç±» | 100px |
| æ—¶æ•ˆæ€§ | 3å¤©å†…/30å¤©å†…/30å¤©ä»¥ä¸Š | 120px |
| æ•°æ®æ¥æº | æ•°æ®æä¾›æ–¹ | 150px+ |
| å¯ç”¨æ•°é‡ | æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º | 120px |
| è¿è¥å•†åˆ†å¸ƒ | å„è¿è¥å•†æ•°é‡å’Œå æ¯” | 200px+ |
| é”€å”®ä»·æ ¼ | åº”ç”¨å®¢æˆ·æŠ˜æ‰£åçš„ä»·æ ¼ | 140px |
| æ“ä½œ | è´­ä¹°ã€æ”¶è—æŒ‰é’® | 200px |

---

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: æ–°å®¢æˆ·

- **çŠ¶æ€**: æ— è´­ä¹°è®°å½•ï¼Œæ— æ”¶è—
- **æ˜¾ç¤º**: æç¤º"æš‚æ— è®¢é˜…æ•°æ®ï¼Œè¯·å…ˆè´­ä¹°æ•°æ®æˆ–æ·»åŠ æ”¶è—"

### åœºæ™¯2: æœ‰è´­ä¹°è®°å½•çš„å®¢æˆ·

- **çŠ¶æ€**: è´­ä¹°è¿‡å­ŸåŠ æ‹‰å›½çš„æ‰‹æœºå·ç 
- **æ¨è**: æ˜¾ç¤ºæ‰€æœ‰å­ŸåŠ æ‹‰å›½çš„æ‰‹æœºå·ç æ•°æ®ï¼ˆåŒ…æ‹¬æ–°ä¸Šæ¶çš„ï¼‰

### åœºæ™¯3: æœ‰æ”¶è—çš„å®¢æˆ·

- **çŠ¶æ€**: æ”¶è—äº†å°åº¦çš„ç”µè¯å·ç 
- **æ¨è**: æ˜¾ç¤ºè¯¥æ”¶è—æ•°æ®ï¼ˆæ ‡è®°ä¸º"æ”¶è—"ï¼‰

### åœºæ™¯4: æ—¢æœ‰è´­ä¹°åˆæœ‰æ”¶è—

- **çŠ¶æ€**: è´­ä¹°è¿‡å­ŸåŠ æ‹‰å›½æ•°æ®ï¼Œæ”¶è—äº†å°åº¦æ•°æ®
- **æ¨è**: 
  - å­ŸåŠ æ‹‰å›½æ‰€æœ‰ç›¸åŒç±»å‹æ•°æ®ï¼ˆæ ‡è®°"å·²è´­"ï¼‰
  - å°åº¦æ”¶è—çš„æ•°æ®ï¼ˆæ ‡è®°"æ”¶è—"ï¼‰
  - å¦‚æœæ”¶è—çš„æ•°æ®æ°å¥½æ˜¯å·²è´­ä¹°ç±»å‹ï¼Œæ ‡è®°"æ”¶è—+å·²è´­"

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

ä½¿ç”¨ Sequelize çš„ `Op.or` æ“ä½œç¬¦åˆå¹¶å¤šä¸ªæŸ¥è¯¢æ¡ä»¶:

```javascript
const whereConditions = [];

// å·²è´­ä¹°ç±»å‹
purchasedOrders.forEach(order => {
  whereConditions.push({
    country: order.country,
    data_type: order.data_type
  });
});

// æ”¶è—æ•°æ®
if (favoriteDataIds.length > 0) {
  whereConditions.push({
    id: { [Op.in]: favoriteDataIds }
  });
}

// æ‰§è¡ŒæŸ¥è¯¢
await DataLibrary.findAndCountAll({
  where: {
    [Op.or]: whereConditions,
    publish_status: 'published',
    status: 'available',
    available_quantity: { [Op.gt]: 0 }
  }
});
```

### å‰ç«¯çŠ¶æ€ç®¡ç†

- ä½¿ç”¨ `activeTab` æ§åˆ¶å½“å‰æ¿€æ´»çš„æ ‡ç­¾é¡µ
- è®¢é˜…æ•°æ®ç‹¬ç«‹çš„åˆ†é¡µçŠ¶æ€ `subscriptionQuery`
- å…±äº«æ”¶è—çŠ¶æ€ `favoriteIds`ï¼Œç¡®ä¿ä¸¤ä¸ªæ ‡ç­¾é¡µæ”¶è—çŠ¶æ€ä¸€è‡´

### æ ·å¼ä¼˜åŒ–

- æ ‡ç­¾é¡µå›¾æ ‡ç¾åŒ–
- æ¨èæ¥æºæ ‡ç­¾é¢œè‰²åŒºåˆ†
- ç©ºçŠ¶æ€å‹å¥½æç¤º
- å“åº”å¼è¡¨æ ¼å¸ƒå±€

---

## æµ‹è¯•è¦ç‚¹

### åŠŸèƒ½æµ‹è¯•

1. âœ… å®¢æˆ·ç™»å½•åèƒ½çœ‹åˆ°è®¢é˜…ä¸­å¿ƒæ ‡ç­¾é¡µ
2. âœ… ä»£ç†/ç®¡ç†å‘˜çœ‹åˆ°æƒé™æç¤º
3. âœ… åˆ‡æ¢åˆ°è®¢é˜…ä¸­å¿ƒè‡ªåŠ¨åŠ è½½æ•°æ®
4. âœ… æ ¹æ®è´­ä¹°å†å²æ¨èç›¸åŒå›½å®¶å’Œç±»å‹çš„æ•°æ®
5. âœ… æ˜¾ç¤ºæ”¶è—çš„æ•°æ®
6. âœ… æ­£ç¡®æ ‡è®°æ•°æ®æ¥æº
7. âœ… è´­ä¹°åŠŸèƒ½æ­£å¸¸
8. âœ… æ”¶è—/å–æ¶ˆæ”¶è—åŠŸèƒ½æ­£å¸¸
9. âœ… åˆ†é¡µåŠŸèƒ½æ­£å¸¸
10. âœ… ä»·æ ¼æ­£ç¡®åº”ç”¨å®¢æˆ·æŠ˜æ‰£

### è¾¹ç•Œæµ‹è¯•

1. âœ… æ— è´­ä¹°è®°å½•ä¸”æ— æ”¶è—æ—¶æ˜¾ç¤ºæç¤º
2. âœ… åªæœ‰è´­ä¹°è®°å½•æ—¶åªæ˜¾ç¤ºæ¨èæ•°æ®
3. âœ… åªæœ‰æ”¶è—æ—¶åªæ˜¾ç¤ºæ”¶è—æ•°æ®
4. âœ… æ•°æ®é‡å¤§æ—¶åˆ†é¡µæ­£å¸¸
5. âœ… ç½‘ç»œé”™è¯¯æ—¶æ˜¾ç¤ºå‹å¥½æç¤º

---

## åç»­ä¼˜åŒ–å»ºè®®

### 1. æ¨èç®—æ³•å¢å¼º

- æ ¹æ®è´­ä¹°é¢‘ç‡è°ƒæ•´æ¨èæƒé‡
- è€ƒè™‘æ—¶æ•ˆæ€§ä¼˜å…ˆçº§
- æ·»åŠ çƒ­é—¨æ•°æ®æ¨è

### 2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- æ·»åŠ æ’åºåŠŸèƒ½ï¼ˆæŒ‰ä»·æ ¼ã€æ•°é‡ã€æ—¶æ•ˆæ€§ï¼‰
- æ·»åŠ ç­›é€‰åŠŸèƒ½ï¼ˆä»…æ˜¾ç¤ºæ”¶è—/ä»…æ˜¾ç¤ºæ¨èï¼‰
- æ·»åŠ æœç´¢åŠŸèƒ½

### 3. æ•°æ®ç»Ÿè®¡

- ç»Ÿè®¡è®¢é˜…è½¬åŒ–ç‡
- åˆ†æå“ªäº›æ¨èæœ€å—æ¬¢è¿
- ä¼˜åŒ–æ¨èç­–ç•¥

---

## ç›¸å…³æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶

- `/home/vue-element-admin/backend/routes/data.js` - æ•°æ®è·¯ç”±ï¼ˆæ–°å¢è®¢é˜…æ¥å£ï¼‰
- `/home/vue-element-admin/backend/models/Order.js` - è®¢å•æ¨¡å‹
- `/home/vue-element-admin/backend/models/Favorite.js` - æ”¶è—æ¨¡å‹
- `/home/vue-element-admin/backend/models/DataLibrary.js` - æ•°æ®åº“æ¨¡å‹

### å‰ç«¯æ–‡ä»¶

- `/home/vue-element-admin/src/views/resource/center.vue` - èµ„æºä¸­å¿ƒé¡µé¢ï¼ˆä¸»è¦ä¿®æ”¹ï¼‰

### æ–‡æ¡£æ–‡ä»¶

- `/home/vue-element-admin/è®¢é˜…ä¸­å¿ƒåŠŸèƒ½è¯´æ˜.md` - æœ¬æ–‡æ¡£

---

## æ€»ç»“

è®¢é˜…ä¸­å¿ƒåŠŸèƒ½ä¸ºå®¢æˆ·æä¾›äº†ä¸ªæ€§åŒ–çš„æ•°æ®æµè§ˆä½“éªŒï¼Œé€šè¿‡æ™ºèƒ½æ¨èç®—æ³•å¸®åŠ©å®¢æˆ·å‘ç°æ„Ÿå…´è¶£çš„æ•°æ®ã€‚è¯¥åŠŸèƒ½ç»“åˆäº†è´­ä¹°å†å²å’Œæ”¶è—è®°å½•ï¼Œæä¾›äº†æ›´ç²¾å‡†çš„æ•°æ®æ¨èï¼Œæå‡äº†ç”¨æˆ·ä½“éªŒå’Œè½¬åŒ–ç‡ã€‚
