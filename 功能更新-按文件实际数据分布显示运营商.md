# 功能更新：按文件实际数据分布显示运营商

## 📋 更新概述

按运营商提取功能已升级，不再显示固定的市场份额，而是**根据选中文件的实际数据分布**动态显示运营商及其数量。

---

## ✨ 更新内容

### 1. **智能分析文件数据** 🔍
- ✅ 选择文件和国家后，自动分析文件中的运营商分布
- ✅ 显示每个运营商在文件中的实际数量和占比
- ✅ 只显示文件中实际包含的运营商

### 2. **实时数据展示** 📊
- ✅ 运营商列表显示：`运营商名 (数量: X条, 占比: Y%)`
- ✅ 根据实际数据动态更新显示
- ✅ 自动过滤无数据的运营商

### 3. **灵活的提取配置** ⚙️
- ✅ 可选择多个运营商同时提取
- ✅ 为每个运营商单独设置提取条数
- ✅ 支持"全部提取"或"限制条数"两种模式

---

## 🎯 使用场景示例

### 场景：处理孟加拉国混合数据

**数据情况**：
- 文件名：`BD_mix_1000.txt`
- 总数据：1,000 条
- 实际分布：
  - Grameenphone: 300条 (30%)
  - Banglalink: 300条 (30%)
  - Robi: 400条 (40%)

**操作步骤**：

1. **选择文件**：`BD_mix_1000.txt` (1,000行)
2. **选择国家**：孟加拉国 (Bangladesh)
3. **系统自动分析**，显示运营商分布：
   ```
   ☑ Grameenphone (数量: 300, 占比: 30.0%)
   ☑ Banglalink (数量: 300, 占比: 30.0%)
   ☑ Robi (数量: 400, 占比: 40.0%)
   ☐ Teletalk (数量: 0, 占比: 0%) ← 自动隐藏或显示为0
   ```

4. **选择提取方案**：
   - ✅ Grameenphone - 限制条数: 100
   - ✅ Banglalink - 限制条数: 100
   - ✅ Robi - 限制条数: 100

5. **开始提取**

**提取结果**：
```
提取完成！
总数据: 1,000 条
提取总数: 300 条
运营商数: 3 个

● Grameenphone: 100 条 (限制100条, 已达上限)
● Banglalink: 100 条 (限制100条, 已达上限)
● Robi: 100 条 (限制100条, 已达上限)
```

自动下载3个文件：
- `operator_Grameenphone_1729123456789.txt` (100行)
- `operator_Banglalink_1729123456790.txt` (100行)
- `operator_Robi_1729123456791.txt` (100行)

---

## 🔧 技术实现

### 后端新增功能

#### 1. 数据处理工具类 (`backend/utils/dataProcessor.js`)

新增方法：`analyzeOperatorDistribution`

```javascript
/**
 * 分析文件中的运营商分布
 * @param {string} inputPath - 输入文件路径
 * @param {Object} operatorConfig - 运营商配置
 * @returns {Promise<Object>} 运营商分布统计
 */
static async analyzeOperatorDistribution(inputPath, operatorConfig) {
  const lines = await this.readLines(inputPath);
  const { countryCode, operators } = operatorConfig;
  
  // 初始化每个运营商的计数器
  const distribution = operators.map(op => ({
    name: op.name,
    numberSegments: op.numberSegments,
    count: 0
  }));
  
  let unmatchedCount = 0;
  
  // 遍历所有数据行，统计每个运营商的数量
  for (const line of lines) {
    const cleaned = line.replace(/[^\d]/g, '');
    let phoneNumber = cleaned;
    
    // 智能去除国码（与提取逻辑一致）
    // ... 去除国码逻辑 ...
    
    // 检查该号码属于哪个运营商
    let matched = false;
    for (const dist of distribution) {
      if (dist.numberSegments.some(segment => phoneNumber.startsWith(segment))) {
        dist.count++;
        matched = true;
        break;
      }
    }
    
    if (!matched) {
      unmatchedCount++;
    }
  }
  
  return {
    totalCount: lines.length,
    distribution: distribution.filter(d => d.count > 0), // 只返回有数据的运营商
    unmatchedCount: unmatchedCount
  };
}
```

#### 2. API路由 (`backend/routes/dataProcessing.js`)

新增接口：`POST /api/data-processing/analyze-operator-distribution`

**请求格式**：
```json
{
  "fileId": 123,
  "countryCode": "880",
  "operators": [
    {
      "name": "Grameenphone",
      "numberSegments": ["017", "013", "019"]
    },
    {
      "name": "Banglalink",
      "numberSegments": ["014", "019"]
    }
  ]
}
```

**响应格式**：
```json
{
  "success": true,
  "data": {
    "totalCount": 1000,
    "distribution": [
      {
        "name": "Grameenphone",
        "numberSegments": ["017", "013", "019"],
        "count": 300
      },
      {
        "name": "Banglalink",
        "numberSegments": ["014", "019"],
        "count": 300
      },
      {
        "name": "Robi",
        "numberSegments": ["018", "019"],
        "count": 400
      }
    ],
    "unmatchedCount": 0
  }
}
```

### 前端新增功能

#### 1. 数据模型更新 (`src/views/data/processing.vue`)

```javascript
extractOperatorForm: {
  fileId: null,
  countryCode: '',
  selectedOperators: [],
  operatorLimits: {},
  analyzing: false  // 新增：分析状态标识
}
```

#### 2. 核心方法

**文件选择处理**：
```javascript
handleFileChange(fileId) {
  // 清空之前的选择
  this.extractOperatorForm.selectedOperators = []
  this.extractOperatorForm.operatorLimits = {}
  this.operatorList = []
  
  if (!fileId || !this.extractOperatorForm.countryCode) {
    return
  }
  
  // 分析文件中的运营商分布
  this.analyzeOperatorDistribution()
}
```

**国家变更处理**：
```javascript
handleCountryChange(countryCode) {
  // 清空之前的选择
  this.extractOperatorForm.selectedOperators = []
  this.extractOperatorForm.operatorLimits = {}
  this.operatorList = []
  
  if (!countryCode || !this.extractOperatorForm.fileId) {
    return
  }
  
  // 分析文件中的运营商分布
  this.analyzeOperatorDistribution()
}
```

**分析运营商分布**：
```javascript
async analyzeOperatorDistribution() {
  if (!this.extractOperatorForm.fileId || !this.extractOperatorForm.countryCode) {
    return
  }

  // 获取国家的所有运营商
  const allOperators = getOperatorsByCountry(this.extractOperatorForm.countryCode)
  
  // 获取国码
  const country = this.countryList.find(c => c.code === this.extractOperatorForm.countryCode)
  const countryCode = country ? country.dialCode.replace(/^\+/, '') : null

  this.extractOperatorForm.analyzing = true
  try {
    const response = await request({
      url: '/api/data-processing/analyze-operator-distribution',
      method: 'post',
      data: {
        fileId: this.extractOperatorForm.fileId,
        countryCode: countryCode,
        operators: allOperators
      }
    })

    const { totalCount, distribution } = response.data

    // 构建运营商列表，显示实际数量和百分比
    this.operatorList = distribution.map(d => {
      const percentage = ((d.count / totalCount) * 100).toFixed(1)
      return {
        name: d.name,
        numberSegments: d.numberSegments,
        count: d.count,
        percentage: percentage,
        displayText: `${d.name} (数量: ${this.formatNumber(d.count)}, 占比: ${percentage}%)`
      }
    })

    this.$message.success(`分析完成！检测到 ${distribution.length} 个运营商`)
  } catch (error) {
    this.$message.error('分析失败: ' + error.message)
    this.operatorList = []
  } finally {
    this.extractOperatorForm.analyzing = false
  }
}
```

#### 3. UI界面更新

**运营商显示**：
```vue
<!-- 分析中提示 -->
<el-alert
  v-if="extractOperatorForm.analyzing"
  title="正在分析文件中的运营商分布..."
  type="info"
  :closable="false"
  show-icon
/>

<!-- 运营商列表 -->
<el-form-item v-if="!extractOperatorForm.analyzing && operatorList.length > 0" label="选择运营商">
  <el-checkbox-group v-model="extractOperatorForm.selectedOperators">
    <el-checkbox
      v-for="operator in operatorList"
      :key="operator.name"
      :label="operator.name"
    >
      {{ operator.name }} (数量: {{ formatNumber(operator.count) }}, 占比: {{ operator.percentage }}%)
    </el-checkbox>
  </el-checkbox-group>
</el-form-item>

<!-- 无数据提示 -->
<el-alert
  v-if="!extractOperatorForm.analyzing && operatorList.length === 0 && extractOperatorForm.countryCode"
  title="文件中未检测到该国家的运营商数据，请选择其他国家或文件"
  type="warning"
  :closable="false"
/>
```

---

## 📊 对比：旧版 vs 新版

### 旧版本（固定市场份额）
```
☑ Grameenphone (市场份额: 46%)
☑ Banglalink (市场份额: 30%)
☑ Robi (市场份额: 20%)
☑ Teletalk (市场份额: 5%)
```
- ❌ 显示固定的市场份额，不反映文件实际情况
- ❌ 即使文件中没有某运营商数据也会显示
- ❌ 无法知道文件中实际有多少条数据

### 新版本（实际数据分布）
```
☑ Grameenphone (数量: 300, 占比: 30.0%)
☑ Banglalink (数量: 300, 占比: 30.0%)
☑ Robi (数量: 400, 占比: 40.0%)
```
- ✅ 显示文件中的实际数量和占比
- ✅ 只显示文件中实际包含的运营商
- ✅ 一目了然地了解数据分布情况
- ✅ 便于制定精准的提取策略

---

## 💡 使用建议

1. **先选择文件和国家**
   - 选择文件后再选择国家，或反过来都可以
   - 两者都选择后会自动触发分析

2. **等待分析完成**
   - 分析过程中会显示"正在分析..."提示
   - 分析完成后显示运营商列表

3. **根据实际分布选择**
   - 查看每个运营商的数量和占比
   - 根据需求选择要提取的运营商
   - 设置合适的提取条数

4. **注意提取限制**
   - 提取条数不能超过实际数量
   - 系统会在达到限制后停止提取
   - 建议设置略小于实际数量以提高效率

---

## 🐛 问题修复

### 修复前：
- ❌ 无法选择运营商（复选框灰色不可用）
- ❌ 显示固定市场份额，不反映实际情况
- ❌ 无法知道文件中是否包含该运营商数据

### 修复后：
- ✅ 可以正常选择运营商
- ✅ 显示实际数据分布
- ✅ 只显示有数据的运营商
- ✅ 提供详细的数量和占比信息

---

## 📝 技术细节

### 分析算法
1. 读取文件所有数据行
2. 对每条数据智能去除国码（与提取逻辑一致）
3. 遍历所有运营商号段，匹配并计数
4. 统计每个运营商的数量
5. 计算占比并返回结果

### 性能优化
- 分析过程显示加载状态
- 只返回有数据的运营商
- 复用现有的号码清洗逻辑
- 异步处理，不阻塞UI

### 数据一致性
- 分析逻辑与提取逻辑完全一致
- 确保分析结果准确反映提取结果
- 使用相同的国码识别和号段匹配规则

---

## 🎉 总结

此次更新极大提升了按运营商提取功能的实用性和准确性：

1. **更直观** - 一眼看出文件中各运营商的数据分布
2. **更准确** - 基于实际数据，而非固定市场份额
3. **更高效** - 只显示有数据的运营商，避免无效操作
4. **更灵活** - 根据实际情况制定提取策略

现在您可以：
- 精准了解文件中的运营商分布
- 按实际需求分配提取数量
- 避免提取不存在的运营商数据
- 一目了然地查看每个运营商的数据量

---

**更新时间**：2025-10-16  
**版本**：v2.0  
**状态**：✅ 已上线
